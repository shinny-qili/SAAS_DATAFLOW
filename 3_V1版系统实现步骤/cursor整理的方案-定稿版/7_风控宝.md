# 风控宝产品方案

本文档描述风控宝模块的完整产品方案，包括实时风控、事后风控、风控设置、风控驾驶舱、风控告警记录、VaR测试、压力测试等功能模块。

---

## 一、概述

### 1.1 服务定位

风控宝是系统的风险控制中心，提供实时风控、事后风控、风险监控、告警管理、风险量化等功能，帮助风控团队及时发现、评估和管理各类风险。

### 1.2 风控与报表的分界线

- **风控**：警告、阻止等既成事实的呈现和后续动作
- **报表**：对系统现状的呈现
- 一个系统基本无法将所有意外情况都以警告、阻止的形式呈现，所以需要报表及其下钻以人主观作为风控的补充
- 风控是风控，报表的一部分也可用于风控
- 例如：VaR预测和压力测试属于功能，可能放在风控页，是可用于风控服务的一个功能

### 1.3 模块结构

风控宝包含以下子模块：
- **实时交易风控**：委托前/委托时风控判断（后端服务，前端仅展示日志）
- **事后风控**：敞口、交收、期货等风险指标的事后分析（数据展示主要在风控驾驶舱）
- **风控设置**：风控规则和告警策略的配置中心
- **风控驾驶舱**：风险指标的一眼概览
- **风控告警记录**：告警记录的查看和处理工作台
- **VaR测试**：风险敞口的量化分析
- **压力测试**：极端风险情景测试

### 1.4 实现状态说明

#### 1.4.1 前端原型已实现模块

以下模块已在原型系统中完整实现，包括界面布局、交互逻辑、数据展示等：

- ✅ **风控设置**：完整的异常提醒与告警策略配置界面，支持行情类异常、可能异常、已经异常三类配置
- ✅ **风控驾驶舱**：完整的数据banner、图表、表格、记录展示，支持数据下钻功能
- ✅ **风控告警记录**：完整的列表展示、筛选、处理功能，支持关注、已处理、转通知等操作
- ✅ **VaR测试**：完整的参数配置、计算、结果展示功能，支持多维度分析和历史回测
- ✅ **压力测试**：完整的多场景测试功能，支持历史极端日、跨市场联动、基差骤变等场景

#### 1.4.2 后端服务模块

- **实时交易风控**：由后端实时交易风控服务负责，对指令与委托在落地前/后的合规性进行即时判断。前端仅提供实时风控日志的查看功能，不参与实时判断逻辑。

#### 1.4.3 数据计算与展示

- **事后风控**：事后风控的数据计算由后端完成，前端在"风控驾驶舱"中展示计算结果。事后风控的各项指标（敞口、交收、期货等）在驾驶舱中以表格、图表、数据banner等形式呈现，详见"五、风控驾驶舱"章节。

---

## 二、实时交易风控

### 2.1 服务定位

实时交易风控是后端服务模块，对以下两种动作进行判断，然后系统判定允许、拒绝：
- **实时的委托前风控**：包括指令
- **实时的委托时风控**：包括委托
  - 品种、手数、账户资金占用

**重要说明**：实时交易风控为后端服务，不在前端界面中实现。前端仅提供实时风控日志的查看功能，用于事后追溯和分析。

### 2.2 功能说明

- 实时风控服务会作用于指令是否合法、委托是否合法
- **前端功能**：事后查看实时风控日志（可在相关模块中查看被阻止的指令/委托记录）
- **后端服务**：实时判断逻辑由后端实时交易风控服务负责
- 期货报单阻止发出的相关设置项在：全局设置-期货账户设置-风控限制
- 指令阻止发出的相关设置项在：指令宝-指令权限设置-人员指令权限设置、指令宝-指令权限设置-客商指令权限设置

### 2.3 与风控告警记录的联动

当实时风控阻止指令或委托时：
- 如果"风控设置"中启用了"期货报单阻止发出告警"或"指令阻止发出告警"，系统会在"风控告警记录"中生成相应的告警记录
- 告警记录包含阻止原因、被阻止的指令/委托信息等，详见"六、风控告警记录"章节

---

## 三、事后风控

### 3.1 服务定位

事后风控是对敞口、交收、期货等风险指标的事后分析。数据计算由后端完成，前端在"风控驾驶舱"中展示计算结果。

**重要说明**：事后风控的各项指标在"风控驾驶舱"中以表格、图表、数据banner等形式呈现。以下列出的各项指标对应驾驶舱中的具体展示位置，详见"五、风控驾驶舱"章节。

### 3.2 指标展示位置

对以下内容中的重要字段在界面中排序呈现：

#### 3.2.1 敞口

在风控驾驶舱的"表"区域展示：

- **保值方案的敞口合计** → 驾驶舱"敞口-保值方案敞口前五"表格
- **合同未采销匹配也未期现匹配的敞口** → 驾驶舱"敞口-合同敞口前五"表格
- **期货未匹配的敞口** → 驾驶舱"敞口-期货敞口前五"表格

#### 3.2.2 交收

在风控驾驶舱的"图"区域展示：

- **按未来时间周期** → 驾驶舱"货量和未来交收货量"图表
  - 采购交收数量
  - 销售交收数量
  - 净交收数量
- **按过去时间周期** → 可在驾驶舱数据下钻中查看历史数据

#### 3.2.3 期货

在风控驾驶舱的"表"和"图"区域展示：

- **期货平仓盈亏** → 驾驶舱"盈亏-期货账户前五"表格（可下钻）
  - 下钻期货账户
    - 下钻到品种
      - 下钻到月份
- **期货浮动盈亏** → 可在驾驶舱数据下钻中查看
  - 下钻期货账户
    - 下钻到品种
      - 下钻到月份
- **期货品种多头持仓量** → 可在驾驶舱数据下钻中查看
  - 下钻期货账户
    - 下钻到月份
- **期货品种空头持仓量** → 可在驾驶舱数据下钻中查看
  - 下钻期货账户
    - 下钻到月份
- **期货品种净持仓量** → 可在驾驶舱数据下钻中查看
  - 下钻期货账户
    - 下钻到月份

#### 3.2.4 预测

在风控驾驶舱的"图"区域展示：

- **VaR测试** → 驾驶舱"VAR指标"图表，点击可跳转到"VaR测试"页面查看详情
- **压力测试** → 可在"压力测试"页面查看，驾驶舱可显示简要结果卡片

#### 3.2.5 异常提醒
- **行情**
  - N日涨幅超过N%
  - N日跌幅超过N%
- **可能异常**
  - 有持仓今天过后就是交割月
  - 有持仓今天过后就是交割日
  - 有期权持仓今天过后就是行权日
    - 期权行权保证金预估
  - 当日未完成的指令
  - 节前最后交易日
  - 离最后点价期还有N天，还没点完
  - 有期货账户的保值额度未设置
  - 期货账户占用保证金超账户权益的N%
- **已经异常**
  - 合同关联的期货敞口数量大于合同数量的N%
  - 有系统外报单被回收，没有标注保值方案
  - 期货账户登录异常
  - 按交易日现货价格录入不连续
  - 均价合同缺少均价标的、标的价格、均价周期
  - 点价点超了
  - 采销匹配数量越界
  - 未配置敞口系数和期货

---

## 四、风控设置

### 4.1 目录路径
- 一级：风控宝
- 二级：风控设置

### 4.2 服务定位

作为"风控宝"的配置中心，对实时风控、事后风控及告警策略的参数进行统一配置。
- 由风控负责人/系统管理员维护，交易员和业务人员只使用结果，不直接改配置
- 这里所规定的风控仅为做告警记录
  - 期货报单阻止发出的相关设置项在：全局设置-期货账户设置-风控限制
  - 指令阻止发出的相关设置项在：指令宝-指令权限设置-人员指令权限设置、指令宝-指令权限设置-客商指令权限设置

### 4.3 异常提醒与告警策略设置

#### 4.3.1 行情类异常：行情涨跌幅度超预期

**N 日涨幅超过 N%**
- 设置项：N日（天数）、N%（涨幅阈值）
- 告警生成时机：即时每日一次
- 说明：作用于现货品牌中已经定义的所有期货品种的所有月份

**N 日跌幅超过 N%**
- 设置项：N日（天数）、N%（跌幅阈值）
- 告警生成时机：即时每日一次
- 说明：作用于现货品牌中已经定义的所有期货品种的所有月份

#### 4.3.2 可能异常

定义为不会产生即时影响，有可能故意为之，未来有可能发生问题。

**有持仓且距离交割月前 N 天**
- 设置项：N天
- 告警生成时机：交易日开始时提醒

**有期货持仓今天交割**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒

**有期权持仓且距离行权日前 N 天**
- 设置项：N天
- 告警生成时机：交易日开始时提醒

**有期权持仓今天行权**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒

**当日有未完成的指令**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒

**节前最后交易日**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒

**未全部点价且离最后点价日期还有 N 天**
- 设置项：N天
- 告警生成时机：交易日开始时提醒

**期货账户保值额度未设置**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒

**缺少现货价格录入**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒

**采销关联期货不一致**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒，每采销关联记录每日一次
- 说明：当采购合同与销售合同的采销关联关系中，关联的期货合约不一致时触发预警。用于提醒风控人员检查采销关联的期货合约配置是否正确。

#### 4.3.3 已经异常

定义为一定不正常，必须马上处理。

**期货账户占用保证金超账户权益的 N%**
- 设置项：N%
- 告警生成时机：即时每账户每日一次

**合同关联的期货敞口数量大于合同数量的 N%**
- 设置项：N%
- 告警生成时机：即时每合同每日一次

**发生系统外报单**
- 设置项：启用/禁用
- 告警生成时机：即时每次

**期货账户登录异常**
- 设置项：启用/禁用
- 告警生成时机：即时每账户每日一次

**均价合同缺少平台价字段**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒，每合同每日一次

**均价合同缺少平台价价格**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒，每合同每日一次

**均价合同缺少均价起止日**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒，每合同每日一次

**点价合同缺少点价期**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒，每合同每日一次

**合同缺少交收日期**
- 设置项：启用/禁用
- 告警生成时机：交易日结束时提醒，每合同每日一次

**点价越界**
- 设置项：启用/禁用
- 告警生成时机：即时每合同每日一次

**采销匹配数量越界**
- 设置项：启用/禁用
- 告警生成时机：即时每合同每日一次

**现货品牌未配置敞口系数和期货**
- 设置项：启用/禁用
- 告警生成时机：交易日开始时提醒，每品牌每日一次

**合同的期现关联不符合全局设置**
- 设置项：启用/禁用
- 告警生成时机：即时提醒，每合同每日一次

**期货报单阻止发出告警**
- 设置项：启用/禁用
- 告警生成时机：即时提醒

**指令阻止发出告警**
- 设置项：启用/禁用
- 告警生成时机：即时提醒

**创建N天后未指定采销关系**
- 设置项：N天（正整数）
- 告警生成时机：交易日开始时提醒，每合同每日一次
- 说明：当采购合同或销售合同创建超过N天后，仍未指定采销关联关系时触发告警。用于监控采销关联的及时性，确保合同能够及时完成匹配。
- 触发条件：合同创建日期 + N天 < 当前日期，且该合同未建立任何采销关联关系

### 4.4 告警触发后的通知方式

- 系统缺省只生成告警记录
- 系统提供转通知功能，每个人员登录系统后的工作台中都有"通知记录"二级目录，里面有通知记录

### 4.5 告警通知查看权限

- 超管的系统后台
- 风控员的风控工作台

### 4.6 告警变更留痕

- 告警记录界面上会有三个按钮，"关注"、"已处理"、"转通知"
- 人员工作台的通知记录中也有三个按钮，"关注"、"已处理"、"转通知"
- 人员在这条通知内点击三个按钮时都会对告警记录的备注增加一条记录，例如：
  - 张三 转通知 李四
  - 李四 关注
  - 李四 已处理

---

## 五、风控驾驶舱

### 5.1 目录路径
- 一级：风控宝
- 二级：风控驾驶舱

### 5.2 服务定位

- **一眼看风险**：从公司总体视角快速了解敞口、交收、期货、资金等关键风险指标的当前状态和趋势
- **支持数据下钻**：表、数据banner、记录、图都支持右侧抽屉展开，在抽屉中显示全面的原始数据表

### 5.3 界面布局

#### 5.3.1 表

**敞口**
- 保值方案敞口前五
- 合同敞口前五
- 期货敞口前五

**行情**
- 关联期货合约的波动前五

**盈亏**
- 采销关联盈利前五
- 期货账户前五
- 保值方案期货前五
- 期货品种前五

**资金占用**
- 采购合同前五
- 销售合同前五
- 期货账户权益前五
- 风险度前五

**需移仓**
- 期货合约前五

**需点价**
- 合同数量前五

**交易员**
- 成交的委托笔数前五
- 买日均价前五
- 卖日均价前五
- 指令数量完成度前五

#### 5.3.2 数据banner

**按现货品种**

**昨日采购订单**
- 定价数量
- 定价均价
- 期货关联卖数量
- 期货关联卖均价

**昨日销售订单定价数量**
- 定价数量
- 定价均价
- 期货关联买数量
- 期货关联买均价

**昨日采购长单定价数量**
- 定价数量
- 定价均价
- 期货关联卖数量
- 期货关联卖均价

**昨日销售长单定价数量**
- 定价数量
- 定价均价
- 期货关联买数量
- 期货关联买均价

**昨日采销关联**
- 关联数量
- 关联合同利润
- 关联期货利润

**昨日库存**
- 昨日库存货量
- 昨日库存均价

#### 5.3.3 记录

**点价和代点价指令记录**
- 列出最近五条

**风控告警未处理**
- 列出最近五条

#### 5.3.4 图

- 期货、现货、基差
- 货量和未来交收货量
- 保值额度使用
- VAR指标
- 压力测试

---

## 六、风控告警记录

### 6.1 目录路径
- 一级：风控宝
- 二级：风控告警记录

### 6.2 服务定位

- 统一展示所有由"风控设置"中配置的异常提醒规则触发生成的告警记录
- 支持按多维度筛选、查询、跟踪处理状态，是风控团队的"工作台"
- 与"风控设置"中配置的告警策略、与"风控驾驶舱"中的告警概览保持数据一致
- 告警记录缺省只生成记录，不阻断业务；如需通知相关人员，需通过"转通知"功能

### 6.3 数据来源与类型

#### 6.3.1 告警来源

异常提醒规则触发（对应"风控设置-异常提醒与告警策略设置"）

**行情类异常**
- N 日涨幅超过 N%
- N 日跌幅超过 N%

**可能异常**
- 有持仓距离交割月前 N 天开始预警
- 有期权持仓距离行权日前 N 天开始预警
- 有期权持仓今天交割，计算并展示期权行权保证金预估
- 当日有未完成的指令提醒
- 节前最后交易日
- 暂定价合同离最后点价期还有 N 天，还没点完
- 有期货账户的保值额度未设置
- 按交易日现货价格录入不连续
- 采销关联期货不一致

**已经异常**
- 期货账户占用保证金超账户权益的 N%
- 合同关联的期货敞口数量大于合同数量的 N%
- 有系统外报单被回收，没有标注保值方案
- 期货账户登录异常
- 均价合同缺少均价标的、标的价格、均价周期
- 点价点超了
- 采销匹配数量越界
- 现货品牌未配置敞口系数和期货
- 合同的现货品牌与期货品种对应关系不符合全局设置
- 创建N天后未指定采销关系
- 期货报单阻止发出（需在"风控设置"中启用告警记录）
- 指令阻止发出（需在"风控设置"中启用告警记录）

#### 6.3.2 告警生成时机说明

- **即时提醒**：规则触发时立即生成告警记录
- **交易日开始时提醒**：每个交易日开始时批量检查并生成告警记录
- **交易日结束时提醒**：每个交易日结束时批量检查并生成告警记录
- **每日一次**：同一对象同一规则在同一天内最多生成一条告警记录（避免频繁告警）
- **每次**：每次触发都生成告警记录

#### 6.3.3 告警分类

**按异常类型**
- 行情类异常
- 可能异常
- 已经异常

**按对象类型**
- 保值方案
- 合同（采购/销售/均价/点价/暂定价）
- 品种 / 品牌
- 期货账户 / 期权账户
- 具体合约（期货/期权）
- 系统/接口（如登录异常、报单阻止）

**按指标类型**
- 敞口类、限额类、资金类、行情类、交收类、系统类等

### 6.4 主列表设计

#### 6.4.1 列表字段

- 告警时间
- 告警编号（系统自动生成）
- 异常类型（行情类异常 / 可能异常 / 已经异常）
- 告警对象类型（保值方案/合同/品种/品牌/期货账户/合约/系统等）
- 告警对象名称/标识（如：保值方案名称、合同号、期货账户、合约代码等）
- 指标类型/规则名称（如：N 日涨幅超过 N%、有持仓距离交割月前 N 天、期货账户占用保证金超账户权益的 N% 等）
- 当前值（如适用）（如：实际涨幅、距离交割月天数、保证金占用比例等）
- 阈值/规则描述（如适用）（如：N%、N天、N% 等）
- 处理状态（未处理 / 已处理 / 关注中）
- 处理人
- 最近处理时间
- 备注（显示最近几条处理记录摘要）

#### 6.4.2 筛选条件

- **时间范围**：支持按告警时间区间筛选（近 1 日/近 7 日/近 30 日/自定义）
- **异常类型**：多选（行情类异常 / 可能异常 / 已经异常）
- **告警状态**：未处理 / 已处理 / 关注中
- **对象维度**
  - 保值方案（多选）
  - 期货账户（多选）
  - 品种/品牌（多选）
  - 合同号（支持模糊搜索）
- **指标类型/规则名称**：支持按具体规则名称筛选
- **处理人**：支持按处理人筛选

#### 6.4.3 排序与分页

- 默认按告警时间倒序
- 支持按异常类型、状态、指标类型、对象等字段排序

### 6.5 告警详情与处理

#### 6.5.1 告警详情页/侧滑面板

**基本信息**
- 告警时间、编号、异常类型、对象、指标类型/规则名称

**指标数据**
- 触发时的当前值（如适用）
- 阈值/规则说明（如适用）
- 相关历史数据简要（如近几日同指标的走势，如适用）

**上下文信息**
- 与该告警相关的合同/持仓/账户的核心信息（只读）

**规则配置来源**
- 提供"查看规则配置"入口，跳转到"风控设置"中对应的规则配置页面（只读或根据权限可编辑）

#### 6.5.2 处理记录

**处理动作记录列表**
- 每次处理记录操作人、时间、处理动作、备注
- 处理动作包括：关注、已处理、转通知（转给XXX）

**当前状态**
- 状态字段由最近一条处理记录决定（未处理/已处理/关注中）

#### 6.5.3 支持的处理动作

**【关注】**
- 表示该告警需要持续关注，暂不关闭
- 操作后状态变为"关注中"
- 操作会记录到告警记录的备注中，格式如：张三 关注

**【已处理】**
- 表示已确认并完成相应业务/风控动作
- 操作后状态变为"已处理"
- 操作会记录到告警记录的备注中，格式如：张三 已处理

**【转通知】**
- 将该告警信息转发给某一或多位用户
- 转发后，被转发的用户在其工作台的"通知记录"中可以看到该通知
- 操作会记录到告警记录的备注中，格式如：张三 转通知 李四
- 被转发的用户在工作台的"通知记录"中也可以对通知进行操作（关注、已处理、转通知），操作同样会记录到原告警记录的备注中

**批量处理**：支持批量处理，多选后点按钮操作

### 6.6 告警样式示例

以下展示各类告警在列表和详情页中的具体样式示例：

#### 6.6.1 行情类异常告警示例

**示例1：N 日涨幅超过 N%**

**列表显示：**
```
告警时间：2024-01-15 09:30:00
告警编号：ALM-20240115-001234
异常类型：行情类异常
告警对象类型：合约
告警对象名称：cu2403（沪铜2403合约）
指标类型/规则名称：5日涨幅超过5%
当前值：6.8%
阈值/规则描述：5%
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 09:30:00
告警编号：ALM-20240115-001234
异常类型：行情类异常
告警对象：cu2403（沪铜2403合约）
规则名称：5日涨幅超过5%

【指标数据】
当前涨幅：6.8%
阈值设置：5%
超出幅度：1.8%
计算周期：5个交易日（2024-01-10 至 2024-01-15）

【历史走势】
近5日价格变化：
2024-01-10：68,500元/吨
2024-01-11：69,200元/吨 (+1.02%)
2024-01-12：70,100元/吨 (+1.30%)
2024-01-13：71,500元/吨 (+2.00%)
2024-01-14：72,200元/吨 (+0.98%)
2024-01-15：73,158元/吨 (+1.33%)

【上下文信息】
关联保值方案：铜材保值方案A
关联期货账户：中信期货-账户001
当前持仓：多头50手
```

**示例2：N 日跌幅超过 N%**

**列表显示：**
```
告警时间：2024-01-15 14:20:00
告警编号：ALM-20240115-001235
异常类型：行情类异常
告警对象类型：合约
告警对象名称：al2403（沪铝2403合约）
指标类型/规则名称：3日跌幅超过3%
当前值：-4.2%
阈值/规则描述：-3%
处理状态：未处理
```

#### 6.6.2 可能异常告警示例

**示例1：有持仓距离交割月前 N 天开始预警**

**列表显示：**
```
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001236
异常类型：可能异常
告警对象类型：合约
告警对象名称：cu2402（沪铜2402合约）
指标类型/规则名称：有持仓距离交割月前15天开始预警
当前值：距离交割月还有12天
阈值/规则描述：15天
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001236
异常类型：可能异常
告警对象：cu2402（沪铜2402合约）
规则名称：有持仓距离交割月前15天开始预警

【指标数据】
当前日期：2024-01-15
合约交割月：2024年2月
距离交割月天数：12天
预警阈值：15天
建议处理时间：2024-01-18前

【上下文信息】
当前持仓：多头30手
持仓方向：多头
开仓均价：68,200元/吨
最新价：68,500元/吨
浮动盈亏：+9,000元
关联保值方案：铜材保值方案B
关联期货账户：中信期货-账户002

【建议操作】
1. 评估是否需要移仓至远月合约
2. 如需移仓，建议移仓至cu2403或cu2404
3. 如继续持有，需关注交割月持仓限制
```

**示例2：暂定价合同离最后点价期还有 N 天，还没点完**

**列表显示：**
```
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001237
异常类型：可能异常
告警对象类型：合同
告警对象名称：CG-202401-001234（采购合同）
指标类型/规则名称：暂定价合同离最后点价期还有5天，还没点完
当前值：距离最后点价期还有3天，未点价数量500吨
阈值/规则描述：5天
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001237
异常类型：可能异常
告警对象：CG-202401-001234（采购合同）
规则名称：暂定价合同离最后点价期还有5天，还没点完

【指标数据】
合同总数量：1,000吨
已点价数量：500吨
未点价数量：500吨
点价完成率：50%
最后点价期：2024-01-18
距离最后点价期：3天
预警阈值：5天

【上下文信息】
合同类型：采购合同
合同日期：2024-01-05
客商：XX贸易公司
品种：铜
品牌：A级铜
已点价均价：68,500元/吨
关联保值方案：铜材保值方案C

【建议操作】
1. 尽快完成剩余500吨的点价操作
2. 如无法在最后点价期前完成，需与客商协商延期或调整合同
```

**示例3：当日有未完成的指令提醒**

**列表显示：**
```
告警时间：2024-01-15 15:00:00
告警编号：ALM-20240115-001238
异常类型：可能异常
告警对象类型：指令
告警对象名称：INST-20240115-000123（买入指令）
指标类型/规则名称：当日有未完成的指令提醒
当前值：指令创建时间09:30，当前15:00仍未完成
阈值/规则描述：交易日结束时提醒
处理状态：未处理
```

**示例4：有期货账户的保值额度未设置**

**列表显示：**
```
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001239
异常类型：可能异常
告警对象类型：期货账户
告警对象名称：中信期货-账户003
指标类型/规则名称：有期货账户的保值额度未设置
当前值：未配置保值额度
阈值/规则描述：启用/禁用
处理状态：未处理
```

#### 6.6.3 已经异常告警示例

**示例1：期货账户占用保证金超账户权益的 N%**

**列表显示：**
```
告警时间：2024-01-15 10:15:00
告警编号：ALM-20240115-001240
异常类型：已经异常
告警对象类型：期货账户
告警对象名称：中信期货-账户001
指标类型/规则名称：期货账户占用保证金超账户权益的80%
当前值：占用保证金比例85.6%
阈值/规则描述：80%
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 10:15:00
告警编号：ALM-20240115-001240
异常类型：已经异常
告警对象：中信期货-账户001
规则名称：期货账户占用保证金超账户权益的80%

【指标数据】
账户权益：10,000,000元
占用保证金：8,560,000元
占用比例：85.6%
预警阈值：80%
超出比例：5.6%
可用资金：1,440,000元

【上下文信息】
账户状态：正常
持仓合约数：15个
总持仓手数：500手
持仓市值：85,600,000元
风险度：85.6%

【持仓明细】
合约代码 | 方向 | 手数 | 开仓均价 | 最新价 | 占用保证金
cu2403  | 多头 | 50   | 68,200   | 68,500 | 1,710,000
al2403  | 空头 | 100  | 18,500   | 18,300 | 1,830,000
...

【建议操作】
1. 立即降低持仓规模，释放保证金
2. 平仓部分持仓，将占用比例降至80%以下
3. 如需要继续持仓，考虑追加保证金
```

**示例2：合同关联的期货敞口数量大于合同数量的 N%**

**列表显示：**
```
告警时间：2024-01-15 11:20:00
告警编号：ALM-20240115-001241
异常类型：已经异常
告警对象类型：合同
告警对象名称：CG-202401-001235（采购合同）
指标类型/规则名称：合同关联的期货敞口数量大于合同数量的120%
当前值：期货敞口1,500吨，合同数量1,000吨，比例150%
阈值/规则描述：120%
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 11:20:00
告警编号：ALM-20240115-001241
异常类型：已经异常
告警对象：CG-202401-001235（采购合同）
规则名称：合同关联的期货敞口数量大于合同数量的120%

【指标数据】
合同数量：1,000吨
期货敞口数量：1,500吨（折算后）
敞口比例：150%
预警阈值：120%
超出比例：30%

【上下文信息】
合同类型：采购合同
合同日期：2024-01-10
品种：铜
品牌：A级铜
关联保值方案：铜材保值方案D

【期货关联明细】
合约代码 | 方向 | 手数 | 敞口系数 | 折算敞口(吨)
cu2403  | 买入 | 75   | 5        | 375
cu2404  | 买入 | 90   | 5        | 450
cu2405  | 买入 | 135  | 5        | 675
合计：1,500吨

【建议操作】
1. 检查期货敞口是否配置错误
2. 如敞口配置正确，需评估是否超出套保需求
3. 如超出套保需求，建议平仓部分期货持仓
```

**示例3：点价点超了**

**列表显示：**
```
告警时间：2024-01-15 14:30:00
告警编号：ALM-20240115-001242
异常类型：已经异常
告警对象类型：合同
告警对象名称：XS-202401-000567（销售合同）
指标类型/规则名称：点价点超了
当前值：合同数量1,000吨，已点价1,200吨，超出200吨
阈值/规则描述：启用/禁用
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 14:30:00
告警编号：ALM-20240115-001242
异常类型：已经异常
告警对象：XS-202401-000567（销售合同）
规则名称：点价点超了

【指标数据】
合同数量：1,000吨
已点价数量：1,200吨
超出数量：200吨
超出比例：20%

【点价明细】
点价时间 | 点价数量(吨) | 点价价格 | 累计点价
2024-01-10 10:00 | 500 | 68,500 | 500
2024-01-12 14:00 | 400 | 68,800 | 900
2024-01-15 14:30 | 300 | 69,000 | 1,200（超出200）

【上下文信息】
合同类型：销售合同
合同日期：2024-01-08
客商：YY贸易公司
品种：铜
品牌：A级铜

【建议操作】
1. 检查点价记录是否有误
2. 如点价无误，需与客商协商调整合同数量或取消超出的点价
3. 如无法调整，需记录异常原因并上报
```

**示例4：采销匹配数量越界**

**列表显示：**
```
告警时间：2024-01-15 13:45:00
告警编号：ALM-20240115-001243
异常类型：已经异常
告警对象类型：合同
告警对象名称：CG-202401-001236（采购合同）
指标类型/规则名称：采销匹配数量越界
当前值：采购合同数量1,000吨，已匹配销售数量1,200吨，超出200吨
阈值/规则描述：启用/禁用
处理状态：未处理
```

**示例5：现货品牌未配置敞口系数和期货**

**列表显示：**
```
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001244
异常类型：已经异常
告警对象类型：品牌
告警对象名称：B级铜
指标类型/规则名称：现货品牌未配置敞口系数和期货
当前值：品牌B级铜未配置敞口系数和期货品种对应关系
阈值/规则描述：启用/禁用
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 09:00:00
告警编号：ALM-20240115-001244
异常类型：已经异常
告警对象：B级铜（品牌）
规则名称：现货品牌未配置敞口系数和期货

【指标数据】
品牌名称：B级铜
品种：铜
配置状态：未配置敞口系数和期货品种对应关系

【影响范围】
涉及合同数量：5个
涉及保值方案：2个
无法计算敞口：是

【建议操作】
1. 前往全局设置-现货品牌配置，为B级铜配置敞口系数
2. 配置B级铜与期货品种的对应关系
3. 配置完成后，系统将自动重新计算相关敞口数据
```

**示例6：期货报单阻止发出**

**列表显示：**
```
告警时间：2024-01-15 10:30:00
告警编号：ALM-20240115-001245
异常类型：已经异常
告警对象类型：委托
告警对象名称：ORD-20240115-000456
指标类型/规则名称：期货报单阻止发出
当前值：报单被实时风控阻止，原因：超过账户持仓限额
阈值/规则描述：启用/禁用
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 10:30:00
告警编号：ALM-20240115-001245
异常类型：已经异常
告警对象：ORD-20240115-000456（委托单）
规则名称：期货报单阻止发出

【指标数据】
阻止时间：2024-01-15 10:30:00
阻止原因：超过账户持仓限额
阻止类型：实时风控阻止

【委托单信息】
委托单号：ORD-20240115-000456
合约代码：cu2403
委托方向：买入
委托手数：100手
委托价格：68,500元/吨
委托时间：2024-01-15 10:30:00
委托状态：已拒绝

【账户信息】
期货账户：中信期货-账户001
当前持仓：cu2403多头450手
账户持仓限额：500手
尝试委托后持仓：550手（超过限额）

【风控规则】
规则来源：全局设置-期货账户设置-风控限制
规则内容：cu2403合约持仓限额500手

【建议操作】
1. 如需继续交易，需先平仓部分持仓
2. 或申请调整账户持仓限额
3. 检查委托单是否正确，避免重复提交
```

**示例7：指令阻止发出**

**列表显示：**
```
告警时间：2024-01-15 09:45:00
告警编号：ALM-20240115-001246
异常类型：已经异常
告警对象类型：指令
告警对象名称：INST-20240115-000234
指标类型/规则名称：指令阻止发出
当前值：指令被权限控制阻止，原因：该交易员无此合约交易权限
阈值/规则描述：启用/禁用
处理状态：未处理
```

**示例8：期货账户登录异常**

**列表显示：**
```
告警时间：2024-01-15 09:05:00
告警编号：ALM-20240115-001247
异常类型：已经异常
告警对象类型：期货账户
告警对象名称：中信期货-账户002
指标类型/规则名称：期货账户登录异常
当前值：账户登录失败，连接超时
阈值/规则描述：启用/禁用
处理状态：未处理
```

**详情页显示：**
```
【基本信息】
告警时间：2024-01-15 09:05:00
告警编号：ALM-20240115-001247
异常类型：已经异常
告警对象：中信期货-账户002
规则名称：期货账户登录异常

【指标数据】
异常时间：2024-01-15 09:05:00
异常类型：登录失败
错误信息：连接超时
重试次数：3次
最后成功登录时间：2024-01-14 15:00:00

【账户信息】
期货账户：中信期货-账户002
账户状态：异常
当前持仓：有持仓（需关注）
持仓手数：200手

【建议操作】
1. 检查网络连接是否正常
2. 检查账户配置是否正确
3. 联系期货公司技术支持
4. 如账户有持仓，需尽快恢复连接，避免影响交易
```

#### 6.6.4 告警列表统一格式说明

**列表行样式：**
- **未处理告警**：背景色为浅红色（#FFF5F5），左侧有红色竖条标识
- **关注中告警**：背景色为浅黄色（#FFFBF0），左侧有黄色竖条标识
- **已处理告警**：背景色为浅灰色（#F5F5F5），左侧有灰色竖条标识

**优先级标识：**
- **已经异常**：红色感叹号图标（🔴）
- **可能异常**：黄色警告图标（🟡）
- **行情类异常**：蓝色信息图标（🔵）

**状态标签：**
- 未处理：红色标签
- 关注中：黄色标签
- 已处理：灰色标签

**操作按钮：**
- 每行末尾显示操作按钮：【关注】、【已处理】、【转通知】
- 已处理状态的行不显示操作按钮，仅显示"查看详情"

### 6.7 与工作台通知记录的联动

#### 6.6.1 数据同步

- 当告警记录被"转通知"后，会在被通知人员的工作台"通知记录"中生成一条通知记录
- 通知记录与告警记录关联，但展示方式更简洁（适合工作台快速查看）

#### 6.6.2 操作联动

- 在告警记录界面点击"关注/已处理/转通知"，操作会记录到告警记录的备注中
- 在工作台的通知记录中点击"关注/已处理/转通知"，操作同样会记录到原告警记录的备注中
- 两个界面的操作状态保持同步

#### 6.6.3 跳转关系

- 从工作台的通知记录可以跳转到"风控告警记录"的详情页查看完整信息
- 从"风控告警记录"可以查看该告警的所有通知记录（哪些人收到了通知、处理状态如何）

### 6.8 与风控设置、驾驶舱的联动

#### 6.8.1 与风控设置的联动

- **告警生成规则**：所有告警记录都应能在"风控设置-异常提醒与告警策略设置"中找到对应的规则来源
- **规则追踪**：在告警详情中提供"查看规则配置"入口，跳转到对应的风控配置页面（只读或根据权限可编辑）
- **规则参数显示**：告警详情中显示触发该告警的规则参数（如：N%、N天等），便于理解告警原因

#### 6.8.2 与风控驾驶舱的联动

- **数据一致性**：驾驶舱中的"今日新增预警数量/未处理预警数量"和分类型统计，均基于本页数据计算
- **快捷过滤**：从驾驶舱点击某个告警聚合（如某方案的未处理告警），可直接跳转到本页，带入筛选条件
- **快捷处理**：在驾驶舱的预警列表中可以直接进行快捷处理（关注、已处理），操作同步到本页

### 6.9 权限与审计

#### 6.9.1 查看权限

- 超管的系统后台：可查看所有告警记录
- 风控员的风控工作台：可查看所有告警记录
- 其他人员：通过"转通知"功能接收通知后，可在工作台查看被转发的通知记录

#### 6.9.2 处理权限

- 超管和风控员：可以处理所有告警记录
- 被转通知的人员：可以处理自己收到的通知记录（操作会同步到原告警记录）

#### 6.9.3 审计要求

- 所有告警处理操作需留痕：
  - 包括操作人、时间、处理动作（关注/已处理/转通知）、备注
  - 备注中记录所有处理历史，格式如：
    - 张三 转通知 李四
    - 李四 关注
    - 李四 已处理
- 支持按时间/处理人/对象/规则查询历史处理情况，为风控复盘提供依据

### 6.10 红点提醒

- 记录上一次页面打开，显示到哪一条警告记录
- 之后有新来的告警记录或者通知记录，会在二级目录上显示一个红点
- 点开告警记录或者通知记录，会在上次之后的条目上显示new
- 以此反复，这个记录应该是记在期现服务器上的

---

## 七、VaR测试

### 7.1 目录路径
- 一级：风控宝
- 二级：VaR测试

### 7.2 服务定位

- **量化风险敞口**：通过VaR（Value at Risk）方法，量化在给定置信度和时间周期下的最大可能损失
- **支持多维度分析**：支持按保值方案维度或期货账户维度分别计算，反映不同层面的风险敞口
- **历史回测验证**：通过历史回测验证VaR模型的准确度，评估模型的有效性

### 7.3 整体布局

#### 7.3.1 顶部筛选区

**维度筛选**
- 保值方案（多选）
- 现货品种、品牌（多选）
- 期货账户（多选）

**维度选择器（重要）**
- **保值方案维度**
  - 基于期现关联关系的逻辑持仓
  - 反映业务逻辑层面的风险敞口
  - 用于业务风控，关注套保效果和敞口管理
- **期货账户维度**
  - 基于实际开平仓结果的物理持仓
  - 反映实际持仓层面的风险敞口
  - 用于资金风控，关注实际持仓风险和保证金占用

**时间维度**
- 计算基准日（当前日/选定交易日）
- 历史数据窗口长度（如250个交易日、500个交易日）

**计算方法选择**
- 历史模拟法
- 蒙特卡洛模拟法
- 参数法（方差-协方差法）

#### 7.3.2 参数配置区

**置信度设置**
- 95%（常用）
- 99%（更保守）
- 自定义（90%、97.5%等）

**时间周期设置**
- 1日VaR
- 10日VaR
- N日VaR（自定义）

**历史数据窗口长度**
- 250个交易日（约1年）
- 500个交易日（约2年）
- 自定义窗口长度

**期货价格连续合约类型选择（重要）**
- **主连（主力连续）**
  - 使用主力合约拼接的历史价格序列
  - 适用于大多数VaR计算场景
  - 反映主力合约的价格走势
- **近月连续**
  - 使用近月合约拼接的历史价格序列
  - 适用于关注近月合约的场景
  - 反映近月合约的价格走势
- **指数连续**
  - 使用指数合约的历史价格序列
  - 适用于需要平滑价格波动的场景
  - 反映整体品种的价格走势

**注意**：不同的连续合约类型会影响历史价格数据，进而影响VaR计算结果

#### 7.3.3 核心结果展示区

**VaR数值卡片**
- 显示当前VaR数值（金额）
- 置信度标识（如95%、99%）
- 时间周期标识（如1日、10日）
- 信号灯（红/黄/绿）表示风险等级
- 与阈值的对比（如：VaR / 风险限额）

**风险等级说明**
- 绿色：VaR在安全范围内
- 黄色：VaR接近风险限额
- 红色：VaR超过风险限额

#### 7.3.4 分析图表区

**VaR趋势图**
- 时间序列图，展示VaR的历史变化趋势
- 支持按日/按周/按月查看
- 可叠加实际损失数据，进行回测对比

**VaR贡献度分析**
- 按保值方案拆分的VaR贡献度（保值方案维度）
- 按期货账户拆分的VaR贡献度（期货账户维度）
- 按品种拆分的VaR贡献度
- 按品牌拆分的VaR贡献度
- 饼图或柱状图展示各维度的贡献占比

**VaR分布图**
- 展示VaR的概率分布
- 显示不同置信度下的VaR值
- 帮助理解风险分布特征

#### 7.3.5 历史回测区

**回测结果统计**
- 回测期间内实际损失超过VaR的次数
- 回测期间内实际损失超过VaR的频率
- 回测准确度评估（如：95%置信度下，实际损失超过VaR的频率应接近5%）

**回测对比图**
- 实际损失 vs VaR预测的对比图
- 标注超过VaR的异常点
- 帮助评估模型的准确性

#### 7.3.6 明细数据区

**持仓明细表**
- 展示参与VaR计算的持仓明细
- 字段包括：
  - 保值方案/期货账户（根据选择的维度）
  - 品种
  - 品牌（保值方案维度）
  - 合约代码
  - 持仓方向（买入/卖出 或 多头/空头）
  - 持仓数量（手数）
  - 当前价格
  - 敞口系数（保值方案维度）
  - 持仓价值
  - 风险贡献度
- 支持排序、筛选、导出

### 7.4 交互功能

#### 7.4.1 计算触发

- **手动计算**：点击"计算VaR"按钮，根据当前筛选条件和参数进行计算
- **自动计算**：可设置定时自动计算（如每日收盘后自动计算）
- **参数变更时提示**：修改参数后提示需要重新计算

#### 7.4.2 维度切换

- 在保值方案维度和期货账户维度之间切换
- 切换时自动重新计算VaR
- 保留各自的筛选条件和参数设置

#### 7.4.3 下钻功能

- 从公司整体 → 保值方案/期货账户 → 品种 → 品牌/月份 → 合约明细
- 点击图表元素（如饼图的扇形、柱状图的柱子）进入下钻视图
- 支持返回上一级视图

#### 7.4.4 参数调整

- **实时预览**：调整参数后显示参数变更提示，需要重新计算
- **参数对比**：支持保存多组参数配置，对比不同参数下的VaR结果
- **参数历史**：记录参数变更历史，支持回退到历史参数配置

#### 7.4.5 导出功能

- **导出VaR报告**（Excel/PDF）：包含VaR数值、参数设置、分析图表、明细数据
- **导出明细数据**（Excel/CSV）：导出参与计算的持仓明细

#### 7.4.6 刷新功能

- **手动刷新**：点击刷新按钮更新最新数据
- **自动刷新**：可设置自动刷新间隔（如每5分钟）

### 7.5 数据来源

#### 7.5.1 持仓数据

**保值方案维度**
- 数据来源：期现关联记录（期现备注表）+ 期货委托/成交记录（按保值方案归属）
- 计算方式：按保值方案、合约、买卖方向进行对冲计算
- 关键字段：保值方案_id、合约代码、买卖方向、关联手数、敞口系数

**期货账户维度**
- 数据来源：交易所实际持仓数据（来自交易宝/快期行情服务）
- 计算方式：基于实际开平仓结果，按期货账户、合约、方向统计
- 关键字段：期货账户_id、合约代码、持仓方向、持仓手数、开仓均价、最新价

#### 7.5.2 价格数据

**期货价格历史数据**
- 数据来源：快期行情服务、历史行情数据库
- 连续合约类型：主连/近月连续/指数连续（在参数配置中选择）
- 历史数据窗口：根据配置的窗口长度获取

**现货价格历史数据**
- 数据来源：现货价格历史数据（按品种/品牌）
- 用于计算基差历史数据

**实时行情**
- 期货实时价格：用于当前持仓估值
- 现货实时价格：用于计算当前敞口

#### 7.5.3 配置数据

- 保值方案配置
- 期货账户配置
- 现货品种与品牌配置
- 敞口系数配置（品牌 × 期货合约的敞口系数）

### 7.6 计算方法说明

#### 7.6.1 历史模拟法

**原理**：使用历史价格数据模拟未来价格走势

**步骤**：
1. 获取历史价格数据（根据选择的连续合约类型）
2. 计算历史收益率序列
3. 将历史收益率应用到当前持仓，得到模拟的盈亏分布
4. 根据置信度，从盈亏分布中提取VaR值

**优点**：不需要假设价格分布，能捕捉非正态分布特征

**缺点**：依赖历史数据质量，可能无法反映未来新情况

#### 7.6.2 蒙特卡洛模拟法

**原理**：通过随机模拟生成大量可能的价格路径

**步骤**：
1. 估计价格波动的统计参数（均值、方差、相关性）
2. 生成大量随机价格路径
3. 计算每条路径下的盈亏
4. 根据置信度，从盈亏分布中提取VaR值

**优点**：可以模拟复杂的价格动态，考虑相关性

**缺点**：计算量大，需要估计准确的参数

#### 7.6.3 参数法（方差-协方差法）

**原理**：假设价格变化服从正态分布，使用均值和方差估计

**步骤**：
1. 计算持仓的方差-协方差矩阵
2. 根据置信度，从正态分布中提取分位数
3. 计算VaR = 持仓价值 × 波动率 × 分位数

**优点**：计算快速，易于理解

**缺点**：假设正态分布可能不符合实际情况

### 7.7 结果解读

#### 7.7.1 VaR数值含义

例如："95%置信度下，1日VaR = 500万元"
- 含义：在95%的置信度下，未来1天内，持仓的最大可能损失不超过500万元
- 注意：VaR是概率意义上的估计，不是绝对保证

#### 7.7.2 风险等级判断

- 绿色：VaR在安全范围内，风险可控
- 黄色：VaR接近风险限额，需要关注
- 红色：VaR超过风险限额，需要采取措施降低风险

#### 7.7.3 VaR贡献度分析

- 帮助识别哪些保值方案/账户/品种/品牌对总VaR的贡献最大
- 可以针对性地调整高风险敞口

#### 7.7.4 历史回测验证

- 如果回测期间内实际损失超过VaR的频率接近预期（如95%置信度下约5%），说明模型较准确
- 如果频率明显偏离预期，需要检查模型参数或方法

### 7.8 与风控设置的联动

#### 7.8.1 参数读取

- VaR计算方法、置信度、时间周期、历史数据窗口长度、期货价格连续合约类型等参数
- 均从"风控设置"中读取（如果已配置）
- 也可以在VaR测试页面直接修改（仅本次计算生效，不保存到配置）

#### 7.8.2 阈值告警

- 当VaR超过风控设置中配置的阈值时，触发告警
- 告警记录在"风控告警记录"中
- 可在风控驾驶舱中查看告警概览

#### 7.8.3 结果联动

- VaR计算结果可以跳转到风控驾驶舱查看整体风险概览
- 风控驾驶舱中可以显示VaR指标卡片（简要信息），点击跳转到VaR测试页面查看详情

### 7.9 权限与视图

#### 7.9.1 角色权限

- 风控人员：可以查看所有维度的VaR，可以修改参数进行计算
- 交易员/业务员：可以查看自己相关保值方案/账户的VaR，不能修改全局参数
- 管理层：可以查看公司整体的VaR，关注风险趋势

#### 7.9.2 个性化设置（可选二开）

- 不同角色可定义自己的常用参数配置和默认筛选条件
- 支持保存个人参数模板

---

## 八、压力测试

### 8.1 目录路径
- 一级：风控宝
- 二级：压力测试

### 8.2 服务定位

- **极端风险测试**：通过压力测试，评估在极端市场情景下的潜在损失，补充VaR在极端情况下的不足
- **多场景分析**：支持多种压力测试场景，包括历史极端日、跨市场联动、基差骤变、汇率冲击等
- **支持多维度分析**：支持按保值方案维度或期货账户维度分别测试，反映不同层面的极端风险

### 8.3 整体布局

#### 8.3.1 顶部筛选区

**维度筛选**
- 保值方案（多选）
- 现货品种、品牌（多选）
- 期货账户（多选）

**维度选择器（重要）**
- **保值方案维度**
  - 基于期现关联关系的逻辑持仓
  - 测试业务逻辑层面的极端风险
  - 用于业务风控，关注套保效果在极端情况下的表现
- **期货账户维度**
  - 基于实际开平仓结果的物理持仓
  - 测试实际持仓层面的极端风险
  - 用于资金风控，关注实际持仓在极端情况下的损失

**时间维度**
- 测试基准日（当前日/选定交易日）
- 历史数据窗口长度（用于历史极端日场景）

#### 8.3.2 场景配置区

**场景类型选择**

- **历史极端日**
  - 重现历史极端行情
  - 从历史数据中识别极端波动日
  - 应用极端日的价格变化到当前持仓
  - 注意：需要明确使用哪种连续合约类型的历史数据

- **跨市场联动**
  - 模拟多个市场同时发生极端波动
  - 考虑不同市场之间的相关性
  - 适用于多品种、多市场的组合持仓

- **基差骤变**
  - 模拟基差异常变化的情况
  - 基差 = 现货价格 - 期货价格
  - 注意：基差计算依赖期货价格，需要明确连续合约类型

- **汇率冲击**
  - 模拟汇率大幅波动的情况
  - 适用于涉及外汇的跨市场交易

- **自定义场景**
  - 用户可以自定义价格冲击幅度
  - 可以组合多个因素（价格、基差、汇率等）

**场景参数设置**

- **历史极端日场景**
  - 极端日识别标准（如：涨跌幅超过N%）
  - 历史数据窗口长度
  - 期货价格连续合约类型选择（主连/近月连续/指数连续）

- **跨市场联动场景**
  - 联动市场选择
  - 价格冲击幅度（各市场的涨跌幅）
  - 相关性参数

- **基差骤变场景**
  - 基差变化幅度（如：基差扩大/缩小N元）
  - 期货价格连续合约类型选择（主连/近月连续/指数连续）
  - 历史基差数据窗口

- **汇率冲击场景**
  - 汇率变化幅度（如：汇率升值/贬值N%）
  - 涉及的外汇品种

**期货价格连续合约类型选择（重要）**

- **主连（主力连续）**
  - 使用主力合约拼接的历史价格序列
  - 适用于大多数压力测试场景
  - 反映主力合约的价格走势

- **近月连续**
  - 使用近月合约拼接的历史价格序列
  - 适用于关注近月合约的场景
  - 反映近月合约的价格走势

- **指数连续**
  - 使用指数合约的历史价格序列
  - 适用于需要平滑价格波动的场景
  - 反映整体品种的价格走势

**注意**：不同的连续合约类型会影响历史价格数据，进而影响压力测试结果

#### 8.3.3 核心结果展示区

**损失区间卡片**
- 显示最坏情景下的损失区间（最小损失 ~ 最大损失）
- 显示各场景下的潜在损失
- 当前测试场景名称
- 风险等级标识（红/黄/绿）

**场景对比卡片**
- 多场景损失对比
- 最坏情景损失
- 风险等级评估

#### 8.3.4 分析图表区

**损失分布图**
- 展示各场景下的损失分布
- 柱状图或箱线图展示损失区间
- 标注最坏情景损失

**场景对比图**
- 多场景损失对比柱状图
- 横向对比不同场景下的损失
- 帮助识别最危险的场景

**历史极端日回放图**
- 展示历史极端日的价格走势
- 标注极端波动的时间点
- 帮助理解极端日的特征

#### 8.3.5 明细数据区

**持仓明细表**
- 展示参与压力测试的持仓明细
- 字段包括：
  - 保值方案/期货账户（根据选择的维度）
  - 品种
  - 品牌（保值方案维度）
  - 合约代码
  - 持仓方向（买入/卖出 或 多头/空头）
  - 持仓数量（手数）
  - 当前价格
  - 场景价格（极端情景下的价格）
  - 价格变化幅度
  - 损失金额
  - 敞口系数（保值方案维度）
- 支持排序、筛选、导出

### 8.4 交互功能

#### 8.4.1 测试触发

- **手动测试**：点击"执行压力测试"按钮，根据当前筛选条件和场景配置进行测试
- **批量测试**：支持同时执行多个场景的测试，对比结果
- **参数变更时提示**：修改场景参数后提示需要重新测试

#### 8.4.2 维度切换

- 在保值方案维度和期货账户维度之间切换
- 切换时自动重新执行测试
- 保留各自的筛选条件和场景配置

#### 8.4.3 场景管理

- **场景保存**：支持保存自定义场景配置，方便后续使用
- **场景模板**：提供常用场景模板，快速选择
- **场景对比**：支持同时执行多个场景，对比结果

#### 8.4.4 下钻功能

- 从公司整体 → 保值方案/期货账户 → 品种 → 品牌/月份 → 合约明细
- 点击图表元素（如柱状图的柱子）进入下钻视图
- 支持返回上一级视图

#### 8.4.5 参数调整

- **实时预览**：调整场景参数后显示参数变更提示，需要重新测试
- **参数对比**：支持保存多组场景配置，对比不同场景下的损失
- **参数历史**：记录场景参数变更历史，支持回退到历史配置

#### 8.4.6 导出功能

- **导出压力测试报告**（Excel/PDF）：包含损失区间、场景配置、分析图表、明细数据
- **导出明细数据**（Excel/CSV）：导出参与测试的持仓明细和损失明细

#### 8.4.7 刷新功能

- **手动刷新**：点击刷新按钮更新最新数据
- **自动刷新**：可设置自动刷新间隔（如每5分钟）

### 8.5 数据来源

#### 8.5.1 持仓数据

**保值方案维度**
- 数据来源：期现关联记录（期现备注表）+ 期货委托/成交记录（按保值方案归属）
- 计算方式：按保值方案、合约、买卖方向进行对冲计算
- 关键字段：保值方案_id、合约代码、买卖方向、关联手数、敞口系数

**期货账户维度**
- 数据来源：交易所实际持仓数据（来自交易宝/快期行情服务）
- 计算方式：基于实际开平仓结果，按期货账户、合约、方向统计
- 关键字段：期货账户_id、合约代码、持仓方向、持仓手数、开仓均价、最新价

#### 8.5.2 价格数据

**期货价格历史数据**
- 数据来源：快期行情服务、历史行情数据库
- 连续合约类型：主连/近月连续/指数连续（在场景配置中选择）
- 历史数据窗口：根据配置的窗口长度获取
- 用于历史极端日场景识别

**现货价格历史数据**
- 数据来源：现货价格历史数据（按品种/品牌）
- 用于计算基差历史数据

**实时行情**
- 期货实时价格：用于当前持仓估值
- 现货实时价格：用于计算当前敞口

#### 8.5.3 市场数据

**历史极端行情数据**
- 用于"历史极端日"场景
- 注意：需要明确使用哪种连续合约类型的历史数据

**跨市场相关性数据**
- 用于"跨市场联动"场景
- 不同市场之间的价格相关性

**汇率数据**
- 用于"汇率冲击"场景
- 历史汇率数据和实时汇率

**基差历史波动数据**
- 用于"基差骤变"场景
- 注意：基差计算依赖期货价格，连续合约类型会影响基差结果

#### 8.5.4 配置数据

- 保值方案配置
- 期货账户配置
- 现货品种与品牌配置
- 敞口系数配置（品牌 × 期货合约的敞口系数）

### 8.6 场景说明

#### 8.6.1 历史极端日场景

**原理**：从历史数据中识别极端波动日，将极端日的价格变化应用到当前持仓

**步骤**：
1. 根据选择的连续合约类型，获取历史价格数据
2. 计算历史日收益率
3. 识别极端波动日（如：涨跌幅超过N%）
4. 将极端日的价格变化应用到当前持仓，计算损失

**适用场景**：评估历史极端行情重现时的风险

**注意事项**：不同的连续合约类型会导致不同的极端日识别结果

#### 8.6.2 跨市场联动场景

**原理**：模拟多个市场同时发生极端波动，考虑市场间的相关性

**步骤**：
1. 选择联动市场（如：铜、铝、锌同时波动）
2. 设置各市场的价格冲击幅度
3. 考虑市场间的相关性（如：相关性系数）
4. 计算组合持仓的损失

**适用场景**：多品种、多市场的组合持仓

**注意事项**：需要准确估计市场间的相关性

#### 8.6.3 基差骤变场景

**原理**：模拟基差异常变化的情况，基差 = 现货价格 - 期货价格

**步骤**：
1. 根据选择的连续合约类型，计算历史基差
2. 识别基差异常变化的情况（如：基差扩大/缩小N元）
3. 将基差变化应用到当前持仓，计算损失

**适用场景**：评估基差异常变化对套保效果的影响

**注意事项**：基差计算依赖期货价格，连续合约类型会影响基差结果

#### 8.6.4 汇率冲击场景

**原理**：模拟汇率大幅波动的情况

**步骤**：
1. 识别涉及外汇的持仓
2. 设置汇率变化幅度（如：汇率升值/贬值N%）
3. 计算汇率变化对持仓价值的影响

**适用场景**：涉及外汇的跨市场交易

**注意事项**：需要准确识别涉及外汇的持仓

#### 8.6.5 自定义场景

**原理**：用户可以自定义价格冲击幅度，组合多个因素

**步骤**：
1. 用户设置各品种/合约的价格冲击幅度
2. 可以组合价格、基差、汇率等多个因素
3. 计算自定义场景下的损失

**适用场景**：针对特定风险点的定制化测试

**注意事项**：需要用户对市场有深入理解

### 8.7 结果解读

#### 8.7.1 损失区间含义

例如："历史极端日场景下，损失区间为 -800万元 ~ -1200万元"
- 含义：在历史极端日重现的情况下，持仓的损失可能在800万元到1200万元之间
- 最坏情景损失：-1200万元（最大损失）

#### 8.7.2 风险等级判断

- 绿色：损失在可承受范围内
- 黄色：损失接近风险限额，需要关注
- 红色：损失超过风险限额，需要采取措施降低风险

#### 8.7.3 场景对比分析

- 帮助识别哪些场景下的损失最大
- 可以针对性地防范高风险场景

#### 8.7.4 与VaR的对比

- **VaR**：在正常市场条件下的风险估计（概率意义）
- **压力测试**：在极端市场条件下的损失估计（情景分析）
- 两者互补，共同评估风险

### 8.8 与风控设置的联动

#### 8.8.1 参数读取

- 压力测试场景参数、期货价格连续合约类型等参数
- 均从"风控设置"中读取（如果已配置）
- 也可以在压力测试页面直接修改（仅本次测试生效，不保存到配置）

#### 8.8.2 阈值告警

- 当压力测试结果（最坏情景损失）超过风控设置中配置的阈值时，触发告警
- 告警记录在"风控告警记录"中
- 可在风控驾驶舱中查看告警概览

#### 8.8.3 结果联动

- 压力测试结果可以跳转到风控驾驶舱查看整体风险概览
- 风控驾驶舱中可以显示压力测试结果卡片（简要信息），点击跳转到压力测试页面查看详情

### 8.9 权限与视图

#### 8.9.1 角色权限

- 风控人员：可以查看所有维度的压力测试结果，可以修改场景参数进行测试
- 交易员/业务员：可以查看自己相关保值方案/账户的压力测试结果，不能修改全局场景配置
- 管理层：可以查看公司整体的压力测试结果，关注极端风险

#### 8.9.2 个性化设置（可选二开）

- 不同角色可定义自己的常用场景配置和默认筛选条件
- 支持保存个人场景模板

---

## 九、告警操作说明

### 9.1 对警告的操作

可以单选或多选：

- **【已处理】按钮**：代表这条风控我看过了，后续我自己处理，或已经处理
- **【转发】按钮**：在XXX的登录界面跳出需要手工关闭的窗口
- **【关注】按钮**：比如有一个均价期在过去的合同创建，我需要对他的期货交易特殊处理，处理完成后改为已处理

### 9.2 对警告的提示方式

- 警告列表

### 9.3 告警频率

- 报单阻止和指令阻止不限制频率
- 比如风险度，每次触发都告警会非常频繁，系统默认为日内一次

### 9.4 警告的触发条件是否支持用户自定义

- 指定风控类型的参数设置，不支持更自由的自定义
- 风控类型可以作为二开内容

---

## 十、数据来源和计算说明

### 10.1 总体原则

风控宝的数据计算基于"model + 事件流水"的架构，所有风险指标均来自以下几类基础对象和事件：

- 基础 model：合同（采购/销售）、采销关联记录、期货委托/成交/持仓、保值方案配置、敞口系数配置
- 事件流水：点价事件、期现关联事件、采销关联事件
- 风控配置：事后风控阈值配置（敞口比例、敞口绝对值）、实时风控设置（由实时交易风控服务维护）

风控宝不直接修改上述基础数据，只在此基础上进行汇总计算和阈值判断。

### 10.2 数据更新频率

- 实时风控相关数据（指令、委托、账户状态等）由实时风控服务和交易模块维护，风控宝主要消费其结果事件
- 敞口及事后风控相关汇总数据的更新建议策略：
  - 当日盘中可按需触发增量计算（例如每 N 分钟或关键事件后刷新）
  - 当日收盘后进行一次完整汇总计算，形成当日的风险快照，用于第二天的风险回顾与报表

---

## 十一、权限与审计

### 11.1 查看权限

- 超管的系统后台：可查看所有风控数据和告警记录
- 风控员的风控工作台：可查看所有风控数据和告警记录
- 其他人员：通过"转通知"功能接收通知后，可在工作台查看被转发的通知记录

### 11.2 处理权限

- 超管和风控员：可以处理所有告警记录
- 被转通知的人员：可以处理自己收到的通知记录（操作会同步到原告警记录）

### 11.3 配置权限

- 风控设置由风控负责人/系统管理员维护
- 交易员和业务人员只使用结果，不直接改配置

### 11.4 审计要求

- 所有告警处理操作需留痕
- 包括操作人、时间、处理动作（关注/已处理/转通知）、备注
- 支持按时间/处理人/对象/规则查询历史处理情况，为风控复盘提供依据

---

## 十二、模块间联动关系

### 12.1 实时风控与事后风控

- **实时风控**：由实时交易风控服务负责，对指令与委托在落地前/后的合规性进行即时判断（允许/拒绝/告警），并产生实时风控事件记录
- **事后风控**：由风控宝基于当日收盘后的汇总数据和阈值配置，批量计算是否存在敞口越界、超卖/超买、配置缺失等风险，并产生事后风控事件记录
- 两者在风控告警记录中统一展示，但数据来源与触发时机不同：
  - 实时风控偏"动作/行为控制"
  - 事后风控偏"结果/状态审查"

### 12.2 风控设置与告警记录

- 所有告警记录都应能在"风控设置-异常提醒与告警策略设置"中找到对应的规则来源
- 告警详情中提供"查看规则配置"入口，跳转到对应的风控配置页面

### 12.3 风控驾驶舱与其他模块

- 驾驶舱中的"今日新增预警数量/未处理预警数量"和分类型统计，均基于告警记录数据计算
- 从驾驶舱点击某个告警聚合，可直接跳转到告警记录页面，带入筛选条件
- 驾驶舱中可以显示VaR指标卡片和压力测试结果卡片，点击跳转到对应页面查看详情

---

## 附录：参考信息

### 参考文档
- 7_0风控相关问题解释.md
- 7_1实时交易要求.md
- 7_2事后风控的要求.md
- 7_3风控设置.md
- 7_4风控驾驶舱.md
- 7_5风控告警记录.md
- 7_7VaR测试.md
- 7_8压力测试.md

### 相关概念
- **敞口**：指未对冲的风险暴露，包括现货敞口和期货敞口
- **VaR**：Value at Risk，在险价值，量化在给定置信度和时间周期下的最大可能损失
- **压力测试**：评估在极端市场情景下的潜在损失
- **告警记录**：由风控规则触发生成的告警信息记录
- **实时风控**：对指令与委托在落地前/后的合规性进行即时判断（后端服务）
- **事后风控**：基于汇总数据和阈值配置，批量计算风险并生成告警记录（数据展示在驾驶舱）

---

## 十三、版本历史

### V1.0（2024-01-XX）

**定稿版本**

- ✅ 完成所有功能模块的产品方案设计
- ✅ 明确实时交易风控为后端服务，前端仅展示日志
- ✅ 明确事后风控数据在风控驾驶舱中的展示位置
- ✅ 补充实现状态说明章节
- ✅ 完善模块间联动关系说明
- ✅ 前端原型已完整实现：风控设置、风控驾驶舱、风控告警记录、VaR测试、压力测试

**主要更新内容**：
1. 新增"1.4 实现状态说明"章节，明确各模块的实现状态
2. 完善"二、实时交易风控"章节，明确为后端服务
3. 完善"三、事后风控"章节，明确与驾驶舱的对应关系
4. 增加版本历史记录

**文档状态**：✅ 已定稿，可用于开发实施
