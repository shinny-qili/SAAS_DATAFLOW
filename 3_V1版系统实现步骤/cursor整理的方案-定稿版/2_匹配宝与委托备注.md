# 匹配宝与委托备注产品方案

本文档描述「匹配宝」模块下的「匹配宝与委托备注」页面产品方案，定义委托单管理、期现备注、委托备注、批量匹配等功能的界面交互、数据来源、计算规则和约束条件。

---

## 一、界面功能描述

### 1.1 页面入口与权限

- **菜单路径**：一级菜单「匹配宝」→ 二级菜单「匹配宝与委托备注」
- **权限要求**：匹配员权限（页面操作需要匹配员权限）

### 1.2 委托单列表

#### 1.2.1 筛选条件

页面顶部提供筛选栏，支持以下筛选条件：

- **日期筛选**：单选按钮组，包含「当日」「历史」「自定义」三个选项
  - 选择「当日」时，仅显示当日的委托单
  - 选择「历史」时，显示除当日外的所有历史委托单
  - 选择「自定义」时，显示日期范围选择器，可指定起止日期范围
- **期货账户**：多选下拉框，可同时选择多个期货账户进行筛选
- **保值方案**：多选下拉框，可同时选择多个保值方案进行筛选
- **交易员**：多选下拉框，根据期货账户关联的交易员进行筛选
- **合约**：文本输入框，支持模糊搜索合约代码
- **方向**：单选下拉框，可选择「买入」或「卖出」
- **开平**：单选下拉框，可选择「开仓」「平仓」「平今」
- **挂单状态**：多选下拉框，可选择「未成」「部成」「全成」「已撤」「部成已撤」「错单」
- **短编号**：文本输入框，支持模糊搜索短编号

筛选栏右侧提供「重置」按钮，可一键清空所有筛选条件并恢复默认状态（默认显示当日数据）。

#### 1.2.2 工具栏按钮

页面工具栏提供以下操作按钮：

- **期现备注**：需选中一条委托单，打开期现备注编辑弹窗
- **委托备注**：需选中一条委托单，打开委托备注编辑弹窗
- **批量匹配**：需选中至少一条委托单（支持多选），打开批量匹配弹窗
- **变更保值方案**：需选中至少一条委托单（支持多选），打开变更保值方案弹窗
- **解除关联**：需选中至少一条委托单（支持多选），打开解除关联弹窗，用于解除已匹配的期现备注关联
- **虚拟期货**：无需选择，直接打开虚拟期货创建弹窗，用于创建买卖保值方案之间的内部对冲虚拟期货头寸
- **导出**：导出当前筛选条件下的委托单列表数据

工具栏显示当前已选委托单数量，并提示「备注仅支持单条操作；批量匹配和指定匹配支持多选/全选」。

#### 1.2.3 表格列（一级字段）

委托单列表表格包含以下列，支持通过「自定义列」按钮配置显示/隐藏和列宽：

- **行选择**：多选框，支持多选委托单
- **期货账户**：显示委托单所属的期货账户
- **保值方案**：显示委托单关联的保值方案名称
- **日期时间**：显示委托单的日期时间
- **短编号**：显示委托单的短编号
- **合约**：显示期货合约代码
- **方向**：显示「买入」或「卖出」，使用颜色标签区分（买入为红色，卖出为绿色）
- **成交均价**：显示成交均价，右对齐
- **成交手数**：显示成交手数，右对齐，鼠标悬浮显示对应的吨数
- **未匹配手数**：根据已匹配期现备注的手数计算得出，右对齐，鼠标悬浮显示对应的吨数
- **期现备注**：以表中表形式展示该委托单下的所有期现备注，包含期现备注的二级字段
- **报单价格**：显示报单价格，右对齐
- **挂单状态**：显示挂单状态（未成/部成/全成/已撤/部成已撤/错单），使用不同颜色的标签区分
- **交易员**：显示该期货账户关联的交易员，多个交易员用逗号分隔
- **委托备注**：显示委托备注内容，内容过长时显示省略号，鼠标悬浮显示完整内容（支持 HTML 格式显示）

#### 1.2.4 期现备注二级字段

期现备注在表格中以表中表形式展示，包含以下二级字段，支持通过「期现备注列配置」按钮单独控制显示/隐藏：

- **手数**：期现备注的手数，右对齐，鼠标悬浮显示对应的吨数
- **现货数量**：现货数量，右对齐
- **点价价格**：点价价格，右对齐
- **标签**：标签名称，使用标签样式显示
- **备注**：备注文本，过长时显示省略号
- **客商**：客商简称
- **合同号**：合同编号
- **是否已匹配**：显示「是」或「否」，使用标签样式区分（已匹配为绿色，未匹配为灰色）

#### 1.2.5 分页与列设置

- **分页**：默认每页显示 10 条记录，支持切换为 10/20/50/100 条每页
- **表格列设置**：支持自定义一级字段的显示/隐藏和列宽，配置保存在本地存储中
- **期现备注列设置**：支持自定义期现备注二级字段的显示/隐藏和列宽，配置保存在本地存储中

### 1.3 期现备注功能

#### 1.3.1 打开方式

选中一条委托单后，点击「期现备注」按钮，打开期现备注编辑弹窗。

#### 1.3.2 数据关系

一条期货委托单可以附加多条期现备注，每条期现备注是独立的记录。

#### 1.3.3 字段说明

期现备注弹窗中，每条期现备注包含以下字段：

- **手数**（必填）：数字类型，必须大于 0，支持小数
- **现货数量**（选填）：数字类型，可为空
- **点价价格**（选填）：数字类型，可为空
- **标签**（选填）：下拉选择，选项来源于该委托单所属保值方案配置的标签列表
- **备注**（选填）：文本输入框，可为空
- **合同号**（选填）：下拉选择，选项来源于同保值方案的合同列表
  - 仅当保值方案类型为「单单匹配」时，才允许选择合同
  - 如果保值方案不是「单单匹配」，该字段禁用并提示「当前保值方案不支持选择合同」
- **客商**（选填）：下拉选择，选项来源于客商列表
  - 如果已选择合同号，则客商字段自动禁用（不能同时选择合同和客商）
  - 如果已选择客商，选择合同号时会自动清空客商
- **是否已匹配**（只读）：开关控件，显示当前匹配状态，不可编辑

手数字段输入时，鼠标悬浮会显示对应的吨数（根据合约计算）。

#### 1.3.3.1 字段显示规则

期现备注弹窗中的字段显示根据保值方案类型和合同类型动态控制：

**情况一：保值方案为「整体匹配」「无合同客商」「无合同人员」**
- **不显示的字段**：现货数量、点价价格、合同号、客商
- **显示的字段**：手数、标签、备注、是否已匹配

**情况二：保值方案为「单单匹配」**
- **合同号**：优先显示，支持选择合同
- **客商**：不显示（因为优先选择合同，合同与客商互斥）
- **现货数量、点价价格**：根据所选合同的定价方式动态显示
  - 如果合同定价方式为「暂定价」：显示现货数量和点价价格字段，可选输入
  - 如果合同定价方式为「均价」：不显示现货数量和点价价格字段，也无需输入
- **其他字段**：手数、标签、备注、是否已匹配正常显示

#### 1.3.4 操作功能

- **新增期现备注**：点击弹窗底部的「新增期现备注」按钮，添加一条新的期现备注记录
- **编辑期现备注**：直接在表单中修改各字段值
- **删除期现备注**：点击每条期现备注卡片右上角的「删除」按钮，直接删除该条记录（无需确认对话框）

#### 1.3.5 数据验证

保存期现备注时，系统会进行以下验证：

- 期现备注中的总手数不能大于委托单的已成交手数
- 如果保值方案类型为「单单匹配」，才允许选择合同号
- 如果已选择合同号，则不能选择客商
- 手数字段必填且必须大于 0
- 如果保值方案为「整体匹配」「无合同客商」「无合同人员」，则不允许填写现货数量、点价价格、合同号、客商
- 如果保值方案为「单单匹配」且已选择合同：
  - 如果合同定价方式为「暂定价」，现货数量和点价价格为可选字段
  - 如果合同定价方式为「均价」，不允许填写现货数量和点价价格

#### 1.3.6 表格展示

期现备注在委托单列表的「期现备注」列中以表中表形式展示，根据列配置动态显示二级字段。如果委托单没有期现备注，该列显示「-」。

### 1.4 委托备注功能

#### 1.4.1 打开方式

选中一条委托单后，点击「委托备注」按钮，打开委托备注编辑弹窗。

#### 1.4.2 字段说明

委托备注弹窗包含一个文本输入框：

- **备注信息**：多行文本输入框，支持普通文本输入（不支持富文本编辑）

#### 1.4.3 操作功能

- **编辑委托备注**：在文本框中输入或修改备注内容
- **删除委托备注**：点击弹窗底部的「删除」按钮，直接清空委托备注（无需确认对话框）
- **保存**：点击「确认」按钮保存备注内容

#### 1.4.4 表格展示

委托备注在委托单列表的「委托备注」列中显示：
- 如果委托备注为空，显示空字符串
- 如果委托备注有内容，显示文本内容（去除 HTML 标签后的纯文本），超过 50 个字符时显示省略号
- 鼠标悬浮时，在提示框中显示完整的备注内容（支持 HTML 格式渲染）

### 1.5 批量匹配功能

#### 1.5.1 打开方式

选中至少一条委托单（支持多选）后，点击「批量匹配」按钮，打开批量匹配弹窗。如果未选择任何委托单，系统会自动取前 10 条委托单作为匹配对象。

#### 1.5.2 弹窗内容

批量匹配弹窗显示一个可编辑的分配确认表，包含以下列：

**期货信息列（只读显示）**：
- **保值方案**：显示委托单的保值方案名称
- **期货账户**：显示委托单的期货账户
- **日期时间**：显示委托单的日期时间（格式：MM-DD HH:mm:ss）
- **合约**：显示期货合约代码
- **方向**：显示买入/卖出，使用颜色标签区分
- **开平**：显示开仓/平仓/平今
- **标签**：显示该委托单第一条期现备注的标签（如果有）
- **价格**：显示成交均价

**可编辑列**：
- **手数**：可编辑的期货手数，默认值为该委托单的未匹配手数，支持修改，鼠标悬浮显示对应的吨数
- **合同号**：下拉选择，选项来源于同保值方案的合同列表，仅当保值方案为「单单匹配」且标签符合要求时必填
- **合同数量**：数字输入框，可选，非必填
- **合同价格**：数字输入框，可选，非必填

**状态列**：
- **匹配状态**：显示「可匹配」或「暂不可匹配」，使用颜色标签区分
  - 如果保值方案为「单单匹配」且标签属于需要合同的标签列表，但未选择合同号，则显示「需选择合同」的红色标签
  - 如果数据缺失，显示「数据缺失」的红色标签
  - 其他情况显示「可匹配」的绿色标签

#### 1.5.3 筛选与分页

弹窗顶部提供搜索框，支持按短编号、合约、账户、保值方案进行筛选。弹窗内表格支持分页，每页显示 10 条记录，显示总记录数和当前页记录数。

#### 1.5.4 匹配规则

系统根据以下规则判断是否可以进行匹配：

- 如果保值方案类型为「单单匹配」，且期现备注的标签属于以下列表之一，则必须指定合同号才能匹配：
  - 长单保值、长单增量、长单减量、长单取消
  - 订单接货保值、订单出货保值、订单增量、订单减量、订单取消
  - 买点价、卖点价、调敞口、代持
- 其他情况：绑定保值方案进行匹配即可

#### 1.5.5 操作流程

1. 选择一条或多条委托单
2. 点击「批量匹配」按钮
3. 在弹窗中查看和编辑分配确认表
4. 系统自动标记每条记录的匹配状态（可匹配/不可匹配）
5. 编辑需要修改的字段（手数、合同号、合同数量、合同价格）
6. 点击「确认匹配」按钮
7. 系统仅对符合匹配规则的记录执行匹配操作
8. 匹配完成后，弹出匹配结果弹窗，显示匹配成功的记录数量
9. 关闭匹配结果弹窗后，委托单列表自动刷新

### 1.6 解除关联功能

#### 1.6.1 打开方式

选中至少一条委托单（支持多选）后，点击「解除关联」按钮，打开解除关联弹窗。

#### 1.6.2 弹窗内容

解除关联弹窗列出所选委托单下所有已匹配的期现备注，以表格形式展示：

- **委托单**：显示短编号和合约代码
- **保值方案**：显示保值方案名称
- **标签**：显示期现备注的标签
- **期现备注手数**：显示期现备注的手数，鼠标悬浮显示对应的吨数
- **备注内容**：显示期现备注的备注文本
- **当前状态**：显示「已匹配」标签
- **是否解除关联**：复选框，可勾选需要解除关联的记录

#### 1.6.3 操作流程

1. 选择一条或多条委托单
2. 点击「解除关联」按钮
3. 在弹窗中查看已匹配的期现备注列表
4. 勾选需要解除关联的记录
5. 点击「确认」按钮
6. 系统解除选中记录的关联关系，并刷新委托单列表

如果所选委托单没有已匹配的期现备注，系统提示「所选委托没有已匹配的期现备注，无需解除关联」。

### 1.7 变更保值方案功能

#### 1.7.1 打开方式

选中至少一条委托单（支持多选）后，点击「变更保值方案」按钮，打开变更保值方案弹窗。

#### 1.7.2 限制条件

仅支持对尚未产生已匹配期现备注的委托变更保值方案。如果所选委托单中已有已匹配的期现备注，这些委托单不会出现在变更列表中，系统会提示「所选委托均已有已匹配的期现备注，不能变更保值方案」。

#### 1.7.3 弹窗内容

变更保值方案弹窗以表格形式展示可变更的委托单：

- **委托单**：显示短编号和合约代码
- **当前方案**：显示当前的保值方案名称（只读）
- **目标方案**：下拉选择，可选择目标保值方案

#### 1.7.4 操作流程

1. 选择一条或多条委托单
2. 点击「变更保值方案」按钮
3. 系统过滤出没有已匹配期现备注的委托单
4. 在弹窗中为每条委托单选择目标保值方案
5. 点击「确认」按钮
6. 系统更新委托单的保值方案，并刷新列表

### 1.8 虚拟期货功能

#### 1.8.1 功能说明

虚拟期货用于在买保值方案和卖保值方案之间创建一笔内部对冲的虚拟期货头寸，不直接对应真实交易。

#### 1.8.2 打开方式

无需选择委托单，直接点击「虚拟期货」按钮，打开虚拟期货创建弹窗。

#### 1.8.3 字段说明

虚拟期货创建弹窗包含以下字段：

- **买保值方案**（必填）：下拉选择，选择买保值方案
- **卖保值方案**（必填）：下拉选择，选择卖保值方案
- **合约**（必填）：文本输入框，输入合约代码（如 CU2401）
- **手数**（必填）：数字输入框，输入手数，必须大于等于 1
- **价格**（必填）：数字输入框，输入价格，必须大于等于 0

#### 1.8.4 操作流程

1. 点击「虚拟期货」按钮
2. 在弹窗中填写买保值方案、卖保值方案、合约、手数、价格
3. 点击「确认」按钮
4. 系统创建虚拟期货记录

---

## 二、数据来源和相关计算公式

### 2.1 数据来源

#### 2.1.1 委托单数据

委托单数据来源于期货交易系统，包含以下关键字段：
- 期货账户、保值方案、日期时间、短编号、合约、方向、开平
- 成交均价、成交手数、报单价格、挂单状态
- 期现备注列表、委托备注

#### 2.1.2 保值方案数据

保值方案数据来源于「全局设置」→「保值方案管理」，用于：
- 筛选委托单列表
- 获取期现备注的标签选项（从保值方案的标签配置中读取）
- 判断保值方案类型（整体匹配/单单匹配），决定是否允许选择合同
- 获取同保值方案的合同列表

#### 2.1.3 合同数据

合同数据来源于「合同宝」模块，用于：
- 期现备注中选择合同号（仅当保值方案为「单单匹配」时）
- 批量匹配中选择合同号（根据匹配规则决定是否必填）
- 合同列表根据保值方案过滤，仅显示同保值方案的合同
- 获取合同的定价方式（暂定价/均价），用于控制期现备注中现货数量和点价价格字段的显示

#### 2.1.4 客商数据

客商数据来源于「全局设置」→「客商管理」，用于：
- 期现备注中选择客商
- 如果已选择合同，则不能选择客商

#### 2.1.5 期货账户数据

期货账户数据来源于「全局设置」→「期货账户管理」，用于：
- 筛选委托单列表
- 获取期货账户关联的交易员列表

#### 2.1.6 交易员数据

交易员数据来源于「全局设置」→「人员管理」，通过期货账户关联获取，用于：
- 筛选委托单列表
- 在委托单列表中显示交易员信息

#### 2.1.7 期现备注数据

期现备注数据来源于多个渠道，所有来源的期现备注数据都会同步到委托单的期现备注列表中：

**数据来源渠道**：

1. **批量匹配操作**（本页面）
   - 在「匹配宝与委托备注」页面通过批量匹配功能创建的期现备注
   - 匹配成功后，系统自动创建期现备注记录
   - 期现备注的「是否已匹配」字段自动设置为 `true`
   - 包含信息：手数、合同号（如适用）、合同数量、合同价格、标签等

2. **合同宝匹配操作**
   - 在「合同宝」模块通过期现关联匹配功能创建的期现备注
   - 当用户在合同关联弹出框中进行期现关联匹配操作时，系统自动创建期现备注记录
   - 期现备注的「是否已匹配」字段自动设置为 `true`
   - 包含信息：委托_id、合同_id、手数、现货数量、点价价格、标签等
   - **所有通过合同宝匹配的结果都会自动同步到委托单的期现备注列表中**

3. **指令匹配操作**（指令宝）
   - 通过「指令宝」模块的指令匹配功能创建的期现备注
   - 当指令与委托单完成匹配时，系统自动创建期现备注记录
   - 期现备注的「是否已匹配」字段自动设置为 `true`
   - **所有通过指令匹配的结果都会自动同步到委托单的期现备注列表中**

4. **手动创建**（本页面）
   - 在「匹配宝与委托备注」页面通过期现备注弹窗手动新增的期现备注
   - 手动创建的期现备注默认「是否已匹配」字段为 `false`
   - 用户可以在弹窗中编辑所有字段

**数据同步机制**：

- 所有通过匹配操作（批量匹配、合同宝匹配、指令匹配）创建的期现备注，都会作为期现关联事件记录在系统中
- 这些期现关联事件会自动同步到对应委托单的期现备注列表中
- 委托单列表中的期现备注数据是实时从期现关联事件中聚合生成的
- 确保委托单列表中的期现备注数据与各模块的匹配操作结果保持一致

**数据一致性**：

- 期现备注数据统一存储在期现关联事件表中
- 委托单列表中的期现备注是通过关联查询期现关联事件表获取的
- 任何模块的匹配操作都会更新期现关联事件表，从而自动反映在委托单的期现备注列表中

### 2.2 计算公式

#### 2.2.1 未匹配手数计算

未匹配手数 = 委托单的成交手数 - 已匹配期现备注的手数总和

其中，已匹配期现备注的手数总和 = 该委托单下所有 `isMatched = true` 的期现备注的手数（qty）之和。

#### 2.2.2 手数转吨数计算

手数转吨数的计算依赖于期货合约的规格，不同合约的每手吨数不同。系统在显示手数时，会同时计算并显示对应的吨数，通过鼠标悬浮提示的方式展示。

计算公式：吨数 = 手数 × 合约每手吨数

合约每手吨数需要从合约配置或全局设置中获取。

#### 2.2.3 期现备注总手数验证

保存期现备注时，需要验证：
期现备注总手数 = 所有期现备注的手数（qty）之和 ≤ 委托单的成交手数

如果超过，系统提示错误并阻止保存。

### 2.3 匹配规则计算

#### 2.3.1 批量匹配规则判断

系统根据以下逻辑判断批量匹配记录是否符合匹配规则：

1. 检查委托单和保值方案是否存在，如果不存在，标记为「数据缺失」，不可匹配
2. 如果保值方案类型为「单单匹配」：
   - 获取该委托单的第一条期现备注的标签
   - 如果标签属于需要合同的标签列表（长单保值、长单增量、长单减量、长单取消、订单接货保值、订单出货保值、订单增量、订单减量、订单取消、买点价、卖点价、调敞口、代持）
   - 则必须选择合同号，否则标记为「需选择合同」，不可匹配
3. 其他情况：标记为「可匹配」

#### 2.3.2 匹配状态实时更新

批量匹配弹窗中的「匹配状态」列会根据用户的操作实时更新：
- 当用户选择或清空合同号时，系统重新计算匹配状态
- 如果从「不可匹配」变为「可匹配」，状态标签自动更新为绿色
- 如果从「可匹配」变为「不可匹配」，状态标签自动更新为红色并显示原因

---

## 三、数据一致性和数据约束

### 3.1 外键与引用完整性

#### 3.1.1 期现备注的外键约束

期现备注记录统一存储在期现关联事件表中，必须关联有效的委托单：
- `期货id`（futuresId）必须指向有效的委托单记录
- 删除委托单时，需要级联删除或处理关联的期现备注（期现关联事件）
- 期现备注数据来源于期现关联事件，委托单列表中的期现备注是通过关联查询期现关联事件表获取的

期现备注中的可选外键：
- `客商id`（customerId）：如果填写，必须指向「客商管理」中的有效客商记录
- `合同id`（contractId）：如果填写，必须指向「合同宝」中的有效合同记录，且该合同必须与委托单的保值方案一致

#### 3.1.2 期现关联事件的数据同步

期现备注数据来源于期现关联事件，系统需要保证以下数据同步：

- **批量匹配操作**：在「匹配宝与委托备注」页面完成批量匹配后，系统自动创建期现关联事件，并同步到委托单的期现备注列表
- **合同宝匹配操作**：在「合同宝」模块完成期现关联匹配后，系统自动创建期现关联事件，并同步到委托单的期现备注列表
- **指令匹配操作**：在「指令宝」模块完成指令匹配后，系统自动创建期现关联事件，并同步到委托单的期现备注列表
- **数据实时性**：委托单列表中的期现备注数据需要实时反映期现关联事件表中的最新状态，确保各模块的匹配操作结果都能及时显示

#### 3.1.3 委托备注的外键约束

委托备注必须关联有效的委托单：
- `期货id`（futuresId）必须指向有效的委托单记录
- 一个委托单只能有一条委托备注（一对一关系）

#### 3.1.4 保值方案引用约束

委托单的保值方案必须来自「全局设置」→「保值方案管理」：
- 如果保值方案被禁用，不影响已有委托单的显示
- 新建或编辑期现备注时，标签选项必须从当前保值方案的标签配置中获取
- 变更保值方案时，目标保值方案必须处于启用状态

### 3.2 数据验证约束

#### 3.2.1 期现备注数据验证

- **手数**：必填，必须大于 0，支持小数
- **总手数限制**：所有期现备注的手数之和不能超过委托单的成交手数
- **合同与客商互斥**：如果已选择合同号，则不能选择客商；如果已选择客商，选择合同号时会自动清空客商
- **合同选择限制**：仅当保值方案类型为「单单匹配」时，才允许选择合同号
- **标签来源**：标签选项必须从委托单所属保值方案的标签配置中获取
- **字段显示与填写限制**：
  - 如果保值方案类型为「整体匹配」「无合同客商」「无合同人员」，则不允许填写现货数量、点价价格、合同号、客商字段
  - 如果保值方案类型为「单单匹配」：
    - 优先选择合同号，客商字段不显示
    - 如果已选择合同且合同定价方式为「暂定价」，现货数量和点价价格为可选字段
    - 如果已选择合同且合同定价方式为「均价」，不允许填写现货数量和点价价格

#### 3.2.2 批量匹配数据验证

- **手数**：必须大于 0，支持小数，不能超过委托单的未匹配手数
- **合同号必填规则**：如果保值方案为「单单匹配」且标签属于需要合同的列表，则合同号必填
- **合同数量与价格**：可选，如果填写必须为数字类型且大于等于 0
- **匹配状态验证**：只有标记为「可匹配」的记录才会被执行匹配操作

#### 3.2.3 变更保值方案约束

- **已匹配限制**：如果委托单已有已匹配的期现备注（isMatched = true），则不允许变更保值方案
- **目标方案状态**：目标保值方案必须处于启用状态

### 3.3 业务规则约束

#### 3.3.1 期现备注匹配状态

- **是否已匹配**（isMatched）字段由系统根据匹配操作自动更新，用户不能直接编辑
- 批量匹配成功后，系统会自动将相关期现备注的 `isMatched` 字段设置为 `true`
- 解除关联后，系统会将相关期现备注的 `isMatched` 字段设置为 `false`

#### 3.3.2 删除规则

- **期现备注删除**：删除期现备注时，直接执行删除操作，无需确认对话框（系统统一规则：弹框内不再弹框）
- **委托备注删除**：删除委托备注时，直接清空备注内容，无需确认对话框

#### 3.3.3 数据一致性

- **未匹配手数一致性**：未匹配手数必须实时计算，确保与已匹配期现备注的手数总和一致
- **期现备注列表一致性**：委托单列表中的期现备注数据必须与期现备注弹窗中的数据保持一致
- **匹配状态一致性**：批量匹配弹窗中的匹配状态必须根据最新数据实时计算

### 3.4 权限约束

- **匹配员权限**：页面所有操作需要匹配员权限
- **数据可见性**：用户只能看到有权限访问的委托单数据
- **操作权限**：不同角色可能对某些操作有不同权限（如变更保值方案可能需要更高权限）

---

## 四、其他补充

### 4.1 用户体验优化

#### 4.1.1 列配置持久化

- 表格列配置和期现备注列配置保存在浏览器本地存储中
- 用户下次访问页面时，自动恢复上次的列配置
- 支持恢复默认列配置

#### 4.1.2 数据提示

- 手数字段输入时，鼠标悬浮显示对应的吨数
- 委托备注内容过长时，鼠标悬浮显示完整内容（支持 HTML 格式）
- 批量匹配弹窗中实时显示匹配状态，帮助用户快速识别可匹配的记录

#### 4.1.3 操作反馈

- 所有保存、删除、匹配操作都有明确的成功/失败提示
- 批量匹配完成后，弹出匹配结果弹窗，显示匹配成功的记录数量
- 操作失败时，显示具体的错误原因

### 4.2 性能考虑

#### 4.2.1 数据加载

- 委托单列表支持分页，默认每页 10 条，避免一次性加载大量数据
- 批量匹配弹窗内也支持分页，每页 10 条记录
- 筛选条件变化时，实时过滤数据，无需重新请求服务器

#### 4.2.2 缓存策略

- 保值方案、合同、客商等基础数据可以在页面加载时一次性获取并缓存
- 标签选项根据保值方案动态获取，避免加载不必要的数据

### 4.3 扩展功能

#### 4.3.1 虚拟期货

虚拟期货功能用于在买卖保值方案之间创建内部对冲的虚拟期货头寸，不直接对应真实交易。该功能独立于匹配流程，可根据业务需要启用或禁用。

#### 4.3.2 导出功能

导出功能支持将当前筛选条件下的委托单列表导出为 Excel 或其他格式，包含所有可见列的数据。

### 4.4 接口说明

#### 4.4.1 期现备注接口

**保存期现备注**：
- 请求参数：
  - `期货id`（int）：委托单 ID
  - `期现备注列表`（json_list）：期现备注数组
    - `手数`（int/float）：必填
    - `现货数量`（float）：可选
    - `点价价格`（float）：可选
    - `标签`（str）：可选
    - `备注`（str）：可选
    - `客商id`（int）：可选，如果已选合同则不能选
    - `合同id`（int）：可选，如果保值方案是单单才允许选取
    - `是否已匹配`（bool）：由系统自动设置

#### 4.4.2 委托备注接口

**保存委托备注**：
- 请求参数：
  - `期货id`（int）：委托单 ID
  - `备注信息`（str）：备注文本内容

**删除委托备注**：
- 请求参数：
  - `期货id`（int）：委托单 ID

#### 4.4.3 批量匹配接口

**执行批量匹配**：
- 请求参数：
  - `匹配记录列表`（json_list）：匹配记录数组
    - `保值方案id`（int）：必填
    - `期货id`（int）：必填
    - `期货数量`（int/float）：必填
    - `合同id`（int）：可选，根据匹配规则决定
    - `合同数量`（float）：可选，非必填
    - `合同价格`（float）：可选，非必填

- 响应结果：
  - 返回匹配成功的记录数量和详情
  - 返回匹配失败的记录及失败原因

#### 4.4.4 解除关联接口

**解除期现备注关联**：
- 请求参数：
  - `期现备注id列表`（json_list）：需要解除关联的期现备注 ID 数组

#### 4.4.5 变更保值方案接口

**变更委托单保值方案**：
- 请求参数：
  - `委托单id列表`（json_list）：需要变更的委托单 ID 数组
  - `目标保值方案id`（int）：目标保值方案 ID

### 4.5 错误处理

#### 4.5.1 数据验证错误

- 期现备注总手数超过成交手数时，提示具体错误信息
- 批量匹配时，不符合匹配规则的记录会被标记，不会执行匹配
- 变更保值方案时，已有已匹配期现备注的委托单会被过滤，并提示用户

#### 4.5.2 网络错误

- 保存、删除、匹配等操作失败时，显示网络错误提示
- 建议用户重试或联系管理员

#### 4.5.3 权限错误

- 如果用户没有匹配员权限，页面应提示权限不足
- 某些操作可能需要更高权限时，按钮应禁用并提示原因

### 4.6 后续优化建议

- **批量操作优化**：考虑支持批量编辑期现备注的某些字段
- **匹配规则扩展**：根据业务需要，可以扩展更复杂的匹配规则
- **历史记录**：考虑记录匹配操作的历史，便于追溯和审计
- **报表集成**：期现备注数据可用于后续的报表和统计分析

---

本方案作为「匹配宝与委托备注」页面的完整产品说明，开发人员应严格按照本方案实现功能，确保界面交互、数据验证、业务规则的一致性。
