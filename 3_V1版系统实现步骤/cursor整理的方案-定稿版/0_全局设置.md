## 全局设置产品方案

本文档描述整个系统的「全局设置」模块产品方案，定义各业务模块（合同宝、指令宝、匹配宝、交易宝、风控宝等）所依赖的基础配置、数据来源、计算规则和一致性约束。

---

## 一、界面功能描述

本节描述「全局设置」菜单下各页面的功能与交互，不再针对单一业务模块，而是从“全局配置中心”的角度出发。

### 1.1 全局设置菜单结构

- **入口位置**
  - 顶部一级菜单：`全局设置`（与示例 UI 顶部菜单名称一致）。
  - 仅对拥有配置权限的用户显示（如系统管理员、超级用户）。
- **左侧子菜单（菜单文案 ⇔ 概念名称）**
  - **基础主数据**
    - `保值方案管理` ⇔ 保值方案管理
    - `客商管理` ⇔ 客商管理
    - `现货品种与价格` ⇔ 现货品种与品牌管理
    - `期货账户管理` ⇔ 期货账户管理
  - **权限与用户**
    - `人员管理` ⇔ 人员管理
    - `人员角色管理` ⇔ 角色与权限管理（角色定义与分配在此页，指令权限等粒度在指令相关页面配置）
  - **通用配置**
    - `自定义字段配置` ⇔ 自定义字段管理
    - 枚举与标签管理（当前部分标签/枚举在保值方案等业务页面中自定义，后续可视情况收敛到统一页面）
    - 系统参数与交易日管理（交易日数据由快期行情服务提供，本系统只做消费与展示）
  - **其他设置**
    - `其他设置` ⇔ 其他业务规则配置
  - 后续新模块（如风控阈值模板、报表模板）可在本菜单下扩展新增页面。

所有业务页面均只通过接口读取这些配置，不直接修改；配置的新增、变更和禁用只能在「全局设置」中完成。

---

### 1.2 保值方案管理

#### 1.2.1 列表与筛选

- **表格字段（示例）**
  - 方案名称、方案编码
  - 方案类型：整体匹配 / 单单匹配 / 其他
  - 启停状态：启用 / 禁用
  - 适用现货品种（多选）
  - 适用品牌范围（多选）
  - 是否启用敞口管理
  - 是否启用均价自动指令、是否启用净值套保等策略开关
  - 已关联合同数量、已关联指令数量（只读统计）
- **筛选条件**
  - 方案名称/编码模糊搜索
  - 方案类型
  - 启停状态
  - 适用品种/品牌

#### 1.2.2 新建 / 编辑弹窗

- **基础信息**
  - 方案名称（必填，唯一）
  - 方案编码（必填，唯一）
  - 方案类型（必选：整体匹配 / 单单匹配等）
  - 启停状态（启用 / 禁用）
- **适用范围**
  - 关联的现货品种（来自“现货品种与品牌管理”，仅显示启用品种）
  - 关联的品牌（来自“现货品种与品牌管理”，仅显示启用品牌，可按品种过滤）
- **敞口配置**
  - 按"品牌 + 期货合约"配置敞口系数列表：
    - 现货品牌（必选）
    - 期货品种 / 合约代码（必选）
    - 敞口系数（必填，小数）
  - 支持为同一品牌配置多个期货合约及不同敞口系数。
- **指令类型配置**
  - 可选择的指令类型列表（多选）
  - 系统根据保值方案类型自动过滤可用的指令类型：
    - **整体匹配类型**可选的指令类型：
      - 期货交易指令
      - 合同创建指令
      - 一口价创建套保指令
      - 保值方案移仓换月指令
      - 保值方案净值套保指令
      - 保值方案均价净值套保指令
    - **单单匹配类型**可选的指令类型：
      - 期货交易指令
      - 合同创建指令
      - 一口价创建套保指令
      - 保值方案移仓换月指令
      - 非均价合同套保指令
      - 均价合同套保指令
      - 点价指令
      - 非均价合同变更指令
      - 均价合同变更指令
      - **单单移仓换月**（仅可应用于单单匹配类型）
    - **无合同（人员）类型**可选的指令类型：
      - 期货交易指令
    - **无合同（客商）类型**可选的指令类型：
      - 期货交易指令
  - **约束规则**：
    - "单单移仓换月"指令类型仅可应用于"单单匹配"类型的保值方案。
    - 系统在创建或编辑保值方案时，会根据方案类型自动过滤并显示可用的指令类型选项。
    - 如果用户先选择了方案类型，然后选择指令类型，系统只显示该方案类型可用的指令类型。
- **指令策略**
  - 是否启用"保值方案净值套保指令"（仅整体匹配类型）
  - 是否启用"保值方案均价净值套保指令"（仅整体匹配类型）
  - 是否允许系统自动生成子指令

#### 1.2.3 与业务页面的依赖关系

- **合同模块**
  - 合同的 `保值方案` 字段从此处下拉选择，仅显示启用状态的保值方案。
  - 合同变更时计算“变更所需期货数量”时，敞口系数从对应“保值方案 × 品牌”的敞口配置中读取。
- **指令模块**
  - 父指令与子指令的 `保值方案` 字段从此处引用。
  - 自动指令生成逻辑根据保值方案的“均价自动指令启停”配置决定是否生成或更新子指令。
- **期现备注与报表**
  - 期现备注中可带出保值方案信息，用于后续按方案维度统计敞口与净值。

---

### 1.3 客商管理

#### 1.3.1 列表与筛选

- **表格字段**
  - 客商编码、客商简称、客商全称
  - 客商类型：供应商 / 客户 / 兼有
  - 客商分组或等级（如 A/B/C）
  - 联系人、联系电话
  - 状态：启用 / 禁用
- **筛选条件**
  - 编码/名称模糊筛选
  - 客商类型
  - 状态（启用/禁用）

#### 1.3.2 新建 / 编辑弹窗

- 编码、简称、全称（支持唯一性校验）
- 类型（供应商 / 客户 / 兼有）
- 联系信息（联系人、电话、邮箱等）
- 结算方式、信用额度等（可选扩展）
- 启停状态

#### 1.3.3 与业务页面的依赖关系

- **合同模块**
  - 合同中的“供应商/客户”字段从客商管理中选择，仅显示启用客商。
  - 合同类型为采购时只展示客商类型为“供应商/兼有”的记录；合同类型为销售时只展示“客户/兼有”。
- **指令 / 风控 / 报表**
  - 按客商维度统计敞口和交易行为。
  - 风控宝中可针对特定客商设定风控策略或查看风险敞口。

---

### 1.4 现货品种与价格（菜单文案） / 现货品种与品牌管理（概念名称）

#### 1.4.1 界面结构

- 左侧：现货品种列表。
- 右侧：选中品种下的品牌列表与品牌明细。

#### 1.4.2 现货品种字段

- 品种编码、品种名称
- 品种分类（可选）
- 状态：启用 / 禁用

#### 1.4.3 品牌字段

- 品牌名称、品牌编码
- 所属品种
- 是否主港价、是否平台价等业务属性
- 价格基准与升贴水（如有）
- 品牌维度的期货敞口配置（一个品牌可关联多个期货合约及敞口系数，当前为全局品牌级配置，暂不按保值方案拆分）
- 状态：启用 / 禁用

#### 1.4.4 与业务页面的依赖关系

- **合同模块**
  - 合同的 `现货品种` 字段从品种管理中选择，只显示启用品种。
  - 合同的 `品牌` 字段从品牌管理中选择，只显示启用品牌，且根据所选品种过滤。
- **保值方案管理**
  - 在需要按品种/品牌过滤或展示保值方案时，从此处拉取品种与品牌列表。
- **指令 / 期现关联**
  - 期现关联默认匹配逻辑根据现货品种推导期货品种，基础映射关系来源于品种/品牌配置与品牌维度敞口配置。

---

### 1.5 期货账户管理

#### 1.5.1 列表与筛选

- **表格字段**
  - 账户编码、账户名称、账户别名
  - 交易通道（CTP、文华等）
  - 所属机构、币种
  - `是否允许 Web 交易`（布尔）
  - 状态：启用 / 禁用
  - 操作列：包含"保值额度"按钮（用于管理该账户的保值持仓额度配置）
- **筛选条件**
  - 账户编码/名称模糊搜索
  - 状态、交易通道、是否允许 Web 交易

#### 1.5.2 新建 / 编辑弹窗

- 账户基本信息（编码、名称、通道、机构、币种）
- 账户别名（可选）
  - 用于在交易端等业务页面中显示更易识别的账户名称
  - 如果设置了别名，则在交易端选择期货账户时显示别名
  - 如果没有设置别名，则显示账户编码或账户名称
- 是否允许用于 Web 交易端
- 是否允许用于自动指令执行
- 状态（启用/禁用）

#### 1.5.3 保值额度管理

- **入口**
  - 在期货账户列表的操作列中，点击"保值额度"按钮，打开该账户的保值额度配置弹窗。
- **功能描述**
  - 为当前期货账户配置各期货合约的多空方向保值持仓额度。
  - 支持按"期货合约 + 多空方向"维度设置独立的持仓额度限制。
- **列表展示**
  - 表格字段：
    - 期货合约代码（必填，下拉选择或手动输入）
    - 多空方向（必选：多头 / 空头）
    - 保值持仓额度（必填，数值，单位：手）
    - 备注（可选）
  - 支持按合约代码、多空方向筛选。
- **操作功能**
  - 新增：添加一条新的保值额度配置记录。
  - 编辑：修改已有记录的合约、方向或额度值。
  - 删除：删除指定的保值额度配置（需确认，避免误删）。
- **数据约束**
  - 同一账户下，同一"期货合约 + 多空方向"组合应唯一，不允许重复配置。
  - 保值持仓额度必须为正数。
  - 删除配置前，系统应检查是否有业务数据正在使用该额度配置（如指令执行、风控检查等），如有则提示并禁止删除。

#### 1.5.4 与业务页面的依赖关系

- **Web 交易端**
  - 下单界面的"期货账户"下拉，从期货账户管理中读取，仅显示"启用且允许 Web 交易"的账户。
  - 显示规则：如果账户设置了别名，则显示别名；如果没有设置别名，则显示账户编码。
- **指令执行 / 风控**
  - 指令执行可限定在特定账户范围内。
  - 风控宝按账户维度统计风险敞口和占用。
  - 风控宝在执行持仓额度检查时，从对应期货账户的"保值额度"配置中读取各合约、各方向的额度上限，与当前持仓进行比对，判断是否超限。
- **保值额度配置**
  - 保值额度配置作为风控检查的数据来源，用于限制各账户在各期货合约、各方向上的最大保值持仓数量。
  - 当指令执行或持仓变动时，风控模块需实时校验是否超出配置的保值持仓额度。

---

### 1.6 人员管理与角色权限管理

#### 1.6.1 人员管理

- **列表字段**
  - 姓名、工号、所属部门
  - 登录账号
  - 默认角色
  - 状态：在职 / 离职 / 禁用
- **依赖关系**
  - 合同中的 `业务经理` 下拉，从人员管理中读取，仅展示状态为“在职且启用”的人员。
  - 各业务记录的“创建人”字段从当前登录人员自动赋值。

#### 1.6.2 角色与权限管理

- 角色列表：角色名称、说明、启停状态。
- 角色详情：可访问的菜单、可执行的操作（如"合同新增"、"合同删除"、"期现关联编辑"、"全局设置维护"等）。
- 统一控制按钮的可见与可点击状态，不同角色看到不同的模块和操作集合。

**指令类型绑定配置**（新增）：

在角色管理页面，为每个角色配置可用的指令类型。这是指令权限分配的基础配置。

- **配置位置**：角色详情页或角色编辑弹窗中
- **配置内容**：
  - 可选指令类型列表（多选）
  - 系统显示所有定义的指令类型，管理员为每个角色选择该角色可以使用的指令类型
  - 例如：交易员角色可以选择"期货交易指令"、"保值方案移仓换月指令"、"保值方案净值套保指令"
  - 例如：业务经理角色可以选择"期货交易指令"、"合同创建指令"、"点价指令"等
  - 例如：指令员角色可以选择所有指令类型

- **配置说明**：
  - 一个角色可以绑定多个指令类型
  - 一个指令类型可以被多个角色绑定
  - 该配置作为指令权限分配时的约束条件
  - 在"人员指令权限设置"界面中，选择指令类型后，系统会根据该配置自动筛选可选人员（只显示拥有对应角色的员工）

- **配置验证**：
  - 确保每个角色至少配置一个指令类型（角色才有业务意义）
  - 确保每个指令类型至少配置一个角色（指令才能被使用）
  - 配置变更后，需要检查是否影响现有权限配置

- **配置示例**：
  - 交易员：期货交易指令、保值方案移仓换月指令、保值方案净值套保指令、单单移仓换月
  - 业务经理：期货交易指令、合同创建指令、一口价创建套保指令、非均价合同套保指令、点价指令、非均价合同变更指令、均价合同变更指令、单单移仓换月
  - 指令员：所有指令类型
  - 制单员：合同创建指令
  - 客商：期货交易指令、点价指令（此配置仅供参考，客商角色通常由外部系统管理）

**指令类型与保值方案类型的约束关系**：

- **单单移仓换月**：仅可应用于"单单匹配"类型的保值方案。
  - 该指令类型用于在单单匹配场景下进行移仓换月操作。
  - 与"保值方案移仓换月指令"的区别：
    - "保值方案移仓换月指令"：可用于整体匹配和单单匹配，是基于保值方案维度的移仓换月。
    - "单单移仓换月"：仅用于单单匹配，是针对具体合同的移仓换月操作。

- **与指令权限设置的关系**：
  - 本配置用于限定"人员指令权限设置"中的可选人员范围
  - 如果某个指令类型未绑定任何角色，则在权限分配时不会筛选出任何可选人员
  - 如果某个角色未绑定任何指令类型，则拥有该角色的人员无法被分配任何指令权限

---

### 1.7 自定义字段管理

#### 1.7.1 界面结构

- 顶部选择“实体类型”：合同、指令、委托、期现备注、客商等。
- 中部表格展示当前实体下已配置的自定义字段。

#### 1.7.2 字段配置内容

- 字段编码（唯一）
- 字段名称（显示用）
- 数据类型（字符串、整数、小数、布尔、日期、日期时间等）
- 是否必填
- 是否允许在列表中展示
- 是否允许用作筛选条件

#### 1.7.3 与业务页面的依赖关系

- 各实体类型（如“合同”）的创建/编辑弹窗，会自动根据自定义字段配置增加对应输入项。
- 列表中可以根据配置增加/移除自定义字段列，并支持按配置的“是否可筛选”进行查询。

---

### 1.8 枚举与标签管理

#### 1.8.1 管理范围

- 系统统一维护的枚举值，如：
  - 状态枚举：enable / disable / delete / cancel 等
  - 期货方向：买入 / 卖出
  - 合同方向：采购 / 销售
  - 合同定价方式：一口价 / 暂定价 / 均价
  - 开平标志：开仓 / 平仓
  - 计价方式：一口价 / 暂定价 / 均价
- 各业务使用的标签，如：
  - 期现备注标签（套保、点价、移仓、补录等）
  - 指令标签（自动、手工、风控触发等）

#### 1.8.2 与业务页面的依赖关系

- **期现备注**
  - 期现备注的“标签”字段，从此处配置读取，可多选。
  - 用于后续在报表、风险分析等模块按标签筛选。
- **各业务模块状态字段**
  - 所有状态字段统一依赖这一处，不允许页面直接写死字符串，避免不同模块状态含义不一致。

---

### 1.9 系统参数与交易日管理

#### 1.9.1 系统参数

- 当前交易日（单值）
- 默认分页条数、日期显示格式等 UI 相关参数
- 是否允许补录历史数据
- 发生时间与创建时间的允许关系（如：允许发生时间早于创建时间，但不允许晚于创建时间）

#### 1.9.2 交易日历

- 维护节假日、周末规则及特殊交易日（如夜盘等）。
- 各模块在计算“是否在定价期”、“交易日归属”等逻辑时统一引用这里。

---

### 1.10 其他设置

#### 1.10.1 界面结构

- 统一的设置页面，展示各项业务规则配置项。
- 每个配置项独立显示，包含配置项名称、说明、选项和当前值。
- 支持修改配置值并保存。

#### 1.10.2 采销关联规则配置

- **配置项名称**：采销关联规则
- **配置说明**：设置采购合同与销售合同的关联匹配规则，决定系统如何处理采销合同的关联操作。
- **配置选项**：
  - **手工指定采销**（默认值）
    - 用户在业务页面手动选择采购合同和销售合同进行关联。
    - 适用于需要精确控制采销匹配关系的业务场景。
    - 允许用户灵活调整关联关系。
  - **自动先进先出**
    - 系统按照先进先出（FIFO）规则自动匹配采购合同与销售合同。
    - 适用于批量处理、标准化业务流程的场景。
    - 系统自动根据合同创建时间或指定时间维度进行匹配。
- **配置位置**：其他设置页面，采销关联规则配置项。
- **默认值**：手工指定采销。
- **生效方式**：配置变更后即时生效（或可配置为次交易日生效，根据业务需求确定）。

#### 1.10.3 采销关联规则说明

**通用约束规则**（无论选择哪种关联规则，无论保值方案是整体匹配还是单单匹配）：

1. **现货品种一致性要求**
   - 采购合同与销售合同的现货品种必须一致。
   - 系统在进行采销关联时，必须校验两侧合同的现货品种是否相同。
   - 如果现货品种不一致，系统应拒绝关联并提示错误信息。

2. **期货月份无要求**
   - 系统不对合同关联的期货月份提要求。
   - 采购合同关联的期货合约月份与销售合同关联的期货合约月份可以不同。
   - 例如：采购合同可能关联 cu2403，销售合同可能关联 cu2404，系统允许此种关联。

3. **保值方案匹配类型的影响**
   - **单单匹配**：在手工指定模式下，用户需要明确选择具体的采购合同和销售合同；在自动先进先出模式下，系统在满足约束条件下自动匹配。
   - **整体匹配**：在手工指定模式下，仍需手工指定，但关联关系纳入整体管理；在自动先进先出模式下，系统按先进先出规则在整体范围内自动匹配。

4. **品牌一致性（可选说明）**
   - 建议在业务实践中保持品牌一致，但系统不作强制约束。
   - 如果业务需要不同品牌的采销关联，可通过业务规则或自定义配置实现。

#### 1.10.4 与业务页面的依赖关系

- **合同模块 - 采销关联功能**
  - 在进行采销关联操作时，系统读取"采销关联规则"配置。
  - 如果配置为"手工指定采销"：
    - 用户在合同管理界面通过"关联"按钮打开采销关联弹窗。
    - 用户手动选择采购合同和销售合同进行关联。
    - 系统校验现货品种是否一致，校验通过后创建关联关系。
  - 如果配置为"自动先进先出"：
    - 系统提供自动匹配触发功能（可配置触发时机，如合同创建时、批量处理时）。
    - 系统按照先进先出规则，自动在满足约束条件的采购合同与销售合同之间建立关联关系。
    - 自动匹配时同样必须校验现货品种一致性。
    - 用户可在关联记录中查看自动匹配的结果，并支持手动调整（如需要）。
- **匹配宝模块**
  - 匹配宝中的采销关联功能同样遵循"采销关联规则"配置。
  - 在批量处理场景下，根据配置采用手工指定或自动匹配方式。
- **报表模块**
  - 采销关联报表展示关联记录时，标注关联方式（手工指定 / 自动匹配）。
  - 支持按关联方式筛选和统计。

---

## 二、数据来源和相关计算公式

本节从“全局配置如何被业务页面消费”的角度，描述数据来源与关键计算，避免在业务文档里重复定义。

### 2.1 业务字段的数据来源

#### 2.1.1 合同相关字段

- `保值方案_id`：来自“保值方案管理”，仅可选择启用状态的方案。
- `现货品种_id`、`品牌_id`：来自“现货品种与品牌管理”，仅可选择启用品种与品牌。
- `供应商/客户_id`：来自“客商管理”，根据合同类型过滤可选范围。
- `业务经理_id`：来自“人员管理”，仅可选择在职且启用的人员。
- `自定义字段`：字段结构来自“自定义字段管理”，实际值由用户在业务页面填写。

#### 2.1.2 指令与委托相关字段

- `保值方案_id`：来自"保值方案管理"，决定指令归属与策略。
- `期货账户_id`：来自"期货账户管理"，仅可选择启用且符合使用场景的账户。
- 各类枚举字段（方向、开平、状态、计价方式等）：从"枚举与标签管理"统一加载。
- `保值持仓额度`：来自"期货账户管理"中的"保值额度"配置，按"期货账户 × 期货合约 × 多空方向"维度读取额度上限，用于风控检查。

#### 2.1.3 业务规则配置字段

- `采销关联规则`：来自"其他设置"中的"采销关联规则"配置，决定采销关联的操作方式（手工指定采销 / 自动先进先出）。
  - 合同模块在进行采销关联时读取此配置。
  - 匹配宝模块在进行批量采销关联时读取此配置。
  - 系统根据此配置决定是提供手工选择界面还是触发自动匹配逻辑。

---

### 2.2 敞口与期货需求计算

#### 2.2.1 敞口系数数据来源

- 在“保值方案管理”中，为每个“保值方案 × 品牌”配置若干“期货合约 + 敞口系数”。
- 业务页面只负责读取这些配置，不直接维护任何敞口系数常量。

#### 2.2.2 合同数量变更的期货需求计算

- **变更数量**
  - 变更数量 = 变更后合同数量 - 变更前合同数量。
- **敞口系数**
  - 从当前合同绑定的“保值方案 × 品牌”的敞口配置中获取对应系数。
- **变更所需期货数量**
  - 变更所需期货数量（手数） = 变更数量 × 敞口系数。
  - 正值表示需要新增买入（或减空），负值表示需要卖出（或减多）。
- 以上规则不再在单个业务文档重复定义，而是统一由本“全局设置”文档约定。

---

### 2.3 状态计算与交易日规则

#### 2.3.1 交易日与时间字段

- 当前交易日统一来自“系统参数与交易日管理”。
- 各模块中的“发生日期时间”和“创建日期时间”需遵守：
  - 如果发生日期时间未填写，则默认等于创建日期时间。
  - 发生日期时间可以早于创建日期时间（用于补录历史数据）。
  - 发生日期时间不能晚于创建日期时间（不允许未来事件）。

#### 2.3.2 状态型计算字段（统一原则）

- **是否已交收**
  - 统一规则：交割日期 ≤ 当前日期 → 是，否则为否。
- **是否在定价期**
  - 统一规则：当前日期 ≤ 点价截止日 → 是，否则为否。
- **均价合同是否已定价**
  - 统一规则：当前日期 ≥ 均价起止日的结束日期 → 已定价，否则未定价。
- 各业务模块只负责实现本规则，不得自行定义不同口径。

---

### 2.4 标签与枚举的使用

- 所有标签（如期现备注标签）、状态值、方向值、计价方式值等统一由“枚举与标签管理”提供。
- 报表和风控模块在做统计时，只按这些统一枚举聚合，避免出现同义异写的问题。

---

## 三、数据一致性和数据约束

### 3.1 外键与引用完整性

- 所有业务表中的以下字段均为外键，必须指向"全局设置"中的有效记录：
  - 保值方案_id、现货品种_id、品牌_id
  - 客商_id、人员_id
  - 期货账户_id
  - 自定义字段定义_id 等
- 保值额度配置作为期货账户的子配置：
  - 保值额度配置必须关联一个有效的期货账户。
  - 当期货账户被禁用时，该账户下的所有保值额度配置自动失效（不再用于风控检查），但配置数据保留。
  - 当期货账户被删除时，应先删除或迁移其下的所有保值额度配置。
- 当全局配置被禁用时：
  - 不影响历史业务记录的展示；
  - 禁止在新的业务记录中继续引用。
- 当存在业务引用时，一般禁止物理删除配置，只允许禁用。

---

### 3.2 状态与禁用规则

- **保值方案禁用**
  - 合同新增与指令新增时，不再展示该方案。
  - 已使用该方案的历史合同、指令保持不变。
- **客商 / 品种 / 品牌 / 期货账户 / 人员禁用**
  - 新建或编辑业务数据时，不得再选择禁用记录。
  - 历史记录中的引用值仍需保留，以保证历史数据可追溯。
- **期货账户禁用对保值额度的影响**
  - 当期货账户被禁用时，该账户下的保值额度配置自动失效，风控模块不再使用这些配置进行额度检查。
  - 保值额度配置数据本身保留，但标记为"关联账户已禁用"状态。
  - 当期货账户重新启用时，保值额度配置自动恢复生效。
- 所有禁用行为都应记录审计日志，包括操作人、时间与原因。

---

### 3.3 自定义字段约束

- 字段定义一经引用，不允许随意更改数据类型或删除。
- 禁止在有历史数据的情况下将字段从“选填”改为“必填”，除非同时提供数据补齐方案。
- 业务保存数据时必须按字段定义校验类型与必填性。

---

### 3.4 交易日与时间一致性

- 所有模块共用同一套“当前交易日”和“交易日历”配置。
- 任何涉及“按交易日统计”的逻辑（如净值、敞口、报表）都必须以该交易日配置为准，不能自行计算。
- 发生时间与创建时间的关系（发生时间不得晚于创建时间）必须在所有录入场景中统一校验。

---

### 3.5 采销关联数据约束

#### 3.5.1 采销关联的通用约束（无论关联规则配置）

**现货品种一致性约束**：
- 采购合同与销售合同的现货品种必须一致，系统必须强制校验。
- 在创建采销关联记录时，如果采购合同的现货品种与销售合同的现货品种不一致，系统应拒绝创建并提示："采销关联要求两侧合同的现货品种必须一致"。
- 在编辑或调整采销关联关系时，同样需要校验现货品种一致性。

**期货月份无约束**：
- 系统不对合同关联的期货合约月份作任何要求或校验。
- 采购合同关联的期货合约（cu2403）与销售合同关联的期货合约（cu2404）可以不同，系统允许此种关联。

**保值方案一致性约束**：
- 采购合同与销售合同的保值方案必须一致（该约束已在合同宝模块中定义，此处再次强调）。
- 系统在校验采销关联时，需要同时校验保值方案一致性。

#### 3.5.2 不同关联规则下的特殊约束

**手工指定采销模式**：
- 用户手动选择的采购合同和销售合同必须满足上述通用约束。
- 系统仅在校验通过后创建关联关系。
- 允许用户灵活选择关联对象，不受时间顺序限制（除非业务另有要求）。

**自动先进先出模式**：
- 系统自动匹配时，必须严格按照先进先出规则进行匹配。
- 先进先出的排序维度：默认按合同创建时间排序，或按合同的发生日期时间排序（可根据业务需求配置）。
- 自动匹配时，系统首先筛选满足现货品种一致性的候选合同，然后按时间顺序进行匹配。
- 如果无法找到满足约束条件的匹配对象，系统应记录日志并提示用户。

#### 3.5.3 关联数量的约束

- 关联数量不能超过采购合同的剩余未关联数量（合同数量 - 已销售数量）。
- 关联数量不能超过销售合同的剩余未关联数量（合同数量 - 已采购数量）。
- 关联数量必须大于0。
- 上述约束适用于手工指定和自动先进先出两种模式。

### 3.6 全局一致性检查

- 系统应定期执行一致性检查任务，至少包括：
  - 检查业务表中的外键是否都能在全局设置中找到对应记录。
  - 检查禁用配置是否仍被用于新建业务数据。
  - 检查自定义字段定义与实际数据类型是否一致。
  - 检查采销关联记录是否符合现货品种一致性约束（如发现不一致，记录异常日志）。
- 对发现的异常记录日志，并提供运维级修复工具。

---

## 四、其他补充

### 4.1 权限与审计

- 「全局设置」模块应具备更高权限要求，一般仅开放给运维和管理角色。
- 对关键配置（保值方案、期货账户、保值额度、交易日、枚举与标签、自定义字段、采销关联规则等）的新增/修改/禁用操作，都需要记录详细审计日志。
- 保值额度配置的变更（新增、修改、删除）应记录操作人、操作时间、变更前后值、关联的期货账户等信息，便于追溯和风控审计。
- 采销关联规则配置的变更应记录操作人、操作时间、变更前后值等信息，因为该配置会影响业务操作方式。

---

### 4.2 配置变更生效策略

- 部分配置可即时生效，如：
  - 客商启用/禁用
  - 品种/品牌启用/禁用
  - 期货账户启用/禁用
- 部分配置建议支持"次日生效"，如：
  - 敞口系数变更
  - 关键风控参数调整
  - 保值额度配置变更（新增、修改、删除），建议次日生效，避免当日交易过程中额度变更导致的风控判断不一致
  - 采销关联规则变更（从手工指定切换到自动先进先出，或反之），建议次日生效，避免当日业务操作方式突变导致的操作混乱
- 生效时间策略可以作为配置字段存储，并在业务模块中体现（如提示"本次修改将于次交易日生效"）。

---

### 4.3 性能与缓存

- 全局配置数据读多写少，建议：
  - 后端在内存中缓存保值方案、品种/品牌、客商、人员、期货账户、保值额度、自定义字段、枚举、采销关联规则等配置。
  - 配置变更时主动刷新缓存，或采用版本号机制强制业务模块刷新。
  - 保值额度配置建议按"期货账户_id"建立索引缓存，便于风控模块快速查询。
  - 采销关联规则配置建议在合同模块和匹配宝模块的关联功能入口处缓存读取，避免频繁查询。
- 前端可以在登录后一次性拉取枚举与部分全局配置（包括采销关联规则），减少业务页面多次请求。

---

### 4.4 多环境与多租户（如需）

- 不同环境（开发、测试、预发布、生产）应使用不同的全局设置数据源，严禁共用。
- 如有多租户场景，需要在全局设置中增加“租户维度”，所有业务数据与配置按租户隔离。

---

本方案作为整个系统的「全局设置产品方案」，后续各业务模块在各自的产品文档中，只需说明“使用了哪些全局配置，以及如何使用”，不再重复定义这些全局性规则。 


