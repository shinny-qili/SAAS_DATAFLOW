# 合同宝产品方案

本文档描述合同宝模块的完整产品方案，包括界面功能、数据来源、计算公式、数据约束和补充说明。

---

## 一、界面功能描述

### 1.1 合同管理主界面

合同管理分为采购合同管理和销售合同管理两个子模块，界面结构相同，仅字段显示名称不同（采购合同显示"供应商"，销售合同显示"客户"）。

#### 1.1.1 表格布局

采用纯表格布局，从上到下依次为：
- **按钮工具栏**：包含创建、编辑（变更）、删除（作废）、关联、解除关联、点价、禁用/启用等操作按钮
- **表格区域**：显示合同列表，支持横向滚动

#### 1.1.2 表格列字段

表格默认显示以下字段（用户可通过列配置自定义显示）：
- **单选按钮**：用于选择合同行
- **保值方案**：显示保值方案名称
- **业务经理**：显示业务经理姓名
- **合同编号**：合同唯一编号
- **供应商/客户**：根据合同类型显示供应商或客户简称
- **现货品种**：现货品种名称
- **品牌**：品牌名称
- **计价方式**：一口价/暂定价/均价
- **合同数量**：合同数量
- **单价**：合同单价
- **结算单价**：结算单价
- **合同金额**：合同数量 × 单价（计算字段）
- **结算金额**：合同数量 × 结算单价（计算字段）
- **运输方式**：自提/送到
- **交割日期**：交割日期
- **已点数量**：已点价数量
- **未点数量**：合同数量 - 已点数量（计算字段）
- **已销售数量**（仅采购合同）：可点击，点击后弹出采销关系表格
- **已采购数量**（仅销售合同）：可点击，点击后弹出采购关系表格
- **创建人**：创建人姓名
- **创建日期时间**：合同创建时间
- **发生日期时间**：事件发生时间
- **状态**：启用/禁用/已删除

#### 1.1.3 筛选功能

表格支持多条件筛选，筛选条件包括：
- 保值方案（多选）
- 业务经理（多选）
- 合同编号（模糊搜索）
- 供应商/客户（多选）
- 现货品种（多选）
- 品牌（多选）
- 计价方式（多选）
- 状态（多选）
- 是否已定价（是/否）
- 是否已交收（是/否）
- 是否在定价期（是/否）
- 已销售数量/已采购数量（范围筛选）

#### 1.1.4 表格操作

- **排序**：所有列支持排序
- **分页**：默认每页10条，支持10/20/50/100四档可选
- **列配置**：支持自定义显示列、调整列顺序和宽度
- **导出**：支持导出Excel，空表导出可作为模板
- **备注编辑**：支持单行编辑备注
- **附件上传**：支持单行编辑附件

### 1.2 合同创建/编辑弹窗

#### 1.2.1 基本信息表单

包含以下字段：
- **保值方案**（必填）：下拉选择，仅显示启用状态的保值方案
- **业务经理**（选填）：下拉选择，仅显示启用状态的人员
- **合同编号**（必填）：文本输入，需唯一
- **供应商/客户**（选填）：下拉选择，仅显示启用状态的客商
- **现货品种**（选填）：下拉选择，仅显示启用状态的现货品种
- **品牌**（选填）：下拉选择，根据现货品种筛选，仅显示启用状态的品牌
- **计价方式**（必填）：下拉选择（一口价/暂定价/均价）
- **合同数量**（选填）：数字输入
- **单价**（选填）：数字输入
- **结算单价**（选填）：数字输入
- **运输方式**（选填）：下拉选择（自提/送到）
- **交割日期**（选填）：日期选择器
- **均价起止日**（选填）：日期范围选择器，仅均价合同显示
- **点价截止日**（选填）：日期选择器，仅暂定价合同显示
- **已点数量**（选填）：数字输入，仅暂定价合同显示，编辑时禁用
- **发生日期时间**（选填）：日期时间选择器，不填写时使用创建日期时间
- **备注**（选填）：文本输入

#### 1.2.2 未完成指令显示区域

位于表单下方，显示当前合同相关的未完成指令列表。

**显示条件**：
- 创建合同时：不显示（新合同无历史指令）
- 编辑合同时：显示
- 删除合同时：显示

**查询条件**：
- 指令直接关联到当前合同（合同ID匹配）
- 或指令关联到当前合同所属的保值方案（保值方案ID匹配，且指令类型为整体类型）
- 指令状态为"待完成"或"撤销待处理"
- 指令类型包括：均价合同套保指令、非均价合同套保指令、均价合同变更指令、非均价合同变更指令、保值方案净值套保指令、保值方案均价净值套保指令

**显示内容**：
- 指令编号、指令类型、指令状态、保值方案名称
- 期货要求：合约代码、买卖方向、所需数量、价格要求
- 父指令编号（如果是子指令）
- 创建时间、发起人姓名

**交互功能**：
- 支持折叠/展开
- 点击指令行可查看详情
- 提供快捷撤销按钮（可选）

#### 1.2.3 预算变更影响显示区域

位于表单下方，实时计算并显示当前变更会导致的需期货交易数量变更数值。

**显示时机**：
- 创建合同时：如果用户输入了合同数量，显示预算信息
- 编辑合同时：当用户修改合同数量时，实时计算并显示
- 删除合同时：显示合同取消的影响（变更数量 = 0 - 原合同数量）

**显示内容**：
- 变更前合同数量（编辑/删除时显示）
- 变更后合同数量（编辑/创建时显示）
- 变更数量：变更的绝对值，标注增加或减少
- 敞口系数：使用的敞口系数值
- 变更所需期货数量：计算得出的期货交易数量（手数），标注买入或卖出
- 影响的指令列表：列出会受到影响的指令编号和类型

**计算规则**：
- 变更数量 = 变更后合同数量 - 变更前合同数量
- 变更所需期货数量（手数）= 变更数量 × 敞口系数
- 敞口系数从合同关联的保值方案中获取，根据合同的品牌配置查找对应的期货敞口系数

**实时更新**：
- 当用户在弹出框中修改合同数量时，预算区域实时更新
- 计算延迟不超过500毫秒

### 1.3 期现关联功能

#### 1.3.1 关联弹窗

选择合同后点击"关联"按钮，弹出期现关联弹窗，包含两个标签页：
- **期现关联**：建立合同与期货委托的关联关系
- **采销关联**：建立采购合同与销售合同的关联关系

#### 1.3.2 期现关联标签页

**默认筛选条件**：
- 保值方案：与合同相同的保值方案
- 方向：与合同方向匹配（采购合同对应买入，销售合同对应卖出）
- 品种：与合同现货品种匹配的期货品种
- 未匹配数量 > 0

**用户可自定义筛选**：
- 合约代码
- 成交日期区间
- 价格范围

**表格显示字段**：
- 选择（复选框）
- 账户：期货账户名称或别名
- 合约：期货合约代码
- 买卖：买入/卖出
- 开平：开仓/平仓
- 成交日期：从最后成交时间提取
- 价格：成交均价
- 期货数量（可编辑）：用户输入
- 合同数量（可编辑）：用户输入
- 发生时间（可编辑，可选）：用户输入，不填写默认为当前时间

**排序规则**：
- 未匹配手数 > 0 的委托单优先显示（靠上）
- 在未匹配手数 > 0 的记录中，按未匹配手数降序排序
- 如果未匹配手数相同，按成交日期降序排序

**表格自定义列**：
- 支持显示期货委托单的所有字段
- 可选字段包括：指令编号、短编号、成交手数、已匹配手数、未匹配手数、挂单状态、委托备注等

**操作按钮**：
- 确定：保存关联关系
- 取消：关闭弹窗，不保存

**匹配后状态变更**：
- 更新委托单的已匹配手数
- 更新委托单的未匹配手数
- 创建或更新期现备注记录
- 自动将期现备注的"是否已匹配"状态标为"是"
- 更新委托单的匹配状态

#### 1.3.3 采销关联标签页

**默认筛选条件**：
- 现货品种：与合同相同的现货品种
- 品牌：与合同相同的品牌
- 方向：与合同方向相反（采购合同关联销售合同，销售合同关联采购合同）
- 保值方案：与合同相同的保值方案（强制一致）
- 未匹配数量 > 0

**用户可自定义筛选**：
- 合同编号
- 客商
- 业务经理

**表格显示字段**：
- 选择（复选框）
- 合同编号、客户/供应商、业务经理等合同字段
- 数量（可编辑）：用户输入
- 发生时间（可编辑，可选）：用户输入，不填写默认为当前时间

**表格自定义列**：
- 支持显示合同的所有字段

**操作按钮**：
- 确定：保存关联关系
- 取消：关闭弹窗，不保存

### 1.4 解除关联功能

#### 1.4.1 解除关联弹窗

选择合同后点击"解除关联"按钮，弹出解除关联弹窗，包含两个标签页：
- **解除期现关联**：解除合同与期货委托的关联关系
- **解除采销关联**：解除采购合同与销售合同的关联关系

#### 1.4.2 解除期现关联标签页

**用户可自定义筛选**：
- 关联日期区间
- 合约代码
- 成交日期区间

**表格显示字段**：
- 选择（复选框）
- 合约、成交日期、价格等期货委托字段
- 解除期货数量（可编辑）：用户输入
- 解除合同数量（可编辑）：用户输入
- 发生日期时间（可编辑）：用户输入

**操作按钮**：
- 确定：保存解除关联操作
- 取消：关闭弹窗，不保存

#### 1.4.3 解除采销关联标签页

**用户可自定义筛选**：
- 关联日期区间
- 合同编号
- 客商
- 业务经理

**表格显示字段**：
- 选择（复选框）
- 合同编号、客户/供应商、业务经理等合同字段
- 解除数量（可编辑）：用户输入
- 发生日期时间（可编辑）：用户输入

**操作按钮**：
- 确定：保存解除关联操作
- 取消：关闭弹窗，不保存

### 1.5 点价功能

#### 1.5.1 点价弹窗

选择暂定价合同后点击"点价"按钮，弹出点价弹窗。

**表单字段**：
- **点价数量**：文本输入框
- **点价价格**：文本输入框
- **发生日期时间**：日期时间选择器

**期货委托表格**：
- **默认筛选条件**：
  - 保值方案：与合同相同的保值方案
  - 方向：与合同方向匹配
  - 品种：与合同现货品种匹配的期货品种
  - 未匹配数量 > 0
- **用户可自定义筛选**：
  - 合约代码
  - 成交日期区间
  - 价格范围
- **表格字段**：
  - 选择（复选框）
  - 合约、买卖、开平、成交日期、价格等期货委托字段
  - 期货数量（可编辑）：用户输入
- **操作按钮**：
  - 确定：保存点价操作
  - 取消：关闭弹窗，不保存

#### 1.5.2 点价操作说明

点价操作会触发点价事件，影响合同数据：
- 更新合同的已点数量
- 更新合同的单价（如果点价价格不为空）
- 创建期现关联关系
- 更新期现备注记录

**取消点价的方法**：
- 编辑合同的结算价和已点价数量
- 解除部分或者全部期现关系

### 1.6 采销关系查看

#### 1.6.1 采销关系弹窗（采购合同）

点击采购合同的"已销售数量"字段，弹出采销关系弹窗。

**弹窗标题**：采销关系

**顶部信息**：
- 当前合同的基本信息：合同编号、供应商、合同数量

**表格内容**：
- 显示关联的销售合同列表
- 表格列：合同编号、客户、业务经理、关联数量、关联日期、发生日期时间
- 支持分页显示，每页20条记录
- 表格高度可滚动查看，最大高度500px
- 表格为只读模式，仅用于查看关联关系

#### 1.6.2 采购关系弹窗（销售合同）

点击销售合同的"已采购数量"字段，弹出采购关系弹窗。

**弹窗标题**：采购关系

**顶部信息**：
- 当前合同的基本信息：合同编号、客户、合同数量

**表格内容**：
- 显示关联的采购合同列表
- 表格列：合同编号、供应商、业务经理、关联数量、关联日期、发生日期时间
- 支持分页显示，每页20条记录
- 表格高度可滚动查看，最大高度500px
- 表格为只读模式，仅用于查看关联关系

### 1.7 合同变更与指令联动

#### 1.7.1 变更场景判断

当用户保存合同变更（创建/编辑/删除）时，系统按以下顺序判断场景：

**场景1：单单均价合同套保指令**
- 存在针对该合同的未完成父指令（均价合同套保指令）
- 处理方式：自动创建或更新子指令（均价合同变更指令），重新计算父指令所需数量

**场景2：单单非均价合同套保指令**
- 存在针对该合同的未完成父指令（非均价合同套保指令）
- 处理方式：显示提示信息，允许直接保存合同变更，不处理相关指令

**场景3：整体类型父指令（均价自动指令）**
- 合同所属保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
- 存在该保值方案的未完成父指令（保值方案均价净值套保指令），且指令创建日期为当前交易日
- 处理方式：自动创建或更新子指令，重新计算父指令所需数量

**场景4：整体类型父指令（非自动指令）**
- 存在该合同所属保值方案的未完成父指令（保值方案净值套保指令或保值方案均价净值套保指令）
- 父指令的创建日期为当前交易日
- 处理方式：自动创建或更新子指令，重新计算父指令所需数量

**场景5：无匹配场景**
- 不存在未完成的父指令
- 处理方式：直接保存合同变更，不创建指令

#### 1.7.2 子指令创建规则

**子指令信息**：
- 指令类型：均价合同变更指令 或 非均价合同变更指令
- 父指令ID：关联到父指令
- 合同ID：当前合同ID
- 保值方案ID：当前合同所属保值方案ID
- 子指令数量影响：变更数量（合同数量的变化值）
- 变更所需期货：变更数量 × 敞口系数
- 变更前现货敞口：变更前的合同数量
- 变更后现货敞口：变更后的合同数量
- 变更前期货数量：变更前合同数量 × 敞口系数
- 变更后期货数量：变更后合同数量 × 敞口系数
- 指令状态：待完成
- 创建日期时间：当前时间
- 交易日：当前交易日

**父指令数量重新计算**：
- 查询父指令的所有子指令（包括新创建/更新的子指令）
- 计算父指令的所需数量：所有子指令的"变更所需期货"之和
- 如果计算结果为负数，取绝对值
- 更新父指令的所需数量字段

---

## 二、数据来源和相关计算公式

### 2.1 合同基础字段数据来源

#### 2.1.1 直接输入字段

以下字段由用户在创建或编辑合同时直接输入：
- 保值方案_id、业务经理、合同编号、供应商/客户、现货品种、品牌、计价方式、合同数量、单价、结算单价、运输方式、交割日期、均价起止日、点价截止日、发生日期时间、备注

#### 2.1.2 系统缺省字段

以下字段由系统自动设置，用户无需输入：
- **创建人**：初始设置为当前登录用户的人员ID
- **创建日期时间**：初始设置为当前系统时间
- **已点数量**：初始设置为0
- **状态**：初始设置为"enable"（启用）

**说明**：如果发生日期时间未填写，系统将使用创建日期时间作为发生日期时间。

### 2.2 计算字段

#### 2.2.1 合同金额

**计算公式**：合同金额 = 合同数量 × 单价

**数据来源**：
- 合同数量：来自"合同数量"字段（decimal）
- 单价：来自"单价"字段（decimal）

**说明**：
- 如果合同数量或单价为空，合同金额显示为0或"-"
- 实时计算，不存储

#### 2.2.2 结算金额

**计算公式**：结算金额 = 合同数量 × 结算单价

**数据来源**：
- 合同数量：来自"合同数量"字段（decimal）
- 结算单价：来自"结算单价"字段（decimal）

**说明**：
- 如果合同数量或结算单价为空，结算金额显示为0或"-"
- 实时计算，不存储

#### 2.2.3 未点数量

**计算公式**：未点数量 = 合同数量 - 已点数量

**数据来源**：
- 合同数量：来自"合同数量"字段（decimal）
- 已点数量：来自"已点数量"字段（decimal，系统缺省为0）

**说明**：
- 未点数量表示尚未点价的合同数量
- 如果合同数量为空，未点数量显示为"-"
- 如果已点数量大于合同数量，未点数量显示为0（不允许负数）
- 实时计算，不存储

### 2.3 事件驱动字段

#### 2.3.1 已点数量

**数据来源**：点价事件

**说明**：
- 已点数量是点价事件的结果，不是直接输入字段
- 点价事件会更新合同的已点数量和单价
- 点价事件通过以下方式触发：
  - 合同管理中的直接点价按钮：用于线下交流后，先做了期货，后在系统中补充点价操作步骤
  - 指令中的点价：规范化的操作流程
- 已点数量初始值为0，通过点价事件累加

**点价事件影响**：
- 更新合同的已点数量：已点数量（新）= 已点数量（旧）+ 点价数量
- 更新合同的单价：如果点价价格不为空，更新单价为点价价格
- 创建期现关联关系
- 更新期现备注记录

#### 2.3.2 已销售数量（采购合同）

**计算公式**：已销售数量 = SUM(采销关联记录中的关联数量)

**数据来源**：采销关联事件

**说明**：
- 仅适用于采购合同
- 统计该采购合同已经关联销售的合同数量总和
- 通过采销关联事件累加
- 如果没有任何采销关联记录，已销售数量显示为0
- 点击该字段可以弹出采销关系表格，查看详细的关联记录

#### 2.3.3 已采购数量（销售合同）

**计算公式**：已采购数量 = SUM(采销关联记录中的关联数量)

**数据来源**：采销关联事件

**说明**：
- 仅适用于销售合同
- 统计该销售合同已经关联采购的合同数量总和
- 通过采销关联事件累加
- 如果没有任何采销关联记录，已采购数量显示为0
- 点击该字段可以弹出采购关系表格，查看详细的关联记录

### 2.4 计算逻辑字段

#### 2.4.1 是否已定价

**计算公式**：是否已定价 = 已点数量 > 0

**数据来源**：
- 已点数量：来自"已点数量"字段（decimal）

**说明**：
- 如果已点数量 > 0，显示"是"
- 如果已点数量 = 0，显示"否"
- 实时计算，不存储
- 用于筛选和显示

#### 2.4.2 是否已交收

**计算公式**：是否已交收 = 交割日期 <= 当前日期

**数据来源**：
- 交割日期：来自"交割日期"字段（date）
- 当前日期：系统当前日期

**说明**：
- 如果交割日期 <= 当前日期，显示"是"
- 如果交割日期 > 当前日期 或 交割日期为空，显示"否"
- 实时计算，不存储
- 用于筛选和显示

#### 2.4.3 是否在定价期

**计算公式**：是否在定价期 = 当前日期 <= 点价截止日

**数据来源**：
- 点价截止日：来自"点价截止日"字段（date）
- 当前日期：系统当前日期

**说明**：
- 如果当前日期 <= 点价截止日，显示"是"
- 如果当前日期 > 点价截止日 或 点价截止日为空，显示"否"
- 实时计算，不存储
- 用于筛选和显示
- 仅适用于暂定价合同

#### 2.4.4 均价合同的是否已定价

**计算公式**：均价合同的是否已定价 = 当前日期 >= 均价起止日的结束日期

**数据来源**：
- 均价起止日：来自"均价起止日"字段（date范围）
- 当前日期：系统当前日期

**说明**：
- 仅适用于均价合同
- 如果当前日期 >= 均价起止日的结束日期，显示"是"（已定价）
- 如果当前日期 < 均价起止日的结束日期，显示"否"（未定价）
- 实时计算，不存储
- 用于筛选和显示

### 2.5 指令和子指令相关字段

#### 2.5.1 变更所需期货数量

**计算公式**：变更所需期货数量（手数）= 变更数量 × 敞口系数

**数据来源**：
- 变更数量：变更后合同数量 - 变更前合同数量
- 敞口系数：从合同关联的保值方案中获取，根据合同的品牌配置查找对应的期货敞口系数

**说明**：
- 用于合同变更时计算对指令的影响
- 如果变更数量为正数（增加），变更所需期货为正数（需要买入）
- 如果变更数量为负数（减少），变更所需期货为负数（需要卖出）
- 如果变更数量为0，变更所需期货为0（无影响）

#### 2.5.2 父指令所需数量

**计算公式**：父指令所需数量 = SUM(所有子指令的变更所需期货)

**数据来源**：
- 所有子指令的变更所需期货：查询父指令的所有子指令，计算每个子指令的变更所需期货

**说明**：
- 用于合同变更时重新计算父指令的所需数量
- 如果计算结果为负数，取绝对值（因为指令数量不能为负数）
- 更新父指令的所需数量字段

---

## 三、数据一致性和数据约束

### 3.1 期现关联的数据一致性

#### 3.1.1 期现关联匹配操作

当用户在合同关联弹出框中进行期现关联匹配操作时，系统需要保证以下数据的一致性：

**委托单表的更新**：
- 已匹配手数字段更新：已匹配手数（新）= 已匹配手数（旧）+ 本次匹配的期货数量
- 约束条件：已匹配手数（新）≤ 成交手数（不允许超过成交手数）
- 未匹配手数字段更新：未匹配手数（新）= 成交手数 - 已匹配手数（新）
- 约束条件：未匹配手数（新）≥ 0（不允许负数）
- 是否已匹配状态更新：如果已匹配手数（新）> 0，自动将"是否已匹配"状态设置为"是"

**期现备注表的创建和更新**：
- 所有匹配都会影响到委托单列表的期现备注，且会自动将状态标为已匹配
- 创建期现备注记录：包含委托_id、合同_id、手数、现货数量、点价价格、标签、是否已匹配等信息
- 更新期现备注记录：如果委托单已存在期现备注记录，系统会更新现有记录，增加关联的手数
- 期现备注状态自动更新：完成匹配操作后，系统自动将期现备注的"是否已匹配"状态标为"是"

**数据一致性约束**：
- 匹配数量不能超过未匹配手数：本次匹配的期货数量 ≤ 委托单的未匹配手数
- 匹配数量必须大于0：本次匹配的期货数量 > 0
- 合同数量与期货数量的对应关系：合同数量与期货数量应该符合保值方案的配置比例（可选验证）

**事务性保证**：
- 所有匹配操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个匹配操作需要回滚
- 确保委托单、期现备注、合同关联等表的数据同时更新或同时回滚

#### 3.1.2 期现解除关联操作

当用户进行期现解除关联操作时，系统需要保证以下数据的一致性：

**委托单表的更新**：
- 已匹配手数字段更新：已匹配手数（新）= 已匹配手数（旧）- 本次解除的期货数量
- 约束条件：已匹配手数（新）≥ 0（不允许负数）
- 未匹配手数字段更新：未匹配手数（新）= 成交手数 - 已匹配手数（新）
- 是否已匹配状态更新：如果已匹配手数（新）= 0，自动将"是否已匹配"状态设置为"否"

**期现备注表的更新**：
- 更新期现备注记录：减少关联的手数
- 如果期现备注的手数全部解除，可以删除期现备注记录或标记为已解除

**数据一致性约束**：
- 解除数量不能超过已匹配手数：本次解除的期货数量 ≤ 委托单的已匹配手数
- 解除数量必须大于0：本次解除的期货数量 > 0

**事务性保证**：
- 所有解除关联操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个操作需要回滚

### 3.2 采销关联的数据一致性

#### 3.2.1 采销关联匹配操作

当用户进行采销关联匹配操作时，系统需要保证以下数据的一致性：

**合同表的更新**：
- 已销售数量字段更新（采购合同）：已销售数量（新）= 已销售数量（旧）+ 本次关联的数量
- 约束条件：已销售数量（新）≤ 合同数量（不允许超过合同数量）
- 已采购数量字段更新（销售合同）：已采购数量（新）= 已采购数量（旧）+ 本次关联的数量
- 约束条件：已采购数量（新）≤ 合同数量（不允许超过合同数量）

**采销关联关系表的创建**：
- 创建采销关联关系记录，包含采购合同_id、销售合同_id、关联数量、关联日期、发生日期时间

**数据一致性约束**：
- 关联数量不能超过合同的剩余未关联数量：剩余未关联数量 = 合同数量 - 已关联数量
- 关联数量必须大于0：本次关联的数量 > 0
- 保值方案一致性：采购合同和销售合同的保值方案必须一致（强制约束）

**展示一致性（合同表 → 采销关联弹窗 → 采销关联详情）**：
- 合同表中展示的数量 = 弹窗顶部显示的"已关联数量"总计
- 弹窗列表中所有采销关联记录的"关联数量"求和 = 弹窗顶部总计
- 在弹窗中继续点击某条"采销关联"进入详情后，详情页展示的"关联数量" = 该记录在列表中的"关联数量" = 参与该记录的一对采购/销售合同字段的累计更新值
- 校验方式：前端打开弹窗与详情时均重新拉取后台数据；后台在返回结果前再次校验上述三层数据是否一致，若不一致则返回错误并阻止页面展示旧数据
- 异常提示：当任意一层数据不相等时，统一提示"采销关联数量不一致，请刷新或联系管理员"，并在日志中记录合同ID、关联ID与数值差

**事务性保证**：
- 所有采销关联操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个操作需要回滚

#### 3.2.2 采销解除关联操作

当用户进行采销解除关联操作时，系统需要保证以下数据的一致性：

**合同表的更新**：
- 已销售数量字段更新（采购合同）：已销售数量（新）= 已销售数量（旧）- 本次解除的数量
- 约束条件：已销售数量（新）≥ 0（不允许负数）
- 已采购数量字段更新（销售合同）：已采购数量（新）= 已采购数量（旧）- 本次解除的数量
- 约束条件：已采购数量（新）≥ 0（不允许负数）

**采销关联关系表的更新**：
- 更新采销关联关系记录：减少关联的数量
- 如果关联数量全部解除，可以删除采销关联关系记录或标记为已解除

**数据一致性约束**：
- 解除数量不能超过已关联数量：本次解除的数量 ≤ 已关联数量
- 解除数量必须大于0：本次解除的数量 > 0

**事务性保证**：
- 所有解除关联操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个操作需要回滚

### 3.3 合同表的数据一致性

#### 3.3.1 数量字段的一致性

**已点数量约束**：
- 规则：已点数量 ≤ 合同数量
- 验证时机：更新已点数量时
- 错误提示：如果超出，提示"已点数量不能超过合同数量"

**未点数量计算**：
- 规则：未点数量 = 合同数量 - 已点数量
- 自动更新：当已点数量或合同数量发生变化时，自动重新计算未点数量

**已销售数量约束（采购合同）**：
- 规则：已销售数量 ≤ 合同数量
- 验证时机：更新已销售数量时
- 错误提示：如果超出，提示"已销售数量不能超过合同数量"

**已采购数量约束（销售合同）**：
- 规则：已采购数量 ≤ 合同数量
- 验证时机：更新已采购数量时
- 错误提示：如果超出，提示"已采购数量不能超过合同数量"

#### 3.3.2 金额字段的一致性

**合同金额计算**：
- 规则：合同金额 = 合同数量 × 单价
- 自动更新：当合同数量或单价发生变化时，自动重新计算合同金额

**结算金额计算**：
- 规则：结算金额 = 合同数量 × 结算单价
- 自动更新：当合同数量或结算单价发生变化时，自动重新计算结算金额

### 3.4 合同变更与指令的数据一致性

#### 3.4.1 子指令创建的数据一致性

**子指令信息完整性**：
- 子指令必须关联到父指令（父指令ID不能为空）
- 子指令必须关联到合同（合同ID不能为空）
- 子指令必须关联到保值方案（保值方案ID不能为空）
- 子指令的变更数量不能为0（如果为0，不创建子指令）

**父指令数量重新计算**：
- 父指令所需数量 = 所有子指令的变更所需期货之和
- 如果计算结果为负数，取绝对值
- 更新父指令的所需数量字段

**事务性保证**：
- 所有合同变更和指令操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个操作需要回滚
- 确保合同、指令、子指令的数据同时更新或同时回滚

#### 3.4.2 场景3.2的特殊处理

**单单非均价合同套保指令的处理**：
- 不处理相关指令（不撤销、不修改、不创建新指令）
- 只显示提示信息，允许直接保存合同变更
- 由相关人员后续手动处理
- 事务只包含合同变更操作，不包含指令操作

### 3.5 数据约束规则总结

#### 3.5.1 数值约束

- 所有数量字段（手数、数量）不允许负数
- 所有金额字段不允许负数
- 已匹配数量/已点数量/已销售数量等累计字段不能超过对应的总量字段

#### 3.5.2 关联约束

- 外键关联必须指向存在的记录
- 删除操作需要考虑关联数据的处理（级联删除或阻止删除）
- 关联关系的数据类型必须匹配（如ID类型）
- 采销关联时，采购合同和销售合同的保值方案必须一致（强制约束）

#### 3.5.3 状态一致性约束

- 计算状态字段必须与基础数据保持一致
- 当基础数据发生变化时，相关状态字段需要自动更新
- 期现备注的匹配状态必须与委托单的匹配状态保持一致

#### 3.5.4 事务性约束

- 所有关联操作必须在同一个事务中完成
- 保证数据的原子性、一致性、隔离性和持久性（ACID特性）
- 合同变更与指令操作必须在同一事务中完成（场景1、场景3.1、场景2除外）

### 3.6 数据一致性检查

#### 3.6.1 定期检查任务

系统应该定期运行数据一致性检查任务：
- 检查委托单的已匹配手数是否与期现备注的手数总和一致
- 检查合同的已点数量是否与点价记录的总和一致
- 检查合同的已销售数量是否与采销关联记录的总和一致
- 检查合同的已采购数量是否与采销关联记录的总和一致

#### 3.6.2 异常处理

- 如果发现数据不一致，系统应该记录异常日志
- 提供数据修复工具或手动修复流程
- 通知系统管理员进行处理

---

## 四、其他补充

### 4.1 禁用启用规则

#### 4.1.1 合同禁用

**影响范围**：
- 合同新增：无法选择禁用的保值方案、客商、现货品种、品牌、业务经理
- 期现关联：无法选择禁用的合同进行关联
- 采销关联：无法选择禁用的合同进行关联
- 点价操作：无法对禁用的合同进行点价操作

**历史数据不受影响**：
- 之前关联的期货委托不受影响
- 之前关联的采销合同不受影响
- 已创建的指令不受影响

#### 4.1.2 关联数据禁用

**保值方案禁用**：
- 合同新增：无法选择禁用的保值方案
- 期货下单：不能选择禁用的保值方案
- 历史数据不受影响：之前选择了这个保值方案的合同不受影响

**客商禁用**：
- 合同新增：不能在创建合同时引用禁用的客商
- 历史数据不受影响：已有合同不受影响

**现货品种/品牌禁用**：
- 合同新增：不能在创建合同时引用禁用的现货品种/品牌
- 历史数据不受影响：已有合同不受影响

### 4.2 合同换保值方案的前提

#### 4.2.1 整体匹配的保值方案

**合同换保值方案的前提**：
- 期货没有限制
- 合同不应有采销关联

#### 4.2.2 单单匹配的保值方案

**合同换保值方案的前提**：
- 合同应该没有期现和采销关联
- 期货应该没有期现关联

### 4.3 发生日期时间与创建日期时间

#### 4.3.1 字段说明

- **发生日期时间**：用于定义事件的时间归属，比如今天为昨天的均价指令补了一些期货交易，这个期货交易应该归属在昨天的关系和敞口中
- **创建日期时间**：实际发生的日期时间，系统自动设置为当前系统时间

#### 4.3.2 使用规则

- 如果发生日期时间未填写，系统将使用创建日期时间作为发生日期时间
- 发生日期时间可以早于创建日期时间（用于补录历史数据）
- 发生日期时间不能晚于创建日期时间（不允许未来时间）

### 4.4 合同删除（作废）规则

#### 4.4.1 删除操作

- 合同删除采用软删除方式，在数据库中标识为delete状态
- 删除后的合同在界面中不显示
- 标准界面流程中不能更改delete标志

#### 4.4.2 删除约束

- 如果合同有关联的期货委托（期现关联），需要先解除关联才能删除
- 如果合同有关联的采销合同（采销关联），需要先解除关联才能删除
- 如果合同有未完成的指令，需要先处理指令才能删除（或提示用户）

#### 4.4.3 合同取消

- 合同取消等同于数量变更为0
- 合同状态更新为"取消"（delete状态，但语义是"取消"）
- 合同数量更新为0
- 现货敞口更新为0
- 合同记录仍然保留在系统中（软删除）

### 4.5 自定义字段支持

#### 4.5.1 自定义字段配置

- 系统支持为合同表添加自定义字段
- 自定义字段的配置由管理员在"全局设置 > 合同自定字段"中设置
- 自定义字段可以设置为必填或选填

#### 4.5.2 自定义字段显示

- 自定义字段可以在表格中显示（通过列配置添加）
- 自定义字段可以在创建/编辑弹窗中显示
- 自定义字段支持筛选和排序

### 4.6 合同报表

#### 4.6.1 报表功能（待实现）

合同宝模块包含以下报表功能（具体实现待补充）：
- 均价合同今日净值预估
- 查看合同与期货的关系
- 查看采销合同的关系
- 合同事件流水查询
- 合同敞口分列与合计

### 4.7 性能优化建议

#### 4.7.1 查询优化

- 在查询未完成指令时，使用索引优化查询性能
- 缓存保值方案的敞口系数配置，减少数据库查询
- 批量查询多个合同的未完成指令，减少数据库交互次数

#### 4.7.2 计算优化

- 预算计算使用前端实时计算，减少服务器压力
- 复杂计算使用缓存机制，避免重复计算
- 异步处理非关键操作（如操作日志记录）

#### 4.7.3 界面优化

- 预算区域使用防抖机制，避免频繁计算
- 未完成指令列表使用分页或虚拟滚动，提高加载速度
- 使用骨架屏或加载动画，提升用户体验

### 4.8 异常处理

#### 4.8.1 计算异常

**敞口系数未配置**：
- 提示用户："该合同的保值方案未配置敞口系数，无法计算变更影响"
- 阻止保存合同变更（因为需要创建子指令的场景必须要有敞口系数）
- 引导用户到保值方案配置页面配置敞口系数
- 记录错误日志

#### 4.8.2 数据异常

**父指令不存在**：
- 如果场景判断时发现父指令已被删除或不存在
- 按场景5处理，直接保存合同变更

**父指令状态异常**：
- 如果父指令状态不是"待完成"（如已完成、已撤销）
- 按场景5处理，直接保存合同变更

#### 4.8.3 业务异常

**变更数量为0**：
- 如果变更数量为0（合同数量未变化）
- 不创建子指令，直接保存合同变更

**变更所需期货为0**：
- 如果变更所需期货计算结果为0（变更数量为0或敞口系数为0）
- 不创建子指令，直接保存合同变更

**合同取消时，数量不为0**：
- 如果合同状态为"取消"，但合同数量不为0
- 阻止保存，返回错误信息："合同取消时，数量必须为0"

**合同取消时，现货敞口不为0**：
- 如果合同状态为"取消"，但现货敞口不为0
- 阻止保存，返回错误信息："合同取消时，现货敞口必须为0"

### 4.9 后续扩展

如果后续版本中新增功能或修改业务规则，需要同步更新本文档，明确：
1. 新增功能的界面描述和操作流程
2. 新增字段的数据来源和计算公式
3. 新增数据一致性规则和约束条件
4. 新增异常处理规则

---

## 附录：字段类型说明

- **str**：字符串类型
- **int**：整数类型
- **decimal**：小数类型，用于金额、数量等
- **bool**：布尔类型，true/false
- **date**：日期类型
- **datetime**：日期时间类型
- **json_list**：JSON数组类型，用于存储多个值的列表
