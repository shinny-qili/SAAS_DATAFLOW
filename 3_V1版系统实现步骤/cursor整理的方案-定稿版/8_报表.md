# 报表模块产品方案

本文档描述系统报表模块的完整产品方案，包括报表分类、功能描述、数据来源、计算公式、界面设计和数据约束。

---

## 一、概述

### 1.1 服务定位

报表模块是系统的数据分析和展示中心，提供多维度、多层次的业务数据统计和分析功能，帮助用户从不同视角了解业务状况、监控风险、评估绩效。

### 1.2 报表与风控的分界线

- **报表**：对系统现状的呈现，提供数据查询、统计、分析功能，帮助用户了解业务状态
- **风控**：警告、阻止等既成事实的呈现和后续动作
- 一个系统基本无法将所有意外情况都以警告、阻止的形式呈现，所以需要报表及其下钻以人主观作为风控的补充
- 风控是风控，报表的一部分也可用于风控
- 例如：VaR预测和压力测试属于功能，可能放在风控页，是可用于风控服务的一个功能

### 1.3 模块结构

报表模块包含以下子模块：
- **合同报表**：合同相关的统计和分析报表
- **指令报表**：指令执行情况的统计报表
- **匹配报表**：期现关联和采销关联的统计报表
- **交易报表**：期货交易和账户相关的统计报表
- **综合报表**：跨模块的综合统计报表
- **自定义报表**：基于结构化报表配置的自定义报表

### 1.4 报表分类

#### 1.4.1 按时间维度分类

- **实时报表**：显示当前最新状态的数据报表
- **逐日表**：按交易日统计的报表，显示每日数据
- **期末表**：按时间节点（如月末、季末、年末）统计的报表
- **历史完整表**：显示历史完整数据的报表

#### 1.4.2 按业务维度分类

- **合同维度**：按合同、业务经理、客商等维度统计
- **指令维度**：按指令、交易员、保值方案等维度统计
- **期货账户维度**：按期货账户、合约、品种等维度统计
- **保值方案维度**：按保值方案、品种、品牌等维度统计

#### 1.4.3 按功能分类

- **统计报表**：数据汇总和统计
- **分析报表**：数据分析和趋势展示
- **明细报表**：详细数据列表
- **对比报表**：多维度数据对比

---

## 二、合同报表

### 2.1 目录路径

- 一级：报表
- 二级：合同报表

### 2.2 报表列表

#### 2.2.1 均价合同今日净值预估

**功能说明**：
- 显示均价合同在当前交易日的净值预估
- 用于业务经理和交易员了解均价合同的当前价值

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 合同编号（模糊搜索）
- 现货品种（多选）
- 品牌（多选）
- 合同状态（多选）

**表格字段**：
- 合同编号
- 保值方案
- 业务经理
- 供应商/客户
- 现货品种
- 品牌
- 合同数量
- 均价起止日
- 当前均价
- 今日净值预估
- 已点数量
- 未点数量
- 合同状态

**数据来源**：
- 合同基础数据（合同表）
- 均价日历数据（交易日历）
- 现货价格数据（现货价格表）
- 点价记录（点价事件表）

**计算公式**：
- 今日净值预估 = 合同数量 × 当前均价
- 当前均价：根据均价起止日和均价日历计算
- 未点数量 = 合同数量 - 已点数量

#### 2.2.2 查看合同与期货的关系

**功能说明**：
- 展示合同与期货委托的关联关系
- 用于了解合同的套保情况

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 合同编号（模糊搜索）
- 期货账户（多选）
- 合约代码（模糊搜索）
- 关联日期范围

**表格字段**：
- 合同编号
- 保值方案
- 业务经理
- 供应商/客户
- 现货品种
- 品牌
- 合同数量
- 关联期货账户
- 关联合约
- 关联方向
- 关联期货数量（手数）
- 关联合同数量
- 关联日期
- 点价价格（如适用）

**数据来源**：
- 合同基础数据（合同表）
- 期现关联记录（期现关联事件表）
- 期货委托数据（委托单表）

**数据下钻**：
- 点击合同编号可查看合同详情
- 点击关联合约可查看期货委托明细
- 支持查看关联历史记录

#### 2.2.3 查看采销合同的关系

**功能说明**：
- 展示采购合同与销售合同的关联关系
- 用于了解采销匹配情况

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 合同编号（模糊搜索）
- 客商（多选）
- 现货品种（多选）
- 品牌（多选）
- 关联日期范围

**表格字段**：
- 采购合同编号
- 采购供应商
- 采购业务经理
- 采购数量
- 销售合同编号
- 销售客户
- 销售业务经理
- 销售数量
- 关联数量
- 关联日期
- 发生日期时间
- 保值方案

**数据来源**：
- 合同基础数据（合同表）
- 采销关联记录（采销关联事件表）

**数据下钻**：
- 点击合同编号可查看合同详情
- 支持查看关联历史记录
- 支持查看关联利润分析

#### 2.2.4 合同事件流水查询

**功能说明**：
- 展示合同的所有变更事件记录
- 用于追溯合同的历史变更

**筛选条件**：
- 合同编号（模糊搜索）
- 保值方案（多选）
- 业务经理（多选）
- 事件类型（多选）：创建、编辑、删除、点价、期现关联、采销关联等
- 事件日期范围
- 操作人（多选）

**表格字段**：
- 事件时间
- 合同编号
- 保值方案
- 业务经理
- 事件类型
- 操作人
- 变更内容（显示变更前后对比）
- 变更说明

**数据来源**：
- 合同变更事件表（合同创建、编辑、删除事件）
- 点价事件表
- 期现关联事件表
- 采销关联事件表

**数据下钻**：
- 点击事件可查看详细变更内容
- 支持查看变更前后的数据对比

#### 2.2.5 合同敞口分列与合计

**功能说明**：
- 展示合同的敞口情况，按不同维度分列展示
- 用于了解合同的敞口分布和合计

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 现货品种（多选）
- 品牌（多选）
- 合同状态（多选）
- 统计日期

**表格字段**：

**按合同维度**：
- 合同编号
- 保值方案
- 业务经理
- 供应商/客户
- 现货品种
- 品牌
- 合同数量
- 已点数量
- 未点数量
- 已销售数量（采购合同）/已采购数量（销售合同）
- 现货敞口（合同数量 - 已点数量 - 已销售/已采购数量）
- 期货敞口（关联的期货数量）
- 敞口系数
- 敞口状态（已对冲/未对冲/部分对冲）

**按保值方案维度合计**：
- 保值方案
- 合同数量合计
- 已点数量合计
- 未点数量合计
- 现货敞口合计
- 期货敞口合计
- 敞口覆盖率（期货敞口 / 现货敞口）

**按业务经理维度合计**：
- 业务经理
- 合同数量合计
- 现货敞口合计
- 期货敞口合计
- 敞口覆盖率

**数据来源**：
- 合同基础数据（合同表）
- 期现关联记录（期现关联事件表）
- 采销关联记录（采销关联事件表）
- 敞口系数配置（保值方案配置）

**计算公式**：
- 现货敞口 = 合同数量 - 已点数量 - 已销售数量（采购合同）或 - 已采购数量（销售合同）
- 期货敞口 = SUM(期现关联记录中的期货数量 × 敞口系数)
- 敞口覆盖率 = 期货敞口 / 现货敞口（如果现货敞口 > 0）

**数据下钻**：
- 点击保值方案可查看该方案下的所有合同明细
- 点击业务经理可查看该业务经理的所有合同明细
- 支持按品种、品牌等维度下钻

#### 2.2.6 按业务负责人的合同的应交收和实际交收

**功能说明**：
- 展示按业务经理统计的合同交收情况
- 标红提示期货套保但是未交收的合同
- 用于业务经理了解合同交收进度

**筛选条件**：
- 业务经理（多选）
- 保值方案（多选）
- 客商（多选）
- 现货品种（多选）
- 交收日期范围

**表格字段**：
- 业务经理
- 合同编号
- 保值方案
- 供应商/客户
- 现货品种
- 品牌
- 合同数量
- 应交收数量
- 实际交收数量
- 未交收数量
- 交收完成率
- 交割日期
- 是否已交收
- 是否已套保（期货敞口 > 0）
- 套保未交收标识（标红提示）

**数据来源**：
- 合同基础数据（合同表）
- 期现关联记录（期现关联事件表）
- 交收记录（如有交收事件表）

**计算公式**：
- 应交收数量 = 合同数量
- 实际交收数量 = SUM(交收记录中的交收数量)
- 未交收数量 = 应交收数量 - 实际交收数量
- 交收完成率 = 实际交收数量 / 应交收数量
- 是否已套保 = 期货敞口 > 0
- 套保未交收标识 = 是否已套保 AND 未交收数量 > 0

**特殊标识**：
- 套保未交收的合同行标红显示
- 支持按套保未交收筛选

---

## 三、指令报表

### 3.1 目录路径

- 一级：报表
- 二级：指令报表

### 3.2 报表列表

#### 3.2.1 在途指令

**功能说明**：
- 显示所有状态为"待完成"或"撤销待处理"的指令
- 用于实时监控当前系统中的在途指令情况

**筛选条件**：
- 保值方案（多选）
- 指令类型（多选）
- 发起人（多选）
- 指令状态（多选）：待完成、撤销待处理
- 日期范围

**表格字段**：
- 指令编号
- 指令类型
- 保值方案
- 发起人
- 发起时间
- 指令状态
- 期货交易状态
- 合同创建状态
- 期货交易认领人
- 合同创建认领人
- 所需数量（手数）
- 已匹配数量（手数）
- 未匹配数量（手数）
- 最后更新时间

**数据来源**：
- 指令基础数据（指令表）
- 指令匹配记录（指令匹配事件表）

**数据下钻**：
- 点击指令编号可查看指令详情
- 支持查看指令的备注记录
- 支持查看指令的匹配明细

#### 3.2.2 历史指令

**功能说明**：
- 显示所有已完成的指令
- 支持按时间范围查询历史指令记录

**筛选条件**：
- 保值方案（多选）
- 指令类型（多选）
- 发起人（多选）
- 完成时间范围
- 日期范围

**表格字段**：
- 指令编号
- 指令类型
- 保值方案
- 发起人
- 发起时间
- 完成时间
- 指令状态（固定为"完成"）
- 期货交易状态
- 合同创建状态
- 期货交易认领人
- 合同创建认领人
- 所需数量（手数）
- 已匹配数量（手数）
- 执行时长（完成时间 - 发起时间）

**数据来源**：
- 指令基础数据（指令表）
- 指令匹配记录（指令匹配事件表）

**数据下钻**：
- 点击指令编号可查看指令详情
- 支持查看指令的执行历史
- 支持查看指令的匹配明细

#### 3.2.3 按交易员认领的指令的完成情况和敞口

**功能说明**：
- 展示按交易员统计的指令完成情况和敞口
- 逐日表，显示每日数据
- 用于评估交易员的指令执行情况

**筛选条件**：
- 交易员（多选）
- 保值方案（多选）
- 指令类型（多选）
- 日期范围

**表格字段**：

**按交易员维度**：
- 交易员
- 交易日
- 认领指令数量
- 已完成指令数量
- 待完成指令数量
- 指令完成率
- 认领所需数量合计（手数）
- 已匹配数量合计（手数）
- 未匹配数量合计（手数）
- 敞口数量（手数）

**按指令明细**：
- 指令编号
- 指令类型
- 保值方案
- 发起人
- 发起时间
- 指令状态
- 所需数量（手数）
- 已匹配数量（手数）
- 未匹配数量（手数）
- 敞口数量（手数）

**数据来源**：
- 指令基础数据（指令表）
- 指令匹配记录（指令匹配事件表）
- 交易员认领记录（指令认领事件表）

**计算公式**：
- 指令完成率 = 已完成指令数量 / 认领指令数量
- 敞口数量 = 未匹配数量（手数）

**数据下钻**：
- 点击交易员可查看该交易员的所有指令明细
- 点击交易日可查看该日的指令明细
- 支持按保值方案、指令类型等维度下钻

#### 3.2.4 指令更新记录

**功能说明**：
- 展示指令的所有更新记录
- 用于追溯指令的历史变更

**筛选条件**：
- 指令编号（模糊搜索）
- 保值方案（多选）
- 指令类型（多选）
- 更新日期范围
- 更新人（多选）

**表格字段**：
- 更新时间
- 指令编号
- 指令类型
- 保值方案
- 更新人
- 更新类型（内容更新、状态更新、匹配更新等）
- 更新内容（显示更新前后对比）
- 更新说明

**数据来源**：
- 指令更新事件表

**数据下钻**：
- 点击更新记录可查看详细更新内容
- 支持查看更新前后的数据对比

---

## 四、匹配报表

### 4.1 目录路径

- 一级：报表
- 二级：匹配报表

### 4.2 报表列表

#### 4.2.1 期现关联记录

**功能说明**：
- 展示所有期现关联记录
- 用于了解期货与现货的匹配情况

**筛选条件**：
- 保值方案（多选）
- 期货账户（多选）
- 合约代码（模糊搜索）
- 合同编号（模糊搜索）
- 关联日期范围
- 标签（多选）

**表格字段**：
- 关联日期
- 发生日期时间
- 保值方案
- 期货账户
- 合约代码
- 买卖方向
- 开平
- 成交日期
- 成交均价
- 期货数量（手数）
- 合同编号
- 合同数量
- 点价价格（如适用）
- 标签
- 是否已匹配

**数据来源**：
- 期现关联事件表
- 期货委托数据（委托单表）
- 合同基础数据（合同表）

**数据下钻**：
- 点击期货账户可查看该账户的所有关联记录
- 点击合同编号可查看该合同的所有关联记录
- 支持按保值方案、合约等维度下钻

#### 4.2.2 采销关联记录

**功能说明**：
- 展示所有采销关联记录
- 用于了解采购与销售的匹配情况

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 客商（多选）
- 现货品种（多选）
- 品牌（多选）
- 关联日期范围

**表格字段**：
- 关联日期
- 发生日期时间
- 保值方案
- 采购合同编号
- 采购供应商
- 采购业务经理
- 采购数量
- 销售合同编号
- 销售客户
- 销售业务经理
- 销售数量
- 关联数量
- 关联利润（如适用）

**数据来源**：
- 采销关联事件表
- 合同基础数据（合同表）

**数据下钻**：
- 点击合同编号可查看合同详情
- 支持查看关联利润分析
- 支持按保值方案、业务经理等维度下钻

---

## 五、交易报表

### 5.1 目录路径

- 一级：报表
- 二级：交易报表

### 5.2 报表列表

#### 5.2.1 期货账户信息一览（期末表）

**功能说明**：
- 展示期货账户的期末信息
- 用于了解各账户的资金、持仓等情况

**筛选条件**：
- 期货账户（多选）
- 统计日期（期末日期）

**表格字段**：
- 期货账户
- 账户权益
- 可用资金
- 占用保证金
- 风险度（占用保证金 / 账户权益）
- 总持仓手数
- 多头持仓手数
- 空头持仓手数
- 持仓市值
- 浮动盈亏
- 平仓盈亏（统计期间）
- 手续费（统计期间）
- 净盈亏（平仓盈亏 - 手续费）

**数据来源**：
- 期货账户基础数据（期货账户表）
- 期货持仓数据（持仓表）
- 期货成交数据（成交表）
- 账户资金数据（账户资金表）

**计算公式**：
- 风险度 = 占用保证金 / 账户权益
- 净盈亏 = 平仓盈亏 - 手续费

**数据下钻**：
- 点击期货账户可查看该账户的持仓明细
- 支持查看账户的交易明细
- 支持查看账户的资金流水

#### 5.2.2 按交易员的投机交易记录和盈亏报表

**功能说明**：
- 展示按交易员统计的投机交易记录和盈亏
- 历史完整表，显示所有历史数据
- 用于评估交易员的交易绩效

**筛选条件**：
- 交易员（多选）
- 期货账户（多选）
- 合约代码（模糊搜索）
- 交易日期范围

**表格字段**：

**按交易员维度**：
- 交易员
- 交易日期
- 交易笔数
- 开仓手数
- 平仓手数
- 平仓盈亏
- 手续费
- 净盈亏
- 胜率（盈利笔数 / 总笔数）
- 平均盈亏

**按交易明细**：
- 交易日期
- 交易时间
- 交易员
- 期货账户
- 合约代码
- 买卖方向
- 开平
- 成交价格
- 成交手数
- 平仓盈亏
- 手续费
- 净盈亏

**数据来源**：
- 期货成交数据（成交表）
- 期货平仓记录（平仓记录表）
- 交易员认领记录（指令认领事件表）

**计算公式**：
- 净盈亏 = 平仓盈亏 - 手续费
- 胜率 = 盈利笔数 / 总笔数
- 平均盈亏 = 净盈亏合计 / 交易笔数

**数据下钻**：
- 点击交易员可查看该交易员的所有交易明细
- 支持按合约、日期等维度下钻
- 支持查看交易员的盈亏趋势图

---

## 六、综合报表

### 6.1 目录路径

- 一级：报表
- 二级：综合报表

### 6.2 报表列表

#### 6.2.1 保值方案信息一览（期末表）

**功能说明**：
- 展示保值方案的期末信息
- 用于了解各保值方案的整体情况

**筛选条件**：
- 保值方案（多选）
- 统计日期（期末日期）

**表格字段**：
- 保值方案
- 方案类型
- 适用现货品种
- 适用品牌
- 关联合同数量
- 合同数量合计
- 现货敞口合计
- 期货敞口合计
- 敞口覆盖率
- 期货持仓手数合计
- 期货浮动盈亏
- 期货平仓盈亏（统计期间）
- 基差贡献（如适用）

**数据来源**：
- 保值方案基础数据（保值方案表）
- 合同基础数据（合同表）
- 期现关联记录（期现关联事件表）
- 期货持仓数据（持仓表）
- 期货成交数据（成交表）

**计算公式**：
- 现货敞口合计 = SUM(合同数量 - 已点数量 - 已销售/已采购数量)
- 期货敞口合计 = SUM(期现关联记录中的期货数量 × 敞口系数)
- 敞口覆盖率 = 期货敞口合计 / 现货敞口合计（如果现货敞口合计 > 0）

**数据下钻**：
- 点击保值方案可查看该方案下的所有合同明细
- 支持查看该方案的期货持仓明细
- 支持查看该方案的盈亏分析

#### 6.2.2 合同套期关系一览表（期末表）

**功能说明**：
- 展示合同的套期关系
- 用于了解合同的套保情况

**筛选条件**：
- 保值方案（多选）
- 业务经理（多选）
- 现货品种（多选）
- 品牌（多选）
- 统计日期（期末日期）

**表格字段**：
- 合同编号
- 保值方案
- 业务经理
- 供应商/客户
- 现货品种
- 品牌
- 合同数量
- 已点数量
- 未点数量
- 现货敞口
- 关联期货账户
- 关联合约
- 关联期货数量（手数）
- 期货敞口
- 敞口覆盖率
- 套保状态（已对冲/未对冲/部分对冲）

**数据来源**：
- 合同基础数据（合同表）
- 期现关联记录（期现关联事件表）
- 敞口系数配置（保值方案配置）

**计算公式**：
- 现货敞口 = 合同数量 - 已点数量
- 期货敞口 = SUM(期现关联记录中的期货数量 × 敞口系数)
- 敞口覆盖率 = 期货敞口 / 现货敞口（如果现货敞口 > 0）
- 套保状态：
  - 已对冲：敞口覆盖率 >= 100%
  - 未对冲：敞口覆盖率 = 0%
  - 部分对冲：0% < 敞口覆盖率 < 100%

**数据下钻**：
- 点击合同编号可查看合同详情
- 点击关联合约可查看期货委托明细
- 支持查看套保效果分析

---

## 七、自定义报表

### 7.1 目录路径

- 一级：报表
- 二级：自定义报表

### 7.2 功能说明

#### 7.2.1 结构化报表配置

**功能说明**：
- 基于结构化报表配置，用户可以自定义报表
- 支持配置报表的数据源、字段、筛选条件、分组、排序等

**配置项**：
- **数据源选择**：选择报表的数据来源（合同、指令、委托、期现关联、采销关联等）
- **字段选择**：选择要显示的字段
- **筛选条件**：配置筛选条件
- **分组设置**：设置分组字段和聚合方式
- **排序设置**：设置排序字段和排序方式
- **计算公式**：配置计算字段和公式
- **显示格式**：设置字段的显示格式

#### 7.2.2 报表模板管理

**功能说明**：
- 支持保存报表配置为模板
- 支持分享报表模板给其他用户
- 支持从模板快速创建报表

#### 7.2.3 报表执行

**功能说明**：
- 根据配置执行报表查询
- 支持实时查询和历史数据查询
- 支持导出报表数据

#### 7.2.4 数据源结构化要求（关键设计原则）

**问题背景**：
- 结构化自定义报表的实现效果很大程度上依赖于数据源的结构化程度
- 如果数据源的model和事件表中记载的信息量不够结构化，会导致后续结构化应用不顺畅
- 需要在数据源设计阶段就考虑结构化报表的需求

**核心要求**：

**1. 数据源Model的结构化要求**：

- **字段标准化**：
  - 所有业务实体的字段必须有明确的类型定义（文本、数字、日期、枚举等）
  - 字段命名必须规范统一，避免同义异写（如"业务经理"和"负责人"）
  - 枚举值必须统一管理，通过"枚举与标签管理"提供，不得硬编码

- **字段完整性**：
  - 关键业务字段必须完整，不能缺失
  - 关联字段（如保值方案_id、业务经理_id）必须存在且可关联
  - 时间字段（创建时间、发生时间）必须完整记录

- **字段可查询性**：
  - 所有用于筛选、分组、排序的字段必须可索引
  - 关联字段必须支持JOIN查询
  - 计算字段必须明确计算公式，支持实时计算或预计算

- **自定义字段支持**：
  - 支持自定义字段的实体必须采用元数据表方式存储
  - 自定义字段值必须结构化存储，支持查询、筛选、分组
  - 自定义字段定义必须包含字段类型、是否必填、选项列表等元数据

**2. 事件表的结构化要求**：

- **事件类型标准化**：
  - 事件类型必须使用枚举值，不能使用自由文本
  - 事件类型定义必须完整，涵盖所有业务操作（创建、编辑、删除、点价、关联等）
  - 事件类型必须可查询、可筛选、可统计

- **变更内容结构化存储**：
  - **禁止使用JSON或文本字段存储变更内容**（不利于查询和统计）
  - 变更内容必须拆分为结构化字段：
    - 变更字段名（标准字段名）
    - 变更前值（按字段类型存储）
    - 变更后值（按字段类型存储）
    - 变更类型（新增/修改/删除）
  - 支持多字段变更记录（一条事件可记录多个字段的变更）

- **事件关联完整性**：
  - 事件必须关联到具体的业务实体（合同_id、指令_id等）
  - 事件必须记录操作人、操作时间、发生时间
  - 事件必须支持按业务实体、操作人、时间范围等维度查询

- **事件数据可追溯性**：
  - 支持通过事件表还原历史状态
  - 支持按时间点查询历史数据快照
  - 支持事件链追踪（如合同变更→指令变更→委托变更）

**3. 数据字典和元数据管理**：

- **数据字典定义**：
  - 为每个数据源建立完整的数据字典
  - 数据字典包含：字段名、字段类型、字段说明、是否必填、是否可查询、是否可筛选、是否可分组、是否可排序
  - 数据字典必须与数据库表结构保持一致

- **元数据管理**：
  - 建立统一的元数据管理机制
  - 元数据包括：数据源定义、字段定义、关联关系定义、计算公式定义
  - 元数据变更必须版本化管理，支持历史追溯

- **字段分类管理**：
  - 将字段分为：基础字段、关联字段、计算字段、自定义字段
  - 明确每类字段的查询、筛选、分组、排序能力
  - 自定义报表配置时，根据字段分类提供不同的操作选项

**4. 数据源关联关系结构化**：

- **关联关系明确化**：
  - 所有数据源之间的关联关系必须明确定义
  - 关联关系包括：一对一、一对多、多对多
  - 关联字段必须可查询、可JOIN

- **关联查询支持**：
  - 支持跨数据源的关联查询（如合同→保值方案→期货账户）
  - 支持多级关联查询（如合同→期现关联→委托单→成交记录）
  - 关联查询性能必须可接受（通过索引优化）

**5. 实施建议**：

- **数据源设计阶段**：
  - 在设计数据源时，必须考虑结构化报表的需求
  - 字段设计必须规范，避免使用自由文本存储结构化信息
  - 事件表设计必须结构化，避免使用JSON或文本字段存储变更内容

- **事件记录实现**：
  - 实现事件记录时，必须将变更内容拆分为结构化字段
  - 建立事件类型枚举表，统一管理事件类型
  - 建立变更字段映射表，统一管理字段变更记录格式

- **元数据管理实现**：
  - 建立数据字典表，存储所有数据源的字段定义
  - 建立元数据管理界面，支持数据字典的维护和查询
  - 自定义报表配置时，从数据字典动态加载可用字段

- **性能优化**：
  - 为常用查询字段建立索引
  - 为事件表的关联字段建立索引
  - 对于大数据量的报表，考虑预计算或异步生成

**6. 与现有系统的兼容性**：

- **历史数据处理**：
  - 对于已存在的历史数据，需要评估结构化程度
  - 如果历史数据不够结构化，需要制定数据迁移或补全方案
  - 新功能必须严格按照结构化要求实现

- **渐进式改进**：
  - 优先保证核心数据源的结构化
  - 逐步完善事件表的结构化存储
  - 逐步建立和完善元数据管理体系

---

## 八、数据来源和相关计算公式

### 8.1 数据来源

#### 8.1.1 基础数据表

- **合同表**：合同基础信息
- **指令表**：指令基础信息
- **委托单表**：期货委托和成交信息
- **持仓表**：期货持仓信息
- **期现关联事件表**：期现关联记录
- **采销关联事件表**：采销关联记录
- **点价事件表**：点价记录
- **合同变更事件表**：合同变更记录（**必须结构化存储变更内容，详见7.2.4节**）
- **指令更新事件表**：指令更新记录（**必须结构化存储变更内容，详见7.2.4节**）
- **保值方案表**：保值方案配置
- **期货账户表**：期货账户信息
- **账户资金表**：账户资金信息
- **现货价格表**：现货价格数据

**数据源结构化要求**：
- 所有数据源必须符合结构化要求（详见7.2.4节）
- 事件表必须结构化存储变更内容，不能使用JSON或文本字段
- 所有字段必须有明确的类型定义和可查询性定义

#### 8.1.2 配置数据

- **敞口系数配置**：从保值方案配置中获取
- **交易日历**：从全局设置中获取
- **枚举和标签**：从全局设置中获取

### 8.2 计算公式

#### 8.2.1 敞口计算

**现货敞口**：
- 现货敞口 = 合同数量 - 已点数量 - 已销售数量（采购合同）或 - 已采购数量（销售合同）

**期货敞口**：
- 期货敞口 = SUM(期现关联记录中的期货数量 × 敞口系数)

**敞口覆盖率**：
- 敞口覆盖率 = 期货敞口 / 现货敞口（如果现货敞口 > 0）

#### 8.2.2 盈亏计算

**期货浮动盈亏**：
- 浮动盈亏 = (最新价 - 开仓均价) × 持仓手数 × 合约乘数 × 持仓方向系数
- 持仓方向系数：多头为1，空头为-1

**期货平仓盈亏**：
- 平仓盈亏 = (平仓价 - 开仓价) × 平仓手数 × 合约乘数 × 持仓方向系数

**净盈亏**：
- 净盈亏 = 平仓盈亏 - 手续费

#### 8.2.3 交收计算

**应交收数量**：
- 应交收数量 = 合同数量

**实际交收数量**：
- 实际交收数量 = SUM(交收记录中的交收数量)

**交收完成率**：
- 交收完成率 = 实际交收数量 / 应交收数量

#### 8.2.4 指令完成率

**指令完成率**：
- 指令完成率 = 已完成指令数量 / 认领指令数量

**匹配完成率**：
- 匹配完成率 = 已匹配数量 / 所需数量

---

## 九、界面功能描述

### 9.1 报表列表页

#### 9.1.1 页面布局

- **顶部筛选区**：提供筛选条件输入
- **工具栏**：提供刷新、导出、列配置等操作按钮
- **表格区域**：显示报表数据
- **分页组件**：支持分页显示

#### 9.1.2 筛选功能

- 支持多条件组合筛选
- 支持日期范围选择
- 支持模糊搜索
- 支持多选下拉
- 支持保存筛选条件为快捷方式

#### 9.1.3 表格功能

- **列配置**：支持自定义显示列、调整列顺序和宽度
- **排序**：支持按列排序
- **分页**：默认每页10条，支持10/20/50/100四档可选
- **导出**：支持导出Excel、CSV等格式
- **数据下钻**：支持点击数据下钻查看明细

#### 9.1.4 图表展示

- 部分报表支持图表展示（如趋势图、饼图、柱状图等）
- 支持图表与表格切换显示
- 支持图表数据下钻

### 9.2 报表详情页

#### 9.2.1 详情展示

- 显示报表的详细数据
- 支持查看关联数据
- 支持查看历史记录

#### 9.2.2 数据下钻

- 支持多级下钻
- 支持从汇总数据下钻到明细数据
- 支持从明细数据跳转到相关业务页面

### 9.3 自定义报表配置页

#### 9.3.1 配置界面

- 提供可视化的报表配置界面
- 支持拖拽式配置
- 支持实时预览

#### 9.3.2 配置项

- 数据源选择
- 字段选择
- 筛选条件配置
- 分组和聚合配置
- 排序配置
- 计算公式配置
- 显示格式配置

---

## 十、数据一致性和数据约束

### 10.1 数据一致性

#### 10.1.1 实时性要求

- **实时报表**：数据实时更新，延迟不超过5分钟
- **逐日表**：每日收盘后更新
- **期末表**：期末时点更新
- **历史完整表**：支持查询历史任意时点数据

#### 10.1.2 数据准确性

- 报表数据必须与业务数据保持一致
- 计算字段必须使用统一的计算公式
- 汇总数据必须与明细数据一致

#### 10.1.3 数据完整性

- 报表必须包含所有符合筛选条件的数据
- 不得遗漏或重复计算数据
- 缺失数据应明确标识

### 10.2 数据约束

#### 10.2.1 权限约束

- 用户只能查看有权限访问的数据
- 按角色和权限过滤数据
- 敏感数据需要特殊权限

#### 10.2.2 性能约束

- 报表查询响应时间不超过10秒
- 大数据量报表支持异步生成
- 支持数据缓存和预计算

#### 10.2.3 导出约束

- 导出数据量限制（如单次最多导出10万条）
- 导出格式限制（Excel、CSV等）
- 导出权限控制

---

## 十一、其他补充

### 11.1 报表权限

#### 11.1.1 查看权限

- 不同角色可查看不同范围的报表
- 业务经理可查看自己负责的合同报表
- 交易员可查看自己认领的指令报表
- 风控人员可查看所有报表

#### 11.1.2 导出权限

- 导出功能需要特殊权限
- 敏感数据导出需要审批

### 11.2 报表性能优化

#### 11.2.1 数据预计算

- 对于常用的汇总报表，支持预计算
- 定期更新预计算结果
- 减少实时计算压力

#### 11.2.2 数据缓存

- 缓存常用的报表数据
- 缓存有效期根据数据更新频率设置
- 数据更新时主动刷新缓存

#### 11.2.3 异步生成

- 大数据量报表支持异步生成
- 生成完成后通知用户
- 支持下载生成的报表文件

### 11.3 报表扩展

#### 11.3.1 自定义字段支持

- 报表支持显示自定义字段
- 支持按自定义字段筛选
- 支持按自定义字段分组统计

#### 11.3.2 报表模板

- 支持保存报表配置为模板
- 支持从模板快速创建报表
- 支持分享报表模板

### 11.4 与风控模块的联动

#### 11.4.1 数据共享

- 报表数据可用于风控分析
- 风控告警可跳转到相关报表
- 报表可显示风控指标

#### 11.4.2 功能互补

- 报表提供数据查询和分析功能
- 风控提供告警和阻止功能
- 两者互补，共同支持风险管理

---

## 十二、版本历史

### V1.0（2024-01-XX）

**初始版本**

- ✅ 完成报表模块的整体架构设计
- ✅ 完成合同报表、指令报表、匹配报表、交易报表、综合报表的功能设计
- ✅ 完成自定义报表的基础功能设计
- ✅ 明确数据来源和计算公式
- ✅ 明确界面功能和交互设计
- ✅ 明确数据一致性和约束条件
- ✅ **新增：数据源结构化要求（7.2.4节）**：基于实际项目经验，补充了数据源结构化的关键设计原则，包括数据源Model的结构化要求、事件表的结构化要求、数据字典和元数据管理、数据源关联关系结构化等，确保结构化自定义报表的实现效果

**主要功能**：
1. 合同报表：均价合同今日净值预估、查看合同与期货的关系、查看采销合同的关系、合同事件流水查询、合同敞口分列与合计、按业务负责人的合同的应交收和实际交收
2. 指令报表：在途指令、历史指令、按交易员认领的指令的完成情况和敞口、指令更新记录
3. 匹配报表：期现关联记录、采销关联记录
4. 交易报表：期货账户信息一览、按交易员的投机交易记录和盈亏报表
5. 综合报表：保值方案信息一览、合同套期关系一览表
6. 自定义报表：结构化报表配置、报表模板管理、报表执行

**文档状态**：✅ 已定稿，可用于开发实施

---

## 附录：参考信息

### 相关文档

- 合同宝产品方案
- 指令宝产品方案
- 匹配宝与委托备注产品方案
- 交易宝产品方案
- 风控宝产品方案
- 全局设置产品方案

### 相关概念

- **敞口**：指未对冲的风险暴露，包括现货敞口和期货敞口
- **套保**：套期保值，通过期货交易对冲现货风险
- **期现关联**：期货与现货的关联关系
- **采销关联**：采购合同与销售合同的关联关系
- **净值**：资产净值，用于均价合同的估值
- **交收**：现货的交割和交付

---

本方案作为系统报表模块的完整产品说明，开发人员应严格按照本方案实现功能，确保报表数据的准确性、一致性和完整性。

