# V1版系统设计决策与问题澄清

本文档整合了V1版系统的关键设计决策、问题澄清和规则说明，供后续开发和维护参考。

---

## 目录

1. [指令宝设计决策](#一-指令宝设计决策)
2. [设计问题澄清清单](#二-设计问题澄清清单)
   - [第一轮问题澄清](#第一轮问题澄清)
   - [第二轮问题澄清](#第二轮问题澄清)
3. [禁用启用规则说明](#三-禁用启用规则说明)

---

## 一、指令宝设计决策

### 1. 角色界面与指令权限模型

**问题描述**：权限设计为"以人员为粒度、在保值方案上授予"，但界面入口完全由角色决定，可能导致授权了但无法操作的情况。

**设计决策**：**已做文档修正**。系统已统一权限模型与界面入口的映射关系，确保授权与操作的一致性。

**参考文档**：
- `6_0指令的问题讨论增补3.md` - 指令鉴权部分
- `6_4_0工作台界面特性.md` - 工作台显示逻辑

---

### 2. 父子指令与交易日切换规则

**问题描述**：父子指令关系判断规则和交易日切换时间点不够明确，可能产生异常情况。

**设计决策**：**交易日切换规则已明确**：
- **主要规则**：交易日变更定位为**非中金所的交易所全部收盘**
- **备选规则**：15:00作为交易日切换的确切时间（适用于大多数商品期货客户）
- **特殊情况**：节假日前会直接日切到下一个交易日

**说明**：
- 收盘最晚的是中金所的15:15
- 大多数客户都是商品期货，可以暂时定义非中金所的交易所收盘
- 父子指令关系判断：交易日一致 + 合同一致或保值方案一致

**参考文档**：
- `6_0指令的问题讨论增补2.md` (93-96行)

---

### 3. 撤销流程与指令完成的手工操作

**问题描述**：撤销流程要求人工反冲但缺少系统约束；指令完成完全靠手工点击，缺乏与交易系统的核对。

**设计决策**：**当前设计为保留系统用例兼容性**。

**设计理由**：
- 只要还存在交易员，就无法知道交易员为指令是否已做交易
- 实际业务中存在多种复杂场景：
  - **多指令合并交易**：交易员可能将多个指令合并执行
  - **规则允许的刻意留敞口**：交易员根据行情判断，可能故意不完全执行
  - **线下沟通先交易后指令**：存在先交易、后补指令的业务流程

**系统设计原则**：
- 保留人工操作入口，确保系统能兼容各种实际业务场景
- 不强制系统自动校验，避免因业务灵活性不足导致系统无法使用
- 通过流程规范和权限控制来约束操作，而非系统硬性限制

**参考文档**：
- `6_4_0工作台界面特性.md` - 指令撤销流程
- `6_4_2交易员指令发起.md` - 交易员操作流程

---

### 4. 客商指令校验性能问题

**问题描述**：客商指令权限校验需要"结合保值方案中的历史交易记录核算持仓"，可能在高频场景下性能不足。

**设计决策**：**采用先校验和排队机制，牺牲部分效率，确保不会越界交易**。

**设计理由**：
- **安全性优先**：客商指令涉及外部用户操作，必须确保不会越界交易
- **排队机制**：通过排队避免并发校验冲突，保证数据一致性
- **先校验后执行**：在指令发起前完成完整校验，而非边执行边校验

**性能权衡**：
- 接受一定的响应延迟，换取数据准确性和交易安全性
- 后续可通过缓存、快照等机制优化，但核心原则不变

**参考文档**：
- `6_0指令的问题讨论增补3.md` - 客商指令鉴权
- `6_1_2客商指令权限设置.md` - 客商指令权限配置

---

### 5. 其他设计说明

#### 虚拟期货成交
- 支持场景：跨保值方案、同保值方案的两个单单指令
- 规则：合约相同、方向相反、价格一致、数量一致
- 用途：处理交易员主观判断无需实际交易的情况，保证绩效核算准确性

#### 指令状态管理
- 指令状态包括：完成/撤销待处理/待完成
- 子指令可随时完成，父指令需在交易日收盘后完成
- 状态更新依赖人工确认，保证业务灵活性

#### 指令类型与保值方案匹配策略
- 整体匹配：保值方案净值套保指令、保值方案均价净值套保指令
- 单单匹配：非均价合同套保指令、均价合同套保指令、点价指令
- 支持整体和单单在不同保值方案中混用

---

## 二、设计问题澄清清单

### 0. 界面方案

#### Q0.1 菜单结构关系 ✅ 已解决
**问题**：界面方案中，页面顶端菜单有"指令发起页"和"待办流程"，但指令宝的二级菜单中也有"指令管理"。这两者的关系和区别是什么？

**回答**：已修正。界面方案是先写的，指令方案是后写的。在指令方案中修正了不合理设计，已同步回界面方案。
- "指令发起页"和"待办流程"已在界面方案中删除
- 指令宝的二级菜单已更新为：指令设置、各岗位的指令工作台、报表

**参考文档**：
- ```26:29:3_V1版系统实现步骤/0_界面方案/0_界面方案.md
            指令宝
                指令设置
                各岗位的指令工作台
                报表
```

**说明**：各岗位人员通过"各岗位的指令工作台"进入对应的指令功能，工作台根据角色显示。

#### Q0.2 Tab状态存档 ✅ 已解决
**问题**：tab状态按hedge_user存档，但切换tab时会刷新内容。存档的具体内容是什么？

**回答**：已增补，存档包含筛选条件和排序列。

**参考文档**：
- ```67:68:3_V1版系统实现步骤/0_界面方案/0_界面方案.md
        页面tab状态需要在服务中按hedge_user存档，存档包含删选
```
- ```80:81:3_V1版系统实现步骤/0_界面方案/0_界面方案.md
            表格列可以自定义是否显示、位置、列宽，宽度也可以在界面上拖拽，在服务中按hedge_user存档，存档包含排序列
```

---

### 1. 现货品种配置

#### Q1.1 期货品种与敞口系数的对应关系 ✅ 已解决
**问题**：品牌表格中"期货品种：这个会有多个"和"敞口系数：这个会有多个"。
- 一个品牌可以对应多个期货品种，那敞口系数是每个期货品种对应一个吗？
- 还是品牌级别的敞口系数，所有期货品种共用？
- 如果是每个期货品种一个敞口系数，在界面上如何展示和编辑？

**回答**：多个期货品种的敞口一定是多个。目前品级或者叫牌号还没有涉及到，只到品牌对应的期货品种和敞口系数。需要在表中做类似合并单元格的展示和编辑。

#### Q1.2 价格更新机制 ✅ 已解决
**问题**："已有同日期的价格或升贴水，提醒后确认可更新"。
- 如果同一天有多次价格更新，是覆盖还是保留历史记录？
- "提醒后确认可更新"的具体交互流程是什么？
- 历史价格查询中，同一天的多条记录如何显示？

**回答**：覆盖，每天一个记录；红字提示；五多条（历史价格查询中同一天的多条记录显示）。

#### Q1.3 平台价字段 ✅ 已解决
**问题**：筛选和表格列中有"是否平台"字段，但增加编辑接口中没有这个字段。
- 这个字段是否需要支持编辑？
- "平台价"与"主港价格"的关系是什么？

**回答**：已增补；平台价只有绝对价格是有意义的。可以做接口限制；不支持在是否平台价间编辑切换。主港和非主港的编辑切换要支持。平台价的不支持主港选项，主港的是否都不支持平台价。

---

### 2. 客商配置

#### Q2.1 客商类型命名歧义 ✅ 已解决
**问题**：客商类型默认分类包括"供应商、客户、仓库、物流、撮合商、客商"，但客商类型本身也叫"客商"。
- 这是否有命名歧义？
- "客商"类型与其他类型（供应商、客户）的区别是什么？

**回答**：无歧义。

#### Q2.2 客商唯一性判断 ✅ 已解决
**问题**："已有重复简称或者全称的客商，不能增加"。
- 简称和全称是分别唯一（简称唯一且全称唯一），还是组合唯一（简称+全称组合唯一）？
- 如果简称可以重复，全称必须唯一，那如何判断"重复"？

**回答**：分别唯一（简称唯一且全称唯一）。

---

### 3. 保值方案管理

#### Q3.1 保值方案类型与指令类型的对应关系 ✅ 已解决
**问题**：保值方案类型包括"无合同（人员）"和"无合同（客商）"，但指令类型列表中很多都是针对合同的。
- "无合同（人员）"类型的保值方案，可以发起哪些指令类型？
- "无合同（客商）"类型的保值方案，可以发起哪些指令类型？
- 是否所有指令类型都可以在"整体匹配/单单匹配"类型的保值方案中使用？

**回答**：已在保值方案管理中补充。

**参考文档**：
- ```28:28:3_V1版系统实现步骤/1_现货品种配置&客商配置&保值方案/1_3保值方案管理/1_3_1保值方案管理.md
                    做期货交易：**期货交易指令**；整体/单单/无合同（人员）/无合同（客商）
```

#### Q3.2 交易员列表的作用 ✅ 已解决
**问题**：保值方案中有"交易员列表"字段，但根据V1版系统总述增补1，保值方案与交易员绑定，交易员与期货账户绑定。

**回答**：已修复。在保值方案中列出所有拥有交易员角色的人员，对一个保值方案附加一个或多个交易员。

**参考文档**：
- ```93:95:1_按子产品描述SaaS版/全局设置.md
    交易员与保值方案
        在保值方案中列出所有拥有交易员角色的人员
        对一个保值方案附加一个或多个交易员
```

#### Q3.3 指令类型的多选逻辑 ✅ 已解决
**问题**：保值方案中"指令类型：可多选"，但不同指令类型支持的匹配策略不同。
- 如果一个保值方案选择了"整体匹配"类型，但指令类型列表中包含了"单单匹配"的指令类型，如何处理？
- 系统是否需要校验指令类型与保值方案类型的匹配关系？

**回答**：整体的保值方案中不能选单单类型的指令。系统需要校验指令类型与保值方案类型的匹配关系。

---

### 4. 人员管理

#### Q4.1 人员角色显示 ✅ 已解决
**问题**：人员管理表格列显示"角色：来自人员角色管理"，但人员角色管理是另一个三级菜单。

**回答**：直接把关联的角色jsonlist内容显示在单元格中。

#### Q4.2 人员删除判断逻辑 ✅ 已解决
**问题**："有保值方案绑定的人员不能删除"，但保值方案中交易员列表是json_list，可能有多个人。
- 这个判断是指"人员在任何保值方案的交易员列表中"就不能删除吗？
- 还是指"人员是某个保值方案的唯一交易员"时不能删除？
- 如果人员从所有保值方案中移除，是否就可以删除？

**回答**：是any（人员在任何保值方案的交易员列表中就不能删除）。从保值方案中移除后可以删除。

#### Q4.3 人员与角色的关系 ✅ 已解决
**问题**：人员管理中说"对人员附加一个或多个角色属性"，但人员角色管理中说"一类角色只能增加一行"。
- 这是否意味着一个角色只能绑定一组人员？
- 如果人员很多，需要分批绑定，如何处理？
- 还是说"一类角色只能增加一行"是指一个角色在系统中只能有一条配置记录？

**回答**：一个角色绑一组人员。

---

### 5. 人员角色管理

#### Q5.1 接口字段错误 ✅ 已解决
**问题**：禁用删除启用接口中写的是"保值方案_id"，但这是人员角色管理模块。
- 这应该是"人员角色关系_id"或类似的字段名吧？
- 还是说这个接口设计有误？

**回答**：已修正（刚才忘记存档）。

#### Q5.2 角色绑定限制 ✅ 已解决
**问题**："一类角色只能增加一行"。
- 这个限制的具体含义是什么？
- 是指一个角色只能绑定一组人员，还是指一个角色在系统中只能有一条配置？
- 如果需要给角色添加更多人员，是修改现有记录还是创建新记录？

**回答**：一个角色绑一组人员（与Q4.3一致）。

---

### 6. 期货账户管理

#### Q6.1 交易员模式含义 ✅ 已解决
**问题**："交易员模式：共用/独立"。
- "共用"是指多个交易员共享一个账户吗？
- "独立"是指每个交易员使用独立的子账户吗？
- 这个模式与"每个期货账户暂定只下分一个子账户"的关系是什么？

**回答**：这个概念已经不存在了，每个期货账户下一个子账户，所有交易员针对子账户交易授权，所以都是公用了。

#### Q6.2 交易员绑定解除 ✅ 已解决
**问题**："可以解除一个交易员的绑定，但是不会把交易员踢下来"。
- "踢下来"的具体含义是什么？
- 是指正在交易中的交易员不会被强制下线吗？
- 解除绑定后，该交易员还能继续交易吗？还是只是不能看到这个账户？

**回答**：系统提供web交易终端，如果禁用交易员某个子账户的交易权限，暂时不会强迫交易员掉线，可以在报单时由api判断是否给与通过。

#### Q6.3 子账户资金同步 ✅ 已解决
**问题**："子账户与后端账户资金每天一次的同步一致"。
- 这个同步是自动的还是手动的？
- 同步时间点是什么时候？
- 如果同步失败，如何处理？

**回答**：自动，zq结算后。

---

### 7. 合同管理

#### Q7.1 合同类型遗漏 ✅ 已解决
**问题**：合同创建接口中"计价方式：一口价/暂定价/均价"，但根据场景描述，还有"均基差"类型。
- 是否遗漏了"均基差"类型？
- 还是"均基差"属于"暂定价"的一种特殊情况？

**回答**：均基差暂时按暂定价合同处理。

#### Q7.2 期现关联的保值方案判断 ✅ 已解决
**问题**："期现关联会默认筛选合同相关的期货委托的保值方案、方向、品种"。

**回答**：
- 保值方案与合同绑定，则从合同发出的指令所匹配的期货成交也会被打上同保值方案。
- 保值方案同交易员绑定，交易员下单前必须选择期货账户，选择保值方案，才能下单。
- 如何判断"相关"：通过合同的保值方案字段，以及从合同发出的指令匹配的期货成交。

#### Q7.3 点价功能与指令的关系 ✅ 已解决
**问题**：合同管理中有"点价"按钮，可以直接选择期货委托进行点价。

**回答**：
- 合同管理中的直接点价按钮：用于线下交流后，先做了期货，后在系统中补充点价操作步骤。
- 指令中的点价：规范化的操作流程。
- 两者场景不一致，是两种不同的使用方式。

#### Q7.4 采销关联的保值方案一致性 ✅ 已解决
**问题**："采销关联会默认筛选合同相关的现货品种、品牌、方向（理论上保值方案也应该一致，没想完整）"。
- 采销关联时，是否强制要求保值方案一致？
- 如果不一致，是否允许关联？如果允许，后续如何处理？

**回答**：暂时强制保值方案一致。

---

### 8. 指令权限设置

#### Q8.1 权限设置界面与设计决策的一致性 ✅ 已解决
**问题**：人员指令权限设置中"指令创建人：multy_selectbox；先选择角色，再勾选角色下的人员"。
- 但根据设计决策注解，权限是以人员为粒度的。
- 这里先选角色再选人员，是否与设计决策一致？
- 还是说这只是界面交互方式，实际存储还是以人员为粒度？

**回答**：界面交互方式，实际存储还是以人员为粒度。

#### Q8.2 交易员字段的不一致性 ✅ 已解决
**问题**：人员指令权限设置中："交易员id：json_list；人员_id"（多个），客商指令权限设置中："交易员id：人员_id"（单个）。

**回答**：已更正，客商指令权限设置中的交易员字段改为json_list（多个）。

**参考文档**：
- ```28:34:3_V1版系统实现步骤/6_指令宝/6_1指令权限设置/6_1_2客商指令权限设置.md
    创建修改客商指令权限接口：
        客商指令权限id：客商指令权限_id
        指令创建人：json_list；客商_id
        指令类型id：指令类型_id
        保值方案id：保值方案_id
        交易员id：json_list；人员_id
        有效期：date（含）
```

#### Q8.3 均价自动指令的发起人 ✅ 已解决
**问题**：均价自动指令启停中"指令发起人：json_list；人员_id"。
- 但自动发起时，发起人应该是系统，这里的人员_id是什么含义？
- 是指"通知对象"还是"责任人"？
- 还是说自动发起的指令，发起人字段填写的是配置中的人员？

**回答**：发起人改成系统管理员_id。

**参考文档**：
- ```12:12:3_V1版系统实现步骤/6_指令宝/6_1指令权限设置/6_1_3均价自动指令启停.md
        指令发起人：系统管理员_id
```

#### Q8.4 制单员字段的作用 ✅ 已解决
**问题**：人员指令权限设置中有"制单员id：json_list；人员_id"字段。
- 这个字段的作用是什么？
- 是指定可以认领合同创建指令的制单员吗？
- 如果为空，是否所有制单员都可以认领？

**回答**：是指定可以认领合同创建指令的制单员。如果为空，所有制单员都可以认领，交易员同理。

---

### 9. 跨模块问题

#### Q9.1 保值方案与交易员的绑定关系 ✅ 已解决
**问题**：根据V1版系统总述增补1，保值方案与交易员绑定，但保值方案管理中有"交易员列表"字段，人员管理中又说"交易员与保值方案"可以附加一个或多个保值方案。

**回答**：已修复。在保值方案中列出所有拥有交易员角色的人员，对一个保值方案附加一个或多个交易员。

**参考文档**：
- ```93:95:1_按子产品描述SaaS版/全局设置.md
    交易员与保值方案
        在保值方案中列出所有拥有交易员角色的人员
        对一个保值方案附加一个或多个交易员
```

#### Q9.2 指令类型与保值方案的匹配策略 ✅ 已解决
**问题**：不同指令类型支持的匹配策略不同（整体/单单），但保值方案也有匹配策略类型。

**回答**：指令是分为单单和整体类型的，在保值方案管理中有明确提及。

**参考文档**：
- ```24:38:3_V1版系统实现步骤/1_现货品种配置&客商配置&保值方案/1_3保值方案管理/1_3_1保值方案管理.md
            指令类型：可多选
                单独指令 or 父指令
                    做期货交易：**期货交易指令**；整体/单单
                    合同创建：**合同创建指令**；整体/单单
                    做期货交易，然后将期货交易作为合同创建的信息量：**一口价创建套保指令**；整体/单单
                    为保值方案做期货移仓换月：**保值方案移仓换月指令**；整体/单单
                    为保值方案提供套保：**保值方案净值套保指令**；整体
                    为保值方案提供均价套保：**保值方案均价净值套保指令**；整体
                    为合同提供套保：**非均价合同套保指令**；单单
                    为合同提供均价套保：**均价合同套保指令**；单单
                    为合同提供点价：**点价指令**；单单
                    自定义指令：**XX指令**；单单
                单独指令 or 子指令
                    非均价合同变更：**非均价合同变更指令**；单单
                    均价合同变更：**均价合同变更指令**；单单
```

#### Q9.3 禁用/启用状态的级联 ✅ 已解决
**问题**：期货账户禁用，下级保值方案都禁用；保值方案禁用，相关合同、指令如何处理；人员禁用，相关指令权限如何处理。

**回答**：详见[禁用启用规则说明](#三-禁用启用规则说明)

**参考文档**：
- ```1:3:3_V1版系统实现步骤/2_合同宝/2_0合同讨论信息补充.md
系统引入：禁用、启用、删除概念
    禁用会继续在界面显示，但是禁止在其他界面引用。比如禁用的客商，不能在创建合同时引用
    删除会在界面中不显示，在数据库中标识未delete，标准界面流程中不能更改delet标志
```

---

### 第二轮问题澄清

#### Q10.1 合同创建接口字段不完整 ✅ 已解决
**问题**：合同创建修改接口中，字段定义不完整。

**回答**：已修正。必填和option作为todo，在整个文档成型后补充。

---

#### Q10.2 合同筛选条件缺失 ✅ 已说明
**问题**：合同管理表格的筛选条件标记为"todo"，没有具体定义。

**回答**：所有筛选项现在都是todo，在整个文档成型后补充。

---

#### Q10.3 合同报表功能未完成 ✅ 已说明
**问题**：合同报表文档只有目录结构，具体实现未定义。

**回答**：所有报表都是todo，在整个文档成型后补充。

---

#### Q10.4 指令报表功能缺失 ✅ 已说明
**问题**：在途指令和历史指令报表只有目录路径，没有具体实现。

**回答**：所有报表都是todo，在整个文档成型后补充。

---

#### Q10.5 指令员工作台"所有指令"的权限范围 ✅ 已解决
**问题**：指令员工作台中有"所有指令（包含均价指令自动发起、变更、新增导致的指令变化）"。

**回答**：指系统中的所有指令，原则上无需在人员指令权限中对其做设置。

**参考文档**：
- ```5:38:3_V1版系统实现步骤/6_指令宝/6_4各岗位工作台的指令界面/6_4_3指令员指令发起.md
    左侧一个树结构，根目录是指令员工作台，一级目录包括，我发起的指令、所有指令（包含均价指令自动发起、变更、新增导致的指令变化）
```

---

#### Q10.6 制单员认领接口字段错误 ✅ 已解决
**问题**：制单员工作台中，认领/取消认领接口的字段名写的是"交易员id"，应该是"制单员id"。

**回答**：已修正。

**参考文档**：
- ```23:25:3_V1版系统实现步骤/6_指令宝/6_4各岗位工作台的指令界面/6_4_5制单员创建合同.md
        认领/取消认领接口
            指令id：指令_id
            制单员id：人员_id
```

---

#### Q10.7 指令匹配接口的完整性 ✅ 已解决
**问题**：交易员工作台和制单员工作台中都有"匹配"接口，但接口参数不完整。

**回答**：
- 这是底层概念问题。只有暂定价合同点价时需要指定合同这一批点价的数量，因为会涉及到合同价格、金额。这里的合同数量可以在点价指令界面中作为选填值，缺省值是按照敞口比例算出来的。
- 交易员发出的指令，一般只有纯期货交易的指令，在这里不涉及到合同数量。
- 制单员接口已修正，增加了合同数量字段。

**参考文档**：
- ```47:50:3_V1版系统实现步骤/6_指令宝/6_4各岗位工作台的指令界面/6_4_5制单员创建合同.md
        匹配接口
            指令id：指令_id
            合同id：合同_id
            合同数量：decimal
```

---

#### Q10.8 指令状态流转的完整性 ✅ 已解决
**问题**：指令状态包括多个维度（交易状态、合同状态、撤销处理、指令状态、认领状态），但状态流转规则不明确。

**回答**：
- 当指令的所有子任务完成时，指令可以人工点完成。
- 撤销如果是待处理，指令不能点完成。
- null不影响指令完成。

**参考文档**：
- ```22:31:3_V1版系统实现步骤/6_指令宝/6_4各岗位工作台的指令界面/6_4_0工作台界面特性.md
指令的状态
    点开的详细状态
        交易状态：待完成/完成/null
        合同状态：待完成/完成/null
        撤销处理：待处理/已同意/已拒绝/null
        指令状态：完成/待完成
        交易认领：完成/待完成/null
        合同创建认领：完成/待完成/null
    表格单元格的状态显示
        完成/撤销待处理/待完成
```

---

#### Q10.9 人员角色管理接口字段错误 ✅ 已解决
**问题**：人员角色管理的禁用删除启用接口中，字段名写的是"保值方案_id"，应该是"人员角色关系_id"。

**回答**：已修正。

**参考文档**：
- ```23:25:3_V1版系统实现步骤/1_现货品种配置&客商配置&保值方案/1_4人员管理/1_4_2人员角色管理.md
        禁用删除启用接口(禁用后一类相关角色都不能操作)
            角色人员关系id：int；角色人员关系_id
            status：enable/disable/delete
```

---

#### Q10.10 保值方案筛选条件缺失 ✅ 已说明
**问题**：保值方案管理表格的筛选条件为空，没有定义。

**回答**：所有筛选项现在都是todo，在整个文档成型后补充。

---

#### Q10.11 期货品种与敞口系数的数据结构 ✅ 已解决
**问题**：品牌表格中"期货品种：这个会有多个"和"敞口系数：这个会有多个"，但增加编辑接口中只定义了单个。

**回答**：已修正。期货品种和敞口系数都改为jsonlist，敞口系数是期货品种的关联。

**参考文档**：
- ```36:37:3_V1版系统实现步骤/1_现货品种配置&客商配置&保值方案/1_1现货品种配置/1_1_1现货品种管理.md
            期货品种：jsonlist;期货品种_id
            敞口系数：jsonlist；是期货品种的关联
```

---

#### Q10.12 指令认领的权限控制 ✅ 已解决
**问题**：交易员可以认领指令，制单员可以认领合同创建指令，但认领的权限控制不明确。

**回答**：
- 交易员只能认领交易指令，制单员可以认领合同创建指令。
- 认领范围受交易员与保值方案范围控制。
- 在保值方案管理中已补充制单员与保值范围。

**参考文档**：
- ```19:25:3_V1版系统实现步骤/1_现货品种配置&客商配置&保值方案/1_3保值方案管理/1_3_1保值方案管理.md
            交易员列表
            制单员列表
        增加编辑保值方案接口
            名称：str
            类型：整体匹配/单单匹配/无合同（人员）/无合同（客商）
            交易员列表：json_list;人员_id
            制单员列表：json_list;人员_id
```

---

#### Q10.13 指令完成的条件 ✅ 已解决
**问题**：指令完成的条件不明确。

**回答**：
- 所有步骤都完成且撤销已处理后可以完成指令。
- null不影响指令完成。
- 子指令必须完成后才能完成父指令。

**参考文档**：
- ```20:21:3_V1版系统实现步骤/6_指令宝/6_4各岗位工作台的指令界面/6_4_0工作台界面特性.md
指令应该谁点完成
    指令最后一个步骤的人点完成
```

---

#### Q10.14 均价自动指令的发起时机 ✅ 已解决
**问题**：均价自动指令启停中，自动发起的时机不明确。

**回答**：
- 自动发起时间应该是切换交易日后自动发起。
- 变更立即更新指令。
- 自动指令的发起人填系统管理员。

**参考文档**：
- ```19:21:3_V1版系统实现步骤/6_指令宝/6_1指令权限设置/6_1_3均价自动指令启停.md
    自动发起机制
        如果在本界面启动，则每日自动进行按保值方案或者按合同的均价指令发起
        默认禁止
```

---

#### Q10.15 期货账户的"类型"字段未定义 ✅ 已解决
**问题**：期货账户管理的筛选和表格列中有"类型"字段，但增加编辑接口中没有定义这个字段。

**回答**：已更正，上次没存档。

---

#### Q10.16 其他设置的匹配策略配置 ✅ 已说明
**问题**：其他设置中只有"指定采销/先进先出/指定采销+先进先出"，但保值方案管理中提到了"匹配策略预设"。

**回答**：其他设置暂时不要看，没写完。

---

#### Q10.17 价格录入的必填字段 ✅ 已说明
**问题**：录入价格接口中，升贴水和价格都是decimal类型，但没有说明是否必填。

**回答**：必填和选填是todo，最后再做。

---

## 三、禁用启用规则说明

### 基本概念

#### 禁用（Disable）
- **定义**：不能再调用，不再有权限，而不是删除
- **显示**：禁用会继续在界面显示，但是禁止在其他界面引用
- **示例**：禁用的客商，不能在创建合同时引用

#### 启用（Enable）
- **定义**：恢复调用权限，可以在其他界面引用
- **操作**：将禁用的人或字段再启用

#### 删除（Delete）
- **定义**：在界面中不显示，在数据库中标识为delete
- **限制**：标准界面流程中不能更改delete标志
- **区别**：删除是物理删除标记，禁用是逻辑禁用

**参考**：```1:3:3_V1版系统实现步骤/2_合同宝/2_0合同讨论信息补充.md
系统引入：禁用、启用、删除概念
    禁用会继续在界面显示，但是禁止在其他界面引用。比如禁用的客商，不能在创建合同时引用
    删除会在界面中不显示，在数据库中标识未delete，标准界面流程中不能更改delet标志
```

---

### 各模块禁用/启用规则

#### 1. 保值方案禁用

**影响范围**：
- ✅ **合同新增**：无法选择这个保值方案
- ✅ **期货下单**：不能选择这个保值方案
- ❌ **历史数据不受影响**：
  - 之前选择了这个保值方案的合同不受影响
  - 之前匹配的期货成交不受影响
  - 已创建的指令不受影响

**使用场景**：
- 某个保值方案暂时停用，但需要保留历史数据
- 新业务不再使用该保值方案，但已有业务继续运行

---

#### 2. 人员禁用

**影响范围**：
- ✅ **权限失效**：无法登录系统，无法进行相关操作
- ✅ **新操作受限**：不能发起新指令、不能认领新指令等
- ❌ **历史数据不受影响**：
  - 已发的指令不受影响
  - 已创建的合同不受影响
  - 历史操作记录保留

**使用场景**：
- 人员离职或暂时停用账号
- 需要保留该人员的历史操作记录和已发起的指令

---

#### 3. 期货账户禁用

**影响范围**：
- ✅ **交易受限**：该账户不能进行交易操作
- ❌ **保值方案不受影响**：
  - 根据V1版系统总述增补1，保值方案与期货账户没有绑定关系
  - 不存在"期货账户禁用→保值方案禁用"的级联关系
  - 保值方案可以继续使用其他期货账户

**使用场景**：
- 期货账户暂时停用或维护
- 需要切换期货账户，但保值方案继续使用

**参考**：```1:11:2_V1版系统总述/V1版系统总述增补1.md
前面定的保值方案一定绑期货子账户的方案有问题，如果两个保值方案分别只需要做买和卖，那么在两个子账户层面永远无法平仓。修改方案如下
    保值方案与交易员绑定
    交易员与期货账户绑定
    保值方案作为指令发出的主体，交易员决定用哪个期货账户做交易，交易自主权完全下放给交易员，承认无法以简单模型做场景通关。保值方案与期货账户没有绑定关系
    每个期货账户暂定只下分一个子账户，这个子账户可以同时由多个交易员下单，子账户的资金与期货账户资金同步。暂时不抛弃子账户概念，防止后续有场景护不住，还要启用
    如果要进行移仓换月，可以从保值方案发起指令。也可以用账户交易时，指定保值方案。是否支持先交易，后拆分到多个保值方案进行关联，这个问题暂时搁置

    上述解决方案导致以下结果：
        保值方案肯定没有持仓概念，也不能针对保值方案的持仓发起移仓换月
        保值方案与期货账户或者子账户概念完全脱钩
        子账户层面仍可以进行自动开平和移仓换月
```

---

#### 4. 客商禁用

**影响范围**：
- ✅ **合同新增**：不能在创建合同时引用
- ❌ **历史数据不受影响**：
  - 已有合同不受影响
  - 历史交易记录保留

**参考**：```1:3:3_V1版系统实现步骤/2_合同宝/2_0合同讨论信息补充.md
系统引入：禁用、启用、删除概念
    禁用会继续在界面显示，但是禁止在其他界面引用。比如禁用的客商，不能在创建合同时引用
```

---

#### 5. 现货品种/品牌禁用

**影响范围**：
- ✅ **合同新增**：不能在创建合同时引用
- ❌ **历史数据不受影响**：
  - 已有合同不受影响
  - 历史价格数据保留

---

### 级联规则总结

#### 不存在级联关系
1. **期货账户禁用 → 保值方案禁用** ❌
   - 原因：保值方案与期货账户没有绑定关系
   - 影响：保值方案可以继续使用其他期货账户

#### 存在级联影响（仅影响新操作）
1. **保值方案禁用 → 新合同无法选择** ✅
2. **保值方案禁用 → 新期货下单无法选择** ✅
3. **人员禁用 → 无法登录系统** ✅
4. **人员禁用 → 无法发起/认领新指令** ✅
5. **客商禁用 → 新合同无法引用** ✅

#### 不受影响（历史数据）
- 已创建的合同
- 已匹配的期货成交
- 已创建的指令
- 历史操作记录

---

### 设计原则

1. **禁用不影响历史数据**：已创建的数据和已执行的操作不受禁用影响
2. **禁用只影响新操作**：禁用后，相关的新增、引用、选择操作受限
3. **禁用可恢复**：通过启用操作可以恢复权限
4. **禁用与删除分离**：禁用是逻辑禁用，删除是物理删除标记

---

## 注意事项

1. **业务灵活性优先**：系统设计优先保证业务场景的兼容性，而非系统自动化程度
2. **人工确认机制**：关键操作保留人工确认，避免系统误判
3. **安全性保障**：外部用户操作（如客商指令）必须严格校验，性能可适当让步
4. **后续优化空间**：当前设计为V1版本，后续可通过技术手段优化性能，但核心设计原则不变

---

## 更新记录

- 2025-01-XX：初始版本，整合设计决策、问题澄清和规则说明
- 交易日切换规则：已更新为非中金所交易所收盘时间
- 菜单结构：已修正，删除"指令发起页"和"待办流程"
- 交易员字段：已统一为json_list
- 禁用启用规则：已明确各模块的禁用/启用影响范围
- 第二轮问题澄清：已整合新增问题澄清清单，补充了合同管理、指令宝、全局设置等模块的问题和解答
- 第三轮问题澄清：已完成所有待澄清问题的回答，包括现货品种配置、客商配置、保值方案管理、人员管理、期货账户管理、合同管理、指令权限设置等模块

