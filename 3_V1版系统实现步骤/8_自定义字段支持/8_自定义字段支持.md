# ERP系统自定义字段实现方案

## 版本功能范围

### V1版本功能（当前版本）

1. **自定义字段管理**：支持自定义字段的增删改操作
   - 创建自定义字段定义（字段名称、字段类型、是否必填、选项列表等）
   - 修改自定义字段定义
   - 删除自定义字段定义（软删除，保留历史数据）

**支持的字段类型**：
   - **文本类型（text）**：短文本输入，用于存储字符串信息
   - **长文本类型（textarea）**：多行文本输入，用于存储备注等长内容
   - **数字类型（number）**：数字输入，支持整数和小数
   - **日期类型（date）**：日期选择器，用于选择日期
   - **日期时间类型（datetime）**：日期时间选择器，用于选择日期和时间
   - **下拉选择类型（select）**：单选下拉框，从预定义的选项列表中选择一个值
   - **多选下拉类型（multiselect）**：多选下拉框，从预定义的选项列表中选择多个值
   - **布尔类型（boolean）**：是/否选择，用于存储布尔值

**下拉选择类型（select）配置说明**：
   - 字段类型选择为"下拉选择"或"多选下拉"时，需要配置选项列表
   - 选项列表可以手动输入，每行一个选项，格式为：`选项值|选项显示名称` 或直接输入选项名称（值默认为名称）
   - 例如：仓库选择可以配置为：
     ```
     仓库A|仓库A
     仓库B|仓库B
     仓库C|仓库C
     ```
   - 选项列表支持动态维护，可以在字段定义中随时添加、修改、删除选项
   - 单选下拉（select）：只能选择一个选项
   - 多选下拉（multiselect）：可以选择多个选项，值以数组形式存储

2. **自定义字段在表格中的应用**：
   - 在实体列表表格中显示自定义字段列
   - 支持自定义字段的列配置（显示/隐藏、列宽、排序）
   - 在实体编辑表单中编辑自定义字段值

3. **自定义字段在报表中的应用**：
   - 在报表查询结果中显示自定义字段
   - 支持按自定义字段进行筛选
   - 支持按自定义字段进行分组统计
   - 报表导出时包含自定义字段
   - 报表列配置支持自定义字段

### 后续版本功能（暂不实现）

1. **自定义字段公式计算**：支持公式字段类型，通过公式自动计算字段值
2. **报表字段公式**：在报表中支持公式字段，可以基于其他字段进行计算

## 一、自定义字段的实现方式

### 1. 元数据表方式（推荐）

这是最灵活和标准的方式，通过元数据表来定义和管理自定义字段。

需要创建两个核心表：自定义字段定义表和自定义字段值表。定义表用于存储每个实体类型的字段配置信息，包括字段编码、字段名称、字段类型、是否必填、排序等属性。值表用于存储每个实体实例的自定义字段值，通过实体类型和实体ID关联到具体的业务记录。

这种方式的优点是灵活性强，可以动态添加字段而无需修改表结构，所有实体的自定义字段统一管理，支持多种字段类型和配置。缺点是查询时需要JOIN操作，在大数据量时可能影响性能，复杂查询的WHERE条件需要特殊处理。

### 2. 扩展表方式

为每个需要自定义字段的主表创建对应的扩展表，在扩展表中预留多个通用字段用于存储自定义数据。

这种方式的优点是性能好，直接关联查询无需复杂JOIN，实现相对简单。缺点是不够灵活，字段数量有限制，每个表都需要维护对应的扩展表，增加维护成本。

### 3. JSON字段方式

在主表中直接使用JSON字段存储自定义字段，所有自定义字段的值统一存储在一个JSON字段中。

这种方式的优点是简单，无需额外表，可以存储任意结构的数据。缺点是JSON字段的查询和索引支持有限，数据验证需要在应用层完成，不利于复杂查询和统计分析。

## 二、哪些表需要支持自定义字段

### 核心业务实体（必须支持）

1. **客商表（customer）**
   - 行业特定属性，如所属行业、业务区域等
   - 业务分类标签，用于客商分类管理
   - 特殊备注信息，记录客商的特殊要求或注意事项

2. **合同表（contract）**
   - 合同特殊条款，记录合同中的特殊约定
   - 业务分类标签，用于合同分类和统计
   - 项目编号、订单号等外部关联信息
   - 合同来源渠道、业务类型等扩展属性
   - **可选仓库**：通过下拉选择类型（select）或多选下拉类型（multiselect）创建仓库选择字段，在合同创建和编辑时可以选择一个或多个仓库
     - 应用场景：合同需要指定交货仓库时，可以从预定义的仓库列表中选择
     - 实现方式：在自定义字段配置中为合同表创建"可选仓库"字段，类型选择为"下拉选择"或"多选下拉"，配置仓库选项列表
     - 显示位置：自定义字段会自动显示在合同创建和编辑的弹出表单中，位于标准字段之后

3. **现货品种表（spot_brand）**
   - 品种品牌属性扩展，如质量标准、产地要求、回收率、含铝量等
   - 行业分类，用于品种的分类管理
   - 特殊规格要求，记录品种的特殊属性
   - 注意：品种是一级分类，属性主要在品牌上，未来可能还有牌号层级，需要考虑层级继承关系

### 交易相关实体

4. **期现备注表（spot_futures_remark）**
   - 团队选择，用于标识期现备注所属的团队
   - 业务归属选择，用于标识期现备注的业务归属
   - 其他业务扩展属性
   - 注意：期现备注是委托单的附属信息，自定义字段应该关联到期现备注表，而不是匹配单表

5. **期货委托单表（entrust_order）**
   - 交易渠道标识，记录委托单的来源渠道
   - 特殊要求，记录委托单的特殊执行要求
   - 业务分类标签，用于委托单的分类管理
   - 注意：期现备注的自定义字段应该存储在期现备注表中，而不是委托单表

### 其他实体

7. **人员表（person/user）**
   - 职位信息，记录人员的职位、职级等
   - 岗位属性扩展，记录人员的特殊岗位属性
   - 业务分类标签，用于人员的业务分类
   - 特殊权限标识，记录人员的特殊权限要求

8. **期货账户表（futures_account）**
   - 账户属性扩展，记录账户的特殊属性
   - 风险等级标识，记录账户的风险等级
   - 业务分类标签，用于账户的分类管理

### 不需要自定义字段的实体

9. **保值方案表（hedge_plan）**
   - 保值方案本身就是分类维度，如果分类不够可以通过增加新的保值方案来解决
   - 标签功能已经为保值方案提供了下分的具体业务维度
   - 因此保值方案表不需要自定义字段支持

10. **交易指令表（instruction）**
    - 指令类型是适应不同客户需求的主要途径，为不同客户增加指令类型是主要的服务手段
    - 指令上的备注已经承担了多次信息传递的责任
    - 自定义字段在指令上的应用场景不明确，暂不建议支持

## 三、自定义字段在报表中的应用

### 1. 报表查询时动态加载自定义字段

在报表查询时，系统需要根据当前实体的自定义字段定义，动态地将自定义字段值关联到查询结果中。查询时需要先获取该实体的所有启用的自定义字段定义，然后在查询SQL中通过LEFT JOIN的方式将自定义字段值表关联到主表，使用CASE WHEN语句将不同字段的值转换为对应的列。对于自定义字段的筛选条件，需要在WHERE子句中使用EXISTS子查询来过滤符合条件的记录。

### 2. 报表导出时包含自定义字段

在导出报表时，系统需要将自定义字段作为额外的列包含在导出文件中。导出时需要先获取当前实体的自定义字段定义，然后在导出文件的表头中添加自定义字段的列名，在数据行中填充对应的自定义字段值。用户可以在导出前选择要包含哪些自定义字段，系统根据用户的选择动态生成导出文件。

### 3. 报表筛选器支持自定义字段

报表的筛选器需要支持按自定义字段进行筛选。系统需要根据实体的自定义字段定义，动态生成对应的筛选器控件。对于文本类型的字段，提供文本输入框；对于数字类型的字段，提供数字输入框或范围选择器；对于日期类型的字段，提供日期选择器；对于下拉选择类型的字段，提供下拉选择框，选项来源于字段配置中的选项列表。筛选器应该支持多种操作符，如等于、不等于、包含、大于、小于等。

### 4. 报表统计时使用自定义字段分组

在报表统计功能中，可以按自定义字段进行分组统计。例如，可以按合同的自定义业务分类字段进行分组，统计每个分类下的合同数量和金额。系统需要支持在统计查询中按自定义字段分组，并能够对分组结果进行聚合计算，如计数、求和、平均值等。

### 5. 报表列配置支持自定义字段

用户可以在报表的列配置功能中选择显示哪些自定义字段。系统需要提供列配置界面，列出所有可用的自定义字段，用户可以选择显示或隐藏这些字段，并可以调整字段的显示顺序和列宽。配置信息需要保存到用户的个人设置中，下次打开报表时自动应用。

## 四、实现建议

### 1. 前端实现

**字段配置界面**：在全局设置中提供自定义字段配置界面，作为全局设置的二级菜单项。管理员可以为每个实体类型配置自定义字段。配置界面需要支持字段的增删改操作，可以设置字段名称、字段类型、是否必填、默认值、选项列表等属性。

**界面位置**：
- 一级菜单：全局设置
- 二级菜单：自定义字段配置（与其他全局设置项并列，如现货品种与价格、客商管理、保值方案管理等）

**界面结构**：
- 左侧：实体类型列表（客商、合同、现货品种、期现备注、期货委托单、人员、期货账户等）
- 右侧：选中实体类型的自定义字段列表，支持增删改操作

**字段编辑界面**：在实体的编辑表单中（包括创建和编辑弹出页），需要根据该实体的自定义字段定义动态渲染对应的表单控件。系统需要根据字段类型渲染不同的控件：
   - 文本类型：渲染文本输入框（Input）
   - 长文本类型：渲染多行文本输入框（TextArea）
   - 数字类型：渲染数字输入框（InputNumber）
   - 日期类型：渲染日期选择器（DatePicker）
   - 日期时间类型：渲染日期时间选择器（DatePicker showTime）
   - 下拉选择类型：渲染单选下拉框（Select），选项来源于字段配置中的选项列表
   - 多选下拉类型：渲染多选下拉框（Select mode="multiple"），选项来源于字段配置中的选项列表
   - 布尔类型：渲染开关或单选框（Switch/Radio）
   
   自定义字段在表单中的显示位置：
   - 在实体创建/编辑弹出页中，自定义字段显示在标准字段之后
   - 可以按照字段定义中的排序字段进行排序显示
   - 支持字段分组显示，将相关的自定义字段放在同一组中

**报表列配置**：在报表页面提供列配置功能，用户可以自定义显示哪些标准列和自定义列，可以调整列的显示顺序和宽度。配置信息需要保存到用户的个人设置中。

**筛选器配置**：在报表的筛选区域，需要根据实体的自定义字段定义动态生成筛选器。筛选器需要支持多种操作符，对于选择类型的字段需要提供选项列表。

### 2. 后端实现

**字段定义API**：提供自定义字段定义的增删改接口（V1版本），支持创建、更新、删除字段定义。需要验证字段编码的唯一性，确保同一实体类型下字段编码不重复。删除操作采用软删除，保留历史数据以便后续查询和统计。

**字段值API**：提供自定义字段值的保存和查询接口。保存时需要根据字段定义验证数据的有效性，如必填验证、数据类型验证、选项值验证等。

**动态查询**：在报表查询接口中，需要根据实体的自定义字段定义动态构建查询SQL，将自定义字段值关联到查询结果中。需要优化查询性能，避免N+1查询问题。

**数据验证**：在保存自定义字段值时，需要根据字段定义进行数据验证。包括必填验证、数据类型验证、选项值验证、数值范围验证、日期格式验证等。

### 3. 性能优化

**缓存机制**：将自定义字段定义缓存到内存中，减少数据库查询。当字段定义发生变化时，需要及时更新缓存。

**索引优化**：为自定义字段值表建立合适的索引，提高查询性能。建议在实体类型、实体ID、字段编码的组合上建立索引。

**分页查询**：对于大数据量的报表查询，需要使用分页查询，避免一次性加载过多数据。

**异步加载**：在报表页面中，可以先加载标准列的数据，自定义字段的数据可以异步加载，提升页面响应速度。

### 4. 数据迁移

**历史数据处理**：如果系统中已有历史数据需要迁移到自定义字段，需要提供数据迁移工具。迁移时需要确保数据的完整性和一致性。

**字段删除处理**：删除字段定义时，需要考虑是否保留历史数据。建议提供软删除功能，标记字段为已删除但不删除历史数据，以便后续查询和统计。

**字段类型变更**：当需要修改字段类型时，需要考虑历史数据的兼容性。系统需要提供数据转换功能，将历史数据转换为新的字段类型。

## 五、最佳实践

1. **字段命名规范**：使用有意义的字段编码，采用下划线命名法，如 `business_category`、`risk_level`、`project_number` 等。字段名称应该清晰明了，便于用户理解。

2. **字段类型选择**：根据业务需求选择合适的字段类型。
   - 文本类型用于存储短文本信息
   - 长文本类型用于存储备注等长内容
   - 数字类型用于存储数值
   - 日期类型用于存储日期时间
   - 下拉选择类型（select）用于存储固定选项的值，适用于需要从预定义列表中选择的场景，如仓库选择、业务分类等
   - 多选下拉类型（multiselect）用于存储多个固定选项的值，适用于需要选择多个选项的场景
   - 布尔类型用于存储是/否类型的值

3. **必填字段谨慎设置**：避免设置过多必填字段，影响用户体验。只对真正必要的字段设置为必填，其他字段设置为可选。

4. **字段分组显示**：在界面上对自定义字段进行分组显示，将相关的字段放在同一组中，提升用户体验。可以使用折叠面板或标签页来组织字段。

5. **权限控制**：某些敏感的自定义字段可以设置权限控制，只有特定角色的用户才能查看或编辑这些字段。需要在字段定义中记录权限要求，在查询和编辑时进行权限校验。

6. **数据备份**：自定义字段数据同样需要备份和恢复机制。在系统备份时，需要包含自定义字段定义表和值表的数据。

7. **审计日志**：记录自定义字段的创建、修改、删除操作，包括操作人、操作时间、操作内容等信息，便于追溯和审计。

8. **字段使用统计**：可以统计每个自定义字段的使用情况，如使用频率、填充率等，帮助管理员了解字段的使用情况，优化字段配置。

9. **字段模板功能**：可以为常用的字段组合创建模板，在配置新实体时可以直接应用模板，提高配置效率。

10. **字段导入导出**：提供字段定义的导入导出功能，方便在不同环境之间迁移字段配置，也便于备份和恢复。

## 六、特殊场景处理

### 1. 层级结构的自定义字段继承

对于具有父子层级关系的实体（如现货品种->品牌->牌号），需要考虑自定义字段的继承机制。

**应用场景**：在现货品种的层级结构中，品种是一级分类，属性主要在品牌上，未来可能还会有牌号层级。某些属性可能需要在父级定义，子级自动继承，同时子级可以覆盖父级的值。

**实现方式**：在自定义字段值表中，可以支持层级继承。当查询子级实体的自定义字段时，如果子级没有该字段的值，则向上查找父级的值。字段定义中可以设置是否支持继承，以及继承的优先级规则。

**使用建议**：对于品种层级结构，建议在品牌层级定义自定义字段，牌号层级可以继承品牌的字段定义。如果某个属性需要在品种层级统一管理，可以在品种层级定义，品牌和牌号都可以继承使用。

### 2. 期现备注的自定义字段

期现备注是委托单的附属信息，需要支持自定义字段，如团队选择、业务归属选择等。

**数据归属**：期现备注的自定义字段应该存储在期现备注表中，而不是匹配单表或委托单表。因为一条委托单可以有多条期现备注，每条期现备注可能有不同的团队归属和业务归属。

**应用场景**：在期现备注编辑界面，需要支持团队选择、业务归属选择等自定义字段。这些字段可以用于后续的报表统计和筛选，如按团队统计期现备注数量，按业务归属进行分组分析等。

**实现方式**：在自定义字段定义表中，实体类型设置为"spot_futures_remark"，字段值表中通过期现备注的ID关联存储自定义字段值。

## 七、后续版本功能规划

### 1. 自定义字段的公式计算（后续版本）

当自定义字段需要经过系统计算填入数值，或者被应用于报表时需要公式定义时，需要支持公式字段类型。

**公式字段类型**：在字段定义中增加公式字段类型，可以定义计算公式。公式可以引用同一实体的其他标准字段或自定义字段，也可以引用关联实体的字段。

**公式定义方式**：公式可以使用类似Excel的表达式语法，支持基本的数学运算、函数调用、字段引用等。例如：`合同金额 * 0.1`、`SUM(期现备注.手数)`、`IF(保值方案类型='整体', 1, 0)`等。

**计算时机**：公式字段可以在保存时自动计算，也可以在查询时动态计算。对于需要实时计算的字段，建议在查询时计算；对于计算成本较高的字段，可以在保存时计算并缓存结果。

**公式字段在报表中的应用**：在报表查询时，如果字段类型是公式字段，需要先解析公式，然后根据公式引用的字段动态构建查询，计算出公式字段的值。公式字段可以用于报表的列显示、筛选、分组统计等场景。

**实现建议**：
- 公式解析引擎：需要实现一个公式解析引擎，能够解析公式表达式，识别字段引用，执行计算逻辑
- 字段依赖关系：需要维护字段之间的依赖关系，当被引用的字段值发生变化时，需要重新计算公式字段的值
- 性能优化：对于复杂的公式计算，可以考虑缓存计算结果，避免重复计算
- 错误处理：公式计算可能出现错误（如除零、字段不存在等），需要提供友好的错误提示

### 2. 报表字段公式（后续版本）

在报表中支持公式字段，可以基于其他字段进行计算，生成衍生指标或统计结果。报表公式字段可以引用报表中的其他列，支持聚合函数、条件判断等复杂计算逻辑。
