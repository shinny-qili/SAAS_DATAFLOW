# 指令宝产品方案

本文档描述指令宝模块的完整产品方案，包括界面功能、数据来源、计算公式、数据约束和补充说明。

---

## 一、界面功能描述

### 1.1 指令权限设置

指令权限设置模块用于配置哪些人员或客商可以在哪些保值方案下发起哪些类型的指令，以及相应的限制条件。

#### 1.1.1 指令类型角色绑定配置（全局设置）

指令类型角色绑定配置在全局设置的"人员角色管理"页面中完成。在角色管理页面，为每个角色配置可用的指令类型。这是指令权限分配的基础配置。

**配置位置**：全局设置 → 人员管理 → 人员角色管理（在角色详情页或角色编辑弹窗中配置）

**配置内容**：
- 可选指令类型列表（多选）
- 系统显示所有定义的指令类型，管理员为每个角色选择该角色可以使用的指令类型
- 例如：交易员角色可以选择"期货交易指令"、"保值方案移仓换月指令"、"保值方案净值套保指令"
- 例如：业务经理角色可以选择"期货交易指令"、"合同创建指令"、"点价指令"等
- 例如：指令员角色可以选择所有指令类型

**配置说明**：
- 一个角色可以绑定多个指令类型
- 一个指令类型可以被多个角色绑定
- 该配置作为指令权限分配时的约束条件
- 在"人员指令权限设置"界面中，选择指令类型后，系统会根据该配置自动筛选可选人员（只显示拥有对应角色的员工）

**配置验证**：
- 确保每个角色至少配置一个指令类型（角色才有业务意义）
- 确保每个指令类型至少配置一个角色（指令才能被使用）
- 配置变更后，需要检查是否影响现有权限配置

**配置示例**：
- 交易员：期货交易指令、保值方案移仓换月指令、保值方案净值套保指令
- 业务经理：期货交易指令、合同创建指令、一口价创建套保指令、非均价合同套保指令、点价指令、非均价合同变更指令、均价合同变更指令
- 指令员：所有指令类型
- 制单员：合同创建指令
- 客商：期货交易指令、点价指令（此配置仅供参考，客商角色通常由外部系统管理）

**与指令权限设置的关系**：
- 本配置用于限定"人员指令权限设置"中的可选人员范围
- 如果某个指令类型未绑定任何角色，则在权限分配时不会筛选出任何可选人员
- 如果某个角色未绑定任何指令类型，则拥有该角色的人员无法被分配任何指令权限

**详细配置说明请参考**：全局设置文档 → 人员管理 → 角色与权限管理 → 指令类型绑定配置（新增）

#### 1.1.2 人员指令权限设置

**页面入口**：指令宝 → 指令权限设置 → 人员指令权限设置

**页面结构**：
- 顶部工具栏：创建、修改、删除、禁用/启用、导出、自定义列
- 筛选区域：保值方案、指令类型、授权人员、状态等筛选条件
- 数据表格：显示所有人员指令权限配置记录

**表格字段**：
- 保值方案：显示保值方案名称
- 指令类型：显示指令类型名称
- 授权人员：显示被授权的人员列表（多人员时用逗号分隔）
- 制单员：显示可选配的制单员列表
- 交易员：显示可选配的交易员列表
- 状态：启用/禁用

**创建/修改权限配置**：

表单字段说明：

1. **指令类型**（必填）
   - 下拉选择框，显示所有系统定义的指令类型
   - 选择后，系统自动根据"指令类型角色限定配置"筛选可选人员

2. **保值方案**（必填）
   - 下拉选择框，仅显示启用状态的保值方案
   - 根据保值方案类型，系统会过滤可选的指令类型（保值方案类型与指令类型的对应关系见全局设置文档）

3. **授权人员**（必填）
   - 多选下拉框，显示可选人员
   - **关键特性**：选择指令类型后，系统自动筛选可选人员，只显示拥有该指令类型对应角色的人员
   - 人员名称后显示角色标签，例如："张三（交易员、指令员）"
   - 提示信息："只能选择有该指令类型权限角色的人员，已根据指令类型自动筛选"

4. **期货品种限制**（可选，根据指令类型显示）
   - 仅当指令类型不是"合同创建指令"时显示
   - 多选下拉框，选择限制的期货品种
   - 如果不选择，表示不限制期货品种
   - **重要说明**：对于人员的期货交易指令权限，只需配置期货品种和期货合约限制即可，不需要配置其他持仓限制

5. **期货合约限制**（可选，根据指令类型显示）
   - 仅当指令类型不是"合同创建指令"时显示
   - 多选下拉框，选择限制的期货合约代码
   - 如果不选择，表示不限制期货合约
   - **重要说明**：对于人员的期货交易指令权限，只需配置期货品种和期货合约限制即可。持仓方向、持仓手数、单笔手数限制仅在特殊情况下使用（见下）

6-8. **持仓方向限制、持仓手数限制、单笔手数限制**（仅特殊场景）
   - **适用范围**：仅当同时满足以下条件时，这些字段才会显示：
     - 指令类型为"期货交易指令"
     - 保值方案类型为"无合同（人员）"
   - **说明**：对于普通的人员指令权限（合同相关的指令），不需要配置这些限制字段。这些限制仅用于"无合同（人员）"类型的保值方案，用于控制人员的投机性交易。

6. **持仓方向限制**（可选，条件显示）
   - 仅当同时满足以下条件时显示：
     - 指令类型为"期货交易指令"
     - 保值方案类型为"无合同（人员）"
   - 单选：多头/空头
   - 如果不选择，表示不限制持仓方向
   - **说明**：仅在"无合同（人员）"类型的保值方案下才需要配置此限制，用于控制人员的投机性交易

7. **持仓手数限制**（可选，条件显示）
   - 仅当同时满足以下条件时显示：
     - 指令类型为"期货交易指令"
     - 保值方案类型为"无合同（人员）"
   - 数字输入框，只能输入正整数
   - 表示该人员在该保值方案下的最大持仓手数
   - **说明**：仅在"无合同（人员）"类型的保值方案下才需要配置此限制

8. **单笔手数限制**（可选，条件显示）
   - 仅当同时满足以下条件时显示：
     - 指令类型为"期货交易指令"
     - 保值方案类型为"无合同（人员）"
   - 数字输入框，只能输入正整数
   - 表示该人员单笔指令的最大手数
   - **说明**：仅在"无合同（人员）"类型的保值方案下才需要配置此限制

9. **制单员**（可选）
   - 多选下拉框，仅显示"制单员"角色的人员
   - 用于指定该指令权限对应的制单员范围

10. **交易员**（可选）
    - 多选下拉框，仅显示"交易员"角色的人员
    - 用于指定该指令权限对应的交易员范围

**点价指令特殊处理**：
- 如果指令类型是"点价指令"，且授权人员是业务经理角色，则该业务经理只能对"业务经理"字段是自己的合同发起点价
- 如果授权人员是指令员角色，则可以对保值方案下的所有合同发起点价
- 系统在权限验证时需要检查该逻辑

**权限分配流程**：
1. 选择指令类型 → 系统自动筛选可选人员（只显示有对应角色的人员）
2. 选择保值方案 → 系统验证保值方案类型是否支持该指令类型
3. 选择授权人员 → 从筛选后的人员列表中选择具体人员
4. 配置其他限制条件 → 根据指令类型和保值方案类型显示相应字段
5. 保存权限配置 → 系统验证通过后保存

**筛选功能**：
- 保值方案筛选（多选）
- 指令类型筛选（多选）
- 授权人员筛选（模糊搜索或多选）
- 状态筛选（启用/禁用）

#### 1.1.3 客商指令权限设置

**页面入口**：指令宝 → 指令权限设置 → 客商指令权限设置

**页面结构**：
- 顶部工具栏：创建、修改、删除、禁用/启用、导出、自定义列
- 筛选区域：保值方案、授权客商、有效期、状态等筛选条件
- 数据表格：显示所有客商指令权限配置记录

**表格字段**：
- 保值方案：显示保值方案名称
- 指令类型：固定显示"期货交易指令"（客商只能发起期货交易指令）
- 指令创建人：显示被授权的客商列表
- 交易员：显示可选配的交易员列表
- 有效期：显示权限的有效期（含该日期）
- 状态：启用/禁用

**创建/修改权限配置**：

表单字段说明：

1. **指令类型**（固定）
   - 固定显示"期货交易指令"，不可修改
   - 客商只能发起期货交易指令

2. **保值方案**（必填）
   - 下拉选择框，仅显示类型为"无合同（客商）"的保值方案
   - 其他类型的保值方案不在可选范围内

3. **指令创建人**（必填）
   - 多选下拉框，显示所有启用的客商
   - 选择被授权可以发起指令的客商列表

4. **期货合约限制**（必填）
   - 多选下拉框，选择限制的期货合约代码
   - 必须至少选择一个期货合约
   - **重要说明**：客商的期货交易指令权限需要配置全部限制字段，包括期货合约、持仓方向、持仓手数、单笔手数限制，所有字段均为必填

5. **持仓方向限制**（必填）
   - 单选：多头/空头
   - 必须选择其中一个方向
   - **说明**：客商指令权限必须配置持仓方向限制，与人员的指令权限不同，客商权限必须明确指定持仓方向

6. **持仓手数限制**（必填）
   - 数字输入框，只能输入正整数
   - 表示该客商在该保值方案下的最大持仓手数
   - **说明**：客商指令权限必须配置持仓手数限制，用于控制客商的最大持仓

7. **单笔手数限制**（必填）
   - 数字输入框，只能输入正整数
   - 表示该客商单笔指令的最大手数
   - **说明**：客商指令权限必须配置单笔手数限制，用于控制单笔指令的数量上限

**客商与人员权限的差异说明**：
- **人员的期货交易指令权限**：在普通保值方案下，只需配置期货品种限制和期货合约限制（可选）。持仓方向、持仓手数、单笔手数限制仅在"无合同（人员）"类型的保值方案中需要配置。
- **客商的期货交易指令权限**：必须配置全部限制字段，包括期货合约、持仓方向、持仓手数、单笔手数限制，所有字段均为必填。这是因为客商的权限控制需要更严格，需要明确限制持仓方向、最大持仓和单笔上限。

8. **交易员**（可选）
   - 多选下拉框，仅显示"交易员"角色的人员
   - 用于指定该指令权限对应的交易员范围

9. **有效期**（必填）
   - 日期选择器，选择权限的有效期（含该日期）
   - 必须选择一个日期
   - 系统在验证权限时会检查当前日期是否在有效期内

**权限验证规则**：
- 验证时需要结合保值方案中的历史交易记录核算持仓
- 判断客商是否能发起该指令，需要检查：
  - 当前持仓是否超过持仓手数限制
  - 单笔指令数量是否超过单笔手数限制
  - 持仓方向是否符合限制
  - 期货合约是否在允许范围内
  - 当前日期是否在有效期内

**客商与人员权限的差异总结**：
- **人员的期货交易指令权限**（普通保值方案）：
  - 只需配置：期货品种限制（可选）、期货合约限制（可选）
  - 不需要配置：持仓方向限制、持仓手数限制、单笔手数限制
  
- **人员的期货交易指令权限**（无合同（人员）保值方案）：
  - 可以配置：期货品种限制、期货合约限制、持仓方向限制、持仓手数限制、单笔手数限制（均为可选）
  
- **客商的期货交易指令权限**：
  - 必须配置：期货合约限制（必填）、持仓方向限制（必填）、持仓手数限制（必填）、单笔手数限制（必填）、有效期（必填）
  - 说明：客商的权限控制需要更严格，所有限制字段均为必填，确保客商交易在可控范围内

#### 1.1.4 均价自动指令启停

**页面入口**：指令宝 → 指令权限设置 → 均价自动指令启停

**页面结构**：
- 顶部工具栏：启动/禁用、导出、自定义列
- 提示信息：说明数据来源和自动发起机制
- 数据表格：显示可配置自动启停的均价指令

**数据来源说明**：
- 本表格数据来源于"人员指令权限设置"中针对保值方案设置了"保值方案均价净值套保指令"或"均价合同套保指令"的记录
- 只有在这两个指令类型的人员权限配置中存在的保值方案，才会在本页面显示

**表格字段**：
- 保值方案：显示保值方案名称
- 指令发起人：固定显示"系统管理员"（自动指令由系统发起）
- 指令类型：显示"保值方案均价净值套保指令"或"均价合同套保指令"
- 状态：启动/禁用

**功能说明**：
- 默认状态为禁用
- 启动后，系统将每日自动进行按保值方案或按合同的均价指令发起
- 自动发起的时间点由系统参数配置（通常为每日固定时间）
- 自动发起的指令会关联到对应的人员指令权限配置

**操作说明**：
- 选择一条或多条记录后，点击"启动/禁用"按钮
- 启动后，系统会在每日自动生成均价指令
- 禁用后，系统停止自动生成，但不影响历史指令

### 1.2 各岗位工作台的指令界面

工作台是指令宝的核心操作界面，不同角色的人员登录后看到不同的工作台，每个工作台提供对应角色所需的指令查看和处理功能。

#### 1.2.1 工作台界面特性

**工作台显示逻辑**：
- 工作台显示取决于登录人员的角色
- 用户登录后，系统根据用户的角色自动显示对应的工作台入口
- 如果用户有多个角色，会显示多个工作台入口，用户可以切换
- 例如：张三同时拥有"交易员"和"指令员"角色，则显示"交易员工作台"和"指令员工作台"两个入口

**整体布局**：
- 顶部为筛选区域：保值方案、指令类型、状态、日期范围等
- 筛选区域下方为工具栏：创建、认领/取消认领、申请撤回、完成、备注、导出、自定义列等操作按钮
- 工具栏下方为指令列表表格，表格底部为分页组件
- 表格使用横向滚动显示宽表结构，**横向滚动条紧贴在分页组件上方**，保证各工作台体验一致

**视图切换（替代左侧树）**：
- 原方案中的“左侧树结构 + 右侧表格”统一调整为“视图筛选按钮 + 单列表格”的布局
- 在筛选区域附近提供视图切换按钮（单选按钮组），用于在“我发起的”“所有”“我认领的”等不同视图之间切换
- 视图切换只改变同一张表格的数据视图，不改变表格列结构
- 客商工作台只有“我发起的指令”一个视图，不显示视图切换按钮

**状态更新提示**：
- 当指令内容有状态更新时，系统可以在对应工作台显示小红点提示
- 用户需要刷新页面才能看到最新状态（非实时通讯）

**置顶功能**：
- 在交易员工作台中，指定我作为交易人的指令、我发出的指令会被置顶显示
- 置顶状态持续到指令完成

**状态详情对话框**：
- 在表格中涉及到"指令状态"、"其他合同信息"、"期货、合同的要求和匹配内容"、"备注记录"等字段
- 鼠标点击或悬浮后弹出对话框显示详细信息
- 避免表格列过宽，提升可读性

**行内操作与按钮区分**：
- 表格中**不再设计“操作”列**，所有操作通过“选中一行或多行 + 顶部工具栏按钮”完成
- 行内仅用于展示信息（包括通过 Popover / 对话框展示详情），不提供行级“编辑/删除/完成”等链接按钮
- 该规则适用于所有角色的工作台，保证交互方式一致、操作入口集中

**手机适配**：
- 所有指令界面均考虑手机适配
- 移动端使用简化的界面布局，保持核心功能可用

#### 1.2.2 业务经理工作台

**左侧树结构**：
- 根节点：业务经理操作台
- 一级节点：
  - 我发起的指令
  - 与我相关的指令

**我发起的指令表**：

表格字段：
- 发起时间：指令创建时间
- 指令内容更新时间：指令最后更新时间（用于标识指令是否有更新）
- 保值方案：保值方案名称
- 指令类型：指令类型名称
- 合同号：关联的合同编号（如果有）
- 客商简称：关联的客商简称（如果有）
- 其他合同信息：点击或悬浮显示完整合同信息
- 期货交易认领人：认领该指令的交易员姓名
- 期货要求和匹配内容：点击或悬浮显示期货要求和已匹配的期货委托详情
- 期货交易状态：完成/待完成/null（null表示该指令不涉及期货交易）
- 合同创建认领人：认领该指令的制单员姓名
- 合同创建要求和匹配内容：点击或悬浮显示合同创建要求和已创建的合同详情
- 合同创建状态：完成/待完成/null（null表示该指令不涉及合同创建）
- 指令状态：待完成/撤销待处理/完成
- 备注记录：点击或悬浮显示备注记录列表

工具栏按钮：
- 创建：发起新指令（根据权限显示可创建的指令类型）
- 申请撤回：对选中的指令申请撤回
- 备注：为指令添加备注

筛选功能：
- 保值方案筛选
- 指令类型筛选
- 指令状态筛选
- 日期范围筛选

**与我相关的指令表**：

表格字段：
- 发起人：指令发起人姓名
- 发起时间、指令内容更新时间、保值方案、指令类型、合同号、客商简称等字段与"我发起的指令表"相同
- 其他合同信息、期货要求和匹配内容、合同创建要求和匹配内容、指令状态、备注记录等字段同上

工具栏按钮：
- 备注：为指令添加备注（只能添加备注，不能修改指令）

筛选功能：同上

**指令创建流程**：
1. 点击"创建"按钮，弹出指令创建表单
2. 系统根据用户的权限，显示可创建的指令类型选项
3. 选择指令类型后，系统根据权限配置，显示可选的保值方案
4. 填写指令内容（根据指令类型不同，表单字段不同）
5. 提交创建，系统验证权限后创建指令

**父子指令的显示规则**：
- 如果业务经理发起了均价合同的数量变更，系统会自动创建一个子指令（均价合同变更指令），该子指令关联到父指令（如保值方案均价净值套保指令或均价合同套保指令）
- 在业务经理工作台的指令列表中，**只显示该业务经理发起的子指令**，不显示父指令
- 子指令列表中显示：子指令编号、关联合同、子指令状态、变更数量影响、期货要求等
- 业务经理可以查看自己发起的子指令的完成状态，但看不到父指令的整体情况

#### 1.2.3 交易员工作台

**左侧树结构**：
- 根节点：交易员工作台
- 一级节点：
  - 我发起的交易指令
  - 所有交易指令
  - 我认领的交易指令

**我发起的交易指令表**：

表格字段：
- 发起时间、指令内容更新时间、保值方案
- 指令类型：期货交易指令、保值方案移仓换月指令、保值方案净值套保指令等
- 期货要求：显示合约、方向、价格、数量等信息的汇总
  - 合约：期货合约代码
  - 方向：买入/卖出
  - 价格：价格要求（如果有）
  - 数量：所需手数
- 期货要求和匹配内容：点击或悬浮显示详细信息和匹配的委托单
- 期货交易认领人：认领该指令的交易员
- 期货交易状态：完成/待完成/null
- 指令状态：待完成/撤销待处理/完成
- 备注记录：点击或悬浮显示

工具栏按钮：
- 创建：发起新交易指令
- 申请撤回：申请撤回指令
- 认领/取消认领：认领或取消认领指令
- 备注：添加备注

**所有交易指令表**：

表格字段：
- 认领状态：待认领/认领人姓名
- 发起人：指令发起人姓名
- 其他字段与"我发起的交易指令表"相同

工具栏按钮：
- 认领/取消认领：认领或取消认领选中的指令
- 备注：添加备注

**我认领的交易指令表**：

表格字段：
- 指令状态、发起人、发起时间、指令内容更新时间、保值方案、指令类型
- 合同号、客商简称、其他合同信息（如果有）
- 期货要求、期货要求和匹配内容
- 期货交易状态
- 备注记录

工具栏按钮：
- 取消认领：取消对指令的认领
- 同意撤销/拒绝撤销：处理指令撤销申请
- 主动撤销：主动申请撤销指令
- 匹配：将期货委托匹配到指令（打开匹配界面）
- 备注：添加备注
- 完成期货交易：标记期货交易完成
- 完成指令：标记整个指令完成

**父子指令的操作说明**：
- 如果认领的指令是父指令（包含子指令），在指令详情中会显示"子指令列表"表格
- 在指令详情中，交易员可以看到：
  - 父指令的汇总期货要求（所需数量、方向、合约等）
  - 所有子指令的列表，包括每个子指令的变更影响、变更前后敞口、变更所需期货数量等
  - 导致期货交易的合同基础信息列表，以及子指令更新记录（均价当日创建、均价变更、指令撤销申请）
  - 对于变更类型的子指令，显示：变更前现货敞口（整体或单单）、变更前期货数量（整体或单单）、变更后需要的期货数量
- 交易员可以针对**每个子指令单独完成期货交易**：
  - 在"子指令列表"表格中，每个子指令行提供"完成期货交易"按钮
  - 点击后，系统验证该子指令的期货交易是否已经匹配完成，如果已完成匹配，将子指令状态标记为"完成"
  - 只有当所有子指令的期货交易都完成后，才能对父指令点"完成期货交易"
- 父指令的期货交易完成：
  - 只有在所有子指令的期货交易都完成后，"完成期货交易"按钮才可点击
  - 点击后，系统验证所有子指令和父指令的期货交易状态，如果都满足，将父指令的期货交易状态标记为"完成"

**撤销处理流程**：
- 如果还没做交易，交易员直接同意撤销
- 如果做了交易没匹配或已经匹配但是未完成交易：
  - 可以拒绝撤销，然后继续匹配完成
  - 如果想要同意撤销，交易员应该进行反冲交易，然后将两个方向的交易都匹配进来，再同意撤销
- 如果父指令包含子指令，撤销时需要同时考虑子指令的交易状态

#### 1.2.4 指令员工作台

**左侧树结构**：
- 根节点：指令员工作台
- 一级节点：
  - 我发起的指令
  - 所有指令

**我发起的指令表**：

表格字段：与业务经理工作台的"我发起的指令表"相同

工具栏按钮：
- 创建：发起新指令（可以发起所有类型的指令）
- 申请撤回：申请撤回指令
- 备注：添加备注

**所有指令表**：

表格字段：
- 发起人：指令发起人姓名
- 其他字段与"我发起的指令表"相同

工具栏按钮：
- 申请撤回：对选中的指令申请撤回
- 备注：添加备注

**特殊说明**：
- 指令员可以看到所有指令，包括系统自动发起的均价指令
- 均价指令的自动发起结果只有指令员和相关业务经理能看到

#### 1.2.5 制单员工作台

**左侧树结构**：
- 根节点：制单员工作台
- 一级节点：
  - 所有合同指令
  - 我认领的指令

**所有合同指令表**：

表格字段：
- 认领状态：待认领/认领人姓名
- 发起人：指令发起人姓名
- 发起时间、指令内容更新时间、保值方案、指令类型
- 合同号、客商简称、其他合同信息
- 合同创建要求和匹配内容：点击或悬浮显示合同创建要求和已创建的合同详情
- 合同创建状态：完成/待完成/null
- 指令状态：待完成/撤销待处理/完成
- 备注记录：点击或悬浮显示

工具栏按钮：
- 认领/取消认领：认领或取消认领合同创建指令
- 备注：添加备注

**我认领的指令表**：

表格字段：
- 指令状态、发起人、发起时间、指令内容更新时间、保值方案、指令类型
- 合同号、客商简称、其他合同信息
- 合同创建要求和匹配内容
- 合同创建状态
- 备注记录

工具栏按钮：
- 取消认领：取消对指令的认领
- 创建合同：根据指令要求创建合同
- 备注：添加备注
- 完成合同创建：标记合同创建完成
- 完成指令：标记整个指令完成

**合同匹配功能**：
- 制单员可以将创建的合同匹配到指令
- 匹配时需要指定匹配的数量

#### 1.2.6 客商工作台

**页面结构**：
- 仅显示"我发起的指令"表（无左侧树结构）

**我发起的指令表**：

表格字段：
- 发起时间、指令内容更新时间
- 保值方案：显示"无合同（客商）"类型的保值方案
- 指令类型：固定显示"期货交易指令"
- 期货交易认领人：认领该指令的交易员
- 期货要求和匹配内容：点击或悬浮显示期货要求和匹配详情
- 期货交易状态：完成/待完成/null
- 指令状态：待完成/撤销待处理/完成
- 备注记录：点击或悬浮显示

工具栏按钮：
- 创建：发起新的期货交易指令
- 申请撤回：申请撤回指令
- 备注：添加备注（客商可以为自己发起的指令添加备注）

**指令创建流程**：
- 客商只能发起期货交易指令
- 系统根据客商指令权限配置，限制可选的保值方案、期货合约、持仓方向、持仓手数等
- 创建指令时，系统会验证客商的当前持仓，确保不超过限制

### 1.3 指令报表

指令报表提供指令的查询和统计功能，帮助用户了解指令的执行情况和历史记录。

#### 1.3.1 在途指令

**页面入口**：指令宝 → 报表 → 在途指令

**功能说明**：
- 显示所有状态为"待完成"或"撤销待处理"的指令
- 用于实时监控当前系统中的在途指令情况

**表格字段**：
- 指令编号、指令类型、保值方案、发起人、发起时间
- 指令状态、期货交易状态、合同创建状态
- 相关合同信息、期货要求信息等
- 最后更新时间

**筛选功能**：
- 保值方案筛选
- 指令类型筛选
- 发起人筛选
- 指令状态筛选
- 日期范围筛选

#### 1.3.2 历史指令

**页面入口**：指令宝 → 报表 → 历史指令

**功能说明**：
- 显示所有已完成的指令
- 支持按时间范围查询历史指令记录

**表格字段**：
- 指令编号、指令类型、保值方案、发起人、发起时间、完成时间
- 指令状态（固定为"完成"）
- 期货交易状态、合同创建状态
- 相关合同信息、期货要求信息等

**筛选功能**：
- 保值方案筛选
- 指令类型筛选
- 发起人筛选
- 完成时间范围筛选
- 日期范围筛选

### 1.4 指令备注功能

**功能说明**：
- 在一个指令上，各相关步骤的人员可以不止打一个备注
- 每次打的备注都会被存在备注记录中
- 这不是一个即时通讯软件，只有刷新后才能从数据库获取新的视图

**备注显示格式**：
```
张三：齐总点价30吨，5300
张三：我是替李四发的点价指令
王五：确定是30吨？我记得李四昨天说20吨
张三：确定多点10吨
王五：已完成期货
```

**备注记录字段**：
- 备注人：添加备注的人员姓名或客商名称
- 备注内容：备注文本内容
- 备注时间：添加备注的时间

**备注权限**：
- 指令发起人可以添加备注
- 期货交易认领人可以添加备注
- 合同创建认领人可以添加备注
- 指令员可以对所有指令添加备注
- 客商只能对自己发起的指令添加备注

---

## 二、数据来源和相关计算公式

### 2.1 指令权限数据来源

#### 2.1.1 人员指令权限

**权限主体**：
- 授权人员ID列表：来自人员管理，通过人员指令权限设置界面选择
- 人员选择范围：由"指令类型角色限定配置"自动筛选，只显示拥有对应角色的人员

**权限范围**：
- 保值方案ID：来自保值方案管理，根据保值方案类型过滤可选的指令类型
- 指令类型ID：来自系统定义的指令类型列表
- 期货品种限制：可选，来自期货品种配置
- 期货合约限制：可选，来自期货合约配置
- 持仓方向限制：仅当指令类型为"期货交易指令"且保值方案为"无合同（人员）"时配置
- 持仓手数限制：仅当指令类型为"期货交易指令"且保值方案为"无合同（人员）"时配置
- 单笔手数限制：仅当指令类型为"期货交易指令"且保值方案为"无合同（人员）"时配置
- 制单员ID列表：来自人员管理，仅显示"制单员"角色的人员
- 交易员ID列表：来自人员管理，仅显示"交易员"角色的人员

**权限验证逻辑**：
- 验证用户是否有权限创建指令时，需要检查：
  1. 用户ID是否在授权人员列表中
  2. 权限状态是否为"启用"
  3. 保值方案是否匹配
  4. 指令类型是否匹配
  5. 如果有限制条件，检查是否符合限制

#### 2.1.2 客商指令权限

**权限主体**：
- 授权客商ID列表：来自客商管理，通过客商指令权限设置界面选择

**权限范围**：
- 保值方案ID：仅限"无合同（客商）"类型的保值方案
- 指令类型ID：固定为"期货交易指令"
- 期货合约限制：必填，来自期货合约配置
- 持仓方向限制：必填，单选"多头"或"空头"
- 持仓手数限制：必填，正整数
- 单笔手数限制：必填，正整数
- 交易员ID列表：来自人员管理，仅显示"交易员"角色的人员
- 有效期：日期，权限有效期（含该日期）

**权限验证逻辑**：
- 验证客商是否有权限创建指令时，需要检查：
  1. 客商ID是否在授权客商列表中
  2. 权限状态是否为"启用"
  3. 当前日期是否在有效期内
  4. 保值方案是否匹配
  5. 结合保值方案中的历史交易记录核算持仓：
     - 当前持仓是否超过持仓手数限制
     - 单笔指令数量是否超过单笔手数限制
     - 持仓方向是否符合限制
     - 期货合约是否在允许范围内

### 2.2 指令类型角色限定配置

**配置位置**：全局设置 → 人员管理 → 人员角色管理

**配置内容**：
- 角色与指令类型的绑定关系
- 一个角色可以绑定多个指令类型
- 一个指令类型可以被多个角色绑定

**作用机制**：
- 在人员指令权限设置界面，选择指令类型后，系统自动筛选可选人员
- 只显示拥有该指令类型对应角色的人员
- 如果没有配置角色与指令类型的绑定，则不会筛选出任何人员

**配置示例**：
- 交易员角色：期货交易指令、保值方案移仓换月指令、保值方案净值套保指令
- 业务经理角色：期货交易指令、合同创建指令、一口价创建套保指令、非均价合同套保指令、点价指令、非均价合同变更指令、均价合同变更指令
- 指令员角色：所有指令类型
- 制单员角色：合同创建指令
- 客商角色：期货交易指令、点价指令

### 2.3 指令状态计算

**详细状态组成**：
- 交易状态：待完成/完成/null（null表示该指令不涉及期货交易）
- 合同状态：待完成/完成/null（null表示该指令不涉及合同创建）
- 撤销处理：待处理/已同意/已拒绝/null（null表示该指令没有撤销申请）
- 指令状态：完成/待完成
- 交易认领：完成/待完成/null（null表示该指令不需要认领）
- 合同创建认领：完成/待完成/null（null表示该指令不需要认领）

**指令状态判断规则**：
- 指令状态为"完成"的条件：
  - 所有需要完成的步骤都已完成（交易状态和合同状态都为"完成"或"null"）
  - 撤销处理状态不是"待处理"（已完成处理或没有撤销申请）

- 指令状态为"撤销待处理"的条件：
  - 有撤销申请且状态为"待处理"

- 指令状态为"待完成"的条件：
  - 不满足"完成"和"撤销待处理"的条件

**单元格显示规则**：
- 表格单元格中只显示简化的状态：完成/撤销待处理/待完成
- 点击或悬浮后显示详细的状态分解

### 2.4 指令更新机制

**指令更新触发场景**：
1. 对于均价合同，在保值方案维度，如果发生变更，自动更新指令中的合同内容和期货要求
2. 对于一口价合同，需要发起人对一口价合同进行"创建合同信息补充"
3. 对于点价合同，需要发起人对点价指令进行撤销
4. 所有"合同的变更信息补充"，自动更新指令中的合同内容和期货要求
5. **父子指令的更新场景**：
   - 当合同发生数量变更时，如果存在未完成的父指令，系统会自动创建或更新子指令
   - 子指令创建/更新后，系统会重新计算父指令的所需数量
   - 父指令的所需数量会随着子指令的变化而实时更新

**指令更新记录**：
- 系统记录指令的更新次数和最后更新时间
- 在指令列表中显示"指令内容更新时间"字段
- 提供指令更新日志查看功能
- 对于父子指令，记录子指令的创建/更新日志，以及父指令数量的重新计算日志

**指令更新显示**：
- 在指令列表中，如果指令有更新，在"指令内容更新时间"字段显示最后更新时间
- 可以点击查看更新日志，了解指令的变更历史
- 对于父指令，如果子指令有更新，父指令的"指令内容更新时间"也会相应更新
- 在父指令详情中，可以查看所有子指令的更新历史记录

### 2.5 父子指令关系

**父子指令类型**：
- 某些指令类型可以包含子指令
- 子指令类型包括：均价合同变更指令、非均价合同变更指令

**父子指令数据结构（概要）**：
- 父指令核心字段：
  - 父指令编号、指令类型（如保值方案净值套保指令、保值方案均价净值套保指令、均价合同套保指令等）
  - 关联保值方案、可选关联合同（整体/单单场景不同）
  - 父指令所需数量（手数）：等于所有子指令“变更所需期货数量”之和的绝对值
  - 指令状态：待完成 / 撤销待处理 / 完成
  - 创建时间、完成时间、交易日等元数据
- 子指令核心字段（变更指令）：
  - 子指令编号、子指令类型：均价合同变更指令 / 非均价合同变更指令
  - 父指令ID（必填）、关联合同ID、关联保值方案ID
  - 子指令数量影响：本次合同变更的数量增减值（吨）
  - 变更所需期货数量：子指令数量影响 × 敞口系数（手数）
  - 变更前/后现货敞口与期货数量：用于在父指令详情中给交易员展示变更前后对冲需求
  - 子指令状态：待完成 / 完成
  - 创建时间、交易日

**父子指令关系判断**：
- 合并指令形成的父指令，是确定的指定管理（不支持任意拆散重组）
- 均价指令自动发出时会指定交易日，所有子指令发生时也会判断交易日，如果交易日一致、合同一致或保值方案一致则判断为父子关系

**父子指令的界面展示**：

**查看子指令的方式**：
- 在各工作台的指令列表中，父指令以单行汇总展示：显示保值方案、指令类型、所需数量、期货状态、合同状态等关键字段，不直接展开所有子指令细节
- 点击父指令行进入“指令详情”抽屉/弹窗，在详情中：
  - 展示合同信息、期货要求信息等基础区块
  - 单独提供“子指令列表”表格，显示子指令编号、类型、状态、操作人、方向、影响手数等字段
  - 提供“操作日志”“备注信息”等区块，串联父子指令的时间线

**父子指令的可见性规则**：
- **业务经理视角**：
  - 如果业务经理发起了均价合同的数量变更，系统会创建一个子指令（均价合同变更指令），该子指令关联到父指令（如保值方案均价净值套保指令或均价合同套保指令）
  - 业务经理在工作台中**只能看到自己发起的子指令**，看不到父指令本身
  - 子指令列表中显示：子指令编号、关联合同、子指令状态、变更数量影响、期货要求等
  - 业务经理只能查看自己发起的子指令的完成状态，无法查看父指令或其他人的子指令
- **指令员视角**：
  - 指令员可以看到所有父指令和所有子指令
  - 在指令列表中，可以看到父指令汇总信息和所有子指令的列表
  - 指令员可以查看父子指令的完整关系链
- **交易员视角**：
  - 交易员需要看到父指令和所有子指令，因为需要根据子指令的变更情况完成期货交易
  - 在指令详情中，交易员可以看到：
    - 父指令的汇总期货要求（所需数量、方向、合约等）
    - 所有子指令的列表，包括每个子指令的变更影响、变更前后敞口、变更所需期货数量等
    - 导致期货交易的合同基础信息列表，以及子指令更新记录（均价当日创建、均价变更、指令撤销申请）
    - 对于变更类型的子指令，需要显示：变更前现货敞口（整体或单单）、变更前期货数量（整体或单单）、变更后需要的期货数量
- **制单员视角**：
  - 制单员主要关注合同创建相关的指令，不涉及父子指令的期货交易部分，因此不需要查看父子指令关系

**子指令更新对父指令期货交易数量的影响**：

**更新触发机制**：
- 当合同发生数量变更时（创建、编辑、删除），系统会自动检测是否存在未完成的父指令
- 如果存在父指令且满足父子关系判断条件（交易日一致、合同一致或保值方案一致），系统会创建或更新子指令
- 子指令创建/更新后，系统会重新计算父指令的所需数量

**父指令所需数量的计算公式**：
- **父指令所需数量（手数）** = 所有子指令的"变更所需期货数量"之和的绝对值
- 子指令的"变更所需期货数量" = 子指令数量影响（吨）× 敞口系数（手/吨）
- 如果父指令本身有初始的期货要求（如自动指令根据均价日历计算的基础数量），则：
  - 父指令所需数量 = |初始期货数量 + 所有子指令变更所需期货数量之和|
- 每次子指令创建或更新时，系统会立即重新计算父指令所需数量并更新

**数据来源**：
- 子指令数量影响：来自合同变更时的数量差值（变更后数量 - 变更前数量）
- 敞口系数：从合同关联的保值方案中获取，根据合同的品牌配置查找对应的期货敞口系数
- 变更前/后现货敞口：来自合同变更前的数量和变更后的数量
- 变更前/后期货数量：根据变更前/后现货敞口 × 敞口系数计算

**父指令完成规则**：
- 父指令应该在15点之后点完成（系统可以通过交易日及时间限制，在15点前不允许完成父指令）
- 所有子指令完成后才能对父指令点完成
- 父指令的期货交易状态只有在所有子指令的期货交易都完成后，才能标记为"完成"

**子指令完成规则**：
- 子指令随时可以完成（不受时间限制）
- 子指令完成后，需要同步更新父指令的所需数量
- 如果子指令的期货交易已完成，子指令状态标记为"完成"
- 父指令的状态在所有子指令完成、且期货交易实际执行完毕之后才能置为"完成"

**交易员对子指令的操作逻辑**：

**在交易员工作台的"我认领的交易指令表"中**：
- 如果认领的指令是父指令（包含子指令），在指令详情中会显示"子指令列表"表格
- 交易员可以查看所有子指令的状态、变更影响、变更前后敞口等信息

**子指令的期货交易完成操作**：
- 交易员可以针对**每个子指令单独完成期货交易**
- 在指令详情的"子指令列表"表格中，每个子指令行提供"完成期货交易"按钮
- 点击"完成期货交易"按钮后：
  - 系统验证该子指令的期货交易是否已经匹配完成
  - 如果已完成匹配，将子指令的期货交易状态标记为"完成"
  - 更新子指令状态为"完成"
  - 检查父指令的所有子指令是否都已完成，如果都已完成，允许对父指令点"完成期货交易"
- 如果子指令的期货交易还未完成或未匹配，系统提示交易员先完成匹配

**父指令的期货交易完成操作**：
- 只有在所有子指令的期货交易都完成后，才能对父指令点"完成期货交易"
- 在指令详情的顶部工具栏中，提供"完成期货交易"按钮（仅在所有子指令完成后才可点击）
- 点击"完成期货交易"按钮后：
  - 系统验证所有子指令的期货交易状态都是"完成"
  - 验证父指令本身的期货交易是否已经匹配完成
  - 如果都满足，将父指令的期货交易状态标记为"完成"

**数据一致性约束**：
- 子指令的期货交易完成后，父指令的所需数量不能为负数
- 如果所有子指令完成后的父指令所需数量为0，父指令可以标记为完成
- 如果父指令所需数量仍大于0，交易员需要继续完成父指令本身的期货交易，或等待新的子指令更新父指令数量

### 2.6 指令认领机制

**交易认领**：
- 所有交易指令都需要认领
- 交易员可以认领/取消认领指令
- 一个指令可以被一个交易员认领
- 认领后，该交易员负责完成该指令的期货交易部分

**合同创建认领**：
- 合同创建指令需要制单员认领
- 制单员可以认领/取消认领合同创建指令
- 认领后，该制单员负责完成该指令的合同创建部分

**认领状态**：
- 待认领：还没有人认领
- 认领人：显示认领人的姓名

---

## 三、数据一致性和数据约束

### 3.1 权限分配的数据约束

#### 3.1.1 人员指令权限约束

**角色匹配约束**：
- 授权人员必须拥有该指令类型对应的角色
- 在权限分配界面，系统自动筛选，只显示有对应角色的人员
- 如果权限分配后，人员角色被移除，系统会在权限列表中显示警告，并在工作台验证时拒绝使用该权限

**保值方案与指令类型匹配**：
- 保值方案类型必须支持该指令类型
- 例如："整体匹配"类型的保值方案不支持"点价指令"、"均价合同套保指令"等"单单匹配"类型的指令
- 系统在保存权限时会验证该约束

**字段显示约束**：
- 期货品种限制、期货合约限制：除了"合同创建指令"，其他指令都可选配置
- 持仓方向限制、持仓手数限制、单笔手数限制：仅当指令类型为"期货交易指令"且保值方案为"无合同（人员）"时显示和配置
- 其他情况下这些字段不显示

#### 3.1.2 客商指令权限约束

**保值方案约束**：
- 客商指令权限只能配置"无合同（客商）"类型的保值方案
- 其他类型的保值方案不在可选范围内

**必填字段约束**：
- 期货合约限制：必填，必须至少选择一个期货合约
- 持仓方向限制：必填，必须选择"多头"或"空头"
- 持仓手数限制：必填，必须输入正整数
- 单笔手数限制：必填，必须输入正整数
- 有效期：必填，必须选择一个日期

**持仓验证约束**：
- 系统在验证客商权限时，需要结合历史交易记录核算持仓
- 确保当前持仓不超过持仓手数限制
- 确保单笔指令数量不超过单笔手数限制
- 确保持仓方向符合限制
- 确保期货合约在允许范围内

#### 3.1.3 指令类型角色限定约束

**配置约束**：
- 每个角色必须至少配置一个指令类型（角色才有意义）
- 每个指令类型必须至少配置一个角色（指令才能被使用）
- 角色名称必须与人员角色管理中的角色名称一致

**使用约束**：
- 在权限分配时，如果指令类型没有配置对应的角色，不会筛选出任何可选人员
- 系统会提示管理员先配置指令类型角色限定

### 3.2 指令创建的数据约束

#### 3.2.1 权限验证约束

**创建指令时的验证**：
- 检查用户是否有权限创建该类型的指令
- 检查用户是否有权限在该保值方案下创建指令
- 检查是否符合权限配置的限制条件（品种、合约、方向、手数等）
- 对于客商，还需要检查持仓和有效期

#### 3.2.2 指令内容约束

**必填字段**：
- 指令类型、保值方案、发起人、创建时间
- 根据指令类型不同，其他必填字段也不同

**数量约束**：
- 指令数量必须大于0
- 如果是指令数量为0，不创建指令

**日期约束**：
- 指令创建时间不能晚于当前时间
- 指令的交易日必须有效

### 3.3 指令状态的数据一致性

#### 3.3.1 状态更新一致性

**状态更新规则**：
- 当交易完成时，更新交易状态为"完成"
- 当合同创建完成时，更新合同状态为"完成"
- 当所有步骤都完成时，指令状态自动更新为"完成"
- 状态更新必须在一个事务中完成

**状态互斥规则**：
- 指令状态为"完成"时，不能再申请撤销
- 指令状态为"撤销待处理"时，不能标记为"完成"
- 未撤销处理的指令不能完成

#### 3.3.2 认领状态一致性

**认领状态更新**：
- 认领后，更新认领状态为"完成"，记录认领人
- 取消认领后，更新认领状态为"待认领"，清空认领人
- 认领状态的更新必须在事务中完成

### 3.4 指令更新的数据一致性

#### 3.4.1 自动更新一致性

**自动更新触发**：
- 合同变更时，系统自动检测是否需要更新指令
- 如果存在未完成的父指令，自动创建或更新子指令
- 自动更新父指令的所需数量

**更新事务性**：
- 合同变更和指令更新必须在同一个事务中完成
- 如果任何一步失败，整个操作回滚

#### 3.4.2 更新记录一致性

**更新日志记录**：
- 每次指令更新都记录更新日志
- 更新日志包含：更新时间、更新人、更新内容、更新前后对比
- 更新日志不可删除，用于追溯

### 3.5 父子指令的数据一致性

#### 3.5.1 父子关系一致性

**关系维护**：
- 子指令必须关联到父指令（父指令ID字段必填）
- 如果父指令被删除，子指令的处理策略需要明确（通常不允许删除有子指令的父指令）
- 父指令的所需数量必须等于所有子指令的变更所需期货之和的绝对值
- 子指令的交易日必须与父指令的交易日一致，才能建立父子关系

**父子关系判断规则**：
- 合并指令形成的父指令，是确定的指定管理（不支持任意拆散重组）
- 均价指令自动发出时会指定交易日，所有子指令发生时也会判断交易日
- 如果交易日一致、合同一致或保值方案一致则判断为父子关系
- 系统在创建子指令时，会自动查找符合条件的父指令并建立关联

#### 3.5.2 完成状态一致性

**完成顺序**：
- 子指令可以随时完成（不受时间限制）
- 父指令必须等所有子指令完成后才能完成
- 父指令的完成时间必须晚于所有子指令的完成时间
- 父指令必须在15点之后才能点完成（系统在15点前不允许完成父指令）

**完成状态更新规则**：
- 子指令的期货交易完成后，更新子指令状态为"完成"
- 父指令的期货交易状态只有在所有子指令的期货交易都完成后，才能标记为"完成"
- 父指令的指令状态只有在所有子指令完成、且父指令本身的期货交易实际执行完毕之后才能置为"完成"

#### 3.5.3 数量一致性约束

**父指令所需数量计算**：
- 父指令所需数量（手数）= |所有子指令的"变更所需期货数量"之和|
- 如果父指令本身有初始的期货要求（如自动指令根据均价日历计算的基础数量），则：
  - 父指令所需数量 = |初始期货数量 + 所有子指令变更所需期货数量之和|
- 每次子指令创建或更新时，系统必须立即重新计算父指令所需数量并更新
- 父指令所需数量不能为负数（取绝对值）

**子指令数量影响计算**：
- 子指令数量影响 = 变更后合同数量 - 变更前合同数量（吨）
- 子指令变更所需期货数量 = 子指令数量影响 × 敞口系数（手数）
- 敞口系数从合同关联的保值方案中获取，根据合同的品牌配置查找对应的期货敞口系数

**数量更新一致性**：
- 子指令创建或更新时，必须在同一个事务中完成以下操作：
  - 创建/更新子指令记录
  - 重新计算父指令所需数量
  - 更新父指令的所需数量字段
- 如果任何一步失败，整个操作必须回滚
- 确保子指令数量影响和父指令所需数量始终保持一致

### 3.6 数据一致性检查

#### 3.6.1 定期检查任务

系统应该定期运行数据一致性检查任务：
- 检查指令状态是否与交易状态、合同状态一致
- 检查父指令所需数量是否等于所有子指令的变更所需期货之和的绝对值
- 检查子指令的父指令ID是否有效（父指令是否存在）
- 检查父子指令的交易日是否一致
- 检查子指令的期货交易状态与父指令的期货交易状态是否一致
- 检查父指令是否在所有子指令完成前就被标记为完成（数据异常）
- 检查权限配置中的授权人员是否仍然拥有对应角色
- 检查客商权限是否在有效期内

#### 3.6.2 异常处理

- 如果发现数据不一致，系统应该记录异常日志
- 提供数据修复工具或手动修复流程
- 通知系统管理员进行处理

---

## 四、其他补充

### 4.1 禁用启用规则

#### 4.1.1 权限配置禁用

**权限配置禁用影响**：
- 禁用的权限配置，用户无法使用该权限创建新指令
- 已创建的指令不受影响，可以继续处理
- 禁用后，在工作台不显示对应的指令创建入口

**历史数据不受影响**：
- 之前创建的指令不受权限配置禁用的影响
- 之前分配的权限记录保留，但状态为"禁用"

#### 4.1.2 角色禁用影响

**角色禁用影响**：
- 禁用的角色，无法在权限分配时选择
- 如果人员角色被禁用，该人员无法使用对应工作台
- 已分配的权限如果依赖禁用的角色，系统会显示警告

### 4.2 指令完成规则

#### 4.2.1 完成权限

**谁可以点完成**：
- 指令最后一个步骤的人点完成
- 例如：如果指令只需要完成期货交易，则由交易员点完成
- 例如：如果指令需要完成期货交易和合同创建，则由最后完成步骤的人点完成

**完成验证**：
- 系统验证所有必需的步骤是否都已完成
- 如果还有未完成的步骤，不允许点完成
- 如果有撤销申请待处理，不允许点完成

#### 4.2.2 完成时间限制

**父指令完成时间**：
- 父指令应该在15点之后点完成
- 系统在15点前不允许点完成父指令
- 15点后可以点完成

**子指令完成时间**：
- 子指令随时可以完成
- 不受时间限制

### 4.3 指令撤销规则

#### 4.3.1 撤销申请

**谁可以申请撤销**：
- 指令发起人可以申请撤销
- 申请撤销后，指令状态变为"撤销待处理"

**撤销申请约束**：
- 完成的指令不再接受撤销申请
- 如果指令已经完成，不能申请撤销

#### 4.3.2 撤销处理

**撤销处理流程**：
- 如果还没做交易，交易员直接同意撤销
- 如果做了交易没匹配或已经匹配但是未完成交易：
  - 可以拒绝撤销，然后继续匹配完成
  - 如果想要同意撤销，交易员应该进行反冲交易，然后将两个方向的交易都匹配进来，再同意撤销

**撤销处理结果**：
- 已同意：指令状态变为"已完成"，但标记为"已撤销"
- 已拒绝：指令状态恢复为"待完成"，继续正常流程

### 4.4 均价自动指令规则

#### 4.4.1 自动发起机制

**发起条件**：
- 在"均价自动指令启停"页面启动后，系统每日自动发起
- 根据"人员指令权限设置"中的配置，查找需要自动发起的保值方案
- 系统在每日固定时间（如9:00）自动检查并生成指令

**发起内容**：
- 按照保值方案每天自动发指令
- 指令中应该有每一个合同的当日需均价明细
- 按照保值方案合并提示应该期货操作数量
- 应该提示当日均价、当月均价、上月均价等信息
- 当天均价期的均价合同新增和变更会触发指令内容更新

#### 4.4.2 自动指令可见性

**可见范围**：
- 均价指令的自动发起结果只有指令员和相关业务经理能看到
- 其他角色看不到自动发起的均价指令（除非被授权）

### 4.5 指令类型说明

#### 4.5.1 指令类型列表

系统支持的指令类型包括：
- 期货交易指令：纯期货交易指令
- 合同创建指令：仅创建合同，不涉及期货交易
- 点价指令：为暂定价合同点价，涉及期货交易
- 一口价创建套保指令：创建一口价合同并做期货交易
- 保值方案移仓换月指令：为保值方案做期货移仓换月
- 保值方案净值套保指令：为保值方案提供套保
- 保值方案均价净值套保指令：为保值方案提供均价套保
- 非均价合同套保指令：为非均价合同提供套保
- 均价合同套保指令：为均价合同提供套保
- 非均价合同变更指令：处理非均价合同的变更
- 均价合同变更指令：处理均价合同的变更

#### 4.5.2 指令类型与保值方案类型的对应关系

**整体匹配类型保值方案**支持：
- 期货交易指令
- 合同创建指令
- 一口价创建套保指令
- 保值方案移仓换月指令
- 保值方案净值套保指令
- 保值方案均价净值套保指令

**单单匹配类型保值方案**支持：
- 期货交易指令
- 合同创建指令
- 一口价创建套保指令
- 非均价合同套保指令
- 均价合同套保指令
- 点价指令
- 非均价合同变更指令
- 均价合同变更指令

**无合同（人员）类型保值方案**支持：
- 期货交易指令

**无合同（客商）类型保值方案**支持：
- 期货交易指令

### 4.6 指令匹配规则

#### 4.6.1 期货匹配

**匹配功能**：
- 交易员可以将期货委托匹配到指令
- 匹配时需要指定匹配的期货数量
- 匹配后，更新指令的期货要求和匹配内容

**匹配约束**：
- 匹配的期货数量不能超过指令的所需数量
- 匹配的期货方向必须与指令要求一致
- 匹配的期货合约必须符合指令要求

#### 4.6.2 合同匹配

**匹配功能**：
- 制单员可以将创建的合同匹配到指令
- 匹配时需要指定匹配的合同数量
- 匹配后，更新指令的合同创建要求和匹配内容

**匹配约束**：
- 匹配的合同数量不能超过指令的所需数量
- 匹配的合同必须符合指令要求

### 4.7 点价指令特殊规则

#### 4.7.1 点价权限控制

**业务经理点价权限**：
- 如果指令发起人是业务经理角色，业务经理只能对合同字段"业务经理"是自己的合同发起点价
- 系统在创建点价指令时验证该约束

**指令员点价权限**：
- 如果是指令员，则可以对保值方案下的所有合同发起点价
- 不受业务经理字段限制

#### 4.7.2 点价指令撤销

**撤销规则**：
- 对于点价合同，需要发起人对点价指令进行撤销
- 撤销后，点价合同恢复为暂定价状态

### 4.8 性能优化建议

#### 4.8.1 查询优化

- 在查询未完成指令时，使用索引优化查询性能
- 缓存指令类型角色限定配置，减少数据库查询
- 批量查询多个权限配置，减少数据库交互次数

#### 4.8.2 界面优化

- 指令列表使用分页或虚拟滚动，提高加载速度
- 使用骨架屏或加载动画，提升用户体验
- 状态更新提示使用防抖机制，避免频繁刷新

#### 4.8.3 缓存机制

- 缓存权限配置数据，减少重复查询
- 缓存指令类型角色限定配置
- 权限配置变更时主动刷新缓存

### 4.9 异常处理

#### 4.9.1 权限验证异常

**权限不存在**：
- 如果用户尝试创建指令但权限不存在，提示"您没有在此保值方案下创建此指令类型的权限"
- 不显示创建按钮或禁用创建按钮

**权限已禁用**：
- 如果权限配置已被禁用，提示"该权限配置已禁用，请联系管理员"
- 在工作台不显示对应的指令创建入口

**角色不匹配**：
- 如果用户权限依赖的角色已被移除，提示"该权限需要XX角色，但您当前没有此角色，请联系管理员"
- 在权限列表中显示警告图标

#### 4.9.2 指令创建异常

**保值方案不支持**：
- 如果保值方案类型不支持该指令类型，提示"该保值方案类型不支持此指令类型"
- 在权限分配时就进行验证，避免创建时才发现

**限制条件不满足**：
- 如果不符合权限配置的限制条件（如品种、合约、方向、手数等），提示具体的限制条件
- 例如："您的权限限制期货合约为CU2401，不能选择其他合约"

#### 4.9.3 客商权限验证异常

**持仓超限**：
- 如果客商当前持仓超过限制，提示"您的当前持仓已超过限制（XX手），无法发起新的指令"
- 显示当前持仓和限制值

**有效期过期**：
- 如果权限有效期已过期，提示"该权限已过期（有效期至XX），请联系管理员续期"
- 不显示创建按钮

**单笔手数超限**：
- 如果单笔指令数量超过限制，提示"单笔指令数量不能超过XX手"
- 在创建指令时进行验证

### 4.10 后续扩展

如果后续版本中新增功能或修改业务规则，需要同步更新本文档，明确：
1. 新增功能的界面描述和操作流程
2. 新增字段的数据来源和计算公式
3. 新增数据一致性规则和约束条件
4. 新增异常处理规则

---

## 附录：字段类型说明

- **str**：字符串类型
- **int**：整数类型
- **decimal**：小数类型，用于金额、数量等
- **bool**：布尔类型，true/false
- **date**：日期类型
- **datetime**：日期时间类型
- **json_list**：JSON数组类型，用于存储多个值的列表
