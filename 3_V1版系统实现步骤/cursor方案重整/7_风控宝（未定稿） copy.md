# 风控宝产品方案

本文档描述风控宝模块的完整产品方案，包括界面功能、数据来源、计算公式、数据约束和补充说明。

**说明**：本文档为预备版本，包含需要澄清的问题，待问题确认后完善为正式方案。

---

## 一、界面功能描述

### 1.1 风控首页（保值方案视角）

风控首页用于以保值方案为主视角，汇总展示整体风险情况，帮助用户快速定位风险最大的方案和品种。

#### 1.1.1 布局结构

从上到下包含以下区域：

- **筛选区**  
  - 支持按保值方案（多选）、现货品种（多选）、品牌（多选）、交易日（单选）进行筛选。  
  - 交易日默认为当前交易日，支持切换历史交易日查看当日风险快照。

- **关键指标概览区**  
  - 在当前筛选条件下，展示系统级汇总指标：  
    - 总现货净敞口  
    - 总期货净敞口（按敞口系数折算）  
    - 总期现净敞口  
    - 总未匹配净敞口  
    - 触发事后风控阈值的保值方案数量（当日）  
  - 指标以数字+环形进度条的形式展示，当存在越界或接近越界时以颜色高亮。

- **保值方案风险列表区**  
  - 表格按保值方案维度展示风险指标，并按“未匹配净敞口绝对值”从大到小排序。  
  - 默认展示字段：  
    - 保值方案名称  
    - 现货净敞口  
    - 期货净敞口（折算后）  
    - 期现净敞口  
    - 未匹配净敞口（重点字段，支持点击钻取）  
    - 敞口比例（期货敞口 / 现货敞口）  
    - 敞口绝对值（现货敞口 - 期货敞口）  
    - 事后风控阈值命中状态（比例阈值、绝对值阈值是否越界）  
    - 风险标签（当日命中的事后风控检查项摘要，如“未配置敞口系数”“最后点价日未点完”等）  
  - 用户点击某一行保值方案，可进入保值方案详情页。

- **账户视角入口区**  
  - 在首页提供“账户视角”快捷入口，展示当前筛选条件下，各期货账户的持仓规模、净敞口和风险状态的简要排名列表，支持一键跳转到账户视角页面。

#### 1.1.2 表格操作

- 支持按保值方案名称、现货净敞口、期货净敞口、期现净敞口、敞口比例、敞口绝对值进行排序。  
- 支持按风险状态筛选：仅看“命中事后风控阈值”的保值方案，或仅看“未配置阈值”的保值方案。  
- 支持列配置：用户可自主选择是否显示某些高级字段（如风险标签列）。  
- 支持导出当前筛选条件下的保值方案风险列表为 Excel。

### 1.2 保值方案视角的敞口与库存风险页

保值方案详情页用于透视单一保值方案在不同品种、不同时间窗口内的敞口结构，重点识别未来 30 自然日内的超卖、超买风险。

#### 1.2.1 基本信息与整体概览

- 顶部展示当前保值方案的基本信息：方案名称、关联品种数、关联账户数、是否配置事后风控阈值等。  
- 展示该保值方案在当前交易日的整体风险指标：  
  - 现货净敞口、期货净敞口、期现净敞口、未匹配净敞口  
  - 方案层面的敞口比例、敞口绝对值及其与阈值的对比情况  
- 当方案命中任一事后风控检查项时，在页面顶部以醒目的风险提示条展示。

#### 1.2.2 品种/品牌维度的敞口视图

- 表格以“品种+品牌”为行，展示：  
  - 现货净敞口、期货净敞口、期现净敞口  
  - 未匹配净敞口  
  - 敞口比例、敞口绝对值  
  - 是否命中该品种维度的事后风控阈值（如有按品种拆分配置时）。  
- 用户可展开某一行查看更细的构成：  
  - 对应的合同列表（采购/销售及已采销关联情况）  
  - 对应的期货成交/持仓列表及期现关联情况。  
- 支持按“未匹配净敞口绝对值”排序，方便快速定位问题最大的品种。

#### 1.2.3 未来 30 日超卖/超买风险视图

- 提供“未来 30 日交割窗口”视图：  
  - 时间维度固定为“从当前交易日起滚动 30 个自然日内的交割期相关合同和事件”。  
- 在此窗口内，按“交割日期区间 + 品种/品牌”维度展示：  
  - 采购合同数量（含已采销关联量、未关联量）  
  - 销售合同数量（含已采销关联量、未关联量）  
  - 推导出的“潜在超卖量”（销售合同数量 > 采购合同数量，且采销关联不足的部分）  
  - 推导出的“潜在超买量”（采购合同数量 > 销售合同数量，且采销关联不足的部分）。  
- 当潜在超卖量或超买量大于 0 时，在对应行打上明显的风险标记，并生成对应的事后风控事件记录，供风控工作台汇总展示。

### 1.3 账户视角的敞口与持仓规模页

账户视角页面用于从期货账户维度审视整体持仓规模和净敞口，为交易通道侧的实时风控提供可视化补充。

#### 1.3.1 账户汇总列表

- 表格每行代表一个期货账户，展示：  
  - 账户名称、经纪商  
  - 总持仓手数、总市值  
  - 期货净敞口（折算后）  
  - 与账户维度风控设置（来自实时风控服务）的占用比例，如保证金占比、持仓规模占比等（具体字段与《7_1 实时交易风控服务》保持一致）。  
  - 当日命中的实时风控事件数量（如有挡单、预警记录）。  
- 支持点击账户行，进入账户详情页。

#### 1.3.2 账户详情与保值方案分布

- 在账户详情页中，按保值方案/品种拆分查看该账户的持仓与敞口贡献：  
  - 每个保值方案在该账户下的持仓手数、期货净敞口、对应的期现匹配情况。  
- 支持查看该账户在当日或指定交易日内的实时风控事件列表，便于事后复盘某次挡单或预警的原因。

### 1.4 风控设置页（事后风控阈值）

风控设置页用于集中配置和管理事后风控阈值，以及管理一部分无需录入数值、仅需开关控制的事后检查项。

#### 1.4.1 阈值配置列表

- 以保值方案为粒度，每个方案在同一种阈值类型下仅允许存在一条配置记录。  
- 支持配置以下两类阈值（对应《7_3 事后风控阈值》中的说明）：  
  - 保值方案敞口比例阈值：期货敞口 / 现货敞口 的上限、下限。  
  - 保值方案敞口绝对值阈值：现货敞口 - 期货敞口 的上限、下限。  
- 阈值配置可单独启用/禁用，默认禁用。启用后即参与每日事后风控计算并可能产生事件。

#### 1.4.2 无需录入数值的检查项管理

- 将以下事后检查项以“开关+说明”的形式配置，默认全部禁用，开启后参与每日事后风控计算（示例）：  
  - 有系统外报单被回收但没有标注保值方案；  
  - 有持仓今天过后就是交割月；  
  - 有持仓今天过后就是交割日；  
  - 当日未完成的指令；  
  - 虽然有保值方案但未被匹配期货成交；  
  - 超实时风控的操作记录；  
  - 期货账户登录异常；  
  - 节前最后交易日；  
  - 今天是最后点价期却没点完；  
  - 均价合同缺少均价标的价格；  
  - 点价点超了；  
  - 采销匹配数量越界；  
  - 未配置敞口系数和期货；  
  - tradingday 缺少现货价格。  
- 每个检查项可查看规则描述和示例，方便业务方理解含义。

### 1.5 风控工作台

风控工作台用于集中查看和处理由实时风控服务与事后风控阈值计算产生的所有风控事件。

#### 1.5.1 事件列表

- 统一展示以下类型的事件：  
  - 实时风控事件：委托前/委托后风控服务产生的“允许/拒绝/告警”记录；  
  - 事后风控事件：由阈值或检查项触发的敞口越界、超卖/超买、进度异常等记录。  
- 主要字段包括：  
  - 事件时间、事件类型（实时/事后）、风险类型（敞口、超卖、超买、配置缺失等）、保值方案、品种、账户、关联合同/指令/委托编号、简要描述、处理状态、处理人。  
- 支持按时间、保值方案、账户、事件类型、处理状态等条件筛选和排序。

#### 1.5.2 事件处理与穿透

- 用户可在工作台中对事件进行处理：标记为“已知晓”或“已处理”，并填写处理说明。  
- 支持从事件一键穿透到：  
  - 保值方案详情页；  
  - 相关合同详情；  
  - 相关指令/委托详情；  
  - 相关账户详情。

---

## 二、数据来源和相关计算公式

### 2.1 总体原则

风控宝的数据计算基于“model + 事件流水”的架构，所有风险指标均来自以下几类基础对象和事件：

- 基础 model：合同（采购/销售）、采销关联记录、期货委托/成交/持仓、保值方案配置、敞口系数配置。  
- 事件流水：点价事件、期现关联事件、采销关联事件。  
- 风控配置：事后风控阈值配置（敞口比例、敞口绝对值）、实时风控设置（由《7_1 实时交易风控服务》维护）。

风控宝不直接修改上述基础数据，只在此基础上进行汇总计算和阈值判断。

### 2.2 现货侧指标

#### 2.2.1 现货基础数量

- 以“保值方案 + 品种 + 品牌 + 交易日”为最小统计粒度（具体实现可根据性能需要适当简化）。  
- 对于采购合同：  
  - 合同数量、已销售数量、未销售数量等基础字段直接来自合同宝及采销关联记录。  
- 对于销售合同：  
  - 合同数量、已采购数量、未采购数量等基础字段直接来自合同宝及采销关联记录。  
- 仅统计状态为启用且未取消的合同记录；软删除或取消状态不参与当日敞口。

#### 2.2.2 现货净敞口

- 在保值方案维度：  
  - 采购侧有效数量 = 所有采购合同数量之和（扣除状态不合法的记录）。  
  - 销售侧有效数量 = 所有销售合同数量之和。  
  - 现货净敞口 = 采购侧有效数量 - 销售侧有效数量。  
- 在品种/品牌维度：  
  - 按“保值方案 + 品种 + 品牌”对上述数量进行进一步分组汇总。  
- 采销关联事件的作用：  
  - 用于区分“已通过采销关联对冲的数量”和“未关联的剩余数量”，为未来 30 日超卖/超买风险识别提供输入。

### 2.3 期货侧指标

#### 2.3.1 期货基础数量

- 期货成交/持仓数据来自交易宝和指令宝所在的委托/成交/持仓表。  
- 在保值方案维度：  
  - 通过委托/成交所在的保值方案（直接或通过指令类型和保值方案配置间接关联）进行归属。  
- 在账户维度：  
  - 直接按期货账户字段分组，统计买入手数、卖出手数、持仓手数等。

#### 2.3.2 期货净敞口（折算后）

- 对每一条成交/持仓记录，根据其关联的保值方案与品牌，获取对应的敞口系数。  
- 期货敞口数量（现货等价） = 期货手数 × 敞口系数。  
- 在某个维度（如保值方案或保值方案+品种）下：  
  - 期货净敞口 = 所有买入方向期货敞口之和 - 所有卖出方向期货敞口之和。  
- 若某条记录缺少敞口系数配置，则在风控计算时标记为“未配置敞口系数和期货”，生成对应事后风控事件。

### 2.4 期现匹配相关指标

#### 2.4.1 已匹配敞口

- 期现关联事件记录了现货数量与期货手数之间的匹配关系。  
- 在“保值方案 + 品种 + 品牌”粒度下：  
  - 已匹配现货敞口 = 所有期现关联记录中的现货数量之和。  
  - 已匹配期货敞口 = 所有期现关联记录中的期货手数 × 对应敞口系数之和。

#### 2.4.2 未匹配敞口与期现净敞口

- 未匹配现货敞口 = 现货净敞口 - 已匹配现货敞口。  
- 未匹配期货敞口 = 期货净敞口 - 已匹配期货敞口。  
- 期现净敞口（用于首页和方案详情展示）可按以下方式计算：  
  - 期现净敞口 = 现货净敞口 - 期货净敞口。  
- 对于风控首页的排序字段“未匹配净敞口绝对值”：  
  - 未匹配净敞口 = 未匹配现货敞口 - 未匹配期货敞口（如业务上需要区分，也可仅使用未匹配现货敞口）。  
  - 未匹配净敞口绝对值 = |未匹配净敞口|。

### 2.5 超卖/超买风险相关指标

#### 2.5.1 未来 30 日交割窗口

- 时间窗口定义为：从当前交易日起滚动 30 个自然日内，所有交割日期落在该区间内的合同和相关事件。  
- 该窗口内的采购合同数量、销售合同数量及采销关联数量，用于识别未来一个月的超卖与超买风险。

#### 2.5.2 超卖与超买判定

- 在“保值方案 + 品种 + 品牌 + 交割日期区间”粒度下：  
  - 采购总量 = 窗口内所有采购合同数量之和。  
  - 销售总量 = 窗口内所有销售合同数量之和.  
  - 采销已关联量 = 对应采销关联事件中的关联数量之和。  
- 潜在超卖量（找不到货风险）示例口径：  
  - 若销售总量 > 采购总量，且采销已关联量不足以覆盖销售总量，则  
    - 潜在超卖量 = max(0, 销售总量 - max(采购总量, 采销已关联量))。  
- 潜在超买量（库存积压风险）示例口径：  
  - 若采购总量 > 销售总量，且采销已关联量不足以覆盖采购总量，则  
    - 潜在超买量 = max(0, 采购总量 - max(销售总量, 采销已关联量))。  
- 当潜在超卖量或潜在超买量大于 0 时，在保值方案详情页的“未来 30 日视图”中标记风险，并生成对应事后风控事件。

### 2.6 事后风控阈值相关计算

#### 2.6.1 敞口比例阈值

- 在保值方案维度：  
  - 敞口比例 = 期货敞口 / 现货敞口。  
  - 当现货敞口为 0 且期货敞口不为 0 时，可直接视为“纯期货敞口”，按系统配置决定是否直接触发风险事件。  
- 用户可在事后风控阈值设置中，为每个保值方案配置敞口比例的上限、下限：  
  - 若敞口比例 > 上限或 < 下限，则触发“敞口比例越界”类型的事后风控事件。

#### 2.6.2 敞口绝对值阈值

- 在保值方案维度：  
  - 敞口绝对值 = 现货敞口 - 期货敞口。  
- 用户可为每个保值方案配置该绝对值的上限、下限：  
  - 若敞口绝对值 > 上限或 < 下限，则触发“敞口绝对值越界”类型的事后风控事件。

### 2.7 实时风控与事后风控的衔接

- 实时风控：由《7_1 实时交易风控服务》负责，对指令与委托在落地前/后的合规性进行即时判断（允许/拒绝/告警），并产生实时风控事件记录。  
- 事后风控：由风控宝基于当日收盘后的汇总数据和阈值配置，批量计算是否存在敞口越界、超卖/超买、配置缺失等风险，并产生事后风控事件记录。  
- 两者在风控工作台中统一展示，但数据来源与触发时机不同：  
  - 实时风控偏“动作/行为控制”；  
  - 事后风控偏“结果/状态审查”。

### 2.8 数据更新频率

- 实时风控相关数据（指令、委托、账户状态等）由实时风控服务和交易模块维护，风控宝主要消费其结果事件。  
- 敞口及事后风控相关汇总数据的更新建议策略：  
  - 当日盘中可按需触发增量计算（例如每 N 分钟或关键事件后刷新）；  
  - 当日收盘后进行一次完整汇总计算，形成当日的风险快照，用于第二天的风险回顾与报表。

---

## 三、数据一致性和数据约束

### 3.1 敞口数据一致性

#### 3.1.1 现货敞口一致性

**问题28：如何保证现货敞口数据的准确性？**
- 现货敞口是否应该等于合同表中的合同数量汇总？
- 是否需要校验已销售数量/已采购数量的一致性？
- 是否需要校验已点数量的一致性？

#### 3.1.2 期货敞口一致性

**问题29：如何保证期货敞口数据的准确性？**
- 期货敞口是否应该等于期货委托单表中的持仓汇总？
- 是否需要校验已匹配手数的一致性？
- 是否需要校验未匹配手数的一致性？

#### 3.1.3 期现匹配一致性

**问题30：如何保证期现匹配数据的一致性？**
- 期现关联记录的手数总和是否应该等于委托单的已匹配手数？
- 期现关联记录的现货数量总和是否应该等于合同的已点数量？
- 是否需要定期校验这些数据的一致性？

### 3.2 限额数据约束

#### 3.2.1 限额值约束

**问题31：限额值需要哪些约束？**
- 限额值是否必须大于0？
- 子限额的总和是否不能超过父限额？
- 限额值是否支持负数（表示禁止）？

#### 3.2.2 限额使用约束

**问题32：限额使用需要哪些约束？**
- 已使用限额是否不能超过总限额（允许超限预警）？
- 限额使用率超过100%时如何处理？
- 是否需要阻止超限操作（如阻止创建合同、阻止下单）？

### 3.3 风险预警约束

#### 3.3.1 预警触发约束

**问题33：预警触发的约束是什么？**
- 预警是否应该在数据更新时自动触发？
- 是否需要避免重复预警（同一事件只预警一次）？
- 预警是否需要确认机制？

#### 3.3.2 预警级别约束

**问题34：预警级别如何划分？**
- 是否需要多个预警级别（如低、中、高、严重）？
- 预警级别的划分标准是什么（如使用率80%为低、90%为中、100%为高）？

### 3.4 数据校验规则

**问题35：风控数据需要哪些校验规则？**
- 敞口数据是否应该定期校验？
- 限额数据是否应该定期校验？
- 是否需要数据修复机制？
- 校验失败时如何处理？

---

## 四、其他补充

### 4.1 权限控制

**问题36：风控宝需要哪些权限控制？**
- 是否需要区分查看权限和配置权限？
- 限额配置是否需要特殊权限？
- 风险预警是否需要特殊权限？
- 是否需要支持按保值方案限制权限？

### 4.2 数据权限

**问题37：风控数据是否需要数据权限控制？**
- 是否需要按保值方案限制数据查看范围？
- 是否需要按角色限制数据查看范围？
- 是否需要支持数据脱敏？

### 4.3 性能优化

**问题38：风控宝的性能优化需求是什么？**
- 敞口汇总计算是否需要缓存？
- 限额使用计算是否需要缓存？
- 是否需要异步计算风险指标？
- 大数据量下的查询性能如何保证？

### 4.4 实时性要求

**问题39：风控数据的实时性要求是什么？**
- 敞口数据是否需要实时更新？
- 限额使用是否需要实时更新？
- 风险预警是否需要实时触发？
- 不同数据的实时性要求是否不同？

### 4.5 历史数据

**问题40：风控数据是否需要保存历史记录？**
- 是否需要保存历史敞口数据（用于趋势分析）？
- 是否需要保存历史限额使用数据？
- 是否需要保存历史风险指标数据？
- 历史数据保存多长时间？

### 4.6 异常处理

**问题41：风控宝的异常处理规则是什么？**
- 数据计算失败时如何处理？
- 限额配置错误时如何处理？
- 预警系统故障时如何处理？
- 是否需要异常告警机制？

### 4.7 集成需求

**问题42：风控宝是否需要与其他模块集成？**
- 是否需要与合同宝集成（获取合同数据）？
- 是否需要与指令宝集成（获取指令数据）？
- 是否需要与交易宝集成（获取持仓数据）？
- 是否需要与匹配宝集成（获取匹配数据）？

### 4.8 扩展性

**问题43：风控宝的扩展性需求是什么？**
- 是否需要支持自定义风险指标？
- 是否需要支持自定义预警规则？
- 是否需要支持自定义限额类型？
- 是否需要支持插件化扩展？

---

## 待澄清问题汇总

本文档共提出43个问题，涉及以下方面：

1. **界面功能**（问题1-18）：界面布局、表格字段、筛选条件、操作功能、监控功能、限额管理、报表功能、事件记录
2. **数据计算**（问题19-27）：敞口计算、风险指标、限额计算、数据更新频率
3. **数据一致性**（问题28-35）：敞口一致性、限额约束、预警约束、数据校验
4. **其他补充**（问题36-43）：权限控制、性能优化、实时性、历史数据、异常处理、集成需求、扩展性

请逐一回答上述问题，以便完善风控宝产品方案。

---

## 附录：参考信息

### 参考文档
- 合同宝产品方案（1_合同宝.md）
- 指令宝产品方案（3_指令宝.md）
- 设计决策与问题澄清.md

### 相关概念
- **敞口**：指未对冲的风险暴露，包括现货敞口和期货敞口
- **限额**：指风险控制的上限，包括敞口限额、持仓限额等
- **风险指标**：用于衡量风险大小的量化指标，如风险度、VaR等
- **预警**：当风险超过阈值时触发的提醒机制
