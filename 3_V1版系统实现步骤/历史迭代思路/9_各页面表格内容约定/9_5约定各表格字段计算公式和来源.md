# 各表格字段计算公式和来源约定

本文档定义各个表格中计算字段的计算公式和数据来源。

## 一、合同表（contract）

### 计算字段

#### 1. 合同金额
- **计算公式**：合同金额 = 合同数量 × 单价
- **数据来源**：
  - 合同数量：来自"合同数量"字段（decimal）
  - 单价：来自"单价"字段（decimal）
- **说明**：
  - 如果合同数量或单价为空，合同金额显示为0或"-"
  - 在示意界面中，因为没有数据库逻辑，暂时不要求计算结果自洽

#### 2. 结算金额
- **计算公式**：结算金额 = 合同数量 × 结算单价
- **数据来源**：
  - 合同数量：来自"合同数量"字段（decimal）
  - 结算单价：来自"结算单价"字段（decimal）
- **说明**：
  - 如果合同数量或结算单价为空，结算金额显示为0或"-"
  - 在示意界面中，因为没有数据库逻辑，暂时不要求计算结果自洽

#### 3. 未点数量
- **计算公式**：未点数量 = 合同数量 - 已点数量
- **数据来源**：
  - 合同数量：来自"合同数量"字段（decimal）
  - 已点数量：来自"已点数量"字段（decimal，系统缺省为0）
- **说明**：
  - 未点数量是点价的结果，表示尚未点价的合同数量
  - 如果合同数量为空，未点数量显示为"-"
  - 如果已点数量大于合同数量，未点数量显示为0（不允许负数）

#### 4. 已销售数量（采购合同）
- **计算公式**：已销售数量 = SUM(采销关联记录中的关联数量)
- **数据来源**：
  - 采销关联记录：通过合同表关联采销关联关系表，查询该采购合同关联的所有销售合同
  - 关联数量：来自采销关联关系表中的"关联数量"字段（decimal）
- **说明**：
  - 仅适用于采购合同
  - 统计该采购合同已经关联销售的合同数量总和
  - 如果没有任何采销关联记录，已销售数量显示为0
  - 点击该字段可以弹出采销关系表格，查看详细的关联记录

#### 5. 已采购数量（销售合同）
- **计算公式**：已采购数量 = SUM(采销关联记录中的关联数量)
- **数据来源**：
  - 采销关联记录：通过合同表关联采销关联关系表，查询该销售合同关联的所有采购合同
  - 关联数量：来自采销关联关系表中的"关联数量"字段（decimal）
- **说明**：
  - 仅适用于销售合同
  - 统计该销售合同已经关联采购的合同数量总和
  - 如果没有任何采销关联记录，已采购数量显示为0
  - 点击该字段可以弹出采购关系表格，查看详细的关联记录

### 关联显示字段

#### 1. 保值方案名称
- **数据来源**：通过"保值方案_id"关联保值方案表，显示保值方案的"名称"字段

#### 2. 业务经理姓名
- **数据来源**：通过"业务经理"字段（人员ID）关联人员表，显示人员的"姓名"字段

#### 3. 供应商/客户简称
- **数据来源**：通过"供应商/客户"字段（客商ID）关联客商表，显示客商的"简称"字段
- **说明**：界面显示名称根据合同类型不同而不同（采购合同显示"供应商"，销售合同显示"客户"），但数据库字段是同一个

#### 4. 现货品种名称
- **数据来源**：通过"现货品种"字段（现货品种ID）关联现货品种表，显示现货品种的"名称"字段

#### 5. 品牌名称
- **数据来源**：通过"品牌"字段（品牌ID）关联品牌表，显示品牌的"名称"字段

#### 6. 创建人姓名
- **数据来源**：通过"创建人"字段（人员ID）关联人员表，显示人员的"姓名"字段

---

## 二、期货委托单表（entrust_order）

### 交易所提供字段（核心字段）

期货委托单、持仓、成交、平仓的字段有固定命名和用法，除了匹配、备注、合同、账户、保值方案、短编号等业务字段外，交易所提供的核心字段如下：

#### 委托单核心字段
- **报单编号**（str）：交易所报单编号
- **合约**（str）：期货合约代码
- **买卖**（str）：买入/卖出
- **开平**（str）：开仓/平仓
- **挂单状态**（str）：挂单状态
- **报单价格**（decimal）：报单价格
- **报单手数**（decimal）：报单手数
- **未成交手数**（decimal）：未成交手数
- **成交手数**（decimal）：成交手数
- **成交均价**（decimal）：成交均价
- **投保**（str）：投保类型
- **详细状态**（str）：详细状态
- **报单时间**（datetime）：报单时间
- **最后成交时间**（datetime）：最后成交时间
- **交易所**（str）：交易所名称

#### 持仓字段
- **合约**（str）：期货合约代码
- **买卖**（str）：买入/卖出
- **总持仓**（decimal）：总持仓手数
- **昨仓**（decimal）：昨日持仓手数
- **今仓**（decimal）：今日持仓手数
- **可平量**（decimal）：可平仓手数
- **持仓均价**（decimal）：持仓均价
- **持仓盈亏**（decimal）：持仓盈亏
- **开仓均价**（decimal）：开仓均价
- **浮动盈亏**（decimal）：浮动盈亏
- **实收保证金**（decimal）：实收保证金
- **投保**（str）：投保类型
- **交易所**（str）：交易所名称
- **可平今量**（decimal）：可平今仓手数
- **可平仓量**（decimal）：可平仓手数
- **今开仓量**（decimal）：今日开仓手数
- **今平仓量**（decimal）：今日平仓手数
- **最新价**（decimal）：最新价格

#### 成交字段
- **成交编号**（str）：成交编号
- **合约**（str）：期货合约代码
- **买卖**（str）：买入/卖出
- **开平**（str）：开仓/平仓
- **成交价格**（decimal）：成交价格
- **成交手数**（decimal）：成交手数
- **手续费**（decimal）：手续费
- **平仓盈亏**（decimal）：平仓盈亏
- **逐笔平仓盈亏**（decimal）：逐笔平仓盈亏
- **投保**（str）：投保类型
- **成交时间**（datetime）：成交时间
- **成交类型**（str）：成交类型
- **交易所**（str）：交易所名称
- **报单编号**（str）：关联的报单编号

#### 平仓记录字段
- **合约**（str）：期货合约代码
- **持仓方向**（str）：持仓方向
- **投保**（str）：投保类型
- **开仓价格**（decimal）：开仓价格
- **开仓日期**（date）：开仓日期
- **开仓时间**（datetime）：开仓时间
- **开仓成交号**（str）：开仓成交编号
- **平仓价格**（decimal）：平仓价格
- **平仓手数**（decimal）：平仓手数
- **逐笔平仓盈亏**（decimal）：逐笔平仓盈亏
- **平仓盈亏**（decimal）：平仓盈亏
- **平仓日期**（date）：平仓日期
- **平仓时间**（datetime）：平仓时间
- **平仓成交号**（str）：平仓成交编号
- **交易所**（str）：交易所名称

### 业务字段

#### 1. 保值方案_id（int）
- **数据来源**：关联的保值方案ID
- **关联显示**：保值方案名称

#### 2. 指令_id（int）
- **数据来源**：关联的指令编号

#### 3. 短编号（str）
- **数据来源**：众期短编号

#### 4. 委托备注（str）
- **数据来源**：委托备注（支持富文本）

#### 5. 备注（str）
- **数据来源**：备注信息

### 计算字段

#### 1. 未匹配手数
- **计算公式**：未匹配手数 = 成交手数 - 已匹配手数
- **数据来源**：
  - 成交手数：来自交易所的"成交手数"字段
  - 已匹配手数：来自业务字段"已匹配手数"（decimal）
- **说明**：
  - 如果成交手数为空，未匹配手数显示为"-"
  - 如果已匹配手数大于成交手数，未匹配手数显示为0（不允许负数）

#### 2. 是否已匹配
- **计算公式**：是否已匹配 = 已匹配手数 > 0
- **数据来源**：
  - 已匹配手数：来自业务字段"已匹配手数"（decimal）
- **说明**：
  - 如果已匹配手数 > 0，显示"是"
  - 如果已匹配手数 = 0，显示"否"

### 关联弹出框中的使用

#### 合同关联弹出框 - 期现关联标签页

##### 期货列表数据来源
- **数据来源**：显示同保值方案的期货委托单
- **筛选条件**：
  - 保值方案_id = 当前合同的保值方案_id
  - 指令_id = null（未指定指令编号的委托单）
  - 成交手数 > 0（必须有成交记录）
- **排序规则**：
  - 未匹配手数 > 0 的委托单优先显示（靠上显示）
  - 在未匹配手数 > 0 的记录中，按未匹配手数降序排序（未匹配手数大的在前）
  - 如果未匹配手数相同，按成交日期降序排序（最近的在前）

##### 表格字段说明

表格显示的字段包括：

1. **账户**
   - **数据来源**：通过"账户_id"关联期货账户表，显示期货账户的名称或别名
   - **关联字段**：账户_id（int）

2. **买卖**
   - **数据来源**：来自交易所的"买卖"字段（str）
   - **显示值**：买入/卖出

3. **开平**
   - **数据来源**：来自交易所的"开平"字段（str）
   - **显示值**：开仓/平仓

4. **合约**
   - **数据来源**：来自交易所的"合约"字段（str）
   - **显示值**：期货合约代码

5. **成交日期**
   - **数据来源**：从"最后成交时间"字段提取日期部分
   - **显示值**：成交日期

6. **价格**
   - **数据来源**：来自交易所的"成交均价"字段（decimal）
   - **显示值**：成交均价

7. **期货数量**
   - **说明**：用户输入字段，用于指定关联的期货数量
   - **数据类型**：decimal

8. **合同数量**
   - **说明**：用户输入字段，用于指定关联的合同数量
   - **数据类型**：decimal

9. **发生时间**
   - **说明**：用户输入字段（可选），用于指定关联发生的时间
   - **数据类型**：datetime
   - **默认值**：如果用户不填写，默认为当前时间

##### 表格自定义列功能
- 弹出框中的表格支持自定义列功能
- 用户可以通过列配置功能显示期货委托单的所有字段
- 可选字段包括但不限于：指令编号、短编号、成交手数、已匹配手数、未匹配手数、挂单状态、委托备注等

##### 匹配操作后的状态变更

当用户完成期现关联匹配操作后，系统会自动进行以下处理：

1. **更新委托单的已匹配手数**
   - 计算公式：已匹配手数（新）= 已匹配手数（旧）+ 本次匹配的期货数量
   - 更新委托单表中的"已匹配手数"字段

2. **更新委托单的未匹配手数**
   - 计算公式：未匹配手数（新）= 成交手数 - 已匹配手数（新）
   - 自动重新计算

3. **创建或更新期现备注记录**
   - 如果委托单已有期现备注，会增加新的关联记录
   - 如果委托单没有期现备注，会自动创建期现备注记录
   - 期现备注记录包含：委托单ID、合同ID、手数等信息

4. **更新期现备注的匹配状态**
   - 自动将期现备注的"是否已匹配"状态标为"是"
   - 如果期现备注的手数全部匹配完成，状态设置为"已匹配"

5. **更新委托单的匹配状态**
   - 如果已匹配手数 > 0，委托单的"是否已匹配"状态自动更新为"是"

---

## 三、期现备注表（spot_futures_remark）

### 关联显示字段

#### 1. 委托单短编号
- **数据来源**：通过"委托_id"关联期货委托单表，显示委托单的"短编号"字段

#### 2. 客商简称
- **数据来源**：通过"客商_id"关联客商表，显示客商的"简称"字段

#### 3. 合同编号
- **数据来源**：通过"合同_id"关联合同表，显示合同的"合同编号"字段

---

## 四、其他表格

### 客商表（customer）
- 无计算字段

### 现货品种表（spot_variety）
- 无计算字段

### 品牌表（spot_brand）
- 无计算字段

### 人员表（person/user）
- 无计算字段

### 角色表（role）

#### 1. 人员数量
- **计算公式**：人员数量 = 人员列表（json_list）的长度
- **数据来源**：
  - 人员列表：来自"人员列表"字段（json_list类型）
- **说明**：
  - 统计该角色关联的人员总数

### 保值方案表（hedge_plan）
- 无计算字段

---

## 五、通用规则

### 1. 计算字段显示规则
- 计算字段在表格中显示时，应该实时计算并显示
- 如果计算所需的基础字段为空，计算字段应该显示为"-"或"0"（根据业务逻辑决定）
- 计算字段通常不允许用户直接编辑，但可以通过编辑基础字段来影响计算结果

### 2. 计算字段排序规则
- 计算字段支持排序功能
- 排序时应该基于计算结果进行排序

### 3. 计算字段筛选规则
- 计算字段可以用于筛选
- 筛选时应该基于计算结果进行筛选

### 4. 示意界面说明
- 在示意界面（prototype.html）中，因为没有数据库逻辑，暂时不要求计算结果自洽
- 示意界面中的计算字段可以使用模拟数据，不需要严格按照计算公式计算

---

## 六、后续扩展

如果后续版本中新增表格或修改表格结构，需要同步更新本文档，明确：
1. 计算字段的计算公式
2. 关联显示字段的数据来源
3. 计算字段的显示和筛选规则
