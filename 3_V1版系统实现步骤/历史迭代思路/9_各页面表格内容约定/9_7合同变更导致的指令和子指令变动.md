# 合同变更导致的指令和子指令变动实现方案

本文档定义合同变更（创建、编辑、删除）时，对相关指令和子指令的处理规则和实现方案。
本文的合同变更单指对合同数量的增减，有些情况只变更合同内容，有些合同变更会调用合同变更指令完成
补充：合同变更指令应该是先变更合同内容，再进行指令或子指令操作

**说明**：关于数据一致性和数据约束的详细内容，请参考 `9_6约定各表格数据一致性和数据约束.md` 文档。

---

## 核心规则总结

### 指令处理规则

1. **均价合同（无论是单单还是整体）**：
   - 一律自动变更父指令（创建或更新子指令）
   - 重新计算父指令所需数量
   - 适用于：
     - 整体类型：保值方案均价净值套保指令
     - 单单类型：均价合同套保指令

2. **整体非均价合同**：
   - 自动变更父指令（创建或更新子指令）
   - 重新计算父指令所需数量
   - 适用于：保值方案净值套保指令

3. **单单非均价合同**：
   - 不处理相关指令（不撤销、不修改、不创建新指令）
   - 只显示提示信息，允许直接保存合同变更
   - 由相关人员后续手动处理
   - 适用于：非均价合同套保指令

### 合同变更保存规则

- **所有场景都允许保存合同变更**，不阻止合同数据的更新
- 对于需要处理指令的场景，在保存合同变更的同时处理指令
- 对于不需要处理指令的场景，只保存合同变更，不处理指令

---

## 一、功能概述

#### 1.1 核心功能
在合同创建、编辑、删除的弹出框中，系统需要：
- **显示未完成指令区域**：显示合同当前的未完成相关指令列表
- **预算变更影响区域**：实时计算并显示当前变更会导致的需期货交易数量变更数值

#### 1.2 触发时机
- **创建合同时**：显示预算区域（如果有默认数量），不显示未完成指令（新合同无历史指令）
- **编辑合同时**：显示未完成指令区域和预算变更影响区域
- **删除合同时**：显示未完成指令区域和预算变更影响区域（合同取消等同于数量变更为0）

---

## 二、弹出框显示区域设计

#### 2.1 未完成指令显示区域

##### 2.1.1 显示位置
- 位于合同创建/编辑/删除弹出框的下方区域
- 使用独立的折叠面板或卡片组件展示
- 标题为"未完成相关指令"

##### 2.1.2 查询条件
系统需要查询以下条件的指令：
- **关联关系**：
  - 指令直接关联到当前合同（合同ID匹配）
  - 或指令关联到当前合同所属的保值方案（保值方案ID匹配，且指令类型为整体类型）
- **指令状态**：状态为"待完成"或"撤销待处理"
- **指令类型**：包含以下类型之一
  - 均价合同套保指令（单单类型）
  - 非均价合同套保指令（单单类型）
  - 均价合同变更指令（子指令）
  - 非均价合同变更指令（子指令）
  - 保值方案净值套保指令（整体类型，父指令）
  - 保值方案均价净值套保指令（整体类型，父指令）

##### 2.1.3 显示内容
每条指令显示以下信息：
- **指令编号**：指令的唯一标识
- **指令类型**：指令的类型名称
- **指令状态**：待完成/撤销待处理
- **保值方案**：关联的保值方案名称
- **期货要求**：
  - 合约代码
  - 买卖方向
  - 所需数量（手数）
  - 价格要求（如有）
- **父指令编号**：如果是子指令，显示父指令编号
- **创建时间**：指令的创建日期时间
- **发起人**：指令的发起人姓名

##### 2.1.4 交互功能
- **查看详情**：点击指令行可以查看指令的详细信息
- **撤销指令**：对于"待完成"状态的指令，提供快捷撤销按钮（可选功能，用户可以根据需要自行决定是否撤销）
- **折叠/展开**：支持折叠面板，默认展开

#### 2.2 预算变更影响显示区域

##### 2.2.1 显示位置
- 位于合同创建/编辑/删除弹出框的下方区域
- 在未完成指令显示区域的上方或下方
- 使用警告样式（黄色背景）或信息样式（蓝色背景）展示
- 标题为"变更影响预算"

##### 2.2.2 显示时机
- **创建合同时**：如果用户输入了合同数量，显示预算信息
- **编辑合同时**：当用户修改合同数量时，实时计算并显示
- **取消合同时**：显示合同取消的影响（变更数量 = 0 - 原合同数量）

##### 2.2.3 计算规则

###### 变更数量计算
- **变更数量** = 变更后合同数量 - 变更前合同数量
- **变更前合同数量**：编辑时为原合同数量，创建时为0，删除时为原合同数量
- **变更后合同数量**：编辑时为新的合同数量，创建时为输入的合同数量，删除时为0

###### 敞口系数获取
- 从合同关联的保值方案中获取
- 根据合同的品牌配置，查找对应的期货敞口系数
- 如果保值方案中有多个品牌配置，使用当前合同品牌对应的敞口系数
- 如果找不到对应的敞口系数，使用默认值1.0或提示用户配置

###### 变更所需期货计算
- **变更所需期货数量（手数）** = 变更数量 × 敞口系数
- 如果变更数量为正数（增加），变更所需期货为正数（需要买入）
- 如果变更数量为负数（减少），变更所需期货为负数（需要卖出）
- 如果变更数量为0，变更所需期货为0（无影响）

##### 2.2.4 显示内容
预算区域显示以下信息：
- **变更前合同数量**：原合同数量（编辑/删除时显示）
- **变更后合同数量**：新合同数量（编辑/创建时显示）
- **变更数量**：变更的绝对值，标注增加或减少
- **敞口系数**：使用的敞口系数值
- **变更所需期货数量**：计算得出的期货交易数量（手数），标注买入或卖出
- **影响的指令列表**：列出会受到影响的指令编号和类型

##### 2.2.5 实时更新
- 当用户在弹出框中修改合同数量时，预算区域实时更新
- 计算延迟不超过500毫秒，确保用户体验流畅
- 如果计算失败，显示错误提示

---

## 三、合同变更处理逻辑

#### 3.1 场景判断流程

当用户保存合同变更（创建/编辑/删除）时，系统按以下顺序判断场景：

**第一步：检查是否存在未完成的单单类型父指令（均价）**
- 查询条件：
  - 指令关联的合同ID = 当前合同ID
  - 指令类型 = "均价合同套保指令"
  - 指令状态 = "待完成"
- 如果存在 → **进入场景3.1处理**（单单均价，自动变更子指令）

**第一步（续）：检查是否存在未完成的单单类型父指令（非均价）**
- 查询条件：
  - 指令关联的合同ID = 当前合同ID
  - 指令类型 = "非均价合同套保指令"
  - 指令状态 = "待完成"
- 如果存在 → **进入场景3.2处理**（单单非均价，手工处理）

**第二步：检查是否存在未完成的整体类型父指令（均价自动指令）**
- 查询条件：
  - 指令关联的保值方案ID = 当前合同所属保值方案ID
  - 指令类型 = "保值方案均价净值套保指令"
  - 指令状态 = "待完成"
  - 指令的创建日期 = 当前交易日
  - 该保值方案在"均价自动指令启停"中处于"启动"状态
- 如果存在 → **进入场景1处理**

**第三步：检查是否存在未完成的整体类型父指令（非均价）**
- 查询条件：
  - 指令关联的保值方案ID = 当前合同所属保值方案ID
  - 指令类型 = "保值方案净值套保指令" 或 "保值方案均价净值套保指令"
  - 指令状态 = "待完成"
  - 指令的创建日期 = 当前交易日
- 如果存在 → **进入场景2处理**

**第四步：无匹配场景**
- 如果以上场景都不满足 → **进入场景4处理**

#### 3.2 场景1：保值方案中有针对均价合同的自动指令

##### 3.2.1 场景描述
- 合同所属保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
- 存在该保值方案的未完成父指令（保值方案均价净值套保指令），且指令创建日期为当前交易日
- 合同为均价合同（计价方式 = "均价"）

##### 3.2.2 处理流程

**步骤1：验证变更合法性**
- 检查变更数量是否不为0
- 检查敞口系数是否已配置
- 如果验证失败，阻止保存并提示错误

**步骤2：创建或更新子指令**
- 查询是否存在该合同的未完成子指令（均价合同变更指令）
  - 如果存在：更新子指令的数量影响
  - 如果不存在：创建新的子指令
- 子指令信息：
  - **指令类型**：均价合同变更指令
  - **父指令ID**：关联到父指令（保值方案均价净值套保指令）
  - **合同ID**：当前合同ID
  - **保值方案ID**：当前合同所属保值方案ID
  - **子指令数量影响**：变更数量（合同数量的变化值）
  - **变更所需期货**：变更数量 × 敞口系数
  - **变更前现货敞口**：变更前的合同数量
  - **变更后现货敞口**：变更后的合同数量
  - **变更前期货数量**：根据变更前的合同数量计算（变更前合同数量 × 敞口系数）
  - **变更后期货数量**：根据变更后的合同数量计算（变更后合同数量 × 敞口系数）
  - **指令状态**：待完成
  - **创建日期时间**：当前时间
  - **交易日**：当前交易日

**步骤3：重新计算父指令所需数量**
- 查询父指令的所有子指令（包括新创建/更新的子指令）
- 计算父指令的所需数量：
  - 父指令所需数量 = 所有子指令的"变更所需期货"之和
  - 如果计算结果为负数，取绝对值（因为指令数量不能为负数）
- 更新父指令的所需数量字段

**步骤4：更新合同信息**
- 保存合同的变更信息
- 更新合同数量、合同金额等相关字段

**步骤5：记录操作日志**
- 记录合同变更操作
- 记录子指令创建/更新操作
- 记录父指令数量重新计算操作

##### 3.2.3 数据一致性保证
- 所有操作必须在同一个数据库事务中完成
- 如果任何一步失败，整个操作回滚
- 确保合同、指令、子指令的数据同时更新或同时回滚

#### 3.3 场景2：有针对整体的保值方案发出当日指令

##### 3.3.1 场景描述
- 存在该合同所属保值方案的未完成父指令
- 父指令类型为"保值方案净值套保指令"或"保值方案均价净值套保指令"（整体类型）
- 父指令的创建日期为当前交易日
- 父指令状态为"待完成"

##### 3.3.2 处理流程

**步骤1：验证变更合法性**
- 检查变更数量是否不为0
- 检查敞口系数是否已配置
- 如果验证失败，阻止保存并提示错误

**步骤2：判断子指令类型**
- 如果合同计价方式 = "均价"：
  - 子指令类型 = "均价合同变更指令"
- 如果合同计价方式 ≠ "均价"：
  - 子指令类型 = "非均价合同变更指令"

**步骤3：创建或更新子指令**
- 查询是否存在该合同的未完成子指令（对应类型的变更指令）
  - 如果存在：更新子指令的数量影响
  - 如果不存在：创建新的子指令
- 子指令信息：
  - **指令类型**：均价合同变更指令 或 非均价合同变更指令
  - **父指令ID**：关联到父指令（保值方案净值套保指令 或 保值方案均价净值套保指令）
  - **合同ID**：当前合同ID
  - **保值方案ID**：当前合同所属保值方案ID
  - **子指令数量影响**：变更数量（合同数量的变化值）
  - **变更所需期货**：变更数量 × 敞口系数
  - **变更前现货敞口**：变更前的合同数量
  - **变更后现货敞口**：变更后的合同数量
  - **变更前期货数量**：根据变更前的合同数量计算（变更前合同数量 × 敞口系数）
  - **变更后期货数量**：根据变更后的合同数量计算（变更后合同数量 × 敞口系数）
  - **指令状态**：待完成
  - **创建日期时间**：当前时间
  - **交易日**：当前交易日

**步骤4：重新计算父指令所需数量**
- 查询父指令的所有子指令（包括新创建/更新的子指令）
- 计算父指令的所需数量：
  - 父指令所需数量 = 所有子指令的"变更所需期货"之和
  - 如果计算结果为负数，取绝对值
- 更新父指令的所需数量字段

**步骤5：更新合同信息**
- 保存合同的变更信息
- 更新合同数量、合同金额等相关字段

**步骤6：记录操作日志**
- 记录合同变更操作
- 记录子指令创建/更新操作
- 记录父指令数量重新计算操作

##### 3.3.3 数据一致性保证
- 所有操作必须在同一个数据库事务中完成
- 如果任何一步失败，整个操作回滚
- 确保合同、指令、子指令的数据同时更新或同时回滚

#### 3.4 场景3：有针对单单保值方案的当前合同未完成当日指令

##### 3.4.1 场景3.1：单单均价合同套保指令（自动变更子指令）

###### 3.4.1.1 场景描述
- 存在针对该合同的未完成父指令
- 父指令类型为"均价合同套保指令"（单单类型，均价）
- 父指令状态为"待完成"
- **说明**：单单的均价合同因为有每日自动发出机制，应该自动变更子指令处理

###### 3.4.1.2 处理流程

**步骤1：验证变更合法性**
- 检查变更数量是否不为0
- 检查敞口系数是否已配置
- 如果验证失败，阻止保存并提示错误

**步骤2：创建或更新子指令**
- 查询是否存在该合同的未完成子指令（均价合同变更指令）
  - 如果存在：更新子指令的数量影响
  - 如果不存在：创建新的子指令
- 子指令信息：
  - **指令类型**：均价合同变更指令
  - **父指令ID**：关联到父指令（均价合同套保指令）
  - **合同ID**：当前合同ID
  - **保值方案ID**：当前合同所属保值方案ID
  - **子指令数量影响**：变更数量（合同数量的变化值）
  - **变更所需期货**：变更数量 × 敞口系数
  - **变更前现货敞口**：变更前的合同数量
  - **变更后现货敞口**：变更后的合同数量
  - **变更前期货数量**：根据变更前的合同数量计算（变更前合同数量 × 敞口系数）
  - **变更后期货数量**：根据变更后的合同数量计算（变更后合同数量 × 敞口系数）
  - **指令状态**：待完成
  - **创建日期时间**：当前时间
  - **交易日**：当前交易日

**步骤3：重新计算父指令所需数量**
- 查询父指令的所有子指令（包括新创建/更新的子指令）
- 计算父指令的所需数量：
  - 父指令所需数量 = 所有子指令的"变更所需期货"之和
  - 如果计算结果为负数，取绝对值（因为指令数量不能为负数）
- 更新父指令的所需数量字段

**步骤4：更新合同信息**
- 保存合同的变更信息
- 更新合同数量、合同金额等相关字段

**步骤5：记录操作日志**
- 记录合同变更操作
- 记录子指令创建/更新操作
- 记录父指令数量重新计算操作

###### 3.4.1.3 数据一致性保证
- 所有操作必须在同一个数据库事务中完成
- 如果任何一步失败，整个操作回滚
- 确保合同、指令、子指令的数据同时更新或同时回滚

##### 3.4.2 场景3.2：单单非均价合同套保指令（手工处理）

###### 3.4.2.1 场景描述
- 存在针对该合同的未完成父指令
- 父指令类型为"非均价合同套保指令"（单单类型，非均价）
- 父指令状态为"待完成"
- **说明**：单单的非均价合同全部需要手工处理，不自动变更指令

###### 3.4.2.2 处理流程

**步骤1：检测未完成指令**
- 系统检测到存在未完成的非均价单单类型父指令
- **不阻止合同变更**，允许直接保存合同变更
- 在弹出框中显示提示信息（仅提示，不阻止操作）

**步骤2：提示信息显示**
- 提示内容：
  - "该合同存在未完成的套保指令（非均价），合同变更后，请相关人员核对指令是否需要调整"
  - 显示未完成指令的编号、类型、状态、所需数量
  - 提供"查看指令详情"按钮（可选）
- 提示样式：使用警告样式（黄色背景），但不阻止保存

**步骤3：保存合同变更**
- 直接保存合同的变更信息
- 更新合同数量、合同金额等相关字段
- **不处理相关指令**（不撤销、不修改、不创建新指令）
- 指令保持原状，由相关人员后续手动处理

**步骤4：记录操作日志**
- 记录合同变更操作
- 记录提示信息（存在未完成指令但已允许变更）
- 不记录指令相关操作

###### 3.4.2.3 业务规则说明

**为什么不处理指令**：
- 非均价合同套保指令不是自动发出的，需要人工判断和处理
- 系统无法判断交易员是否已经根据原指令执行了部分或全部期货交易
- 如果自动撤销或修改指令，可能导致已完成的交易与指令不匹配
- 合同变更和指令调整应该由业务人员根据实际情况决定
- 保持合同数据和指令数据的独立性，避免自动操作带来的风险

**为什么允许直接变更合同**：
- 合同变更可能来自外部系统（如ERP），需要保证数据同步的及时性
- 合同数据是基础数据，应该允许及时更新
- 指令的调整可以在合同变更后，由相关人员根据实际情况处理

**后续处理建议**：
- 合同变更后，系统可以在指令管理界面标记相关指令，提醒相关人员核对
- 相关人员可以根据新的合同数量，决定是否需要调整指令或重新发起指令
- 如果指令已部分完成交易，需要人工判断如何处理

###### 3.4.2.4 特殊情况处理

**如果存在多个未完成的非均价单单类型指令**：
- 列出所有未完成的指令
- 提示信息中显示所有相关指令
- 允许直接保存合同变更，不处理任何指令

**如果合同变更为取消（数量变为0）**：
- 合同状态更新为"取消"（不是"删除"）
- 合同数量更新为0
- 现货敞口更新为0
- 不处理相关指令，由相关人员后续决定如何处理指令

**合同取消的定义**：
- **合同状态**：设置为"取消"（delete状态，但语义是"取消"）
- **合同数量**：必须为0
- **现货敞口**：必须为0
- **说明**：取消代表合同不再生效，数量为0，现货敞口也是0，但合同记录仍然保留在系统中（软删除）

#### 3.5 场景4：没有上述情况

##### 3.5.1 场景描述
- 不存在未完成的单单类型父指令（场景3.1和场景3.2不满足）
- 不存在未完成的整体类型父指令（场景1和场景2不满足）
- 或者存在的指令状态不是"待完成"（已完成、已撤销等）

##### 3.5.2 处理流程

**步骤1：直接保存合同变更**
- 系统不创建或更新任何指令
- 直接保存合同的变更信息
- 更新合同数量、合同金额等相关字段

**步骤2：记录操作日志**
- 记录合同变更操作
- 不记录指令相关操作

##### 3.5.3 说明
- 合同数量变更不会影响当日指令
- 如果后续需要针对该合同发起指令，可以在指令管理模块中手动发起
- 或者等待自动指令机制（如果配置了）在下一个交易日自动发起

---

## 四、场景穷举

#### 4.1 合同创建场景

##### 场景1.1：创建均价合同，存在整体类型父指令（均价自动指令启动）
- **条件**：
  - 合同计价方式 = "均价"
  - 保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
  - 存在该保值方案的未完成父指令（保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：创建子指令（均价合同变更指令），变更数量 = 新合同数量，变更所需期货 = 新合同数量 × 敞口系数

##### 场景1.2：创建均价合同，存在整体类型父指令（非自动指令）
- **条件**：
  - 合同计价方式 = "均价"
  - 存在该保值方案的未完成父指令（保值方案净值套保指令 或 保值方案均价净值套保指令），创建日期为当前交易日
  - 但"均价自动指令启停"中未启动或不存在
- **处理**：创建子指令（均价合同变更指令），变更数量 = 新合同数量，变更所需期货 = 新合同数量 × 敞口系数

##### 场景1.3：创建非均价合同，存在整体类型父指令
- **条件**：
  - 合同计价方式 ≠ "均价"（一口价或暂定价）
  - 存在该保值方案的未完成父指令（保值方案净值套保指令），创建日期为当前交易日
- **处理**：创建子指令（非均价合同变更指令），变更数量 = 新合同数量，变更所需期货 = 新合同数量 × 敞口系数

##### 场景1.4：创建合同，不存在相关父指令
- **条件**：
  - 不存在未完成的父指令（任何类型）
- **处理**：直接保存合同，不创建指令

#### 4.2 合同编辑场景（数量增加）

##### 场景2.1：均价合同数量增加，存在整体类型父指令（均价自动指令启动）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
  - 存在该保值方案的未完成父指令（保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 如果已存在该合同的子指令：更新子指令，变更数量 = +50，变更所需期货 = +50 × 敞口系数
  - 如果不存在子指令：创建子指令，变更数量 = +50，变更所需期货 = +50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景2.2：均价合同数量增加，存在整体类型父指令（非自动指令）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 存在该保值方案的未完成父指令（保值方案净值套保指令 或 保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = +50，变更所需期货 = +50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景2.3：非均价合同数量增加，存在整体类型父指令
- **条件**：
  - 合同计价方式 ≠ "均价"
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 存在该保值方案的未完成父指令（保值方案净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（非均价合同变更指令），变更数量 = +50，变更所需期货 = +50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景2.4：合同数量增加，存在单单类型父指令（均价）
- **条件**：
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 存在该合同的未完成父指令（均价合同套保指令）
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = +50，变更所需期货 = +50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景2.5：合同数量增加，存在单单类型父指令（非均价）
- **条件**：
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 存在该合同的未完成父指令（非均价合同套保指令）
- **处理**：
  - 显示提示信息（存在未完成指令）
  - 直接保存合同变更
  - 不处理相关指令

##### 场景2.6：合同数量增加，不存在相关父指令
- **条件**：
  - 原合同数量 = 100，新合同数量 = 150（增加50）
  - 不存在未完成的父指令
- **处理**：直接保存合同，不创建指令

#### 4.3 合同编辑场景（数量减少）

##### 场景3.1：均价合同数量减少，存在整体类型父指令（均价自动指令启动）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
  - 存在该保值方案的未完成父指令（保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 如果已存在该合同的子指令：更新子指令，变更数量 = -50，变更所需期货 = -50 × 敞口系数（负数，表示需要卖出）
  - 如果不存在子指令：创建子指令，变更数量 = -50，变更所需期货 = -50 × 敞口系数
  - 重新计算父指令所需数量（父指令所需数量可能减少）

##### 场景3.2：均价合同数量减少，存在整体类型父指令（非自动指令）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 存在该保值方案的未完成父指令（保值方案净值套保指令 或 保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = -50，变更所需期货 = -50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景3.3：非均价合同数量减少，存在整体类型父指令
- **条件**：
  - 合同计价方式 ≠ "均价"
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 存在该保值方案的未完成父指令（保值方案净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（非均价合同变更指令），变更数量 = -50，变更所需期货 = -50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景3.4：合同数量减少，存在单单类型父指令（均价）
- **条件**：
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 存在该合同的未完成父指令（均价合同套保指令）
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = -50，变更所需期货 = -50 × 敞口系数
  - 重新计算父指令所需数量

##### 场景3.5：合同数量减少，存在单单类型父指令（非均价）
- **条件**：
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 存在该合同的未完成父指令（非均价合同套保指令）
- **处理**：
  - 显示提示信息（存在未完成指令）
  - 直接保存合同变更
  - 不处理相关指令

##### 场景3.6：合同数量减少，不存在相关父指令
- **条件**：
  - 原合同数量 = 150，新合同数量 = 100（减少50）
  - 不存在未完成的父指令
- **处理**：直接保存合同，不创建指令

#### 4.4 合同编辑场景（数量不变，其他字段变更）

##### 场景4.1：合同数量不变，只修改其他字段（单价、交割日期等）
- **条件**：
  - 合同数量不变
  - 只修改了单价、交割日期、运输方式等其他字段
- **处理**：
  - 直接保存合同变更
  - 不创建或更新指令
  - 不重新计算父指令所需数量

#### 4.5 合同删除场景

##### 场景5.1：删除均价合同，存在整体类型父指令（均价自动指令启动）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 100
  - 保值方案在"均价自动指令启停"中配置了"保值方案均价净值套保指令"且状态为"启动"
  - 存在该保值方案的未完成父指令（保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = -100（合同取消），变更所需期货 = -100 × 敞口系数
  - 重新计算父指令所需数量
  - 标记合同为"已删除"状态（软删除）

##### 场景5.2：删除均价合同，存在整体类型父指令（非自动指令）
- **条件**：
  - 合同计价方式 = "均价"
  - 原合同数量 = 100
  - 存在该保值方案的未完成父指令（保值方案净值套保指令 或 保值方案均价净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = -100，变更所需期货 = -100 × 敞口系数
  - 重新计算父指令所需数量
  - 标记合同为"已删除"状态

##### 场景5.3：删除非均价合同，存在整体类型父指令
- **条件**：
  - 合同计价方式 ≠ "均价"
  - 原合同数量 = 100
  - 存在该保值方案的未完成父指令（保值方案净值套保指令），创建日期为当前交易日
- **处理**：
  - 创建或更新子指令（非均价合同变更指令），变更数量 = -100，变更所需期货 = -100 × 敞口系数
  - 重新计算父指令所需数量
  - 标记合同为"已删除"状态

##### 场景5.4：取消合同，存在单单类型父指令（均价）
- **条件**：
  - 原合同数量 = 100
  - 新合同数量 = 0（合同取消）
  - 存在该合同的未完成父指令（均价合同套保指令）
- **处理**：
  - 创建或更新子指令（均价合同变更指令），变更数量 = -100（合同取消），变更所需期货 = -100 × 敞口系数
  - 重新计算父指令所需数量
  - 保存合同变更：
    - 合同状态 = "取消"
    - 合同数量 = 0
    - 现货敞口 = 0

##### 场景5.5：取消合同，存在单单类型父指令（非均价）
- **条件**：
  - 原合同数量 = 100
  - 新合同数量 = 0（合同取消）
  - 存在该合同的未完成父指令（非均价合同套保指令）
- **处理**：
  - 显示提示信息（存在未完成指令）
  - 保存合同变更：
    - 合同状态 = "取消"
    - 合同数量 = 0
    - 现货敞口 = 0
  - 不处理相关指令

##### 场景5.6：取消合同，不存在相关父指令
- **条件**：
  - 原合同数量 = 100
  - 新合同数量 = 0（合同取消）
  - 不存在未完成的父指令
- **处理**：
  - 保存合同变更：
    - 合同状态 = "取消"
    - 合同数量 = 0
    - 现货敞口 = 0
  - 不创建指令

#### 4.6 复杂场景组合

##### 场景6.1：同一合同在同一天多次变更
- **条件**：
  - 合同在当天进行了多次数量变更
  - 第一次：100 → 150（增加50）
  - 第二次：150 → 120（减少30）
  - 存在整体类型父指令
- **处理**：
  - 第一次变更：创建子指令，变更数量 = +50
  - 第二次变更：更新同一子指令，变更数量 = +20（累计变更：+50 - 30 = +20）
  - 变更所需期货 = +20 × 敞口系数
  - 重新计算父指令所需数量

##### 场景6.2：合同变更时，父指令已存在多个子指令
- **条件**：
  - 父指令（保值方案净值套保指令）已关联多个合同的子指令
  - 当前合同变更，需要创建新的子指令
- **处理**：
  - 创建当前合同的子指令
  - 重新计算父指令所需数量 = 所有子指令的变更所需期货之和

##### 场景6.3：合同变更时，同时存在整体类型和单单类型指令（均价）
- **条件**：
  - 存在整体类型父指令（保值方案净值套保指令）
  - 同时存在单单类型父指令（均价合同套保指令）
- **处理**：
  - 按照场景判断优先级，场景3.1（单单类型均价）优先级最高
  - 先处理场景3.1：创建或更新子指令，关联到单单类型父指令（均价合同套保指令）
  - 再处理场景2：创建或更新子指令，关联到整体类型父指令
  - 最终结果：合同变更保存，两个父指令都更新

##### 场景6.4：合同变更时，同时存在整体类型和单单类型指令（非均价）
- **条件**：
  - 存在整体类型父指令（保值方案净值套保指令）
  - 同时存在单单类型父指令（非均价合同套保指令）
- **处理**：
  - 按照场景判断优先级，场景3.2（单单类型非均价）优先级最高
  - 先处理场景3.2：显示提示信息，允许保存合同变更，不处理单单类型指令
  - 再处理场景2：创建或更新子指令，关联到整体类型父指令
  - 最终结果：合同变更保存，整体类型父指令更新，单单类型指令保持不变

##### 场景6.5：合同变更时，父指令状态为"撤销待处理"
- **条件**：
  - 存在父指令，但状态为"撤销待处理"（不是"待完成"）
- **处理**：
  - 不创建子指令
  - 按场景4处理，直接保存合同变更

##### 场景6.6：合同变更时，父指令的创建日期不是当前交易日
- **条件**：
  - 存在父指令，但创建日期是上一个交易日或更早
- **处理**：
  - 对于场景1（均价自动指令）：不创建子指令，因为自动指令是按交易日发起的，上一个交易日的指令已经完成或过期
  - 对于场景2（整体类型指令）：不创建子指令，因为整体类型指令也是按交易日发起的，上一个交易日的指令已经完成或过期
  - 对于场景3.1（单单均价）：不创建子指令，因为单单均价指令也是按交易日发起的
  - 按场景4处理，直接保存合同变更

---

## 五、数据一致性保证

#### 5.1 事务性保证
- 所有合同变更和指令操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个操作需要回滚
- 确保合同、指令、子指令的数据同时更新或同时回滚
- **场景3.2的特殊处理**：
  - 场景3.2（单单非均价）只保存合同变更，不处理指令，因此事务只包含合同变更操作
  - 如果合同变更失败，整个操作回滚
- **场景3.1、场景1、场景2的特殊处理**：
  - 这些场景需要同时处理合同变更和指令操作，必须在同一事务中完成
  - 如果任何一步失败，整个操作回滚

#### 5.2 数据校验
- 在创建子指令前，校验变更数量的合法性（不能为0）
- 在创建子指令前，校验敞口系数是否已配置
- 在更新父指令所需数量前，校验计算结果是否合理（不能为负数）
- 在保存合同变更前，校验合同数量是否合法（不能为负数）
- **合同取消的特殊校验**：
  - 如果合同状态为"取消"，必须校验合同数量是否为0
  - 如果合同状态为"取消"，必须校验现货敞口是否为0

#### 5.3 并发控制
- 使用乐观锁机制，防止多个用户同时修改同一合同
- 使用数据库行锁，防止多个用户同时修改同一指令
- 在事务提交前，再次校验数据的完整性

---

## 六、异常处理

#### 6.1 计算异常
- **敞口系数未配置**：
  - 提示用户："该合同的保值方案未配置敞口系数，无法计算变更影响"
  - 阻止保存合同变更（因为需要创建子指令的场景必须要有敞口系数）
  - 引导用户到保值方案配置页面配置敞口系数
  - 记录错误日志

#### 6.2 数据异常
- **父指令不存在**：
  - 如果场景判断时发现父指令已被删除或不存在
  - 按场景4处理，直接保存合同变更

- **父指令状态异常**：
  - 如果父指令状态不是"待完成"（如已完成、已撤销）
  - 按场景4处理，直接保存合同变更

#### 6.3 业务异常
- **变更数量为0**：
  - 如果变更数量为0（合同数量未变化）
  - 不创建子指令，直接保存合同变更

- **变更所需期货为0**：
  - 如果变更所需期货计算结果为0（变更数量为0或敞口系数为0）
  - 不创建子指令，直接保存合同变更

#### 6.4 场景3特殊异常
- **合同变更时，指令状态发生变化**：
  - 如果在保存合同变更时，发现指令状态已变化（如已完成、已撤销）
  - 不影响合同变更，正常保存
  - 记录提示信息的变化（如果指令已完成，提示信息可以更新）

- **合同取消时，数量不为0**：
  - 如果合同状态为"取消"，但合同数量不为0
  - 阻止保存，返回错误信息："合同取消时，数量必须为0"

- **合同取消时，现货敞口不为0**：
  - 如果合同状态为"取消"，但现货敞口不为0
  - 阻止保存，返回错误信息："合同取消时，现货敞口必须为0"

---

## 七、性能优化建议

#### 7.1 查询优化
- 在查询未完成指令时，使用索引优化查询性能
- 缓存保值方案的敞口系数配置，减少数据库查询
- 批量查询多个合同的未完成指令，减少数据库交互次数

#### 7.2 计算优化
- 预算计算使用前端实时计算，减少服务器压力
- 复杂计算使用缓存机制，避免重复计算
- 异步处理非关键操作（如操作日志记录）

#### 7.3 界面优化
- 预算区域使用防抖机制，避免频繁计算
- 未完成指令列表使用分页或虚拟滚动，提高加载速度
- 使用骨架屏或加载动画，提升用户体验

---

## 八、后续扩展

如果后续版本中新增指令类型或修改业务规则，需要同步更新本文档，明确：
1. 新增指令类型与合同变更的关联关系
2. 新增场景的处理逻辑
3. 新增数据一致性规则和约束条件