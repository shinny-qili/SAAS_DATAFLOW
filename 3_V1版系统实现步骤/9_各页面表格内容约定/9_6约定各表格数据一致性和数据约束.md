# 各表格数据一致性和数据约束约定

本文档定义各个表格之间的数据一致性规则和数据约束条件。

## 一、期现匹配操作的数据一致性

### 1. 期现关联匹配操作

#### 操作场景
当用户在合同关联弹出框中进行期现关联匹配操作时，系统需要保证以下数据的一致性：

#### 1.1 委托单表的更新
- **已匹配手数字段更新**
  - 计算公式：已匹配手数（新）= 已匹配手数（旧）+ 本次匹配的期货数量
  - 约束条件：已匹配手数（新）≤ 成交手数（不允许超过成交手数）

- **未匹配手数字段更新**
  - 计算公式：未匹配手数（新）= 成交手数 - 已匹配手数（新）
  - 约束条件：未匹配手数（新）≥ 0（不允许负数）

- **是否已匹配状态更新**
  - 如果已匹配手数（新）> 0，自动将"是否已匹配"状态设置为"是"
  - 如果已匹配手数（新）= 0，保持"是否已匹配"状态为"否"

#### 1.2 期现备注表的创建和更新

**所有匹配都会影响到委托单列表的期现备注，且会自动将状态标为已匹配。**

##### 创建期现备注记录
- 当完成期现关联匹配操作后，系统会自动创建期现备注记录（如果不存在）
- 期现备注记录包含以下信息：
  - **委托_id**：关联的期货委托单ID
  - **合同_id**：关联的合同ID（如果是单单匹配类型）
  - **客商_id**：关联的客商ID（如果是无合同（客商）类型）
  - **标签**：从保值方案中获取标签信息
  - **手数**：本次匹配的期货数量
  - **现货数量**：本次匹配的合同数量
  - **点价价格**：如果需要，可以设置点价价格
  - **是否已匹配**：自动设置为"是"
  - **创建日期时间**：记录创建时间

##### 更新期现备注记录
- 如果委托单已存在期现备注记录，系统会更新现有记录：
  - 增加关联的手数
  - 更新关联的合同信息（如果是单单匹配）
  - 更新关联的客商信息（如果是无合同（客商）类型）

##### 期现备注状态自动更新
- 完成匹配操作后，系统自动将期现备注的"是否已匹配"状态标为"是"
- 如果期现备注的所有手数都已匹配完成，状态保持为"已匹配"

#### 1.3 数据一致性约束

##### 约束条件1：匹配数量不能超过未匹配手数
- **规则**：本次匹配的期货数量 ≤ 委托单的未匹配手数
- **验证时机**：在用户点击"确认"按钮时进行验证
- **错误提示**：如果超出，提示"匹配数量不能超过未匹配手数"

##### 约束条件2：匹配数量必须大于0
- **规则**：本次匹配的期货数量 > 0
- **验证时机**：在用户点击"确认"按钮时进行验证
- **错误提示**：如果为0或负数，提示"匹配数量必须大于0"

##### 约束条件3：合同数量与期货数量的对应关系
- **规则**：合同数量与期货数量应该符合保值方案的配置比例
- **说明**：根据保值方案中品牌配置的期货敞口系数，计算合理的对应关系
- **验证时机**：在用户点击"确认"按钮时进行验证（可选，根据业务需求决定）

#### 1.4 事务性保证
- 所有匹配操作必须在同一个数据库事务中完成
- 如果任何一步操作失败，整个匹配操作需要回滚
- 确保委托单、期现备注、合同关联等表的数据同时更新或同时回滚

### 2. 采销关联匹配操作

#### 2.1 合同表的更新
- **已销售数量字段更新**（采购合同）
  - 计算公式：已销售数量（新）= 已销售数量（旧）+ 本次关联的数量
  - 约束条件：已销售数量（新）≤ 合同数量（不允许超过合同数量）

- **已采购数量字段更新**（销售合同）
  - 计算公式：已采购数量（新）= 已采购数量（旧）+ 本次关联的数量
  - 约束条件：已采购数量（新）≤ 合同数量（不允许超过合同数量）

#### 2.2 采销关联关系表的创建
- 创建采销关联关系记录，包含：
  - **采购合同_id**：采购合同ID
  - **销售合同_id**：销售合同ID
  - **关联数量**：本次关联的数量
  - **关联日期**：关联日期
  - **发生日期时间**：发生日期时间

#### 2.3 数据一致性约束
- **约束条件**：关联数量不能超过合同的剩余未关联数量
- **计算公式**：剩余未关联数量 = 合同数量 - 已关联数量
- **验证时机**：在用户点击"确认"按钮时进行验证

#### 2.4 展示一致性（合同表 → 采销关联弹窗 → 采销关联详情）
- **触发方式**：用户在合同表点击"已销售数量"（采购合同）或"已采购数量"（销售合同）字段。
- **一致性要求**：
  1. 合同表中展示的数量 = 弹窗顶部显示的"已关联数量"总计。
  2. 弹窗列表中所有采销关联记录的"关联数量"求和 = 弹窗顶部总计。
  3. 在弹窗中继续点击某条"采销关联"进入详情后，详情页或侧滑面板展示的"关联数量" = 该记录在列表中的"关联数量" = 参与该记录的一对采购/销售合同字段的累计更新值。
- **校验方式**：前端打开弹窗与详情时均重新拉取后台数据；后台在返回结果前再次校验上述三层数据是否一致，若不一致则返回错误并阻止页面展示旧数据。
- **异常提示**：当任意一层数据不相等时，统一提示"采销关联数量不一致，请刷新或联系管理员"，并在日志中记录合同ID、关联ID与数值差。

---

## 二、期现备注表的数据一致性

### 1. 期现备注与委托单的一致性

#### 1.1 手数总和约束
- **规则**：期现备注表中同一委托单的所有记录的"手数"总和 ≤ 委托单的"成交手数"
- **验证时机**：创建或更新期现备注记录时
- **错误提示**：如果超出，提示"期现备注手数总和不能超过委托单成交手数"

#### 1.2 匹配状态一致性
- **规则**：如果委托单的"已匹配手数" = 委托单的"成交手数"，则所有关联的期现备注记录的"是否已匹配"状态都应该为"是"
- **自动更新**：当委托单的匹配状态发生变化时，系统自动更新关联的期现备注记录的匹配状态

### 2. 期现备注与合同的一致性

#### 2.1 合同匹配约束（单单匹配类型）
- **规则**：对于单单匹配类型的保值方案，期现备注必须关联到具体的合同
- **约束条件**：期现备注的"合同_id"字段不能为空
- **验证时机**：创建期现备注记录时

#### 2.2 客商匹配约束（无合同（客商）类型）
- **规则**：对于无合同（客商）类型的保值方案，期现备注必须关联到具体的客商
- **约束条件**：期现备注的"客商_id"字段不能为空，"合同_id"字段必须为空
- **验证时机**：创建期现备注记录时

---

## 三、合同表的数据一致性

### 1. 数量字段的一致性

#### 1.1 已点数量约束
- **规则**：已点数量 ≤ 合同数量
- **验证时机**：更新已点数量时
- **错误提示**：如果超出，提示"已点数量不能超过合同数量"

#### 1.2 未点数量计算
- **规则**：未点数量 = 合同数量 - 已点数量
- **自动更新**：当已点数量或合同数量发生变化时，自动重新计算未点数量

#### 1.3 已销售数量约束（采购合同）
- **规则**：已销售数量 ≤ 合同数量
- **验证时机**：更新已销售数量时
- **错误提示**：如果超出，提示"已销售数量不能超过合同数量"

#### 1.4 已采购数量约束（销售合同）
- **规则**：已采购数量 ≤ 合同数量
- **验证时机**：更新已采购数量时
- **错误提示**：如果超出，提示"已采购数量不能超过合同数量"

### 2. 金额字段的一致性

#### 2.1 合同金额计算
- **规则**：合同金额 = 合同数量 × 单价
- **自动更新**：当合同数量或单价发生变化时，自动重新计算合同金额

#### 2.2 结算金额计算
- **规则**：结算金额 = 合同数量 × 结算单价
- **自动更新**：当合同数量或结算单价发生变化时，自动重新计算结算金额

---

## 四、期货委托单表的数据一致性

### 1. 匹配字段的一致性

#### 1.1 已匹配手数约束
- **规则**：已匹配手数 ≤ 成交手数
- **验证时机**：更新已匹配手数时
- **错误提示**：如果超出，提示"已匹配手数不能超过成交手数"

#### 1.2 未匹配手数计算
- **规则**：未匹配手数 = 成交手数 - 已匹配手数
- **自动更新**：当成交手数或已匹配手数发生变化时，自动重新计算未匹配手数

#### 1.3 是否已匹配状态
- **规则**：如果已匹配手数 > 0，则"是否已匹配" = "是"
- **自动更新**：当已匹配手数发生变化时，自动更新"是否已匹配"状态

### 2. 成交字段的一致性

#### 2.1 成交手数与成交均价
- **说明**：成交手数和成交均价由交易所提供，系统不允许直接修改
- **验证时机**：如果交易所有更新，系统自动同步更新

---

## 五、数据约束规则总结

### 1. 数值约束
- 所有数量字段（手数、数量）不允许负数
- 所有金额字段不允许负数
- 已匹配数量/已点数量/已销售数量等累计字段不能超过对应的总量字段

### 2. 关联约束
- 外键关联必须指向存在的记录
- 删除操作需要考虑关联数据的处理（级联删除或阻止删除）
- 关联关系的数据类型必须匹配（如ID类型）

### 3. 状态一致性约束
- 计算状态字段必须与基础数据保持一致
- 当基础数据发生变化时，相关状态字段需要自动更新

### 4. 事务性约束
- 所有关联操作必须在同一个事务中完成
- 保证数据的原子性、一致性、隔离性和持久性（ACID特性）

---

## 六、数据一致性检查

### 1. 定期检查任务
- 系统应该定期运行数据一致性检查任务
- 检查委托单的已匹配手数是否与期现备注的手数总和一致
- 检查合同的已点数量是否与点价记录的总和一致
- 检查合同的已销售数量是否与采销关联记录的总和一致

### 2. 异常处理
- 如果发现数据不一致，系统应该记录异常日志
- 提供数据修复工具或手动修复流程
- 通知系统管理员进行处理

---

## 七、后续扩展

如果后续版本中新增表格或修改表格结构，需要同步更新本文档，明确：
1. 新增表格的数据一致性规则
2. 新增关联关系的数据约束条件
3. 新增计算字段的自动更新规则
