<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>期现业务管理平台 - 原型系统</title>
  <link rel="stylesheet" href="https://unpkg.com/antd@5.14.2/dist/reset.css" />
  <link rel="stylesheet" href="https://unpkg.com/antd@5.14.2/dist/antd.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root {
      --primary-color: #1677ff;
      --erp-gray-100: #f7f8fa;
      --erp-gray-200: #eef0f5;
      --erp-gray-300: #d9dee8;
      --erp-gray-500: #8a94a6;
      --erp-gray-700: #4b5565;
      --erp-bg-light: #f4f6fb;
      --erp-bg-dark: #1d232f;
      --header-height: 60px;
      --top-menu-height: 48px;
      --tabs-height: 42px;
      font-feature-settings: "tnum";
    }

    html, body, #root {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--erp-bg-light);
      color: #1f2430;
      overflow: hidden;
    }

    .erp-header {
      position: relative;
      z-index: 100;
      height: var(--header-height);
      min-height: var(--header-height);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(244, 246, 251, 0.95);
      border-bottom: 1px solid rgba(140, 156, 187, 0.3);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
      overflow: visible;
    }

    .erp-header .erp-top-menu {
      height: auto;
      min-height: auto;
      background: transparent;
      border-bottom: none;
      padding: 0;
      margin: 0;
    }

    .erp-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      min-width: 0;
    }

    .erp-logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary-color), #409eff);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(22, 119, 255, 0.3);
    }

    .erp-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
      line-height: 1.5;
    }

    .erp-title .name {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #1f2430;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.5;
      max-width: 250px;
    }

    .erp-title .desc {
      font-size: 10px;
      color: #7a8499;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.4;
      max-width: 250px;
    }

    .erp-top-menu {
      height: var(--top-menu-height);
      min-height: var(--top-menu-height);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(140, 156, 187, 0.2);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      overflow-x: auto;
    }

    .erp-top-menu-item {
      padding: 6px 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 13px;
      color: #4b5565;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .erp-top-menu-item:hover {
      background: rgba(22, 119, 255, 0.08);
      color: var(--primary-color);
    }

    .erp-top-menu-item.active {
      background: var(--primary-color);
      color: #fff;
    }

    .erp-main-layout {
      height: calc(100vh - var(--header-height));
      display: flex;
      overflow: hidden;
    }

    .erp-sider {
      width: 240px;
      min-width: 240px;
      background: rgba(255, 255, 255, 0.95);
      border-right: 1px solid rgba(140, 156, 187, 0.2);
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
    }

    .erp-content-area {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .erp-tabs-bar {
      height: var(--tabs-height);
      min-height: var(--tabs-height);
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid rgba(140, 156, 187, 0.25);
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }

    .erp-content {
      padding: 8px 9px 12px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%, rgba(244, 246, 251, 0.92) 40%, rgba(244, 246, 251, 0.92) 100%);
    }

    .erp-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      width: 100%;
    }

    .erp-toolbar .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .erp-tree-table-layout {
      display: flex;
      gap: 9px;
      align-items: stretch;
      width: 100%;
      height: 100%;
      min-height: 0;
    }

    .erp-tree-panel {
      width: 140px;
      min-width: 140px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.08);
      box-shadow: 0 12px 30px rgba(22, 119, 255, 0.05);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .erp-tree-panel .tree-content {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .erp-table-panel {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.08);
      padding: 8px;
      box-shadow: 0 12px 30px rgba(22, 119, 255, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .erp-filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(22, 119, 255, 0.03);
      border-radius: 8px;
      flex-wrap: wrap;
      width: 100%;
    }

    .erp-filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .erp-filter-item label {
      font-size: 13px;
      color: #4b5565;
      white-space: nowrap;
    }

    .erp-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .erp-status-badge.enabled {
      background: rgba(80, 188, 97, 0.12);
      color: #1d7b30;
    }

    .erp-status-badge.disabled {
      background: rgba(244, 67, 54, 0.12);
      color: #c62828;
    }

    .erp-column-editor-modal .ant-modal-body {
      padding: 20px;
    }

    .erp-column-editor-content {
      display: flex;
      gap: 20px;
      min-height: 400px;
      max-height: 600px;
    }

    .erp-column-editor-panel {
      flex: 1;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      padding: 16px;
      overflow-y: auto;
    }

    .erp-column-editor-panel-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .erp-column-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .erp-column-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 4px;
      transition: background 0.2s;
      cursor: move;
    }

    .erp-column-item:hover {
      background: #f5f5f5;
    }

    .erp-column-item.dragging {
      opacity: 0.5;
      background: #e6f7ff;
    }

    .erp-column-item.drag-over {
      border-top: 2px solid #1677ff;
      background: #f0f9ff;
    }

    .erp-column-item-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .erp-column-item-drag {
      cursor: move;
      color: #1677ff;
      font-size: 16px;
    }

    .erp-column-width-input {
      width: 80px;
    }

    .erp-mobile-menu-btn {
      border: none;
      box-shadow: none;
      padding: 4px;
      display: none;
    }

    .mobile-workbench {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mobile-workbench .user-card {
      border-radius: 12px;
    }

    .mobile-workbench-card {
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.12);
      box-shadow: 0 8px 20px rgba(22, 119, 255, 0.06);
    }

    .mobile-workbench-card .ant-card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (max-width: 1024px) {
      body {
        overflow: auto;
      }

      .erp-header {
        padding: 0 12px;
      }

      .erp-mobile-menu-btn {
        display: inline-flex;
      }

      .erp-title .name {
        font-size: 14px;
        max-width: 180px;
      }

      .erp-title .desc {
        font-size: 9px;
        max-width: 180px;
      }

      .erp-main-layout {
        flex-direction: column;
        height: auto;
        min-height: calc(100vh - var(--header-height));
      }

      .erp-sider {
        display: none;
      }

      .erp-content-area {
        width: 100%;
      }

      .erp-tabs-bar {
        overflow-x: auto;
      }

      .erp-tree-table-layout {
        flex-direction: column;
        height: auto;
      }

      .erp-tree-panel,
      .erp-table-panel {
        width: 100%;
        min-width: 0;
        height: auto;
        margin-bottom: 12px;
      }

      .erp-filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .erp-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .erp-tree-panel .tree-content {
        max-height: 220px;
        overflow-y: auto;
      }
    }

    @media (max-width: 600px) {
      .erp-header {
        flex-wrap: wrap;
        gap: 8px;
        height: auto;
      }

      .erp-top-menu {
        order: 3;
        width: 100%;
        padding: 4px 0;
      }

      .erp-logo {
        width: 100%;
        justify-content: space-between;
      }

      .erp-toolbar {
        gap: 8px;
      }

      .erp-filter-bar {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>
  <script src="https://unpkg.com/antd@5.14.2/dist/antd.min.js"></script>
  <script src="https://unpkg.com/@ant-design/icons@5.2.6/dist/index.umd.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useMemo, useEffect, useCallback, useRef } = React;
    const {
      Layout, Menu, Tabs, Space, Input, InputNumber, Button, Avatar, Badge, Dropdown,
      ConfigProvider, theme, Select, Tooltip, Tree, Card, Tag, Divider, Table, Form,
      Drawer, DatePicker, Modal, message, Radio, Checkbox, Switch, TreeSelect, Empty, Alert
    } = antd;
    const { Header, Sider, Content } = Layout;
    const icons = window.icons;

    const renderIcon = (name, extraProps = {}) => {
      const IconComp = icons?.[name];
      if (IconComp) {
        return <IconComp {...extraProps} />;
      }
      return <span style={{ display: 'inline-block', width: 16, height: 16 }}>●</span>;
    };

    const createPaginationConfig = (overrides = {}) => ({
      pageSize: 10,
      showSizeChanger: true,
      pageSizeOptions: ['10', '20', '50', '100'],
      showQuickJumper: {
        goButton: <Button size="small">前往</Button>
      },
      showTotal: (total, range) => `第 ${range[0]}-${range[1]} 条 / 共 ${total} 条`,
      ...overrides
    });

    const MODAL_TEXTS = {
      okText: '确认',
      cancelText: '取消'
    };

    const getIsMobile = () => {
      if (typeof window === 'undefined') return false;
      return window.innerWidth <= 1024;
    };

    // Mock数据
    const mockSpotCategories = [
      { key: 'cat-1', title: '有色金属', children: [
        { key: 'cat-1-1', title: '铜' },
        { key: 'cat-1-2', title: '铝' }
      ]},
      { key: 'cat-2', title: '黑色金属', children: [
        { key: 'cat-2-1', title: '螺纹钢' }
      ]}
    ];

    const mockSpotBrands = [
      { 
        id: 1, 
        name: '品牌A', 
        mainPortState: 'true', 
        platformState: 'invalid', 
        premium: 100, 
        price: 5300, 
        futures: [
          { code: 'CU2401', exposure: 0.8 },
          { code: 'CU2402', exposure: 0.2 }
        ]
      },
      { 
        id: 2, 
        name: '品牌B', 
        mainPortState: 'invalid', 
        platformState: 'true', 
        premium: 50, 
        price: 5250, 
        futures: [
          { code: 'CU2401', exposure: 1.0 }
        ]
      },
      { 
        id: 3, 
        name: '品牌C', 
        mainPortState: 'false', 
        platformState: 'invalid', 
        premium: 0, 
        price: 5200, 
        futures: []
      }
    ];

    const mockCustomers = [
      { id: 1, shortName: '供应商A', fullName: '上海XX贸易有限公司', creditRating: 'AAA', contact: '张三', phone: '13800138000', parentCompany: '', customerType: '供应商', status: '正常', creator: '蒋晓晓', createTime: '2025-11-24 10:02' },
      { id: 2, shortName: '客户B', fullName: '江苏XX实业有限公司', creditRating: 'AA', contact: '李四', phone: '13900139000', parentCompany: '', customerType: '客户', status: '正常', creator: '籍孟晓', createTime: '2025-11-23 15:30' },
      { id: 3, shortName: '仓库C', fullName: '上海XX仓储物流有限公司', creditRating: 'A', contact: '王五', phone: '13700137000', parentCompany: '', customerType: '仓库', status: '正常', creator: '李辉', createTime: '2025-11-22 09:15' },
      { id: 4, shortName: '物流D', fullName: '深圳XX物流有限公司', creditRating: 'BBB', contact: '赵六', phone: '13600136000', parentCompany: '', customerType: '物流', status: '正常', creator: '贺晓兰', createTime: '2025-11-21 14:20' },
      { id: 5, shortName: '撮合商E', fullName: '北京XX撮合服务有限公司', creditRating: 'AA', contact: '钱七', phone: '13500135000', parentCompany: '', customerType: '撮合商', status: '正常', creator: '朱利军', createTime: '2025-11-20 11:45' },
      { id: 6, shortName: '客商F', fullName: '广州XX商贸有限公司', creditRating: 'A', contact: '孙八', phone: '13400134000', parentCompany: '', customerType: '客商', status: '正常', creator: '李文昊', createTime: '2025-11-19 16:10' },
      { id: 7, shortName: '供应商G', fullName: '杭州XX贸易有限公司', creditRating: 'AAA', contact: '周九', phone: '13300133000', parentCompany: '', customerType: '供应商', status: '正常', creator: '魏光婷', createTime: '2025-11-18 10:30' },
      { id: 8, shortName: '客户H', fullName: '成都XX实业有限公司', creditRating: 'AA', contact: '吴十', phone: '13200132000', parentCompany: '', customerType: '客户', status: '正常', creator: '孙倩', createTime: '2025-11-17 13:25' },
      { id: 9, shortName: '仓库I', fullName: '武汉XX仓储有限公司', creditRating: 'A', contact: '郑一', phone: '13100131000', parentCompany: '', customerType: '仓库', status: '正常', creator: '蒋晓晓', createTime: '2025-11-16 08:50' },
      { id: 10, shortName: '物流J', fullName: '西安XX物流有限公司', creditRating: 'BBB', contact: '王二', phone: '13000130000', parentCompany: '', customerType: '物流', status: '正常', creator: '籍孟晓', createTime: '2025-11-15 15:40' },
      { id: 11, shortName: 'STAR PLASTICS LIMI', fullName: 'STAR PLASTICS LIMITED', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '客户', status: '正常', creator: '李辉', createTime: '2025-11-14 12:15' },
      { id: 12, shortName: 'DONGMYONG KIM', fullName: 'DONGMYONG KIM COMPANY', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '撮合商', status: '正常', creator: '贺晓兰', createTime: '2025-11-13 11:11' },
      { id: 13, shortName: 'THAI POLYESTER CO', fullName: 'THAI POLYESTER COMPANY', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '供应商', status: '正常', creator: '朱利军', createTime: '2025-11-12 09:20' }
    ];

    // 缺省标签（系统预设，可编辑）
    const defaultTags = [
      '长单保值',
      '长单增量',
      '长单减量',
      '长单取消',
      '订单接货保值',
      '订单出货保值',
      '订单增量',
      '订单减量',
      '移仓换月',
      '订单取消',
      '买点价',
      '卖点价',
      '投机',
      '调敞口',
      '代持'
    ];

    // 标签管理（存储在localStorage中，可编辑）
    const getTags = () => {
      const saved = localStorage.getItem('hedge-plan-tags');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return [...defaultTags];
        }
      }
      return [...defaultTags];
    };

    const saveTags = (tags) => {
      localStorage.setItem('hedge-plan-tags', JSON.stringify(tags));
    };

    const mockHedgePlans = [
      { id: 1, name: '整体保值方案A', type: '整体匹配', instructionTypes: ['期货交易指令', '合同创建指令'], traders: ['交易员A', '交易员B'], makers: ['制单员A'], tags: ['长单保值', '订单接货保值'] },
      { id: 2, name: '单单保值方案B', type: '单单匹配', instructionTypes: ['点价指令', '均价合同套保指令'], traders: ['交易员C'], makers: ['制单员B'], tags: ['买点价', '卖点价'] },
      { id: 3, name: '无合同（人员）方案', type: '无合同（人员）', instructionTypes: ['期货交易指令'], traders: ['交易员A'], makers: [], tags: ['投机'] },
      { id: 4, name: '无合同（客商）方案', type: '无合同（客商）', instructionTypes: ['期货交易指令'], traders: ['交易员B'], makers: [], tags: ['代持'] }
    ];

    // 指令类型数据
    const mockInstructionTypes = [
      { id: 1, name: '期货交易指令' },
      { id: 2, name: '合同创建指令' },
      { id: 3, name: '点价指令' },
      { id: 4, name: '均价合同套保指令' },
      { id: 5, name: '保值方案均价净值套保指令' }
    ];

    // 人员指令权限数据
    const mockPersonInstructionPermissions = [
      { id: 1, hedgePlan: '整体保值方案A', instructionType: '期货交易指令', creators: ['张三', '李四'], makers: ['制单员A'], traders: ['交易员A'], status: 'enabled' },
      { id: 2, hedgePlan: '单单保值方案B', instructionType: '点价指令', creators: ['王五'], makers: ['制单员B'], traders: ['交易员C'], status: 'enabled' },
      { id: 3, hedgePlan: '无合同（人员）方案', instructionType: '期货交易指令', creators: ['张三'], makers: [], traders: ['交易员A'], status: 'enabled' }
    ];

    // 客商指令权限数据
    const mockCustomerInstructionPermissions = [
      { id: 1, hedgePlan: '无合同（客商）方案', instructionType: '期货交易指令', creators: ['供应商A', '客户B'], traders: ['交易员B'], validUntil: '2025-12-31', status: 'enabled' },
      { id: 2, hedgePlan: '无合同（客商）方案', instructionType: '期货交易指令', creators: ['客户B'], traders: ['交易员A'], validUntil: '2025-11-30', status: 'enabled' }
    ];

    // 均价自动指令启停数据
    const mockAvgPriceAutoInstructions = [
      { id: 1, hedgePlan: '整体保值方案A', creator: '系统管理员', instructionType: '保值方案均价净值套保指令', status: 'disabled' },
      { id: 2, hedgePlan: '单单保值方案B', creator: '系统管理员', instructionType: '均价合同套保指令', status: 'enabled' }
    ];

    const mockFuturesAccounts = [
      { id: 1, account: 'ACC001', status: 'enabled', traders: ['交易员A', '交易员B'] },
      { id: 2, account: 'ACC002', status: 'enabled', traders: ['交易员C'] }
    ];

    // 角色数据
    const mockRoles = [
      { id: 1, name: '交易员', description: '负责期货交易操作' },
      { id: 2, name: '制单员', description: '负责合同制单' },
      { id: 3, name: '业务经理', description: '负责业务管理' },
      { id: 4, name: '风控员', description: '负责风险控制' }
    ];

    // 人员数据
    const mockPersons = [
      { id: 1, name: '张三', phone: '13800138000', role: '交易员', status: 'enabled' },
      { id: 2, name: '李四', phone: '13900139000', role: '制单员', status: 'enabled' },
      { id: 3, name: '王五', phone: '13700137000', role: '业务经理', status: 'enabled' },
      { id: 4, name: '赵六', phone: '13600136000', role: '交易员', status: 'enabled' },
      { id: 5, name: '钱七', phone: '13500135000', role: '制单员', status: 'enabled' },
      { id: 6, name: '孙八', phone: '13400134000', role: '风控员', status: 'disabled' }
    ];

    // 人员角色关系数据（每个角色一行，每个角色包含多个人员）
    const mockPersonRoles = [
      { id: 1, roleId: 1, roleName: '交易员', personIds: [1, 4], personNames: ['张三', '赵六'], description: '负责期货交易操作', status: 'enabled' },
      { id: 2, roleId: 2, roleName: '制单员', personIds: [2, 5], personNames: ['李四', '钱七'], description: '负责合同制单', status: 'enabled' },
      { id: 3, roleId: 3, roleName: '业务经理', personIds: [3], personNames: ['王五'], description: '负责业务管理', status: 'enabled' },
      { id: 4, roleId: 4, roleName: '风控员', personIds: [6], personNames: ['孙八'], description: '负责风险控制', status: 'disabled' }
    ];

    const roleWorkbenches = {
      '交易员': [
        { key: 'instruction', title: '指令工作台', description: '查看并处理期现指令、快速确认执行结果。', icon: 'DesktopOutlined', cta: '进入指令工作台' },
        { key: 'web-trade', title: 'Web 交易端', description: '随时查看行情并发起下单或点价操作。', icon: 'StockOutlined', cta: '打开交易端' }
      ],
      '业务经理': [
        { key: 'biz-report', title: '经营报表', description: '掌握合同执行与敞口情况，获取分析报表。', icon: 'BarChartOutlined', cta: '查看经营报表' },
        { key: 'customer-pricing', title: '客商点价', description: '审批或查看客商点价申请，维护报价。', icon: 'DollarOutlined', cta: '进入点价' }
      ],
      '制单员': [
        { key: 'instruction', title: '指令工作台', description: '接收业务指令，快速完成制单。', icon: 'FileTextOutlined', cta: '处理制单指令' }
      ],
      '风控员': [
        { key: 'risk-report', title: '风险监控', description: '查看风险阈值、监控账户敞口并发出预警。', icon: 'AlertOutlined', cta: '查看风险报表' }
      ]
    };

    const mockContracts = [
      { id: 1, hedgePlan: '整体保值方案A', manager: '业务经理A', contractNo: 'HT2025-0001', customer: '供应商A', spotType: '铜', brand: '品牌A', pricing: '一口价', qty: 100, price: 5300, settlementPrice: 5300, amount: 530000, settlementAmount: 530000, transport: '自提', deliveryDate: '2025-12-31', pricedQty: 100, unpricedQty: 0, creator: '张三', createTime: '2025-11-10 10:00', occurTime: '2025-11-10 10:00', status: 'active' },
      { id: 2, hedgePlan: '单单保值方案B', manager: '业务经理B', contractNo: 'HT2025-0002', customer: '客户B', spotType: '铝', brand: '品牌B', pricing: '均价', qty: 200, price: 0, settlementPrice: 0, amount: 0, settlementAmount: 0, transport: '送到', deliveryDate: '2025-12-15', pricedQty: 0, unpricedQty: 200, creator: '李四', createTime: '2025-11-11 14:30', occurTime: '2025-11-11 14:30', status: 'active' }
    ];

    // 委托单数据
    const mockFuturesOrders = [
      { 
        id: 1, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 10:30:00', 
        shortNo: 'NO001', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5300, 
        tradedQty: 50, 
        orderPrice: 5300,
        unmatchedQty: 20,
        orderStatus: '部成',
        spotRemarks: [
          { id: 1, qty: 20, spotQty: 100, pricingPrice: 5300, tag: '长单保值', remark: '备注1', customerId: 1, contractId: null, isMatched: false },
          { id: 2, qty: 10, spotQty: 50, pricingPrice: 0, tag: '订单接货保值', remark: '备注2', customerId: null, contractId: 1, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 2, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 11:00:00', 
        shortNo: 'NO002', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5250, 
        tradedQty: 30, 
        orderPrice: 5250,
        unmatchedQty: 30,
        orderStatus: '全成',
        spotRemarks: [],
        orderRemark: '<p>这是委托备注内容</p>'
      },
      { 
        id: 3, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（人员）方案', 
        hedgePlanId: 3,
        dateTime: '2025-11-24 09:15:00', 
        shortNo: 'NO003', 
        contract: 'CU2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5350, 
        tradedQty: 100, 
        orderPrice: 5350,
        unmatchedQty: 100,
        orderStatus: '全成',
        spotRemarks: [
          { id: 3, qty: 100, spotQty: 500, pricingPrice: 0, tag: '投机', remark: '', customerId: null, contractId: null, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 4, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 14:20:00', 
        shortNo: 'NO004', 
        contract: 'CU2403', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5280, 
        tradedQty: 80, 
        orderPrice: 5280,
        unmatchedQty: 0,
        orderStatus: '全成',
        spotRemarks: [
          { id: 4, qty: 50, spotQty: 250, pricingPrice: 5280, tag: '长单减量', remark: '减仓操作', customerId: 2, contractId: null, isMatched: true },
          { id: 5, qty: 30, spotQty: 150, pricingPrice: 5280, tag: '订单出货保值', remark: '出货备注', customerId: 2, contractId: null, isMatched: true }
        ],
        orderRemark: '<p>整体保值减仓操作</p>'
      },
      { 
        id: 5, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 15:45:00', 
        shortNo: 'NO005', 
        contract: 'AL2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5200, 
        tradedQty: 60, 
        orderPrice: 5200,
        unmatchedQty: 60,
        orderStatus: '全成',
        spotRemarks: [
          { id: 6, qty: 40, spotQty: 200, pricingPrice: 5200, tag: '买点价', remark: '点价买入', customerId: null, contractId: 2, isMatched: false },
          { id: 7, qty: 20, spotQty: 100, pricingPrice: 0, tag: '订单增量', remark: '增量操作', customerId: null, contractId: 2, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 6, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（客商）方案', 
        hedgePlanId: 4,
        dateTime: '2025-11-24 16:10:00', 
        shortNo: 'NO006', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5320, 
        tradedQty: 40, 
        orderPrice: 5320,
        unmatchedQty: 40,
        orderStatus: '全成',
        spotRemarks: [
          { id: 8, qty: 40, spotQty: 200, pricingPrice: 0, tag: '代持', remark: '代客持有', customerId: 3, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>客商代持操作</p>'
      },
      { 
        id: 7, 
        futuresAccount: 'ACC002', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 09:30:00', 
        shortNo: 'NO007', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5240, 
        tradedQty: 25, 
        orderPrice: 5240,
        unmatchedQty: 5,
        orderStatus: '部成',
        spotRemarks: [
          { id: 9, qty: 20, spotQty: 100, pricingPrice: 5240, tag: '长单取消', remark: '取消订单', customerId: 4, contractId: null, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 8, 
        futuresAccount: 'ACC001', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 13:15:00', 
        shortNo: 'NO008', 
        contract: 'CU2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5360, 
        tradedQty: 70, 
        orderPrice: 5360,
        unmatchedQty: 70,
        orderStatus: '全成',
        spotRemarks: [
          { id: 10, qty: 35, spotQty: 175, pricingPrice: 5360, tag: '卖点价', remark: '点价卖出', customerId: null, contractId: 1, isMatched: false },
          { id: 11, qty: 35, spotQty: 175, pricingPrice: 0, tag: '订单减量', remark: '减量操作', customerId: null, contractId: 1, isMatched: false }
        ],
        orderRemark: '<p>点价和减量组合操作</p>'
      },
      { 
        id: 9, 
        futuresAccount: 'ACC002', 
        hedgePlan: '无合同（人员）方案', 
        hedgePlanId: 3,
        dateTime: '2025-11-24 10:00:00', 
        shortNo: 'NO009', 
        contract: 'AL2403', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5180, 
        tradedQty: 90, 
        orderPrice: 5180,
        unmatchedQty: 90,
        orderStatus: '全成',
        spotRemarks: [
          { id: 12, qty: 50, spotQty: 250, pricingPrice: 0, tag: '调敞口', remark: '调整敞口', customerId: null, contractId: null, isMatched: false },
          { id: 13, qty: 40, spotQty: 200, pricingPrice: 0, tag: '投机', remark: '投机交易', customerId: null, contractId: null, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 10, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 11:30:00', 
        shortNo: 'NO010', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5310, 
        tradedQty: 35, 
        orderPrice: 5310,
        unmatchedQty: 35,
        orderStatus: '全成',
        spotRemarks: [
          { id: 14, qty: 35, spotQty: 175, pricingPrice: 5310, tag: '长单增量', remark: '增量操作', customerId: 5, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>长单增量保值</p>'
      },
      { 
        id: 11, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 12:00:00', 
        shortNo: 'NO011', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5230, 
        tradedQty: 45, 
        orderPrice: 5230,
        unmatchedQty: 0,
        orderStatus: '全成',
        spotRemarks: [
          { id: 15, qty: 30, spotQty: 150, pricingPrice: 5230, tag: '订单取消', remark: '取消订单', customerId: null, contractId: 2, isMatched: true },
          { id: 16, qty: 15, spotQty: 75, pricingPrice: 5230, tag: '移仓换月', remark: '移仓操作', customerId: null, contractId: 2, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 12, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（客商）方案', 
        hedgePlanId: 4,
        dateTime: '2025-11-24 14:50:00', 
        shortNo: 'NO012', 
        contract: 'CU2403', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5340, 
        tradedQty: 55, 
        orderPrice: 5340,
        unmatchedQty: 55,
        orderStatus: '全成',
        spotRemarks: [
          { id: 17, qty: 55, spotQty: 275, pricingPrice: 0, tag: '代持', remark: '代客持有', customerId: 6, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>客商代持</p>'
      },
      { 
        id: 13, 
        futuresAccount: 'ACC002', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 15:20:00', 
        shortNo: 'NO013', 
        contract: 'AL2402', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5190, 
        tradedQty: 20, 
        orderPrice: 5190,
        unmatchedQty: 20,
        orderStatus: '未成',
        spotRemarks: [],
        orderRemark: ''
      }
    ];

    // 现货品种管理页面
    const SpotBrandManagement = () => {
      const [selectedCategory, setSelectedCategory] = useState('cat-1');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ brand: '', mainPort: '', platform: '', futures: '' });
      const [spotBrands, setSpotBrands] = useState(mockSpotBrands);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [priceModalVisible, setPriceModalVisible] = useState(false);
      const [historyModalVisible, setHistoryModalVisible] = useState(false);
      const [exposureModalVisible, setExposureModalVisible] = useState(false);
      const [currentBrandId, setCurrentBrandId] = useState(null);
      const [form] = Form.useForm();
      const [exposureForm] = Form.useForm();

      const filteredData = useMemo(() => {
        return spotBrands.filter(item => {
          if (filters.brand && !item.name.includes(filters.brand)) return false;
          if (filters.mainPort && item.mainPortState !== filters.mainPort) return false;
          if (filters.platform && item.platformState !== filters.platform) return false;
          if (filters.futures) {
            const keyword = filters.futures.toLowerCase();
            const matched = item.futures?.some(f => f.code?.toLowerCase().includes(keyword));
            if (!matched) return false;
          }
          return true;
        });
      }, [filters, spotBrands]);

      const TRI_STATE_OPTIONS = [
        { value: 'invalid', label: 'Invalid（继承）' },
        { value: 'true', label: '是' },
        { value: 'false', label: '否' }
      ];

      const formatTriState = (value) => {
        if (value === 'true') return '是';
        if (value === 'false') return '否';
        return 'Invalid';
      };

      const enforceTriStateRules = (changedValues, allValues) => {
        const updates = {};
        if (Object.prototype.hasOwnProperty.call(changedValues, 'mainPortState')) {
          const value = changedValues.mainPortState;
          if (value !== 'invalid') {
            updates.platformState = 'invalid';
          } else if ((allValues.platformState || 'invalid') === 'invalid') {
            updates.platformState = 'true';
          }
        }
        if (Object.prototype.hasOwnProperty.call(changedValues, 'platformState')) {
          const value = changedValues.platformState;
          if (value !== 'invalid') {
            updates.mainPortState = 'invalid';
          } else if ((allValues.mainPortState || 'invalid') === 'invalid') {
            updates.mainPortState = 'true';
          }
        }
        if (Object.keys(updates).length) {
          form.setFieldsValue(updates);
        }
      };

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '名称', dataIndex: 'name', width: 150, fixed: 'left' },
        { key: 'mainPortState', title: '是否主港', dataIndex: 'mainPortState', width: 120, render: formatTriState },
        { key: 'platformState', title: '是否平台价', dataIndex: 'platformState', width: 140, render: formatTriState },
        { key: 'premium', title: '升贴水', dataIndex: 'premium', width: 100 },
        { key: 'price', title: '价格', dataIndex: 'price', width: 120 },
        { 
          key: 'futures', 
          title: '期货敞口配置', 
          dataIndex: 'futures', 
          width: 300, 
          render: (arr) => {
            if (!arr || arr.length === 0) {
              return <span style={{ color: '#999' }}>未配置</span>;
            }
            return (
              <div style={{ lineHeight: 1.8 }}>
                {arr.map((item, index) => (
                  <div key={`${item.code}-${index}`}>
                    <strong>{item.code || '-'}</strong>
                    <span style={{ marginLeft: 8, color: '#4b5565' }}>敞口：{(item.exposure ?? 0).toFixed(2)}</span>
                  </div>
                ))}
              </div>
            );
          }
        }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: spotVisibleColumns
      } = useColumnManager('spot-brand', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-tree-table-layout" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-tree-panel">
              <Space style={{ marginBottom: 12, width: '100%', justifyContent: 'space-between', flexShrink: 0 }}>
                <span style={{ fontWeight: 600 }}>现货品种</span>
                <Button size="small" icon={renderIcon('PlusOutlined')} onClick={() => message.info('添加分类')} />
              </Space>
              <div className="tree-content">
                <Tree
                  treeData={mockSpotCategories}
                  selectedKeys={[selectedCategory]}
                  onSelect={(keys) => setSelectedCategory(keys[0])}
                  defaultExpandAll
                />
              </div>
            </div>
            <div className="erp-table-panel">
              <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
                <div className="erp-filter-item">
                  <label>品牌：</label>
                  <Input placeholder="品牌" style={{ width: 150 }} value={filters.brand} onChange={(e) => setFilters({...filters, brand: e.target.value})} />
                </div>
                <div className="erp-filter-item">
                  <label>主港：</label>
                  <Select placeholder="全部" style={{ width: 150 }} value={filters.mainPort} onChange={(v) => setFilters({...filters, mainPort: v})}>
                    <Select.Option value="">全部</Select.Option>
                    <Select.Option value="true">是</Select.Option>
                    <Select.Option value="false">否</Select.Option>
                    <Select.Option value="invalid">Invalid（继承）</Select.Option>
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>平台：</label>
                  <Select placeholder="全部" style={{ width: 150 }} value={filters.platform} onChange={(v) => setFilters({...filters, platform: v})}>
                    <Select.Option value="">全部</Select.Option>
                    <Select.Option value="true">是</Select.Option>
                    <Select.Option value="false">否</Select.Option>
                    <Select.Option value="invalid">Invalid（继承）</Select.Option>
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>期货品种：</label>
                  <Input placeholder="期货品种" style={{ width: 150 }} value={filters.futures} onChange={(e) => setFilters({...filters, futures: e.target.value})} />
                </div>
              </div>
              <div className="erp-toolbar" style={{ flexShrink: 0 }}>
                <Space wrap>
                  <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => setEditModalVisible(true)}>增加</Button>
                  <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1}>编辑</Button>
                  <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0}>删除</Button>
                  <Button icon={renderIcon('DollarOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setPriceModalVisible(true)}>录入价格</Button>
                  <Button icon={renderIcon('ClusterOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const brand = spotBrands.find(item => item.id === selectedRowKeys[0]);
                      setCurrentBrandId(brand?.id || null);
                      exposureForm.setFieldsValue({
                        futures: brand?.futures?.length ? brand.futures.map(f => ({ code: f.code, exposure: f.exposure })) : [{ code: '', exposure: 0 }]
                      });
                      setExposureModalVisible(true);
                    }
                  }}>配置敞口</Button>
                  <Button icon={renderIcon('UploadOutlined')}>导入价格</Button>
                  <Button icon={renderIcon('HistoryOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setHistoryModalVisible(true)}>历史价格</Button>
                  <Button icon={renderIcon('PoweroffOutlined')}>禁用/启用</Button>
                  <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
                </Space>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                  style={{ marginLeft: 'auto' }}
                >
                  自定义列
                </Button>
              </div>
              <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
                <Table
                  rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                  columns={tableColumns}
                  dataSource={filteredData}
                  rowKey="id"
                  scroll={{ x: 'max-content' }}
                  pagination={createPaginationConfig()}
                />
              </div>
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑品牌"
            open={editModalVisible}
            onCancel={() => setEditModalVisible(false)}
            onOk={() => { message.success('保存成功'); setEditModalVisible(false); }}
          >
            <Form
              form={form}
              layout="vertical"
              initialValues={{ mainPortState: 'true', platformState: 'invalid' }}
              onValuesChange={(changed, values) => enforceTriStateRules(changed, values)}
            >
              <Form.Item label="名称" name="name" required><Input /></Form.Item>
              <Form.Item label="是否主港" name="mainPortState" required>
                <Select options={TRI_STATE_OPTIONS} />
              </Form.Item>
              <Form.Item label="是否平台价" name="platformState" required>
                <Select options={TRI_STATE_OPTIONS} />
              </Form.Item>
              <Form.Item label="期货品种" name="futures"><Select mode="tags" placeholder="选择期货品种" /></Form.Item>
              <Form.Item label="敞口系数" name="exposure"><InputNumber min={0} max={1} step={0.1} style={{ width: '100%' }} /></Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="录入价格"
            open={priceModalVisible}
            onCancel={() => setPriceModalVisible(false)}
            onOk={() => { message.success('价格录入成功'); setPriceModalVisible(false); }}
          >
            <Form layout="vertical">
              <Form.Item label="品牌"><Input value={spotBrands.find(b => b.id === selectedRowKeys[0])?.name} disabled /></Form.Item>
              <Form.Item label="升贴水" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="价格" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="发生日期" required><DatePicker style={{ width: '100%' }} /></Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="历史价格"
            open={historyModalVisible}
            onCancel={() => setHistoryModalVisible(false)}
            width={800}
          >
            <div className="erp-filter-bar">
              <div className="erp-filter-item">
                <label>日期：</label>
                <DatePicker.RangePicker />
              </div>
            </div>
            <Table
              columns={[
                { title: '名称', dataIndex: 'name' },
                { title: '升贴水', dataIndex: 'premium' },
                { title: '价格', dataIndex: 'price' },
                { title: '日期', dataIndex: 'date' }
              ]}
              dataSource={[]}
              pagination={false}
            />
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="配置期货敞口"
            open={exposureModalVisible}
            onCancel={() => setExposureModalVisible(false)}
            width={520}
            destroyOnClose
            onOk={() => {
              exposureForm.validateFields().then(values => {
                const futuresList = (values.futures || [])
                  .filter(item => item?.code)
                  .map(item => ({ code: item.code.trim(), exposure: Number(item.exposure) || 0 }));
                setSpotBrands(prev => prev.map(item => {
                  if (item.id === currentBrandId) {
                    return { ...item, futures: futuresList };
                  }
                  return item;
                }));
                message.success('敞口配置已更新');
                setExposureModalVisible(false);
              });
            }}
          >
            <Form form={exposureForm} layout="vertical" preserve={false}>
              <Form.List name="futures" initialValue={[{ code: '', exposure: 0 }]}>
                {(fields, { add, remove }) => (
                  <Space direction="vertical" style={{ width: '100%' }}>
                    {fields.map((field, index) => (
                      <Space key={field.key} align="baseline" style={{ width: '100%' }}>
                        <Form.Item
                          {...field}
                          name={[field.name, 'code']}
                          fieldKey={[field.fieldKey, 'code']}
                          label="期货品种"
                          rules={[{ required: true, message: '请输入期货品种代码' }]}
                        >
                          <Input placeholder="如 CU2401" style={{ width: 160 }} />
                        </Form.Item>
                        <Form.Item
                          {...field}
                          name={[field.name, 'exposure']}
                          fieldKey={[field.fieldKey, 'exposure']}
                          label="敞口系数"
                          rules={[{ required: true, message: '请输入敞口系数' }]}
                        >
                          <InputNumber min={0} max={5} step={0.01} style={{ width: 140 }} />
                        </Form.Item>
                        {fields.length > 1 && (
                          <Button
                            type="text"
                            danger
                            icon={renderIcon('DeleteOutlined')}
                            onClick={() => remove(field.name)}
                          />
                        )}
                      </Space>
                    ))}
                    <Button
                      type="dashed"
                      onClick={() => add({ code: '', exposure: 0 })}
                      icon={renderIcon('PlusOutlined')}
                      block
                    >
                      新增期货品种
                    </Button>
                  </Space>
                )}
              </Form.List>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={spotVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 通用的列管理Hook
    const useColumnManager = (pageKey, allColumnDefinitions, defaultVisibleColumns, options = {}) => {
      const { onRowSelect, onCellClick } = options;
      
      const [visibleColumns, setVisibleColumns] = useState(() => {
        const saved = localStorage.getItem(`${pageKey}-columns`);
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            return defaultVisibleColumns;
          }
        }
        return defaultVisibleColumns;
      });

      const [columnEditorVisible, setColumnEditorVisible] = useState(false);

      useEffect(() => {
        localStorage.setItem(`${pageKey}-columns`, JSON.stringify(visibleColumns));
      }, [visibleColumns, pageKey]);

      const handleColumnSave = (columns) => {
        setVisibleColumns(columns);
        setColumnEditorVisible(false);
        message.success('列设置已保存');
      };

      const handleColumnRestoreDefault = () => {
        setVisibleColumns(defaultVisibleColumns);
        setColumnEditorVisible(false);
        message.success('已恢复默认列设置');
      };

      // 构建表格列，添加序号列
      const tableColumns = useMemo(() => {
        return [
          {
            title: '序号',
            key: 'index',
            width: 80,
            fixed: 'left',
            render: (_, __, index) => index + 1
          },
          ...visibleColumns.map(col => {
            const def = allColumnDefinitions.find(d => d.key === col.key);
            const columnDef = {
              ...def,
              ...col,
              width: col.width || def?.width || 150,
              // 确保 render 函数从原始定义中保留
              render: def?.render || col.render
            };
            
            // 处理单元格点击行为
            const isClickable = def?.clickable === true || col.clickable === true;
            const hasCustomClick = def?.onCellClick || onCellClick;
            
            if (isClickable && hasCustomClick) {
              // 可操作类：点击弹出详情对话框
              columnDef.onCell = (record) => ({
                onClick: (e) => {
                  // 如果点击的是单元格内的按钮、链接等交互元素，不触发
                  if (e.target.tagName === 'BUTTON' || 
                      e.target.tagName === 'A' || 
                      e.target.closest('button') || 
                      e.target.closest('a') ||
                      e.target.closest('.ant-btn') ||
                      e.target.closest('.ant-tag') ||
                      e.target.closest('.ant-input') ||
                      e.target.closest('.ant-select')) {
                    return;
                  }
                  // 调用自定义点击处理函数
                  const clickHandler = def?.onCellClick || onCellClick;
                  if (clickHandler) {
                    clickHandler(record, e);
                  }
                },
                style: { cursor: 'pointer' }
              });
            } else if (!isClickable && onRowSelect) {
              // 不可操作类：点击选中行
              columnDef.onCell = (record) => ({
                onClick: (e) => {
                  // 如果点击的是单元格内的按钮、链接等交互元素，不触发选中
                  if (e.target.tagName === 'BUTTON' || 
                      e.target.tagName === 'A' || 
                      e.target.closest('button') || 
                      e.target.closest('a') ||
                      e.target.closest('.ant-btn') ||
                      e.target.closest('.ant-tag') ||
                      e.target.closest('.ant-input') ||
                      e.target.closest('.ant-select')) {
                    return;
                  }
                  // 选中该行
                  if (record && record.id !== undefined) {
                    onRowSelect([record.id]);
                  }
                },
                style: { cursor: 'pointer' }
              });
            }
            
            return columnDef;
          })
        ];
      }, [visibleColumns, allColumnDefinitions, onRowSelect, onCellClick]);

      return {
        visibleColumns,
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions,
        defaultVisibleColumns,
        setVisibleColumns
      };
    };

    // 列编辑器组件
    const ColumnEditor = ({ allColumns, visibleColumns, onSave, onCancel, onRestoreDefault }) => {
      const [localVisibleColumns, setLocalVisibleColumns] = useState([...visibleColumns]);
      const [widthInputs, setWidthInputs] = useState({});
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [dragOverIndex, setDragOverIndex] = useState(null);
      
      useEffect(() => {
        const widths = {};
        localVisibleColumns.forEach(col => {
          widths[col.key] = col.width || 150;
        });
        setWidthInputs(widths);
      }, [localVisibleColumns]);

      const handleToggleColumn = (columnKey) => {
        const column = allColumns.find(c => c.key === columnKey);
        if (!column) return;
        
        const isVisible = localVisibleColumns.some(c => c.key === columnKey);
        if (isVisible) {
          setLocalVisibleColumns(localVisibleColumns.filter(c => c.key !== columnKey));
        } else {
          setLocalVisibleColumns([...localVisibleColumns, { ...column, width: column.width || 150 }]);
        }
      };

      const handleSelectAll = (checked) => {
        if (checked) {
          setLocalVisibleColumns(allColumns.map(col => ({ ...col, width: col.width || 150 })));
        } else {
          setLocalVisibleColumns([]);
        }
      };

      const handleRemoveColumn = (columnKey) => {
        setLocalVisibleColumns(localVisibleColumns.filter(c => c.key !== columnKey));
      };

      const handleWidthChange = (columnKey, width) => {
        setWidthInputs({ ...widthInputs, [columnKey]: width });
        setLocalVisibleColumns(localVisibleColumns.map(col => 
          col.key === columnKey ? { ...col, width } : col
        ));
      };

      const handleDragStart = (e, index) => {
        // 如果点击的是按钮或按钮内的元素，不触发拖拽
        const target = e.target;
        if (target.tagName === 'BUTTON' || 
            target.closest('button') || 
            target.closest('.erp-column-item-actions')) {
          e.preventDefault();
          return false;
        }
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', index.toString());
        // 设置拖拽时的视觉效果
        if (e.currentTarget) {
          e.currentTarget.style.opacity = '0.5';
        }
      };

      const handleDragEnd = (e) => {
        e.currentTarget.style.opacity = '1';
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const handleDragOver = (e, index) => {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        if (draggedIndex !== null && draggedIndex !== index) {
          setDragOverIndex(index);
        }
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        // 只有当离开到列表外部时才清除dragOverIndex
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX;
        const y = e.clientY;
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
          setDragOverIndex(null);
        }
      };

      const handleDrop = (e, dropIndex) => {
        e.preventDefault();
        e.stopPropagation();
        if (draggedIndex === null || draggedIndex === dropIndex) {
          setDragOverIndex(null);
          return;
        }

        const newColumns = [...localVisibleColumns];
        const [moved] = newColumns.splice(draggedIndex, 1);
        newColumns.splice(dropIndex, 0, moved);
        setLocalVisibleColumns(newColumns);
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const handleSave = () => {
        const finalColumns = localVisibleColumns.map(col => ({
          ...col,
          width: widthInputs[col.key] || col.width || 150
        }));
        onSave(finalColumns);
      };

      const allSelected = localVisibleColumns.length === allColumns.length;
      const someSelected = localVisibleColumns.length > 0 && localVisibleColumns.length < allColumns.length;

      return (
        <Modal
          {...MODAL_TEXTS}
          title="设置自定义列"
          open={true}
          onCancel={onCancel}
          width={800}
          className="erp-column-editor-modal"
          footer={[
            <Button key="cancel" onClick={onCancel}>取消</Button>,
            <Button key="restore" onClick={onRestoreDefault}>恢复默认</Button>,
            <Button key="confirm" type="primary" onClick={handleSave}>确认</Button>
          ]}
        >
          <div className="erp-column-editor-content">
            <div className="erp-column-editor-panel">
              <div className="erp-column-editor-panel-title">请选择列表中要展示的信息</div>
              <div className="erp-column-list">
                <div className="erp-column-item">
                  <Checkbox
                    checked={allSelected}
                    indeterminate={someSelected}
                    onChange={(e) => handleSelectAll(e.target.checked)}
                  >
                    全选
                  </Checkbox>
                </div>
                {allColumns.map(column => {
                  const isChecked = localVisibleColumns.some(c => c.key === column.key);
                  return (
                    <div key={column.key} className="erp-column-item">
                      <Checkbox
                        checked={isChecked}
                        onChange={() => handleToggleColumn(column.key)}
                      >
                        {column.title}
                      </Checkbox>
                    </div>
                  );
                })}
              </div>
            </div>
            <div className="erp-column-editor-panel">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                <div className="erp-column-editor-panel-title">当前选定的字段</div>
                <Button size="small" onClick={() => setLocalVisibleColumns([])}>清空</Button>
              </div>
              <div className="erp-column-list">
                {localVisibleColumns.map((column, index) => (
                  <div
                    key={column.key}
                    className={`erp-column-item ${draggedIndex === index ? 'dragging' : ''} ${dragOverIndex === index ? 'drag-over' : ''}`}
                    draggable={true}
                    onDragStart={(e) => handleDragStart(e, index)}
                    onDragEnd={handleDragEnd}
                    onDragOver={(e) => handleDragOver(e, index)}
                    onDragLeave={handleDragLeave}
                    onDrop={(e) => handleDrop(e, index)}
                  >
                    <span style={{ userSelect: 'none', flex: 1 }}>{column.title}</span>
                    <div 
                      className="erp-column-item-actions" 
                      onClick={(e) => e.stopPropagation()}
                      onMouseDown={(e) => {
                        e.stopPropagation();
                        // 阻止拖拽
                        const parent = e.currentTarget.closest('.erp-column-item');
                        if (parent) {
                          parent.draggable = false;
                          setTimeout(() => {
                            parent.draggable = true;
                          }, 100);
                        }
                      }}
                      style={{ pointerEvents: 'auto' }}
                    >
                      <Button
                        size="small"
                        type="text"
                        onClick={(e) => {
                          e.stopPropagation();
                          const currentWidth = widthInputs[column.key] || column.width || 150;
                          let tempWidth = currentWidth;
                          Modal.confirm({
                            ...MODAL_TEXTS,
                            title: `设置"${column.title}"列宽`,
                            content: (
                              <div style={{ marginTop: 16 }}>
                                <InputNumber
                                  style={{ width: '100%' }}
                                  min={50}
                                  max={500}
                                  defaultValue={currentWidth}
                                  onChange={(val) => {
                                    if (val !== null) {
                                      tempWidth = val;
                                    }
                                  }}
                                  addonAfter="px"
                                />
                              </div>
                            ),
                            onOk: () => {
                              handleWidthChange(column.key, tempWidth);
                              message.success('列宽已更新');
                            }
                          });
                        }}
                        style={{ padding: '0 4px' }}
                      >
                        宽度设置
                      </Button>
                      <Button
                        size="small"
                        type="text"
                        danger
                        icon={renderIcon('DeleteOutlined')}
                        onClick={(e) => {
                          e.stopPropagation();
                          handleRemoveColumn(column.key);
                        }}
                        style={{ padding: '0 4px' }}
                      />
                      <span 
                        className="erp-column-item-drag" 
                        title="拖拽排序（点击并拖动整行）" 
                        style={{ cursor: 'move', fontSize: 16, userSelect: 'none', padding: '4px' }}
                        onMouseDown={(e) => e.stopPropagation()}
                      >
                        {renderIcon('MenuOutlined') || '⋮⋮'}
                      </span>
                    </div>
                  </div>
                ))}
                {localVisibleColumns.length === 0 && (
                  <div style={{ textAlign: 'center', color: '#999', padding: '40px 0' }}>
                    暂无选定的字段
                  </div>
                )}
              </div>
            </div>
          </div>
        </Modal>
      );
    };

    // 客商管理页面
    const CustomerManagement = () => {
      const [selectedCategory, setSelectedCategory] = useState('supplier');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ shortName: '', fullName: '' });
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'shortName', title: '简称', dataIndex: 'shortName', width: 150 },
        { key: 'fullName', title: '全称', dataIndex: 'fullName', width: 250 },
        { key: 'creditRating', title: '信用评级', dataIndex: 'creditRating', width: 120 },
        { key: 'contact', title: '联系人', dataIndex: 'contact', width: 120 },
        { key: 'phone', title: '联系电话', dataIndex: 'phone', width: 150 },
        { key: 'parentCompany', title: '关联母公司', dataIndex: 'parentCompany', width: 200 },
        { key: 'customerType', title: '客商类型', dataIndex: 'customerType', width: 120, render: (type) => (
          type ? <Tag color="blue">{type}</Tag> : '-'
        )},
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === '正常' ? 'enabled' : 'disabled'}`}>
            {status || '正常'}
          </span>
        )},
        { key: 'creator', title: '创建人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '创建时间', dataIndex: 'createTime', width: 180 }
      ];

      // 默认显示的列
      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: customerVisibleColumns
      } = useColumnManager('customer', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const customerCategories = [
        { key: 'supplier', title: '供应商' },
        { key: 'customer', title: '客户' },
        { key: 'warehouse', title: '仓库' },
        { key: 'logistics', title: '物流' },
        { key: 'broker', title: '撮合商' },
        { key: 'other', title: '客商' }
      ];

      // 从数据中提取唯一的简称和全称列表
      const shortNameOptions = useMemo(() => {
        const uniqueNames = [...new Set(mockCustomers.map(item => item.shortName).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, []);

      const fullNameOptions = useMemo(() => {
        const uniqueNames = [...new Set(mockCustomers.map(item => item.fullName).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, []);

      const filteredData = useMemo(() => {
        return mockCustomers.filter(item => {
          if (filters.shortName && !item.shortName.includes(filters.shortName)) return false;
          if (filters.fullName && !item.fullName.includes(filters.fullName)) return false;
          return true;
        });
      }, [filters]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-tree-table-layout" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-tree-panel">
              <Space style={{ marginBottom: 12, width: '100%', justifyContent: 'space-between', flexShrink: 0 }}>
                <span style={{ fontWeight: 600 }}>客商类型</span>
                <Button size="small" icon={renderIcon('PlusOutlined')} onClick={() => message.info('添加类型')} />
              </Space>
              <div className="tree-content">
                <Tree
                  treeData={customerCategories}
                  selectedKeys={[selectedCategory]}
                  onSelect={(keys) => setSelectedCategory(keys[0])}
                />
              </div>
            </div>
            <div className="erp-table-panel">
              <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
                <div className="erp-filter-item">
                  <label>简称：</label>
                  <Select
                    showSearch
                    allowClear
                    placeholder="请输入或选择简称"
                    style={{ width: 200 }}
                    value={filters.shortName || undefined}
                    onChange={(value) => setFilters({...filters, shortName: value || ''})}
                    options={shortNameOptions}
                    filterOption={(input, option) =>
                      (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                    }
                  />
                </div>
                <div className="erp-filter-item">
                  <label>全称：</label>
                  <Select
                    showSearch
                    allowClear
                    placeholder="请输入或选择全称"
                    style={{ width: 250 }}
                    value={filters.fullName || undefined}
                    onChange={(value) => setFilters({...filters, fullName: value || ''})}
                    options={fullNameOptions}
                    filterOption={(input, option) =>
                      (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                    }
                  />
                </div>
                <div className="erp-filter-item">
                  <label>联系人：</label>
                  <Input placeholder="联系人" style={{ width: 150 }} value={filters.contact} onChange={(e) => setFilters({...filters, contact: e.target.value})} />
                </div>
                <div className="erp-filter-item">
                  <label>手机号：</label>
                  <Input placeholder="手机号" style={{ width: 150 }} value={filters.phone} onChange={(e) => setFilters({...filters, phone: e.target.value})} />
                </div>
              </div>
              <div className="erp-toolbar" style={{ flexShrink: 0 }}>
                <Space wrap>
                  <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => setEditModalVisible(true)}>增加</Button>
                  <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1}>编辑</Button>
                  <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0}>删除</Button>
                  <Button icon={renderIcon('PoweroffOutlined')}>禁用/启用</Button>
                  <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
                </Space>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                  style={{ marginLeft: 'auto' }}
                >
                  自定义列
                </Button>
              </div>
              <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
                <Table
                  rowSelection={{ 
                    type: 'radio',
                    selectedRowKeys, 
                    onChange: setSelectedRowKeys 
                  }}
                  columns={tableColumns}
                  dataSource={filteredData}
                  rowKey="id"
                  scroll={{ x: 'max-content' }}
                  pagination={createPaginationConfig()}
                />
              </div>
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑客商"
            open={editModalVisible}
            onCancel={() => setEditModalVisible(false)}
            onOk={() => { message.success('保存成功'); setEditModalVisible(false); }}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="简称" name="shortName" required><Input /></Form.Item>
              <Form.Item label="全称" name="fullName" required><Input /></Form.Item>
              <Form.Item label="联系人" name="contact"><Input /></Form.Item>
              <Form.Item label="手机号" name="phone"><Input /></Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allColumnDefinitions}
              visibleColumns={visibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 保值方案管理页面
    const HedgePlanManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [tagManageModalVisible, setTagManageModalVisible] = useState(false);
      const [form] = Form.useForm();
      const [tagForm] = Form.useForm();
      const [availableTags, setAvailableTags] = useState(() => getTags());
      const [selectedHedgePlanType, setSelectedHedgePlanType] = useState(null);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '名称', dataIndex: 'name', width: 200 },
        { key: 'type', title: '类型', dataIndex: 'type', width: 120 },
        { key: 'instructionTypes', title: '指令类型列表', dataIndex: 'instructionTypes', width: 250, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员列表', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'makers', title: '制单员列表', dataIndex: 'makers', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'tags', title: '标签列表', dataIndex: 'tags', width: 250, render: (arr) => {
          if (!arr || arr.length === 0) return '-';
          return (
            <Space wrap>
              {arr.map((tag, index) => (
                <Tag key={index} color="blue">{tag}</Tag>
              ))}
            </Space>
          );
        }},
        { key: 'remark', title: '备注', dataIndex: 'remark', ellipsis: true }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: hedgeVisibleColumns
      } = useColumnManager('hedge-plan', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleAdd = () => {
        form.resetFields();
        setSelectedHedgePlanType(null);
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockHedgePlans.find(hp => hp.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue({
            id: record.id,
            name: record.name,
            type: record.type,
            instructionTypes: record.instructionTypes,
            traders: record.traders?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            makers: record.makers?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            tags: record.tags || [],
            remark: record.remark || ''
          });
          setSelectedHedgePlanType(record.type);
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id');
          
          // 检查重复名称（新增时）
          if (!editingId) {
            const exists = mockHedgePlans.some(hp => hp.name === values.name);
            if (exists) {
              message.error('已有重复名称的保值方案，不能增加');
              return;
            }
          }
          
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
          setSelectedHedgePlanType(null);
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        // 检查是否有合同在用
        const selectedPlans = mockHedgePlans.filter(hp => selectedRowKeys.includes(hp.id));
        const hasContracts = selectedPlans.some(plan => {
          return mockContracts.some(contract => contract.hedgePlan === plan.name);
        });
        
        if (hasContracts) {
          message.error('有合同在用的保值方案不能删除');
          return;
        }
        
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedPlans = mockHedgePlans.filter(hp => selectedRowKeys.includes(hp.id));
        const hasDisabled = selectedPlans.some(hp => hp.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      const handleTagManage = () => {
        tagForm.setFieldsValue({ tags: availableTags });
        setTagManageModalVisible(true);
      };

      const handleTagSave = () => {
        tagForm.validateFields().then(values => {
          const tags = values.tags || [];
          // 过滤空标签
          const validTags = tags.filter(tag => tag && tag.trim());
          setAvailableTags(validTags);
          saveTags(validTags);
          message.success('标签保存成功');
          setTagManageModalVisible(false);
        });
      };

      // 获取交易员列表
      const traderOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取制单员列表
      const makerOptions = useMemo(() => {
        const makers = mockPersonRoles.find(pr => pr.roleName === '制单员');
        if (makers && makers.personIds) {
          return mockPersons.filter(p => makers.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 根据保值方案类型过滤指令类型
      const getAvailableInstructionTypes = (hedgePlanType) => {
        const allTypes = [
          { name: '期货交易指令', types: ['整体匹配', '单单匹配', '无合同（人员）', '无合同（客商）'] },
          { name: '合同创建指令', types: ['整体匹配', '单单匹配'] },
          { name: '一口价创建套保指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案移仓换月指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案净值套保指令', types: ['整体匹配'] },
          { name: '保值方案均价净值套保指令', types: ['整体匹配'] },
          { name: '非均价合同套保指令', types: ['单单匹配'] },
          { name: '均价合同套保指令', types: ['单单匹配'] },
          { name: '点价指令', types: ['单单匹配'] },
          { name: '非均价合同变更指令', types: ['单单匹配'] },
          { name: '均价合同变更指令', types: ['单单匹配'] }
        ];
        return allTypes.filter(it => it.types.includes(hedgePlanType)).map(it => it.name);
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('BookOutlined')} onClick={handleTagManage}>管理标签</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={mockHedgePlans}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑保值方案"
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields(); 
              setSelectedHedgePlanType(null);
            }}
            width={700}
            onOk={handleSave}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="名称" name="name" required rules={[{ required: true, message: '请输入名称' }]}>
                <Input placeholder="请输入保值方案名称" />
              </Form.Item>
              <Form.Item label="类型" name="type" required rules={[{ required: true, message: '请选择类型' }]}>
                <Select 
                  placeholder="请选择保值方案类型"
                  onChange={(value) => {
                    setSelectedHedgePlanType(value);
                    // 当类型改变时，清空并重新设置指令类型选项
                    form.setFieldsValue({ instructionTypes: [] });
                  }}
                >
                  <Select.Option value="整体匹配">整体匹配</Select.Option>
                  <Select.Option value="单单匹配">单单匹配</Select.Option>
                  <Select.Option value="无合同（人员）">无合同（人员）</Select.Option>
                  <Select.Option value="无合同（客商）">无合同（客商）</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item 
                label="指令类型" 
                name="instructionTypes"
                rules={[
                  { type: 'array', min: 1, message: '至少选择一个指令类型' },
                  ({ getFieldValue }) => ({
                    validator(_, value) {
                      const type = getFieldValue('type') || selectedHedgePlanType;
                      if (!type || !value || value.length === 0) {
                        return Promise.resolve();
                      }
                      const availableTypes = getAvailableInstructionTypes(type);
                      const invalidTypes = value.filter(v => !availableTypes.includes(v));
                      if (invalidTypes.length > 0) {
                        return Promise.reject(new Error(`整体的保值方案中不能选单单类型的指令：${invalidTypes.join(', ')}`));
                      }
                      return Promise.resolve();
                    }
                  })
                ]}
              >
                <Select 
                  mode="multiple" 
                  placeholder={selectedHedgePlanType ? "选择指令类型" : "请先选择保值方案类型"}
                  disabled={!selectedHedgePlanType}
                  options={selectedHedgePlanType ? getAvailableInstructionTypes(selectedHedgePlanType).map(name => ({ label: name, value: name })) : []}
                />
              </Form.Item>
              <Form.Item label="交易员列表" name="traders">
                <Select 
                  mode="multiple" 
                  placeholder="选择交易员（可多选）"
                  options={traderOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="制单员列表" name="makers">
                <Select 
                  mode="multiple" 
                  placeholder="选择制单员（可多选）"
                  options={makerOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item 
                label="标签列表" 
                name="tags"
                tooltip="标签用于期现备注中的标签选项，每笔期货都应该有保值方案，期现备注中的标签选项来源于对应保值方案设置的标签"
              >
                <Select 
                  mode="tags" 
                  placeholder="选择或输入标签（可多选）"
                  options={availableTags.map(tag => ({ label: tag, value: tag }))}
                  tokenSeparators={[',']}
                  style={{ width: '100%' }}
                />
              </Form.Item>
              <Form.Item label="备注" name="remark">
                <Input.TextArea rows={3} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="管理标签"
            open={tagManageModalVisible}
            onCancel={() => { setTagManageModalVisible(false); tagForm.resetFields(); }}
            width={600}
            onOk={handleTagSave}
          >
            <Alert
              type="info"
              showIcon
              message="标签说明"
              description="标签是业务中的具体操作分类，保值方案是业务类型或流程。标签作为期现备注中的可选项，每笔期货都应该有保值方案，期现备注中的标签选项来源于对应保值方案设置的标签。"
              style={{ marginBottom: 16 }}
            />
            <Form form={tagForm} layout="vertical">
              <Form.Item 
                label="标签列表" 
                name="tags"
                rules={[{ required: true, message: '至少需要一个标签' }]}
              >
                <Form.List name="tags" initialValue={availableTags}>
                  {(fields, { add, remove }) => (
                    <Space direction="vertical" style={{ width: '100%' }}>
                      {fields.map((field, index) => (
                        <Space key={field.key} align="baseline" style={{ width: '100%' }}>
                          <Form.Item
                            {...field}
                            name={[field.name]}
                            fieldKey={[field.fieldKey]}
                            rules={[{ required: true, message: '请输入标签名称' }]}
                            style={{ flex: 1, marginBottom: 0 }}
                          >
                            <Input placeholder="请输入标签名称" />
                          </Form.Item>
                          {fields.length > 1 && (
                            <Button
                              type="text"
                              danger
                              icon={renderIcon('DeleteOutlined')}
                              onClick={() => remove(field.name)}
                            />
                          )}
                        </Space>
                      ))}
                      <Button
                        type="dashed"
                        onClick={() => add('')}
                        icon={renderIcon('PlusOutlined')}
                        block
                      >
                        新增标签
                      </Button>
                    </Space>
                  )}
                </Form.List>
              </Form.Item>
              <Form.Item>
                <Button 
                  type="link" 
                  onClick={() => {
                    tagForm.setFieldsValue({ tags: [...defaultTags] });
                    message.info('已恢复为缺省标签');
                  }}
                >
                  恢复缺省标签
                </Button>
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={hedgeVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 期货账户管理页面
    const FuturesAccountManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'account', title: '期货账户', dataIndex: 'account', width: 150 },
        { key: 'status', title: '账户状态', dataIndex: 'status', width: 120, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 200, render: (arr) => arr?.join(', ') || '-' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: futuresVisibleColumns
      } = useColumnManager('futures-account', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => setEditModalVisible(true)}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('UserOutlined')} disabled={selectedRowKeys.length !== 1}>绑定交易员</Button>
              <Button icon={renderIcon('SafetyOutlined')} disabled={selectedRowKeys.length !== 1}>设置账户风控限制</Button>
              <Button icon={renderIcon('PoweroffOutlined')}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={mockFuturesAccounts}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑期货账户"
            open={editModalVisible}
            onCancel={() => setEditModalVisible(false)}
            onOk={() => { message.success('保存成功'); setEditModalVisible(false); }}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="期货账户" name="account" required><Input /></Form.Item>
              <Form.Item label="密码" name="password"><Input.Password /></Form.Item>
              <Form.Item label="期货公司" name="company"><Input /></Form.Item>
              <Form.Item label="前置" name="frontend"><Input /></Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={futuresVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 人员管理页面
    const PersonManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ name: '', phone: '' });
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '姓名', dataIndex: 'name', width: 150 },
        { key: 'role', title: '角色', dataIndex: 'role', width: 150 },
        { key: 'phone', title: '手机号', dataIndex: 'phone', width: 150 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: personVisibleColumns
      } = useColumnManager('person', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 从数据中提取唯一的姓名和手机号列表
      const nameOptions = useMemo(() => {
        const uniqueNames = [...new Set(mockPersons.map(item => item.name).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, []);

      const phoneOptions = useMemo(() => {
        const uniquePhones = [...new Set(mockPersons.map(item => item.phone).filter(Boolean))];
        return uniquePhones.map(phone => ({ label: phone, value: phone }));
      }, []);

      const filteredData = useMemo(() => {
        return mockPersons.map(person => {
          // 从人员角色关系中获取角色（每个角色一行，每个角色包含多个人员）
          const roles = mockPersonRoles
            .filter(pr => pr.personIds?.includes(person.id) && pr.status === 'enabled')
            .map(pr => pr.roleName);
          return {
            ...person,
            role: roles.join(', ') || '-'
          };
        }).filter(item => {
          if (filters.name && !item.name.includes(filters.name)) return false;
          if (filters.phone && !item.phone.includes(filters.phone)) return false;
          return true;
        });
      }, [filters]);

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的人员');
          return;
        }
        // 检查是否有保值方案绑定或角色绑定
        const selectedPersons = mockPersons.filter(p => selectedRowKeys.includes(p.id));
        const hasHedgePlan = selectedPersons.some(p => {
          return mockHedgePlans.some(hp => 
            hp.traders?.includes(p.name) || hp.makers?.includes(p.name)
          );
        });
        const hasRole = selectedPersons.some(p => {
          return mockPersonRoles.some(pr => pr.personId === p.id && pr.status === 'enabled');
        });
        
        if (hasHedgePlan) {
          message.error('有保值方案绑定的人员不能删除');
          return;
        }
        if (hasRole) {
          message.error('有角色绑定的人员不能删除');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 个人员吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleAdd = () => {
        form.resetFields();
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一个人员进行编辑');
          return;
        }
        const person = mockPersons.find(p => p.id === selectedRowKeys[0]);
        if (person) {
          form.setFieldsValue(person);
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          // 检查重复姓名（新增时）
          if (!form.getFieldValue('id')) {
            const exists = mockPersons.some(p => p.name === values.name);
            if (exists) {
              message.error('已有重复姓名的人员，不能增加');
              return;
            }
          }
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的人员');
          return;
        }
        const selectedPersons = mockPersons.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedPersons.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 个人员吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>姓名：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择姓名"
                style={{ width: 200 }}
                value={filters.name || undefined}
                onChange={(value) => setFilters({...filters, name: value || ''})}
                options={nameOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
            <div className="erp-filter-item">
              <label>手机号：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择手机号"
                style={{ width: 200 }}
                value={filters.phone || undefined}
                onChange={(value) => setFilters({...filters, phone: value || ''})}
                options={phoneOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑人员"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); }}
            onOk={handleSave}
            width={500}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="姓名" name="name" required rules={[{ required: true, message: '请输入姓名' }]}>
                <Input placeholder="请输入姓名" />
              </Form.Item>
              <Form.Item label="手机号" name="phone" required rules={[{ required: true, message: '请输入手机号' }, { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号' }]}>
                <Input placeholder="请输入手机号" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={personVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 人员角色管理页面
    const PersonRoleManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ role: '', name: '' });
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'roleName', title: '角色', dataIndex: 'roleName', width: 150 },
        { 
          key: 'personNames', 
          title: '姓名', 
          dataIndex: 'personNames', 
          width: 300,
          render: (value, record) => {
            // 从 record 中获取 personNames，优先使用 value（dataIndex 对应的值）
            const personNames = value || record?.personNames || [];
            if (!Array.isArray(personNames) || personNames.length === 0) {
              return <span style={{ color: '#999' }}>-</span>;
            }
            return (
              <div style={{ lineHeight: '1.8', whiteSpace: 'normal' }}>
                {personNames.map((name, index) => (
                  <div key={index} style={{ marginBottom: index < personNames.length - 1 ? '4px' : '0' }}>
                    {name}
                  </div>
                ))}
              </div>
            );
          }
        },
        { key: 'description', title: '角色解释', dataIndex: 'description', width: 250 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: personRoleVisibleColumns
      } = useColumnManager('person-role', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 从数据中提取唯一的角色列表
      const roleOptions = useMemo(() => {
        return mockRoles.map(role => ({ label: role.name, value: role.name }));
      }, []);

      // 从所有人员角色关系中提取所有人员姓名（用于筛选）
      const allPersonNames = useMemo(() => {
        const names = new Set();
        mockPersonRoles.forEach(pr => {
          if (pr.personNames) {
            pr.personNames.forEach(name => names.add(name));
          }
        });
        return Array.from(names).map(name => ({ label: name, value: name }));
      }, []);

      const filteredData = useMemo(() => {
        return mockPersonRoles.filter(item => {
          if (filters.role && !item.roleName.includes(filters.role)) return false;
          if (filters.name && item.personNames && !item.personNames.some(name => name.includes(filters.name))) return false;
          return true;
        });
      }, [filters]);

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的角色');
          return;
        }
        // 检查是否已绑定期货账户的交易员
        const selectedRoles = mockPersonRoles.filter(pr => selectedRowKeys.includes(pr.id));
        const hasFuturesAccount = selectedRoles.some(pr => {
          if (pr.roleName === '交易员' && pr.personNames) {
            return pr.personNames.some(personName => {
              return mockFuturesAccounts.some(fa => fa.traders?.includes(personName));
            });
          }
          return false;
        });
        
        if (hasFuturesAccount) {
          message.error('已绑定期货账户的交易员不能解除人员与角色关系');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 个角色配置吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleAdd = () => {
        form.resetFields();
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一个角色进行编辑');
          return;
        }
        const role = mockPersonRoles.find(pr => pr.id === selectedRowKeys[0]);
        if (role) {
          form.setFieldsValue({
            id: role.id,
            roleId: role.roleId,
            personIds: role.personIds || []
          });
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id');
          
          // 检查一类角色只能增加一行（新增时）
          if (!editingId) {
            // 新增：检查该角色是否已存在
            const existingRole = mockPersonRoles.find(pr => pr.roleId === values.roleId);
            if (existingRole) {
              message.error('一类角色只能增加一行');
              return;
            }
          } else {
            // 编辑：检查是否修改了角色，如果修改了角色，检查新角色是否已存在
            const currentRole = mockPersonRoles.find(pr => pr.id === editingId);
            if (currentRole && currentRole.roleId !== values.roleId) {
              const existingRole = mockPersonRoles.find(pr => pr.roleId === values.roleId);
              if (existingRole) {
                message.error('一类角色只能增加一行，不能修改为已存在的角色');
                return;
              }
            }
          }
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的角色');
          return;
        }
        const selectedRoles = mockPersonRoles.filter(pr => selectedRowKeys.includes(pr.id));
        const hasDisabled = selectedRoles.some(pr => pr.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 个角色配置吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>角色：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择角色"
                style={{ width: 200 }}
                value={filters.role || undefined}
                onChange={(value) => setFilters({...filters, role: value || ''})}
                options={roleOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
            <div className="erp-filter-item">
              <label>姓名：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择姓名"
                style={{ width: 200 }}
                value={filters.name || undefined}
                onChange={(value) => setFilters({...filters, name: value || ''})}
                options={allPersonNames}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑人员与角色关系"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); }}
            onOk={handleSave}
            width={500}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="角色" name="roleId" required rules={[{ required: true, message: '请选择角色' }]}>
                <Select 
                  placeholder="请选择角色"
                  disabled={!!form.getFieldValue('id')} // 编辑时禁用角色选择
                >
                  {mockRoles.map(role => (
                    <Select.Option key={role.id} value={role.id}>{role.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="人员" name="personIds" required rules={[{ required: true, message: '请选择人员' }, { type: 'array', min: 1, message: '至少选择一个人员' }]}>
                <Select 
                  mode="multiple"
                  placeholder="请选择人员（可多选）"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.children ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                >
                  {mockPersons.map(person => (
                    <Select.Option key={person.id} value={person.id}>{person.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={personRoleVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 合同管理页面
    const ContractManagement = ({ contractType = 'purchase' }) => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [linkModalVisible, setLinkModalVisible] = useState(false);
      const [unlinkModalVisible, setUnlinkModalVisible] = useState(false);
      const [priceModalVisible, setPriceModalVisible] = useState(false);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 150 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150, fixed: 'left' },
        { key: 'customer', title: contractType === 'purchase' ? '供应商' : '客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'pricing', title: '计价方式', dataIndex: 'pricing', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'price', title: '单价', dataIndex: 'price', width: 120, align: 'right' },
        { key: 'settlementPrice', title: '结算单价', dataIndex: 'settlementPrice', width: 120, align: 'right' },
        { key: 'amount', title: '合同金额', dataIndex: 'amount', width: 150, align: 'right' },
        { key: 'settlementAmount', title: '结算金额', dataIndex: 'settlementAmount', width: 150, align: 'right' },
        { key: 'transport', title: '运输方式', dataIndex: 'transport', width: 120 },
        { key: 'deliveryDate', title: '交割日期', dataIndex: 'deliveryDate', width: 120 },
        { key: 'pricedQty', title: '已点数量', dataIndex: 'pricedQty', width: 120, align: 'right' },
        { key: 'unpricedQty', title: '未点数量', dataIndex: 'unpricedQty', width: 120, align: 'right' },
        { key: 'creator', title: '创建人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '创建日期时间', dataIndex: 'createTime', width: 160 },
        { key: 'occurTime', title: '发生日期时间', dataIndex: 'occurTime', width: 160 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: contractVisibleColumns
      } = useColumnManager(`contract-${contractType}`, allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => setEditModalVisible(true)}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1}>编辑（变更）</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0}>删除（作废）</Button>
              <Button icon={renderIcon('LinkOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setLinkModalVisible(true)}>关联</Button>
              <Button icon={renderIcon('DisconnectOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setUnlinkModalVisible(true)}>解除关联</Button>
              <Button icon={renderIcon('DollarOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setPriceModalVisible(true)}>点价</Button>
              <Button icon={renderIcon('PoweroffOutlined')}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={mockContracts}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="关联"
            open={linkModalVisible}
            onCancel={() => setLinkModalVisible(false)}
            width={900}
          >
            <Tabs>
              <Tabs.TabPane tab="期现关联" key="futures">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>合约：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>成交日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>价格：</label>
                    <InputNumber style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合约', dataIndex: 'contract' },
                    { title: '成交日期', dataIndex: 'date' },
                    { title: '价格', dataIndex: 'price' },
                    { title: '期货数量', dataIndex: 'futuresQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '合同数量', dataIndex: 'contractQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setLinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
              <Tabs.TabPane tab="采销关联" key="sales">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>合同编号：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>客商：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>业务经理：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合同编号', dataIndex: 'contractNo' },
                    { title: '客商', dataIndex: 'customer' },
                    { title: '数量', dataIndex: 'qty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setLinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
            </Tabs>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="解除关联"
            open={unlinkModalVisible}
            onCancel={() => setUnlinkModalVisible(false)}
            width={900}
          >
            <Tabs>
              <Tabs.TabPane tab="解除期现关联" key="futures">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>关联日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>合约：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>成交日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合约', dataIndex: 'contract' },
                    { title: '成交日期', dataIndex: 'date' },
                    { title: '解除期货数量', dataIndex: 'futuresQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '解除合同数量', dataIndex: 'contractQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生日期时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setUnlinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
              <Tabs.TabPane tab="解除采销关联" key="sales">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>关联日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>合同编号：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>客商：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>业务经理：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合同编号', dataIndex: 'contractNo' },
                    { title: '客商', dataIndex: 'customer' },
                    { title: '解除数量', dataIndex: 'qty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生日期时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setUnlinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
            </Tabs>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="点价"
            open={priceModalVisible}
            onCancel={() => setPriceModalVisible(false)}
            width={800}
          >
            <Form layout="vertical">
              <Form.Item label="点价数量" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="点价价格" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="发生日期时间" required><DatePicker showTime style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="期货委托表">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>合约：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>成交日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>价格：</label>
                    <InputNumber style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合约', dataIndex: 'contract' },
                    { title: '成交日期', dataIndex: 'date' },
                    { title: '价格', dataIndex: 'price' },
                    { title: '期货数量', dataIndex: 'futuresQty', render: () => <InputNumber style={{ width: 100 }} /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
              </Form.Item>
              <Space style={{ marginTop: 16 }}>
                <Button type="primary">确认</Button>
                <Button onClick={() => setPriceModalVisible(false)}>取消</Button>
              </Space>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="创建/编辑合同"
            open={editModalVisible}
            onCancel={() => setEditModalVisible(false)}
            width={800}
            onOk={() => { message.success('保存成功'); setEditModalVisible(false); }}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="保值方案" name="hedgePlan" required><Select /></Form.Item>
              <Form.Item label="业务经理" name="manager"><Select /></Form.Item>
              <Form.Item label="合同编号" name="contractNo" required><Input /></Form.Item>
              <Form.Item label={contractType === 'purchase' ? '供应商' : '客户'} name="customer" required><Select /></Form.Item>
              <Form.Item label="现货品种" name="spotType" required><Select /></Form.Item>
              <Form.Item label="品牌" name="brand" required><Select /></Form.Item>
              <Form.Item label="计价方式" name="pricing" required>
                <Select>
                  <Select.Option value="一口价">一口价</Select.Option>
                  <Select.Option value="暂定价">暂定价</Select.Option>
                  <Select.Option value="均价">均价</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item label="合同数量" name="qty" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="单价" name="price"><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="运输方式" name="transport">
                <Select>
                  <Select.Option value="自提">自提</Select.Option>
                  <Select.Option value="送到">送到</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item label="交割日期" name="deliveryDate" required><DatePicker style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="均价起止日" name="avgDateRange"><DatePicker.RangePicker style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="点价截止日" name="priceDeadline"><DatePicker style={{ width: '100%' }} /></Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={contractVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 指令工作台页面
    const InstructionWorkbench = () => {
      const [role, setRole] = useState('trader');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);

      const mockInstructions = [
        { id: 1, type: '期货交易指令', status: '待完成', trader: '交易员A', contract: 'HT2025-0001', futures: 'CU2401', qty: 100, price: 5300, createTime: '2025-11-10 10:00' },
        { id: 2, type: '点价指令', status: '待完成', trader: '交易员B', contract: 'HT2025-0002', futures: 'AL2401', qty: 200, price: 0, createTime: '2025-11-11 14:30' }
      ];

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'type', title: '指令类型', dataIndex: 'type', width: 150 },
        { key: 'status', title: '指令状态', dataIndex: 'status', width: 120, render: (status) => {
          const color = status === '完成' ? 'green' : status === '撤销待处理' ? 'orange' : 'blue';
          return <Tag color={color}>{status}</Tag>;
        }},
        { key: 'trader', title: '交易员', dataIndex: 'trader', width: 120 },
        { key: 'contract', title: '合同', dataIndex: 'contract', width: 150 },
        { key: 'futures', title: '期货', dataIndex: 'futures', width: 120 },
        { key: 'qty', title: '数量', dataIndex: 'qty', width: 100, align: 'right' },
        { key: 'price', title: '价格', dataIndex: 'price', width: 120, align: 'right' },
        { key: 'createTime', title: '创建时间', dataIndex: 'createTime', width: 160 },
        { key: 'action', title: '操作', key: 'action', width: 200, fixed: 'right', render: () => (
          <Space>
            <Button size="small" type="link">查看详情</Button>
            <Button size="small" type="link">备注</Button>
            <Button size="small" type="link">完成</Button>
          </Space>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: instructionVisibleColumns
      } = useColumnManager('instruction-workbench', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar">
            <Space wrap>
              <Radio.Group value={role} onChange={(e) => setRole(e.target.value)}>
                <Radio.Button value="trader">交易员工作台</Radio.Button>
                <Radio.Button value="manager">业务经理工作台</Radio.Button>
                <Radio.Button value="maker">指令员工作台</Radio.Button>
                <Radio.Button value="clerk">制单员工作台</Radio.Button>
                <Radio.Button value="customer">客商工作台</Radio.Button>
              </Radio.Group>
            </Space>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')}>发起指令</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={mockInstructions}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={instructionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 人员指令权限设置页面
    const PersonInstructionPermission = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();
      const [selectedInstructionType, setSelectedInstructionType] = useState(null);
      const [selectedHedgePlan, setSelectedHedgePlan] = useState(null);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'creators', title: '指令创建人', dataIndex: 'creators', width: 200, render: (arr) => arr?.join(', ') || '-' },
        { key: 'makers', title: '制单员', dataIndex: 'makers', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: permissionVisibleColumns
      } = useColumnManager('person-instruction-permission', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取所有角色下的人员
      const getPersonsByRole = () => {
        const rolePersonMap = {};
        mockPersonRoles.forEach(pr => {
          if (pr.status === 'enabled' && pr.personNames) {
            if (!rolePersonMap[pr.roleName]) {
              rolePersonMap[pr.roleName] = [];
            }
            pr.personNames.forEach(name => {
              const person = mockPersons.find(p => p.name === name);
              if (person && !rolePersonMap[pr.roleName].find(p => p.id === person.id)) {
                rolePersonMap[pr.roleName].push(person);
              }
            });
          }
        });
        return rolePersonMap;
      };

      const rolePersonMap = useMemo(() => getPersonsByRole(), []);

      // 获取制单员列表
      const makerOptions = useMemo(() => {
        const makers = mockPersonRoles.find(pr => pr.roleName === '制单员');
        if (makers && makers.personIds) {
          return mockPersons.filter(p => makers.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取交易员列表
      const traderOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      const handleAdd = () => {
        form.resetFields();
        setSelectedInstructionType(null);
        setSelectedHedgePlan(null);
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockPersonInstructionPermissions.find(p => p.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue({
            id: record.id,
            instructionTypeId: mockInstructionTypes.find(it => it.name === record.instructionType)?.id,
            hedgePlanId: mockHedgePlans.find(hp => hp.name === record.hedgePlan)?.id,
            creators: record.creators?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            makers: record.makers?.map(name => makerOptions.find(p => p.name === name)?.id).filter(Boolean) || [],
            traders: record.traders?.map(name => traderOptions.find(p => p.name === name)?.id).filter(Boolean) || []
          });
          setSelectedInstructionType(mockInstructionTypes.find(it => it.name === record.instructionType)?.id);
          setSelectedHedgePlan(mockHedgePlans.find(hp => hp.name === record.hedgePlan));
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
          setSelectedInstructionType(null);
          setSelectedHedgePlan(null);
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockPersonInstructionPermissions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      // 判断是否显示期货相关字段
      const showFuturesFields = () => {
        if (!selectedInstructionType) return false;
        const instructionType = mockInstructionTypes.find(it => it.id === selectedInstructionType);
        return instructionType && instructionType.name !== '合同创建指令';
      };

      // 判断是否显示持仓限制字段
      const showPositionLimitFields = () => {
        if (!selectedInstructionType || !selectedHedgePlan) return false;
        const instructionType = mockInstructionTypes.find(it => it.id === selectedInstructionType);
        return instructionType?.name === '期货交易指令' && selectedHedgePlan?.type === '无合同（人员）';
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>修改</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={mockPersonInstructionPermissions}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="创建/修改人员指令权限"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); setSelectedInstructionType(null); setSelectedHedgePlan(null); }}
            onOk={handleSave}
            width={700}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="指令类型" name="instructionTypeId" required rules={[{ required: true, message: '请选择指令类型' }]}>
                <Select 
                  placeholder="请选择指令类型"
                  onChange={(value) => {
                    setSelectedInstructionType(value);
                    const instructionType = mockInstructionTypes.find(it => it.id === value);
                    if (instructionType?.name === '合同创建指令') {
                      form.setFieldsValue({ futuresVarietyLimit: [], futuresContractLimit: [] });
                    }
                  }}
                >
                  {mockInstructionTypes.map(it => (
                    <Select.Option key={it.id} value={it.id}>{it.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="保值方案" name="hedgePlanId" required rules={[{ required: true, message: '请选择保值方案' }]}>
                <Select 
                  placeholder="请选择保值方案"
                  onChange={(value) => {
                    const plan = mockHedgePlans.find(hp => hp.id === value);
                    setSelectedHedgePlan(plan);
                  }}
                >
                  {mockHedgePlans.map(hp => (
                    <Select.Option key={hp.id} value={hp.id}>{hp.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="指令创建人" name="creators" required rules={[{ required: true, message: '请选择指令创建人' }, { type: 'array', min: 1, message: '至少选择一个创建人' }]}>
                <TreeSelect
                  multiple
                  placeholder="先选择角色，再勾选角色下的人员"
                  treeData={Object.keys(rolePersonMap).map(roleName => ({
                    title: roleName,
                    value: `role_${roleName}`,
                    selectable: false,
                    children: rolePersonMap[roleName].map(person => ({
                      title: person.name,
                      value: person.id
                    }))
                  }))}
                  style={{ width: '100%' }}
                />
              </Form.Item>
              {showFuturesFields() && (
                <>
                  <Form.Item label="期货品种限制" name="futuresVarietyLimit">
                    <Select mode="tags" placeholder="请输入或选择期货品种" />
                  </Form.Item>
                  <Form.Item label="期货合约限制" name="futuresContractLimit">
                    <Select mode="tags" placeholder="请输入或选择期货合约" />
                  </Form.Item>
                </>
              )}
              {showPositionLimitFields() && (
                <>
                  <Form.Item label="持仓方向限制" name="positionDirection">
                    <Radio.Group>
                      <Radio value="多头">多头</Radio>
                      <Radio value="空头">空头</Radio>
                    </Radio.Group>
                  </Form.Item>
                  <Form.Item label="持仓手数限制" name="positionLimit" rules={[{ pattern: /^\d+$/, message: '请输入正整数' }]}>
                    <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
                  </Form.Item>
                  <Form.Item label="单笔手数限制" name="singleOrderLimit" rules={[{ pattern: /^\d+$/, message: '请输入正整数' }]}>
                    <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
                  </Form.Item>
                </>
              )}
              <Form.Item label="制单员" name="makers">
                <Select 
                  mode="multiple"
                  placeholder="请选择制单员（可多选）"
                  options={makerOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="交易员" name="traders">
                <Select 
                  mode="multiple"
                  placeholder="请选择交易员（可多选，可选）"
                  options={traderOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={permissionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 客商指令权限设置页面
    const CustomerInstructionPermission = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'creators', title: '指令创建人', dataIndex: 'creators', width: 200, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'validUntil', title: '有效期', dataIndex: 'validUntil', width: 120 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: customerPermissionVisibleColumns
      } = useColumnManager('customer-instruction-permission', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取交易员列表
      const traderOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取无合同（客商）类型的保值方案
      const customerHedgePlans = useMemo(() => {
        return mockHedgePlans.filter(hp => hp.type === '无合同（客商）');
      }, []);

      const handleAdd = () => {
        form.resetFields();
        form.setFieldsValue({ instructionTypeId: 1 }); // 默认期货交易指令
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockCustomerInstructionPermissions.find(p => p.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue({
            id: record.id,
            instructionTypeId: 1, // 固定为期货交易指令
            hedgePlanId: mockHedgePlans.find(hp => hp.name === record.hedgePlan)?.id,
            creators: record.creators?.map(name => mockCustomers.find(c => c.shortName === name)?.id).filter(Boolean) || [],
            traders: record.traders?.map(name => traderOptions.find(p => p.name === name)?.id).filter(Boolean) || [],
            validUntil: record.validUntil ? dayjs(record.validUntil) : null
          });
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockCustomerInstructionPermissions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>修改</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={mockCustomerInstructionPermissions}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="创建/修改客商指令权限"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); }}
            onOk={handleSave}
            width={700}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="指令类型" name="instructionTypeId">
                <Input value="期货交易指令" disabled />
              </Form.Item>
              <Form.Item label="保值方案" name="hedgePlanId" required rules={[{ required: true, message: '请选择保值方案' }]}>
                <Select placeholder="请选择保值方案（只能选择无合同（客商）类型）">
                  {customerHedgePlans.map(hp => (
                    <Select.Option key={hp.id} value={hp.id}>{hp.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="指令创建人" name="creators" required rules={[{ required: true, message: '请选择指令创建人' }, { type: 'array', min: 1, message: '至少选择一个创建人' }]}>
                <Select 
                  mode="multiple"
                  placeholder="请选择客商（可多选）"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={mockCustomers.map(c => ({ label: c.shortName, value: c.id }))}
                />
              </Form.Item>
              <Form.Item label="期货合约限制" name="futuresContractLimit" required rules={[{ required: true, message: '请选择期货合约限制' }]}>
                <Select mode="multiple" placeholder="请选择期货合约（可多选）" />
              </Form.Item>
              <Form.Item label="持仓方向限制" name="positionDirection" required rules={[{ required: true, message: '请选择持仓方向限制' }]}>
                <Radio.Group>
                  <Radio value="多头">多头</Radio>
                  <Radio value="空头">空头</Radio>
                </Radio.Group>
              </Form.Item>
              <Form.Item label="持仓手数限制" name="positionLimit" required rules={[{ required: true, message: '请输入持仓手数限制' }, { pattern: /^\d+$/, message: '请输入正整数' }]}>
                <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
              </Form.Item>
              <Form.Item label="单笔手数限制" name="singleOrderLimit" required rules={[{ required: true, message: '请输入单笔手数限制' }, { pattern: /^\d+$/, message: '请输入正整数' }]}>
                <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
              </Form.Item>
              <Form.Item label="交易员" name="traders">
                <Select 
                  mode="multiple"
                  placeholder="请选择交易员（可多选，可选）"
                  options={traderOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="有效期" name="validUntil" required rules={[{ required: true, message: '请选择有效期' }]}>
                <DatePicker style={{ width: '100%' }} placeholder="请选择有效期（含）" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={customerPermissionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 均价自动指令启停页面
    const AvgPriceAutoInstruction = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'creator', title: '指令发起人', dataIndex: 'creator', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 200 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启动' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: avgPriceVisibleColumns
      } = useColumnManager('avg-price-auto-instruction', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockAvgPriceAutoInstructions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启动' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？${action === '启动' ? '启动后，系统将每日自动进行按保值方案或按合同的均价指令发起。' : ''}`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>启动/禁用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <Alert
              type="info"
              showIcon
              message="说明"
              description="本表格数据来源于人员指令权限设置中针对保值方案设置了'保值方案均价净值套保指令'或'均价合同套保指令'的记录。启动后，系统将每日自动进行按保值方案或按合同的均价指令发起。默认状态为禁用。"
              style={{ marginBottom: 16 }}
            />
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={mockAvgPriceAutoInstructions}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={avgPriceVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 匹配宝与委托备注页面
    const MatchAndRemark = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filterType, setFilterType] = useState('today'); // today or history
      const [spotRemarkModalVisible, setSpotRemarkModalVisible] = useState(false);
      const [orderRemarkModalVisible, setOrderRemarkModalVisible] = useState(false);
      const [batchMatchModalVisible, setBatchMatchModalVisible] = useState(false);
      const [singleMatchModalVisible, setSingleMatchModalVisible] = useState(false);
      const [matchResultModalVisible, setMatchResultModalVisible] = useState(false);
      const [spotRemarkColumnEditorVisible, setSpotRemarkColumnEditorVisible] = useState(false);
      const [currentFuturesId, setCurrentFuturesId] = useState(null);
      const [spotRemarkForm] = Form.useForm();
      const [orderRemarkForm] = Form.useForm();
      const [batchMatchForm] = Form.useForm();
      const [singleMatchForm] = Form.useForm();
      const [searchKeyword, setSearchKeyword] = useState('');

      // 获取当前显示的委托单数据
      const displayOrders = useMemo(() => {
        let orders = [...mockFuturesOrders];
        if (filterType === 'today') {
          const today = dayjs().format('YYYY-MM-DD');
          orders = orders.filter(order => order.dateTime.startsWith(today));
        }
        if (searchKeyword) {
          const keyword = searchKeyword.toLowerCase();
          orders = orders.filter(order => 
            order.shortNo.toLowerCase().includes(keyword) ||
            order.contract.toLowerCase().includes(keyword) ||
            order.futuresAccount.toLowerCase().includes(keyword) ||
            order.hedgePlan.toLowerCase().includes(keyword)
          );
        }
        return orders;
      }, [filterType, searchKeyword]);

      // 所有可用列定义（一级字段）
      const allColumnDefinitions = [
        { key: 'futuresAccount', title: '期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'dateTime', title: '日期时间', dataIndex: 'dateTime', width: 160 },
        { key: 'shortNo', title: '短编号', dataIndex: 'shortNo', width: 120 },
        { key: 'contract', title: '合约', dataIndex: 'contract', width: 120 },
        { key: 'direction', title: '方向', dataIndex: 'direction', width: 80, render: (dir) => (
          <Tag color={dir === '买入' ? 'red' : 'green'}>{dir}</Tag>
        )},
        { key: 'avgPrice', title: '成交均价', dataIndex: 'avgPrice', width: 120, align: 'right' },
        { key: 'tradedQty', title: '成交手数', dataIndex: 'tradedQty', width: 120, align: 'right' },
        { 
          key: 'spotRemarks', 
          title: '期现备注', 
          dataIndex: 'spotRemarks', 
          width: 400,
          render: (remarks, record) => {
            if (!remarks || remarks.length === 0) return '-';
            
            // 根据配置的可见列动态生成表格列
            const spotRemarkTableColumns = spotRemarkVisibleColumns.map(col => {
              const def = spotRemarkColumnDefinitions.find(d => d.key === col.key);
              if (!def) return null;
              
              const columnDef = {
                ...def,
                ...col,
                width: col.width || def.width || 100,
                title: def.title,
                align: def.align || 'left',
                dataIndex: def.dataIndex
              };
              
              // 添加render函数
              if (col.key === 'qty') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'spotQty') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'pricingPrice') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'tag') {
                columnDef.render = (tag) => tag ? <Tag>{tag}</Tag> : '-';
              } else if (col.key === 'remark') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'customer') {
                // customer字段对应customerId
                columnDef.dataIndex = 'customerId';
                columnDef.render = (id) => {
                  if (!id) return '-';
                  const customer = mockCustomers.find(c => c.id === id);
                  return customer ? customer.shortName : '-';
                };
              } else if (col.key === 'contractNo') {
                // contractNo字段对应contractId
                columnDef.dataIndex = 'contractId';
                columnDef.render = (id) => {
                  if (!id) return '-';
                  const contract = mockContracts.find(c => c.id === id);
                  return contract ? contract.contractNo : '-';
                };
              } else if (col.key === 'isMatched') {
                columnDef.render = (matched) => (
                  <Tag color={matched ? 'green' : 'default'}>{matched ? '是' : '否'}</Tag>
                );
              }
              
              return columnDef;
            }).filter(Boolean);
            
            return (
              <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                <Table
                  size="small"
                  dataSource={remarks}
                  rowKey="id"
                  pagination={false}
                  columns={spotRemarkTableColumns}
                />
              </div>
            );
          }
        },
        { key: 'orderPrice', title: '报单价格', dataIndex: 'orderPrice', width: 120, align: 'right' },
        { key: 'unmatchedQty', title: '未匹配手数', dataIndex: 'unmatchedQty', width: 120, align: 'right' },
        { key: 'orderStatus', title: '挂单状态', dataIndex: 'orderStatus', width: 100, render: (status) => {
          const statusMap = {
            '未成': { color: 'default' },
            '部成': { color: 'orange' },
            '全成': { color: 'green' },
            '已撤': { color: 'red' },
            '部成已撤': { color: 'red' },
            '错单': { color: 'red' }
          };
          const config = statusMap[status] || { color: 'default' };
          return <Tag color={config.color}>{status}</Tag>;
        }},
        { key: 'orderRemark', title: '委托备注', dataIndex: 'orderRemark', width: 200, ellipsis: true, render: (remark) => {
          if (!remark) return '';
          const text = remark.replace(/<[^>]*>/g, '').substring(0, 50);
          return (
            <Tooltip title={<div dangerouslySetInnerHTML={{ __html: remark }} />}>
              <span>{text}{remark.length > 50 ? '...' : ''}</span>
            </Tooltip>
          );
        }}
      ];

      // 期现备注二级字段列定义
      const spotRemarkColumnDefinitions = [
        { key: 'qty', title: '手数', dataIndex: 'qty', width: 80, align: 'right' },
        { key: 'spotQty', title: '现货数量', dataIndex: 'spotQty', width: 100, align: 'right' },
        { key: 'pricingPrice', title: '点价价格', dataIndex: 'pricingPrice', width: 100, align: 'right' },
        { key: 'tag', title: '标签', dataIndex: 'tag', width: 120 },
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 150, ellipsis: true },
        { key: 'customer', title: '客商', dataIndex: 'customerId', width: 120 },
        { key: 'contractNo', title: '合同号', dataIndex: 'contractId', width: 120 },
        { key: 'isMatched', title: '是否已匹配', dataIndex: 'isMatched', width: 100 }
      ];

      // 期现备注二级字段的默认可见列
      const defaultSpotRemarkVisibleColumns = spotRemarkColumnDefinitions;

      // 期现备注二级字段的列管理
      const [spotRemarkVisibleColumns, setSpotRemarkVisibleColumns] = useState(() => {
        const saved = localStorage.getItem('match-remark-spot-columns');
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            return defaultSpotRemarkVisibleColumns;
          }
        }
        return defaultSpotRemarkVisibleColumns;
      });

      useEffect(() => {
        localStorage.setItem('match-remark-spot-columns', JSON.stringify(spotRemarkVisibleColumns));
      }, [spotRemarkVisibleColumns]);

      // 期现备注列配置的保存和恢复
      const handleSpotRemarkColumnSave = (columns) => {
        setSpotRemarkVisibleColumns(columns);
        setSpotRemarkColumnEditorVisible(false);
        message.success('期现备注列设置已保存');
      };

      const handleSpotRemarkColumnRestoreDefault = () => {
        setSpotRemarkVisibleColumns(defaultSpotRemarkVisibleColumns);
        setSpotRemarkColumnEditorVisible(false);
        message.success('已恢复期现备注默认列设置');
      };

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: matchVisibleColumns
      } = useColumnManager('match-remark', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取保值方案的标签
      const getHedgePlanTags = (hedgePlanId) => {
        const plan = mockHedgePlans.find(hp => hp.id === hedgePlanId);
        return plan?.tags || [];
      };

      // 获取同保值方案的合同列表
      const getContractsByHedgePlan = (hedgePlanId) => {
        const plan = mockHedgePlans.find(hp => hp.id === hedgePlanId);
        if (!plan) return [];
        return mockContracts.filter(c => c.hedgePlan === plan.name);
      };

      // 处理期现备注
      const handleSpotRemark = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = displayOrders.find(o => o.id === selectedRowKeys[0]);
        if (order) {
          setCurrentFuturesId(order.id);
          spotRemarkForm.setFieldsValue({
            spotRemarks: order.spotRemarks || []
          });
          setSpotRemarkModalVisible(true);
        }
      };

      // 处理委托备注
      const handleOrderRemark = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = displayOrders.find(o => o.id === selectedRowKeys[0]);
        if (order) {
          setCurrentFuturesId(order.id);
          orderRemarkForm.setFieldsValue({
            orderRemark: order.orderRemark || ''
          });
          setOrderRemarkModalVisible(true);
        }
      };

      // 保存期现备注
      const handleSaveSpotRemark = () => {
        spotRemarkForm.validateFields().then(values => {
          const order = displayOrders.find(o => o.id === currentFuturesId);
          if (order) {
            const totalQty = (values.spotRemarks || []).reduce((sum, r) => sum + (r.qty || 0), 0);
            if (totalQty > order.tradedQty) {
              message.error(`期现备注中的总手数不能大于委托单的已成交手数（${order.tradedQty}）`);
              return;
            }
          }
          message.success('保存成功');
          setSpotRemarkModalVisible(false);
          spotRemarkForm.resetFields();
        });
      };

      // 保存委托备注
      const handleSaveOrderRemark = () => {
        orderRemarkForm.validateFields().then(values => {
          message.success('保存成功');
          setOrderRemarkModalVisible(false);
          orderRemarkForm.resetFields();
        });
      };

      // 删除委托备注
      const handleDeleteOrderRemark = () => {
        if (currentFuturesId) {
          message.success('删除成功');
          setOrderRemarkModalVisible(false);
          orderRemarkForm.resetFields();
        }
      };

      // 批量匹配
      const handleBatchMatch = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要匹配的委托单');
          return;
        }
        const selectedOrders = displayOrders.filter(o => selectedRowKeys.includes(o.id));
        batchMatchForm.setFieldsValue({
          matchRecords: selectedOrders.map(order => ({
            futuresId: order.id,
            hedgePlanId: order.hedgePlanId,
            contractId: null,
            contractQty: null,
            contractPrice: null,
            futuresQty: order.unmatchedQty
          }))
        });
        setBatchMatchModalVisible(true);
      };

      // 单条匹配
      const handleSingleMatch = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = displayOrders.find(o => o.id === selectedRowKeys[0]);
        if (order) {
          const plan = mockHedgePlans.find(hp => hp.id === order.hedgePlanId);
          singleMatchForm.setFieldsValue({
            futuresId: order.id,
            hedgePlanId: order.hedgePlanId,
            hedgePlanType: plan?.type,
            contractId: null,
            contractQty: null,
            contractPrice: null,
            futuresQty: order.unmatchedQty
          });
          setSingleMatchModalVisible(true);
        }
      };

      // 确认批量匹配
      const handleConfirmBatchMatch = () => {
        batchMatchForm.validateFields().then(values => {
          const matchRecords = values.matchRecords || [];
          const validRecords = matchRecords.filter(r => {
            const order = displayOrders.find(o => o.id === r.futuresId);
            if (!order) return false;
            const plan = mockHedgePlans.find(hp => hp.id === r.hedgePlanId);
            if (!plan) return false;
            
            // 检查匹配规则
            if (plan.type === '单单匹配') {
              // 需要检查标签
              const spotRemark = order.spotRemarks?.[0];
              if (spotRemark && spotRemark.tag) {
                const requireContractTags = ['长单保值', '长单增量', '长单减量', '长单取消', '订单接货保值', '订单出货保值', '订单增量', '订单减量', '订单取消', '买点价', '卖点价', '调敞口', '代持'];
                if (requireContractTags.includes(spotRemark.tag)) {
                  return !!r.contractId;
                }
              }
            }
            return true;
          });
          
          if (validRecords.length === 0) {
            message.warning('没有符合匹配规则的记录');
            return;
          }
          
          setBatchMatchModalVisible(false);
          setMatchResultModalVisible(true);
          message.success(`成功匹配 ${validRecords.length} 条记录`);
        });
      };

      // 确认单条匹配
      const handleConfirmSingleMatch = () => {
        singleMatchForm.validateFields().then(values => {
          const plan = mockHedgePlans.find(hp => hp.id === values.hedgePlanId);
          if (plan?.type === '单单匹配' && !values.contractId) {
            message.error('单单匹配的保值方案必须选择合同');
            return;
          }
          message.success('匹配成功');
          setSingleMatchModalVisible(false);
          singleMatchForm.resetFields();
        });
      };

      // 刷新
      const handleRefresh = () => {
        message.success('刷新成功');
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>筛选：</label>
              <Radio.Group value={filterType} onChange={(e) => setFilterType(e.target.value)}>
                <Radio.Button value="today">当日</Radio.Button>
                <Radio.Button value="history">历史</Radio.Button>
              </Radio.Group>
            </div>
            <div className="erp-filter-item">
              <Input.Search
                placeholder="搜索短编号、合约、账户、保值方案"
                style={{ width: 300 }}
                value={searchKeyword}
                onChange={(e) => setSearchKeyword(e.target.value)}
                onSearch={(value) => setSearchKeyword(value)}
                allowClear
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('FileTextOutlined')} onClick={handleSpotRemark} disabled={selectedRowKeys.length !== 1}>期现备注</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleOrderRemark} disabled={selectedRowKeys.length !== 1}>委托备注</Button>
              <Button icon={renderIcon('ClusterOutlined')} onClick={handleBatchMatch} disabled={selectedRowKeys.length === 0}>批量匹配</Button>
              <Button icon={renderIcon('LinkOutlined')} onClick={handleSingleMatch} disabled={selectedRowKeys.length !== 1}>单条匹配</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
              <Button icon={renderIcon('SyncOutlined')} onClick={handleRefresh}>刷新</Button>
            </Space>
            <Space>
              <Button 
                icon={renderIcon('SettingOutlined')} 
                onClick={() => setSpotRemarkColumnEditorVisible(true)}
              >
                期现备注列配置
              </Button>
              <Button 
                icon={renderIcon('SettingOutlined')} 
                onClick={() => setColumnEditorVisible(true)}
              >
                自定义列
              </Button>
            </Space>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={displayOrders}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>

          {/* 期现备注模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="期现备注"
            open={spotRemarkModalVisible}
            onCancel={() => { setSpotRemarkModalVisible(false); spotRemarkForm.resetFields(); }}
            width={1000}
            onOk={handleSaveSpotRemark}
          >
            <Form form={spotRemarkForm} layout="vertical">
              <Form.List name="spotRemarks" initialValue={[]}>
                {(fields, { add, remove }) => {
                  const order = displayOrders.find(o => o.id === currentFuturesId);
                  const hedgePlanTags = order ? getHedgePlanTags(order.hedgePlanId) : [];
                  const contracts = order ? getContractsByHedgePlan(order.hedgePlanId) : [];
                  const plan = order ? mockHedgePlans.find(hp => hp.id === order.hedgePlanId) : null;
                  const canSelectContract = plan?.type === '单单匹配';

                  return (
                    <Space direction="vertical" style={{ width: '100%' }}>
                      {fields.map((field, index) => (
                        <Card key={field.key} size="small" title={`期现备注 ${index + 1}`} extra={
                          <Button type="text" danger icon={renderIcon('DeleteOutlined')} onClick={() => remove(field.name)}>删除</Button>
                        }>
                          <Space direction="vertical" style={{ width: '100%' }}>
                            <Form.Item
                              {...field}
                              name={[field.name, 'qty']}
                              fieldKey={[field.fieldKey, 'qty']}
                              label="手数"
                              rules={[{ required: true, message: '请输入手数' }, { type: 'number', min: 1, message: '手数必须大于0' }]}
                            >
                              <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入手数" />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'spotQty']}
                              fieldKey={[field.fieldKey, 'spotQty']}
                              label="现货数量"
                            >
                              <InputNumber min={0} style={{ width: '100%' }} placeholder="请输入现货数量" />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'pricingPrice']}
                              fieldKey={[field.fieldKey, 'pricingPrice']}
                              label="点价价格"
                            >
                              <InputNumber min={0} style={{ width: '100%' }} placeholder="请输入点价价格" />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'tag']}
                              fieldKey={[field.fieldKey, 'tag']}
                              label="标签"
                            >
                              <Select placeholder="请选择标签" options={hedgePlanTags.map(tag => ({ label: tag, value: tag }))} />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'remark']}
                              fieldKey={[field.fieldKey, 'remark']}
                              label="备注"
                            >
                              <Input.TextArea rows={2} placeholder="请输入备注" />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'contractId']}
                              fieldKey={[field.fieldKey, 'contractId']}
                              label="合同号"
                            >
                              <Select 
                                placeholder={canSelectContract ? "请选择合同（如果保值方案是单单才允许选取）" : "当前保值方案不支持选择合同"}
                                disabled={!canSelectContract}
                                options={contracts.map(c => ({ label: c.contractNo, value: c.id }))}
                                onChange={(value) => {
                                  // 如果已选合同，清空客商
                                  if (value) {
                                    spotRemarkForm.setFieldsValue({
                                      spotRemarks: spotRemarkForm.getFieldValue('spotRemarks').map((r, i) => 
                                        i === field.name ? { ...r, customerId: null } : r
                                      )
                                    });
                                  }
                                }}
                              />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'customerId']}
                              fieldKey={[field.fieldKey, 'customerId']}
                              label="客商"
                            >
                              <Select 
                                placeholder="请选择客商（如果已选合同则不能选）"
                                disabled={!!spotRemarkForm.getFieldValue(['spotRemarks', field.name, 'contractId'])}
                                options={mockCustomers.map(c => ({ label: c.shortName, value: c.id }))}
                              />
                            </Form.Item>
                            <Form.Item
                              {...field}
                              name={[field.name, 'isMatched']}
                              fieldKey={[field.fieldKey, 'isMatched']}
                              label="是否已匹配"
                              valuePropName="checked"
                            >
                              <Switch />
                            </Form.Item>
                          </Space>
                        </Card>
                      ))}
                      <Button
                        type="dashed"
                        onClick={() => add({ qty: null, spotQty: null, pricingPrice: null, tag: null, remark: '', customerId: null, contractId: null, isMatched: false })}
                        icon={renderIcon('PlusOutlined')}
                        block
                      >
                        新增期现备注
                      </Button>
                    </Space>
                  );
                }}
              </Form.List>
            </Form>
          </Modal>

          {/* 委托备注模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="委托备注"
            open={orderRemarkModalVisible}
            onCancel={() => { setOrderRemarkModalVisible(false); orderRemarkForm.resetFields(); }}
            width={700}
            footer={[
              <Button key="delete" danger onClick={handleDeleteOrderRemark}>删除</Button>,
              <Button key="cancel" onClick={() => { setOrderRemarkModalVisible(false); orderRemarkForm.resetFields(); }}>取消</Button>,
              <Button key="ok" type="primary" onClick={handleSaveOrderRemark}>确认</Button>
            ]}
          >
            <Form form={orderRemarkForm} layout="vertical">
              <Form.Item label="备注信息" name="orderRemark">
                <Input.TextArea rows={8} placeholder="请输入委托备注（支持富文本）" />
              </Form.Item>
              <Alert
                type="info"
                message="提示：委托备注支持富文本格式，可直接输入HTML内容"
                style={{ marginTop: 8 }}
              />
            </Form>
          </Modal>

          {/* 批量匹配模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="批量匹配"
            open={batchMatchModalVisible}
            onCancel={() => { setBatchMatchModalVisible(false); batchMatchForm.resetFields(); }}
            width={1200}
            onOk={handleConfirmBatchMatch}
          >
            <Form form={batchMatchForm} layout="vertical">
              <Form.List name="matchRecords">
                {(fields) => {
                  const matchRecords = batchMatchForm.getFieldValue('matchRecords') || [];
                  return (
                    <Table
                      dataSource={matchRecords.map((record, index) => ({ ...record, key: index }))}
                      columns={[
                        { title: '保值方案', dataIndex: 'hedgePlanId', width: 150, render: (id) => {
                          const plan = mockHedgePlans.find(hp => hp.id === id);
                          return plan?.name || '-';
                        }},
                        { title: '期货账户', dataIndex: 'futuresAccount', width: 120, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.futuresAccount || '-';
                        }},
                        { title: '日期时间', dataIndex: 'dateTime', width: 160, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.dateTime || '-';
                        }},
                        { title: '合约', dataIndex: 'contract', width: 120, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.contract || '-';
                        }},
                        { title: '方向', dataIndex: 'direction', width: 80, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order ? <Tag color={order.direction === '买入' ? 'red' : 'green'}>{order.direction}</Tag> : '-';
                        }},
                        { title: '开平', dataIndex: 'openClose', width: 80, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.openClose || '-';
                        }},
                        { title: '价格', dataIndex: 'price', width: 100, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.avgPrice || '-';
                        }},
                        { title: '手数', dataIndex: 'futuresQty', width: 100, render: (qty, record, index) => (
                          <Form.Item name={[index, 'futuresQty']} style={{ margin: 0 }}>
                            <InputNumber min={1} style={{ width: '100%' }} />
                          </Form.Item>
                        )},
                        { title: '合同号', dataIndex: 'contractId', width: 150, render: (_, record, index) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          const contracts = order ? getContractsByHedgePlan(order.hedgePlanId) : [];
                          return (
                            <Form.Item name={[index, 'contractId']} style={{ margin: 0 }}>
                              <Select placeholder="请选择合同" options={contracts.map(c => ({ label: c.contractNo, value: c.id }))} />
                            </Form.Item>
                          );
                        }},
                        { title: '合同数量', dataIndex: 'contractQty', width: 120, render: (_, record, index) => (
                          <Form.Item name={[index, 'contractQty']} style={{ margin: 0 }}>
                            <InputNumber min={0} style={{ width: '100%' }} placeholder="可选" />
                          </Form.Item>
                        )},
                        { title: '合同价格', dataIndex: 'contractPrice', width: 120, render: (_, record, index) => (
                          <Form.Item name={[index, 'contractPrice']} style={{ margin: 0 }}>
                            <InputNumber min={0} style={{ width: '100%' }} placeholder="可选" />
                          </Form.Item>
                        )}
                      ]}
                      pagination={false}
                      scroll={{ y: 400 }}
                    />
                  );
                }}
              </Form.List>
              <Alert
                type="info"
                message="匹配规则"
                description="如果保值方案是单单，且标签是特定标签（长单保值、长单增量等），必须指定合同。其他情况：绑定保值方案进行匹配。"
                style={{ marginTop: 16 }}
              />
            </Form>
          </Modal>

          {/* 单条匹配模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="单条匹配"
            open={singleMatchModalVisible}
            onCancel={() => { setSingleMatchModalVisible(false); singleMatchForm.resetFields(); }}
            width={600}
            onOk={handleConfirmSingleMatch}
          >
            <Form form={singleMatchForm} layout="vertical">
              <Form.Item label="保值方案" name="hedgePlanType">
                <Input disabled />
              </Form.Item>
              <Form.Item 
                label="合同号" 
                name="contractId"
                rules={[
                  ({ getFieldValue }) => ({
                    validator(_, value) {
                      const type = getFieldValue('hedgePlanType');
                      if (type === '单单匹配' && !value) {
                        return Promise.reject(new Error('单单匹配的保值方案必须选择合同'));
                      }
                      return Promise.resolve();
                    }
                  })
                ]}
              >
                <Select 
                  placeholder="请选择合同（如果保值方案是单单则必填）"
                  options={(() => {
                    const hedgePlanId = singleMatchForm.getFieldValue('hedgePlanId');
                    const contracts = hedgePlanId ? getContractsByHedgePlan(hedgePlanId) : [];
                    return contracts.map(c => ({ label: c.contractNo, value: c.id }));
                  })()}
                />
              </Form.Item>
              <Form.Item label="合同数量" name="contractQty">
                <InputNumber min={0} style={{ width: '100%' }} placeholder="可选，非必填" />
              </Form.Item>
              <Form.Item label="合同价格" name="contractPrice">
                <InputNumber min={0} style={{ width: '100%' }} placeholder="可选，非必填" />
              </Form.Item>
              <Form.Item label="期货数量" name="futuresQty">
                <InputNumber min={1} style={{ width: '100%' }} disabled />
              </Form.Item>
              <Alert
                type="info"
                message="匹配说明"
                description="如果保值方案是整体、客商、人员的：只需要确认即可完成匹配。如果保值方案是单单的：需要选择指定合同。匹配成功后，将自动创建期现备注并刷新委托单列表。"
                style={{ marginTop: 16 }}
              />
            </Form>
          </Modal>

          {/* 匹配结果模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="匹配结果"
            open={matchResultModalVisible}
            onCancel={() => setMatchResultModalVisible(false)}
            width={800}
            footer={[
              <Button key="ok" type="primary" onClick={() => setMatchResultModalVisible(false)}>确认</Button>
            ]}
          >
            <Alert
              type="success"
              message="匹配成功"
              description="已成功完成批量匹配操作，相关记录已更新。"
              style={{ marginBottom: 16 }}
            />
            <Table
              columns={[
                { title: '委托单', dataIndex: 'futuresId' },
                { title: '匹配状态', dataIndex: 'status', render: () => <Tag color="green">成功</Tag> }
              ]}
              dataSource={[]}
              pagination={false}
            />
          </Modal>

          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={matchVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
          {spotRemarkColumnEditorVisible && (
            <ColumnEditor
              allColumns={spotRemarkColumnDefinitions}
              visibleColumns={spotRemarkVisibleColumns}
              onSave={handleSpotRemarkColumnSave}
              onCancel={() => setSpotRemarkColumnEditorVisible(false)}
              onRestoreDefault={handleSpotRemarkColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // Web交易终端页面
    const WebTradeTerminal = () => {
      const [selectedAccount, setSelectedAccount] = useState(mockFuturesAccounts[0]?.account || '');
      const [selectedHedgePlan, setSelectedHedgePlan] = useState(null);
      const [instructionDrawerVisible, setInstructionDrawerVisible] = useState(false);
      const [orderForm] = Form.useForm();
      const [selectedContract, setSelectedContract] = useState('CU2401');
      
      // 模拟持仓数据
      const mockPositions = [
        { id: 1, direction: '买入', contract: 'CU2401', qty: 10, avgPrice: 5300, floatingPnL: 5000, hedgePlan: '整体保值方案A', insurance: '投机' },
        { id: 2, direction: '卖出', contract: 'AL2401', qty: 5, avgPrice: 5250, floatingPnL: -2000, hedgePlan: '单单保值方案B', insurance: '套保' }
      ];
      
      // 模拟委托数据
      const mockOrders = [
        { id: 1, status: '部成', orderTime: '2025-11-24 10:30:00', triggerType: '手动', relatedInstruction: '指令001', contract: 'CU2401', direction: '买入', price: 5300, qty: 10 },
        { id: 2, status: '全成', orderTime: '2025-11-24 11:00:00', triggerType: '自动', relatedInstruction: '指令002', contract: 'AL2401', direction: '卖出', price: 5250, qty: 5 }
      ];
      
      // 模拟成交数据
      const mockFills = [
        { id: 1, price: 5300, qty: 10, fee: 50, matchNo: 'M001', contract: 'CU2401', direction: '买入', time: '2025-11-24 10:30:15' },
        { id: 2, price: 5250, qty: 5, fee: 25, matchNo: 'M002', contract: 'AL2401', direction: '卖出', time: '2025-11-24 11:00:20' }
      ];
      
      // 模拟资金数据
      const mockFunds = {
        equity: 1000000,
        available: 800000,
        occupied: 200000,
        riskDegree: 0.25,
        margin: 200000
      };
      
      // 模拟行情数据
      const mockMarketData = {
        'CU2401': { latest: 5300, change: 50, changePercent: 0.95, volume: 10000, openInterest: 50000, bid: [5299, 5298, 5297, 5296, 5295], ask: [5301, 5302, 5303, 5304, 5305] },
        'AL2401': { latest: 5250, change: -30, changePercent: -0.57, volume: 8000, openInterest: 30000, bid: [5249, 5248, 5247, 5246, 5245], ask: [5251, 5252, 5253, 5254, 5255] }
      };
      
      const currentMarket = mockMarketData[selectedContract] || mockMarketData['CU2401'];
      
      // 获取当前交易员支持的保值方案
      const availableHedgePlans = useMemo(() => {
        return mockHedgePlans.filter(hp => {
          const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
          return traders?.personNames?.some(name => hp.traders?.includes(name));
        });
      }, []);
      
      // 获取指令数据（从指令工作台）
      const instructionData = useMemo(() => {
        return [
          { id: 1, type: '期货交易指令', source: '人员', contract: 'HT2025-0001', futures: 'CU2401', direction: '买入', qty: 100, execType: '人工', progress: '待执行' },
          { id: 2, type: '点价指令', source: '客商', contract: 'HT2025-0002', futures: 'AL2401', direction: '卖出', qty: 200, execType: '自动', progress: '执行中' }
        ];
      }, []);
      
      const filteredPositions = useMemo(() => {
        if (!selectedHedgePlan) return mockPositions;
        return mockPositions.filter(p => p.hedgePlan === selectedHedgePlan);
      }, [selectedHedgePlan]);
      
      const filteredOrders = useMemo(() => {
        if (!selectedHedgePlan) return mockOrders;
        return mockOrders.filter(o => {
          const pos = mockPositions.find(p => p.contract === o.contract);
          return pos?.hedgePlan === selectedHedgePlan;
        });
      }, [selectedHedgePlan]);
      
      const handleSubmitOrder = () => {
        orderForm.validateFields().then(values => {
          message.success('下单成功（模拟）');
          orderForm.resetFields();
        });
      };
      
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', background: '#f5f5f5' }}>
          {/* 顶部状态条 */}
          <div style={{ padding: '8px 16px', background: '#fff', borderBottom: '1px solid #e8e8e8', display: 'flex', alignItems: 'center', gap: 16, flexShrink: 0 }}>
            <Select value={selectedAccount} onChange={setSelectedAccount} style={{ width: 150 }}>
              {mockFuturesAccounts.map(acc => (
                <Select.Option key={acc.id} value={acc.account}>{acc.account}</Select.Option>
              ))}
            </Select>
            <Space>
              <Badge status="success" text="行情连接" />
              <Badge status="success" text="交易连接" />
            </Space>
            <div style={{ marginLeft: 'auto', display: 'flex', gap: 16, alignItems: 'center' }}>
              <span>风险度：<strong style={{ color: mockFunds.riskDegree > 0.8 ? 'red' : 'green' }}>{(mockFunds.riskDegree * 100).toFixed(1)}%</strong></span>
              <span>可用资金：<strong>{mockFunds.available.toLocaleString()}</strong></span>
              <Button type="primary" icon={renderIcon('FileTextOutlined')} onClick={() => setInstructionDrawerVisible(true)}>指令执行</Button>
            </div>
          </div>
          
          <div style={{ flex: 1, display: 'flex', minHeight: 0, overflow: 'hidden' }}>
            {/* 左侧行情区域 */}
            <div style={{ width: 300, background: '#fff', borderRight: '1px solid #e8e8e8', display: 'flex', flexDirection: 'column', flexShrink: 0 }}>
              <div style={{ padding: 12, borderBottom: '1px solid #e8e8e8' }}>
                <Space>
                  <Button size="small" icon={renderIcon('PlusOutlined')}>自选1</Button>
                  <Button size="small" icon={renderIcon('PlusOutlined')}>自选2</Button>
                  <Button size="small" icon={renderIcon('PlusOutlined')}>自选3</Button>
                </Space>
              </div>
              <div style={{ padding: 12, borderBottom: '1px solid #e8e8e8' }}>
                <Select value={selectedContract} onChange={setSelectedContract} style={{ width: '100%' }}>
                  <Select.Option value="CU2401">CU2401</Select.Option>
                  <Select.Option value="AL2401">AL2401</Select.Option>
                </Select>
              </div>
              <div style={{ padding: 12, flex: 1, overflow: 'auto' }}>
                <div style={{ marginBottom: 12 }}>
                  <div style={{ fontSize: 24, fontWeight: 'bold', color: currentMarket.change >= 0 ? 'red' : 'green' }}>
                    {currentMarket.latest}
                  </div>
                  <div style={{ fontSize: 12, color: currentMarket.change >= 0 ? 'red' : 'green' }}>
                    {currentMarket.change >= 0 ? '+' : ''}{currentMarket.change} ({currentMarket.changePercent >= 0 ? '+' : ''}{currentMarket.changePercent}%)
                  </div>
                </div>
                <Divider />
                <div style={{ marginBottom: 8 }}>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                    <span style={{ color: '#999' }}>持仓量</span>
                    <span>{currentMarket.openInterest.toLocaleString()}</span>
                  </div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                    <span style={{ color: '#999' }}>成交量</span>
                    <span>{currentMarket.volume.toLocaleString()}</span>
                  </div>
                </div>
                <Divider />
                <div>
                  <div style={{ fontSize: 12, marginBottom: 8, color: '#999' }}>五档盘口</div>
                  <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                    <div style={{ flex: 1, textAlign: 'right' }}>
                      {currentMarket.ask.slice().reverse().map((price, i) => (
                        <div key={i} style={{ color: 'red', fontSize: 12 }}>{price}</div>
                      ))}
                    </div>
                    <div style={{ flex: 1, textAlign: 'left', marginLeft: 8 }}>
                      {currentMarket.bid.map((price, i) => (
                        <div key={i} style={{ color: 'green', fontSize: 12 }}>{price}</div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* 中间下单区域 */}
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minWidth: 0 }}>
              <div style={{ padding: 16, background: '#fff', borderBottom: '1px solid #e8e8e8' }}>
                <Tabs defaultActiveKey="auto">
                  <Tabs.TabPane tab="自动开平" key="auto">
                    <Form form={orderForm} layout="inline">
                      <Form.Item label="保值方案" name="hedgePlan" style={{ width: 200 }}>
                        <Select placeholder="选择保值方案" value={selectedHedgePlan} onChange={setSelectedHedgePlan}>
                          {availableHedgePlans.map(hp => (
                            <Select.Option key={hp.id} value={hp.name}>{hp.name}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                      <Form.Item label="合约" name="contract" initialValue={selectedContract}>
                        <Input style={{ width: 120 }} />
                      </Form.Item>
                      <Space style={{ marginLeft: 16 }}>
                        <Button type="primary" danger style={{ width: 80 }}>买开</Button>
                        <Button type="default" style={{ width: 80 }}>平仓</Button>
                        <Button type="primary" style={{ width: 80 }}>卖开</Button>
                      </Space>
                      <Form.Item label="数量" name="qty" initialValue={1}>
                        <InputNumber min={1} style={{ width: 100 }} />
                      </Form.Item>
                      <Form.Item label="价格" name="price" initialValue={currentMarket.latest}>
                        <InputNumber style={{ width: 120 }} />
                      </Form.Item>
                      <Button type="primary" onClick={handleSubmitOrder}>提交</Button>
                    </Form>
                  </Tabs.TabPane>
                  <Tabs.TabPane tab="传统下单" key="traditional">
                    <Form form={orderForm} layout="vertical">
                      <Space wrap>
                        <Form.Item label="合约" name="contract" style={{ width: 150 }}>
                          <Input />
                        </Form.Item>
                        <Form.Item label="方向" name="direction" style={{ width: 100 }}>
                          <Select>
                            <Select.Option value="买入">买入</Select.Option>
                            <Select.Option value="卖出">卖出</Select.Option>
                          </Select>
                        </Form.Item>
                        <Form.Item label="价格类型" name="priceType" style={{ width: 120 }}>
                          <Select>
                            <Select.Option value="限价">限价</Select.Option>
                            <Select.Option value="对价">对价</Select.Option>
                            <Select.Option value="市价">市价</Select.Option>
                          </Select>
                        </Form.Item>
                        <Form.Item label="开平" name="openClose" style={{ width: 100 }}>
                          <Select>
                            <Select.Option value="开仓">开仓</Select.Option>
                            <Select.Option value="平仓">平仓</Select.Option>
                          </Select>
                        </Form.Item>
                        <Form.Item label="数量" name="qty" style={{ width: 100 }}>
                          <InputNumber min={1} />
                        </Form.Item>
                        <Button type="primary" onClick={handleSubmitOrder}>提交</Button>
                      </Space>
                    </Form>
                  </Tabs.TabPane>
                </Tabs>
              </div>
              
              {/* 右侧数据面板 */}
              <div style={{ flex: 1, display: 'flex', minHeight: 0 }}>
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', background: '#fff' }}>
                  <Tabs defaultActiveKey="position" style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                    <Tabs.TabPane tab="持仓" key="position">
                      <Table
                        size="small"
                        columns={[
                          { title: '方向', dataIndex: 'direction', width: 80, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
                          { title: '合约', dataIndex: 'contract', width: 100 },
                          { title: '手数', dataIndex: 'qty', width: 80, align: 'right' },
                          { title: '均价', dataIndex: 'avgPrice', width: 100, align: 'right' },
                          { title: '浮盈亏', dataIndex: 'floatingPnL', width: 100, align: 'right', render: (v) => <span style={{ color: v >= 0 ? 'red' : 'green' }}>{v >= 0 ? '+' : ''}{v}</span> },
                          { title: '保值方案', dataIndex: 'hedgePlan', width: 150 },
                          { title: '投保', dataIndex: 'insurance', width: 80 }
                        ]}
                        dataSource={filteredPositions}
                        rowKey="id"
                        pagination={false}
                        scroll={{ y: 'calc(100vh - 500px)' }}
                      />
                    </Tabs.TabPane>
                    <Tabs.TabPane tab="委托" key="order">
                      <Table
                        size="small"
                        columns={[
                          { title: '状态', dataIndex: 'status', width: 80, render: (s) => <Tag>{s}</Tag> },
                          { title: '报单时间', dataIndex: 'orderTime', width: 160 },
                          { title: '触发方式', dataIndex: 'triggerType', width: 100 },
                          { title: '关联指令', dataIndex: 'relatedInstruction', width: 120 },
                          { title: '合约', dataIndex: 'contract', width: 100 },
                          { title: '方向', dataIndex: 'direction', width: 80, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
                          { title: '价格', dataIndex: 'price', width: 100, align: 'right' },
                          { title: '数量', dataIndex: 'qty', width: 80, align: 'right' },
                          { title: '操作', key: 'action', width: 80, render: () => <Button size="small" type="link">撤单</Button> }
                        ]}
                        dataSource={filteredOrders}
                        rowKey="id"
                        pagination={false}
                        scroll={{ y: 'calc(100vh - 500px)' }}
                      />
                    </Tabs.TabPane>
                    <Tabs.TabPane tab="成交" key="fill">
                      <Table
                        size="small"
                        columns={[
                          { title: '时间', dataIndex: 'time', width: 160 },
                          { title: '合约', dataIndex: 'contract', width: 100 },
                          { title: '方向', dataIndex: 'direction', width: 80, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
                          { title: '价格', dataIndex: 'price', width: 100, align: 'right' },
                          { title: '数量', dataIndex: 'qty', width: 80, align: 'right' },
                          { title: '手续费', dataIndex: 'fee', width: 100, align: 'right' },
                          { title: '撮合编号', dataIndex: 'matchNo', width: 120 }
                        ]}
                        dataSource={mockFills}
                        rowKey="id"
                        pagination={false}
                        scroll={{ y: 'calc(100vh - 500px)' }}
                      />
                    </Tabs.TabPane>
                    <Tabs.TabPane tab="资金" key="fund">
                      <div style={{ padding: 16 }}>
                        <Space direction="vertical" style={{ width: '100%' }}>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>权益：</span>
                            <strong>{mockFunds.equity.toLocaleString()}</strong>
                          </div>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>可用：</span>
                            <strong style={{ color: 'green' }}>{mockFunds.available.toLocaleString()}</strong>
                          </div>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>占用：</span>
                            <strong>{mockFunds.occupied.toLocaleString()}</strong>
                          </div>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>风险度：</span>
                            <strong style={{ color: mockFunds.riskDegree > 0.8 ? 'red' : 'green' }}>{(mockFunds.riskDegree * 100).toFixed(2)}%</strong>
                          </div>
                          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                            <span>保证金：</span>
                            <strong>{mockFunds.margin.toLocaleString()}</strong>
                          </div>
                        </Space>
                      </div>
                    </Tabs.TabPane>
                  </Tabs>
                </div>
              </div>
            </div>
          </div>
          
          {/* 指令执行抽屉 */}
          <Drawer
            title="指令执行"
            placement="right"
            width={800}
            open={instructionDrawerVisible}
            onClose={() => setInstructionDrawerVisible(false)}
          >
            <Table
              columns={[
                { title: '指令类型', dataIndex: 'type', width: 150 },
                { title: '来源', dataIndex: 'source', width: 80 },
                { title: '合同', dataIndex: 'contract', width: 120 },
                { title: '合约', dataIndex: 'futures', width: 100 },
                { title: '方向', dataIndex: 'direction', width: 80, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
                { title: '数量', dataIndex: 'qty', width: 80, align: 'right' },
                { title: '执行方式', dataIndex: 'execType', width: 100 },
                { title: '进度', dataIndex: 'progress', width: 100, render: (p) => <Tag>{p}</Tag> },
                { title: '操作', key: 'action', width: 150, render: () => (
                  <Space>
                    <Button size="small" type="primary">接收</Button>
                    <Button size="small">拒绝</Button>
                  </Space>
                )}
              ]}
              dataSource={instructionData}
              rowKey="id"
              pagination={false}
            />
          </Drawer>
        </div>
      );
    };

    // 现货数据页面
    const SpotData = () => {
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ padding: 12, background: '#fff', borderBottom: '1px solid #e8e8e8', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
            <span style={{ fontWeight: 600 }}>现货数据</span>
            <Button icon={renderIcon('ReloadOutlined')} onClick={() => {
              const iframe = document.getElementById('spot-data-iframe');
              if (iframe) iframe.src = iframe.src;
            }}>刷新</Button>
          </div>
          <div style={{ flex: 1, minHeight: 0, position: 'relative' }}>
            <iframe
              id="spot-data-iframe"
              src="https://edb.shinnytech.com/"
              style={{ width: '100%', height: '100%', border: 'none' }}
              title="现货数据"
            />
          </div>
        </div>
      );
    };

    // 交易日历页面
    const TradeCalendar = () => {
      const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [selectedDate, setSelectedDate] = useState(null);
      const [remarkForm] = Form.useForm();
      const [remarks, setRemarks] = useState(() => {
        const saved = localStorage.getItem(`trade-calendar-remarks-${mockPersons[0]?.id || 'default'}`);
        return saved ? JSON.parse(saved) : {};
      });
      
      const currentUser = mockPersons[0];
      const userId = currentUser?.id || 'default';
      
      // 生成日历数据
      const calendarData = useMemo(() => {
        const year = selectedYear;
        const month = selectedMonth;
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();
        
        const days = [];
        // 填充空白
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push(null);
        }
        // 填充日期
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const isWeekend = date.getDay() === 0 || date.getDay() === 6;
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          
          // 模拟交易日历数据
          const isTradingDay = !isWeekend; // 简单逻辑：工作日是交易日
          const exchanges = isTradingDay ? ['上期所', '大商所', '郑商所', '中金所'] : [];
          const openTime = isTradingDay ? '09:00' : '-';
          const closeTime = isTradingDay ? '15:00' : '-';
          
          days.push({
            date: dateStr,
            day,
            isTradingDay,
            exchanges,
            openTime,
            closeTime,
            remark: remarks[dateStr] || ''
          });
        }
        return days;
      }, [selectedYear, selectedMonth, remarks]);
      
      const handleDateClick = (dateStr) => {
        setSelectedDate(dateStr);
        remarkForm.setFieldsValue({ remark: remarks[dateStr] || '' });
        setRemarkModalVisible(true);
      };
      
      const handleSaveRemark = () => {
        remarkForm.validateFields().then(values => {
          const newRemarks = { ...remarks };
          if (values.remark && values.remark.trim()) {
            newRemarks[selectedDate] = values.remark.trim();
          } else {
            delete newRemarks[selectedDate];
          }
          setRemarks(newRemarks);
          localStorage.setItem(`trade-calendar-remarks-${userId}`, JSON.stringify(newRemarks));
          message.success('备注已保存');
          setRemarkModalVisible(false);
        });
      };
      
      const yearOptions = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);
      const monthOptions = Array.from({ length: 12 }, (_, i) => i + 1);
      
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>年份：</label>
              <Select value={selectedYear} onChange={setSelectedYear} style={{ width: 120 }}>
                {yearOptions.map(year => (
                  <Select.Option key={year} value={year}>{year}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>月份：</label>
              <Select value={selectedMonth} onChange={setSelectedMonth} style={{ width: 120 }}>
                {monthOptions.map(month => (
                  <Select.Option key={month} value={month}>{month}月</Select.Option>
                ))}
              </Select>
            </div>
          </div>
          
          <div style={{ flex: 1, padding: 16, overflow: 'auto', background: '#fff' }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 8 }}>
              {['日', '一', '二', '三', '四', '五', '六'].map(day => (
                <div key={day} style={{ textAlign: 'center', fontWeight: 600, padding: 8, background: '#f5f5f5' }}>
                  {day}
                </div>
              ))}
              {calendarData.map((dayData, index) => {
                if (!dayData) {
                  return <div key={`empty-${index}`} />;
                }
                const { date, day, isTradingDay, exchanges, openTime, closeTime, remark } = dayData;
                return (
                  <Card
                    key={date}
                    size="small"
                    style={{
                      minHeight: 120,
                      cursor: 'pointer',
                      border: remark ? '2px solid #1677ff' : '1px solid #e8e8e8'
                    }}
                    onClick={() => handleDateClick(date)}
                  >
                    <div style={{ textAlign: 'center', marginBottom: 8 }}>
                      <div style={{ fontSize: 16, fontWeight: 600 }}>{day}</div>
                      <Tag color={isTradingDay ? 'green' : 'default'} style={{ marginTop: 4 }}>
                        {isTradingDay ? '交易日' : '非交易日'}
                      </Tag>
                    </div>
                    {isTradingDay && (
                      <div style={{ fontSize: 11, color: '#666' }}>
                        <div>交易所：{exchanges.join('、')}</div>
                        <div>开市：{openTime}</div>
                        <div>收市：{closeTime}</div>
                        {remark && (
                          <div style={{ marginTop: 4, color: '#1677ff', fontWeight: 600 }}>
                            备注：{remark}
                          </div>
                        )}
                      </div>
                    )}
                  </Card>
                );
              })}
            </div>
          </div>
          
          <Modal
            {...MODAL_TEXTS}
            title={`编辑备注 - ${selectedDate}`}
            open={remarkModalVisible}
            onCancel={() => setRemarkModalVisible(false)}
            onOk={handleSaveRemark}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item label="备注" name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注信息" />
              </Form.Item>
            </Form>
          </Modal>
        </div>
      );
    };

    // 跨期价差矩阵页面
    const SpreadMatrix = () => {
      const [selectedVariety, setSelectedVariety] = useState('cat-1-1'); // 默认选择铜
      const [contracts, setContracts] = useState([]);
      const [prices, setPrices] = useState({});
      const [detailModalVisible, setDetailModalVisible] = useState(false);
      const [selectedCell, setSelectedCell] = useState(null);
      
      // 生成12个月合约
      const generateContracts = (varietyCode) => {
        const year = new Date().getFullYear();
        const contracts = [];
        for (let month = 1; month <= 12; month++) {
          const monthStr = String(month).padStart(2, '0');
          const code = `${varietyCode}${year}${monthStr}`;
          contracts.push({
            code,
            name: `${varietyCode}${year}${monthStr}`,
            month
          });
        }
        return contracts;
      };
      
      // 初始化合约和价格
      useEffect(() => {
        const variety = mockSpotCategories
          .flatMap(cat => cat.children || [])
          .find(c => c.key === selectedVariety);
        if (variety) {
          const varietyCode = variety.title === '铜' ? 'CU' : variety.title === '铝' ? 'AL' : 'CU';
          const newContracts = generateContracts(varietyCode);
          setContracts(newContracts);
          
          // 初始化价格（模拟）
          const initialPrices = {};
          newContracts.forEach(contract => {
            initialPrices[contract.code] = 5000 + Math.random() * 1000;
          });
          setPrices(initialPrices);
        }
      }, [selectedVariety]);
      
      // 模拟价格刷新
      useEffect(() => {
        const interval = setInterval(() => {
          setPrices(prev => {
            const newPrices = { ...prev };
            Object.keys(newPrices).forEach(code => {
              const change = (Math.random() - 0.5) * 0.01; // ±0.5%变化
              newPrices[code] = newPrices[code] * (1 + change);
            });
            return newPrices;
          });
        }, 3000);
        return () => clearInterval(interval);
      }, []);
      
      const handleRefresh = () => {
        const variety = mockSpotCategories
          .flatMap(cat => cat.children || [])
          .find(c => c.key === selectedVariety);
        if (variety) {
          const varietyCode = variety.title === '铜' ? 'CU' : variety.title === '铝' ? 'AL' : 'CU';
          const newContracts = generateContracts(varietyCode);
          setContracts(newContracts);
          
          const newPrices = {};
          newContracts.forEach(contract => {
            newPrices[contract.code] = 5000 + Math.random() * 1000;
          });
          setPrices(newPrices);
          message.success('合约列表已刷新');
        }
      };
      
      const calculateSpread = (rowCode, colCode) => {
        if (rowCode === colCode) return null;
        const rowPrice = prices[rowCode] || 0;
        const colPrice = prices[colCode] || 0;
        return rowPrice - colPrice;
      };
      
      const handleCellClick = (rowCode, colCode) => {
        if (rowCode === colCode) return;
        setSelectedCell({ rowCode, colCode, rowPrice: prices[rowCode], colPrice: prices[colCode] });
        setDetailModalVisible(true);
      };
      
      const handleExport = () => {
        message.success('导出功能（模拟）');
      };
      
      const varietyOptions = mockSpotCategories.flatMap(cat => 
        (cat.children || []).map(child => ({
          label: `${cat.title} - ${child.title}`,
          value: child.key
        }))
      );
      
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>期货品种：</label>
              <Select value={selectedVariety} onChange={setSelectedVariety} style={{ width: 200 }}>
                {varietyOptions.map(opt => (
                  <Select.Option key={opt.value} value={opt.value}>{opt.label}</Select.Option>
                ))}
              </Select>
            </div>
            <Space style={{ marginLeft: 'auto' }}>
              <Button icon={renderIcon('ReloadOutlined')} onClick={handleRefresh}>刷新合约列表</Button>
              <Button icon={renderIcon('DownloadOutlined')} onClick={handleExport}>导出价差矩阵</Button>
            </Space>
          </div>
          
          <div style={{ flex: 1, overflow: 'auto', padding: 16, background: '#fff' }}>
            <Table
              size="small"
              columns={[
                {
                  title: '合约',
                  dataIndex: 'code',
                  key: 'code',
                  fixed: 'left',
                  width: 100,
                  render: (code) => <strong>{code}</strong>
                },
                ...contracts.map(contract => ({
                  title: contract.code,
                  key: contract.code,
                  width: 120,
                  align: 'right',
                  render: (_, record) => {
                    const spread = calculateSpread(record.code, contract.code);
                    if (spread === null) {
                      return <span style={{ color: '#999' }}>--</span>;
                    }
                    const color = spread >= 0 ? 'red' : 'green';
                    return (
                      <span
                        style={{ color, cursor: 'pointer', fontWeight: 600 }}
                        onClick={() => handleCellClick(record.code, contract.code)}
                      >
                        {spread.toFixed(2)}
                      </span>
                    );
                  }
                }))
              ]}
              dataSource={contracts.map(c => ({ code: c.code, key: c.code }))}
              pagination={false}
              scroll={{ x: 'max-content' }}
            />
          </div>
          
          <Modal
            {...MODAL_TEXTS}
            title="价差详情"
            open={detailModalVisible}
            onCancel={() => setDetailModalVisible(false)}
            footer={[
              <Button key="close" onClick={() => setDetailModalVisible(false)}>关闭</Button>
            ]}
          >
            {selectedCell && (
              <div>
                <Space direction="vertical" style={{ width: '100%' }}>
                  <div>
                    <strong>行合约：</strong>{selectedCell.rowCode} - 价格：{selectedCell.rowPrice?.toFixed(2)}
                  </div>
                  <div>
                    <strong>列合约：</strong>{selectedCell.colCode} - 价格：{selectedCell.colPrice?.toFixed(2)}
                  </div>
                  <Divider />
                  <div>
                    <strong>价差：</strong>
                    <span style={{ color: (selectedCell.rowPrice - selectedCell.colPrice) >= 0 ? 'red' : 'green', fontSize: 18, fontWeight: 600 }}>
                      {(selectedCell.rowPrice - selectedCell.colPrice).toFixed(2)}
                    </span>
                  </div>
                </Space>
              </div>
            )}
          </Modal>
        </div>
      );
    };

    const MobileWorkbench = ({ user, roles, workbenches, onEnterDesktop }) => {
      const [activeWorkbench, setActiveWorkbench] = useState(null);

      return (
        <div className="mobile-workbench">
          <Card className="user-card" title="我的工作台">
            <Space direction="vertical" style={{ width: '100%' }}>
              <Space>
                <Avatar size={48}>{user?.name?.slice(-1) || '用'}</Avatar>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 600 }}>{user?.name || '未登录用户'}</div>
                  <div style={{ color: '#8a94a6', fontSize: 13 }}>当前角色：</div>
                  <Space wrap>
                    {roles.length ? roles.map(role => (
                      <Tag color="blue" key={role}>{role}</Tag>
                    )) : <span style={{ color: '#999' }}>暂无角色</span>}
                  </Space>
                </div>
              </Space>
              <Alert
                type="info"
                showIcon
                message="移动端仅保留与你相关的工作台。复杂操作请使用桌面端。"
              />
              <Button block onClick={onEnterDesktop}>前往桌面版</Button>
            </Space>
          </Card>
          {workbenches.length ? workbenches.map(item => (
            <Card
              key={item.key}
              className="mobile-workbench-card"
              title={item.title}
              extra={<Tag color="geekblue">{item.fromRole}</Tag>}
              cover={
                <div style={{ padding: '12px 16px 0' }}>
                  <Space align="center" size={8}>
                    {renderIcon(item.icon, { style: { fontSize: 24, color: '#1677ff' } })}
                    <span style={{ color: '#8a94a6' }}>{item.description}</span>
                  </Space>
                </div>
              }
            >
              <Space direction="vertical" style={{ width: '100%' }}>
                <Button type="primary" block onClick={() => setActiveWorkbench(item)}>{item.cta}</Button>
                <Button block onClick={onEnterDesktop}>在桌面端处理</Button>
              </Space>
            </Card>
          )) : (
            <Empty description="暂无匹配的工作台，请联系管理员配置角色" />
          )}
          <Drawer
            placement="bottom"
            height={360}
            open={!!activeWorkbench}
            onClose={() => setActiveWorkbench(null)}
            title={activeWorkbench?.title}
          >
            {activeWorkbench && (
              <Space direction="vertical" style={{ width: '100%' }}>
                <Alert
                  message={`当前为 ${activeWorkbench.fromRole} 的工作台模块`}
                  description={activeWorkbench.description}
                  type="info"
                  showIcon
                />
                <Button
                  type="primary"
                  block
                  onClick={() => {
                    message.success(`已进入 ${activeWorkbench.title}`);
                    setActiveWorkbench(null);
                  }}
                >
                  我知道了
                </Button>
                <Button block onClick={onEnterDesktop}>使用桌面端获取完整体验</Button>
              </Space>
            )}
          </Drawer>
        </div>
      );
    };

    // 主应用组件
    const App = () => {
      const [topMenu, setTopMenu] = useState('contract');
      const [sideMenuKey, setSideMenuKey] = useState('');
      const [tabs, setTabs] = useState([]);
      const [activeTab, setActiveTab] = useState('');
      const [isMobile, setIsMobile] = useState(getIsMobile());
      const [sideMenuDrawerVisible, setSideMenuDrawerVisible] = useState(false);
      const [currentUser] = useState(mockPersons[0] || null);

      const currentUserRoles = useMemo(() => {
        if (!currentUser) return [];
        const roleSet = new Set();
        mockPersonRoles.forEach(pr => {
          if (pr.personNames?.includes(currentUser.name)) {
            roleSet.add(pr.roleName);
          }
        });
        return Array.from(roleSet);
      }, [currentUser]);

      const userWorkbenches = useMemo(() => {
        const map = new Map();
        currentUserRoles.forEach(role => {
          roleWorkbenches[role]?.forEach(item => {
            if (!map.has(item.key)) {
              map.set(item.key, { ...item, fromRole: role });
            }
          });
        });
        return Array.from(map.values());
      }, [currentUserRoles]);

      const topMenus = [
        { key: 'contract', label: '合同宝' },
        { key: 'instruction', label: '指令宝' },
        { key: 'match', label: '匹配宝' },
        { key: 'trade', label: '交易宝' },
        { key: 'report', label: '其他报表' },
        { key: 'settings', label: '全局设置' }
      ];

      const sideMenus = {
        contract: [
          { 
            key: 'contract-manage', 
            label: '合同管理', 
            icon: 'FileTextOutlined',
            children: [
              { key: '采购合同管理', label: '采购合同管理', icon: 'ShoppingOutlined' },
              { key: '销售合同管理', label: '销售合同管理', icon: 'ShopOutlined' }
            ]
          },
          { key: 'contract-report', label: '报表', icon: 'BarChartOutlined' }
        ],
        instruction: [
          { 
            key: 'instruction-settings', 
            label: '指令权限设置', 
            icon: 'SettingOutlined',
            children: [
              { key: 'person-instruction-permission', label: '人员指令权限设置', icon: 'UserOutlined' },
              { key: 'customer-instruction-permission', label: '客商指令权限设置', icon: 'TeamOutlined' },
              { key: 'avg-price-auto-instruction', label: '均价自动指令启停', icon: 'PoweroffOutlined' }
            ]
          },
          { key: 'instruction-workbench', label: '各岗位的指令工作台', icon: 'DesktopOutlined' },
          { key: 'instruction-report', label: '报表', icon: 'BarChartOutlined' }
        ],
        match: [
          { key: 'match-remark', label: '匹配宝与委托备注', icon: 'FileTextOutlined' }
        ],
        trade: [
          { key: 'web-trade', label: 'Web交易终端', icon: 'StockOutlined' },
          { key: 'spot-data', label: '现货数据', icon: 'DatabaseOutlined' },
          { key: 'trade-calendar', label: '交易日历', icon: 'CalendarOutlined' },
          { key: 'spread-matrix', label: '跨期价差矩阵', icon: 'TableOutlined' }
        ],
        settings: [
          { key: 'spot-brand', label: '现货品种与价格', icon: 'DatabaseOutlined' },
          { key: 'customer', label: '客商管理', icon: 'TeamOutlined' },
          { key: 'hedge-plan', label: '保值方案管理', icon: 'WalletOutlined' },
          { key: 'futures-account', label: '期货账户管理', icon: 'AccountBookOutlined' },
          { 
            key: 'person-manage', 
            label: '人员管理', 
            icon: 'UserOutlined',
            children: [
              { key: 'person', label: '人员管理', icon: 'UserOutlined' },
              { key: 'person-role', label: '人员角色管理', icon: 'TeamOutlined' }
            ]
          }
        ]
      };

      useEffect(() => {
        const handleResize = () => {
          setIsMobile(getIsMobile());
        };
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      useEffect(() => {
        if (!isMobile) {
          setSideMenuDrawerVisible(false);
        }
      }, [isMobile]);

      const menuItems = useMemo(() => {
        return sideMenus[topMenu]?.map(item => ({
          key: item.key,
          icon: renderIcon(item.icon),
          label: item.label,
          children: item.children?.map(child => ({
            key: child.key,
            icon: renderIcon(child.icon),
            label: child.label
          }))
        })) || [];
      }, [topMenu]);

      const handleDesktopHint = useCallback(() => {
        message.info('请使用桌面端访问完整功能');
      }, []);

      const handleMenuClick = (key) => {
        setSideMenuKey(key);
        if (!tabs.find(t => t.key === key)) {
          // 查找菜单项，包括子菜单
          let menuItem = sideMenus[topMenu]?.find(m => m.key === key);
          if (!menuItem) {
            // 在子菜单中查找
            const parentMenu = sideMenus[topMenu]?.find(m => m.children?.some(c => c.key === key));
            if (parentMenu) {
              menuItem = parentMenu.children.find(c => c.key === key);
            }
          }
          const newTab = { key, label: menuItem?.label || key };
          setTabs([...tabs, newTab]);
        }
        setActiveTab(key);
      };

      const handleTabEdit = (targetKey, action) => {
        if (action === 'remove') {
          const newTabs = tabs.filter(t => t.key !== targetKey);
          setTabs(newTabs);
          if (targetKey === activeTab && newTabs.length) {
            setActiveTab(newTabs[newTabs.length - 1].key);
          } else if (targetKey === activeTab) {
            setActiveTab('');
          }
        }
      };

      const renderContent = () => {
        switch (activeTab) {
          case 'spot-brand':
            return <SpotBrandManagement />;
          case 'customer':
            return <CustomerManagement />;
          case 'hedge-plan':
            return <HedgePlanManagement />;
          case 'futures-account':
            return <FuturesAccountManagement />;
          case 'person':
            return <PersonManagement />;
          case 'person-role':
            return <PersonRoleManagement />;
          case '采购合同管理':
            return <ContractManagement contractType="purchase" />;
          case '销售合同管理':
            return <ContractManagement contractType="sales" />;
          case 'contract-manage':
            return <ContractManagement contractType="purchase" />;
          case 'instruction-workbench':
            return <InstructionWorkbench />;
          case 'person-instruction-permission':
            return <PersonInstructionPermission />;
          case 'customer-instruction-permission':
            return <CustomerInstructionPermission />;
          case 'avg-price-auto-instruction':
            return <AvgPriceAutoInstruction />;
          case 'match-remark':
            return <MatchAndRemark />;
          case 'web-trade':
            return <WebTradeTerminal />;
          case 'spot-data':
            return <SpotData />;
          case 'trade-calendar':
            return <TradeCalendar />;
          case 'spread-matrix':
            return <SpreadMatrix />;
          default:
            return <div style={{ padding: 40, textAlign: 'center', color: '#8a94a6' }}>请选择菜单项</div>;
        }
      };

      if (isMobile) {
        return (
          <ConfigProvider theme={{ token: { colorPrimary: '#1677ff' } }}>
            <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
              <Header className="erp-header" style={{ width: '100%' }}>
                <div className="erp-logo" style={{ width: '100%', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <div className="erp-logo-badge">快期</div>
                    <div className="erp-title">
                      <span className="name" title="期现业务管理平台">期现业务管理平台</span>
                      <span className="desc">Mobile Workbench</span>
                    </div>
                  </div>
                  <Button type="text" onClick={handleDesktopHint}>桌面版</Button>
                </div>
              </Header>
              <Content className="erp-content" style={{ flex: 1, width: '100%' }}>
                <MobileWorkbench
                  user={currentUser}
                  roles={currentUserRoles}
                  workbenches={userWorkbenches}
                  onEnterDesktop={handleDesktopHint}
                />
              </Content>
            </div>
          </ConfigProvider>
        );
      }

      return (
        <ConfigProvider theme={{ token: { colorPrimary: '#1677ff' } }}>
          <div style={{ height: '100vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
            <Header className="erp-header">
              <div className="erp-logo">
                {isMobile && (
                  <Button
                    className="erp-mobile-menu-btn"
                    type="text"
                    icon={renderIcon('MenuOutlined')}
                    onClick={() => setSideMenuDrawerVisible(true)}
                  />
                )}
                <div className="erp-logo-badge">快期</div>
                <div className="erp-title">
                  <span className="name" title="期现业务管理平台">期现业务管理平台</span>
                  <span className="desc" title="Prototype System">Prototype</span>
                </div>
              </div>
              <div className="erp-top-menu" style={{ flex: 1, display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '4px', margin: '0 20px', overflowX: 'auto', overflowY: 'hidden' }}>
                {topMenus.map(menu => (
                  <div
                    key={menu.key}
                    className={`erp-top-menu-item ${topMenu === menu.key ? 'active' : ''}`}
                    onClick={() => setTopMenu(menu.key)}
                    style={{ flexShrink: 0 }}
                  >
                    {menu.label}
                  </div>
                ))}
              </div>
              <Space style={{ flexShrink: 0 }}>
                <Avatar>用户</Avatar>
              </Space>
            </Header>
            <div className="erp-main-layout">
              {!isMobile && (
                <Sider className="erp-sider" width={240}>
                  <Menu
                    mode="inline"
                    selectedKeys={[sideMenuKey]}
                    onClick={({ key }) => handleMenuClick(key)}
                    items={menuItems}
                  />
                </Sider>
              )}
              <div className="erp-content-area">
                <div className="erp-tabs-bar">
                  <Tabs
                    type="editable-card"
                    activeKey={activeTab}
                    onChange={setActiveTab}
                    onEdit={handleTabEdit}
                    hideAdd
                    items={tabs.map(tab => ({
                      key: tab.key,
                      label: tab.label,
                      closable: true
                    }))}
                  />
                </div>
                <Content className="erp-content">
                  {renderContent()}
                </Content>
              </div>
            </div>
            {isMobile && (
              <Drawer
                placement="left"
                width={260}
                open={sideMenuDrawerVisible}
                onClose={() => setSideMenuDrawerVisible(false)}
                bodyStyle={{ padding: 0 }}
              >
                <Menu
                  mode="inline"
                  selectedKeys={[sideMenuKey]}
                  onClick={({ key }) => {
                    handleMenuClick(key);
                    setSideMenuDrawerVisible(false);
                  }}
                  items={menuItems}
                />
              </Drawer>
            )}
          </div>
        </ConfigProvider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
