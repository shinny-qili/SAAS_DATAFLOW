<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>期现业务管理平台 - 原型系统</title>
  <!-- Ant Design CSS -->
  <link rel="stylesheet" href="https://unpkg.com/antd@5.14.2/dist/antd.min.css" 
        onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/antd@5.14.2/dist/antd.min.css';" />
  <style>
    :root {
      --primary-color: #1677ff;
      --erp-gray-100: #f7f8fa;
      --erp-gray-200: #eef0f5;
      --erp-gray-300: #d9dee8;
      --erp-gray-500: #8a94a6;
      --erp-gray-700: #4b5565;
      --erp-bg-light: #f4f6fb;
      --erp-bg-dark: #1d232f;
      --header-height: 60px;
      --top-menu-height: 48px;
      --tabs-height: 42px;
      font-feature-settings: "tnum";
    }

    html, body, #root {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--erp-bg-light);
      color: #1f2430;
      overflow: hidden;
    }

    .erp-header {
      position: relative;
      z-index: 100;
      height: var(--header-height);
      min-height: var(--header-height);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(244, 246, 251, 0.95);
      border-bottom: 1px solid rgba(140, 156, 187, 0.3);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
      overflow: visible;
    }

    .erp-header .erp-top-menu {
      height: auto;
      min-height: auto;
      background: transparent;
      border-bottom: none;
      padding: 0;
      margin: 0;
    }

    .erp-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      min-width: 0;
    }

    .erp-logo-badge {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary-color), #409eff);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 700;
      box-shadow: 0 6px 16px rgba(22, 119, 255, 0.3);
    }

    .erp-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
      justify-content: center;
      line-height: 1.5;
    }

    .erp-title .name {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
      color: #1f2430;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.5;
      max-width: 250px;
    }

    .erp-title .desc {
      font-size: 10px;
      color: #7a8499;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.4;
      max-width: 250px;
    }

    .erp-top-menu {
      height: var(--top-menu-height);
      min-height: var(--top-menu-height);
      background: rgba(255, 255, 255, 0.9);
      border-bottom: 1px solid rgba(140, 156, 187, 0.2);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
      overflow-x: auto;
    }

    .erp-top-menu-item {
      padding: 6px 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
      font-size: 13px;
      color: #4b5565;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .erp-top-menu-item:hover {
      background: rgba(22, 119, 255, 0.08);
      color: var(--primary-color);
    }

    .erp-top-menu-item.active {
      background: var(--primary-color);
      color: #fff;
    }

    .erp-main-layout {
      height: calc(100vh - var(--header-height));
      display: flex;
      overflow: hidden;
    }

    .erp-sider {
      width: 240px;
      min-width: 240px;
      background: rgba(255, 255, 255, 0.95);
      border-right: 1px solid rgba(140, 156, 187, 0.2);
      overflow-y: auto;
      overflow-x: hidden;
      flex-shrink: 0;
    }

    .erp-content-area {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .erp-tabs-bar {
      height: var(--tabs-height);
      min-height: var(--tabs-height);
      display: flex;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid rgba(140, 156, 187, 0.25);
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      flex-shrink: 0;
    }

    .erp-content {
      padding: 8px 9px 12px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.92) 0%, rgba(244, 246, 251, 0.92) 40%, rgba(244, 246, 251, 0.92) 100%);
    }

    .erp-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      width: 100%;
    }

    .erp-toolbar .actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .erp-tree-table-layout {
      display: flex;
      gap: 9px;
      align-items: stretch;
      width: 100%;
      height: 100%;
      min-height: 0;
    }

    .erp-tree-panel {
      width: 220px;
      min-width: 220px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.08);
      box-shadow: 0 12px 30px rgba(22, 119, 255, 0.05);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .erp-tree-panel .tree-content {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
    }

    .erp-tree-panel .ant-tree-node-content-wrapper {
      width: 100%;
      min-width: 0;
      overflow: hidden;
    }

    .erp-tree-panel .ant-tree-title {
      width: 100%;
      min-width: 0;
    }

    .erp-table-panel {
      flex: 1;
      min-width: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.08);
      padding: 8px;
      box-shadow: 0 12px 30px rgba(22, 119, 255, 0.05);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .erp-table-wrapper {
      flex: 1;
      min-height: 0;
      width: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .erp-fill-tabs {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    .erp-fill-tabs .ant-tabs-content-holder,
    .erp-fill-tabs .ant-tabs-content,
    .erp-fill-tabs .ant-tabs-tabpane {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .erp-fill-tabs .ant-tabs-tabpane > div {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .erp-table-wrapper .ant-table-wrapper,
    .erp-table-wrapper .ant-spin-nested-loading,
    .erp-table-wrapper .ant-spin-container,
    .erp-table-wrapper .ant-table,
    .erp-table-wrapper .ant-table-container,
    .erp-table-wrapper .ant-table-content {
      flex: 1;
      height: 100%;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* 套保未交收行标红样式 */
    .hedge-undelivered-row {
      background-color: #fff1f0 !important;
    }
    .hedge-undelivered-row:hover {
      background-color: #ffe7e5 !important;
    }

    .erp-table-wrapper .ant-table-body {
      flex: 1;
      min-height: 0;
      overflow: auto;
    }

    .erp-filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(22, 119, 255, 0.03);
      border-radius: 8px;
      flex-wrap: wrap;
      width: 100%;
    }

    .erp-filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .erp-filter-item label {
      font-size: 13px;
      color: #4b5565;
      white-space: nowrap;
    }

    .erp-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
    }

    .erp-status-badge.enabled {
      background: rgba(80, 188, 97, 0.12);
      color: #1d7b30;
    }

    .erp-status-badge.disabled {
      background: rgba(244, 67, 54, 0.12);
      color: #c62828;
    }

    .erp-column-editor-modal .ant-modal-body {
      padding: 20px;
    }

    .link-modal-container {
      width: 1200px !important;
    }

    .link-modal-container .ant-modal-content {
      height: 800px;
      display: flex;
      flex-direction: column;
    }

    .link-modal-container .ant-modal-body {
      padding: 24px 24px 0 24px !important;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .link-modal-container .ant-modal-footer {
      flex-shrink: 0;
      margin: 0;
      padding: 16px 24px;
      border-top: 1px solid #f0f0f0;
    }

    .link-modal-table-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    .link-modal-table-wrapper * {
      border-bottom: none !important;
    }

    .link-modal-table-wrapper .ant-table-container {
      border: none !important;
    }

    .link-modal-container .ant-table-wrapper {
      border: none !important;
    }

    .link-modal-container .ant-table-container {
      border: none !important;
    }

    .link-modal-container .ant-table {
      border: none !important;
    }

    .link-modal-container .ant-table-content {
      border: none !important;
    }

    .link-modal-table {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .link-modal-table .ant-spin-nested-loading {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .link-modal-table .ant-spin-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .link-modal-table .ant-table {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border: none !important;
      border-bottom: none !important;
    }

    .link-modal-table .ant-table-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border: none !important;
    }

    .link-modal-table .ant-table-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      border: none !important;
    }

    .link-modal-table .ant-table-body {
      flex: 1;
      overflow: auto !important;
      border: none !important;
    }

    .link-modal-table-wrapper .ant-table-wrapper,
    .link-modal-table-wrapper .ant-table,
    .link-modal-table-wrapper .ant-table-container,
    .link-modal-table-wrapper .ant-table-content,
    .link-modal-table-wrapper .ant-table-body {
      border: none !important;
      border-top: none !important;
      border-bottom: none !important;
      border-left: none !important;
      border-right: none !important;
    }

    .link-modal-container .ant-table-wrapper,
    .link-modal-container .ant-table,
    .link-modal-container .ant-table-container,
    .link-modal-container .ant-table-content,
    .link-modal-container .ant-table-body,
    .link-modal-container .ant-table-header,
    .link-modal-container .ant-table-header table,
    .link-modal-container .ant-table-body table {
      border: none !important;
      border-top: none !important;
      border-bottom: none !important;
      border-left: none !important;
      border-right: none !important;
    }

    .link-modal-container .ant-table-tbody > tr:last-child > td {
      border-bottom: none !important;
    }

    .link-modal-container .ant-table-thead > tr > th:first-child,
    .link-modal-container .ant-table-tbody > tr > td:first-child {
      border-left: none !important;
    }

    .link-modal-container .ant-table-thead > tr > th:last-child,
    .link-modal-container .ant-table-tbody > tr > td:last-child {
      border-right: none !important;
    }

    .link-modal-container .ant-table-wrapper {
      border: none !important;
    }

    .link-modal-container .ant-table-container {
      border: none !important;
    }

    .link-modal-container .ant-table {
      border: none !important;
    }

    .link-modal-container .ant-table-content {
      border: none !important;
    }

    .link-modal-container .ant-tabs {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .link-modal-container .ant-tabs-content-holder {
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .link-modal-container .ant-tabs-content {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .link-modal-container .ant-tabs-tabpane {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 0 !important;
    }

    .link-modal-container .ant-tabs-tabpane.ant-tabs-tabpane-hidden {
      display: none !important;
    }

    .erp-column-editor-content {
      display: flex;
      gap: 20px;
      min-height: 400px;
      max-height: 600px;
    }

    .erp-column-editor-panel {
      flex: 1;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      padding: 16px;
      overflow-y: auto;
    }

    .erp-column-editor-panel-title {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .erp-column-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .erp-column-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px;
      border-radius: 4px;
      transition: background 0.2s;
      cursor: move;
    }

    .erp-column-item:hover {
      background: #f5f5f5;
    }

    .erp-column-item.dragging {
      opacity: 0.5;
      background: #e6f7ff;
    }

    .erp-column-item.drag-over {
      border-top: 2px solid #1677ff;
      background: #f0f9ff;
    }

    .erp-column-item-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .erp-column-item-drag {
      cursor: move;
      color: #1677ff;
      font-size: 16px;
    }

    .erp-column-width-input {
      width: 80px;
    }

    .erp-kanban-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 16px;
    }

    .erp-kanban-grid .span-3 {
      grid-column: span 3;
    }

    .erp-kanban-grid .span-4 {
      grid-column: span 4;
    }

    .erp-kanban-grid .span-6 {
      grid-column: span 6;
    }

    .erp-kanban-grid .span-12 {
      grid-column: span 12;
    }

    @media (max-width: 1440px) {
      .erp-kanban-grid .span-3,
      .erp-kanban-grid .span-4 {
        grid-column: span 6;
      }
      .erp-kanban-grid .span-6 {
        grid-column: span 12;
      }
    }

    .erp-mobile-menu-btn {
      border: none;
      box-shadow: none;
      padding: 4px;
      display: none;
    }

    .mobile-workbench {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .mobile-workbench .user-card {
      border-radius: 12px;
    }

    .mobile-workbench-card {
      border-radius: 12px;
      border: 1px solid rgba(22, 119, 255, 0.12);
      box-shadow: 0 8px 20px rgba(22, 119, 255, 0.06);
    }

    .mobile-workbench-card .ant-card-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (max-width: 1024px) {
      body {
        overflow: auto;
      }

      .erp-header {
        padding: 0 12px;
      }

      .erp-mobile-menu-btn {
        display: inline-flex;
      }

      .erp-title .name {
        font-size: 14px;
        max-width: 180px;
      }

      .erp-title .desc {
        font-size: 9px;
        max-width: 180px;
      }

      .erp-main-layout {
        flex-direction: column;
        height: auto;
        min-height: calc(100vh - var(--header-height));
      }

      .erp-sider {
        display: none;
      }

      .erp-content-area {
        width: 100%;
      }

      .erp-tabs-bar {
        overflow-x: auto;
      }

      .erp-tree-table-layout {
        flex-direction: column;
        height: auto;
      }

      .erp-tree-panel,
      .erp-table-panel {
        width: 100%;
        min-width: 0;
        height: auto;
        margin-bottom: 12px;
      }

      .erp-filter-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .erp-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }

      .erp-tree-panel .tree-content {
        max-height: 220px;
        overflow-y: auto;
      }
    }

    @media (max-width: 600px) {
      .erp-header {
        flex-wrap: wrap;
        gap: 8px;
        height: auto;
      }

      .erp-top-menu {
        order: 3;
        width: 100%;
        padding: 4px 0;
      }

      .erp-logo {
        width: 100%;
        justify-content: space-between;
      }

      .erp-toolbar {
        gap: 8px;
      }

      .erp-filter-bar {
        gap: 8px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 库 - 使用多个备用CDN源以提高可用性 -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.development.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js';"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js';"></script>
  <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js';"></script>
  <script src="https://unpkg.com/dayjs@1.11.11/plugin/isSameOrBefore.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/dayjs@1.11.11/plugin/isSameOrBefore.js';"></script>
  <script src="https://unpkg.com/antd@5.14.2/dist/antd.min.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/antd@5.14.2/dist/antd.min.js';"></script>
  <script src="https://unpkg.com/@ant-design/icons@5.2.6/dist/index.umd.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@ant-design/icons@5.2.6/dist/index.umd.js';"></script>
  <script src="https://unpkg.com/echarts@5.5.0/dist/echarts.min.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js';"></script>
  <script>
    // 抑制 Babel 大文件警告（原型文件代码量大是正常的，不影响功能）
    const originalWarn = console.warn;
    const originalLog = console.log;
    
    console.warn = function(...args) {
      const message = args.join(' ');
      // 过滤掉 Babel deoptimised 警告
      if (message.includes('deoptimised') || message.includes('exceeds the max of 500KB') || message.includes('[BABEL]')) {
        return;
      }
      originalWarn.apply(console, args);
    };
    
    console.log = function(...args) {
      const message = args.join(' ');
      // 过滤掉 Babel deoptimised 警告
      if (message.includes('deoptimised') || message.includes('exceeds the max of 500KB') || message.includes('[BABEL]')) {
        return;
      }
      originalLog.apply(console, args);
    };
  </script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" 
          onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.0/babel.min.js';"></script>

  <script type="text/babel">
    if (window.dayjs && window.dayjs_plugin_isSameOrBefore) {
      dayjs.extend(dayjs_plugin_isSameOrBefore);
    }
    const { useState, useMemo, useEffect, useCallback, useRef } = React;
    const {
      Layout, Menu, Tabs, Space, Input, InputNumber, Button, Avatar, Badge, Dropdown,
      ConfigProvider, theme, Select, Tooltip, Tree, Card, Tag, Divider, Table, Form,
      Drawer, DatePicker, Modal, message, Radio, Checkbox, Switch, TreeSelect, Empty, Alert, Popover, List, Timeline, Descriptions,
      Row, Col, Collapse, Pagination, Statistic, Progress
    } = antd;
    const { Header, Sider, Content } = Layout;
    const icons = window.icons;

    const renderIcon = (name, extraProps = {}) => {
      const IconComp = icons?.[name];
      if (IconComp) {
        return <IconComp {...extraProps} />;
      }
      return <span style={{ display: 'inline-block', width: 16, height: 16 }}>●</span>;
    };

    const createPaginationConfig = (overrides = {}) => ({
      pageSize: 10,
      showSizeChanger: true,
      pageSizeOptions: ['10', '20', '50', '100'],
      showQuickJumper: {
        goButton: <Button size="small">前往</Button>
      },
      showTotal: (total, range) => `第 ${range[0]}-${range[1]} 条 / 共 ${total} 条`,
      ...overrides
    });

    const MODAL_TEXTS = {
      okText: '确认',
      cancelText: '取消'
    };

    const getIsMobile = () => {
      if (typeof window === 'undefined') return false;
      return window.innerWidth <= 1024;
    };

    // Mock数据
    const mockSpotCategories = [
      { key: 'cat-1', title: '有色金属', children: [
        { key: 'cat-1-1', title: '铜' },
        { key: 'cat-1-2', title: '铝' }
      ]},
      { key: 'cat-2', title: '黑色金属', children: [
        { key: 'cat-2-1', title: '螺纹钢' }
      ]}
    ];

    const mockSpotBrands = [
      { 
        id: 1, 
        name: '品牌A', 
        mainPortState: true, 
        platformState: null, 
        premium: 100, 
        price: 5300,
        status: 'enabled',
        remark: '',
        futures: [
          { code: 'CU2401', exposure: 0.8 },
          { code: 'CU2402', exposure: 0.2 }
        ]
      },
      { 
        id: 2, 
        name: '品牌B', 
        mainPortState: null, 
        platformState: true, 
        premium: 50, 
        price: 5250,
        status: 'enabled',
        remark: '',
        futures: [
          { code: 'CU2401', exposure: 1.0 }
        ]
      },
      { 
        id: 3, 
        name: '品牌C', 
        mainPortState: false, 
        platformState: false, 
        premium: 0, 
        price: 5200,
        status: 'disabled',
        remark: '',
        futures: []
      }
    ];

    const mockCustomers = [
      { id: 1, shortName: '供应商A', fullName: '上海XX贸易有限公司', creditRating: 'AAA', contact: '张三', phone: '13800138000', parentCompany: '', customerType: '供应商', status: 'enabled', remark: '', creator: '蒋晓晓', createTime: '2025-11-24 10:02' },
      { id: 2, shortName: '客户B', fullName: '江苏XX实业有限公司', creditRating: 'AA', contact: '李四', phone: '13900139000', parentCompany: '', customerType: '客户', status: 'enabled', remark: '', creator: '籍孟晓', createTime: '2025-11-23 15:30' },
      { id: 3, shortName: '仓库C', fullName: '上海XX仓储物流有限公司', creditRating: 'A', contact: '王五', phone: '13700137000', parentCompany: '', customerType: '仓库', status: 'enabled', remark: '', creator: '李辉', createTime: '2025-11-22 09:15' },
      { id: 4, shortName: '物流D', fullName: '深圳XX物流有限公司', creditRating: 'BBB', contact: '赵六', phone: '13600136000', parentCompany: '', customerType: '物流', status: 'enabled', remark: '', creator: '贺晓兰', createTime: '2025-11-21 14:20' },
      { id: 5, shortName: '撮合商E', fullName: '北京XX撮合服务有限公司', creditRating: 'AA', contact: '钱七', phone: '13500135000', parentCompany: '', customerType: '撮合商', status: 'enabled', remark: '', creator: '朱利军', createTime: '2025-11-20 11:45' },
      { id: 6, shortName: '客商F', fullName: '广州XX商贸有限公司', creditRating: 'A', contact: '孙八', phone: '13400134000', parentCompany: '', customerType: '客商', status: 'disabled', remark: '', creator: '李文昊', createTime: '2025-11-19 16:10' },
      { id: 7, shortName: '供应商G', fullName: '杭州XX贸易有限公司', creditRating: 'AAA', contact: '周九', phone: '13300133000', parentCompany: '', customerType: '供应商', status: 'enabled', remark: '', creator: '魏光婷', createTime: '2025-11-18 10:30' },
      { id: 8, shortName: '客户H', fullName: '成都XX实业有限公司', creditRating: 'AA', contact: '吴十', phone: '13200132000', parentCompany: '', customerType: '客户', status: 'enabled', remark: '', creator: '孙倩', createTime: '2025-11-17 13:25' },
      { id: 9, shortName: '仓库I', fullName: '武汉XX仓储有限公司', creditRating: 'A', contact: '郑一', phone: '13100131000', parentCompany: '', customerType: '仓库', status: 'enabled', remark: '', creator: '蒋晓晓', createTime: '2025-11-16 08:50' },
      { id: 10, shortName: '物流J', fullName: '西安XX物流有限公司', creditRating: 'BBB', contact: '王二', phone: '13000130000', parentCompany: '', customerType: '物流', status: 'enabled', remark: '', creator: '籍孟晓', createTime: '2025-11-15 15:40' },
      { id: 11, shortName: 'STAR PLASTICS LIMI', fullName: 'STAR PLASTICS LIMITED', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '客户', status: 'enabled', remark: '', creator: '李辉', createTime: '2025-11-14 12:15' },
      { id: 12, shortName: 'DONGMYONG KIM', fullName: 'DONGMYONG KIM COMPANY', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '撮合商', status: 'enabled', remark: '', creator: '贺晓兰', createTime: '2025-11-13 11:11' },
      { id: 13, shortName: 'THAI POLYESTER CO', fullName: 'THAI POLYESTER COMPANY', creditRating: '', contact: '', phone: '', parentCompany: '', customerType: '供应商', status: 'enabled', remark: '', creator: '朱利军', createTime: '2025-11-12 09:20' }
    ];

    // 缺省标签（系统预设，可编辑）
    const defaultTags = [
      '长单保值',
      '长单增量',
      '长单减量',
      '长单取消',
      '订单接货保值',
      '订单出货保值',
      '订单增量',
      '订单减量',
      '移仓换月',
      '订单取消',
      '买点价',
      '卖点价',
      '投机',
      '调敞口',
      '代持'
    ];

    // 标签管理（存储在localStorage中，可编辑）
    const getTags = () => {
      const saved = localStorage.getItem('hedge-plan-tags');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return [...defaultTags];
        }
      }
      return [...defaultTags];
    };

    const saveTags = (tags) => {
      localStorage.setItem('hedge-plan-tags', JSON.stringify(tags));
    };

    const mockHedgePlans = [
      { id: 1, name: '整体保值方案A', type: '整体匹配', instructionTypes: ['期货交易指令', '合同创建指令'], traders: ['交易员A', '交易员B'], makers: ['制单员A'], tags: ['长单保值', '订单接货保值'], remark: '', status: 'enabled' },
      { id: 2, name: '单单保值方案B', type: '单单匹配', instructionTypes: ['点价指令', '均价合同套保指令'], traders: ['交易员C'], makers: ['制单员B'], tags: ['买点价', '卖点价'], remark: '', status: 'enabled' },
      { id: 3, name: '无合同（人员）方案', type: '无合同（人员）', instructionTypes: ['期货交易指令'], traders: ['交易员A'], makers: [], tags: ['投机'], remark: '', status: 'enabled' },
      { id: 4, name: '无合同（客商）方案', type: '无合同（客商）', instructionTypes: ['期货交易指令'], traders: ['交易员B'], makers: [], tags: ['代持'], remark: '', status: 'enabled' }
    ];

    // 全局mock数据
    const mockSpecies = ['铜', '铝', '锌', '铅'];
    const mockBrands = ['A级铜', 'B级铜', 'A级铝', 'B级铝', '品牌A', '品牌B', '品牌C'];

    // 指令类型数据
    const mockInstructionTypes = [
      { id: 1, name: '期货交易指令' },
      { id: 2, name: '合同创建指令' },
      { id: 3, name: '点价指令' },
      { id: 4, name: '均价合同套保指令' },
      { id: 5, name: '保值方案均价净值套保指令' },
      { id: 6, name: '保值方案移仓换月指令' },
      { id: 7, name: '保值方案净值套保指令' },
      { id: 8, name: '一口价创建套保指令' },
      { id: 9, name: '非均价合同套保指令' },
      { id: 10, name: '非均价合同变更指令' },
      { id: 11, name: '均价合同变更指令' },
      { id: 12, name: '单单移仓换月' }
    ];

    // 人员指令权限数据
    const mockPersonInstructionPermissions = [
      { id: 1, hedgePlan: '整体保值方案A', instructionType: '期货交易指令', creators: ['张三', '李四'], makers: ['制单员A'], traders: ['交易员A'], status: 'enabled' },
      { id: 2, hedgePlan: '单单保值方案B', instructionType: '点价指令', creators: ['王五'], makers: ['制单员B'], traders: ['交易员C'], status: 'enabled' },
      { id: 3, hedgePlan: '无合同（人员）方案', instructionType: '期货交易指令', creators: ['张三'], makers: [], traders: ['交易员A'], status: 'enabled' }
    ];

    // 客商指令权限数据
    const mockCustomerInstructionPermissions = [
      { id: 1, hedgePlan: '无合同（客商）方案', instructionType: '期货交易指令', creators: ['供应商A', '客户B'], traders: ['交易员B'], validUntil: '2025-12-31', status: 'enabled' },
      { id: 2, hedgePlan: '无合同（客商）方案', instructionType: '期货交易指令', creators: ['客户B'], traders: ['交易员A'], validUntil: '2025-11-30', status: 'enabled' }
    ];

    // 均价自动指令启停数据
    const mockAvgPriceAutoInstructions = [
      { id: 1, hedgePlan: '整体保值方案A', creator: '系统管理员', instructionType: '保值方案均价净值套保指令', status: 'disabled' },
      { id: 2, hedgePlan: '单单保值方案B', creator: '系统管理员', instructionType: '均价合同套保指令', status: 'enabled' }
    ];

    // 指令数据（完整的mock数据）
    // 其中包含一个示例父指令（含子指令）和一个示例子指令，用于演示父子指令关系
    const mockInstructions = [
      {
        id: 1,
        instructionNo: 'INS-2025-0001',
        instructionType: '保值方案均价净值套保指令', // 示例父指令（整体类型）
        hedgePlan: '整体保值方案A',
        creator: '系统自动',
        createTime: '2025-11-10 09:00:00',
        updateTime: '2025-11-10 14:30:00',
        contractNo: null,
        customerShortName: null,
        contractInfo: null,
        futuresRequirement: { contract: 'CU2401', direction: '买入', price: 5300, qty: 200 }, // 父指令按保值方案计算出的期货需求
        futuresMatched: [{ entrustNo: 'ENT-001', contract: 'CU2401', direction: '买入', qty: 120, price: 5300 }],
        futuresTrader: '交易员A',
        futuresStatus: '待完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: [],
        contractStatus: null,
        instructionStatus: '待完成',
        withdrawStatus: null,
        // 示例：父指令下挂有两个子指令，用于展示"子指令列表"视图（仅在交易员等角色详情中查看）
        childInstructions: [
          { 
            id: 'INS-2025-0001-1', 
            type: '均价合同变更指令', 
            status: '待完成', 
            operator: '王五', 
            direction: '买入', 
            qty: 80,
            contractNo: 'HT2025-0010',
            quantityImpact: 100, // 吨
            beforeSpotExposure: 500, // 吨
            afterSpotExposure: 600, // 吨
            beforeFuturesQty: 500, // 手
            afterFuturesQty: 600, // 手
            createTime: '2025-11-10 10:30:00'
          },
          { 
            id: 'INS-2025-0001-2', 
            type: '均价合同变更指令', 
            status: '已完成', 
            operator: '李四', 
            direction: '买入', 
            qty: 120,
            contractNo: 'HT2025-0011',
            quantityImpact: 150, // 吨
            beforeSpotExposure: 300, // 吨
            afterSpotExposure: 450, // 吨
            beforeFuturesQty: 300, // 手
            afterFuturesQty: 450, // 手
            createTime: '2025-11-10 09:15:00'
          }
        ],
        remarks: [
          { person: '系统自动', content: '根据当日均价日历自动生成父指令，需买入200手', time: '2025-11-10 09:00:00' },
          { person: '交易员A', content: '上午已完成120手，剩余80手待完成', time: '2025-11-10 11:00:00' }
        ],
        operationLogs: [
          { time: '2025-11-10 09:00:00', content: '系统自动生成父指令，初始期货需求200手' },
          { time: '2025-11-10 10:30:00', content: '子指令 INS-2025-0001-1 创建（合同HT2025-0010数量变更+100吨）' },
          { time: '2025-11-10 09:15:00', content: '子指令 INS-2025-0001-2 创建（合同HT2025-0011数量变更+150吨）' },
          { time: '2025-11-10 11:00:00', content: '交易员A认领父指令' },
          { time: '2025-11-10 14:30:00', content: '重新计算父指令所需数量：200手' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员A',
        isPinned: true,
        isParent: true
      },
      {
        id: 2,
        instructionNo: 'INS-2025-0002',
        instructionType: '点价指令',
        hedgePlan: '单单保值方案B',
        creator: '王五',
        createTime: '2025-11-11 14:30:00',
        updateTime: '2025-11-11 15:45:00',
        contractNo: 'HT2025-0002',
        customerShortName: '客户B',
        contractInfo: { qty: 200, price: null, deliveryDate: '2025-12-15' },
        futuresRequirement: { contract: 'AL2401', direction: '买入', price: null, qty: 200 },
        futuresMatched: [],
        futuresTrader: '交易员B',
        futuresStatus: '待完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: [],
        contractStatus: null,
        instructionStatus: '待完成',
        withdrawStatus: null,
        remarks: [
          { person: '王五', content: '客户要求点价，等待合适时机', time: '2025-11-11 14:30:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员B',
        isPinned: false
      },
      {
        id: 3,
        instructionNo: 'INS-2025-0003',
        instructionType: '合同创建指令',
        hedgePlan: '整体保值方案A',
        creator: '李四',
        createTime: '2025-11-12 09:00:00',
        updateTime: '2025-11-12 16:00:00',
        contractNo: 'HT2025-0003',
        customerShortName: '供应商A',
        contractInfo: { qty: 150, price: 5200, deliveryDate: '2025-12-20' },
        futuresRequirement: null,
        futuresMatched: null,
        futuresTrader: null,
        futuresStatus: null,
        contractMaker: '制单员B',
        contractRequirement: { qty: 150, price: 5200 },
        contractMatched: [{ contractNo: 'HT2025-0003', qty: 150 }],
        contractStatus: '完成',
        instructionStatus: '完成',
        withdrawStatus: null,
        remarks: [
          { person: '制单员B', content: '合同已创建完成', time: '2025-11-12 16:00:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '制单员B',
        isPinned: false
      },
      {
        id: 4,
        instructionNo: 'INS-2025-0004',
        instructionType: '期货交易指令',
        hedgePlan: '无合同（人员）方案',
        creator: '张三',
        createTime: '2025-11-13 10:00:00',
        updateTime: '2025-11-13 10:00:00',
        contractNo: null,
        customerShortName: null,
        contractInfo: null,
        futuresRequirement: { contract: 'CU2402', direction: '卖出', price: 5400, qty: 50 },
        futuresMatched: [{ entrustNo: 'ENT-002', contract: 'CU2402', direction: '卖出', qty: 30, price: 5400 }],
        futuresTrader: '交易员A',
        futuresStatus: '待完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: null,
        contractStatus: null,
        instructionStatus: '撤销待处理',
        withdrawStatus: '待处理',
        remarks: [
          { person: '张三', content: '申请撤销该指令', time: '2025-11-13 11:00:00' },
          { person: '交易员A', content: '已收到撤销申请，等待审批', time: '2025-11-13 11:15:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员A',
        isPinned: true
      },
      {
        id: 5,
        instructionNo: 'INS-2025-0005',
        instructionType: '期货交易指令',
        hedgePlan: '整体保值方案A',
        creator: '供应商A',
        createTime: '2025-11-14 09:15:00',
        updateTime: '2025-11-14 09:15:00',
        contractNo: null,
        customerShortName: null,
        contractInfo: null,
        futuresRequirement: { contract: 'CU2403', direction: '买入', price: 5250, qty: 80 },
        futuresMatched: [{ entrustNo: 'ENT-003', contract: 'CU2403', direction: '买入', qty: 80, price: 5250 }],
        futuresTrader: '交易员B',
        futuresStatus: '完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: null,
        contractStatus: null,
        instructionStatus: '完成',
        withdrawStatus: null,
        remarks: [
          { person: '供应商A', content: '完成期货交易', time: '2025-11-14 10:30:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员B',
        isPinned: false
      },
      {
        id: 6,
        instructionNo: 'INS-2025-0006',
        instructionType: '合同创建指令',
        hedgePlan: '单单保值方案B',
        creator: '李四',
        createTime: '2025-11-14 11:00:00',
        updateTime: '2025-11-14 15:20:00',
        contractNo: 'HT2025-0004',
        customerShortName: '客户C',
        contractInfo: { qty: 300, price: 5100, deliveryDate: '2025-12-30' },
        futuresRequirement: null,
        futuresMatched: null,
        futuresTrader: null,
        futuresStatus: null,
        contractMaker: '制单员A',
        contractRequirement: { qty: 300, price: 5100 },
        contractMatched: [{ contractNo: 'HT2025-0004', qty: 300 }],
        contractStatus: '完成',
        instructionStatus: '完成',
        withdrawStatus: null,
        remarks: [
          { person: '制单员A', content: '合同创建完成，已发送给客户确认', time: '2025-11-14 15:20:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '制单员A',
        isPinned: false
      },
      {
        id: 7,
        instructionNo: 'INS-2025-0007',
        instructionType: '点价指令',
        hedgePlan: '整体保值方案A',
        creator: '供应商A',
        createTime: '2025-11-15 08:30:00',
        updateTime: '2025-11-15 14:00:00',
        contractNo: 'HT2025-0005',
        customerShortName: null,
        contractInfo: { qty: 120, price: null, deliveryDate: '2026-01-15' },
        futuresRequirement: { contract: 'AL2402', direction: '买入', price: null, qty: 120 },
        futuresMatched: [],
        futuresTrader: '交易员A',
        futuresStatus: '待完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: [],
        contractStatus: null,
        instructionStatus: '待完成',
        withdrawStatus: null,
        remarks: [
          { person: '供应商A', content: '等待价格合适时点价', time: '2025-11-15 08:30:00' },
          { person: '交易员A', content: '已认领，正在监控价格', time: '2025-11-15 14:00:00' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员A',
        isPinned: false
      },
      {
        id: 8,
        instructionNo: 'INS-2025-0008',
        instructionType: '均价合同变更指令', // 示例子指令（单笔合同变更）
        hedgePlan: '整体保值方案A',
        creator: '王五', // 业务经理发起
        createTime: '2025-11-15 09:30:00',
        updateTime: '2025-11-15 09:30:00',
        contractNo: 'HT2025-0006',
        customerShortName: '客户D',
        contractInfo: { qty: 50, price: 5280, deliveryDate: '2025-12-31' },
        futuresRequirement: { contract: 'CU2401', direction: '买入', price: null, qty: 50 },
        futuresMatched: [],
        futuresTrader: '交易员A',
        futuresStatus: '待完成',
        contractMaker: null,
        contractRequirement: null,
        contractMatched: [],
        contractStatus: null,
        instructionStatus: '待完成',
        withdrawStatus: null,
        // 业务经理只关心自己发起的子指令完成状态，通过 parentInstructionNo 关联到父指令
        parentInstructionNo: 'INS-2025-0001',
        remarks: [
          { person: '王五', content: '均价合同数量+50吨，对应需补开50手期货', time: '2025-11-15 09:30:00' }
        ],
        operationLogs: [
          { time: '2025-11-15 09:30:00', content: '业务经理王五发起合同数量变更（+50吨）' },
          { time: '2025-11-15 09:30:00', content: '系统自动创建子指令，关联到父指令 INS-2025-0001' },
          { time: '2025-11-15 09:30:00', content: '变更所需期货：50手（数量影响50吨 × 敞口系数1.0）' },
          { time: '2025-11-15 09:30:00', content: '父指令所需数量重新计算：250手（原200手 + 新增50手）' }
        ],
        claimStatus: '已认领',
        claimPerson: '交易员A',
        isPinned: false,
        isChild: true
      }
    ];

    const mockFuturesAccounts = [
      { id: 1, account: 'ACC001', alias: '主账户', status: 'enabled', traders: ['交易员A', '交易员B'], password: '', company: '', frontend: '', remark: '' },
      { id: 2, account: 'ACC002', alias: '', status: 'enabled', traders: ['交易员C'], password: '', company: '', frontend: '', remark: '' }
    ];

    // 角色数据
    const mockRoles = [
      { id: 1, name: '交易员', description: '负责期货交易操作' },
      { id: 2, name: '制单员', description: '负责合同制单' },
      { id: 3, name: '业务经理', description: '负责业务管理' },
      { id: 4, name: '风控员', description: '负责风险控制' }
    ];

    // 人员数据
    const mockPersons = [
      { id: 1, name: '张三', phone: '13800138000', role: '交易员', status: 'enabled', remark: '' },
      { id: 2, name: '李四', phone: '13900139000', role: '制单员', status: 'enabled', remark: '' },
      { id: 3, name: '王五', phone: '13700137000', role: '业务经理', status: 'enabled', remark: '' },
      { id: 4, name: '赵六', phone: '13600136000', role: '交易员', status: 'enabled', remark: '' },
      { id: 5, name: '钱七', phone: '13500135000', role: '制单员', status: 'enabled', remark: '' },
      { id: 6, name: '孙八', phone: '13400134000', role: '风控员', status: 'disabled', remark: '' }
    ];

    // 人员角色关系数据（每个角色一行，每个角色包含多个人员）
    const mockPersonRoles = [
      { id: 1, roleId: 1, roleName: '交易员', personIds: [1, 4], personNames: ['张三', '赵六'], description: '负责期货交易操作', status: 'enabled', remark: '', instructionTypeIds: [1, 6, 7] },
      { id: 2, roleId: 2, roleName: '制单员', personIds: [2, 5], personNames: ['李四', '钱七'], description: '负责合同制单', status: 'enabled', remark: '', instructionTypeIds: [2] },
      { id: 3, roleId: 3, roleName: '业务经理', personIds: [3], personNames: ['王五'], description: '负责业务管理', status: 'enabled', remark: '', instructionTypeIds: [1, 2, 3, 8, 9, 10, 11] },
      { id: 4, roleId: 4, roleName: '风控员', personIds: [6], personNames: ['孙八'], description: '负责风险控制', status: 'disabled', remark: '', instructionTypeIds: [] }
    ];

    const instructionWorkbenchOptions = [
      { role: '业务经理', key: 'instruction-workbench-manager', label: '业务经理工作台', icon: 'UserOutlined', initialRole: 'manager' },
      { role: '交易员', key: 'instruction-workbench-trader', label: '交易员工作台', icon: 'TrademarkOutlined', initialRole: 'trader' },
      { role: '指令员', key: 'instruction-workbench-maker', label: '指令员工作台', icon: 'SettingOutlined', initialRole: 'maker' },
      { role: '制单员', key: 'instruction-workbench-clerk', label: '制单员工作台', icon: 'FileTextOutlined', initialRole: 'clerk' },
      { role: '客商', key: 'instruction-workbench-customer', label: '客商工作台', icon: 'TeamOutlined', initialRole: 'customer' }
    ];

    const enrichContractRecord = (contract) => {
      const qty = Number(contract.qty) || 0;
      const pricedQty = Number(contract.pricedQty) || 0;
      const price = contract.price === null || contract.price === undefined ? null : Number(contract.price);
      const settlementPrice = contract.settlementPrice === null || contract.settlementPrice === undefined ? null : Number(contract.settlementPrice);
      const amount = contract.amount ?? (price !== null ? Number((qty * price).toFixed(2)) : null);
      const settlementAmount = contract.settlementAmount ?? (settlementPrice !== null ? Number((qty * settlementPrice).toFixed(2)) : null);
      const unpricedQty = contract.unpricedQty ?? Math.max(qty - pricedQty, 0);
      return {
        ...contract,
        amount,
        settlementAmount,
        unpricedQty
      };
    };

    const rawContracts = [
      { 
        id: 1,
        contractDirection: 'purchase',
        hedgePlanId: 1,
        hedgePlan: '整体保值方案A',
        manager: '业务经理A',
        contractNo: 'HT2025-0001',
        customerId: 1,
        customer: '供应商A',
        customerFullName: '上海XX贸易有限公司',
        customerType: '供应商',
        customerContact: '张三',
        customerPhone: '13800138000',
        spotType: '铜',
        brandId: 1,
        brand: '品牌A',
        pricing: '一口价',
        qty: 100,
        price: 5300,
        settlementPrice: 5285,
        transport: '自提',
        pricedQty: 80,
        priceDeadline: '2025-12-05',
        deliveryDate: '2025-12-31',
        avgStartDate: '2025-10-01',
        avgEndDate: '2025-10-15',
        occurTime: '2025-11-10 10:00',
        createTime: '2025-11-09 09:30',
        creator: '张三',
        status: 'enable',
        remark: '首批采购合同',
        customFields: {
          仓库: '仓库A',
          付款条款: '30天'
        }
      },
      { 
        id: 2,
        contractDirection: 'sales',
        hedgePlanId: 2,
        hedgePlan: '单单保值方案B',
        manager: '业务经理B',
        contractNo: 'XS2025-0305',
        customerId: 2,
        customer: '客户B',
        customerFullName: '江苏XX实业有限公司',
        customerType: '客户',
        customerContact: '李四',
        customerPhone: '13900139000',
        spotType: '铝',
        brandId: 2,
        brand: '品牌B',
        pricing: '均价',
        qty: 200,
        price: null,
        settlementPrice: 5280,
        transport: '送到',
        pricedQty: 0,
        priceDeadline: '2025-11-25',
        deliveryDate: '2025-12-15',
        avgStartDate: '2025-11-01',
        avgEndDate: '2025-11-30',
        occurTime: '2025-11-11 14:30',
        createTime: '2025-11-11 14:30',
        creator: '李四',
        status: 'enable',
        remark: '销售合同（均价）',
        customFields: {
          交割仓库: '仓库C',
          结算方式: '现汇'
        }
      },
      { 
        id: 3,
        contractDirection: 'purchase',
        hedgePlanId: 1,
        hedgePlan: '整体保值方案A',
        manager: '业务经理C',
        contractNo: 'HT2025-0003',
        customerId: 7,
        customer: '供应商G',
        customerFullName: '杭州XX贸易有限公司',
        customerType: '供应商',
        customerContact: '周九',
        customerPhone: '13300133000',
        spotType: '铜',
        brandId: 3,
        brand: '品牌C',
        pricing: '暂定价',
        qty: 150,
        price: null,
        settlementPrice: null,
        transport: '自提',
        pricedQty: 0,
        priceDeadline: '2025-12-20',
        deliveryDate: '2026-01-10',
        avgStartDate: null,
        avgEndDate: null,
        occurTime: '2025-11-15 09:00',
        createTime: '2025-11-15 09:00',
        creator: '王五',
        status: 'disable',
        remark: '客户资质待复核',
        customFields: {
          付款条款: '45天'
        }
      },
      { 
        id: 4,
        contractDirection: 'sales',
        hedgePlanId: 2,
        hedgePlan: '单单保值方案B',
        manager: '业务经理D',
        contractNo: 'XS2025-0310',
        customerId: 8,
        customer: '客户H',
        customerFullName: '成都XX实业有限公司',
        customerType: '客户',
        customerContact: '吴十',
        customerPhone: '13200132000',
        spotType: '铝',
        brandId: 2,
        brand: '品牌B',
        pricing: '一口价',
        qty: 80,
        price: 5400,
        settlementPrice: 5400,
        transport: '送到',
        pricedQty: 80,
        priceDeadline: '2025-11-05',
        deliveryDate: '2025-11-20',
        avgStartDate: null,
        avgEndDate: null,
        occurTime: '2025-10-28 16:40',
        createTime: '2025-10-28 16:40',
        creator: '赵六',
        status: 'delete',
        remark: '客户取消，记录保留',
        customFields: {}
      }
    ];

    const baseContracts = rawContracts.map(enrichContractRecord);
    const contractMapById = new Map(baseContracts.map(contract => [contract.id, contract]));

    const rawSalesRelations = [
      {
        id: 'SR-20251118001',
        purchaseContractId: 1,
        salesContractId: 2,
        qty: 60,
        relatedDate: '2025-11-18',
        occurTime: '2025-11-18 09:30:00',
        creator: '制单员A',
        remark: '首批采购合同释放的销量'
      },
      {
        id: 'SR-20251120002',
        purchaseContractId: 1,
        salesContractId: 4,
        qty: 40,
        relatedDate: '2025-11-20',
        occurTime: '2025-11-20 15:10:00',
        creator: '制单员B',
        remark: '部分库存转给销售XS2025-0310'
      },
      {
        id: 'SR-20251121001',
        purchaseContractId: 3,
        salesContractId: 2,
        qty: 50,
        relatedDate: '2025-11-21',
        occurTime: '2025-11-21 11:05:00',
        creator: '制单员A',
        remark: '暂定价合同转化为销售XS2025-0305'
      }
    ];

    const mockSalesRelations = rawSalesRelations.map(rel => {
      const purchaseContract = contractMapById.get(rel.purchaseContractId);
      const salesContract = contractMapById.get(rel.salesContractId);
      return {
        ...rel,
        purchaseContractNo: purchaseContract?.contractNo || '-',
        purchaseCustomer: purchaseContract?.customer || '-',
        purchaseManager: purchaseContract?.manager || '-',
        purchaseQty: purchaseContract?.qty || 0,
        salesContractNo: salesContract?.contractNo || '-',
        salesCustomer: salesContract?.customer || '-',
        salesManager: salesContract?.manager || '-',
        salesQty: salesContract?.qty || 0,
        hedgePlan: purchaseContract?.hedgePlan || salesContract?.hedgePlan || '-'
      };
    });

    // 期现关联记录mock数据
    const mockFuturesSpotRelations = [
      {
        id: 1,
        relatedDate: '2025-11-18',
        occurTime: '2025-11-18 09:30:00',
        hedgePlan: '整体保值方案A',
        futuresAccount: 'ACC001',
        contract: 'CU2401',
        direction: '买入',
        openClose: '开仓',
        tradeDate: '2025-11-18',
        tradePrice: 5300,
        futuresQty: 50,
        contractNo: 'HT2025-0001',
        contractQty: 250,
        pricingPrice: 5300,
        tag: '套保',
        isMatched: true
      },
      {
        id: 2,
        relatedDate: '2025-11-20',
        occurTime: '2025-11-20 14:20:00',
        hedgePlan: '单单保值方案B',
        futuresAccount: 'ACC001',
        contract: 'AL2401',
        direction: '卖出',
        openClose: '平仓',
        tradeDate: '2025-11-20',
        tradePrice: 18500,
        futuresQty: 100,
        contractNo: 'XS2025-0305',
        contractQty: 500,
        pricingPrice: null,
        tag: '点价',
        isMatched: true
      }
    ];

    const contractSalesRelationMap = {};

    const ensureRelationBucket = (contractId) => {
      if (!contractSalesRelationMap[contractId]) {
        contractSalesRelationMap[contractId] = [];
      }
      return contractSalesRelationMap[contractId];
    };

    mockSalesRelations.forEach(rel => {
      ensureRelationBucket(rel.purchaseContractId).push({
        ...rel,
        relationRole: 'purchase',
        counterpartContractId: rel.salesContractId,
        counterpartContractNo: rel.salesContractNo,
        counterpartCustomer: rel.salesCustomer,
        counterpartManager: rel.salesManager
      });

      ensureRelationBucket(rel.salesContractId).push({
        ...rel,
        relationRole: 'sales',
        counterpartContractId: rel.purchaseContractId,
        counterpartContractNo: rel.purchaseContractNo,
        counterpartCustomer: rel.purchaseCustomer,
        counterpartManager: rel.purchaseManager
      });
    });

    const mockContracts = baseContracts.map(contract => {
      const relations = contractSalesRelationMap[contract.id] || [];
      const soldTotal = relations
        .filter(rel => rel.relationRole === 'purchase')
        .reduce((sum, rel) => sum + (Number(rel.qty) || 0), 0);
      const purchasedTotal = relations
        .filter(rel => rel.relationRole === 'sales')
        .reduce((sum, rel) => sum + (Number(rel.qty) || 0), 0);
      return {
        ...contract,
        soldQty: contract.contractDirection === 'purchase' ? soldTotal : (contract.soldQty || 0),
        purchasedQty: contract.contractDirection === 'sales' ? purchasedTotal : (contract.purchasedQty || 0)
      };
    });

    // 合约乘数映射（从快期合约服务获取，手数 × 乘数 = 吨数）
    const getContractMultiplier = (contractCode) => {
      if (!contractCode) return 1;
      // 从合约代码中提取品种代码（如 CU2401 -> CU）
      const varietyCode = contractCode.match(/^([A-Z]+)/)?.[1]?.toUpperCase() || '';
      const multiplierMap = {
        'CU': 5,   // 铜：5吨/手
        'AL': 5,   // 铝：5吨/手
        'ZN': 5,   // 锌：5吨/手
        'PB': 5,   // 铅：5吨/手
        'NI': 1,   // 镍：1吨/手
        'SN': 1,   // 锡：1吨/手
        'RB': 10,  // 螺纹钢：10吨/手
        'HC': 10,  // 热轧卷板：10吨/手
        'I': 100,  // 铁矿石：100吨/手
        'J': 100,  // 焦炭：100吨/手
        'JM': 60,  // 焦煤：60吨/手
      };
      return multiplierMap[varietyCode] || 1; // 默认1吨/手
    };

    // 计算手数对应的吨数
    const calculateTons = (qty, contractCode) => {
      if (!qty || qty === 0) return 0;
      const multiplier = getContractMultiplier(contractCode);
      return (qty * multiplier).toFixed(2);
    };

    // 委托单数据
    const mockFuturesOrders = [
      { 
        id: 1, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-23 10:30:00', 
        shortNo: 'NO001', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5300, 
        tradedQty: 50, 
        orderPrice: 5300,
        unmatchedQty: 20,
        orderStatus: '部成',
        spotRemarks: [
          { id: 1, qty: 20, spotQty: 100, pricingPrice: 5300, tag: '长单保值', remark: '备注1', customerId: 1, contractId: null, isMatched: false },
          { id: 2, qty: 10, spotQty: 50, pricingPrice: 0, tag: '订单接货保值', remark: '备注2', customerId: null, contractId: 1, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 2, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-23 11:00:00', 
        shortNo: 'NO002', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5250, 
        tradedQty: 30, 
        orderPrice: 5250,
        unmatchedQty: 30,
        orderStatus: '全成',
        spotRemarks: [],
        orderRemark: '<p>这是委托备注内容</p>'
      },
      { 
        id: 3, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（人员）方案', 
        hedgePlanId: 3,
        dateTime: '2025-11-23 09:15:00', 
        shortNo: 'NO003', 
        contract: 'CU2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5350, 
        tradedQty: 100, 
        orderPrice: 5350,
        unmatchedQty: 100,
        orderStatus: '全成',
        spotRemarks: [
          { id: 3, qty: 100, spotQty: 500, pricingPrice: 0, tag: '投机', remark: '', customerId: null, contractId: null, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 4, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-23 14:20:00', 
        shortNo: 'NO004', 
        contract: 'CU2403', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5280, 
        tradedQty: 80, 
        orderPrice: 5280,
        unmatchedQty: 0,
        orderStatus: '全成',
        spotRemarks: [
          { id: 4, qty: 50, spotQty: 250, pricingPrice: 5280, tag: '长单减量', remark: '减仓操作', customerId: 2, contractId: null, isMatched: true },
          { id: 5, qty: 30, spotQty: 150, pricingPrice: 5280, tag: '订单出货保值', remark: '出货备注', customerId: 2, contractId: null, isMatched: true }
        ],
        orderRemark: '<p>整体保值减仓操作</p>'
      },
      { 
        id: 5, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-23 15:45:00', 
        shortNo: 'NO005', 
        contract: 'AL2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5200, 
        tradedQty: 60, 
        orderPrice: 5200,
        unmatchedQty: 60,
        orderStatus: '全成',
        spotRemarks: [
          { id: 6, qty: 40, spotQty: 200, pricingPrice: 5200, tag: '买点价', remark: '点价买入', customerId: null, contractId: 2, isMatched: false },
          { id: 7, qty: 20, spotQty: 100, pricingPrice: 0, tag: '订单增量', remark: '增量操作', customerId: null, contractId: 2, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 6, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（客商）方案', 
        hedgePlanId: 4,
        dateTime: '2025-11-23 16:10:00', 
        shortNo: 'NO006', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5320, 
        tradedQty: 40, 
        orderPrice: 5320,
        unmatchedQty: 40,
        orderStatus: '全成',
        spotRemarks: [
          { id: 8, qty: 40, spotQty: 200, pricingPrice: 0, tag: '代持', remark: '代客持有', customerId: 3, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>客商代持操作</p>'
      },
      { 
        id: 7, 
        futuresAccount: 'ACC002', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-23 09:30:00', 
        shortNo: 'NO007', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5240, 
        tradedQty: 25, 
        orderPrice: 5240,
        unmatchedQty: 5,
        orderStatus: '部成',
        spotRemarks: [
          { id: 9, qty: 20, spotQty: 100, pricingPrice: 5240, tag: '长单取消', remark: '取消订单', customerId: 4, contractId: null, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 8, 
        futuresAccount: 'ACC001', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 13:15:00', 
        shortNo: 'NO008', 
        contract: 'CU2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5360, 
        tradedQty: 70, 
        orderPrice: 5360,
        unmatchedQty: 70,
        orderStatus: '全成',
        spotRemarks: [
          { id: 10, qty: 35, spotQty: 175, pricingPrice: 5360, tag: '卖点价', remark: '点价卖出', customerId: null, contractId: 1, isMatched: false },
          { id: 11, qty: 35, spotQty: 175, pricingPrice: 0, tag: '订单减量', remark: '减量操作', customerId: null, contractId: 1, isMatched: false }
        ],
        orderRemark: '<p>点价和减量组合操作</p>'
      },
      { 
        id: 9, 
        futuresAccount: 'ACC002', 
        hedgePlan: '无合同（人员）方案', 
        hedgePlanId: 3,
        dateTime: '2025-11-24 10:00:00', 
        shortNo: 'NO009', 
        contract: 'AL2403', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5180, 
        tradedQty: 90, 
        orderPrice: 5180,
        unmatchedQty: 90,
        orderStatus: '全成',
        spotRemarks: [
          { id: 12, qty: 50, spotQty: 250, pricingPrice: 0, tag: '调敞口', remark: '调整敞口', customerId: null, contractId: null, isMatched: false },
          { id: 13, qty: 40, spotQty: 200, pricingPrice: 0, tag: '投机', remark: '投机交易', customerId: null, contractId: null, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 10, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 11:30:00', 
        shortNo: 'NO010', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5310, 
        tradedQty: 35, 
        orderPrice: 5310,
        unmatchedQty: 35,
        orderStatus: '全成',
        spotRemarks: [
          { id: 14, qty: 35, spotQty: 175, pricingPrice: 5310, tag: '长单增量', remark: '增量操作', customerId: 5, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>长单增量保值</p>'
      },
      { 
        id: 11, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 12:00:00', 
        shortNo: 'NO011', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5230, 
        tradedQty: 45, 
        orderPrice: 5230,
        unmatchedQty: 0,
        orderStatus: '全成',
        spotRemarks: [
          { id: 15, qty: 30, spotQty: 150, pricingPrice: 5230, tag: '订单取消', remark: '取消订单', customerId: null, contractId: 2, isMatched: true },
          { id: 16, qty: 15, spotQty: 75, pricingPrice: 5230, tag: '移仓换月', remark: '移仓操作', customerId: null, contractId: 2, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 12, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（客商）方案', 
        hedgePlanId: 4,
        dateTime: '2025-11-24 14:50:00', 
        shortNo: 'NO012', 
        contract: 'CU2403', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5340, 
        tradedQty: 55, 
        orderPrice: 5340,
        unmatchedQty: 55,
        orderStatus: '全成',
        spotRemarks: [
          { id: 17, qty: 55, spotQty: 275, pricingPrice: 0, tag: '代持', remark: '代客持有', customerId: 6, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>客商代持</p>'
      },
      { 
        id: 13, 
        futuresAccount: 'ACC002', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 15:20:00', 
        shortNo: 'NO013', 
        contract: 'AL2402', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5190, 
        tradedQty: 20, 
        orderPrice: 5190,
        unmatchedQty: 20,
        orderStatus: '未成',
        spotRemarks: [],
        orderRemark: ''
      },
      // 复制历史委托到当日（id 1-7 的副本，日期改为今天）
      { 
        id: 14, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 10:30:00', 
        shortNo: 'NO014', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5300, 
        tradedQty: 50, 
        orderPrice: 5300,
        unmatchedQty: 20,
        orderStatus: '部成',
        spotRemarks: [
          { id: 18, qty: 20, spotQty: 100, pricingPrice: 5300, tag: '长单保值', remark: '备注1', customerId: 1, contractId: null, isMatched: false },
          { id: 19, qty: 10, spotQty: 50, pricingPrice: 0, tag: '订单接货保值', remark: '备注2', customerId: null, contractId: 1, isMatched: true }
        ],
        orderRemark: ''
      },
      { 
        id: 15, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 11:00:00', 
        shortNo: 'NO015', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5250, 
        tradedQty: 30, 
        orderPrice: 5250,
        unmatchedQty: 30,
        orderStatus: '全成',
        spotRemarks: [],
        orderRemark: '<p>这是委托备注内容</p>'
      },
      { 
        id: 16, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（人员）方案', 
        hedgePlanId: 3,
        dateTime: '2025-11-24 09:15:00', 
        shortNo: 'NO016', 
        contract: 'CU2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5350, 
        tradedQty: 100, 
        orderPrice: 5350,
        unmatchedQty: 100,
        orderStatus: '全成',
        spotRemarks: [
          { id: 20, qty: 100, spotQty: 500, pricingPrice: 0, tag: '投机', remark: '', customerId: null, contractId: null, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 17, 
        futuresAccount: 'ACC001', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 14:20:00', 
        shortNo: 'NO017', 
        contract: 'CU2403', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5280, 
        tradedQty: 80, 
        orderPrice: 5280,
        unmatchedQty: 0,
        orderStatus: '全成',
        spotRemarks: [
          { id: 21, qty: 50, spotQty: 250, pricingPrice: 5280, tag: '长单减量', remark: '减仓操作', customerId: 2, contractId: null, isMatched: true },
          { id: 22, qty: 30, spotQty: 150, pricingPrice: 5280, tag: '订单出货保值', remark: '出货备注', customerId: 2, contractId: null, isMatched: true }
        ],
        orderRemark: '<p>整体保值减仓操作</p>'
      },
      { 
        id: 18, 
        futuresAccount: 'ACC002', 
        hedgePlan: '单单保值方案B', 
        hedgePlanId: 2,
        dateTime: '2025-11-24 15:45:00', 
        shortNo: 'NO018', 
        contract: 'AL2402', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5200, 
        tradedQty: 60, 
        orderPrice: 5200,
        unmatchedQty: 60,
        orderStatus: '全成',
        spotRemarks: [
          { id: 23, qty: 40, spotQty: 200, pricingPrice: 5200, tag: '买点价', remark: '点价买入', customerId: null, contractId: 2, isMatched: false },
          { id: 24, qty: 20, spotQty: 100, pricingPrice: 0, tag: '订单增量', remark: '增量操作', customerId: null, contractId: 2, isMatched: false }
        ],
        orderRemark: ''
      },
      { 
        id: 19, 
        futuresAccount: 'ACC001', 
        hedgePlan: '无合同（客商）方案', 
        hedgePlanId: 4,
        dateTime: '2025-11-24 16:10:00', 
        shortNo: 'NO019', 
        contract: 'CU2401', 
        direction: '买入', 
        openClose: '开仓',
        avgPrice: 5320, 
        tradedQty: 40, 
        orderPrice: 5320,
        unmatchedQty: 40,
        orderStatus: '全成',
        spotRemarks: [
          { id: 25, qty: 40, spotQty: 200, pricingPrice: 0, tag: '代持', remark: '代客持有', customerId: 3, contractId: null, isMatched: false }
        ],
        orderRemark: '<p>客商代持操作</p>'
      },
      { 
        id: 20, 
        futuresAccount: 'ACC002', 
        hedgePlan: '整体保值方案A', 
        hedgePlanId: 1,
        dateTime: '2025-11-24 09:30:00', 
        shortNo: 'NO020', 
        contract: 'AL2401', 
        direction: '卖出', 
        openClose: '平仓',
        avgPrice: 5240, 
        tradedQty: 25, 
        orderPrice: 5240,
        unmatchedQty: 5,
        orderStatus: '部成',
        spotRemarks: [
          { id: 26, qty: 20, spotQty: 100, pricingPrice: 5240, tag: '长单取消', remark: '取消订单', customerId: 4, contractId: null, isMatched: true }
        ],
        orderRemark: ''
      }
    ];

    // 期货品种选项（不带月份）
    const futuresVarietyOptions = [
      { value: 'CU', label: 'CU - 铜' },
      { value: 'AL', label: 'AL - 铝' },
      { value: 'ZN', label: 'ZN - 锌' },
      { value: 'PB', label: 'PB - 铅' },
      { value: 'NI', label: 'NI - 镍' },
      { value: 'SN', label: 'SN - 锡' },
      { value: 'RB', label: 'RB - 螺纹钢' },
      { value: 'HC', label: 'HC - 热轧卷板' },
      { value: 'I', label: 'I - 铁矿石' },
      { value: 'J', label: 'J - 焦炭' },
      { value: 'JM', label: 'JM - 焦煤' }
    ];

    // 从合约代码中提取品种代码（如 CU2401 -> CU）
    const extractVarietyCode = (code) => {
      if (!code) return '';
      // 如果code是纯字母（如CU），直接返回
      if (/^[A-Z]+$/i.test(code)) {
        return code.toUpperCase();
      }
      // 如果code包含数字（如CU2401），提取字母部分
      const match = code.match(/^([A-Z]+)/i);
      return match ? match[1].toUpperCase() : code;
    };

    // 现货品种管理页面
    const SpotBrandManagement = () => {
      const [selectedCategory, setSelectedCategory] = useState('cat-1');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ brand: '', mainPort: '', platform: '', futures: '' });
      const [spotBrands, setSpotBrands] = useState(mockSpotBrands);
      const [spotCategories, setSpotCategories] = useState(mockSpotCategories);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [priceModalVisible, setPriceModalVisible] = useState(false);
      const [historyModalVisible, setHistoryModalVisible] = useState(false);
      const [exposureModalVisible, setExposureModalVisible] = useState(false);
      const [categoryModalVisible, setCategoryModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentBrandId, setCurrentBrandId] = useState(null);
      const [currentBrand, setCurrentBrand] = useState(null); // 当前选中的品牌信息
      const [currentCategoryKey, setCurrentCategoryKey] = useState(null);
      const [currentParentKey, setCurrentParentKey] = useState(null);
      const [isEditMode, setIsEditMode] = useState(false); // 新增：false，编辑：true
      const [isCategoryEditMode, setIsCategoryEditMode] = useState(false); // 分类编辑模式
      const [form] = Form.useForm();
      const [exposureForm] = Form.useForm();
      const [categoryForm] = Form.useForm();
      const [priceForm] = Form.useForm();
      const [remarkForm] = Form.useForm();

      const filteredData = useMemo(() => {
        return spotBrands.filter(item => {
          if (filters.brand && !item.name.includes(filters.brand)) return false;
          if (filters.mainPort) {
            if (filters.mainPort === 'unset') {
              if (item.mainPortState !== null && item.mainPortState !== undefined) return false;
            } else if (item.mainPortState !== (filters.mainPort === 'true')) {
              return false;
            }
          }
          if (filters.platform) {
            if (filters.platform === 'unset') {
              if (item.platformState !== null && item.platformState !== undefined) return false;
            } else if (item.platformState !== (filters.platform === 'true')) {
              return false;
            }
          }
          if (filters.futures) {
            const keyword = filters.futures.toLowerCase();
            const matched = item.futures?.some(f => f.code?.toLowerCase().includes(keyword));
            if (!matched) return false;
          }
          return true;
        });
      }, [filters, spotBrands]);

      const BOOL_FILTER_OPTIONS = [
        { value: '', label: '全部' },
        { value: 'true', label: '是' },
        { value: 'false', label: '否' },
        { value: 'unset', label: '未设置' }
      ];

      const formatBoolState = (value) => {
        if (value === true) return '是';
        if (value === false) return '否';
        return '未设置';
      };

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '名称', dataIndex: 'name', width: 150, fixed: 'left' },
        { key: 'mainPortState', title: '是否主港', dataIndex: 'mainPortState', width: 120, render: formatBoolState },
        { key: 'platformState', title: '是否平台价', dataIndex: 'platformState', width: 140, render: formatBoolState },
        { key: 'premium', title: '升贴水', dataIndex: 'premium', width: 100 },
        { key: 'price', title: '价格', dataIndex: 'price', width: 120 },
        { 
          key: 'futures', 
          title: '期货敞口配置', 
          dataIndex: 'futures', 
          width: 300, 
          render: (arr) => {
            if (!arr || arr.length === 0) {
              return <span style={{ color: '#999' }}>未配置</span>;
            }
            return (
              <div style={{ lineHeight: 1.8 }}>
                {arr.map((item, index) => (
                  <div key={`${item.code}-${index}`}>
                    <strong>{item.code || '-'}</strong>
                    <span style={{ marginLeft: 8, color: '#4b5565' }}>敞口：{(item.exposure ?? 0).toFixed(2)}</span>
                  </div>
                ))}
              </div>
            );
          }
        },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: spotVisibleColumns
      } = useColumnManager('spot-brand', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 递归更新树节点
      const updateTreeNode = (nodes, targetKey, updater) => {
        return nodes.map(node => {
          if (node.key === targetKey) {
            return updater(node);
          }
          if (node.children) {
            return {
              ...node,
              children: updateTreeNode(node.children, targetKey, updater)
            };
          }
          return node;
        });
      };

      // 递归删除树节点
      const deleteTreeNode = (nodes, targetKey) => {
        return nodes.filter(node => {
          if (node.key === targetKey) {
            return false;
          }
          if (node.children) {
            node.children = deleteTreeNode(node.children, targetKey);
          }
          return true;
        });
      };

      // 递归查找父节点
      const findParentNode = (nodes, targetKey, parent = null) => {
        for (const node of nodes) {
          if (node.key === targetKey) {
            return parent;
          }
          if (node.children) {
            const found = findParentNode(node.children, targetKey, node);
            if (found !== null) {
              return found;
            }
          }
        }
        return null;
      };

      // 生成唯一的key
      const generateCategoryKey = () => {
        const allKeys = [];
        const collectKeys = (nodes) => {
          nodes.forEach(node => {
            allKeys.push(node.key);
            if (node.children) {
              collectKeys(node.children);
            }
          });
        };
        collectKeys(spotCategories);
        let counter = 1;
        while (allKeys.includes(`cat-${counter}`)) {
          counter++;
        }
        return `cat-${counter}`;
      };

      // 处理树节点数据，添加title渲染（带操作按钮）
      const processedTreeData = useMemo(() => {
        const processNodes = (nodes) => {
          return nodes.map(node => {
            const nodeTitle = (
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center', 
                width: '100%', 
                minWidth: 0,
                gap: 4
              }}>
                <Tooltip title={node.title} placement="right">
                  <span style={{ 
                    overflow: 'hidden', 
                    textOverflow: 'ellipsis', 
                    whiteSpace: 'nowrap', 
                    flex: 1,
                    minWidth: 0
                  }}>
                    {node.title}
                  </span>
                </Tooltip>
                <div onClick={(e) => e.stopPropagation()} style={{ flexShrink: 0, display: 'flex', gap: 2 }}>
                  <Button
                    type="text"
                    size="small"
                    icon={renderIcon('EditOutlined')}
                    style={{ padding: '0 4px', height: 20, width: 20, minWidth: 20 }}
                    onClick={() => {
                      setIsCategoryEditMode(true);
                      setCurrentCategoryKey(node.key);
                      const parent = findParentNode(spotCategories, node.key);
                      setCurrentParentKey(parent ? parent.key : null);
                      categoryForm.setFieldsValue({ title: node.title });
                      setCategoryModalVisible(true);
                    }}
                  />
                  <Button
                    type="text"
                    size="small"
                    danger
                    icon={renderIcon('DeleteOutlined')}
                    style={{ padding: '0 4px', height: 20, width: 20, minWidth: 20 }}
                    onClick={() => {
                      Modal.confirm({
                        title: '确认删除',
                        content: `确定要删除分类"${node.title}"吗？删除后其子分类也会被删除。`,
                        onOk: () => {
                          setSpotCategories(prev => deleteTreeNode(prev, node.key));
                          if (selectedCategory === node.key) {
                            setSelectedCategory('');
                          }
                          message.success('删除成功');
                        }
                      });
                    }}
                  />
                </div>
              </div>
            );
            return {
              ...node,
              title: nodeTitle,
              children: node.children ? processNodes(node.children) : undefined
            };
          });
        };
        return processNodes(spotCategories);
      }, [spotCategories, selectedCategory]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-tree-table-layout" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-tree-panel">
              <Space style={{ marginBottom: 12, width: '100%', justifyContent: 'space-between', flexShrink: 0 }}>
                <span style={{ fontWeight: 600 }}>现货品种</span>
                <Button size="small" icon={renderIcon('PlusOutlined')} onClick={() => {
                  setIsCategoryEditMode(false);
                  setCurrentCategoryKey(null);
                  setCurrentParentKey(selectedCategory || null);
                  categoryForm.resetFields();
                  setCategoryModalVisible(true);
                }} />
              </Space>
              <div className="tree-content">
                <Tree
                  treeData={processedTreeData}
                  selectedKeys={[selectedCategory]}
                  onSelect={(keys) => setSelectedCategory(keys[0] || '')}
                  defaultExpandAll
                />
              </div>
            </div>
            <div className="erp-table-panel">
              <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
                <div className="erp-filter-item">
                  <label>品牌：</label>
                  <Input placeholder="品牌" style={{ width: 150 }} value={filters.brand} onChange={(e) => setFilters({...filters, brand: e.target.value})} />
                </div>
                <div className="erp-filter-item">
                  <label>主港：</label>
                  <Select placeholder="全部" style={{ width: 150 }} value={filters.mainPort} onChange={(v) => setFilters({...filters, mainPort: v ?? ''})}>
                    {BOOL_FILTER_OPTIONS.map(opt => (
                      <Select.Option value={opt.value} key={`main-${opt.value}`}>{opt.label}</Select.Option>
                    ))}
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>平台：</label>
                  <Select placeholder="全部" style={{ width: 150 }} value={filters.platform} onChange={(v) => setFilters({...filters, platform: v ?? ''})}>
                    {BOOL_FILTER_OPTIONS.map(opt => (
                      <Select.Option value={opt.value} key={`platform-${opt.value}`}>{opt.label}</Select.Option>
                    ))}
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>期货品种：</label>
                  <Input placeholder="期货品种" style={{ width: 150 }} value={filters.futures} onChange={(e) => setFilters({...filters, futures: e.target.value})} />
                </div>
              </div>
              <div className="erp-toolbar" style={{ flexShrink: 0 }}>
                <Space wrap>
                  <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => {
                    setIsEditMode(false);
                    setCurrentBrandId(null);
                    form.resetFields();
                    form.setFieldsValue({ 
                      mainPortState: false, 
                      platformState: false, 
                      futures: undefined,
                      exposure: undefined
                    });
                    setEditModalVisible(true);
                  }}>增加</Button>
                  <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const brand = spotBrands.find(item => item.id === selectedRowKeys[0]);
                      if (brand) {
                        setIsEditMode(true);
                        setCurrentBrandId(brand.id);
                        form.setFieldsValue({
                          name: brand.name,
                          mainPortState: brand.mainPortState,
                          platformState: brand.platformState
                          // 编辑时不设置futures和exposure，这些通过配置敞口管理
                        });
                        setEditModalVisible(true);
                      }
                    }
                  }}>编辑</Button>
                  <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                    if (selectedRowKeys.length > 0) {
                      Modal.confirm({
                        title: '确认删除',
                        content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
                        onOk: () => {
                          setSpotBrands(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
                          setSelectedRowKeys([]);
                          message.success('删除成功');
                        }
                      });
                    }
                  }}>删除</Button>
                  <Button icon={renderIcon('PoweroffOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                    if (selectedRowKeys.length > 0) {
                      const selectedBrands = spotBrands.filter(item => selectedRowKeys.includes(item.id));
                      const hasDisabled = selectedBrands.some(b => b.status === 'disabled');
                      const action = hasDisabled ? '启用' : '禁用';
                      
                      Modal.confirm({
                        title: `确认${action}`,
                        content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
                        onOk: () => {
                          const newStatus = hasDisabled ? 'enabled' : 'disabled';
                          setSpotBrands(prev => prev.map(item => {
                            if (selectedRowKeys.includes(item.id)) {
                              return { ...item, status: newStatus };
                            }
                            return item;
                          }));
                          message.success(`${action}成功`);
                        }
                      });
                    }
                  }}>禁用/启用</Button>
                  <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const brand = spotBrands.find(item => item.id === selectedRowKeys[0]);
                      if (brand) {
                        setCurrentBrandId(brand.id);
                        remarkForm.setFieldsValue({ remark: brand.remark || '' });
                        setRemarkModalVisible(true);
                      }
                    }
                  }}>备注</Button>
                  <Button icon={renderIcon('DollarOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const brand = spotBrands.find(b => b.id === selectedRowKeys[0]);
                      setCurrentBrand(brand);
                      priceForm.resetFields();
                      // 设置表单初始值
                      priceForm.setFieldsValue({
                        price: brand?.price || 0,
                        premium: brand?.premium || 0,
                        date: dayjs() // 默认当前日期
                      });
                      setPriceModalVisible(true);
                    }
                  }}>录入价格</Button>
                  <Button icon={renderIcon('ClusterOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const brand = spotBrands.find(item => item.id === selectedRowKeys[0]);
                      setCurrentBrandId(brand?.id || null);
                      exposureForm.setFieldsValue({
                        futures: brand?.futures?.length 
                          ? brand.futures.map(f => ({ 
                              code: extractVarietyCode(f.code), // 提取品种代码（不带月份）
                              exposure: f.exposure 
                            })) 
                          : [{ code: '', exposure: 0 }]
                      });
                      setExposureModalVisible(true);
                    }
                  }}>配置敞口</Button>
                  <Button icon={renderIcon('UploadOutlined')}>导入价格</Button>
                  <Button icon={renderIcon('HistoryOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setHistoryModalVisible(true)}>历史价格</Button>
                  <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
                </Space>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                  style={{ marginLeft: 'auto' }}
                >
                  自定义列
                </Button>
              </div>
              <div className="erp-table-wrapper">
                <Table
                  rowSelection={{ 
                    type: 'radio',
                    selectedRowKeys, 
                    onChange: setSelectedRowKeys 
                  }}
                  columns={tableColumns}
                  dataSource={filteredData}
                  rowKey="id"
                  scroll={{ x: 'max-content' }}
                  pagination={createPaginationConfig()}
                />
              </div>
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑品牌" : "新增品牌"}
            open={editModalVisible}
            onCancel={() => {
              setEditModalVisible(false);
              form.resetFields();
            }}
            onOk={() => {
              form.validateFields().then(values => {
                // 验证主港和平台价的互斥关系
                if (values.platformState === true && values.mainPortState !== null) {
                  message.error('选择平台价时，是否主港必须为未设置');
                  return;
                }
                if (values.mainPortState === true && values.platformState !== null) {
                  message.error('选择主港时，是否平台价必须为未设置');
                  return;
                }
                
                // 新增品牌时，期货品种只能是一个
                let futuresList = [];
                if (values.futures && values.exposure !== undefined && values.exposure !== null) {
                  futuresList = [{
                    code: values.futures,
                    exposure: Number(values.exposure) || 0
                  }];
                }
                
                if (isEditMode && currentBrandId) {
                  // 编辑模式：更新现有记录（不修改期货品种，期货品种通过配置敞口修改）
                  setSpotBrands(prev => prev.map(item => {
                    if (item.id === currentBrandId) {
                      return {
                        ...item,
                        name: values.name,
                        mainPortState: values.mainPortState,
                        platformState: values.platformState
                        // 编辑时不修改futures，保持原有配置
                      };
                    }
                    return item;
                  }));
                  message.success('保存成功');
                } else {
                  // 新增模式：创建新记录
                  const newId = Math.max(...spotBrands.map(b => b.id), 0) + 1;
                  const newBrand = {
                    id: newId,
                    name: values.name,
                    mainPortState: values.mainPortState,
                    platformState: values.platformState,
                    premium: 0,
                    price: 0,
                    status: 'enabled', // 默认启用
                    futures: futuresList
                  };
                  setSpotBrands(prev => [...prev, newBrand]);
                  message.success('新增成功');
                }
                setEditModalVisible(false);
                form.resetFields();
              }).catch(err => {
                console.error('表单验证失败:', err);
              });
            }}
          >
            <Form
              form={form}
              layout="vertical"
              initialValues={{ mainPortState: false, platformState: false, futures: [] }}
            >
              <Form.Item label="名称" name="name" rules={[{ required: true, message: '请输入名称' }]}>
                <Input placeholder="请输入品牌名称" />
              </Form.Item>
              <Form.Item 
                label="是否主港" 
                name="mainPortState" 
                rules={[{ required: true, message: '请选择是否主港' }]}
              >
                <Select 
                  placeholder="请选择"
                  onChange={(value) => {
                    // 如果选择主港，平台价必须设为未设置
                    if (value === true) {
                      form.setFieldsValue({ platformState: null });
                    }
                  }}
                >
                  <Select.Option value={true}>是</Select.Option>
                  <Select.Option value={false}>否</Select.Option>
                  <Select.Option value={null}>未设置</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item 
                label="是否平台价" 
                name="platformState" 
                rules={[{ required: true, message: '请选择是否平台价' }]}
              >
                <Select 
                  placeholder="请选择"
                  onChange={(value) => {
                    // 如果选择平台价，主港必须设为未设置
                    if (value === true) {
                      form.setFieldsValue({ mainPortState: null });
                    }
                  }}
                >
                  <Select.Option value={true}>是</Select.Option>
                  <Select.Option value={false}>否</Select.Option>
                  <Select.Option value={null}>未设置</Select.Option>
                </Select>
              </Form.Item>
              {!isEditMode && (
                <>
                  <Form.Item label="期货品种" name="futures">
                    <Select 
                      placeholder="请选择期货品种（选填）" 
                      allowClear
                      options={futuresVarietyOptions}
                    />
                  </Form.Item>
                  <Form.Item label="敞口系数" name="exposure">
                    <InputNumber min={0} max={5} step={0.01} style={{ width: '100%' }} placeholder="请输入敞口系数（选填）" />
                  </Form.Item>
                </>
              )}
              {isEditMode && (
                <Form.Item label="期货品种配置">
                  <div style={{ color: '#8a94a6', fontSize: 12 }}>
                    期货品种配置请通过"配置敞口"功能进行管理
                  </div>
                </Form.Item>
              )}
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="录入价格"
            open={priceModalVisible}
            onCancel={() => {
              setPriceModalVisible(false);
              priceForm.resetFields();
            }}
            onOk={() => {
              priceForm.validateFields().then(values => {
                // 判断是否需要录入价格还是升贴水
                const isMainPort = currentBrand?.mainPortState === true;
                const isPlatform = currentBrand?.platformState === true;
                const needPrice = isMainPort || isPlatform;
                
                if (needPrice) {
                  // 主港或平台价：更新价格
                  setSpotBrands(prev => prev.map(item => {
                    if (item.id === currentBrand?.id) {
                      return {
                        ...item,
                        price: values.price || 0
                      };
                    }
                    return item;
                  }));
                  message.success('价格录入成功');
                } else {
                  // 非主港：更新升贴水
                  setSpotBrands(prev => prev.map(item => {
                    if (item.id === currentBrand?.id) {
                      return {
                        ...item,
                        premium: values.premium || 0
                      };
                    }
                    return item;
                  }));
                  message.success('升贴水录入成功');
                }
                setPriceModalVisible(false);
                priceForm.resetFields();
              }).catch(err => {
                console.error('表单验证失败:', err);
              });
            }}
          >
            <Form form={priceForm} layout="vertical">
              <Form.Item label="品牌">
                <Input value={currentBrand?.name || ''} disabled />
              </Form.Item>
              {(() => {
                const isMainPort = currentBrand?.mainPortState === true;
                const isPlatform = currentBrand?.platformState === true;
                const needPrice = isMainPort || isPlatform;
                
                if (needPrice) {
                  // 主港或平台价：显示价格字段
                  return (
                    <Form.Item 
                      label="价格" 
                      name="price" 
                      rules={[{ required: true, message: '请输入价格' }]}
                    >
                      <InputNumber style={{ width: '100%' }} placeholder="请输入价格" />
                    </Form.Item>
                  );
                } else {
                  // 非主港：显示升贴水字段
                  return (
                    <Form.Item 
                      label="升贴水" 
                      name="premium" 
                      rules={[{ required: true, message: '请输入升贴水' }]}
                    >
                      <InputNumber style={{ width: '100%' }} placeholder="请输入升贴水" />
                    </Form.Item>
                  );
                }
              })()}
              <Form.Item label="发生日期" name="date" rules={[{ required: true, message: '请选择发生日期' }]}>
                <DatePicker style={{ width: '100%' }} placeholder="请选择发生日期" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="历史价格"
            open={historyModalVisible}
            onCancel={() => setHistoryModalVisible(false)}
            width={800}
          >
            <div className="erp-filter-bar">
              <div className="erp-filter-item">
                <label>日期：</label>
                <DatePicker.RangePicker />
              </div>
            </div>
            <Table
              columns={[
                { title: '名称', dataIndex: 'name' },
                { title: '升贴水', dataIndex: 'premium' },
                { title: '价格', dataIndex: 'price' },
                { title: '日期', dataIndex: 'date' }
              ]}
              dataSource={[]}
              pagination={false}
            />
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="配置期货敞口"
            open={exposureModalVisible}
            onCancel={() => setExposureModalVisible(false)}
            width={520}
            destroyOnClose
            onOk={() => {
              exposureForm.validateFields().then(values => {
                const futuresList = (values.futures || [])
                  .filter(item => item?.code)
                  .map(item => ({ code: item.code.trim(), exposure: Number(item.exposure) || 0 }));
                setSpotBrands(prev => prev.map(item => {
                  if (item.id === currentBrandId) {
                    return { ...item, futures: futuresList };
                  }
                  return item;
                }));
                message.success('敞口配置已更新');
                setExposureModalVisible(false);
              });
            }}
          >
            <Form form={exposureForm} layout="vertical" preserve={false}>
              <Form.List name="futures" initialValue={[{ code: '', exposure: 0 }]}>
                {(fields, { add, remove }) => (
                  <Space direction="vertical" style={{ width: '100%' }}>
                    {fields.map((field, index) => (
                      <Space key={field.key} align="baseline" style={{ width: '100%' }}>
                        <Form.Item
                          {...field}
                          name={[field.name, 'code']}
                          fieldKey={[field.fieldKey, 'code']}
                          label="期货品种"
                          rules={[{ required: true, message: '请选择期货品种' }]}
                        >
                          <Select 
                            placeholder="请选择期货品种" 
                            style={{ width: 160 }}
                            options={futuresVarietyOptions}
                          />
                        </Form.Item>
                        <Form.Item
                          {...field}
                          name={[field.name, 'exposure']}
                          fieldKey={[field.fieldKey, 'exposure']}
                          label="敞口系数"
                          rules={[{ required: true, message: '请输入敞口系数' }]}
                        >
                          <InputNumber min={0} max={5} step={0.01} style={{ width: 140 }} />
                        </Form.Item>
                        {fields.length > 1 && (
                          <Button
                            type="text"
                            danger
                            icon={renderIcon('DeleteOutlined')}
                            onClick={() => remove(field.name)}
                          />
                        )}
                      </Space>
                    ))}
                    <Button
                      type="dashed"
                      onClick={() => add({ code: '', exposure: 0 })}
                      icon={renderIcon('PlusOutlined')}
                      block
                    >
                      新增期货品种
                    </Button>
                  </Space>
                )}
              </Form.List>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title={isCategoryEditMode ? "编辑分类" : "新增分类"}
            open={categoryModalVisible}
            onCancel={() => {
              setCategoryModalVisible(false);
              categoryForm.resetFields();
            }}
            onOk={() => {
              categoryForm.validateFields().then(values => {
                if (isCategoryEditMode && currentCategoryKey) {
                  // 编辑模式：更新分类名称
                  setSpotCategories(prev => updateTreeNode(prev, currentCategoryKey, (node) => ({
                    ...node,
                    title: values.title
                  })));
                  message.success('保存成功');
                } else {
                  // 新增模式：创建新分类
                  const newKey = generateCategoryKey();
                  const newCategory = {
                    key: newKey,
                    title: values.title,
                    children: values.isParent ? [] : undefined
                  };
                  
                  if (currentParentKey) {
                    // 添加到父节点下
                    setSpotCategories(prev => updateTreeNode(prev, currentParentKey, (node) => ({
                      ...node,
                      children: [...(node.children || []), newCategory]
                    })));
                  } else {
                    // 添加到根节点
                    setSpotCategories(prev => [...prev, newCategory]);
                  }
                  message.success('新增成功');
                }
                setCategoryModalVisible(false);
                categoryForm.resetFields();
              }).catch(err => {
                console.error('表单验证失败:', err);
              });
            }}
          >
            <Form
              form={categoryForm}
              layout="vertical"
            >
              <Form.Item label="分类名称" name="title" rules={[{ required: true, message: '请输入分类名称' }]}>
                <Input placeholder="请输入分类名称" />
              </Form.Item>
              {!isCategoryEditMode && (
                <Form.Item label="是否父分类" name="isParent" valuePropName="checked">
                  <Checkbox>作为父分类（可添加子分类）</Checkbox>
                </Form.Item>
              )}
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setSpotBrands(prev => prev.map(item => {
                  if (item.id === currentBrandId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={spotVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 通用的列管理Hook
    const useColumnManager = (pageKey, allColumnDefinitions, defaultVisibleColumns, options = {}) => {
      const { onRowSelect, onCellClick } = options;
      
      const [visibleColumns, setVisibleColumns] = useState(() => {
        const saved = localStorage.getItem(`${pageKey}-columns`);
        if (saved) {
          try {
            const savedColumns = JSON.parse(saved);
            // 检查是否有新列添加到 allColumnDefinitions 中
            const savedKeys = savedColumns.map(col => col.key);
            const allKeys = allColumnDefinitions.map(col => col.key);
            const newKeys = allKeys.filter(key => !savedKeys.includes(key));
            
            if (newKeys.length > 0) {
              // 如果有新列，自动添加到可见列中
              const newColumns = allColumnDefinitions.filter(col => newKeys.includes(col.key));
              return [...savedColumns, ...newColumns];
            }
            return savedColumns;
          } catch (e) {
            return defaultVisibleColumns;
          }
        }
        return defaultVisibleColumns;
      });

      const [columnEditorVisible, setColumnEditorVisible] = useState(false);

      useEffect(() => {
        localStorage.setItem(`${pageKey}-columns`, JSON.stringify(visibleColumns));
      }, [visibleColumns, pageKey]);

      const handleColumnSave = (columns) => {
        setVisibleColumns(columns);
        setColumnEditorVisible(false);
        message.success('列设置已保存');
      };

      const handleColumnRestoreDefault = () => {
        setVisibleColumns(defaultVisibleColumns);
        setColumnEditorVisible(false);
        message.success('已恢复默认列设置');
      };

      // 构建表格列
      const tableColumns = useMemo(() => {
        return visibleColumns.map(col => {
            const def = allColumnDefinitions.find(d => d.key === col.key);
            const columnDef = {
              ...def,
              ...col,
              width: col.width || def?.width || 150,
              // 确保 render 函数从原始定义中保留
              render: def?.render || col.render
            };
            
            // 处理单元格点击行为
            const isClickable = def?.clickable === true || col.clickable === true;
            const hasCustomClick = def?.onCellClick || onCellClick;
            
            if (isClickable && hasCustomClick) {
              // 可操作类：点击弹出详情对话框
              columnDef.onCell = (record) => ({
                onClick: (e) => {
                  // 如果点击的是单元格内的按钮、链接等交互元素，不触发
                  if (e.target.tagName === 'BUTTON' || 
                      e.target.tagName === 'A' || 
                      e.target.closest('button') || 
                      e.target.closest('a') ||
                      e.target.closest('.ant-btn') ||
                      e.target.closest('.ant-tag') ||
                      e.target.closest('.ant-input') ||
                      e.target.closest('.ant-select')) {
                    return;
                  }
                  // 调用自定义点击处理函数
                  const clickHandler = def?.onCellClick || onCellClick;
                  if (clickHandler) {
                    clickHandler(record, e);
                  }
                },
                style: { cursor: 'pointer' }
              });
            } else if (!isClickable && onRowSelect) {
              // 不可操作类：点击选中行
              columnDef.onCell = (record) => ({
                onClick: (e) => {
                  // 如果点击的是单元格内的按钮、链接等交互元素，不触发选中
                  if (e.target.tagName === 'BUTTON' || 
                      e.target.tagName === 'A' || 
                      e.target.closest('button') || 
                      e.target.closest('a') ||
                      e.target.closest('.ant-btn') ||
                      e.target.closest('.ant-tag') ||
                      e.target.closest('.ant-input') ||
                      e.target.closest('.ant-select')) {
                    return;
                  }
                  // 选中该行
                  if (record && record.id !== undefined) {
                    onRowSelect([record.id]);
                  }
                },
                style: { cursor: 'pointer' }
              });
            }
            return columnDef;
          });
      }, [visibleColumns, allColumnDefinitions, onRowSelect, onCellClick]);

      return {
        visibleColumns,
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions,
        defaultVisibleColumns,
        setVisibleColumns
      };
    };

    // 列编辑器组件
    const ColumnEditor = ({ allColumns, visibleColumns, onSave, onCancel, onRestoreDefault }) => {
      const [localVisibleColumns, setLocalVisibleColumns] = useState([...visibleColumns]);
      const [widthInputs, setWidthInputs] = useState({});
      const [draggedIndex, setDraggedIndex] = useState(null);
      const [dragOverIndex, setDragOverIndex] = useState(null);
      
      useEffect(() => {
        const widths = {};
        localVisibleColumns.forEach(col => {
          widths[col.key] = col.width || 150;
        });
        setWidthInputs(widths);
      }, [localVisibleColumns]);

      const handleToggleColumn = (columnKey) => {
        const column = allColumns.find(c => c.key === columnKey);
        if (!column) return;
        
        const isVisible = localVisibleColumns.some(c => c.key === columnKey);
        if (isVisible) {
          setLocalVisibleColumns(localVisibleColumns.filter(c => c.key !== columnKey));
        } else {
          setLocalVisibleColumns([...localVisibleColumns, { ...column, width: column.width || 150 }]);
        }
      };

      const handleSelectAll = (checked) => {
        if (checked) {
          setLocalVisibleColumns(allColumns.map(col => ({ ...col, width: col.width || 150 })));
        } else {
          setLocalVisibleColumns([]);
        }
      };

      const handleRemoveColumn = (columnKey) => {
        setLocalVisibleColumns(localVisibleColumns.filter(c => c.key !== columnKey));
      };

      const handleWidthChange = (columnKey, width) => {
        setWidthInputs({ ...widthInputs, [columnKey]: width });
        setLocalVisibleColumns(localVisibleColumns.map(col => 
          col.key === columnKey ? { ...col, width } : col
        ));
      };

      const handleDragStart = (e, index) => {
        // 如果点击的是按钮或按钮内的元素，不触发拖拽
        const target = e.target;
        if (target.tagName === 'BUTTON' || 
            target.closest('button') || 
            target.closest('.erp-column-item-actions')) {
          e.preventDefault();
          return false;
        }
        setDraggedIndex(index);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', index.toString());
        // 设置拖拽时的视觉效果
        if (e.currentTarget) {
          e.currentTarget.style.opacity = '0.5';
        }
      };

      const handleDragEnd = (e) => {
        e.currentTarget.style.opacity = '1';
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const handleDragOver = (e, index) => {
        e.preventDefault();
        e.stopPropagation();
        e.dataTransfer.dropEffect = 'move';
        if (draggedIndex !== null && draggedIndex !== index) {
          setDragOverIndex(index);
        }
      };

      const handleDragLeave = (e) => {
        e.preventDefault();
        // 只有当离开到列表外部时才清除dragOverIndex
        const rect = e.currentTarget.getBoundingClientRect();
        const x = e.clientX;
        const y = e.clientY;
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
          setDragOverIndex(null);
        }
      };

      const handleDrop = (e, dropIndex) => {
        e.preventDefault();
        e.stopPropagation();
        if (draggedIndex === null || draggedIndex === dropIndex) {
          setDragOverIndex(null);
          return;
        }

        const newColumns = [...localVisibleColumns];
        const [moved] = newColumns.splice(draggedIndex, 1);
        newColumns.splice(dropIndex, 0, moved);
        setLocalVisibleColumns(newColumns);
        setDraggedIndex(null);
        setDragOverIndex(null);
      };

      const handleSave = () => {
        const finalColumns = localVisibleColumns.map(col => ({
          ...col,
          width: widthInputs[col.key] || col.width || 150
        }));
        onSave(finalColumns);
      };

      const allSelected = localVisibleColumns.length === allColumns.length;
      const someSelected = localVisibleColumns.length > 0 && localVisibleColumns.length < allColumns.length;

      return (
        <Modal
          {...MODAL_TEXTS}
          title="设置自定义列"
          open={true}
          onCancel={onCancel}
          width={800}
          className="erp-column-editor-modal"
          footer={[
            <Button key="cancel" onClick={onCancel}>取消</Button>,
            <Button key="restore" onClick={onRestoreDefault}>恢复默认</Button>,
            <Button key="confirm" type="primary" onClick={handleSave}>确认</Button>
          ]}
        >
          <div className="erp-column-editor-content">
            <div className="erp-column-editor-panel">
              <div className="erp-column-editor-panel-title">请选择列表中要展示的信息</div>
              <div className="erp-column-list">
                <div className="erp-column-item">
                  <Checkbox
                    checked={allSelected}
                    indeterminate={someSelected}
                    onChange={(e) => handleSelectAll(e.target.checked)}
                  >
                    全选
                  </Checkbox>
                </div>
                {allColumns.map(column => {
                  const isChecked = localVisibleColumns.some(c => c.key === column.key);
                  return (
                    <div key={column.key} className="erp-column-item">
                      <Checkbox
                        checked={isChecked}
                        onChange={() => handleToggleColumn(column.key)}
                      >
                        {column.title}
                      </Checkbox>
                    </div>
                  );
                })}
              </div>
            </div>
            <div className="erp-column-editor-panel">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                <div className="erp-column-editor-panel-title">当前选定的字段</div>
                <Button size="small" onClick={() => setLocalVisibleColumns([])}>清空</Button>
              </div>
              <div className="erp-column-list">
                {localVisibleColumns.map((column, index) => (
                  <div
                    key={column.key}
                    className={`erp-column-item ${draggedIndex === index ? 'dragging' : ''} ${dragOverIndex === index ? 'drag-over' : ''}`}
                    draggable={true}
                    onDragStart={(e) => handleDragStart(e, index)}
                    onDragEnd={handleDragEnd}
                    onDragOver={(e) => handleDragOver(e, index)}
                    onDragLeave={handleDragLeave}
                    onDrop={(e) => handleDrop(e, index)}
                  >
                    <span style={{ userSelect: 'none', flex: 1 }}>{column.title}</span>
                    <div 
                      className="erp-column-item-actions" 
                      onClick={(e) => e.stopPropagation()}
                      onMouseDown={(e) => {
                        e.stopPropagation();
                        // 阻止拖拽
                        const parent = e.currentTarget.closest('.erp-column-item');
                        if (parent) {
                          parent.draggable = false;
                          setTimeout(() => {
                            parent.draggable = true;
                          }, 100);
                        }
                      }}
                      style={{ pointerEvents: 'auto' }}
                    >
                      <Button
                        size="small"
                        type="text"
                        onClick={(e) => {
                          e.stopPropagation();
                          const currentWidth = widthInputs[column.key] || column.width || 150;
                          let tempWidth = currentWidth;
                          Modal.confirm({
                            ...MODAL_TEXTS,
                            title: `设置"${column.title}"列宽`,
                            content: (
                              <div style={{ marginTop: 16 }}>
                                <InputNumber
                                  style={{ width: '100%' }}
                                  min={50}
                                  max={500}
                                  defaultValue={currentWidth}
                                  onChange={(val) => {
                                    if (val !== null) {
                                      tempWidth = val;
                                    }
                                  }}
                                  addonAfter="px"
                                />
                              </div>
                            ),
                            onOk: () => {
                              handleWidthChange(column.key, tempWidth);
                              message.success('列宽已更新');
                            }
                          });
                        }}
                        style={{ padding: '0 4px' }}
                      >
                        宽度设置
                      </Button>
                      <Button
                        size="small"
                        type="text"
                        danger
                        icon={renderIcon('DeleteOutlined')}
                        onClick={(e) => {
                          e.stopPropagation();
                          handleRemoveColumn(column.key);
                        }}
                        style={{ padding: '0 4px' }}
                      />
                      <span 
                        className="erp-column-item-drag" 
                        title="拖拽排序（点击并拖动整行）" 
                        style={{ cursor: 'move', fontSize: 16, userSelect: 'none', padding: '4px' }}
                        onMouseDown={(e) => e.stopPropagation()}
                      >
                        {renderIcon('MenuOutlined') || '⋮⋮'}
                      </span>
                    </div>
                  </div>
                ))}
                {localVisibleColumns.length === 0 && (
                  <div style={{ textAlign: 'center', color: '#999', padding: '40px 0' }}>
                    暂无选定的字段
                  </div>
                )}
              </div>
            </div>
          </div>
        </Modal>
      );
    };

    // 客商管理页面
    const CustomerManagement = () => {
      const [selectedCategory, setSelectedCategory] = useState('supplier');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ shortName: '', fullName: '' });
      const [customers, setCustomers] = useState(mockCustomers);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentCustomerId, setCurrentCustomerId] = useState(null);
      const [isEditMode, setIsEditMode] = useState(false);
      const [form] = Form.useForm();
      const [remarkForm] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'shortName', title: '简称', dataIndex: 'shortName', width: 150 },
        { key: 'fullName', title: '全称', dataIndex: 'fullName', width: 250 },
        { key: 'contact', title: '联系人', dataIndex: 'contact', width: 120 },
        { key: 'phone', title: '联系电话', dataIndex: 'phone', width: 150 },
        { key: 'customerType', title: '客商类型', dataIndex: 'customerType', width: 120, render: (type) => (
          type ? <Tag color="blue">{type}</Tag> : '-'
        )},
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )},
        { key: 'creditRating', title: '信用评级', dataIndex: 'creditRating', width: 120 },
        { key: 'parentCompany', title: '关联母公司', dataIndex: 'parentCompany', width: 200 },
        { key: 'creator', title: '创建人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '创建时间', dataIndex: 'createTime', width: 180 }
      ];

      // 默认显示的列（排除关联母公司）
      const defaultVisibleColumns = allColumnDefinitions.filter(col => col.key !== 'parentCompany');

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: customerVisibleColumns
      } = useColumnManager('customer', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const customerCategories = [
        { key: 'supplier', title: '供应商' },
        { key: 'customer', title: '客户' },
        { key: 'warehouse', title: '仓库' },
        { key: 'logistics', title: '物流' },
        { key: 'broker', title: '撮合商' },
        { key: 'other', title: '客商' }
      ];

      // 从数据中提取唯一的简称和全称列表
      const shortNameOptions = useMemo(() => {
        const uniqueNames = [...new Set(mockCustomers.map(item => item.shortName).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, []);

      const fullNameOptions = useMemo(() => {
        const uniqueNames = [...new Set(mockCustomers.map(item => item.fullName).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, []);

      const filteredData = useMemo(() => {
        return customers.filter(item => {
          if (filters.shortName && !item.shortName.includes(filters.shortName)) return false;
          if (filters.fullName && !item.fullName.includes(filters.fullName)) return false;
          return true;
        });
      }, [filters, customers]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-tree-table-layout" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-tree-panel">
              <Space style={{ marginBottom: 12, width: '100%', justifyContent: 'space-between', flexShrink: 0 }}>
                <span style={{ fontWeight: 600 }}>客商类型</span>
                <Button size="small" icon={renderIcon('PlusOutlined')} onClick={() => message.info('添加类型')} />
              </Space>
              <div className="tree-content">
                <Tree
                  treeData={customerCategories}
                  selectedKeys={[selectedCategory]}
                  onSelect={(keys) => setSelectedCategory(keys[0])}
                  defaultExpandAll
                />
              </div>
            </div>
            <div className="erp-table-panel">
              <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
                <div className="erp-filter-item">
                  <label>简称：</label>
                  <Select
                    showSearch
                    allowClear
                    placeholder="请输入或选择简称"
                    style={{ width: 200 }}
                    value={filters.shortName || undefined}
                    onChange={(value) => setFilters({...filters, shortName: value || ''})}
                    options={shortNameOptions}
                    filterOption={(input, option) =>
                      (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                    }
                  />
                </div>
                <div className="erp-filter-item">
                  <label>全称：</label>
                  <Select
                    showSearch
                    allowClear
                    placeholder="请输入或选择全称"
                    style={{ width: 250 }}
                    value={filters.fullName || undefined}
                    onChange={(value) => setFilters({...filters, fullName: value || ''})}
                    options={fullNameOptions}
                    filterOption={(input, option) =>
                      (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                    }
                  />
                </div>
                <div className="erp-filter-item">
                  <label>联系人：</label>
                  <Input placeholder="联系人" style={{ width: 150 }} value={filters.contact} onChange={(e) => setFilters({...filters, contact: e.target.value})} />
                </div>
                <div className="erp-filter-item">
                  <label>手机号：</label>
                  <Input placeholder="手机号" style={{ width: 150 }} value={filters.phone} onChange={(e) => setFilters({...filters, phone: e.target.value})} />
                </div>
              </div>
              <div className="erp-toolbar" style={{ flexShrink: 0 }}>
                <Space wrap>
                  <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => {
                    setIsEditMode(false);
                    setCurrentCustomerId(null);
                    form.resetFields();
                    setEditModalVisible(true);
                  }}>增加</Button>
                  <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const customer = customers.find(item => item.id === selectedRowKeys[0]);
                      if (customer) {
                        setIsEditMode(true);
                        setCurrentCustomerId(customer.id);
                        form.setFieldsValue({
                          shortName: customer.shortName,
                          fullName: customer.fullName,
                          creditRating: customer.creditRating,
                          contact: customer.contact,
                          phone: customer.phone,
                          parentCompany: customer.parentCompany,
                          customerType: customer.customerType
                        });
                        setEditModalVisible(true);
                      }
                    }
                  }}>编辑</Button>
                  <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                    if (selectedRowKeys.length > 0) {
                      Modal.confirm({
                        title: '确认删除',
                        content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
                        onOk: () => {
                          setCustomers(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
                          setSelectedRowKeys([]);
                          message.success('删除成功');
                        }
                      });
                    }
                  }}>删除</Button>
                  <Button icon={renderIcon('PoweroffOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                    if (selectedRowKeys.length > 0) {
                      const selectedCustomers = customers.filter(item => selectedRowKeys.includes(item.id));
                      const hasDisabled = selectedCustomers.some(c => c.status === 'disabled');
                      const action = hasDisabled ? '启用' : '禁用';
                      
                      Modal.confirm({
                        title: `确认${action}`,
                        content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
                        onOk: () => {
                          const newStatus = hasDisabled ? 'enabled' : 'disabled';
                          setCustomers(prev => prev.map(item => {
                            if (selectedRowKeys.includes(item.id)) {
                              return { ...item, status: newStatus };
                            }
                            return item;
                          }));
                          message.success(`${action}成功`);
                        }
                      });
                    }
                  }}>禁用/启用</Button>
                  <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const customer = customers.find(item => item.id === selectedRowKeys[0]);
                      if (customer) {
                        setCurrentCustomerId(customer.id);
                        remarkForm.setFieldsValue({ remark: customer.remark || '' });
                        setRemarkModalVisible(true);
                      }
                    }
                  }}>备注</Button>
                  <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
                </Space>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                  style={{ marginLeft: 'auto' }}
                >
                  自定义列
                </Button>
              </div>
              <div className="erp-table-wrapper">
                <Table
                  rowSelection={{ 
                    type: 'radio',
                    selectedRowKeys, 
                    onChange: setSelectedRowKeys 
                  }}
                  columns={tableColumns}
                  dataSource={filteredData}
                  rowKey="id"
                  scroll={{ x: 'max-content' }}
                  pagination={createPaginationConfig()}
                />
              </div>
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑客商" : "新增客商"}
            open={editModalVisible}
            onCancel={() => {
              setEditModalVisible(false);
              form.resetFields();
            }}
            onOk={() => {
              form.validateFields().then(values => {
                if (isEditMode && currentCustomerId) {
                  // 编辑模式
                  setCustomers(prev => prev.map(item => {
                    if (item.id === currentCustomerId) {
                      return {
                        ...item,
                        ...values
                      };
                    }
                    return item;
                  }));
                  message.success('保存成功');
                } else {
                  // 新增模式
                  const newId = Math.max(...customers.map(c => c.id), 0) + 1;
                  const newCustomer = {
                    id: newId,
                    ...values,
                    status: 'enabled',
                    remark: '',
                    creator: '当前用户',
                    createTime: dayjs().format('YYYY-MM-DD HH:mm')
                  };
                  setCustomers(prev => [...prev, newCustomer]);
                  message.success('新增成功');
                }
                setEditModalVisible(false);
                form.resetFields();
              }).catch(err => {
                console.error('表单验证失败:', err);
              });
            }}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="简称" name="shortName" rules={[{ required: true, message: '请输入简称' }]}>
                <Input placeholder="请输入简称" />
              </Form.Item>
              <Form.Item label="全称" name="fullName" rules={[{ required: true, message: '请输入全称' }]}>
                <Input placeholder="请输入全称" />
              </Form.Item>
              <Form.Item label="信用评级" name="creditRating">
                <Input placeholder="请输入信用评级" />
              </Form.Item>
              <Form.Item label="联系人" name="contact">
                <Input placeholder="请输入联系人" />
              </Form.Item>
              <Form.Item label="手机号" name="phone">
                <Input placeholder="请输入手机号" />
              </Form.Item>
              <Form.Item label="关联母公司" name="parentCompany">
                <Input placeholder="请输入关联母公司" />
              </Form.Item>
              <Form.Item label="客商类型" name="customerType">
                <Select placeholder="请选择客商类型">
                  <Select.Option value="供应商">供应商</Select.Option>
                  <Select.Option value="客户">客户</Select.Option>
                  <Select.Option value="仓库">仓库</Select.Option>
                  <Select.Option value="物流">物流</Select.Option>
                  <Select.Option value="撮合商">撮合商</Select.Option>
                  <Select.Option value="客商">客商</Select.Option>
                </Select>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setCustomers(prev => prev.map(item => {
                  if (item.id === currentCustomerId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allColumnDefinitions}
              visibleColumns={visibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 保值方案管理页面
    const HedgePlanManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ name: '', type: '', instructionType: '', trader: '' });
      const [hedgePlans, setHedgePlans] = useState(mockHedgePlans);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [tagManageModalVisible, setTagManageModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentHedgePlanId, setCurrentHedgePlanId] = useState(null);
      const [form] = Form.useForm();
      const [tagForm] = Form.useForm();
      const [remarkForm] = Form.useForm();
      const [availableTags, setAvailableTags] = useState(() => getTags());
      const [selectedHedgePlanType, setSelectedHedgePlanType] = useState(null);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '名称', dataIndex: 'name', width: 200 },
        { key: 'type', title: '类型', dataIndex: 'type', width: 120 },
        { key: 'instructionTypes', title: '指令类型列表', dataIndex: 'instructionTypes', width: 250, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员列表', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'makers', title: '制单员列表', dataIndex: 'makers', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'tags', title: '标签列表', dataIndex: 'tags', width: 250, render: (arr) => {
          if (!arr || arr.length === 0) return '-';
          return (
            <Space wrap>
              {arr.map((tag, index) => (
                <Tag key={index} color="blue">{tag}</Tag>
              ))}
            </Space>
          );
        }},
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: hedgeVisibleColumns
      } = useColumnManager('hedge-plan', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleAdd = () => {
        form.resetFields();
        setSelectedHedgePlanType(null);
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockHedgePlans.find(hp => hp.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue({
            id: record.id,
            name: record.name,
            type: record.type,
            instructionTypes: record.instructionTypes,
            traders: record.traders?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            makers: record.makers?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            tags: record.tags || [],
            remark: record.remark || ''
          });
          setSelectedHedgePlanType(record.type);
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id');
          
          // 检查重复名称（新增时）
          if (!editingId) {
            const exists = hedgePlans.some(hp => hp.name === values.name);
            if (exists) {
              message.error('已有重复名称的保值方案，不能增加');
              return;
            }
          }
          
          if (editingId) {
            // 编辑模式
            setHedgePlans(prev => prev.map(item => {
              if (item.id === editingId) {
                return {
                  ...item,
                  ...values,
                  traders: values.traders?.map(id => mockPersons.find(p => p.id === id)?.name).filter(Boolean) || [],
                  makers: values.makers?.map(id => mockPersons.find(p => p.id === id)?.name).filter(Boolean) || []
                };
              }
              return item;
            }));
          } else {
            // 新增模式
            const newId = Math.max(...hedgePlans.map(hp => hp.id), 0) + 1;
            const newPlan = {
              id: newId,
              ...values,
              traders: values.traders?.map(id => mockPersons.find(p => p.id === id)?.name).filter(Boolean) || [],
              makers: values.makers?.map(id => mockPersons.find(p => p.id === id)?.name).filter(Boolean) || [],
              remark: '',
              status: 'enabled'
            };
            setHedgePlans(prev => [...prev, newPlan]);
          }
          
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
          setSelectedHedgePlanType(null);
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        // 检查是否有合同在用
        const selectedPlans = hedgePlans.filter(hp => selectedRowKeys.includes(hp.id));
        const hasContracts = selectedPlans.some(plan => {
          return mockContracts.some(contract => contract.hedgePlan === plan.name);
        });
        
        if (hasContracts) {
          message.error('有合同在用的保值方案不能删除');
          return;
        }
        
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            setHedgePlans(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
            setSelectedRowKeys([]);
            message.success('删除成功');
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedPlans = hedgePlans.filter(hp => selectedRowKeys.includes(hp.id));
        const hasDisabled = selectedPlans.some(hp => hp.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            const newStatus = hasDisabled ? 'enabled' : 'disabled';
            setHedgePlans(prev => prev.map(item => {
              if (selectedRowKeys.includes(item.id)) {
                return { ...item, status: newStatus };
              }
              return item;
            }));
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      const handleTagManage = () => {
        tagForm.setFieldsValue({ tags: availableTags });
        setTagManageModalVisible(true);
      };

      const handleTagSave = () => {
        tagForm.validateFields().then(values => {
          const tags = values.tags || [];
          // 过滤空标签
          const validTags = tags.filter(tag => tag && tag.trim());
          setAvailableTags(validTags);
          saveTags(validTags);
          message.success('标签保存成功');
          setTagManageModalVisible(false);
        });
      };

      // 根据保值方案类型过滤指令类型
      const getAvailableInstructionTypes = (hedgePlanType) => {
        const allTypes = [
          { name: '期货交易指令', types: ['整体匹配', '单单匹配', '无合同（人员）', '无合同（客商）'] },
          { name: '合同创建指令', types: ['整体匹配', '单单匹配'] },
          { name: '一口价创建套保指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案移仓换月指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案净值套保指令', types: ['整体匹配'] },
          { name: '保值方案均价净值套保指令', types: ['整体匹配'] },
          { name: '非均价合同套保指令', types: ['单单匹配'] },
          { name: '均价合同套保指令', types: ['单单匹配'] },
          { name: '点价指令', types: ['单单匹配'] },
          { name: '非均价合同变更指令', types: ['单单匹配'] },
          { name: '均价合同变更指令', types: ['单单匹配'] },
          { name: '单单移仓换月', types: ['单单匹配'] }
        ];
        return allTypes.filter(it => it.types.includes(hedgePlanType)).map(it => it.name);
      };

      // 筛选数据
      const filteredData = useMemo(() => {
        return hedgePlans.filter(item => {
          if (filters.name && !item.name.includes(filters.name)) return false;
          if (filters.type && item.type !== filters.type) return false;
          if (filters.instructionType) {
            const matched = item.instructionTypes?.some(it => it.includes(filters.instructionType));
            if (!matched) return false;
          }
          if (filters.trader) {
            const matched = item.traders?.some(t => t.includes(filters.trader));
            if (!matched) return false;
          }
          return true;
        });
      }, [filters, hedgePlans]);

      // 获取所有唯一的类型
      const typeOptions = useMemo(() => {
        const types = [...new Set(hedgePlans.map(hp => hp.type).filter(Boolean))];
        return types.map(type => ({ label: type, value: type }));
      }, [hedgePlans]);

      // 获取所有唯一的指令类型
      const instructionTypeOptions = useMemo(() => {
        const allTypes = new Set();
        hedgePlans.forEach(hp => {
          hp.instructionTypes?.forEach(it => allTypes.add(it));
        });
        return Array.from(allTypes).map(type => ({ label: type, value: type }));
      }, [hedgePlans]);

      // 获取所有唯一的交易员（用于筛选）
      const traderFilterOptions = useMemo(() => {
        const allTraders = new Set();
        hedgePlans.forEach(hp => {
          hp.traders?.forEach(t => allTraders.add(t));
        });
        return Array.from(allTraders).map(trader => ({ label: trader, value: trader }));
      }, [hedgePlans]);

      // 获取交易员列表（用于表单选择）
      const traderFormOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取制单员列表
      const makerOptions = useMemo(() => {
        const makers = mockPersonRoles.find(pr => pr.roleName === '制单员');
        if (makers && makers.personIds) {
          return mockPersons.filter(p => makers.personIds.includes(p.id));
        }
        return [];
      }, []);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>名称：</label>
              <Input placeholder="名称" style={{ width: 200 }} value={filters.name} onChange={(e) => setFilters({...filters, name: e.target.value})} />
            </div>
            <div className="erp-filter-item">
              <label>类型：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 150 }} 
                value={filters.type || undefined}
                onChange={(v) => setFilters({...filters, type: v || ''})}
                allowClear
                options={typeOptions}
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 200 }} 
                value={filters.instructionType || undefined}
                onChange={(v) => setFilters({...filters, instructionType: v || ''})}
                allowClear
                showSearch
                options={instructionTypeOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
            <div className="erp-filter-item">
              <label>交易员：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 150 }} 
                value={filters.trader || undefined}
                onChange={(v) => setFilters({...filters, trader: v || ''})}
                allowClear
                showSearch
                options={traderFilterOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const plan = hedgePlans.find(item => item.id === selectedRowKeys[0]);
                  if (plan) {
                    setCurrentHedgePlanId(plan.id);
                    remarkForm.setFieldsValue({ remark: plan.remark || '' });
                    setRemarkModalVisible(true);
                  }
                }
              }}>备注</Button>
              <Button icon={renderIcon('BookOutlined')} onClick={handleTagManage}>管理标签</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="编辑保值方案"
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields(); 
              setSelectedHedgePlanType(null);
            }}
            width={700}
            onOk={handleSave}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="名称" name="name" required rules={[{ required: true, message: '请输入名称' }]}>
                <Input placeholder="请输入保值方案名称" />
              </Form.Item>
              <Form.Item label="类型" name="type" required rules={[{ required: true, message: '请选择类型' }]}>
                <Select 
                  placeholder="请选择保值方案类型"
                  onChange={(value) => {
                    setSelectedHedgePlanType(value);
                    // 当类型改变时，清空并重新设置指令类型选项
                    form.setFieldsValue({ instructionTypes: [] });
                  }}
                >
                  <Select.Option value="整体匹配">整体匹配</Select.Option>
                  <Select.Option value="单单匹配">单单匹配</Select.Option>
                  <Select.Option value="无合同（人员）">无合同（人员）</Select.Option>
                  <Select.Option value="无合同（客商）">无合同（客商）</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item 
                label="指令类型" 
                name="instructionTypes"
                rules={[
                  { type: 'array', min: 1, message: '至少选择一个指令类型' },
                  ({ getFieldValue }) => ({
                    validator(_, value) {
                      const type = getFieldValue('type') || selectedHedgePlanType;
                      if (!type || !value || value.length === 0) {
                        return Promise.resolve();
                      }
                      const availableTypes = getAvailableInstructionTypes(type);
                      const invalidTypes = value.filter(v => !availableTypes.includes(v));
                      if (invalidTypes.length > 0) {
                        return Promise.reject(new Error(`整体的保值方案中不能选单单类型的指令：${invalidTypes.join(', ')}`));
                      }
                      return Promise.resolve();
                    }
                  })
                ]}
              >
                <Select 
                  mode="multiple" 
                  placeholder={selectedHedgePlanType ? "选择指令类型" : "请先选择保值方案类型"}
                  disabled={!selectedHedgePlanType}
                  options={selectedHedgePlanType ? getAvailableInstructionTypes(selectedHedgePlanType).map(name => ({ label: name, value: name })) : []}
                />
              </Form.Item>
              <Form.Item label="交易员列表" name="traders">
                <Select 
                  mode="multiple" 
                  placeholder="选择交易员（可多选）"
                  options={traderFormOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="制单员列表" name="makers">
                <Select 
                  mode="multiple" 
                  placeholder="选择制单员（可多选）"
                  options={makerOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item 
                label="标签列表" 
                name="tags"
                tooltip="标签用于期现备注中的标签选项，每笔期货都应该有保值方案，期现备注中的标签选项来源于对应保值方案设置的标签"
              >
                <Select 
                  mode="tags" 
                  placeholder="选择或输入标签（可多选）"
                  options={availableTags.map(tag => ({ label: tag, value: tag }))}
                  tokenSeparators={[',']}
                  style={{ width: '100%' }}
                />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="管理标签"
            open={tagManageModalVisible}
            onCancel={() => { setTagManageModalVisible(false); tagForm.resetFields(); }}
            width={600}
            onOk={handleTagSave}
          >
            <Alert
              type="info"
              showIcon
              message="标签说明"
              description="标签是业务中的具体操作分类，保值方案是业务类型或流程。标签作为期现备注中的可选项，每笔期货都应该有保值方案，期现备注中的标签选项来源于对应保值方案设置的标签。"
              style={{ marginBottom: 16 }}
            />
            <Form form={tagForm} layout="vertical">
              <Form.Item 
                label="标签列表" 
                name="tags"
                rules={[{ required: true, message: '至少需要一个标签' }]}
              >
                <Form.List name="tags" initialValue={availableTags}>
                  {(fields, { add, remove }) => (
                    <Space direction="vertical" style={{ width: '100%' }}>
                      {fields.map((field, index) => (
                        <Space key={field.key} align="baseline" style={{ width: '100%' }}>
                          <Form.Item
                            {...field}
                            name={[field.name]}
                            fieldKey={[field.fieldKey]}
                            rules={[{ required: true, message: '请输入标签名称' }]}
                            style={{ flex: 1, marginBottom: 0 }}
                          >
                            <Input placeholder="请输入标签名称" />
                          </Form.Item>
                          {fields.length > 1 && (
                            <Button
                              type="text"
                              danger
                              icon={renderIcon('DeleteOutlined')}
                              onClick={() => remove(field.name)}
                            />
                          )}
                        </Space>
                      ))}
                      <Button
                        type="dashed"
                        onClick={() => add('')}
                        icon={renderIcon('PlusOutlined')}
                        block
                      >
                        新增标签
                      </Button>
                    </Space>
                  )}
                </Form.List>
              </Form.Item>
              <Form.Item>
                <Button 
                  type="link" 
                  onClick={() => {
                    tagForm.setFieldsValue({ tags: [...defaultTags] });
                    message.info('已恢复为缺省标签');
                  }}
                >
                  恢复缺省标签
                </Button>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setHedgePlans(prev => prev.map(item => {
                  if (item.id === currentHedgePlanId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={hedgeVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 保值额度管理子组件
    const HedgeLimitManagement = ({ accountId, accountName, hedgeLimits: initialLimits, onSave, onClose }) => {
      const [hedgeLimits, setHedgeLimits] = useState(initialLimits || []);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [isEditMode, setIsEditMode] = useState(false);
      const [currentLimitId, setCurrentLimitId] = useState(null);
      const [filters, setFilters] = useState({ contract: '', direction: '' });
      const [form] = Form.useForm();

      // 同步父组件传入的数据
      useEffect(() => {
        setHedgeLimits(initialLimits || []);
      }, [initialLimits]);

      // 筛选数据
      const filteredData = useMemo(() => {
        return hedgeLimits.filter(item => {
          if (filters.contract && !item.contract.includes(filters.contract)) return false;
          if (filters.direction && item.direction !== filters.direction) return false;
          return true;
        });
      }, [filters, hedgeLimits]);

      const handleAdd = () => {
        setIsEditMode(false);
        setCurrentLimitId(null);
        form.resetFields();
        setEditModalVisible(true);
      };

      const handleEdit = (record) => {
        setIsEditMode(true);
        setCurrentLimitId(record.id);
        form.setFieldsValue({
          contract: record.contract,
          direction: record.direction,
          limit: record.limit,
          remark: record.remark || ''
        });
        setEditModalVisible(true);
      };

      const handleDelete = (id) => {
        Modal.confirm({
          title: '确认删除',
          content: '确定要删除这条保值额度配置吗？',
          onOk: () => {
            const newLimits = hedgeLimits.filter(item => item.id !== id);
            setHedgeLimits(newLimits);
            onSave(newLimits);
            message.success('删除成功');
          }
        });
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          // 检查同一账户下，同一"期货合约 + 多空方向"组合是否唯一
          const existing = hedgeLimits.find(item => 
            item.contract === values.contract && 
            item.direction === values.direction &&
            item.id !== currentLimitId
          );
          if (existing) {
            message.error('该期货合约和方向的保值额度配置已存在，请勿重复添加');
            return;
          }

          if (isEditMode && currentLimitId) {
            // 编辑模式
            const newLimits = hedgeLimits.map(item => {
              if (item.id === currentLimitId) {
                return {
                  ...item,
                  ...values
                };
              }
              return item;
            });
            setHedgeLimits(newLimits);
            onSave(newLimits);
            message.success('保存成功');
          } else {
            // 新增模式
            const newId = hedgeLimits.length > 0 ? Math.max(...hedgeLimits.map(l => l.id), 0) + 1 : 1;
            const newLimit = {
              id: newId,
              ...values
            };
            const newLimits = [...hedgeLimits, newLimit];
            setHedgeLimits(newLimits);
            onSave(newLimits);
            message.success('新增成功');
          }
          setEditModalVisible(false);
          form.resetFields();
        }).catch(err => {
          console.error('表单验证失败:', err);
        });
      };

      const columns = [
        {
          title: '期货合约代码',
          dataIndex: 'contract',
          key: 'contract',
          width: 150
        },
        {
          title: '多空方向',
          dataIndex: 'direction',
          key: 'direction',
          width: 120,
          render: (direction) => (
            <span className={`erp-status-badge ${direction === '多头' ? 'enabled' : 'disabled'}`}>
              {direction}
            </span>
          )
        },
        {
          title: '保值持仓额度（手）',
          dataIndex: 'limit',
          key: 'limit',
          width: 150,
          align: 'right',
          render: (limit) => limit?.toLocaleString() || '-'
        },
        {
          title: '备注',
          dataIndex: 'remark',
          key: 'remark',
          ellipsis: true,
          render: (text) => text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        },
        {
          title: '操作',
          key: 'action',
          width: 150,
          fixed: 'right',
          render: (_, record) => (
            <Space>
              <Button type="link" size="small" onClick={() => handleEdit(record)}>编辑</Button>
              <Button type="link" size="small" danger onClick={() => handleDelete(record.id)}>删除</Button>
            </Space>
          )
        }
      ];

      return (
        <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
          <div className="erp-filter-bar" style={{ marginBottom: 16, flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>合约代码：</label>
              <Input 
                placeholder="合约代码" 
                style={{ width: 150 }} 
                value={filters.contract} 
                onChange={(e) => setFilters({...filters, contract: e.target.value})} 
              />
            </div>
            <div className="erp-filter-item">
              <label>多空方向：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 120 }} 
                value={filters.direction || undefined}
                onChange={(v) => setFilters({...filters, direction: v || ''})}
                allowClear
              >
                <Select.Option value="多头">多头</Select.Option>
                <Select.Option value="空头">空头</Select.Option>
              </Select>
            </div>
          </div>
          <div className="erp-toolbar" style={{ marginBottom: 16, flexShrink: 0 }}>
            <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>新增</Button>
          </div>
          <div style={{ flex: 1, minHeight: 0 }}>
            <Table
              columns={columns}
              dataSource={filteredData}
              rowKey="id"
              scroll={{ x: 'max-content', y: 400 }}
              pagination={false}
              size="small"
            />
          </div>
          <div style={{ marginTop: 16, textAlign: 'right', flexShrink: 0, borderTop: '1px solid #f0f0f0', paddingTop: 16 }}>
            <Space>
              <Button onClick={onClose}>关闭</Button>
            </Space>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑保值额度" : "新增保值额度"}
            open={editModalVisible}
            onCancel={() => {
              setEditModalVisible(false);
              form.resetFields();
            }}
            onOk={handleSave}
            width={600}
          >
            <Form form={form} layout="vertical">
              <Form.Item 
                label="期货合约代码" 
                name="contract" 
                rules={[{ required: true, message: '请输入期货合约代码' }]}
              >
                <Input placeholder="请输入期货合约代码，如：CU2401" />
              </Form.Item>
              <Form.Item 
                label="多空方向" 
                name="direction" 
                rules={[{ required: true, message: '请选择多空方向' }]}
              >
                <Select placeholder="请选择多空方向">
                  <Select.Option value="多头">多头</Select.Option>
                  <Select.Option value="空头">空头</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item 
                label="保值持仓额度（手）" 
                name="limit" 
                rules={[
                  { required: true, message: '请输入保值持仓额度' },
                  { type: 'number', min: 0.01, message: '保值持仓额度必须大于0' }
                ]}
              >
                <InputNumber 
                  style={{ width: '100%' }} 
                  placeholder="请输入保值持仓额度" 
                  min={0.01}
                  precision={0}
                />
              </Form.Item>
              <Form.Item label="备注" name="remark">
                <Input.TextArea rows={3} placeholder="请输入备注（可选）" />
              </Form.Item>
            </Form>
          </Modal>
        </div>
      );
    };

    // 期货账户管理页面
    const FuturesAccountManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ account: '', status: '', trader: '' });
      const [futuresAccounts, setFuturesAccounts] = useState(mockFuturesAccounts);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [traderModalVisible, setTraderModalVisible] = useState(false);
      const [riskModalVisible, setRiskModalVisible] = useState(false);
      const [hedgeLimitModalVisible, setHedgeLimitModalVisible] = useState(false);
      const [currentAccountId, setCurrentAccountId] = useState(null);
      const [isEditMode, setIsEditMode] = useState(false);
      const [hedgeLimitEditMode, setHedgeLimitEditMode] = useState(false);
      const [currentHedgeLimitId, setCurrentHedgeLimitId] = useState(null);
      const [form] = Form.useForm();
      const [remarkForm] = Form.useForm();
      const [traderForm] = Form.useForm();
      const [riskForm] = Form.useForm();
      const [hedgeLimitForm] = Form.useForm();
      
      // 保值额度数据：按账户ID存储
      const [hedgeLimits, setHedgeLimits] = useState({});

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'account', title: '期货账户', dataIndex: 'account', width: 150 },
        { key: 'alias', title: '账户别名', dataIndex: 'alias', width: 150, render: (text) => text || '-' },
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 200, render: (arr) => arr?.join(', ') || '-' },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: futuresVisibleColumns
      } = useColumnManager('futures-account', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取交易员列表（用于表单选择）
      const traderFormOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取所有唯一的交易员（用于筛选）
      const traderFilterOptions = useMemo(() => {
        const allTraders = new Set();
        futuresAccounts.forEach(acc => {
          acc.traders?.forEach(t => allTraders.add(t));
        });
        return Array.from(allTraders).map(trader => ({ label: trader, value: trader }));
      }, [futuresAccounts]);

      // 筛选数据
      const filteredData = useMemo(() => {
        return futuresAccounts.filter(item => {
          if (filters.account && !item.account.includes(filters.account)) return false;
          if (filters.status && item.status !== filters.status) return false;
          if (filters.trader) {
            const matched = item.traders?.some(t => t.includes(filters.trader));
            if (!matched) return false;
          }
          return true;
        });
      }, [filters, futuresAccounts]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>账户：</label>
              <Input placeholder="账户" style={{ width: 150 }} value={filters.account} onChange={(e) => setFilters({...filters, account: e.target.value})} />
            </div>
            <div className="erp-filter-item">
              <label>状态：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 120 }} 
                value={filters.status || undefined}
                onChange={(v) => setFilters({...filters, status: v || ''})}
                allowClear
              >
                <Select.Option value="enabled">启用</Select.Option>
                <Select.Option value="disabled">禁用</Select.Option>
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>交易员：</label>
              <Select 
                placeholder="全部" 
                style={{ width: 150 }} 
                value={filters.trader || undefined}
                onChange={(v) => setFilters({...filters, trader: v || ''})}
                allowClear
                showSearch
                options={traderFilterOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={() => {
                setIsEditMode(false);
                setCurrentAccountId(null);
                form.resetFields();
                setEditModalVisible(true);
              }}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const account = futuresAccounts.find(item => item.id === selectedRowKeys[0]);
                  if (account) {
                    setIsEditMode(true);
                    setCurrentAccountId(account.id);
                    form.setFieldsValue({
                      account: account.account,
                      alias: account.alias || '',
                      password: account.password || '',
                      company: account.company || '',
                      frontend: account.frontend || ''
                    });
                    setEditModalVisible(true);
                  }
                }
              }}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                if (selectedRowKeys.length > 0) {
                  Modal.confirm({
                    title: '确认删除',
                    content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
                    onOk: () => {
                      setFuturesAccounts(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
                      setSelectedRowKeys([]);
                      message.success('删除成功');
                    }
                  });
                }
              }}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} disabled={selectedRowKeys.length === 0} onClick={() => {
                if (selectedRowKeys.length > 0) {
                  const selectedAccounts = futuresAccounts.filter(item => selectedRowKeys.includes(item.id));
                  const hasDisabled = selectedAccounts.some(acc => acc.status === 'disabled');
                  const action = hasDisabled ? '启用' : '禁用';
                  
                  Modal.confirm({
                    title: `确认${action}`,
                    content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
                    onOk: () => {
                      const newStatus = hasDisabled ? 'enabled' : 'disabled';
                      setFuturesAccounts(prev => prev.map(item => {
                        if (selectedRowKeys.includes(item.id)) {
                          return { ...item, status: newStatus };
                        }
                        return item;
                      }));
                      message.success(`${action}成功`);
                    }
                  });
                }
              }}>禁用/启用</Button>
              <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const account = futuresAccounts.find(item => item.id === selectedRowKeys[0]);
                  if (account) {
                    setCurrentAccountId(account.id);
                    remarkForm.setFieldsValue({ remark: account.remark || '' });
                    setRemarkModalVisible(true);
                  }
                }
              }}>备注</Button>
              <Button icon={renderIcon('UserOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const account = futuresAccounts.find(item => item.id === selectedRowKeys[0]);
                  if (account) {
                    setCurrentAccountId(account.id);
                    traderForm.setFieldsValue({
                      traders: account.traders?.map(name => {
                        const person = mockPersons.find(p => p.name === name);
                        return person?.id;
                      }).filter(Boolean) || []
                    });
                    setTraderModalVisible(true);
                  }
                }
              }}>绑定交易员</Button>
              <Button icon={renderIcon('SafetyOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const account = futuresAccounts.find(item => item.id === selectedRowKeys[0]);
                  if (account) {
                    setCurrentAccountId(account.id);
                    riskForm.resetFields();
                    setRiskModalVisible(true);
                  }
                }
              }}>风控限制</Button>
              <Button icon={renderIcon('BarChartOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const account = futuresAccounts.find(item => item.id === selectedRowKeys[0]);
                  if (account) {
                    setCurrentAccountId(account.id);
                    setHedgeLimitModalVisible(true);
                  }
                }
              }}>保值额度</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑期货账户" : "新增期货账户"}
            open={editModalVisible}
            onCancel={() => {
              setEditModalVisible(false);
              form.resetFields();
            }}
            onOk={() => {
              form.validateFields().then(values => {
                if (isEditMode && currentAccountId) {
                  // 编辑模式
                  setFuturesAccounts(prev => prev.map(item => {
                    if (item.id === currentAccountId) {
                      return {
                        ...item,
                        ...values
                      };
                    }
                    return item;
                  }));
                  message.success('保存成功');
                } else {
                  // 新增模式
                  const newId = Math.max(...futuresAccounts.map(acc => acc.id), 0) + 1;
                  const newAccount = {
                    id: newId,
                    ...values,
                    status: 'enabled',
                    traders: [],
                    remark: ''
                  };
                  setFuturesAccounts(prev => [...prev, newAccount]);
                  message.success('新增成功');
                }
                setEditModalVisible(false);
                form.resetFields();
              }).catch(err => {
                console.error('表单验证失败:', err);
              });
            }}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="期货账户" name="account" rules={[{ required: true, message: '请输入期货账户' }]}>
                <Input placeholder="请输入期货账户" />
              </Form.Item>
              <Form.Item label="账户别名" name="alias">
                <Input placeholder="请输入账户别名（可选，用于在交易端显示更易识别的名称）" />
              </Form.Item>
              <Form.Item label="密码" name="password">
                <Input.Password placeholder="请输入密码" />
              </Form.Item>
              <Form.Item label="期货公司" name="company">
                <Input placeholder="请输入期货公司" />
              </Form.Item>
              <Form.Item label="前置" name="frontend">
                <Input placeholder="请输入前置" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setFuturesAccounts(prev => prev.map(item => {
                  if (item.id === currentAccountId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="绑定交易员"
            open={traderModalVisible}
            onCancel={() => {
              setTraderModalVisible(false);
              traderForm.resetFields();
            }}
            onOk={() => {
              traderForm.validateFields().then(values => {
                const traderNames = (values.traders || []).map(id => {
                  const person = mockPersons.find(p => p.id === id);
                  return person?.name;
                }).filter(Boolean);
                
                setFuturesAccounts(prev => prev.map(item => {
                  if (item.id === currentAccountId) {
                    return { ...item, traders: traderNames };
                  }
                  return item;
                }));
                message.success('交易员绑定成功');
                setTraderModalVisible(false);
                traderForm.resetFields();
              });
            }}
          >
            <Form form={traderForm} layout="vertical">
              <Form.Item 
                label="交易员" 
                name="traders"
                rules={[{ type: 'array', min: 1, message: '至少选择一个交易员' }]}
              >
                <Select 
                  mode="multiple" 
                  placeholder="请选择交易员（可多选）"
                  options={traderFormOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="风控限制"
            open={riskModalVisible}
            onCancel={() => {
              setRiskModalVisible(false);
              riskForm.resetFields();
            }}
            onOk={() => {
              riskForm.validateFields().then(values => {
                message.success('风控限制设置成功');
                setRiskModalVisible(false);
                riskForm.resetFields();
              });
            }}
            width={600}
          >
            <Form form={riskForm} layout="vertical">
              <Form.Item label="单笔最大持仓" name="maxPosition">
                <InputNumber style={{ width: '100%' }} placeholder="请输入单笔最大持仓" min={0} />
              </Form.Item>
              <Form.Item label="单日最大持仓" name="maxDailyPosition">
                <InputNumber style={{ width: '100%' }} placeholder="请输入单日最大持仓" min={0} />
              </Form.Item>
              <Form.Item label="单日最大亏损" name="maxDailyLoss">
                <InputNumber style={{ width: '100%' }} placeholder="请输入单日最大亏损" min={0} />
              </Form.Item>
              <Form.Item label="备注" name="riskRemark">
                <Input.TextArea rows={3} placeholder="请输入风控限制备注" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title={`保值额度管理 - ${(() => {
              const acc = futuresAccounts.find(a => a.id === currentAccountId);
              return acc?.alias || acc?.account || '';
            })()}`}
            open={hedgeLimitModalVisible}
            onCancel={() => {
              setHedgeLimitModalVisible(false);
              setHedgeLimitEditMode(false);
              setCurrentHedgeLimitId(null);
              hedgeLimitForm.resetFields();
            }}
            width={900}
            footer={null}
          >
            <HedgeLimitManagement
              accountId={currentAccountId}
              accountName={(() => {
                const acc = futuresAccounts.find(a => a.id === currentAccountId);
                return acc?.alias || acc?.account || '';
              })()}
              hedgeLimits={hedgeLimits[currentAccountId] || []}
              onSave={(limits) => {
                setHedgeLimits(prev => ({
                  ...prev,
                  [currentAccountId]: limits
                }));
                message.success('保值额度保存成功');
              }}
              onClose={() => {
                setHedgeLimitModalVisible(false);
                setHedgeLimitEditMode(false);
                setCurrentHedgeLimitId(null);
                hedgeLimitForm.resetFields();
              }}
            />
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={futuresVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 人员管理页面
    const PersonManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ name: '', phone: '' });
      const [persons, setPersons] = useState(mockPersons);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentPersonId, setCurrentPersonId] = useState(null);
      const [isEditMode, setIsEditMode] = useState(false);
      const [form] = Form.useForm();
      const [remarkForm] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'name', title: '姓名', dataIndex: 'name', width: 150 },
        { key: 'role', title: '角色', dataIndex: 'role', width: 150 },
        { key: 'phone', title: '手机号', dataIndex: 'phone', width: 150 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: personVisibleColumns
      } = useColumnManager('person', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 从数据中提取唯一的姓名和手机号列表
      const nameOptions = useMemo(() => {
        const uniqueNames = [...new Set(persons.map(item => item.name).filter(Boolean))];
        return uniqueNames.map(name => ({ label: name, value: name }));
      }, [persons]);

      const phoneOptions = useMemo(() => {
        const uniquePhones = [...new Set(persons.map(item => item.phone).filter(Boolean))];
        return uniquePhones.map(phone => ({ label: phone, value: phone }));
      }, [persons]);

      const filteredData = useMemo(() => {
        return persons.map(person => {
          // 从人员角色关系中获取角色（每个角色一行，每个角色包含多个人员）
          const roles = mockPersonRoles
            .filter(pr => pr.personIds?.includes(person.id) && pr.status === 'enabled')
            .map(pr => pr.roleName);
          return {
            ...person,
            role: roles.join(', ') || '-'
          };
        }).filter(item => {
          if (filters.name && !item.name.includes(filters.name)) return false;
          if (filters.phone && !item.phone.includes(filters.phone)) return false;
          return true;
        });
      }, [filters, persons]);

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的人员');
          return;
        }
        // 检查是否有保值方案绑定或角色绑定
        const selectedPersons = persons.filter(p => selectedRowKeys.includes(p.id));
        const hasHedgePlan = selectedPersons.some(p => {
          return mockHedgePlans.some(hp => 
            hp.traders?.includes(p.name) || hp.makers?.includes(p.name)
          );
        });
        const hasRole = selectedPersons.some(p => {
          return mockPersonRoles.some(pr => pr.personIds?.includes(p.id) && pr.status === 'enabled');
        });
        
        if (hasHedgePlan) {
          message.error('有保值方案绑定的人员不能删除');
          return;
        }
        if (hasRole) {
          message.error('有角色绑定的人员不能删除');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 个人员吗？`,
          onOk: () => {
            setPersons(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
            setSelectedRowKeys([]);
            message.success('删除成功');
          }
        });
      };

      const handleAdd = () => {
        setIsEditMode(false);
        setCurrentPersonId(null);
        form.resetFields();
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一个人员进行编辑');
          return;
        }
        const person = persons.find(p => p.id === selectedRowKeys[0]);
        if (person) {
          setIsEditMode(true);
          setCurrentPersonId(person.id);
          form.setFieldsValue({
            name: person.name,
            phone: person.phone
          });
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id') || currentPersonId;
          
          // 检查重复姓名（新增时）
          if (!editingId) {
            const exists = persons.some(p => p.name === values.name);
            if (exists) {
              message.error('已有重复姓名的人员，不能增加');
              return;
            }
          }
          
          if (editingId) {
            // 编辑模式
            setPersons(prev => prev.map(item => {
              if (item.id === editingId) {
                return {
                  ...item,
                  ...values
                };
              }
              return item;
            }));
            message.success('保存成功');
          } else {
            // 新增模式
            const newId = Math.max(...persons.map(p => p.id), 0) + 1;
            const newPerson = {
              id: newId,
              ...values,
              status: 'enabled',
              remark: ''
            };
            setPersons(prev => [...prev, newPerson]);
            message.success('新增成功');
          }
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的人员');
          return;
        }
        const selectedPersons = persons.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedPersons.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 个人员吗？`,
          onOk: () => {
            const newStatus = hasDisabled ? 'enabled' : 'disabled';
            setPersons(prev => prev.map(item => {
              if (selectedRowKeys.includes(item.id)) {
                return { ...item, status: newStatus };
              }
              return item;
            }));
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>姓名：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择姓名"
                style={{ width: 200 }}
                value={filters.name || undefined}
                onChange={(value) => setFilters({...filters, name: value || ''})}
                options={nameOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
            <div className="erp-filter-item">
              <label>手机号：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择手机号"
                style={{ width: 200 }}
                value={filters.phone || undefined}
                onChange={(value) => setFilters({...filters, phone: value || ''})}
                options={phoneOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const person = persons.find(item => item.id === selectedRowKeys[0]);
                  if (person) {
                    setCurrentPersonId(person.id);
                    remarkForm.setFieldsValue({ remark: person.remark || '' });
                    setRemarkModalVisible(true);
                  }
                }
              }}>备注</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑人员" : "新增人员"}
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields();
            }}
            onOk={handleSave}
            width={500}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="姓名" name="name" rules={[{ required: true, message: '请输入姓名' }]}>
                <Input placeholder="请输入姓名" />
              </Form.Item>
              <Form.Item label="手机号" name="phone" rules={[{ required: true, message: '请输入手机号' }, { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号' }]}>
                <Input placeholder="请输入手机号" />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setPersons(prev => prev.map(item => {
                  if (item.id === currentPersonId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={personVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 人员角色管理页面
    const PersonRoleManagement = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ role: '', name: '' });
      const [personRoles, setPersonRoles] = useState(mockPersonRoles);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentRoleId, setCurrentRoleId] = useState(null);
      const [isEditMode, setIsEditMode] = useState(false);
      const [form] = Form.useForm();
      const [remarkForm] = Form.useForm();

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'roleName', title: '角色', dataIndex: 'roleName', width: 150 },
        { 
          key: 'personNames', 
          title: '姓名', 
          dataIndex: 'personNames', 
          width: 300,
          render: (value, record) => {
            // 从 record 中获取 personNames，优先使用 value（dataIndex 对应的值）
            const personNames = value || record?.personNames || [];
            if (!Array.isArray(personNames) || personNames.length === 0) {
              return <span style={{ color: '#999' }}>-</span>;
            }
            return (
              <div style={{ lineHeight: '1.8', whiteSpace: 'normal' }}>
                {personNames.map((name, index) => (
                  <div key={index} style={{ marginBottom: index < personNames.length - 1 ? '4px' : '0' }}>
                    {name}
                  </div>
                ))}
              </div>
            );
          }
        },
        { key: 'description', title: '角色解释', dataIndex: 'description', width: 250 },
        { 
          key: 'instructionTypes', 
          title: '指令类型绑定', 
          dataIndex: 'instructionTypeIds', 
          width: 300,
          render: (instructionTypeIds, record) => {
            if (!instructionTypeIds || instructionTypeIds.length === 0) {
              return <span style={{ color: '#999' }}>-</span>;
            }
            const instructionTypeNames = instructionTypeIds.map(id => {
              const type = mockInstructionTypes.find(it => it.id === id);
              return type?.name || '';
            }).filter(Boolean);
            if (instructionTypeNames.length === 0) {
              return <span style={{ color: '#999' }}>-</span>;
            }
            return (
              <div style={{ lineHeight: '1.8', whiteSpace: 'normal' }}>
                {instructionTypeNames.map((name, index) => (
                  <Tag key={index} style={{ marginBottom: '4px' }}>{name}</Tag>
                ))}
              </div>
            );
          }
        },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )},
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: personRoleVisibleColumns
      } = useColumnManager('person-role', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 从数据中提取唯一的角色列表
      const roleOptions = useMemo(() => {
        return mockRoles.map(role => ({ label: role.name, value: role.name }));
      }, []);

      // 从所有人员角色关系中提取所有人员姓名（用于筛选）
      const allPersonNames = useMemo(() => {
        const names = new Set();
        mockPersonRoles.forEach(pr => {
          if (pr.personNames) {
            pr.personNames.forEach(name => names.add(name));
          }
        });
        return Array.from(names).map(name => ({ label: name, value: name }));
      }, []);

      const filteredData = useMemo(() => {
        return personRoles.filter(item => {
          if (filters.role && !item.roleName.includes(filters.role)) return false;
          if (filters.name && item.personNames && !item.personNames.some(name => name.includes(filters.name))) return false;
          return true;
        });
      }, [filters, personRoles]);

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的角色');
          return;
        }
        // 检查是否已绑定期货账户的交易员
        const selectedRoles = personRoles.filter(pr => selectedRowKeys.includes(pr.id));
        const hasFuturesAccount = selectedRoles.some(pr => {
          if (pr.roleName === '交易员' && pr.personNames) {
            return pr.personNames.some(personName => {
              return mockFuturesAccounts.some(fa => fa.traders?.includes(personName));
            });
          }
          return false;
        });
        
        if (hasFuturesAccount) {
          message.error('已绑定期货账户的交易员不能解除人员与角色关系');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 个角色配置吗？`,
          onOk: () => {
            setPersonRoles(prev => prev.filter(item => !selectedRowKeys.includes(item.id)));
            setSelectedRowKeys([]);
            message.success('删除成功');
          }
        });
      };

      const handleAdd = () => {
        setIsEditMode(false);
        setCurrentRoleId(null);
        form.resetFields();
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一个角色进行编辑');
          return;
        }
        const role = personRoles.find(pr => pr.id === selectedRowKeys[0]);
        if (role) {
          setIsEditMode(true);
          setCurrentRoleId(role.id);
          form.setFieldsValue({
            id: role.id,
            roleId: role.roleId,
            personIds: role.personIds || [],
            instructionTypeIds: role.instructionTypeIds || []
          });
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id') || currentRoleId;
          
          // 检查一类角色只能增加一行（新增时）
          if (!editingId) {
            // 新增：检查该角色是否已存在
            const existingRole = personRoles.find(pr => pr.roleId === values.roleId);
            if (existingRole) {
              message.error('一类角色只能增加一行');
              return;
            }
          } else {
            // 编辑：检查是否修改了角色，如果修改了角色，检查新角色是否已存在
            const currentRole = personRoles.find(pr => pr.id === editingId);
            if (currentRole && currentRole.roleId !== values.roleId) {
              const existingRole = personRoles.find(pr => pr.roleId === values.roleId);
              if (existingRole) {
                message.error('一类角色只能增加一行，不能修改为已存在的角色');
                return;
              }
            }
          }
          
          if (editingId) {
            // 编辑模式
            const selectedRole = mockRoles.find(r => r.id === values.roleId);
            const personNames = (values.personIds || []).map(id => {
              const person = mockPersons.find(p => p.id === id);
              return person?.name;
            }).filter(Boolean);
            
            setPersonRoles(prev => prev.map(item => {
              if (item.id === editingId) {
                return {
                  ...item,
                  roleId: values.roleId,
                  roleName: selectedRole?.name || item.roleName,
                  personIds: values.personIds || [],
                  personNames: personNames,
                  instructionTypeIds: values.instructionTypeIds || []
                };
              }
              return item;
            }));
            message.success('保存成功');
          } else {
            // 新增模式
            const selectedRole = mockRoles.find(r => r.id === values.roleId);
            const personNames = (values.personIds || []).map(id => {
              const person = mockPersons.find(p => p.id === id);
              return person?.name;
            }).filter(Boolean);
            
            const newId = Math.max(...personRoles.map(pr => pr.id), 0) + 1;
            const newRole = {
              id: newId,
              roleId: values.roleId,
              roleName: selectedRole?.name || '',
              personIds: values.personIds || [],
              personNames: personNames,
              description: selectedRole?.description || '',
              status: 'enabled',
              remark: '',
              instructionTypeIds: values.instructionTypeIds || []
            };
            setPersonRoles(prev => [...prev, newRole]);
            message.success('新增成功');
          }
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的角色');
          return;
        }
        const selectedRoles = personRoles.filter(pr => selectedRowKeys.includes(pr.id));
        const hasDisabled = selectedRoles.some(pr => pr.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 个角色配置吗？`,
          onOk: () => {
            const newStatus = hasDisabled ? 'enabled' : 'disabled';
            setPersonRoles(prev => prev.map(item => {
              if (selectedRowKeys.includes(item.id)) {
                return { ...item, status: newStatus };
              }
              return item;
            }));
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>角色：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择角色"
                style={{ width: 200 }}
                value={filters.role || undefined}
                onChange={(value) => setFilters({...filters, role: value || ''})}
                options={roleOptions}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
            <div className="erp-filter-item">
              <label>姓名：</label>
              <Select
                showSearch
                allowClear
                placeholder="请输入或选择姓名"
                style={{ width: 200 }}
                value={filters.name || undefined}
                onChange={(value) => setFilters({...filters, name: value || ''})}
                options={allPersonNames}
                filterOption={(input, option) =>
                  (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                }
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                if (selectedRowKeys.length === 1) {
                  const role = personRoles.find(item => item.id === selectedRowKeys[0]);
                  if (role) {
                    setCurrentRoleId(role.id);
                    remarkForm.setFieldsValue({ remark: role.remark || '' });
                    setRemarkModalVisible(true);
                  }
                }
              }}>备注</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title={isEditMode ? "编辑人员与角色关系" : "新增人员与角色关系"}
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields();
            }}
            onOk={handleSave}
            width={500}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="角色" name="roleId" rules={[{ required: true, message: '请选择角色' }]}>
                <Select 
                  placeholder="请选择角色"
                  disabled={isEditMode && !!currentRoleId} // 编辑时禁用角色选择
                >
                  {mockRoles.map(role => (
                    <Select.Option key={role.id} value={role.id}>{role.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="人员" name="personIds" rules={[{ required: true, message: '请选择人员' }, { type: 'array', min: 1, message: '至少选择一个人员' }]}>
                <Select 
                  mode="multiple"
                  placeholder="请选择人员（可多选）"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.children ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                >
                  {mockPersons.map(person => (
                    <Select.Option key={person.id} value={person.id}>{person.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item 
                label="指令类型绑定" 
                name="instructionTypeIds" 
                rules={[
                  { required: true, message: '请选择指令类型' }, 
                  { type: 'array', min: 1, message: '至少选择一个指令类型' }
                ]}
                extra="为角色配置可用的指令类型，作为指令权限分配时的约束条件"
              >
                <Select 
                  mode="multiple"
                  placeholder="请选择指令类型（可多选）"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.children ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                >
                  {mockInstructionTypes.map(instructionType => (
                    <Select.Option key={instructionType.id} value={instructionType.id}>
                      {instructionType.name}
                    </Select.Option>
                  ))}
                </Select>
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                setPersonRoles(prev => prev.map(item => {
                  if (item.id === currentRoleId) {
                    return { ...item, remark: values.remark || '' };
                  }
                  return item;
                }));
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={personRoleVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 自定义字段配置页面
    const CustomFieldManagement = () => {
      const [selectedEntityType, setSelectedEntityType] = useState('customer');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ fieldName: '', fieldType: '', isRequired: '', isActive: '' });
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentFieldId, setCurrentFieldId] = useState(null);
      const [form] = Form.useForm();
      const [remarkForm] = Form.useForm();

      // 实体类型列表
      const entityTypes = [
        { key: 'customer', label: '客商', icon: 'TeamOutlined' },
        { key: 'contract', label: '合同', icon: 'FileTextOutlined' },
        { key: 'spot_brand', label: '现货品种', icon: 'DatabaseOutlined' },
        { key: 'spot_futures_remark', label: '期现备注', icon: 'FileTextOutlined' },
        { key: 'entrust_order', label: '期货委托单', icon: 'ShoppingCartOutlined' },
        { key: 'person', label: '人员', icon: 'UserOutlined' },
        { key: 'futures_account', label: '期货账户', icon: 'AccountBookOutlined' }
      ];

      // 模拟数据
      const [customFields, setCustomFields] = useState({
        customer: [
          { id: 1, fieldCode: 'industry', fieldName: '所属行业', fieldType: 'text', isRequired: false, sortOrder: 1, isActive: true, remark: '' },
          { id: 2, fieldCode: 'business_area', fieldName: '业务区域', fieldType: 'text', isRequired: false, sortOrder: 2, isActive: true, remark: '' }
        ],
        contract: [
          { id: 3, fieldCode: 'project_number', fieldName: '项目编号', fieldType: 'text', isRequired: false, sortOrder: 1, isActive: true, remark: '' },
          { id: 4, fieldCode: 'warehouse', fieldName: '可选仓库', fieldType: 'select', isRequired: false, sortOrder: 2, isActive: true, options: '仓库A|仓库A\n仓库B|仓库B\n仓库C|仓库C\n仓库D|仓库D\n仓库E|仓库E', remark: '' }
        ],
        spot_brand: [],
        spot_futures_remark: [],
        entrust_order: [],
        person: [],
        futures_account: []
      });

      // 字段类型选项
      const fieldTypeOptions = [
        { value: 'text', label: '文本' },
        { value: 'textarea', label: '长文本' },
        { value: 'number', label: '数字' },
        { value: 'date', label: '日期' },
        { value: 'datetime', label: '日期时间' },
        { value: 'select', label: '下拉选择' },
        { value: 'multiselect', label: '多选下拉' },
        { value: 'boolean', label: '布尔（是/否）' }
      ];

      // 当前实体类型的字段列表
      const currentFields = customFields[selectedEntityType] || [];

      // 筛选数据
      const filteredData = useMemo(() => {
        return currentFields.filter(item => {
          if (filters.fieldName && !item.fieldName.includes(filters.fieldName)) return false;
          if (filters.fieldType && item.fieldType !== filters.fieldType) return false;
          if (filters.isRequired !== '') {
            const isRequired = filters.isRequired === 'yes';
            if (item.isRequired !== isRequired) return false;
          }
          if (filters.isActive !== '') {
            const isActive = filters.isActive === 'yes';
            if (item.isActive !== isActive) return false;
          }
          return true;
        });
      }, [filters, currentFields]);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'fieldName', title: '字段名称', dataIndex: 'fieldName', width: 200 },
        { 
          key: 'isActive', 
          title: '状态', 
          dataIndex: 'isActive', 
          width: 100,
          render: (active) => (
            <span className={`erp-status-badge ${active ? 'enabled' : 'disabled'}`}>
              {active ? '启用' : '禁用'}
            </span>
          )
        },
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200, ellipsis: true, render: (text) => (
          text ? <Tooltip title={text}>{text}</Tooltip> : '-'
        )},
        { key: 'fieldCode', title: '字段编码', dataIndex: 'fieldCode', width: 150 },
        { 
          key: 'fieldType', 
          title: '字段类型', 
          dataIndex: 'fieldType', 
          width: 120,
          render: (type) => {
            const typeMap = {
              'text': '文本',
              'textarea': '长文本',
              'number': '数字',
              'date': '日期',
              'datetime': '日期时间',
              'select': '下拉选择',
              'multiselect': '多选下拉',
              'boolean': '布尔（是/否）'
            };
            return typeMap[type] || type;
          }
        },
        { 
          key: 'isRequired', 
          title: '是否必填', 
          dataIndex: 'isRequired', 
          width: 100,
          render: (required) => required ? <Tag color="red">必填</Tag> : <Tag>选填</Tag>
        },
        {
          key: 'options',
          title: '选项列表',
          dataIndex: 'options',
          width: 200,
          render: (options, record) => {
            if (record.fieldType === 'select' || record.fieldType === 'multiselect') {
              if (options) {
                const optionList = options.split('\n').filter(o => o.trim()).slice(0, 3);
                const displayText = optionList.map(opt => {
                  const parts = opt.split('|');
                  return parts.length > 1 ? parts[1] : parts[0];
                }).join('、');
                const moreCount = options.split('\n').filter(o => o.trim()).length - 3;
                return (
                  <Tooltip title={options.split('\n').map(opt => {
                    const parts = opt.split('|');
                    return parts.length > 1 ? `${parts[1]}(${parts[0]})` : opt;
                  }).join('\n')}>
                    <span>{displayText}{moreCount > 0 ? ` 等${moreCount + 3}项` : ''}</span>
                  </Tooltip>
                );
              }
              return <Tag color="orange">未配置</Tag>;
            }
            return '-';
          }
        },
        { key: 'sortOrder', title: '排序', dataIndex: 'sortOrder', width: 80, align: 'right' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: customFieldVisibleColumns
      } = useColumnManager('custom-field', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleAdd = () => {
        form.resetFields();
        form.setFieldsValue({
          fieldType: 'text',
          isRequired: false,
          isActive: true,
          sortOrder: filteredData.length + 1,
          remark: ''
        });
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = filteredData.find(f => f.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue(record);
          setEditModalVisible(true);
        }
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条自定义字段吗？删除后历史数据将保留。`,
          onOk: () => {
            const newFields = currentFields.filter(f => !selectedRowKeys.includes(f.id));
            setCustomFields({
              ...customFields,
              [selectedEntityType]: newFields
            });
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id');
          
          // 验证：如果是select或multiselect类型，必须配置选项列表
          if ((values.fieldType === 'select' || values.fieldType === 'multiselect') && !values.options?.trim()) {
            message.error('下拉选择和多选下拉类型的字段必须配置选项列表');
            return;
          }
          
          const newField = {
            ...values,
            id: editingId || Date.now(),
            fieldCode: values.fieldCode || values.fieldName.toLowerCase().replace(/\s+/g, '_'),
            remark: values.remark || ''
          };

          if (editingId) {
            // 编辑
            const newFields = currentFields.map(f => f.id === editingId ? newField : f);
            setCustomFields({
              ...customFields,
              [selectedEntityType]: newFields
            });
          } else {
            // 新增
            // 检查字段编码是否重复
            const exists = currentFields.some(f => f.fieldCode === newField.fieldCode);
            if (exists) {
              message.error('字段编码已存在，请使用其他编码');
              return;
            }
            setCustomFields({
              ...customFields,
              [selectedEntityType]: [...currentFields, newField]
            });
          }
          
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
          setSelectedRowKeys([]);
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const hasDisabled = filteredData.some(f => selectedRowKeys.includes(f.id) && !f.isActive);
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            const newFields = currentFields.map(f => 
              selectedRowKeys.includes(f.id) ? { ...f, isActive: !f.isActive } : f
            );
            setCustomFields({
              ...customFields,
              [selectedEntityType]: newFields
            });
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ display: 'flex', flex: 1, minHeight: 0, gap: 9 }}>
            {/* 左侧实体类型列表 */}
            <div style={{ 
              width: 200, 
              backgroundColor: '#fff', 
              borderRadius: 12, 
              padding: 8,
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 12px 30px rgba(22, 119, 255, 0.05)'
            }}>
              <div style={{ 
                padding: '8px 12px', 
                borderBottom: '1px solid #f0f0f0',
                fontWeight: 500,
                color: '#1677ff'
              }}>
                实体类型
              </div>
              <div style={{ flex: 1, overflow: 'auto', paddingTop: 8 }}>
                {entityTypes.map(entity => (
                  <div
                    key={entity.key}
                    onClick={() => {
                      setSelectedEntityType(entity.key);
                      setSelectedRowKeys([]);
                    }}
                    style={{
                      padding: '10px 12px',
                      cursor: 'pointer',
                      borderRadius: 6,
                      marginBottom: 4,
                      backgroundColor: selectedEntityType === entity.key ? 'rgba(22, 119, 255, 0.1)' : 'transparent',
                      color: selectedEntityType === entity.key ? '#1677ff' : '#333',
                      fontWeight: selectedEntityType === entity.key ? 500 : 400,
                      display: 'flex',
                      alignItems: 'center',
                      gap: 8
                    }}
                  >
                    {renderIcon(entity.icon)}
                    <span>{entity.label}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* 右侧字段列表 */}
            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minWidth: 0 }}>
              <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
                <div className="erp-filter-item">
                  <label>字段名称：</label>
                  <Input placeholder="字段名称" style={{ width: 150 }} value={filters.fieldName} onChange={(e) => setFilters({...filters, fieldName: e.target.value})} />
                </div>
                <div className="erp-filter-item">
                  <label>字段类型：</label>
                  <Select 
                    placeholder="全部" 
                    style={{ width: 150 }} 
                    value={filters.fieldType || undefined}
                    onChange={(v) => setFilters({...filters, fieldType: v || ''})}
                    allowClear
                  >
                    {fieldTypeOptions.map(option => (
                      <Select.Option key={option.value} value={option.value}>{option.label}</Select.Option>
                    ))}
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>是否必填：</label>
                  <Select 
                    placeholder="全部" 
                    style={{ width: 120 }} 
                    value={filters.isRequired || undefined}
                    onChange={(v) => setFilters({...filters, isRequired: v || ''})}
                    allowClear
                  >
                    <Select.Option value="yes">必填</Select.Option>
                    <Select.Option value="no">选填</Select.Option>
                  </Select>
                </div>
                <div className="erp-filter-item">
                  <label>状态：</label>
                  <Select 
                    placeholder="全部" 
                    style={{ width: 120 }} 
                    value={filters.isActive || undefined}
                    onChange={(v) => setFilters({...filters, isActive: v || ''})}
                    allowClear
                  >
                    <Select.Option value="yes">启用</Select.Option>
                    <Select.Option value="no">禁用</Select.Option>
                  </Select>
                </div>
              </div>
              <div className="erp-toolbar">
                <Space wrap>
                  <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>增加</Button>
                  <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑</Button>
                  <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
                  <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
                  <Button icon={renderIcon('FileTextOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => {
                    if (selectedRowKeys.length === 1) {
                      const field = filteredData.find(item => item.id === selectedRowKeys[0]);
                      if (field) {
                        setCurrentFieldId(field.id);
                        remarkForm.setFieldsValue({ remark: field.remark || '' });
                        setRemarkModalVisible(true);
                      }
                    }
                  }}>备注</Button>
                  <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
                </Space>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                  style={{ marginLeft: 'auto' }}
                >
                  自定义列
                </Button>
              </div>
              <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
                <div className="erp-table-wrapper">
                  <Table
                    rowSelection={{ 
                      type: 'radio',
                      selectedRowKeys, 
                      onChange: setSelectedRowKeys 
                    }}
                    columns={tableColumns}
                    dataSource={filteredData}
                    rowKey="id"
                    scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                    pagination={createPaginationConfig()}
                  />
                </div>
              </div>
            </div>
          </div>

          {/* 编辑弹窗 */}
          <Modal
            {...MODAL_TEXTS}
            title="编辑自定义字段"
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields(); 
            }}
            width={600}
            onOk={handleSave}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="字段名称" name="fieldName" required rules={[{ required: true, message: '请输入字段名称' }]}>
                <Input placeholder="请输入字段名称" />
              </Form.Item>
              <Form.Item label="字段编码" name="fieldCode" required rules={[{ required: true, message: '请输入字段编码' }, { pattern: /^[a-z][a-z0-9_]*$/, message: '字段编码只能包含小写字母、数字和下划线，且必须以字母开头' }]}>
                <Input placeholder="字段编码（自动生成或手动输入）" />
              </Form.Item>
              <Form.Item label="字段类型" name="fieldType" required rules={[{ required: true, message: '请选择字段类型' }]}>
                <Select placeholder="请选择字段类型">
                  {fieldTypeOptions.map(opt => (
                    <Select.Option key={opt.value} value={opt.value}>{opt.label}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item 
                noStyle 
                shouldUpdate={(prevValues, currentValues) => prevValues.fieldType !== currentValues.fieldType}
              >
                {({ getFieldValue }) => {
                  const fieldType = getFieldValue('fieldType');
                  if (fieldType === 'select' || fieldType === 'multiselect') {
                    return (
                      <Form.Item 
                        label="选项列表" 
                        name="options" 
                        rules={[{ required: true, message: '请输入选项列表' }]}
                        extra="每行一个选项，格式：选项值|选项显示名称 或直接输入选项名称（值默认为名称）。例如：仓库A|仓库A 或直接输入：仓库A"
                      >
                        <Input.TextArea 
                          placeholder="每行一个选项，例如：&#10;仓库A|仓库A&#10;仓库B|仓库B&#10;仓库C|仓库C"
                          rows={6}
                        />
                      </Form.Item>
                    );
                  }
                  return null;
                }}
              </Form.Item>
              <Form.Item label="是否必填" name="isRequired" valuePropName="checked">
                <Switch />
              </Form.Item>
              <Form.Item label="排序" name="sortOrder">
                <InputNumber min={1} style={{ width: '100%' }} />
              </Form.Item>
              <Form.Item label="状态" name="isActive" valuePropName="checked">
                <Switch />
              </Form.Item>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                const newFields = currentFields.map(f => {
                  if (f.id === currentFieldId) {
                    return { ...f, remark: values.remark || '' };
                  }
                  return f;
                });
                setCustomFields({
                  ...customFields,
                  [selectedEntityType]: newFields
                });
                message.success('备注保存成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
              });
            }}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={customFieldVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 其他设置页面
    const OtherSettings = () => {
      // 从localStorage读取配置，如果没有则使用默认值
      const getInitialConfig = () => {
        const saved = localStorage.getItem('other-settings');
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            return { purchaseSalesRelationRule: 'manual' };
          }
        }
        return { purchaseSalesRelationRule: 'manual' };
      };

      const [config, setConfig] = useState(getInitialConfig);
      const [loading, setLoading] = useState(false);
      const [form] = Form.useForm();

      useEffect(() => {
        form.setFieldsValue(config);
      }, [config, form]);

      const handleSave = async () => {
        try {
          await form.validateFields();
          const values = form.getFieldsValue();
          setLoading(true);
          
          // 模拟保存
          setTimeout(() => {
            setConfig(values);
            localStorage.setItem('other-settings', JSON.stringify(values));
            message.success('配置保存成功');
            setLoading(false);
          }, 500);
        } catch (error) {
          console.error('表单验证失败:', error);
        }
      };

      return (
        <div style={{ padding: '24px', background: '#fff', minHeight: '100%' }}>
          <div style={{ marginBottom: 24 }}>
            <h2 style={{ margin: 0, fontSize: 20, fontWeight: 600, color: '#1f2430' }}>其他设置</h2>
            <div style={{ marginTop: 8, color: '#8a94a6', fontSize: 14 }}>
              配置系统业务规则和全局参数
            </div>
          </div>

          <Card
            title={
              <span style={{ fontSize: 16, fontWeight: 500 }}>
                {renderIcon('SettingOutlined', { style: { marginRight: 8 } })}
                业务规则配置
              </span>
            }
            style={{ marginBottom: 24 }}
          >
            <Form
              form={form}
              layout="vertical"
              initialValues={config}
            >
              <Form.Item
                label={
                  <span>
                    <strong>采销关联规则</strong>
                    <Tooltip title="设置采购合同与销售合同的关联匹配规则，决定系统如何处理采销合同的关联操作。">
                      {renderIcon('QuestionCircleOutlined', { style: { marginLeft: 8, color: '#8a94a6', cursor: 'help' } })}
                    </Tooltip>
                  </span>
                }
                name="purchaseSalesRelationRule"
                rules={[{ required: true, message: '请选择采销关联规则' }]}
              >
                <Radio.Group>
                  <Radio value="manual">
                    <span style={{ fontWeight: 500 }}>手工指定采销</span>
                    <div style={{ marginTop: 4, fontSize: 12, color: '#8a94a6', fontWeight: 400 }}>
                      用户在业务页面手动选择采购合同和销售合同进行关联。适用于需要精确控制采销匹配关系的业务场景。
                    </div>
                  </Radio>
                  <Radio value="auto-fifo" style={{ marginTop: 16 }}>
                    <span style={{ fontWeight: 500 }}>自动先进先出</span>
                    <div style={{ marginTop: 4, fontSize: 12, color: '#8a94a6', fontWeight: 400 }}>
                      系统按照先进先出（FIFO）规则自动匹配采购合同与销售合同。适用于批量处理、标准化业务流程的场景。
                    </div>
                  </Radio>
                </Radio.Group>
              </Form.Item>

              <Divider orientation="left" style={{ marginTop: 32, marginBottom: 16 }}>
                <span style={{ fontSize: 14, fontWeight: 500 }}>约束规则说明</span>
              </Divider>

              <Alert
                message="通用约束规则"
                description={
                  <div>
                    <p style={{ margin: '8px 0' }}>
                      <strong>无论选择哪种关联规则，无论保值方案是整体匹配还是单单匹配，均需遵守以下约束：</strong>
                    </p>
                    <ul style={{ margin: '8px 0', paddingLeft: 20 }}>
                      <li style={{ marginBottom: 8 }}>
                        <strong>现货品种一致性要求</strong>：采购合同与销售合同的现货品种必须一致。系统在进行采销关联时，必须校验两侧合同的现货品种是否相同。如果现货品种不一致，系统应拒绝关联并提示错误信息。
                      </li>
                      <li style={{ marginBottom: 8 }}>
                        <strong>期货月份无要求</strong>：系统不对合同关联的期货月份提要求。采购合同关联的期货合约月份与销售合同关联的期货合约月份可以不同。例如：采购合同可能关联 cu2403，销售合同可能关联 cu2404，系统允许此种关联。
                      </li>
                      <li>
                        <strong>保值方案一致性要求</strong>：采购合同与销售合同的保值方案必须一致。
                      </li>
                    </ul>
                  </div>
                }
                type="info"
                showIcon
                style={{ marginTop: 16 }}
              />
            </Form>

            <div style={{ marginTop: 24, textAlign: 'right' }}>
              <Button
                type="primary"
                onClick={handleSave}
                loading={loading}
                icon={renderIcon('SaveOutlined')}
              >
                保存配置
              </Button>
            </div>
          </Card>
        </div>
      );
    };

    // 合同管理页面
    const ContractManagement = ({ contractType = 'purchase' }) => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [linkModalVisible, setLinkModalVisible] = useState(false);
      const [unlinkModalVisible, setUnlinkModalVisible] = useState(false);
      const [priceModalVisible, setPriceModalVisible] = useState(false);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [filterDrawerVisible, setFilterDrawerVisible] = useState(false);
      const [detailModal, setDetailModal] = useState({ visible: false, type: null, payload: null });
      const [salesRelationModalVisible, setSalesRelationModalVisible] = useState(false);
      const [selectedContractForSalesRelation, setSelectedContractForSalesRelation] = useState(null);
      const [relationDetailDrawer, setRelationDetailDrawer] = useState({ visible: false, record: null });
      const [pricingMode, setPricingMode] = useState(null);
      const [form] = Form.useForm();
      const [filterForm] = Form.useForm();
      
      // 未完成指令和预算相关状态
      const [pendingInstructions, setPendingInstructions] = useState([]);
      const [budgetInfo, setBudgetInfo] = useState(null);
      const [exposureCoefficient, setExposureCoefficient] = useState(1.0); // 敞口系数，默认1.0
      const [instructionDetailVisible, setInstructionDetailVisible] = useState(false);
      const [selectedInstruction, setSelectedInstruction] = useState(null);

      const isPurchase = contractType === 'purchase';
      const statusLabelMap = { enable: '启用', disable: '禁用', delete: '取消' };
      const statusTagColorMap = { enable: 'green', disable: 'orange', delete: 'red' };
      const boolSelectOptions = [
        { label: '全部', value: '' },
        { label: '是', value: 'yes' },
        { label: '否', value: 'no' }
      ];

      const contractsByType = useMemo(
        () => mockContracts.filter(contract => contract.contractDirection === (isPurchase ? 'purchase' : 'sales')),
        [isPurchase]
      );

      const hedgePlanOptions = useMemo(
        () => mockHedgePlans.map(plan => ({ label: plan.name, value: plan.id })),
        []
      );

      const managerOptions = useMemo(() => {
        const set = new Set();
        contractsByType.forEach(contract => {
          if (contract.manager) set.add(contract.manager);
        });
        return Array.from(set).map(name => ({ label: name, value: name }));
      }, [contractsByType]);

      const customerOptions = useMemo(() => {
        const allowedTypes = isPurchase ? ['供应商'] : ['客户'];
        return mockCustomers
          .filter(c => allowedTypes.includes(c.customerType))
          .map(c => ({ label: c.shortName, value: c.id }));
      }, [isPurchase]);

      const spotTypeOptions = useMemo(() => {
        const set = new Set();
        contractsByType.forEach(contract => {
          if (contract.spotType) set.add(contract.spotType);
        });
        return Array.from(set).map(name => ({ label: name, value: name }));
      }, [contractsByType]);

      const brandOptions = useMemo(() => {
        const set = new Map();
        contractsByType.forEach(contract => {
          if (contract.brandId) {
            set.set(contract.brandId, contract.brand);
          }
        });
        return Array.from(set.entries()).map(([value, label]) => ({ label, value }));
      }, [contractsByType]);

      const pricingOptions = [
        { label: '一口价', value: '一口价' },
        { label: '暂定价', value: '暂定价' },
        { label: '均价', value: '均价' }
      ];

      const statusOptions = [
        { label: '启用', value: 'enable' },
        { label: '禁用', value: 'disable' },
        { label: '已删除', value: 'delete' }
      ];

      const creatorOptions = useMemo(
        () => mockPersons.map(person => ({ label: person.name, value: person.name })),
        []
      );

      const transportOptions = [
        { label: '自提', value: '自提' },
        { label: '送到', value: '送到' }
      ];

      const initialFilterValues = useMemo(
        () => ({
          hedgePlanIds: [],
          managerNames: [],
          contractKeyword: '',
          customerIds: [],
          spotTypes: [],
          brandIds: [],
          pricingModes: [],
          statuses: [],
          pricedState: '',
          deliveredState: '',
          pricingWindowState: '',
          createdRange: [],
          contractQtyRange: [],
          priceRange: [],
          settlementPriceRange: [],
          transportModes: [],
          occurRange: [],
          avgRange: [],
          priceDeadlineRange: [],
          deliveryRange: [],
          creatorNames: [],
          customFieldKeyword: ''
        }),
        [contractType]
      );

      const [filters, setFilters] = useState(initialFilterValues);

      useEffect(() => {
        filterForm.setFieldsValue(initialFilterValues);
        setFilters(initialFilterValues);
      }, [initialFilterValues, filterForm]);

      const NumberRangeInput = ({ value = [], onChange, unit }) => {
        const [min, max] = value || [];
        const triggerChange = (next) => {
          onChange?.(next);
        };
        return (
          <Space>
            <InputNumber
              value={min}
              onChange={(val) => triggerChange([val, max])}
              placeholder="最小值"
              style={{ width: 110 }}
            />
            <span style={{ color: '#c4c8d1' }}>~</span>
            <InputNumber
              value={max}
              onChange={(val) => triggerChange([min, val])}
              placeholder="最大值"
              style={{ width: 110 }}
            />
            {unit && <span style={{ color: '#8a94a6' }}>{unit}</span>}
          </Space>
        );
      };

      const matchesNumberRange = (value, range = []) => {
        if (!range || range.length === 0) return true;
        const [min, max] = range;
        if (min !== undefined && min !== null && value < min) return false;
        if (max !== undefined && max !== null && value > max) return false;
        return true;
      };

      const matchesDateRange = (value, range = [], precise = false) => {
        if (!range || range.length !== 2 || (!range[0] && !range[1])) return true;
        if (!value) return false;
        const target = dayjs(value);
        if (!target.isValid()) return false;
        const precision = precise ? 'minute' : 'day';
        if (range[0] && target.isBefore(range[0], precision)) return false;
        if (range[1] && target.isAfter(range[1], precision)) return false;
        return true;
      };

      const matchesBooleanState = (state, filterValue) => {
        if (!filterValue) return true;
        return filterValue === 'yes' ? !!state : !state;
      };

      const handleFilterValuesChange = (_, allValues) => {
        setFilters(allValues);
      };

      const resetFilters = () => {
        filterForm.resetFields();
        setFilters(initialFilterValues);
      };

      const enrichedContracts = useMemo(() => {
        const now = dayjs();
        return contractsByType.map(contract => {
          const qty = Number(contract.qty) || 0;
          const pricedQty = Number(contract.pricedQty) || 0;
          const priceDeadlineDay = contract.priceDeadline ? dayjs(contract.priceDeadline) : null;
          const deliveryDay = contract.deliveryDate ? dayjs(contract.deliveryDate) : null;
          const avgStartDay = contract.avgStartDate ? dayjs(contract.avgStartDate) : null;
          const avgEndDay = contract.avgEndDate ? dayjs(contract.avgEndDate) : null;
          const isPriced = pricedQty > 0;
          const isDelivered = deliveryDay ? deliveryDay.isSameOrBefore(now, 'day') : false;
          const inPricingWindow = priceDeadlineDay ? now.isSameOrBefore(priceDeadlineDay, 'day') : false;
          return {
            ...contract,
            amount: contract.amount,
            settlementAmount: contract.settlementAmount,
            unpricedQty: contract.unpricedQty ?? Math.max(qty - pricedQty, 0),
            isPriced,
            isPricedLabel: isPriced ? '是' : '否',
            isDelivered,
            isDeliveredLabel: isDelivered ? '是' : '否',
            inPricingWindow,
            inPricingWindowLabel: inPricingWindow ? '是' : '否',
            statusLabel: statusLabelMap[contract.status] || contract.status,
            priceDeadlineLabel: contract.priceDeadline,
            deliveryDateLabel: contract.deliveryDate,
            avgStartDay,
            avgEndDay
          };
        });
      }, [contractsByType]);

      const filteredContracts = useMemo(() => {
        return enrichedContracts.filter(contract => {
          if (filters.hedgePlanIds?.length && !filters.hedgePlanIds.includes(contract.hedgePlanId)) return false;
          if (filters.managerNames?.length && !filters.managerNames.includes(contract.manager)) return false;
          if (filters.contractKeyword && !contract.contractNo?.toLowerCase().includes(filters.contractKeyword.toLowerCase())) return false;
          if (filters.customerIds?.length && !filters.customerIds.includes(contract.customerId)) return false;
          if (filters.spotTypes?.length && !filters.spotTypes.includes(contract.spotType)) return false;
          if (filters.brandIds?.length && !filters.brandIds.includes(contract.brandId)) return false;
          if (filters.pricingModes?.length && !filters.pricingModes.includes(contract.pricing)) return false;
          if (filters.statuses?.length && !filters.statuses.includes(contract.status)) return false;
          if (!matchesBooleanState(contract.isPriced, filters.pricedState)) return false;
          if (!matchesBooleanState(contract.isDelivered, filters.deliveredState)) return false;
          if (!matchesBooleanState(contract.inPricingWindow, filters.pricingWindowState)) return false;
          if (!matchesDateRange(contract.createTime, filters.createdRange, true)) return false;
          if (!matchesNumberRange(Number(contract.qty) || 0, filters.contractQtyRange)) return false;
          if (contract.price !== null && !matchesNumberRange(Number(contract.price), filters.priceRange)) return false;
          if (contract.settlementPrice !== null && !matchesNumberRange(Number(contract.settlementPrice), filters.settlementPriceRange)) return false;
          if (filters.transportModes?.length && !filters.transportModes.includes(contract.transport)) return false;
          if (!matchesDateRange(contract.occurTime, filters.occurRange, true)) return false;
          if (filters.avgRange?.length === 2 && (filters.avgRange[0] || filters.avgRange[1])) {
            const avgValues = [contract.avgStartDate, contract.avgEndDate].filter(Boolean);
            if (!avgValues.length) return false;
            const allInRange = avgValues.every(date => matchesDateRange(date, filters.avgRange, false));
            if (!allInRange) return false;
          }
          if (!matchesDateRange(contract.priceDeadline, filters.priceDeadlineRange)) return false;
          if (!matchesDateRange(contract.deliveryDate, filters.deliveryRange)) return false;
          if (filters.creatorNames?.length && !filters.creatorNames.includes(contract.creator)) return false;
          const customKeyword = filters.customFieldKeyword?.trim();
          if (customKeyword) {
            const keyword = customKeyword.toLowerCase();
            const matched = Object.values(contract.customFields || {}).some(value =>
              String(value || '').toLowerCase().includes(keyword)
            );
            if (!matched) return false;
          }
          return true;
        });
      }, [enrichedContracts, filters]);

      const formatNumeric = (value, precision = 2) => {
        const num = Number(value);
        if (!Number.isFinite(num)) return '-';
        let safePrecision = Number(precision);
        if (!Number.isFinite(safePrecision)) safePrecision = 2;
        safePrecision = Math.min(Math.max(Math.round(safePrecision), 0), 20);
        return num.toLocaleString(undefined, { minimumFractionDigits: safePrecision, maximumFractionDigits: safePrecision });
      };

      const formatQuantity = (value) => {
        if (value === null || value === undefined || Number.isNaN(value)) return '-';
        return Number(value).toLocaleString();
      };

      const currentContractRelationQty = selectedContractForSalesRelation
        ? (isPurchase ? selectedContractForSalesRelation.soldQty || 0 : selectedContractForSalesRelation.purchasedQty || 0)
        : 0;

      const salesRelationList = useMemo(() => {
        if (!selectedContractForSalesRelation) return [];
        return (contractSalesRelationMap[selectedContractForSalesRelation.id] || []).map(rel => ({
          ...rel,
          relationId: rel.id,
          contractNo: rel.counterpartContractNo,
          customer: rel.counterpartCustomer,
          manager: rel.counterpartManager,
          relatedQty: Number(rel.qty) || 0,
          relatedDate: rel.relatedDate,
          occurTime: rel.occurTime
        }));
      }, [selectedContractForSalesRelation]);

      const relationTotalQty = useMemo(
        () => salesRelationList.reduce((sum, rel) => sum + (Number(rel.relatedQty) || 0), 0),
        [salesRelationList]
      );

      const relationMismatch = useMemo(() => {
        return Number(currentContractRelationQty || 0) !== Number(relationTotalQty || 0);
      }, [currentContractRelationQty, relationTotalQty]);

      const openDetailModal = (type, record) => {
        if (type === 'customer') {
          const customer = mockCustomers.find(c => c.id === record.customerId) || mockCustomers.find(c => c.shortName === record.customer);
          if (customer) {
            setDetailModal({ visible: true, type: 'customer', payload: customer });
          }
          return;
        }
        if (type === 'brand') {
          const brand = mockSpotBrands.find(b => b.id === record.brandId) || mockSpotBrands.find(b => b.name === record.brand);
          if (brand) {
            setDetailModal({ visible: true, type: 'brand', payload: brand });
          }
          return;
        }
        setDetailModal({ visible: true, type: 'contract', payload: record });
      };

      const closeDetailModal = () => setDetailModal({ visible: false, type: null, payload: null });

      const renderDetailModalContent = () => {
        if (!detailModal.payload) return null;
        if (detailModal.type === 'customer') {
          const customer = detailModal.payload;
          return (
            <Descriptions size="small" column={1} bordered>
              <Descriptions.Item label="简称">{customer.shortName || '-'}</Descriptions.Item>
              <Descriptions.Item label="全称">{customer.fullName || '-'}</Descriptions.Item>
              <Descriptions.Item label="客商分类">{customer.customerType || '-'}</Descriptions.Item>
              <Descriptions.Item label="联系人">{customer.contact || '-'}</Descriptions.Item>
              <Descriptions.Item label="手机号">{customer.phone || '-'}</Descriptions.Item>
              <Descriptions.Item label="状态">{customer.status || '-'}</Descriptions.Item>
              <Descriptions.Item label="创建人">{customer.creator || '-'}</Descriptions.Item>
              <Descriptions.Item label="创建时间">{customer.createTime || '-'}</Descriptions.Item>
            </Descriptions>
          );
        }
        if (detailModal.type === 'brand') {
          const brand = detailModal.payload;
          return (
            <div>
              <Descriptions size="small" column={2} bordered>
                <Descriptions.Item label="名称">{brand.name}</Descriptions.Item>
                <Descriptions.Item label="是否主港">{brand.mainPortState === true ? '是' : brand.mainPortState === false ? '否' : '未设置'}</Descriptions.Item>
                <Descriptions.Item label="是否平台价">{brand.platformState === true ? '是' : brand.platformState === false ? '否' : '未设置'}</Descriptions.Item>
                <Descriptions.Item label="价格">{brand.price}</Descriptions.Item>
                <Descriptions.Item label="升贴水">{brand.premium}</Descriptions.Item>
              </Descriptions>
              <Divider orientation="left" style={{ marginTop: 16 }}>期货敞口配置</Divider>
              {brand.futures?.length ? (
                <List
                  size="small"
                  dataSource={brand.futures}
                  renderItem={(item) => (
                    <List.Item>
                      <Space>
                        <strong>{item.code || '-'}</strong>
                        <span style={{ color: '#8a94a6' }}>敞口系数：{(item.exposure ?? 0).toFixed(2)}</span>
                      </Space>
                    </List.Item>
                  )}
                />
              ) : (
                <Alert type="info" showIcon message="未配置期货敞口" />
              )}
            </div>
          );
        }
        const contract = detailModal.payload;
        return (
          <div>
            <Divider orientation="left">基本信息</Divider>
            <Descriptions size="small" column={2} bordered>
              <Descriptions.Item label="保值方案">{contract.hedgePlan}</Descriptions.Item>
              <Descriptions.Item label="业务经理">{contract.manager || '-'}</Descriptions.Item>
              <Descriptions.Item label="合同编号">{contract.contractNo}</Descriptions.Item>
              <Descriptions.Item label={isPurchase ? '供应商' : '客户'}>{contract.customer}</Descriptions.Item>
              <Descriptions.Item label="现货品种">{contract.spotType || '-'}</Descriptions.Item>
              <Descriptions.Item label="品牌">{contract.brand || '-'}</Descriptions.Item>
              <Descriptions.Item label="计价方式">{contract.pricing || '-'}</Descriptions.Item>
              <Descriptions.Item label="运输方式">{contract.transport || '-'}</Descriptions.Item>
            </Descriptions>
            <Divider orientation="left">数量与价格</Divider>
            <Descriptions size="small" column={2} bordered>
              <Descriptions.Item label="合同数量">{formatQuantity(contract.qty)}</Descriptions.Item>
              <Descriptions.Item label="已点数量">{formatQuantity(contract.pricedQty)}</Descriptions.Item>
              <Descriptions.Item label="未点数量">{formatQuantity(contract.unpricedQty)}</Descriptions.Item>
              <Descriptions.Item label="单价">{formatNumeric(contract.price)}</Descriptions.Item>
              <Descriptions.Item label="结算单价">{formatNumeric(contract.settlementPrice)}</Descriptions.Item>
              <Descriptions.Item label="合同金额">{formatNumeric(contract.amount)}</Descriptions.Item>
              <Descriptions.Item label="结算金额">{formatNumeric(contract.settlementAmount)}</Descriptions.Item>
            </Descriptions>
            <Divider orientation="left">时间信息</Divider>
            <Descriptions size="small" column={2} bordered>
              <Descriptions.Item label="发生日期时间">{contract.occurTime || '-'}</Descriptions.Item>
              <Descriptions.Item label="创建日期时间">{contract.createTime || '-'}</Descriptions.Item>
              <Descriptions.Item label="点价截止日">{contract.priceDeadlineLabel || '-'}</Descriptions.Item>
              <Descriptions.Item label="交割日期">{contract.deliveryDateLabel || '-'}</Descriptions.Item>
              <Descriptions.Item label="均价起止日" span={2}>
                {contract.avgStartDate || contract.avgEndDate
                  ? `${contract.avgStartDate || '-'} ~ ${contract.avgEndDate || '-'}`
                  : '-'}
              </Descriptions.Item>
            </Descriptions>
            <Divider orientation="left">其他信息</Divider>
            <Descriptions size="small" column={2} bordered>
              <Descriptions.Item label="创建人">{contract.creator || '-'}</Descriptions.Item>
              <Descriptions.Item label="状态">{statusLabelMap[contract.status] || '-'}</Descriptions.Item>
              <Descriptions.Item label="备注" span={2}>{contract.remark || '-'}</Descriptions.Item>
            </Descriptions>
            <Divider orientation="left">自定义字段</Divider>
            {contract.customFields && Object.keys(contract.customFields).length ? (
              <Descriptions size="small" column={2} bordered>
                {Object.entries(contract.customFields).map(([field, value]) => (
                  <Descriptions.Item key={field} label={field}>{value || '-'}</Descriptions.Item>
                ))}
              </Descriptions>
            ) : (
              <Alert type="info" showIcon message="暂无自定义字段数据" />
            )}
          </div>
        );
      };

      const allColumnDefinitions = [
        {
          key: 'contractNo',
          title: '合同编号',
          dataIndex: 'contractNo',
          width: 160,
          fixed: 'left',
          render: (text, record) => (
            <Button type="link" onClick={(e) => { e.stopPropagation(); openDetailModal('contract', record); }}>
              {text}
            </Button>
          )
        },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 150 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        {
          key: 'customer',
          title: isPurchase ? '供应商' : '客户',
          dataIndex: 'customer',
          width: 180,
          render: (text, record) => (
            <Button type="link" onClick={(e) => { e.stopPropagation(); openDetailModal('customer', record); }}>
              {text}
            </Button>
          )
        },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        {
          key: 'brand',
          title: '品牌',
          dataIndex: 'brand',
          width: 120,
          render: (text, record) => (
            <Button type="link" onClick={(e) => { e.stopPropagation(); openDetailModal('brand', record); }}>
              {text}
            </Button>
          )
        },
        { key: 'pricing', title: '计价方式', dataIndex: 'pricing', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right', render: formatQuantity },
        { key: 'price', title: '单价', dataIndex: 'price', width: 120, align: 'right', render: formatNumeric },
        { key: 'settlementPrice', title: '结算单价', dataIndex: 'settlementPrice', width: 120, align: 'right', render: formatNumeric },
        { key: 'amount', title: '合同金额', dataIndex: 'amount', width: 150, align: 'right', render: formatNumeric },
        { key: 'settlementAmount', title: '结算金额', dataIndex: 'settlementAmount', width: 150, align: 'right', render: formatNumeric },
        { key: 'pricedQty', title: '已点数量', dataIndex: 'pricedQty', width: 120, align: 'right', render: formatQuantity },
        { key: 'unpricedQty', title: '未点数量', dataIndex: 'unpricedQty', width: 120, align: 'right', render: formatQuantity },
        {
          key: isPurchase ? 'soldQty' : 'purchasedQty',
          title: isPurchase ? '已销售数量' : '已采购数量',
          dataIndex: isPurchase ? 'soldQty' : 'purchasedQty',
          width: 120,
          align: 'right',
          render: (value, record) => (
            <Button
              type="link"
              onClick={(e) => {
                e.stopPropagation();
                setSelectedContractForSalesRelation(record);
                setSalesRelationModalVisible(true);
              }}
              style={{ padding: 0 }}
            >
              {formatQuantity(value || 0)}
            </Button>
          )
        },
        { key: 'priceDeadline', title: '点价截止日', dataIndex: 'priceDeadlineLabel', width: 140 },
        { key: 'deliveryDate', title: '交割日期', dataIndex: 'deliveryDateLabel', width: 140 },
        { key: 'isPriced', title: '是否已定价', dataIndex: 'isPricedLabel', width: 120 },
        { key: 'isDelivered', title: '是否已交收', dataIndex: 'isDeliveredLabel', width: 120 },
        { key: 'inPricingWindow', title: '是否在定价期', dataIndex: 'inPricingWindowLabel', width: 140 },
        {
          key: 'statusLabel',
          title: '状态',
          dataIndex: 'statusLabel',
          width: 110,
          render: (text, record) => <Tag color={statusTagColorMap[record.status] || 'default'}>{text}</Tag>
        },
        { key: 'createTime', title: '创建日期时间', dataIndex: 'createTime', width: 180 },
        { key: 'occurTime', title: '发生日期时间', dataIndex: 'occurTime', width: 180 },
        { key: 'transport', title: '运输方式', dataIndex: 'transport', width: 120 },
        { key: 'creator', title: '创建人', dataIndex: 'creator', width: 120 },
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 200 }
      ];

      const defaultColumnKeys = [
        'contractNo',
        'hedgePlan',
        'manager',
        'customer',
        'spotType',
        'brand',
        'pricing',
        'qty',
        'price',
        'settlementPrice',
        'amount',
        'pricedQty',
        'unpricedQty',
        isPurchase ? 'soldQty' : 'purchasedQty',
        'priceDeadline',
        'deliveryDate',
        'statusLabel',
        'createTime'
      ];

      const defaultVisibleColumns = allColumnDefinitions.filter(column => defaultColumnKeys.includes(column.key));

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: contractVisibleColumns
      } = useColumnManager(`contract-${contractType}`, allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleAdd = () => {
        form.resetFields();
        setPricingMode(null);
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = filteredContracts.find(c => c.id === selectedRowKeys[0]);
        if (record) {
          // 处理日期字段
          const deliveryDate = record.deliveryDate ? dayjs(record.deliveryDate) : null;
          const priceDeadline = record.priceDeadline ? dayjs(record.priceDeadline) : null;
          const avgDateRange = (record.avgStartDate && record.avgEndDate) 
            ? [dayjs(record.avgStartDate), dayjs(record.avgEndDate)] 
            : null;
          const occurTime = record.occurTime ? dayjs(record.occurTime) : null;

          form.setFieldsValue({
            id: record.id,
            hedgePlan: record.hedgePlanId,
            manager: record.manager,
            contractNo: record.contractNo,
            customer: record.customerId,
            spotType: record.spotType,
            brand: record.brandId,
            pricing: record.pricing,
            qty: record.qty,
            price: record.price,
            settlementPrice: record.settlementPrice,
            transport: record.transport,
            deliveryDate: deliveryDate,
            avgDateRange: avgDateRange,
            priceDeadline: priceDeadline,
            occurTime: occurTime,
            remark: record.remark || '',
            pricedQty: record.pricedQty || 0,
            customWarehouse: record.customFields?.仓库 || null
          });
          setPricingMode(record.pricing);
          setEditModalVisible(true);
        }
      };

      // 计算预算变更影响
      const calculateBudget = useCallback((newQty) => {
        const editingId = form.getFieldValue('id');
        const oldQty = editingId ? (form.getFieldValue('originalQty') || 0) : 0;
        
        if (newQty === null || newQty === undefined) {
          setBudgetInfo(null);
          return;
        }
        
        // 获取敞口系数（模拟：从保值方案中获取，这里简化处理）
        // 实际应该根据保值方案和品牌配置获取
        const coefficient = exposureCoefficient;
        
        const changeQty = newQty - oldQty;
        const requiredFutures = changeQty * coefficient;
        
        setBudgetInfo({
          oldQty,
          newQty,
          changeQty,
          coefficient,
          requiredFutures,
          direction: changeQty > 0 ? '增加' : changeQty < 0 ? '减少' : '无变化',
          futuresDirection: requiredFutures > 0 ? '买入' : requiredFutures < 0 ? '卖出' : '无影响'
        });
      }, [exposureCoefficient, form]);
      
      // 查询未完成指令
      const fetchPendingInstructions = useCallback((contractId, hedgePlanId) => {
        // 模拟数据：实际应该从API获取
        const mockPendingInstructions = contractId ? [
          {
            id: 'INS-001',
            instructionNo: 'INS-2025-001',
            type: '均价合同套保指令',
            status: '待完成',
            hedgePlan: '单单保值方案B',
            contract: 'CU2401',
            direction: '买入',
            requiredQty: 100,
            price: null,
            parentInstructionNo: null,
            createTime: '2025-11-24 09:00:00',
            initiator: '系统自动',
            // 详情数据
            detail: {
              contractNo: form.getFieldValue('contractNo') || 'HT2025-0001',
              contractQty: form.getFieldValue('qty') || 1000,
              contractPrice: form.getFieldValue('price') || 4670,
              exposureCoefficient: exposureCoefficient,
              futuresContract: 'CU2401',
              futuresDirection: '买入',
              futuresQty: 100,
              pricing: form.getFieldValue('pricing') === '均价' ? {
                method: '均价',
                avgStartDate: form.getFieldValue('avgDateRange')?.[0]?.format('YYYY-MM-DD'),
                avgEndDate: form.getFieldValue('avgDateRange')?.[1]?.format('YYYY-MM-DD')
              } : null,
              children: [],
              remarks: [
                { id: 1, author: '系统自动', content: '合同变更自动生成指令', time: '2025-11-24 09:00:00' }
              ],
              logs: [
                { id: 1, content: '指令创建', time: '2025-11-24 09:00:00' }
              ]
            }
          },
          {
            id: 'INS-002',
            instructionNo: 'INS-2025-002',
            type: '非均价合同变更指令',
            status: '待完成',
            hedgePlan: '整体保值方案A',
            contract: 'AL2401',
            direction: '卖出',
            requiredQty: 50,
            price: null,
            parentInstructionNo: 'INS-2025-000',
            createTime: '2025-11-24 10:30:00',
            initiator: '张三',
            // 详情数据
            detail: {
              contractNo: form.getFieldValue('contractNo') || 'HT2025-0002',
              contractQty: form.getFieldValue('qty') || 500,
              contractPrice: form.getFieldValue('price') || 4500,
              exposureCoefficient: exposureCoefficient,
              futuresContract: 'AL2401',
              futuresDirection: '卖出',
              futuresQty: 50,
              parentInstructionNo: 'INS-2025-000',
              pricing: null,
              children: [],
              remarks: [
                { id: 1, author: '张三', content: '合同数量变更，需要调整期货持仓', time: '2025-11-24 10:30:00' }
              ],
              logs: [
                { id: 1, content: '子指令创建', time: '2025-11-24 10:30:00' },
                { id: 2, content: '关联到父指令 INS-2025-000', time: '2025-11-24 10:30:00' }
              ]
            }
          }
        ] : [];
        
        setPendingInstructions(mockPendingInstructions);
      }, [form, exposureCoefficient]);
      
      // 打开指令详情
      const openInstructionDetail = (instruction) => {
        setSelectedInstruction(instruction);
        setInstructionDetailVisible(true);
      };
      
      // 监听合同编辑弹窗打开，查询未完成指令
      useEffect(() => {
        if (editModalVisible) {
          const contractId = form.getFieldValue('id');
          const hedgePlanId = form.getFieldValue('hedgePlan');
          const currentQty = form.getFieldValue('qty');
          
          if (contractId) {
            // 编辑模式：查询未完成指令
            fetchPendingInstructions(contractId, hedgePlanId);
            // 保存原始数量用于计算变更
            if (!form.getFieldValue('originalQty')) {
              form.setFieldsValue({ originalQty: currentQty || 0 });
            }
            // 计算预算
            if (currentQty) {
              calculateBudget(currentQty);
            }
          } else {
            // 创建模式：清空指令列表
            setPendingInstructions([]);
            setBudgetInfo(null);
          }
        } else {
          // 弹窗关闭时清空
          setPendingInstructions([]);
          setBudgetInfo(null);
        }
      }, [editModalVisible, form, fetchPendingInstructions, calculateBudget]);

      const handleSave = () => {
        form.validateFields().then(values => {
          const editingId = form.getFieldValue('id');
          
          // 处理日期字段
          const deliveryDate = values.deliveryDate ? values.deliveryDate.format('YYYY-MM-DD') : null;
          const priceDeadline = values.priceDeadline ? values.priceDeadline.format('YYYY-MM-DD') : null;
          const avgStartDate = values.avgDateRange && values.avgDateRange[0] ? values.avgDateRange[0].format('YYYY-MM-DD') : null;
          const avgEndDate = values.avgDateRange && values.avgDateRange[1] ? values.avgDateRange[1].format('YYYY-MM-DD') : null;
          const occurTime = values.occurTime ? values.occurTime.format('YYYY-MM-DD HH:mm:ss') : null;

          // 构建保存的数据对象
          const saveData = {
            hedgePlanId: values.hedgePlan,
            pricing: values.pricing,
            contractNo: values.contractNo,
            manager: values.manager || null,
            customerId: values.customer || null,
            spotType: values.spotType || null,
            brandId: values.brand || null,
            qty: values.qty || null,
            price: values.price || null,
            settlementPrice: values.settlementPrice || null,
            transport: values.transport || null,
            deliveryDate: deliveryDate,
            avgStartDate: avgStartDate,
            avgEndDate: avgEndDate,
            priceDeadline: priceDeadline,
            occurTime: occurTime,
            remark: values.remark || null,
            pricedQty: values.pricedQty || 0
          };

          // 这里应该调用API保存数据
          // 目前只是模拟保存成功
          if (editingId) {
            // 编辑模式
            console.log('更新合同数据:', { id: editingId, ...saveData });
            message.success('合同更新成功');
          } else {
            // 新增模式
            console.log('创建合同数据:', saveData);
            message.success('合同创建成功');
          }
          
          setEditModalVisible(false);
          form.resetFields();
          setPricingMode(null);
          setPendingInstructions([]);
          setBudgetInfo(null);
        }).catch(err => {
          console.error('表单验证失败:', err);
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <Form
              form={filterForm}
              layout="inline"
              onValuesChange={handleFilterValuesChange}
              initialValues={initialFilterValues}
              style={{ width: '100%' }}
            >
              <Space wrap style={{ flex: 1 }}>
                <Form.Item name="hedgePlanIds" label="保值方案">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 200 }}
                    options={hedgePlanOptions}
                  />
                </Form.Item>
                <Form.Item name="managerNames" label="业务经理">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 160 }}
                    options={managerOptions}
                  />
                </Form.Item>
                <Form.Item name="contractKeyword" label="合同编号">
                  <Input placeholder="支持模糊搜索" style={{ width: 170 }} allowClear />
                </Form.Item>
                <Form.Item name="customerIds" label={isPurchase ? '供应商' : '客户'}>
                  <Select
                    mode="multiple"
                    allowClear
                    style={{ width: 200 }}
                    placeholder="全部"
                    options={customerOptions}
                    showSearch
                    optionFilterProp="label"
                  />
                </Form.Item>
                <Form.Item name="spotTypes" label="现货品种">
                  <Select mode="multiple" allowClear style={{ width: 160 }} placeholder="全部" options={spotTypeOptions} />
                </Form.Item>
                <Form.Item name="brandIds" label="品牌">
                  <Select mode="multiple" allowClear style={{ width: 160 }} placeholder="全部" options={brandOptions} />
                </Form.Item>
                <Form.Item name="pricingModes" label="计价方式">
                  <Select mode="multiple" allowClear style={{ width: 150 }} placeholder="全部" options={pricingOptions} />
                </Form.Item>
                <Form.Item name="statuses" label="状态">
                  <Select mode="multiple" allowClear style={{ width: 150 }} placeholder="全部" options={statusOptions} />
                </Form.Item>
                <Form.Item name="pricedState" label="是否已定价">
                  <Select allowClear style={{ width: 140 }} options={boolSelectOptions} />
                </Form.Item>
                <Form.Item name="deliveredState" label="是否已交收">
                  <Select allowClear style={{ width: 140 }} options={boolSelectOptions} />
                </Form.Item>
                <Form.Item name="pricingWindowState" label="是否在定价期">
                  <Select allowClear style={{ width: 150 }} options={boolSelectOptions} />
                </Form.Item>
                <Form.Item name="createdRange" label="创建日期时间">
                  <DatePicker.RangePicker showTime />
                </Form.Item>
              </Space>
              <Space wrap>
                <Button icon={renderIcon('ReloadOutlined')} onClick={resetFilters}>重置</Button>
                <Button icon={renderIcon('FilterOutlined')} type="primary" ghost onClick={() => setFilterDrawerVisible(true)}>
                  高级筛选
                </Button>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                >
                  自定义列
                </Button>
              </Space>
            </Form>
          </div>
          <div className="erp-toolbar">
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>编辑（变更）</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} disabled={selectedRowKeys.length === 0}>取消</Button>
              <Button icon={renderIcon('LinkOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setLinkModalVisible(true)}>关联</Button>
              <Button icon={renderIcon('DisconnectOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setUnlinkModalVisible(true)}>解除关联</Button>
              <Button icon={renderIcon('DollarOutlined')} disabled={selectedRowKeys.length !== 1} onClick={() => setPriceModalVisible(true)}>点价</Button>
              <Button icon={renderIcon('PoweroffOutlined')}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredContracts}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Drawer
            title="高级筛选"
            width={420}
            open={filterDrawerVisible}
            onClose={() => setFilterDrawerVisible(false)}
          >
            <Form form={filterForm} layout="vertical" onValuesChange={handleFilterValuesChange}>
              <Form.Item label="合同数量" name="contractQtyRange">
                <NumberRangeInput unit="吨" />
              </Form.Item>
              <Form.Item label="单价" name="priceRange">
                <NumberRangeInput unit="元/吨" />
              </Form.Item>
              <Form.Item label="结算单价" name="settlementPriceRange">
                <NumberRangeInput unit="元/吨" />
              </Form.Item>
              <Form.Item label="运输方式" name="transportModes">
                <Select mode="multiple" allowClear placeholder="全部" options={transportOptions} />
              </Form.Item>
              <Form.Item label="发生日期时间" name="occurRange">
                <DatePicker.RangePicker showTime />
              </Form.Item>
              <Form.Item label="均价起止日" name="avgRange">
                <DatePicker.RangePicker />
              </Form.Item>
              <Form.Item label="点价截止日" name="priceDeadlineRange">
                <DatePicker.RangePicker />
              </Form.Item>
              <Form.Item label="交割日期" name="deliveryRange">
                <DatePicker.RangePicker />
              </Form.Item>
              <Form.Item label="创建人" name="creatorNames">
                <Select mode="multiple" allowClear placeholder="全部" options={creatorOptions} />
              </Form.Item>
              <Form.Item label="自定义字段关键字" name="customFieldKeyword">
                <Input placeholder="输入关键字，匹配自定义字段的值" allowClear />
              </Form.Item>
              <Alert
                type="info"
                showIcon
                message="自定义字段默认不显示在筛选栏，可在此输入关键字进行模糊过滤。"
              />
            </Form>
          </Drawer>
          <Modal
            {...MODAL_TEXTS}
            title="关联"
            open={linkModalVisible}
            onCancel={() => setLinkModalVisible(false)}
            width={1200}
            style={{ top: 20 }}
            bodyStyle={{ padding: '24px', paddingBottom: 0, height: 700, display: 'flex', flexDirection: 'column' }}
            className="link-modal-container"
            footer={[
              <Button key="cancel" onClick={() => setLinkModalVisible(false)}>取消</Button>,
              <Button key="confirm" type="primary">确认</Button>
            ]}
          >
            <Tabs className="erp-fill-tabs" tabBarStyle={{ marginBottom: 16 }}>
              <Tabs.TabPane tab="期现关联" key="futures">
                <div style={{ display: 'flex', flexDirection: 'column', height: '100%', minHeight: 0 }}>
                  <div className="erp-filter-bar" style={{ flexShrink: 0, marginBottom: 16 }}>
                    <div className="erp-filter-item">
                      <label>合约：</label>
                      <Input style={{ width: 150 }} />
                    </div>
                    <div className="erp-filter-item">
                      <label>成交日期：</label>
                      <DatePicker.RangePicker />
                    </div>
                    <div className="erp-filter-item">
                      <label>价格：</label>
                      <InputNumber style={{ width: 150 }} />
                    </div>
                  </div>
                  <div className="link-modal-table-wrapper">
                    <Table
                      className="link-modal-table"
                      bordered={false}
                      columns={[
                        { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                        { title: '账户', dataIndex: 'account', width: 120 },
                        { title: '合约', dataIndex: 'contract', width: 100 },
                        { title: '买卖', dataIndex: 'direction', width: 80 },
                        { title: '开平', dataIndex: 'openClose', width: 80 },
                        { title: '成交日期', dataIndex: 'date', width: 120 },
                        { title: '价格', dataIndex: 'price', width: 100, align: 'right' },
                        { title: '期货数量', dataIndex: 'futuresQty', width: 100, render: () => <InputNumber style={{ width: 100 }} /> },
                        { title: '合同数量', dataIndex: 'contractQty', width: 100, render: () => <InputNumber style={{ width: 100 }} /> },
                        { title: '发生时间', dataIndex: 'occurTime', width: 180, render: () => <DatePicker showTime style={{ width: '100%' }} /> }
                      ]}
                      dataSource={[]}
                      pagination={false}
                      scroll={{ y: 600 }}
                      size="small"
                    />
                  </div>
                </div>
              </Tabs.TabPane>
              <Tabs.TabPane tab="采销关联" key="sales">
                <div style={{ display: 'flex', flexDirection: 'column', height: '100%', minHeight: 0 }}>
                  <div className="erp-filter-bar" style={{ flexShrink: 0, marginBottom: 16 }}>
                    <div className="erp-filter-item">
                      <label>合同编号：</label>
                      <Input style={{ width: 150 }} />
                    </div>
                    <div className="erp-filter-item">
                      <label>客商：</label>
                      <Input style={{ width: 150 }} />
                    </div>
                    <div className="erp-filter-item">
                      <label>业务经理：</label>
                      <Input style={{ width: 150 }} />
                    </div>
                  </div>
                  <div className="link-modal-table-wrapper">
                    <Table
                      className="link-modal-table"
                      bordered={false}
                      columns={[
                        { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                        { title: '合同编号', dataIndex: 'contractNo', width: 160 },
                        { title: '客商', dataIndex: 'customer', width: 150 },
                        { title: '数量', dataIndex: 'qty', width: 100, render: () => <InputNumber style={{ width: 100 }} /> },
                        { title: '发生时间', dataIndex: 'occurTime', width: 180, render: () => <DatePicker showTime style={{ width: '100%' }} /> }
                      ]}
                      dataSource={[]}
                      pagination={false}
                      scroll={{ y: 600 }}
                      size="small"
                    />
                  </div>
                </div>
              </Tabs.TabPane>
            </Tabs>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title="解除关联"
            open={unlinkModalVisible}
            onCancel={() => setUnlinkModalVisible(false)}
            width={900}
          >
            <Tabs>
              <Tabs.TabPane tab="解除期现关联" key="futures">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>关联日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>合约：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>成交日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合约', dataIndex: 'contract' },
                    { title: '成交日期', dataIndex: 'date' },
                    { title: '解除期货数量', dataIndex: 'futuresQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '解除合同数量', dataIndex: 'contractQty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生日期时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setUnlinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
              <Tabs.TabPane tab="解除采销关联" key="sales">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>关联日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>合同编号：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>客商：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>业务经理：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合同编号', dataIndex: 'contractNo' },
                    { title: '客商', dataIndex: 'customer' },
                    { title: '解除数量', dataIndex: 'qty', render: () => <InputNumber style={{ width: 100 }} /> },
                    { title: '发生日期时间', dataIndex: 'occurTime', render: () => <DatePicker showTime /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
                <Space style={{ marginTop: 16 }}>
                  <Button type="primary">确认</Button>
                  <Button onClick={() => setUnlinkModalVisible(false)}>取消</Button>
                </Space>
              </Tabs.TabPane>
            </Tabs>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title={isPurchase ? "采销关系" : "采购关系"}
            open={salesRelationModalVisible}
            onCancel={() => {
              setSalesRelationModalVisible(false);
              setSelectedContractForSalesRelation(null);
              setRelationDetailDrawer({ visible: false, record: null });
            }}
            width={1000}
            style={{ top: 20 }}
            bodyStyle={{ padding: '24px', paddingBottom: 0 }}
            footer={null}
          >
            {selectedContractForSalesRelation ? (
              <div style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
                <div style={{ marginBottom: 16, padding: 12, backgroundColor: '#f5f5f5', borderRadius: 4 }}>
                  <Space direction="vertical" size={4}>
                    <span>
                      <strong>{isPurchase ? '采购合同' : '销售合同'}：</strong>
                      {selectedContractForSalesRelation.contractNo}
                    </span>
                    <span>
                      <strong>{isPurchase ? '供应商' : '客户'}：</strong>
                      {selectedContractForSalesRelation.customer}
                    </span>
                    <span>
                      <strong>合同数量：</strong>
                      {formatQuantity(selectedContractForSalesRelation.qty)}
                    </span>
                  </Space>
                </div>
                <div style={{ marginBottom: 16, padding: 12, backgroundColor: '#f7f8fa', borderRadius: 8 }}>
                  <Space split={<Divider type="vertical" />} wrap>
                    <span>合同表显示：{formatQuantity(currentContractRelationQty)} 吨</span>
                    <span>弹窗合计：{formatQuantity(relationTotalQty)} 吨</span>
                  </Space>
                  {relationMismatch && (
                    <Alert
                      type="error"
                      showIcon
                      style={{ marginTop: 12 }}
                      message="采销关联数量不一致"
                      description="请刷新数据或联系管理员进行核对。"
                    />
                  )}
                </div>
                <Table
                  columns={[
                    {
                      title: '采销关联编号',
                      dataIndex: 'relationId',
                      width: 180,
                      render: (text, record) => (
                        <Button
                          type="link"
                          size="small"
                          onClick={() => setRelationDetailDrawer({ visible: true, record })}
                        >
                          {text}
                        </Button>
                      )
                    },
                    { title: '合同编号', dataIndex: 'contractNo', width: 160 },
                    { title: isPurchase ? '客户' : '供应商', dataIndex: 'customer', width: 150 },
                    { title: '业务经理', dataIndex: 'manager', width: 120 },
                    { title: '关联数量', dataIndex: 'relatedQty', width: 120, align: 'right', render: formatQuantity },
                    { title: '关联日期', dataIndex: 'relatedDate', width: 140 },
                    { title: '发生日期时间', dataIndex: 'occurTime', width: 180 }
                  ]}
                  dataSource={salesRelationList}
                  pagination={{ pageSize: 20 }}
                  scroll={{ y: 500 }}
                  size="small"
                  rowKey="relationId"
                  style={{ marginBottom: 0 }}
                  locale={{ emptyText: <Empty description="暂无采销关联" /> }}
                />
              </div>
            ) : (
              <Empty description="未选择合同" />
            )}
          </Modal>
          <Drawer
            title="采销关联详情"
            width={520}
            open={relationDetailDrawer.visible}
            onClose={() => setRelationDetailDrawer({ visible: false, record: null })}
            destroyOnClose
          >
            {relationDetailDrawer.record ? (
              <div>
                <Alert
                  type="info"
                  showIcon
                  message={`当前从${isPurchase ? '采购合同' : '销售合同'}视角查看关联`}
                  style={{ marginBottom: 16 }}
                />
                <Descriptions size="small" column={1} bordered>
                  <Descriptions.Item label="采销关联编号">{relationDetailDrawer.record.relationId}</Descriptions.Item>
                  <Descriptions.Item label="关联数量">
                    {formatQuantity(relationDetailDrawer.record.relatedQty)} 吨
                  </Descriptions.Item>
                  <Descriptions.Item label="关联日期">{relationDetailDrawer.record.relatedDate || '-'}</Descriptions.Item>
                  <Descriptions.Item label="发生日期时间">{relationDetailDrawer.record.occurTime || '-'}</Descriptions.Item>
                  <Descriptions.Item label="记录人">{relationDetailDrawer.record.creator || '-'}</Descriptions.Item>
                  <Descriptions.Item label="备注">{relationDetailDrawer.record.remark || '-'}</Descriptions.Item>
                </Descriptions>
                <Divider orientation="left" style={{ marginTop: 16 }}>采购合同</Divider>
                <Descriptions size="small" column={1} bordered>
                  <Descriptions.Item label="合同编号">{relationDetailDrawer.record.purchaseContractNo || '-'}</Descriptions.Item>
                  <Descriptions.Item label="客商">{relationDetailDrawer.record.purchaseCustomer || '-'}</Descriptions.Item>
                  <Descriptions.Item label="业务经理">{relationDetailDrawer.record.purchaseManager || '-'}</Descriptions.Item>
                </Descriptions>
                <Divider orientation="left" style={{ marginTop: 16 }}>销售合同</Divider>
                <Descriptions size="small" column={1} bordered>
                  <Descriptions.Item label="合同编号">{relationDetailDrawer.record.salesContractNo || '-'}</Descriptions.Item>
                  <Descriptions.Item label="客商">{relationDetailDrawer.record.salesCustomer || '-'}</Descriptions.Item>
                  <Descriptions.Item label="业务经理">{relationDetailDrawer.record.salesManager || '-'}</Descriptions.Item>
                </Descriptions>
              </div>
            ) : (
              <Empty description="未选择采销关联" />
            )}
          </Drawer>
          <Modal
            {...MODAL_TEXTS}
            title="点价"
            open={priceModalVisible}
            onCancel={() => setPriceModalVisible(false)}
            width={800}
          >
            <Form layout="vertical">
              <Form.Item label="点价数量" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="点价价格" required><InputNumber style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="发生日期时间" required><DatePicker showTime style={{ width: '100%' }} /></Form.Item>
              <Form.Item label="期货委托表">
                <div className="erp-filter-bar">
                  <div className="erp-filter-item">
                    <label>合约：</label>
                    <Input style={{ width: 150 }} />
                  </div>
                  <div className="erp-filter-item">
                    <label>成交日期：</label>
                    <DatePicker.RangePicker />
                  </div>
                  <div className="erp-filter-item">
                    <label>价格：</label>
                    <InputNumber style={{ width: 150 }} />
                  </div>
                </div>
                <Table
                  columns={[
                    { title: '选择', dataIndex: 'select', render: () => <Checkbox /> },
                    { title: '合约', dataIndex: 'contract' },
                    { title: '成交日期', dataIndex: 'date' },
                    { title: '价格', dataIndex: 'price' },
                    { title: '期货数量', dataIndex: 'futuresQty', render: () => <InputNumber style={{ width: 100 }} /> }
                  ]}
                  dataSource={[]}
                  pagination={false}
                />
              </Form.Item>
              <Space style={{ marginTop: 16 }}>
                <Button type="primary">确认</Button>
                <Button onClick={() => setPriceModalVisible(false)}>取消</Button>
              </Space>
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title={form.getFieldValue('id') ? '编辑合同' : '创建合同'}
            open={editModalVisible}
            onCancel={() => { 
              setEditModalVisible(false); 
              form.resetFields();
              setPricingMode(null);
            }}
            width={800}
            onOk={handleSave}
          >
            <Form form={form} layout="vertical">
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item label="保值方案" name="hedgePlan" required rules={[{ required: true, message: '请选择保值方案' }]}>
                    <Select options={hedgePlanOptions} placeholder="请选择保值方案" />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="业务经理" name="manager">
                    <Select options={managerOptions} placeholder="请选择业务经理（选填）" allowClear />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="合同编号" name="contractNo" required rules={[{ required: true, message: '请输入合同编号' }]}>
                    <Input placeholder="请输入合同编号" disabled={!!form.getFieldValue('id')} />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item label={contractType === 'purchase' ? '供应商' : '客户'} name="customer">
                    <Select options={customerOptions} placeholder={`请选择${contractType === 'purchase' ? '供应商' : '客户'}（选填）`} showSearch optionFilterProp="label" allowClear />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="现货品种" name="spotType">
                    <Select options={spotTypeOptions} placeholder="请选择现货品种（选填）" allowClear />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="品牌" name="brand">
                    <Select options={brandOptions} placeholder="请选择品牌（选填）" allowClear />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item label="计价方式" name="pricing" required rules={[{ required: true, message: '请选择计价方式' }]}>
                    <Select 
                      options={pricingOptions} 
                      placeholder="请选择计价方式"
                      onChange={(value) => {
                        setPricingMode(value);
                        // 切换计价方式时，清空相关字段
                        if (value !== '均价') {
                          form.setFieldsValue({ avgDateRange: null });
                        }
                        if (value !== '暂定价') {
                          form.setFieldsValue({ priceDeadline: null, pricedQty: 0 });
                        }
                      }}
                    />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="合同数量" name="qty" rules={[{ type: 'number', min: 0.01, message: '合同数量必须大于0' }]}>
                    <InputNumber 
                      style={{ width: '100%' }} 
                      placeholder="请输入合同数量（选填）" 
                      min={0.01} 
                      step={0.01}
                      onChange={(value) => {
                        // 实时计算预算
                        calculateBudget(value);
                      }}
                    />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="单价" name="price" rules={[{ type: 'number', min: 0, message: '单价不能为负数' }]}>
                    <InputNumber style={{ width: '100%' }} placeholder="请输入单价（选填）" min={0} step={0.01} />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item label="结算单价" name="settlementPrice" rules={[{ type: 'number', min: 0, message: '结算单价不能为负数' }]}>
                    <InputNumber style={{ width: '100%' }} placeholder="请输入结算单价（选填）" min={0} step={0.01} />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="运输方式" name="transport">
                    <Select options={transportOptions} placeholder="请选择运输方式（选填）" allowClear />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item 
                    label="发生日期时间" 
                    name="occurTime"
                    extra={<div style={{ fontSize: '12px', color: '#8a94a6' }}>不填写时，系统将使用创建日期时间</div>}
                  >
                    <DatePicker showTime style={{ width: '100%' }} placeholder="请选择发生日期时间（选填）" format="YYYY-MM-DD HH:mm:ss" />
                  </Form.Item>
                </Col>
              </Row>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item 
                    label="交割日期" 
                    name="deliveryDate"
                    extra={<div style={{ fontSize: '12px', color: '#8a94a6' }}>不填写时，无法自动交收</div>}
                  >
                    <DatePicker style={{ width: '100%' }} placeholder="请选择交割日期（选填）" />
                  </Form.Item>
                </Col>
                {pricingMode === '暂定价' && (
                  <>
                    <Col span={8}>
                      <Form.Item 
                        label="点价截止日" 
                        name="priceDeadline"
                        extra={<div style={{ fontSize: '12px', color: '#8a94a6' }}>不填写时，无法进行自助点价操作</div>}
                      >
                        <DatePicker style={{ width: '100%' }} placeholder="请选择点价截止日（选填）" />
                      </Form.Item>
                    </Col>
                    <Col span={8}>
                      <Form.Item 
                        label="已点数量" 
                        name="pricedQty"
                        rules={[{ type: 'number', min: 0, message: '已点数量不能为负数' }]}
                        extra={<div style={{ fontSize: '12px', color: '#8a94a6' }}>点价合同的基础信息，初始为0</div>}
                      >
                        <InputNumber style={{ width: '100%' }} placeholder="已点数量" min={0} step={0.01} disabled={!!form.getFieldValue('id')} />
                      </Form.Item>
                    </Col>
                  </>
                )}
              </Row>
              {pricingMode === '均价' && (
                <Row gutter={16}>
                  <Col span={16}>
                    <Form.Item 
                      label="均价起止日" 
                      name="avgDateRange"
                      extra={<div style={{ fontSize: '12px', color: '#8a94a6' }}>不填写时，无法进行均价计算（需要敞口配置支持）</div>}
                    >
                      <DatePicker.RangePicker style={{ width: '100%' }} placeholder={['开始日期', '结束日期']} />
                    </Form.Item>
                  </Col>
                </Row>
              )}
              <Row gutter={16}>
                <Col span={24}>
                  <Form.Item label="备注" name="remark">
                    <Input.TextArea rows={3} placeholder="请输入备注信息（选填）" />
                  </Form.Item>
                </Col>
              </Row>
              
              {/* 自定义字段区域 - 这些字段由管理员在"全局设置 > 自定义字段配置"中动态配置 */}
              <Divider orientation="left" style={{ marginTop: 16, marginBottom: 16 }}>自定义字段</Divider>
              
              {/* 
                示例：可选仓库（下拉选择类型 - select）
                字段类型：下拉选择（select）
                配置说明：在自定义字段配置中，字段类型选择"下拉选择"，选项列表配置为：
                  - 仓库A
                  - 仓库B
                  - 仓库C
                  - 仓库D
                  - 仓库E
                实际实现时，这些选项会从自定义字段定义中动态加载
              */}
              <Form.Item label="可选仓库" name="customWarehouse">
                <Select placeholder="请选择仓库">
                  <Select.Option value="warehouse_a">仓库A</Select.Option>
                  <Select.Option value="warehouse_b">仓库B</Select.Option>
                  <Select.Option value="warehouse_c">仓库C</Select.Option>
                  <Select.Option value="warehouse_d">仓库D</Select.Option>
                  <Select.Option value="warehouse_e">仓库E</Select.Option>
                </Select>
              </Form.Item>
              
              {/* 
                示例：可选仓库（多选下拉类型 - multiselect）
                如果管理员在配置时将字段类型设置为"多选下拉"，则显示为多选模式
                字段类型：多选下拉（multiselect）
                实际实现时，根据字段定义中的类型动态渲染为单选或多选
              */}
              {/* <Form.Item label="可选仓库（多选）" name="customWarehouseMultiple">
                <Select mode="multiple" placeholder="请选择仓库（可多选）">
                  <Select.Option value="warehouse_a">仓库A</Select.Option>
                  <Select.Option value="warehouse_b">仓库B</Select.Option>
                  <Select.Option value="warehouse_c">仓库C</Select.Option>
                  <Select.Option value="warehouse_d">仓库D</Select.Option>
                  <Select.Option value="warehouse_e">仓库E</Select.Option>
                </Select>
              </Form.Item> */}
              
              {/* 
                注意：实际实现时，自定义字段应该根据当前实体的自定义字段定义动态渲染
                系统需要：
                1. 查询合同实体的所有启用的自定义字段定义
                2. 根据字段类型动态渲染对应的表单控件
                3. 支持字段的排序、分组显示
                4. 根据字段定义中的"是否必填"属性设置表单验证规则
              */}
              
              {/* 预算变更影响显示区域 */}
              {budgetInfo && (
                <>
                  <Divider orientation="left" style={{ marginTop: 24, marginBottom: 16 }}>变更影响预算</Divider>
                  <div style={{ 
                    padding: '16px', 
                    background: budgetInfo.changeQty !== 0 ? '#fffbe6' : '#e6f7ff',
                    border: `1px solid ${budgetInfo.changeQty !== 0 ? '#ffe58f' : '#91d5ff'}`,
                    borderRadius: '6px',
                    marginBottom: 16
                  }}>
                    <Row gutter={16}>
                      {form.getFieldValue('id') && (
                        <Col span={12}>
                          <div style={{ marginBottom: 8 }}>
                            <span style={{ color: '#8a94a6', fontSize: '13px' }}>变更前合同数量：</span>
                            <span style={{ fontWeight: 500, marginLeft: 8 }}>{budgetInfo.oldQty || 0}</span>
                          </div>
                        </Col>
                      )}
                      <Col span={12}>
                        <div style={{ marginBottom: 8 }}>
                          <span style={{ color: '#8a94a6', fontSize: '13px' }}>变更后合同数量：</span>
                          <span style={{ fontWeight: 500, marginLeft: 8 }}>{budgetInfo.newQty || 0}</span>
                        </div>
                      </Col>
                      <Col span={12}>
                        <div style={{ marginBottom: 8 }}>
                          <span style={{ color: '#8a94a6', fontSize: '13px' }}>变更数量：</span>
                          <span style={{ 
                            fontWeight: 500, 
                            marginLeft: 8,
                            color: budgetInfo.changeQty > 0 ? '#52c41a' : budgetInfo.changeQty < 0 ? '#ff4d4f' : '#8a94a6'
                          }}>
                            {budgetInfo.changeQty > 0 ? '+' : ''}{budgetInfo.changeQty} ({budgetInfo.direction})
                          </span>
                        </div>
                      </Col>
                      <Col span={12}>
                        <div style={{ marginBottom: 8 }}>
                          <span style={{ color: '#8a94a6', fontSize: '13px' }}>敞口系数：</span>
                          <span style={{ fontWeight: 500, marginLeft: 8 }}>{budgetInfo.coefficient}</span>
                        </div>
                      </Col>
                      <Col span={24}>
                        <div style={{ marginBottom: 8 }}>
                          <span style={{ color: '#8a94a6', fontSize: '13px' }}>变更所需期货数量：</span>
                          <span style={{ 
                            fontWeight: 600, 
                            marginLeft: 8,
                            fontSize: '15px',
                            color: budgetInfo.requiredFutures > 0 ? '#52c41a' : budgetInfo.requiredFutures < 0 ? '#ff4d4f' : '#8a94a6'
                          }}>
                            {budgetInfo.requiredFutures > 0 ? '+' : ''}{budgetInfo.requiredFutures.toFixed(2)} 手 ({budgetInfo.futuresDirection})
                          </span>
                        </div>
                      </Col>
                      {pendingInstructions.length > 0 && (
                        <Col span={24}>
                          <div style={{ marginTop: 12, paddingTop: 12, borderTop: '1px solid #e8e8e8' }}>
                            <div style={{ color: '#8a94a6', fontSize: '13px', marginBottom: 8 }}>影响的指令：</div>
                            <div style={{ fontSize: '13px' }}>
                              {pendingInstructions.map(inst => (
                                <Tag key={inst.id} color="blue" style={{ marginBottom: 4 }}>
                                  {inst.instructionNo} ({inst.type})
                                </Tag>
                              ))}
                            </div>
                          </div>
                        </Col>
                      )}
                    </Row>
                  </div>
                </>
              )}
              
              {/* 未完成指令显示区域 */}
              {pendingInstructions.length > 0 && (
                <>
                  <Divider orientation="left" style={{ marginTop: 24, marginBottom: 16 }}>未完成相关指令</Divider>
                  <Collapse 
                    defaultActiveKey={['1']}
                    items={[{
                      key: '1',
                      label: `未完成指令 (${pendingInstructions.length}条)`,
                      children: (
                        <Table
                          dataSource={pendingInstructions}
                          rowKey="id"
                          size="small"
                          pagination={false}
                          columns={[
                            {
                              title: '指令编号',
                              dataIndex: 'instructionNo',
                              width: 150,
                              render: (text) => <span style={{ fontFamily: 'monospace' }}>{text}</span>
                            },
                            {
                              title: '指令类型',
                              dataIndex: 'type',
                              width: 180
                            },
                            {
                              title: '指令状态',
                              dataIndex: 'status',
                              width: 100,
                              render: (status) => {
                                const color = status === '待完成' ? 'blue' : status === '撤销待处理' ? 'orange' : 'default';
                                return <Tag color={color}>{status}</Tag>;
                              }
                            },
                            {
                              title: '保值方案',
                              dataIndex: 'hedgePlan',
                              width: 150
                            },
                            {
                              title: '期货要求',
                              width: 200,
                              render: (_, record) => (
                                <div>
                                  <div>合约：{record.contract}</div>
                                  <div>方向：{record.direction}</div>
                                  <div>数量：{record.requiredQty}手</div>
                                  {record.price && <div>价格：{record.price}</div>}
                                </div>
                              )
                            },
                            {
                              title: '父指令',
                              dataIndex: 'parentInstructionNo',
                              width: 150,
                              render: (text) => text ? <span style={{ fontFamily: 'monospace', color: '#8a94a6' }}>{text}</span> : '-'
                            },
                            {
                              title: '创建时间',
                              dataIndex: 'createTime',
                              width: 160
                            },
                            {
                              title: '发起人',
                              dataIndex: 'initiator',
                              width: 100
                            },
                            {
                              title: '操作',
                              width: 150,
                              fixed: 'right',
                              render: (_, record) => (
                                <Space size="small">
                                  <Button 
                                    type="link" 
                                    size="small"
                                    onClick={() => {
                                      openInstructionDetail(record);
                                    }}
                                  >
                                    查看详情
                                  </Button>
                                  {record.status === '待完成' && (
                                    <Button 
                                      type="link" 
                                      size="small"
                                      danger
                                      onClick={() => {
                                        Modal.confirm({
                                          title: '确认撤销指令',
                                          content: `确定要撤销指令 ${record.instructionNo} 吗？`,
                                          onOk: () => {
                                            message.success('指令撤销成功');
                                            // 重新查询指令列表
                                            fetchPendingInstructions(form.getFieldValue('id'), form.getFieldValue('hedgePlan'));
                                          }
                                        });
                                      }}
                                    >
                                      撤销
                                    </Button>
                                  )}
                                </Space>
                              )
                            }
                          ]}
                        />
                      )
                    }]}
                  />
                </>
              )}
            </Form>
          </Modal>
          <Modal
            {...MODAL_TEXTS}
            title={
              detailModal.type === 'customer'
                ? '客商详情'
                : detailModal.type === 'brand'
                  ? '品牌详情'
                  : '合同详情'
            }
            open={detailModal.visible}
            onCancel={closeDetailModal}
            footer={null}
            width={detailModal.type === 'contract' ? 900 : 620}
          >
            {renderDetailModalContent()}
          </Modal>
          
          {/* 指令详情弹窗 */}
          <Drawer
            title={selectedInstruction ? `指令详情 · ${selectedInstruction.instructionNo}` : '指令详情'}
            placement="right"
            width={720}
            open={instructionDetailVisible}
            onClose={() => {
              setInstructionDetailVisible(false);
              setSelectedInstruction(null);
            }}
          >
            {selectedInstruction && selectedInstruction.detail ? (
              <Space direction="vertical" size={16} style={{ width: '100%' }}>
                <Card size="small" title="基础信息">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="指令编号">{selectedInstruction.instructionNo}</Descriptions.Item>
                    <Descriptions.Item label="指令类型">{selectedInstruction.type}</Descriptions.Item>
                    <Descriptions.Item label="指令状态">
                      <Tag color={selectedInstruction.status === '待完成' ? 'blue' : selectedInstruction.status === '撤销待处理' ? 'orange' : 'default'}>
                        {selectedInstruction.status}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="保值方案">{selectedInstruction.hedgePlan}</Descriptions.Item>
                    <Descriptions.Item label="发起人">{selectedInstruction.initiator}</Descriptions.Item>
                    <Descriptions.Item label="创建时间">{selectedInstruction.createTime}</Descriptions.Item>
                    {selectedInstruction.parentInstructionNo && (
                      <Descriptions.Item label="父指令编号" span={2}>
                        <span style={{ fontFamily: 'monospace' }}>{selectedInstruction.parentInstructionNo}</span>
                      </Descriptions.Item>
                    )}
                  </Descriptions>
                </Card>
                
                <Card size="small" title="合同信息">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="合同编号">{selectedInstruction.detail.contractNo || '-'}</Descriptions.Item>
                    <Descriptions.Item label="合同数量">{selectedInstruction.detail.contractQty || 0} 吨</Descriptions.Item>
                    <Descriptions.Item label="合同价格">{selectedInstruction.detail.contractPrice || '-'}</Descriptions.Item>
                    <Descriptions.Item label="敞口系数">{selectedInstruction.detail.exposureCoefficient || 1.0}</Descriptions.Item>
                  </Descriptions>
                </Card>
                
                <Card size="small" title="期货要求">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="合约代码">{selectedInstruction.contract || selectedInstruction.detail.futuresContract}</Descriptions.Item>
                    <Descriptions.Item label="买卖方向">
                      <Tag color={selectedInstruction.direction === '买入' ? 'red' : 'green'}>
                        {selectedInstruction.direction}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="所需数量">{selectedInstruction.requiredQty || selectedInstruction.detail.futuresQty} 手</Descriptions.Item>
                    {selectedInstruction.price && (
                      <Descriptions.Item label="价格要求">{selectedInstruction.price}</Descriptions.Item>
                    )}
                  </Descriptions>
                </Card>
                
                {selectedInstruction.detail.pricing && (
                  <Card size="small" title="计价信息">
                    <Descriptions column={2} size="small" bordered>
                      <Descriptions.Item label="计价方式">{selectedInstruction.detail.pricing.method || '-'}</Descriptions.Item>
                      {selectedInstruction.detail.pricing.avgStartDate && (
                        <Descriptions.Item label="均价起始日">{selectedInstruction.detail.pricing.avgStartDate}</Descriptions.Item>
                      )}
                      {selectedInstruction.detail.pricing.avgEndDate && (
                        <Descriptions.Item label="均价结束日">{selectedInstruction.detail.pricing.avgEndDate}</Descriptions.Item>
                      )}
                    </Descriptions>
                  </Card>
                )}
                
                {selectedInstruction.detail.children && selectedInstruction.detail.children.length > 0 && (
                  <Card size="small" title="子指令">
                    <Table
                      size="small"
                      columns={[
                        { title: '子指令ID', dataIndex: 'id', width: 130 },
                        { title: '类型', dataIndex: 'type', width: 140 },
                        { title: '状态', dataIndex: 'status', width: 100 },
                        { title: '操作人', dataIndex: 'operator', width: 100 },
                        { title: '方向', dataIndex: 'direction', width: 70 },
                        { title: '影响手数', dataIndex: 'qty', width: 90 }
                      ]}
                      dataSource={selectedInstruction.detail.children.map(child => ({ key: child.id, ...child }))}
                      pagination={false}
                    />
                  </Card>
                )}
                
                {selectedInstruction.detail.logs && selectedInstruction.detail.logs.length > 0 && (
                  <Card size="small" title="操作日志">
                    <Timeline
                      size="small"
                      items={selectedInstruction.detail.logs.map(log => ({
                        children: (
                          <div>
                            <div style={{ color: '#8a94a6', fontSize: '12px' }}>{log.time}</div>
                            <div>{log.content}</div>
                          </div>
                        )
                      }))}
                    />
                  </Card>
                )}
                
                {selectedInstruction.detail.remarks && selectedInstruction.detail.remarks.length > 0 && (
                  <Card size="small" title="备注信息">
                    <List
                      size="small"
                      dataSource={selectedInstruction.detail.remarks}
                      renderItem={(item) => (
                        <List.Item>
                          <Space direction="vertical" size={4} style={{ width: '100%' }}>
                            <div>
                              <strong>{item.author}</strong>
                              <span style={{ color: '#8a94a6', fontSize: '12px', marginLeft: 8 }}>{item.time}</span>
                            </div>
                            <div>{item.content}</div>
                          </Space>
                        </List.Item>
                      )}
                    />
                  </Card>
                )}
              </Space>
            ) : (
              <Empty description="暂无指令详情" />
            )}
          </Drawer>
          
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={contractVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 指令工作台页面
    const InstructionWorkbench = ({ initialRole }) => {
      const [role, setRole] = useState(initialRole || 'trader');
      const [viewFilter, setViewFilter] = useState(null); // 替代树节点，用于筛选视图
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [statusDetailVisible, setStatusDetailVisible] = useState(false);
      const [currentInstruction, setCurrentInstruction] = useState(null);
      const [instructionDetailVisible, setInstructionDetailVisible] = useState(false);
      const [selectedInstructionDetail, setSelectedInstructionDetail] = useState(null);
      const [remarkForm] = Form.useForm();
      const [filters, setFilters] = useState({ hedgePlan: '', instructionType: '', status: '', dateRange: null });

      // 根据角色获取视图筛选选项
      const viewFilterOptions = useMemo(() => {
        if (role === 'trader') {
          return [
            { value: 'my-initiated', label: '我发起的交易指令' },
            { value: 'all', label: '所有交易指令' },
            { value: 'my-claimed', label: '我认领的交易指令' }
          ];
        } else if (role === 'manager') {
          return [
            { value: 'my-initiated', label: '我发起的指令' },
            { value: 'related', label: '与我相关的指令' }
          ];
        } else if (role === 'maker') {
          return [
            { value: 'my-initiated', label: '我发起的指令' },
            { value: 'all', label: '所有指令' }
          ];
        } else if (role === 'clerk') {
          return [
            { value: 'all', label: '所有合同指令' },
            { value: 'my-claimed', label: '我认领的指令' }
          ];
        }
        return [];
      }, [role]);

      // 根据视图筛选和角色过滤数据
      const filteredInstructions = useMemo(() => {
        let data = [...mockInstructions];
        
        // 根据角色和视图筛选过滤
        if (role === 'trader') {
          if (viewFilter === 'my-initiated') {
            data = data.filter(item => item.creator === '张三'); // 假设当前用户是张三
          } else if (viewFilter === 'my-claimed') {
            data = data.filter(item => item.claimPerson === '交易员A'); // 假设当前用户是交易员A
          }
          // all 显示所有交易指令
          data = data.filter(item => item.futuresRequirement !== null);
        } else if (role === 'manager') {
          // 默认视图按“我发起的指令”处理
          const vf = viewFilter || 'my-initiated';
          if (vf === 'my-initiated') {
            // 业务经理只看到自己发起的子指令（示例：creator 为王五，且存在父指令编号）
            data = data.filter(item => item.creator === '王五' && item.parentInstructionNo);
          } else if (vf === 'related') {
            // 与我相关的指令（这里简化处理，实际应该根据业务逻辑判断）
            data = data.filter(item => item.contractInfo && item.contractInfo.businessManager === '王五');
          }
        } else if (role === 'maker') {
          if (viewFilter === 'my-initiated') {
            data = data.filter(item => item.creator === '李四'); // 假设当前用户是李四
          }
          // all 显示所有指令
        } else if (role === 'clerk') {
          if (viewFilter === 'my-claimed') {
            data = data.filter(item => item.claimPerson === '制单员B'); // 假设当前用户是制单员B
          }
          // all 显示所有合同指令
          data = data.filter(item => item.contractRequirement !== null);
        } else if (role === 'customer') {
          // 客商只显示自己发起的指令
          data = data.filter(item => item.creator === '供应商A'); // 假设当前客商是供应商A
        }

        // 应用筛选条件
        if (filters.hedgePlan) {
          data = data.filter(item => item.hedgePlan.includes(filters.hedgePlan));
        }
        if (filters.instructionType) {
          data = data.filter(item => item.instructionType === filters.instructionType);
        }
        if (filters.status) {
          data = data.filter(item => item.instructionStatus === filters.status);
        }

        // 置顶功能（交易员工作台）
        if (role === 'trader') {
          data.sort((a, b) => {
            if (a.isPinned && !b.isPinned) return -1;
            if (!a.isPinned && b.isPinned) return 1;
            return 0;
          });
        }

        return data;
      }, [role, viewFilter, filters]);

      // 根据角色和树节点生成表格列定义
      const getColumnDefinitions = () => {
        const baseColumns = [
          { key: 'instructionNo', title: '指令编号', dataIndex: 'instructionNo', width: 150, fixed: 'left' },
          { key: 'createTime', title: '发起时间', dataIndex: 'createTime', width: 160 },
          { key: 'updateTime', title: '指令内容更新时间', dataIndex: 'updateTime', width: 160 },
          { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
          { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 }
        ];

        // 根据角色和视图筛选添加特定字段
        if (role === 'trader' && viewFilter === 'all') {
          baseColumns.push(
            { key: 'claimStatus', title: '认领状态', dataIndex: 'claimStatus', width: 120, render: (status) => {
              return status === '已认领' ? <Tag color="green">{status}</Tag> : <Tag color="orange">待认领</Tag>;
            }},
            { key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 }
          );
        } else if (role === 'manager' && viewFilter === 'related') {
          baseColumns.push({ key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 });
        } else if (role === 'clerk' && viewFilter === 'all') {
          baseColumns.push(
            { key: 'claimStatus', title: '认领状态', dataIndex: 'claimStatus', width: 120, render: (status) => {
              return status === '已认领' ? <Tag color="green">{status}</Tag> : <Tag color="orange">待认领</Tag>;
        }},
            { key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 }
          );
        }

        // 通用字段
        const commonColumns = [
          { key: 'contractNo', title: '合同号', dataIndex: 'contractNo', width: 150, render: (text) => text || '-' },
          { key: 'customerShortName', title: '客商简称', dataIndex: 'customerShortName', width: 120, render: (text) => text || '-' },
          {
            key: 'contractInfo',
            title: '其他合同信息',
            dataIndex: 'contractInfo',
            width: 150,
            render: (info, record) => {
              if (!info) return '-';
              return (
                <Popover
                  title="合同信息"
                  content={
                    <div>
                      <p>数量：{info.qty}</p>
                      <p>价格：{info.price || '暂定价'}</p>
                      <p>交货日期：{info.deliveryDate}</p>
                    </div>
                  }
                >
                  <Button type="link" size="small">查看详情</Button>
                </Popover>
              );
            }
          },
          {
            key: 'futuresRequirement',
            title: '期货要求和匹配内容',
            dataIndex: 'futuresRequirement',
            width: 200,
            render: (req, record) => {
              if (!req) return '-';
              const matched = record.futuresMatched || [];
              return (
                <Popover
                  title="期货要求和匹配内容"
                  content={
                    <div>
                      <div style={{ marginBottom: 12 }}>
                        <strong>期货要求：</strong>
                        <p>合约：{req.contract}</p>
                        <p>方向：{req.direction}</p>
                        <p>价格：{req.price || '市价'}</p>
                        <p>数量：{req.qty}手</p>
                      </div>
                      {matched.length > 0 && (
                        <div>
                          <strong>已匹配：</strong>
                          {matched.map((m, idx) => (
                            <p key={idx}>委托单{m.entrustNo}：{m.qty}手 @ {m.price}</p>
                          ))}
                        </div>
                      )}
                    </div>
                  }
                >
                  <Button type="link" size="small">
                    {req.contract} {req.direction} {req.qty}手
                  </Button>
                </Popover>
              );
            }
          },
          { key: 'futuresTrader', title: '期货交易认领人', dataIndex: 'futuresTrader', width: 150, render: (text) => text || '-' },
          {
            key: 'futuresStatus',
            title: '期货交易状态',
            dataIndex: 'futuresStatus',
            width: 130,
            render: (status) => {
              if (!status) return '-';
              const color = status === '完成' ? 'green' : 'orange';
              return <Tag color={color}>{status}</Tag>;
            }
          },
          // 父指令下的子指令汇总，仅用于演示父子指令视图（对没有子指令的记录显示为“-”）
          {
            key: 'childInstructions',
            title: '子指令',
            dataIndex: 'childInstructions',
            width: 180,
            render: (children) => {
              if (!children || children.length === 0) return '-';
              return (
                <Popover
                  title="子指令列表"
                  content={
                    <Table
                      size="small"
                      pagination={false}
                      columns={[
                        { title: '子指令ID', dataIndex: 'id', width: 120 },
                        { title: '类型', dataIndex: 'type', width: 140 },
                        { title: '状态', dataIndex: 'status', width: 100 },
                        { title: '方向', dataIndex: 'direction', width: 70 },
                        { title: '影响手数', dataIndex: 'qty', width: 90 }
                      ]}
                      dataSource={children.map(child => ({ key: child.id, ...child }))}
                    />
                  }
                >
                  <Button type="link" size="small">{children.length}条子指令</Button>
                </Popover>
              );
            }
          },
          {
            key: 'contractRequirement',
            title: '合同创建要求和匹配内容',
            dataIndex: 'contractRequirement',
            width: 200,
            render: (req, record) => {
              if (!req) return '-';
              const matched = record.contractMatched || [];
              return (
                <Popover
                  title="合同创建要求和匹配内容"
                  content={
                    <div>
                      <div style={{ marginBottom: 12 }}>
                        <strong>合同要求：</strong>
                        <p>数量：{req.qty}</p>
                        <p>价格：{req.price || '暂定价'}</p>
                      </div>
                      {matched.length > 0 && (
                        <div>
                          <strong>已创建：</strong>
                          {matched.map((m, idx) => (
                            <p key={idx}>合同{m.contractNo}：{m.qty}</p>
                          ))}
                        </div>
                      )}
                    </div>
                  }
                >
                  <Button type="link" size="small">查看详情</Button>
                </Popover>
              );
            }
          },
          { key: 'contractMaker', title: '合同创建认领人', dataIndex: 'contractMaker', width: 150, render: (text) => text || '-' },
          {
            key: 'contractStatus',
            title: '合同创建状态',
            dataIndex: 'contractStatus',
            width: 130,
            render: (status) => {
              if (!status) return '-';
              const color = status === '完成' ? 'green' : 'orange';
              return <Tag color={color}>{status}</Tag>;
            }
          },
          {
            key: 'instructionStatus',
            title: '指令状态',
            dataIndex: 'instructionStatus',
            width: 120,
            render: (status, record) => {
              const color = status === '完成' ? 'green' : status === '撤销待处理' ? 'orange' : 'blue';
              return (
                <Popover
                  title="指令状态详情"
                  content={
                    <div>
                      <p>指令状态：{status}</p>
                      <p>期货交易状态：{record.futuresStatus || '不涉及'}</p>
                      <p>合同创建状态：{record.contractStatus || '不涉及'}</p>
                      <p>撤销处理：{record.withdrawStatus || '无撤销申请'}</p>
                    </div>
                  }
                >
                  <Tag color={color} style={{ cursor: 'pointer' }}>{status}</Tag>
                </Popover>
              );
            }
          },
          {
            key: 'remarks',
            title: '备注记录',
            dataIndex: 'remarks',
            width: 150,
            render: (remarks) => {
              if (!remarks || remarks.length === 0) return '-';
              return (
                <Popover
                  title="备注记录"
                  content={
                    <div style={{ maxHeight: 300, overflowY: 'auto' }}>
                      {remarks.map((r, idx) => (
                        <div key={idx} style={{ marginBottom: 8, paddingBottom: 8, borderBottom: idx < remarks.length - 1 ? '1px solid #f0f0f0' : 'none' }}>
                          <div><strong>{r.person}</strong>：{r.content}</div>
                          <div style={{ color: '#999', fontSize: '12px' }}>{r.time}</div>
                        </div>
                      ))}
                    </div>
                  }
                >
                  <Button type="link" size="small">{remarks.length}条备注</Button>
                </Popover>
              );
            }
          }
        ];

        baseColumns.push(...commonColumns);

        // 不再添加操作列，操作通过选行后的工具栏按钮进行
        return baseColumns;
      };

      const allColumnDefinitions = getColumnDefinitions();

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: instructionVisibleColumns
      } = useColumnManager('instruction-workbench', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 当initialRole变化时，更新role
      useEffect(() => {
        if (initialRole) {
          setRole(initialRole);
        }
      }, [initialRole]);

      // 初始化视图筛选
      useEffect(() => {
        if (viewFilterOptions.length > 0 && !viewFilter) {
          setViewFilter(viewFilterOptions[0].value);
        } else if (viewFilterOptions.length > 0 && viewFilter && !viewFilterOptions.find(opt => opt.value === viewFilter)) {
          // 如果当前viewFilter不在选项中，重置为第一个选项
          setViewFilter(viewFilterOptions[0].value);
        }
      }, [role, viewFilter, viewFilterOptions]);

      // 根据角色获取工具栏按钮
      const getToolbarButtons = () => {
        const buttons = [];
        if (role === 'trader') {
          if (viewFilter === 'my-initiated' || viewFilter === 'my-claimed') {
            buttons.push(<Button key="create" type="primary" icon={renderIcon('PlusOutlined')} onClick={() => message.info('发起指令')}>发起指令</Button>);
            buttons.push(<Button key="withdraw" icon={renderIcon('RollbackOutlined')} onClick={() => message.info('申请撤回')} disabled={selectedRowKeys.length === 0}>申请撤回</Button>);
          }
          if (viewFilter === 'all') {
            buttons.push(<Button key="claim" icon={renderIcon('UserAddOutlined')} onClick={() => message.success('认领成功')} disabled={selectedRowKeys.length === 0}>认领</Button>);
            buttons.push(<Button key="cancel-claim" icon={renderIcon('UserDeleteOutlined')} onClick={() => message.success('取消认领成功')} disabled={selectedRowKeys.length === 0}>取消认领</Button>);
          }
          if (viewFilter === 'my-claimed') {
            buttons.push(<Button key="match" icon={renderIcon('LinkOutlined')} onClick={() => message.info('匹配')} disabled={selectedRowKeys.length === 0}>匹配</Button>);
            // 完成期货交易：示意交易员对子指令/父指令的完成动作
            buttons.push(
              <Button
                key="complete-futures"
                icon={renderIcon('CheckCircleOutlined')}
                disabled={selectedRowKeys.length === 0}
                onClick={() => {
                  const selected = filteredInstructions.filter(item => selectedRowKeys.includes(item.id));
                  const hasChild = selected.some(item => item.isChild);
                  const hasParent = selected.some(item => item.childInstructions && item.childInstructions.length > 0);
                  if (hasChild) {
                    message.success('已完成所选子指令的期货交易。在真实系统中，此操作会更新子指令状态，并重新计算父指令的所需数量。');
                  } else if (hasParent) {
                    message.success('已完成父指令的期货交易。在真实系统中，系统会先校验所有子指令已完成，再允许完成父指令。');
                  } else {
                    message.success('已完成所选指令的期货交易（示例）。');
                  }
                }}
              >
                完成期货交易
              </Button>
            );
            buttons.push(<Button key="complete" icon={renderIcon('CheckOutlined')} onClick={() => message.success('完成指令')} disabled={selectedRowKeys.length === 0}>完成指令</Button>);
            buttons.push(<Button key="withdraw-approve" icon={renderIcon('CheckOutlined')} onClick={() => message.success('同意撤销')} disabled={selectedRowKeys.length === 0}>同意撤销</Button>);
            buttons.push(<Button key="withdraw-reject" icon={renderIcon('CloseOutlined')} onClick={() => message.success('拒绝撤销')} disabled={selectedRowKeys.length === 0}>拒绝撤销</Button>);
          }
        } else if (role === 'manager') {
          if (viewFilter === 'my-initiated') {
            buttons.push(<Button key="create" type="primary" icon={renderIcon('PlusOutlined')} onClick={() => message.info('发起指令')}>创建</Button>);
            buttons.push(<Button key="withdraw" icon={renderIcon('RollbackOutlined')} onClick={() => message.info('申请撤回')} disabled={selectedRowKeys.length === 0}>申请撤回</Button>);
          }
        } else if (role === 'maker') {
          if (viewFilter === 'my-initiated') {
            buttons.push(<Button key="create" type="primary" icon={renderIcon('PlusOutlined')} onClick={() => message.info('发起指令')}>创建</Button>);
            buttons.push(<Button key="withdraw" icon={renderIcon('RollbackOutlined')} onClick={() => message.info('申请撤回')} disabled={selectedRowKeys.length === 0}>申请撤回</Button>);
          }
          if (viewFilter === 'all') {
            buttons.push(<Button key="withdraw" icon={renderIcon('RollbackOutlined')} onClick={() => message.info('申请撤回')} disabled={selectedRowKeys.length === 0}>申请撤回</Button>);
          }
        } else if (role === 'clerk') {
          if (viewFilter === 'all') {
            buttons.push(<Button key="claim" icon={renderIcon('UserAddOutlined')} onClick={() => message.success('认领成功')} disabled={selectedRowKeys.length === 0}>认领</Button>);
            buttons.push(<Button key="cancel-claim" icon={renderIcon('UserDeleteOutlined')} onClick={() => message.success('取消认领成功')} disabled={selectedRowKeys.length === 0}>取消认领</Button>);
          }
          if (viewFilter === 'my-claimed') {
            buttons.push(<Button key="cancel-claim" icon={renderIcon('UserDeleteOutlined')} onClick={() => message.success('取消认领成功')} disabled={selectedRowKeys.length === 0}>取消认领</Button>);
            buttons.push(<Button key="create-contract" icon={renderIcon('FileAddOutlined')} onClick={() => message.info('创建合同')} disabled={selectedRowKeys.length === 0}>创建合同</Button>);
            buttons.push(<Button key="complete-contract" icon={renderIcon('CheckCircleOutlined')} onClick={() => message.success('完成合同创建')} disabled={selectedRowKeys.length === 0}>完成合同创建</Button>);
            buttons.push(<Button key="complete" icon={renderIcon('CheckOutlined')} onClick={() => message.success('完成指令')} disabled={selectedRowKeys.length === 0}>完成指令</Button>);
          }
        } else if (role === 'customer') {
          buttons.push(<Button key="create" type="primary" icon={renderIcon('PlusOutlined')} onClick={() => message.info('发起指令')}>创建</Button>);
          buttons.push(<Button key="withdraw" icon={renderIcon('RollbackOutlined')} onClick={() => message.info('申请撤回')} disabled={selectedRowKeys.length === 0}>申请撤回</Button>);
        }
        buttons.push(<Button key="view-detail" icon={renderIcon('EyeOutlined')} onClick={() => {
          if (selectedRowKeys.length === 1) {
            const instruction = filteredInstructions.find(item => item.id === selectedRowKeys[0]);
            if (instruction) {
              setSelectedInstructionDetail(instruction);
              setInstructionDetailVisible(true);
            }
          } else {
            message.warning('请选择一条指令查看详情');
          }
        }} disabled={selectedRowKeys.length !== 1}>查看详情</Button>);
        buttons.push(<Button key="remark" icon={renderIcon('MessageOutlined')} onClick={() => {
          if (selectedRowKeys.length === 1) {
            const instruction = filteredInstructions.find(item => item.id === selectedRowKeys[0]);
            if (instruction) {
              setCurrentInstruction(instruction);
              setRemarkModalVisible(true);
            }
          } else {
            message.warning('请选择一条指令');
          }
        }} disabled={selectedRowKeys.length !== 1}>备注</Button>);
        buttons.push(<Button key="export" icon={renderIcon('DownloadOutlined')}>导出</Button>);
        return buttons;
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          {!initialRole && (
            <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
                <Radio.Group value={role} onChange={(e) => {
                  setRole(e.target.value);
                  setViewFilter(null);
                }}>
                <Radio.Button value="trader">交易员工作台</Radio.Button>
                <Radio.Button value="manager">业务经理工作台</Radio.Button>
                <Radio.Button value="maker">指令员工作台</Radio.Button>
                <Radio.Button value="clerk">制单员工作台</Radio.Button>
                <Radio.Button value="customer">客商工作台</Radio.Button>
              </Radio.Group>
            </Space>
            </div>
          )}
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            {/* 视图筛选作为筛选栏第一项 */}
            {viewFilterOptions.length > 0 && (
              <div className="erp-filter-item">
                <Radio.Group 
                  value={viewFilter || (viewFilterOptions[0]?.value)} 
                  onChange={(e) => setViewFilter(e.target.value)}
                  buttonStyle="solid"
                >
                  {viewFilterOptions.map(option => (
                    <Radio.Button key={option.value} value={option.value}>
                      {option.label}
                    </Radio.Button>
                  ))}
                </Radio.Group>
              </div>
            )}
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select
                showSearch
                allowClear
                placeholder="请选择指令类型"
                style={{ width: 200 }}
                value={filters.instructionType || undefined}
                onChange={(value) => setFilters({...filters, instructionType: value || ''})}
              >
                {mockInstructionTypes.map(it => (
                  <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>指令状态：</label>
              <Select
                allowClear
                placeholder="请选择状态"
                style={{ width: 150 }}
                value={filters.status || undefined}
                onChange={(value) => setFilters({...filters, status: value || ''})}
              >
                <Select.Option value="待完成">待完成</Select.Option>
                <Select.Option value="撤销待处理">撤销待处理</Select.Option>
                <Select.Option value="完成">完成</Select.Option>
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              {getToolbarButtons()}
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0, display: 'flex', flexDirection: 'column' }}>
            <div className="erp-table-wrapper" style={{ flex: 1, minHeight: 0, overflow: 'hidden', display: 'flex', flexDirection: 'column' }}>
              <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
                <Table
                  rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                  columns={tableColumns}
                  dataSource={filteredInstructions}
                  rowKey="id"
                  scroll={{ x: 'max-content', y: '100%' }}
                  pagination={false}
                  onRow={(record) => ({
                    onDoubleClick: () => {
                      setSelectedInstructionDetail(record);
                      setInstructionDetailVisible(true);
                    },
                    style: { cursor: 'pointer' }
                  })}
                />
              </div>
              <div style={{ flexShrink: 0, padding: '16px 0 0 0', borderTop: '1px solid #f0f0f0' }}>
                <Pagination {...createPaginationConfig()} style={{ margin: 0, textAlign: 'right' }} />
              </div>
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={instructionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
          <Modal
            {...MODAL_TEXTS}
            title="添加备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
              setCurrentInstruction(null);
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                message.success('备注添加成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
                setCurrentInstruction(null);
              });
            }}
            width={600}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item label="指令编号">
                <Input value={currentInstruction?.instructionNo} disabled />
              </Form.Item>
              <Form.Item label="指令类型">
                <Input value={currentInstruction?.instructionType} disabled />
              </Form.Item>
              <Form.Item 
                label="备注内容" 
                name="remark" 
                rules={[{ required: true, message: '请输入备注内容' }]}
              >
                <Input.TextArea rows={4} placeholder="请输入备注内容" />
              </Form.Item>
              {currentInstruction?.remarks && currentInstruction.remarks.length > 0 && (
                <Form.Item label="历史备注">
                  <div style={{ maxHeight: 200, overflowY: 'auto', padding: '12px', background: '#f5f5f5', borderRadius: '4px' }}>
                    {currentInstruction.remarks.map((r, idx) => (
                      <div key={idx} style={{ marginBottom: 8, paddingBottom: 8, borderBottom: idx < currentInstruction.remarks.length - 1 ? '1px solid #e8e8e8' : 'none' }}>
                        <div><strong>{r.person}</strong>：{r.content}</div>
                        <div style={{ color: '#999', fontSize: '12px' }}>{r.time}</div>
                      </div>
                    ))}
                  </div>
                </Form.Item>
              )}
            </Form>
          </Modal>
          
          {/* 指令详情抽屉 */}
          <Drawer
            title={selectedInstructionDetail ? `指令详情 · ${selectedInstructionDetail.instructionNo}` : '指令详情'}
            placement="right"
            width={800}
            open={instructionDetailVisible}
            onClose={() => {
              setInstructionDetailVisible(false);
              setSelectedInstructionDetail(null);
            }}
          >
            {selectedInstructionDetail ? (
              <Space direction="vertical" size={16} style={{ width: '100%' }}>
                {/* 基础信息 */}
                <Card size="small" title="基础信息">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="指令编号">{selectedInstructionDetail.instructionNo}</Descriptions.Item>
                    <Descriptions.Item label="指令类型">{selectedInstructionDetail.instructionType}</Descriptions.Item>
                    <Descriptions.Item label="指令状态">
                      <Tag color={selectedInstructionDetail.instructionStatus === '完成' ? 'green' : selectedInstructionDetail.instructionStatus === '撤销待处理' ? 'orange' : 'blue'}>
                        {selectedInstructionDetail.instructionStatus}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="保值方案">{selectedInstructionDetail.hedgePlan}</Descriptions.Item>
                    <Descriptions.Item label="发起人">{selectedInstructionDetail.creator}</Descriptions.Item>
                    <Descriptions.Item label="创建时间">{selectedInstructionDetail.createTime}</Descriptions.Item>
                    <Descriptions.Item label="更新时间">{selectedInstructionDetail.updateTime}</Descriptions.Item>
                    {selectedInstructionDetail.parentInstructionNo && (
                      <Descriptions.Item label="父指令编号" span={2}>
                        <span style={{ fontFamily: 'monospace', color: '#1677ff' }}>{selectedInstructionDetail.parentInstructionNo}</span>
                      </Descriptions.Item>
                    )}
                  </Descriptions>
                </Card>

                {/* 合同信息 */}
                {selectedInstructionDetail.contractInfo && (
                  <Card size="small" title="合同信息">
                    <Descriptions column={2} size="small" bordered>
                      <Descriptions.Item label="合同编号">{selectedInstructionDetail.contractNo || '-'}</Descriptions.Item>
                      <Descriptions.Item label="客商简称">{selectedInstructionDetail.customerShortName || '-'}</Descriptions.Item>
                      <Descriptions.Item label="数量">{selectedInstructionDetail.contractInfo.qty || 0} 吨</Descriptions.Item>
                      <Descriptions.Item label="价格">{selectedInstructionDetail.contractInfo.price || '暂定价'}</Descriptions.Item>
                      {selectedInstructionDetail.contractInfo.deliveryDate && (
                        <Descriptions.Item label="交货日期" span={2}>{selectedInstructionDetail.contractInfo.deliveryDate}</Descriptions.Item>
                      )}
                    </Descriptions>
                  </Card>
                )}

                {/* 期货要求 */}
                {selectedInstructionDetail.futuresRequirement && (
                  <Card size="small" title="期货要求">
                    <Descriptions column={2} size="small" bordered>
                      <Descriptions.Item label="合约代码">{selectedInstructionDetail.futuresRequirement.contract}</Descriptions.Item>
                      <Descriptions.Item label="方向">
                        <Tag color={selectedInstructionDetail.futuresRequirement.direction === '买入' ? 'red' : 'green'}>
                          {selectedInstructionDetail.futuresRequirement.direction}
                        </Tag>
                      </Descriptions.Item>
                      <Descriptions.Item label="数量">{selectedInstructionDetail.futuresRequirement.qty} 手</Descriptions.Item>
                      <Descriptions.Item label="价格">{selectedInstructionDetail.futuresRequirement.price || '市价'}</Descriptions.Item>
                      {selectedInstructionDetail.futuresTrader && (
                        <Descriptions.Item label="认领人">{selectedInstructionDetail.futuresTrader}</Descriptions.Item>
                      )}
                      <Descriptions.Item label="交易状态">
                        <Tag color={selectedInstructionDetail.futuresStatus === '完成' ? 'green' : 'orange'}>
                          {selectedInstructionDetail.futuresStatus || '-'}
                        </Tag>
                      </Descriptions.Item>
                    </Descriptions>
                    {selectedInstructionDetail.futuresMatched && selectedInstructionDetail.futuresMatched.length > 0 && (
                      <div style={{ marginTop: 12 }}>
                        <div style={{ marginBottom: 8, fontWeight: 500 }}>已匹配的委托：</div>
                        {selectedInstructionDetail.futuresMatched.map((match, idx) => (
                          <div key={idx} style={{ padding: '4px 0', fontSize: '12px', color: '#666' }}>
                            {match.entrustNo}：{match.qty}手 @ {match.price}
                          </div>
                        ))}
                      </div>
                    )}
                  </Card>
                )}

                {/* 子指令列表（如果是父指令） */}
                {selectedInstructionDetail.childInstructions && selectedInstructionDetail.childInstructions.length > 0 && (
                  <Card size="small" title="子指令列表">
                    <Table
                      size="small"
                      columns={[
                        { title: '子指令编号', dataIndex: 'id', width: 150, fixed: 'left' },
                        { title: '类型', dataIndex: 'type', width: 140 },
                        { title: '状态', dataIndex: 'status', width: 100, render: (status) => (
                          <Tag color={status === '完成' ? 'green' : status === '待完成' ? 'orange' : 'blue'}>{status}</Tag>
                        )},
                        { title: '操作人', dataIndex: 'operator', width: 100 },
                        { title: '方向', dataIndex: 'direction', width: 80, render: (dir) => (
                          <Tag color={dir === '买入' || dir === '买' ? 'red' : 'green'}>{dir}</Tag>
                        )},
                        { title: '变更数量(吨)', dataIndex: 'quantityImpact', width: 110, align: 'right', render: (val) => val ? `${val > 0 ? '+' : ''}${val}` : '-' },
                        { title: '变更前现货敞口(吨)', dataIndex: 'beforeSpotExposure', width: 150, align: 'right', render: (val) => val ?? '-' },
                        { title: '变更后现货敞口(吨)', dataIndex: 'afterSpotExposure', width: 150, align: 'right', render: (val) => val ?? '-' },
                        { title: '变更前期货数量(手)', dataIndex: 'beforeFuturesQty', width: 150, align: 'right', render: (val) => val ?? '-' },
                        { title: '变更后期货数量(手)', dataIndex: 'afterFuturesQty', width: 150, align: 'right', render: (val) => val ?? '-' },
                        { title: '变更所需期货(手)', dataIndex: 'qty', width: 120, align: 'right' },
                        ...(role === 'trader' && viewFilter === 'my-claimed' ? [{
                          title: '操作',
                          key: 'action',
                          width: 130,
                          fixed: 'right',
                          render: (_, record) => (
                            <Button 
                              size="small" 
                              type="link"
                              onClick={() => {
                                message.success(`已完成子指令 ${record.id} 的期货交易。在真实系统中，此操作会更新子指令状态，并重新计算父指令的所需数量。`);
                              }}
                              disabled={record.status === '完成'}
                            >
                              完成期货交易
                            </Button>
                          )
                        }] : [])
                      ]}
                      dataSource={selectedInstructionDetail.childInstructions.map(child => ({ key: child.id, ...child }))}
                      pagination={false}
                      scroll={{ x: 'max-content' }}
                    />
                    <div style={{ marginTop: 12, padding: '8px 12px', background: '#f5f5f5', borderRadius: 4, fontSize: '12px', color: '#666' }}>
                      <strong>说明：</strong>父指令所需数量 = {Math.abs(selectedInstructionDetail.childInstructions.reduce((sum, child) => sum + (child.qty || 0), 0))} 手
                      （所有子指令变更所需期货数量之和的绝对值）
                    </div>
                  </Card>
                )}

                {/* 如果是子指令，显示父指令信息 */}
                {selectedInstructionDetail.isChild && selectedInstructionDetail.parentInstructionNo && (
                  <Card size="small" title="父指令信息">
                    <Alert
                      message={`此指令是子指令，关联到父指令 ${selectedInstructionDetail.parentInstructionNo}`}
                      type="info"
                      showIcon
                    />
                    <div style={{ marginTop: 12, fontSize: '12px', color: '#666' }}>
                      <p>子指令数量影响：{selectedInstructionDetail.contractInfo?.qty || 0} 吨</p>
                      <p>变更所需期货：{selectedInstructionDetail.futuresRequirement?.qty || 0} 手</p>
                    </div>
                  </Card>
                )}

                {/* 操作日志 */}
                {selectedInstructionDetail.operationLogs && selectedInstructionDetail.operationLogs.length > 0 && (
                  <Card size="small" title="操作日志">
                    <Timeline
                      size="small"
                      items={selectedInstructionDetail.operationLogs.map((log, idx) => ({
                        children: (
                          <div>
                            <div style={{ color: '#8a94a6', fontSize: '12px' }}>{log.time}</div>
                            <div>{log.content}</div>
                          </div>
                        )
                      }))}
                    />
                  </Card>
                )}

                {/* 备注信息 */}
                {selectedInstructionDetail.remarks && selectedInstructionDetail.remarks.length > 0 && (
                  <Card size="small" title="备注记录">
                    <List
                      size="small"
                      dataSource={selectedInstructionDetail.remarks}
                      renderItem={(item) => (
                        <List.Item>
                          <Space direction="vertical" size={4} style={{ width: '100%' }}>
                            <div>
                              <strong>{item.person}</strong>
                              <span style={{ color: '#8a94a6', fontSize: '12px', marginLeft: 8 }}>{item.time}</span>
                            </div>
                            <div>{item.content}</div>
                          </Space>
                        </List.Item>
                      )}
                    />
                  </Card>
                )}

                {/* 操作按钮区域（根据角色显示） */}
                {role === 'trader' && viewFilter === 'my-claimed' && (
                  <Card size="small" title="操作">
                    <Space wrap>
                      {selectedInstructionDetail.isChild && (
                        <Button
                          type="primary"
                          icon={renderIcon('CheckCircleOutlined')}
                          onClick={() => {
                            message.success('已完成子指令的期货交易');
                          }}
                          disabled={selectedInstructionDetail.futuresStatus === '完成'}
                        >
                          完成期货交易
                        </Button>
                      )}
                      {selectedInstructionDetail.childInstructions && selectedInstructionDetail.childInstructions.length > 0 && (
                        <Button
                          type="primary"
                          icon={renderIcon('CheckCircleOutlined')}
                          onClick={() => {
                            const allCompleted = selectedInstructionDetail.childInstructions.every(child => child.status === '完成');
                            if (allCompleted) {
                              message.success('已完成父指令的期货交易');
                            } else {
                              message.warning('请先完成所有子指令的期货交易');
                            }
                          }}
                          disabled={!selectedInstructionDetail.childInstructions.every(child => child.status === '完成')}
                        >
                          完成父指令期货交易
                        </Button>
                      )}
                      <Button
                        icon={renderIcon('CheckOutlined')}
                        onClick={() => {
                          message.success('完成指令');
                        }}
                      >
                        完成指令
                      </Button>
                    </Space>
                  </Card>
                )}
              </Space>
            ) : (
              <Empty description="暂无指令详情" />
            )}
          </Drawer>
        </div>
      );
    };

    // 人员指令权限设置页面
    const PersonInstructionPermission = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();
      const [selectedInstructionType, setSelectedInstructionType] = useState(null);
      const [selectedHedgePlan, setSelectedHedgePlan] = useState(null);
      const [filters, setFilters] = useState({ hedgePlan: '', instructionType: '', creator: '', status: '' });

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'creators', title: '授权人员', dataIndex: 'creators', width: 200, render: (arr) => arr?.join(', ') || '-' },
        { key: 'makers', title: '制单员', dataIndex: 'makers', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: permissionVisibleColumns
      } = useColumnManager('person-instruction-permission', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取所有角色下的人员
      const getPersonsByRole = () => {
        const rolePersonMap = {};
        mockPersonRoles.forEach(pr => {
          if (pr.status === 'enabled' && pr.personNames) {
            if (!rolePersonMap[pr.roleName]) {
              rolePersonMap[pr.roleName] = [];
            }
            pr.personNames.forEach(name => {
              const person = mockPersons.find(p => p.name === name);
              if (person && !rolePersonMap[pr.roleName].find(p => p.id === person.id)) {
                rolePersonMap[pr.roleName].push(person);
              }
            });
          }
        });
        return rolePersonMap;
      };

      const rolePersonMap = useMemo(() => getPersonsByRole(), []);

      // 获取制单员列表
      const makerOptions = useMemo(() => {
        const makers = mockPersonRoles.find(pr => pr.roleName === '制单员');
        if (makers && makers.personIds) {
          return mockPersons.filter(p => makers.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取交易员列表
      const traderOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 根据保值方案类型过滤指令类型
      const getAvailableInstructionTypesByHedgePlan = (hedgePlanType) => {
        const allTypes = [
          { name: '期货交易指令', types: ['整体匹配', '单单匹配', '无合同（人员）', '无合同（客商）'] },
          { name: '合同创建指令', types: ['整体匹配', '单单匹配'] },
          { name: '一口价创建套保指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案移仓换月指令', types: ['整体匹配', '单单匹配'] },
          { name: '保值方案净值套保指令', types: ['整体匹配'] },
          { name: '保值方案均价净值套保指令', types: ['整体匹配'] },
          { name: '非均价合同套保指令', types: ['单单匹配'] },
          { name: '均价合同套保指令', types: ['单单匹配'] },
          { name: '点价指令', types: ['单单匹配'] },
          { name: '非均价合同变更指令', types: ['单单匹配'] },
          { name: '均价合同变更指令', types: ['单单匹配'] },
          { name: '单单移仓换月', types: ['单单匹配'] }
        ];
        return allTypes.filter(it => it.types.includes(hedgePlanType)).map(it => it.name);
      };

      // 根据保值方案获取可用的指令类型ID列表
      const getAvailableInstructionTypeIds = useMemo(() => {
        if (!selectedHedgePlan) return [];
        const availableTypeNames = getAvailableInstructionTypesByHedgePlan(selectedHedgePlan.type);
        return mockInstructionTypes
          .filter(it => availableTypeNames.includes(it.name))
          .map(it => it.id);
      }, [selectedHedgePlan]);

      const handleAdd = () => {
        form.resetFields();
        setSelectedInstructionType(null);
        setSelectedHedgePlan(null);
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockPersonInstructionPermissions.find(p => p.id === selectedRowKeys[0]);
        if (record) {
          // 先设置保值方案，再设置指令类型
          const hedgePlan = mockHedgePlans.find(hp => hp.name === record.hedgePlan);
          const instructionType = mockInstructionTypes.find(it => it.name === record.instructionType);
          
          // 先设置保值方案，这会触发selectedHedgePlan的更新
          setSelectedHedgePlan(hedgePlan);
          
          // 然后设置表单值
          form.setFieldsValue({
            id: record.id,
            hedgePlanId: hedgePlan?.id,
            instructionTypeId: instructionType?.id,
            creators: record.creators?.map(name => mockPersons.find(p => p.name === name)?.id).filter(Boolean) || [],
            makers: record.makers?.map(name => makerOptions.find(p => p.name === name)?.id).filter(Boolean) || [],
            traders: record.traders?.map(name => traderOptions.find(p => p.name === name)?.id).filter(Boolean) || []
          });
          
          // 设置指令类型状态
          setSelectedInstructionType(instructionType?.id);
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
          setSelectedInstructionType(null);
          setSelectedHedgePlan(null);
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockPersonInstructionPermissions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      // 判断是否显示期货相关字段
      const showFuturesFields = () => {
        if (!selectedInstructionType) return false;
        const instructionType = mockInstructionTypes.find(it => it.id === selectedInstructionType);
        return instructionType && instructionType.name !== '合同创建指令';
      };

      // 判断是否显示持仓限制字段
      const showPositionLimitFields = () => {
        if (!selectedInstructionType || !selectedHedgePlan) return false;
        const instructionType = mockInstructionTypes.find(it => it.id === selectedInstructionType);
        return instructionType?.name === '期货交易指令' && selectedHedgePlan?.type === '无合同（人员）';
      };

      // 根据指令类型获取可选人员（根据角色限定配置筛选）
      const getAvailablePersonsByInstructionType = useMemo(() => {
        if (!selectedInstructionType) return [];
        
        // 根据指令类型，从角色绑定配置中获取允许的角色
        const instructionType = mockInstructionTypes.find(it => it.id === selectedInstructionType);
        if (!instructionType) return [];
        
        // 查找所有拥有该指令类型绑定配置的角色
        const allowedRoles = [];
        mockPersonRoles.forEach(pr => {
          if (pr.status === 'enabled' && pr.instructionTypeIds && pr.instructionTypeIds.includes(selectedInstructionType)) {
            allowedRoles.push(pr.roleName);
          }
        });
        
        // 获取这些角色下的所有人员
        const availablePersons = [];
        allowedRoles.forEach(roleName => {
          const roleData = mockPersonRoles.find(pr => pr.roleName === roleName && pr.status === 'enabled');
          if (roleData && roleData.personIds) {
            roleData.personIds.forEach(personId => {
              const person = mockPersons.find(p => p.id === personId && p.status === 'enabled');
              if (person && !availablePersons.find(p => p.id === person.id)) {
                // 获取该人员的所有角色
                const personRoles = mockPersonRoles
                  .filter(pr => pr.personIds && pr.personIds.includes(person.id) && pr.status === 'enabled')
                  .map(pr => pr.roleName);
                availablePersons.push({
                  ...person,
                  roles: personRoles
                });
              }
            });
          }
        });
        
        return availablePersons;
      }, [selectedInstructionType]);

      const filteredData = useMemo(() => {
        return mockPersonInstructionPermissions.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.instructionType && item.instructionType !== filters.instructionType) return false;
          if (filters.creator && item.creators && !item.creators.some(c => c.includes(filters.creator))) return false;
          if (filters.status && item.status !== filters.status) return false;
          return true;
        });
      }, [filters]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select
                showSearch
                allowClear
                placeholder="请选择指令类型"
                style={{ width: 200 }}
                value={filters.instructionType || undefined}
                onChange={(value) => setFilters({...filters, instructionType: value || ''})}
              >
                {mockInstructionTypes.map(it => (
                  <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>授权人员：</label>
              <Input
                placeholder="请输入授权人员姓名"
                style={{ width: 200 }}
                value={filters.creator}
                onChange={(e) => setFilters({...filters, creator: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>状态：</label>
              <Select
                allowClear
                placeholder="请选择状态"
                style={{ width: 150 }}
                value={filters.status || undefined}
                onChange={(value) => setFilters({...filters, status: value || ''})}
              >
                <Select.Option value="enabled">启用</Select.Option>
                <Select.Option value="disabled">禁用</Select.Option>
              </Select>
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>修改</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="创建/修改人员指令权限"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); setSelectedInstructionType(null); setSelectedHedgePlan(null); }}
            onOk={handleSave}
            width={700}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="保值方案" name="hedgePlanId" required rules={[{ required: true, message: '请选择保值方案' }]}>
                <Select 
                  placeholder="请选择保值方案"
                  onChange={(value) => {
                    const plan = mockHedgePlans.find(hp => hp.id === value);
                    setSelectedHedgePlan(plan);
                    // 当保值方案改变时，清空指令类型并重新过滤
                    form.setFieldsValue({ instructionTypeId: undefined, creators: [] });
                    setSelectedInstructionType(null);
                  }}
                >
                  {mockHedgePlans.filter(hp => hp.status === 'enabled').map(hp => (
                    <Select.Option key={hp.id} value={hp.id}>{hp.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item 
                label="指令类型" 
                name="instructionTypeId" 
                required 
                rules={[
                  { required: true, message: '请选择指令类型' },
                  {
                    validator: (_, value) => {
                      if (!value) return Promise.resolve();
                      if (!selectedHedgePlan) {
                        return Promise.reject(new Error('请先选择保值方案'));
                      }
                      const availableTypeIds = getAvailableInstructionTypeIds;
                      if (!availableTypeIds.includes(value)) {
                        const instructionType = mockInstructionTypes.find(it => it.id === value);
                        return Promise.reject(new Error(`该指令类型不适用于"${selectedHedgePlan.type}"类型的保值方案`));
                      }
                      return Promise.resolve();
                    }
                  }
                ]}
                extra={selectedHedgePlan ? `根据保值方案类型"${selectedHedgePlan.type}"自动过滤可用的指令类型` : '请先选择保值方案'}
              >
                <Select 
                  placeholder={selectedHedgePlan ? "请选择指令类型" : "请先选择保值方案"}
                  disabled={!selectedHedgePlan}
                  onChange={(value) => {
                    setSelectedInstructionType(value);
                    // 切换指令类型时，清空已选人员和相关字段
                    form.setFieldsValue({ creators: [], futuresVarietyLimit: [], futuresContractLimit: [] });
                    const instructionType = mockInstructionTypes.find(it => it.id === value);
                    if (instructionType?.name === '合同创建指令') {
                      form.setFieldsValue({ futuresVarietyLimit: [], futuresContractLimit: [] });
                    }
                  }}
                >
                  {selectedHedgePlan ? mockInstructionTypes
                    .filter(it => getAvailableInstructionTypeIds.includes(it.id))
                    .map(it => (
                      <Select.Option key={it.id} value={it.id}>{it.name}</Select.Option>
                    )) : []}
                </Select>
              </Form.Item>
              <Form.Item 
                label="授权人员" 
                name="creators" 
                required 
                rules={[{ required: true, message: '请选择授权人员' }, { type: 'array', min: 1, message: '至少选择一个授权人员' }]}
                extra={selectedInstructionType ? '只能选择有该指令类型权限角色的人员，已根据指令类型自动筛选' : '请先选择保值方案和指令类型'}
              >
                <Select
                  mode="multiple"
                  placeholder={selectedInstructionType ? "请选择授权人员（已根据指令类型筛选）" : "请先选择保值方案和指令类型"}
                  disabled={!selectedInstructionType}
                  showSearch
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                >
                  {getAvailablePersonsByInstructionType.map(person => (
                    <Select.Option key={person.id} value={person.id} label={person.name}>
                      {person.name}
                      {person.roles && person.roles.length > 0 && (
                        <span style={{ color: '#999', marginLeft: '8px' }}>
                          （{person.roles.join('、')}）
                        </span>
                      )}
                    </Select.Option>
                  ))}
                </Select>
              </Form.Item>
              {showFuturesFields() && (
                <>
                  <Form.Item label="期货品种限制" name="futuresVarietyLimit">
                    <Select mode="tags" placeholder="请输入或选择期货品种" />
                  </Form.Item>
                  <Form.Item label="期货合约限制" name="futuresContractLimit">
                    <Select mode="tags" placeholder="请输入或选择期货合约" />
                  </Form.Item>
                </>
              )}
              {showPositionLimitFields() && (
                <>
                  <Form.Item label="持仓方向限制" name="positionDirection">
                    <Radio.Group>
                      <Radio value="多头">多头</Radio>
                      <Radio value="空头">空头</Radio>
                    </Radio.Group>
                  </Form.Item>
                  <Form.Item label="持仓手数限制" name="positionLimit" rules={[{ pattern: /^\d+$/, message: '请输入正整数' }]}>
                    <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
                  </Form.Item>
                  <Form.Item label="单笔手数限制" name="singleOrderLimit" rules={[{ pattern: /^\d+$/, message: '请输入正整数' }]}>
                    <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
                  </Form.Item>
                </>
              )}
              <Form.Item label="制单员" name="makers">
                <Select 
                  mode="multiple"
                  placeholder="请选择制单员（可多选）"
                  options={makerOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="交易员" name="traders">
                <Select 
                  mode="multiple"
                  placeholder="请选择交易员（可多选，可选）"
                  options={traderOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={permissionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 客商指令权限设置页面
    const CustomerInstructionPermission = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [editModalVisible, setEditModalVisible] = useState(false);
      const [form] = Form.useForm();
      const [filters, setFilters] = useState({ hedgePlan: '', customer: '', validUntil: '', status: '' });

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'creators', title: '授权人员', dataIndex: 'creators', width: 200, render: (arr) => arr?.join(', ') || '-' },
        { key: 'traders', title: '交易员', dataIndex: 'traders', width: 150, render: (arr) => arr?.join(', ') || '-' },
        { key: 'validUntil', title: '有效期', dataIndex: 'validUntil', width: 120 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启用' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: customerPermissionVisibleColumns
      } = useColumnManager('customer-instruction-permission', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取交易员列表
      const traderOptions = useMemo(() => {
        const traders = mockPersonRoles.find(pr => pr.roleName === '交易员');
        if (traders && traders.personIds) {
          return mockPersons.filter(p => traders.personIds.includes(p.id));
        }
        return [];
      }, []);

      // 获取无合同（客商）类型的保值方案
      const customerHedgePlans = useMemo(() => {
        return mockHedgePlans.filter(hp => hp.type === '无合同（客商）');
      }, []);

      const handleAdd = () => {
        form.resetFields();
        form.setFieldsValue({ instructionTypeId: 1 }); // 默认期货交易指令
        setEditModalVisible(true);
      };

      const handleEdit = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条记录进行编辑');
          return;
        }
        const record = mockCustomerInstructionPermissions.find(p => p.id === selectedRowKeys[0]);
        if (record) {
          form.setFieldsValue({
            id: record.id,
            instructionTypeId: 1, // 固定为期货交易指令
            hedgePlanId: mockHedgePlans.find(hp => hp.name === record.hedgePlan)?.id,
            creators: record.creators?.map(name => mockCustomers.find(c => c.shortName === name)?.id).filter(Boolean) || [],
            traders: record.traders?.map(name => traderOptions.find(p => p.name === name)?.id).filter(Boolean) || [],
            validUntil: record.validUntil ? dayjs(record.validUntil) : null
          });
          setEditModalVisible(true);
        }
      };

      const handleSave = () => {
        form.validateFields().then(values => {
          message.success('保存成功');
          setEditModalVisible(false);
          form.resetFields();
        });
      };

      const handleDelete = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要删除的记录');
          return;
        }
        Modal.confirm({
          ...MODAL_TEXTS,
          title: '确认删除',
          content: `确定要删除选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success('删除成功');
            setSelectedRowKeys([]);
          }
        });
      };

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockCustomerInstructionPermissions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启用' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      const filteredData = useMemo(() => {
        return mockCustomerInstructionPermissions.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.customer && item.creators && !item.creators.some(c => c.includes(filters.customer))) return false;
          if (filters.status && item.status !== filters.status) return false;
          if (filters.validUntil) {
            // 这里简化处理，实际应该根据日期范围筛选
          }
          return true;
        });
      }, [filters]);

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>授权客商：</label>
              <Input
                placeholder="请输入客商名称"
                style={{ width: 200 }}
                value={filters.customer}
                onChange={(e) => setFilters({...filters, customer: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>有效期：</label>
              <DatePicker
                placeholder="请选择有效期"
                style={{ width: 200 }}
                value={filters.validUntil}
                onChange={(date) => setFilters({...filters, validUntil: date})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>状态：</label>
              <Select
                allowClear
                placeholder="请选择状态"
                style={{ width: 150 }}
                value={filters.status || undefined}
                onChange={(value) => setFilters({...filters, status: value || ''})}
              >
                <Select.Option value="enabled">启用</Select.Option>
                <Select.Option value="disabled">禁用</Select.Option>
              </Select>
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button type="primary" icon={renderIcon('PlusOutlined')} onClick={handleAdd}>创建</Button>
              <Button icon={renderIcon('EditOutlined')} onClick={handleEdit} disabled={selectedRowKeys.length !== 1}>修改</Button>
              <Button danger icon={renderIcon('DeleteOutlined')} onClick={handleDelete} disabled={selectedRowKeys.length === 0}>删除</Button>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>禁用/启用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          <Modal
            {...MODAL_TEXTS}
            title="创建/修改客商指令权限"
            open={editModalVisible}
            onCancel={() => { setEditModalVisible(false); form.resetFields(); }}
            onOk={handleSave}
            width={700}
          >
            <Form form={form} layout="vertical">
              <Form.Item label="指令类型" name="instructionTypeId">
                <Input value="期货交易指令" disabled />
              </Form.Item>
              <Form.Item label="保值方案" name="hedgePlanId" required rules={[{ required: true, message: '请选择保值方案' }]}>
                <Select placeholder="请选择保值方案（只能选择无合同（客商）类型）">
                  {customerHedgePlans.map(hp => (
                    <Select.Option key={hp.id} value={hp.id}>{hp.name}</Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="指令创建人" name="creators" required rules={[{ required: true, message: '请选择指令创建人' }, { type: 'array', min: 1, message: '至少选择一个创建人' }]}>
                <Select 
                  mode="multiple"
                  placeholder="请选择客商（可多选）"
                  showSearch
                  filterOption={(input, option) =>
                    (option?.label ?? '').toLowerCase().includes(input.toLowerCase())
                  }
                  options={mockCustomers.map(c => ({ label: c.shortName, value: c.id }))}
                />
              </Form.Item>
              <Form.Item label="期货合约限制" name="futuresContractLimit" required rules={[{ required: true, message: '请选择期货合约限制' }]}>
                <Select mode="multiple" placeholder="请选择期货合约（可多选）" />
              </Form.Item>
              <Form.Item label="持仓方向限制" name="positionDirection" required rules={[{ required: true, message: '请选择持仓方向限制' }]}>
                <Radio.Group>
                  <Radio value="多头">多头</Radio>
                  <Radio value="空头">空头</Radio>
                </Radio.Group>
              </Form.Item>
              <Form.Item label="持仓手数限制" name="positionLimit" required rules={[{ required: true, message: '请输入持仓手数限制' }, { pattern: /^\d+$/, message: '请输入正整数' }]}>
                <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
              </Form.Item>
              <Form.Item label="单笔手数限制" name="singleOrderLimit" required rules={[{ required: true, message: '请输入单笔手数限制' }, { pattern: /^\d+$/, message: '请输入正整数' }]}>
                <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入正整数" />
              </Form.Item>
              <Form.Item label="交易员" name="traders">
                <Select 
                  mode="multiple"
                  placeholder="请选择交易员（可多选，可选）"
                  options={traderOptions.map(p => ({ label: p.name, value: p.id }))}
                />
              </Form.Item>
              <Form.Item label="有效期" name="validUntil" required rules={[{ required: true, message: '请选择有效期' }]}>
                <DatePicker style={{ width: '100%' }} placeholder="请选择有效期（含）" />
              </Form.Item>
            </Form>
          </Modal>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={customerPermissionVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 均价自动指令启停页面
    const AvgPriceAutoInstruction = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);

      // 所有可用列定义
      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'creator', title: '指令发起人', dataIndex: 'creator', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 200 },
        { key: 'status', title: '状态', dataIndex: 'status', width: 100, render: (status) => (
          <span className={`erp-status-badge ${status === 'enabled' ? 'enabled' : 'disabled'}`}>
            {status === 'enabled' ? '启动' : '禁用'}
          </span>
        )}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: avgPriceVisibleColumns
      } = useColumnManager('avg-price-auto-instruction', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      const handleToggleStatus = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要操作的记录');
          return;
        }
        const selectedRecords = mockAvgPriceAutoInstructions.filter(p => selectedRowKeys.includes(p.id));
        const hasDisabled = selectedRecords.some(p => p.status === 'disabled');
        const action = hasDisabled ? '启动' : '禁用';
        Modal.confirm({
          ...MODAL_TEXTS,
          title: `确认${action}`,
          content: `确定要${action}选中的 ${selectedRowKeys.length} 条记录吗？${action === '启动' ? '启动后，系统将每日自动进行按保值方案或按合同的均价指令发起。' : ''}`,
          onOk: () => {
            message.success(`${action}成功`);
            setSelectedRowKeys([]);
          }
        });
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('PoweroffOutlined')} onClick={handleToggleStatus} disabled={selectedRowKeys.length === 0}>启动/禁用</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <Alert
              type="info"
              showIcon
              message="说明"
              description="本表格数据来源于人员指令权限设置中针对保值方案设置了'保值方案均价净值套保指令'或'均价合同套保指令'的记录。启动后，系统将每日自动进行按保值方案或按合同的均价指令发起。默认状态为禁用。"
              style={{ marginBottom: 16 }}
            />
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'radio',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={mockAvgPriceAutoInstructions}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={avgPriceVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 在途指令报表页面
    const InstructionPendingReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ hedgePlan: '', instructionType: '', creator: '', status: '', dateRange: null });

      const filteredData = useMemo(() => {
        return mockInstructions.filter(item => {
          if (item.instructionStatus === '完成') return false; // 在途指令不包括已完成的
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.instructionType && item.instructionType !== filters.instructionType) return false;
          if (filters.creator && item.creator !== filters.creator) return false;
          if (filters.status && item.instructionStatus !== filters.status) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'instructionNo', title: '指令编号', dataIndex: 'instructionNo', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '发起时间', dataIndex: 'createTime', width: 160 },
        { key: 'updateTime', title: '最后更新时间', dataIndex: 'updateTime', width: 160 },
        {
          key: 'instructionStatus',
          title: '指令状态',
          dataIndex: 'instructionStatus',
          width: 120,
          render: (status) => {
            const color = status === '完成' ? 'green' : status === '撤销待处理' ? 'orange' : 'blue';
            return <Tag color={color}>{status}</Tag>;
          }
        },
        {
          key: 'futuresStatus',
          title: '期货交易状态',
          dataIndex: 'futuresStatus',
          width: 130,
          render: (status) => {
            if (!status) return '-';
            const color = status === '完成' ? 'green' : 'orange';
            return <Tag color={color}>{status}</Tag>;
          }
        },
        {
          key: 'contractStatus',
          title: '合同创建状态',
          dataIndex: 'contractStatus',
          width: 130,
          render: (status) => {
            if (!status) return '-';
            const color = status === '完成' ? 'green' : 'orange';
            return <Tag color={color}>{status}</Tag>;
          }
        },
        { key: 'contractNo', title: '合同号', dataIndex: 'contractNo', width: 150, render: (text) => text || '-' },
        { key: 'customerShortName', title: '客商简称', dataIndex: 'customerShortName', width: 120, render: (text) => text || '-' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('instruction-pending-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select
                showSearch
                allowClear
                placeholder="请选择指令类型"
                style={{ width: 200 }}
                value={filters.instructionType || undefined}
                onChange={(value) => setFilters({...filters, instructionType: value || ''})}
              >
                {mockInstructionTypes.map(it => (
                  <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>发起人：</label>
              <Input
                placeholder="请输入发起人姓名"
                style={{ width: 200 }}
                value={filters.creator}
                onChange={(e) => setFilters({...filters, creator: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令状态：</label>
              <Select
                allowClear
                placeholder="请选择状态"
                style={{ width: 150 }}
                value={filters.status || undefined}
                onChange={(value) => setFilters({...filters, status: value || ''})}
              >
                <Select.Option value="待完成">待完成</Select.Option>
                <Select.Option value="撤销待处理">撤销待处理</Select.Option>
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 历史指令报表页面
    const InstructionHistoryReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ hedgePlan: '', instructionType: '', creator: '', dateRange: null, completeDateRange: null });

      const filteredData = useMemo(() => {
        return mockInstructions.filter(item => {
          if (item.instructionStatus !== '完成') return false; // 历史指令只显示已完成的
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.instructionType && item.instructionType !== filters.instructionType) return false;
          if (filters.creator && item.creator !== filters.creator) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'instructionNo', title: '指令编号', dataIndex: 'instructionNo', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '发起时间', dataIndex: 'createTime', width: 160 },
        { key: 'updateTime', title: '完成时间', dataIndex: 'updateTime', width: 160 },
        {
          key: 'instructionStatus',
          title: '指令状态',
          dataIndex: 'instructionStatus',
          width: 120,
          render: () => <Tag color="green">完成</Tag>
        },
        {
          key: 'futuresStatus',
          title: '期货交易状态',
          dataIndex: 'futuresStatus',
          width: 130,
          render: (status) => {
            if (!status) return '-';
            const color = status === '完成' ? 'green' : 'orange';
            return <Tag color={color}>{status}</Tag>;
          }
        },
        {
          key: 'contractStatus',
          title: '合同创建状态',
          dataIndex: 'contractStatus',
          width: 130,
          render: (status) => {
            if (!status) return '-';
            const color = status === '完成' ? 'green' : 'orange';
            return <Tag color={color}>{status}</Tag>;
          }
        },
        { key: 'contractNo', title: '合同号', dataIndex: 'contractNo', width: 150, render: (text) => text || '-' },
        { key: 'customerShortName', title: '客商简称', dataIndex: 'customerShortName', width: 120, render: (text) => text || '-' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: historyVisibleColumns
      } = useColumnManager('instruction-history-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select
                showSearch
                allowClear
                placeholder="请选择指令类型"
                style={{ width: 200 }}
                value={filters.instructionType || undefined}
                onChange={(value) => setFilters({...filters, instructionType: value || ''})}
              >
                {mockInstructionTypes.map(it => (
                  <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>发起人：</label>
              <Input
                placeholder="请输入发起人姓名"
                style={{ width: 200 }}
                value={filters.creator}
                onChange={(e) => setFilters({...filters, creator: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>完成时间范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.completeDateRange}
                onChange={(dates) => setFilters({...filters, completeDateRange: dates})}
              />
            </div>
            <div className="erp-filter-item">
              <label>日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={historyVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 期现关联记录报表
    const FuturesSpotRelationReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        futuresAccount: '', 
        contract: '', 
        contractNo: '', 
        dateRange: null,
        tag: ''
      });

      const filteredData = useMemo(() => {
        return mockFuturesSpotRelations.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.futuresAccount && item.futuresAccount !== filters.futuresAccount) return false;
          if (filters.contract && !item.contract.includes(filters.contract)) return false;
          if (filters.contractNo && !item.contractNo.includes(filters.contractNo)) return false;
          if (filters.tag && item.tag !== filters.tag) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'relatedDate', title: '关联日期', dataIndex: 'relatedDate', width: 120 },
        { key: 'occurTime', title: '发生日期时间', dataIndex: 'occurTime', width: 160 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'futuresAccount', title: '期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'contract', title: '合约代码', dataIndex: 'contract', width: 120 },
        { key: 'direction', title: '买卖方向', dataIndex: 'direction', width: 100, render: (text) => <Tag color={text === '买入' ? 'red' : 'green'}>{text}</Tag> },
        { key: 'openClose', title: '开平', dataIndex: 'openClose', width: 80 },
        { key: 'tradeDate', title: '成交日期', dataIndex: 'tradeDate', width: 120 },
        { key: 'tradePrice', title: '成交均价', dataIndex: 'tradePrice', width: 120, align: 'right' },
        { key: 'futuresQty', title: '期货数量（手数）', dataIndex: 'futuresQty', width: 140, align: 'right' },
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'contractQty', title: '合同数量', dataIndex: 'contractQty', width: 120, align: 'right' },
        { key: 'pricingPrice', title: '点价价格', dataIndex: 'pricingPrice', width: 120, align: 'right', render: (text) => text || '-' },
        { key: 'tag', title: '标签', dataIndex: 'tag', width: 100 },
        { key: 'isMatched', title: '是否已匹配', dataIndex: 'isMatched', width: 120, render: (text) => <Tag color={text ? 'green' : 'default'}>{text ? '是' : '否'}</Tag> }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('futures-spot-relation-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>期货账户：</label>
              <Input
                placeholder="请输入期货账户"
                style={{ width: 200 }}
                value={filters.futuresAccount}
                onChange={(e) => setFilters({...filters, futuresAccount: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合约代码：</label>
              <Input
                placeholder="请输入合约代码"
                style={{ width: 200 }}
                value={filters.contract}
                onChange={(e) => setFilters({...filters, contract: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合同编号：</label>
              <Input
                placeholder="请输入合同编号"
                style={{ width: 200 }}
                value={filters.contractNo}
                onChange={(e) => setFilters({...filters, contractNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>关联日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 采销关联记录报表
    const PurchaseSalesRelationReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        customer: '', 
        spotType: '', 
        brand: '', 
        dateRange: null
      });

      const filteredData = useMemo(() => {
        return mockSalesRelations.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan?.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.purchaseManager?.includes(filters.manager) && !item.salesManager?.includes(filters.manager)) return false;
          if (filters.customer && !item.purchaseCustomer?.includes(filters.customer) && !item.salesCustomer?.includes(filters.customer)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'relatedDate', title: '关联日期', dataIndex: 'relatedDate', width: 120 },
        { key: 'occurTime', title: '发生日期时间', dataIndex: 'occurTime', width: 160 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'purchaseContractNo', title: '采购合同编号', dataIndex: 'purchaseContractNo', width: 150 },
        { key: 'purchaseCustomer', title: '采购供应商', dataIndex: 'purchaseCustomer', width: 150 },
        { key: 'purchaseManager', title: '采购业务经理', dataIndex: 'purchaseManager', width: 130 },
        { key: 'purchaseQty', title: '采购数量', dataIndex: 'purchaseQty', width: 120, align: 'right' },
        { key: 'salesContractNo', title: '销售合同编号', dataIndex: 'salesContractNo', width: 150 },
        { key: 'salesCustomer', title: '销售客户', dataIndex: 'salesCustomer', width: 150 },
        { key: 'salesManager', title: '销售业务经理', dataIndex: 'salesManager', width: 130 },
        { key: 'salesQty', title: '销售数量', dataIndex: 'salesQty', width: 120, align: 'right' },
        { key: 'qty', title: '关联数量', dataIndex: 'qty', width: 120, align: 'right' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('purchase-sales-relation-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>客商：</label>
              <Input
                placeholder="请输入客商"
                style={{ width: 200 }}
                value={filters.customer}
                onChange={(e) => setFilters({...filters, customer: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>关联日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 合同事件流水查询报表
    const ContractEventLogReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        contractNo: '', 
        hedgePlan: '', 
        manager: '', 
        eventType: '', 
        operator: '', 
        dateRange: null
      });

      const mockContractEvents = [
        {
          id: 1,
          eventTime: '2025-11-10 10:00:00',
          contractNo: 'HT2025-0001',
          hedgePlan: '整体保值方案A',
          manager: '业务经理A',
          eventType: '创建',
          operator: '张三',
          changeContent: '创建采购合同，数量100吨，单价5300元',
          changeNote: '首批采购合同'
        },
        {
          id: 2,
          eventTime: '2025-11-15 14:30:00',
          contractNo: 'HT2025-0001',
          hedgePlan: '整体保值方案A',
          manager: '业务经理A',
          eventType: '点价',
          operator: '交易员A',
          changeContent: '点价80吨，点价价格5300元',
          changeNote: '完成部分点价'
        },
        {
          id: 3,
          eventTime: '2025-11-18 09:30:00',
          contractNo: 'HT2025-0001',
          hedgePlan: '整体保值方案A',
          manager: '业务经理A',
          eventType: '期现关联',
          operator: '匹配员A',
          changeContent: '关联期货CU2401，买入50手，关联合同数量250吨',
          changeNote: '完成期现匹配'
        }
      ];

      const filteredData = useMemo(() => {
        return mockContractEvents.filter(item => {
          if (filters.contractNo && !item.contractNo.includes(filters.contractNo)) return false;
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.manager.includes(filters.manager)) return false;
          if (filters.eventType && item.eventType !== filters.eventType) return false;
          if (filters.operator && !item.operator.includes(filters.operator)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'eventTime', title: '事件时间', dataIndex: 'eventTime', width: 160 },
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'eventType', title: '事件类型', dataIndex: 'eventType', width: 120 },
        { key: 'operator', title: '操作人', dataIndex: 'operator', width: 120 },
        { key: 'changeContent', title: '变更内容', dataIndex: 'changeContent', width: 300 },
        { key: 'changeNote', title: '变更说明', dataIndex: 'changeNote', width: 200 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('contract-event-log-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>合同编号：</label>
              <Input
                placeholder="请输入合同编号"
                style={{ width: 200 }}
                value={filters.contractNo}
                onChange={(e) => setFilters({...filters, contractNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>事件类型：</label>
              <Select
                allowClear
                placeholder="请选择事件类型"
                style={{ width: 150 }}
                value={filters.eventType || undefined}
                onChange={(value) => setFilters({...filters, eventType: value || ''})}
              >
                <Select.Option value="创建">创建</Select.Option>
                <Select.Option value="编辑">编辑</Select.Option>
                <Select.Option value="删除">删除</Select.Option>
                <Select.Option value="点价">点价</Select.Option>
                <Select.Option value="期现关联">期现关联</Select.Option>
                <Select.Option value="采销关联">采销关联</Select.Option>
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>操作人：</label>
              <Input
                placeholder="请输入操作人"
                style={{ width: 200 }}
                value={filters.operator}
                onChange={(e) => setFilters({...filters, operator: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>事件日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 均价合同今日净值预估报表
    const AvgPriceNetValueReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        contractNo: '', 
        spotType: '', 
        brand: '', 
        status: ''
      });

      const mockAvgPriceContracts = mockContracts
        .filter(c => c.pricing === '均价')
        .map(c => ({
          id: c.id,
          contractNo: c.contractNo,
          hedgePlan: c.hedgePlan,
          manager: c.manager,
          customer: c.customer,
          spotType: c.spotType,
          brand: c.brand,
          qty: c.qty,
          avgStartDate: c.avgStartDate,
          avgEndDate: c.avgEndDate,
          currentAvgPrice: 5280,
          todayNetValue: (c.qty * 5280).toFixed(2),
          pricedQty: c.pricedQty,
          unpricedQty: c.unpricedQty,
          status: c.status === 'enable' ? '启用' : c.status === 'disable' ? '禁用' : '已删除'
        }));

      const filteredData = useMemo(() => {
        return mockAvgPriceContracts.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.manager.includes(filters.manager)) return false;
          if (filters.contractNo && !item.contractNo.includes(filters.contractNo)) return false;
          if (filters.spotType && item.spotType !== filters.spotType) return false;
          if (filters.brand && item.brand !== filters.brand) return false;
          if (filters.status && item.status !== filters.status) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'customer', title: '供应商/客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'avgDateRange', title: '均价起止日', dataIndex: 'avgStartDate', width: 200, render: (text, record) => `${record.avgStartDate || '-'} 至 ${record.avgEndDate || '-'}` },
        { key: 'currentAvgPrice', title: '当前均价', dataIndex: 'currentAvgPrice', width: 120, align: 'right' },
        { key: 'todayNetValue', title: '今日净值预估', dataIndex: 'todayNetValue', width: 140, align: 'right' },
        { key: 'pricedQty', title: '已点数量', dataIndex: 'pricedQty', width: 120, align: 'right' },
        { key: 'unpricedQty', title: '未点数量', dataIndex: 'unpricedQty', width: 120, align: 'right' },
        { key: 'status', title: '合同状态', dataIndex: 'status', width: 100 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('avg-price-net-value-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合同编号：</label>
              <Input
                placeholder="请输入合同编号"
                style={{ width: 200 }}
                value={filters.contractNo}
                onChange={(e) => setFilters({...filters, contractNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>现货品种：</label>
              <Select
                allowClear
                placeholder="请选择现货品种"
                style={{ width: 150 }}
                value={filters.spotType || undefined}
                onChange={(value) => setFilters({...filters, spotType: value || ''})}
              >
                {mockSpecies.map(s => (
                  <Select.Option key={s} value={s}>{s}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>品牌：</label>
              <Select
                allowClear
                placeholder="请选择品牌"
                style={{ width: 150 }}
                value={filters.brand || undefined}
                onChange={(value) => setFilters({...filters, brand: value || ''})}
              >
                {mockBrands.map(b => (
                  <Select.Option key={b} value={b}>{b}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>合同状态：</label>
              <Select
                allowClear
                placeholder="请选择状态"
                style={{ width: 150 }}
                value={filters.status || undefined}
                onChange={(value) => setFilters({...filters, status: value || ''})}
              >
                <Select.Option value="启用">启用</Select.Option>
                <Select.Option value="禁用">禁用</Select.Option>
                <Select.Option value="已删除">已删除</Select.Option>
              </Select>
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 查看合同与期货的关系报表
    const ContractFuturesRelationReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        contractNo: '', 
        futuresAccount: '', 
        contract: '', 
        dateRange: null
      });

      const mockContractFuturesRelations = mockFuturesSpotRelations.map(item => ({
        ...item,
        contractNo: item.contractNo,
        hedgePlan: item.hedgePlan,
        manager: '业务经理A',
        customer: '供应商A',
        spotType: '铜',
        brand: '品牌A',
        contractQty: item.contractQty
      }));

      const filteredData = useMemo(() => {
        return mockContractFuturesRelations.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.manager?.includes(filters.manager)) return false;
          if (filters.contractNo && !item.contractNo.includes(filters.contractNo)) return false;
          if (filters.futuresAccount && item.futuresAccount !== filters.futuresAccount) return false;
          if (filters.contract && !item.contract.includes(filters.contract)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'customer', title: '供应商/客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'contractQty', title: '合同数量', dataIndex: 'contractQty', width: 120, align: 'right' },
        { key: 'futuresAccount', title: '关联期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'contract', title: '关联合约', dataIndex: 'contract', width: 120 },
        { key: 'direction', title: '关联方向', dataIndex: 'direction', width: 100, render: (text) => <Tag color={text === '买入' ? 'red' : 'green'}>{text}</Tag> },
        { key: 'futuresQty', title: '关联期货数量（手数）', dataIndex: 'futuresQty', width: 160, align: 'right' },
        { key: 'contractQty', title: '关联合同数量', dataIndex: 'contractQty', width: 140, align: 'right' },
        { key: 'relatedDate', title: '关联日期', dataIndex: 'relatedDate', width: 120 },
        { key: 'pricingPrice', title: '点价价格', dataIndex: 'pricingPrice', width: 120, align: 'right', render: (text) => text || '-' }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('contract-futures-relation-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合同编号：</label>
              <Input
                placeholder="请输入合同编号"
                style={{ width: 200 }}
                value={filters.contractNo}
                onChange={(e) => setFilters({...filters, contractNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>期货账户：</label>
              <Input
                placeholder="请输入期货账户"
                style={{ width: 200 }}
                value={filters.futuresAccount}
                onChange={(e) => setFilters({...filters, futuresAccount: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合约代码：</label>
              <Input
                placeholder="请输入合约代码"
                style={{ width: 200 }}
                value={filters.contract}
                onChange={(e) => setFilters({...filters, contract: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>关联日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 查看采销合同的关系报表
    const PurchaseSalesRelationContractReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        contractNo: '', 
        customer: '', 
        spotType: '', 
        brand: '', 
        dateRange: null
      });

      const filteredData = useMemo(() => {
        return mockSalesRelations.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan?.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.purchaseManager?.includes(filters.manager) && !item.salesManager?.includes(filters.manager)) return false;
          if (filters.contractNo && !item.purchaseContractNo?.includes(filters.contractNo) && !item.salesContractNo?.includes(filters.contractNo)) return false;
          if (filters.customer && !item.purchaseCustomer?.includes(filters.customer) && !item.salesCustomer?.includes(filters.customer)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'purchaseContractNo', title: '采购合同编号', dataIndex: 'purchaseContractNo', width: 150 },
        { key: 'purchaseCustomer', title: '采购供应商', dataIndex: 'purchaseCustomer', width: 150 },
        { key: 'purchaseManager', title: '采购业务经理', dataIndex: 'purchaseManager', width: 130 },
        { key: 'purchaseQty', title: '采购数量', dataIndex: 'purchaseQty', width: 120, align: 'right' },
        { key: 'salesContractNo', title: '销售合同编号', dataIndex: 'salesContractNo', width: 150 },
        { key: 'salesCustomer', title: '销售客户', dataIndex: 'salesCustomer', width: 150 },
        { key: 'salesManager', title: '销售业务经理', dataIndex: 'salesManager', width: 130 },
        { key: 'salesQty', title: '销售数量', dataIndex: 'salesQty', width: 120, align: 'right' },
        { key: 'qty', title: '关联数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'relatedDate', title: '关联日期', dataIndex: 'relatedDate', width: 120 },
        { key: 'occurTime', title: '发生日期时间', dataIndex: 'occurTime', width: 160 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('purchase-sales-relation-contract-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>合同编号：</label>
              <Input
                placeholder="请输入合同编号"
                style={{ width: 200 }}
                value={filters.contractNo}
                onChange={(e) => setFilters({...filters, contractNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>客商：</label>
              <Input
                placeholder="请输入客商"
                style={{ width: 200 }}
                value={filters.customer}
                onChange={(e) => setFilters({...filters, customer: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>关联日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 指令更新记录报表
    const InstructionUpdateRecordReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        instructionNo: '', 
        hedgePlan: '', 
        instructionType: '', 
        updater: '', 
        dateRange: null
      });

      const mockInstructionUpdates = [
        {
          id: 1,
          updateTime: '2025-11-10 10:30:00',
          instructionNo: 'INS-2025-0001',
          instructionType: '保值方案均价净值套保指令',
          hedgePlan: '整体保值方案A',
          updater: '系统自动',
          updateType: '内容更新',
          updateContent: '子指令创建，父指令所需数量从200手更新为250手',
          updateNote: '合同数量变更触发子指令创建'
        },
        {
          id: 2,
          updateTime: '2025-11-10 14:30:00',
          instructionNo: 'INS-2025-0001',
          instructionType: '保值方案均价净值套保指令',
          hedgePlan: '整体保值方案A',
          updater: '系统自动',
          updateType: '匹配更新',
          updateContent: '期货交易匹配120手，剩余130手待匹配',
          updateNote: '交易员完成部分匹配'
        }
      ];

      const filteredData = useMemo(() => {
        return mockInstructionUpdates.filter(item => {
          if (filters.instructionNo && !item.instructionNo.includes(filters.instructionNo)) return false;
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.instructionType && item.instructionType !== filters.instructionType) return false;
          if (filters.updater && !item.updater.includes(filters.updater)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'updateTime', title: '更新时间', dataIndex: 'updateTime', width: 160 },
        { key: 'instructionNo', title: '指令编号', dataIndex: 'instructionNo', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 200 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'updater', title: '更新人', dataIndex: 'updater', width: 120 },
        { key: 'updateType', title: '更新类型', dataIndex: 'updateType', width: 120 },
        { key: 'updateContent', title: '更新内容', dataIndex: 'updateContent', width: 300 },
        { key: 'updateNote', title: '更新说明', dataIndex: 'updateNote', width: 200 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('instruction-update-record-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>指令编号：</label>
              <Input
                placeholder="请输入指令编号"
                style={{ width: 200 }}
                value={filters.instructionNo}
                onChange={(e) => setFilters({...filters, instructionNo: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>指令类型：</label>
              <Select
                showSearch
                allowClear
                placeholder="请选择指令类型"
                style={{ width: 200 }}
                value={filters.instructionType || undefined}
                onChange={(value) => setFilters({...filters, instructionType: value || ''})}
              >
                {mockInstructionTypes.map(it => (
                  <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>更新人：</label>
              <Input
                placeholder="请输入更新人"
                style={{ width: 200 }}
                value={filters.updater}
                onChange={(e) => setFilters({...filters, updater: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>更新日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 合同敞口分列与合计报表
    const ContractExposureReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        spotType: '', 
        brand: '', 
        status: '',
        statDate: null
      });
      const [viewMode, setViewMode] = useState('contract'); // 'contract' | 'hedgePlan' | 'manager'

      const mockContractExposures = mockContracts.map(c => {
        const spotExposure = c.qty - (c.pricedQty || 0) - (c.contractDirection === 'purchase' ? (c.soldQty || 0) : (c.purchasedQty || 0));
        const futuresExposure = 50; // 模拟期货敞口
        const exposureCoeff = 1.0;
        const coverageRate = spotExposure > 0 ? ((futuresExposure / exposureCoeff) / spotExposure * 100).toFixed(2) + '%' : '-';
        const exposureStatus = coverageRate === '-' ? '-' : parseFloat(coverageRate) >= 100 ? '已对冲' : parseFloat(coverageRate) === 0 ? '未对冲' : '部分对冲';
        return {
          id: c.id,
          contractNo: c.contractNo,
          hedgePlan: c.hedgePlan,
          manager: c.manager,
          customer: c.customer,
          spotType: c.spotType,
          brand: c.brand,
          qty: c.qty,
          pricedQty: c.pricedQty || 0,
          unpricedQty: c.unpricedQty || 0,
          soldQty: c.contractDirection === 'purchase' ? (c.soldQty || 0) : 0,
          purchasedQty: c.contractDirection === 'sales' ? (c.purchasedQty || 0) : 0,
          spotExposure,
          futuresExposure,
          exposureCoeff,
          exposureStatus,
          status: c.status === 'enable' ? '启用' : c.status === 'disable' ? '禁用' : '已删除'
        };
      });

      const filteredData = useMemo(() => {
        let data = mockContractExposures.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.manager.includes(filters.manager)) return false;
          if (filters.spotType && item.spotType !== filters.spotType) return false;
          if (filters.brand && item.brand !== filters.brand) return false;
          if (filters.status && item.status !== filters.status) return false;
          return true;
        });

        if (viewMode === 'hedgePlan') {
          const grouped = {};
          data.forEach(item => {
            if (!grouped[item.hedgePlan]) {
              grouped[item.hedgePlan] = {
                id: item.hedgePlan,
                hedgePlan: item.hedgePlan,
                qty: 0,
                pricedQty: 0,
                unpricedQty: 0,
                spotExposure: 0,
                futuresExposure: 0,
                coverageRate: '-'
              };
            }
            grouped[item.hedgePlan].qty += item.qty;
            grouped[item.hedgePlan].pricedQty += item.pricedQty;
            grouped[item.hedgePlan].unpricedQty += item.unpricedQty;
            grouped[item.hedgePlan].spotExposure += item.spotExposure;
            grouped[item.hedgePlan].futuresExposure += item.futuresExposure;
          });
          Object.values(grouped).forEach(g => {
            if (g.spotExposure > 0) {
              g.coverageRate = ((g.futuresExposure / 1.0) / g.spotExposure * 100).toFixed(2) + '%';
            }
          });
          data = Object.values(grouped);
        } else if (viewMode === 'manager') {
          const grouped = {};
          data.forEach(item => {
            if (!grouped[item.manager]) {
              grouped[item.manager] = {
                id: item.manager,
                manager: item.manager,
                qty: 0,
                spotExposure: 0,
                futuresExposure: 0,
                coverageRate: '-'
              };
            }
            grouped[item.manager].qty += item.qty;
            grouped[item.manager].spotExposure += item.spotExposure;
            grouped[item.manager].futuresExposure += item.futuresExposure;
          });
          Object.values(grouped).forEach(g => {
            if (g.spotExposure > 0) {
              g.coverageRate = ((g.futuresExposure / 1.0) / g.spotExposure * 100).toFixed(2) + '%';
            }
          });
          data = Object.values(grouped);
        }

        return data;
      }, [filters, viewMode]);

      const contractColumns = [
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'customer', title: '供应商/客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'pricedQty', title: '已点数量', dataIndex: 'pricedQty', width: 120, align: 'right' },
        { key: 'unpricedQty', title: '未点数量', dataIndex: 'unpricedQty', width: 120, align: 'right' },
        { key: 'soldQty', title: '已销售数量', dataIndex: 'soldQty', width: 130, align: 'right', render: (text, record) => record.soldQty || record.purchasedQty || 0 },
        { key: 'spotExposure', title: '现货敞口', dataIndex: 'spotExposure', width: 120, align: 'right' },
        { key: 'futuresExposure', title: '期货敞口', dataIndex: 'futuresExposure', width: 120, align: 'right' },
        { key: 'exposureCoeff', title: '敞口系数', dataIndex: 'exposureCoeff', width: 120, align: 'right' },
        { key: 'exposureStatus', title: '敞口状态', dataIndex: 'exposureStatus', width: 120, render: (text) => {
          const color = text === '已对冲' ? 'green' : text === '未对冲' ? 'red' : 'orange';
          return <Tag color={color}>{text}</Tag>;
        }}
      ];

      const hedgePlanColumns = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'qty', title: '合同数量合计', dataIndex: 'qty', width: 140, align: 'right' },
        { key: 'pricedQty', title: '已点数量合计', dataIndex: 'pricedQty', width: 140, align: 'right' },
        { key: 'unpricedQty', title: '未点数量合计', dataIndex: 'unpricedQty', width: 140, align: 'right' },
        { key: 'spotExposure', title: '现货敞口合计', dataIndex: 'spotExposure', width: 140, align: 'right' },
        { key: 'futuresExposure', title: '期货敞口合计', dataIndex: 'futuresExposure', width: 140, align: 'right' },
        { key: 'coverageRate', title: '敞口覆盖率', dataIndex: 'coverageRate', width: 120, align: 'right' }
      ];

      const managerColumns = [
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'qty', title: '合同数量合计', dataIndex: 'qty', width: 140, align: 'right' },
        { key: 'spotExposure', title: '现货敞口合计', dataIndex: 'spotExposure', width: 140, align: 'right' },
        { key: 'futuresExposure', title: '期货敞口合计', dataIndex: 'futuresExposure', width: 140, align: 'right' },
        { key: 'coverageRate', title: '敞口覆盖率', dataIndex: 'coverageRate', width: 120, align: 'right' }
      ];

      const allColumnDefinitions = viewMode === 'contract' ? contractColumns : viewMode === 'hedgePlan' ? hedgePlanColumns : managerColumns;

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('contract-exposure-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>视图：</label>
              <Radio.Group value={viewMode} onChange={(e) => setViewMode(e.target.value)}>
                <Radio.Button value="contract">按合同</Radio.Button>
                <Radio.Button value="hedgePlan">按保值方案</Radio.Button>
                <Radio.Button value="manager">按业务经理</Radio.Button>
              </Radio.Group>
            </div>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>现货品种：</label>
              <Select
                allowClear
                placeholder="请选择现货品种"
                style={{ width: 150 }}
                value={filters.spotType || undefined}
                onChange={(value) => setFilters({...filters, spotType: value || ''})}
              >
                {mockSpecies.map(s => (
                  <Select.Option key={s} value={s}>{s}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>品牌：</label>
              <Select
                allowClear
                placeholder="请选择品牌"
                style={{ width: 150 }}
                value={filters.brand || undefined}
                onChange={(value) => setFilters({...filters, brand: value || ''})}
              >
                {mockBrands.map(b => (
                  <Select.Option key={b} value={b}>{b}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>统计日期：</label>
              <DatePicker
                style={{ width: 150 }}
                value={filters.statDate}
                onChange={(date) => setFilters({...filters, statDate: date})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 按业务负责人的合同的应交收和实际交收报表
    const ContractDeliveryByManagerReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        manager: '', 
        hedgePlan: '', 
        customer: '', 
        spotType: '', 
        deliveryDateRange: null
      });

      const mockContractDeliveries = mockContracts.map(c => {
        const shouldDeliverQty = c.qty;
        const actualDeliverQty = c.pricedQty || 0;
        const undeliveredQty = shouldDeliverQty - actualDeliverQty;
        const deliveryRate = shouldDeliverQty > 0 ? ((actualDeliverQty / shouldDeliverQty) * 100).toFixed(2) + '%' : '-';
        const isDelivered = new Date(c.deliveryDate) <= new Date();
        const isHedged = 50 > 0; // 模拟期货敞口
        const hedgeUndelivered = isHedged && undeliveredQty > 0;
        return {
          id: c.id,
          manager: c.manager,
          contractNo: c.contractNo,
          hedgePlan: c.hedgePlan,
          customer: c.customer,
          spotType: c.spotType,
          brand: c.brand,
          qty: c.qty,
          shouldDeliverQty,
          actualDeliverQty,
          undeliveredQty,
          deliveryRate,
          deliveryDate: c.deliveryDate,
          isDelivered,
          isHedged,
          hedgeUndelivered
        };
      });

      const filteredData = useMemo(() => {
        return mockContractDeliveries.filter(item => {
          if (filters.manager && !item.manager.includes(filters.manager)) return false;
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.customer && !item.customer.includes(filters.customer)) return false;
          if (filters.spotType && item.spotType !== filters.spotType) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'customer', title: '供应商/客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'shouldDeliverQty', title: '应交收数量', dataIndex: 'shouldDeliverQty', width: 130, align: 'right' },
        { key: 'actualDeliverQty', title: '实际交收数量', dataIndex: 'actualDeliverQty', width: 140, align: 'right' },
        { key: 'undeliveredQty', title: '未交收数量', dataIndex: 'undeliveredQty', width: 130, align: 'right' },
        { key: 'deliveryRate', title: '交收完成率', dataIndex: 'deliveryRate', width: 120, align: 'right' },
        { key: 'deliveryDate', title: '交割日期', dataIndex: 'deliveryDate', width: 120 },
        { key: 'isDelivered', title: '是否已交收', dataIndex: 'isDelivered', width: 120, render: (text) => <Tag color={text ? 'green' : 'default'}>{text ? '是' : '否'}</Tag> },
        { key: 'isHedged', title: '是否已套保', dataIndex: 'isHedged', width: 120, render: (text) => <Tag color={text ? 'blue' : 'default'}>{text ? '是' : '否'}</Tag> },
        { key: 'hedgeUndelivered', title: '套保未交收', dataIndex: 'hedgeUndelivered', width: 120, render: (text) => text ? <Tag color="red">是</Tag> : <Tag>否</Tag> }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('contract-delivery-by-manager-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>客商：</label>
              <Input
                placeholder="请输入客商"
                style={{ width: 200 }}
                value={filters.customer}
                onChange={(e) => setFilters({...filters, customer: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>现货品种：</label>
              <Select
                allowClear
                placeholder="请选择现货品种"
                style={{ width: 150 }}
                value={filters.spotType || undefined}
                onChange={(value) => setFilters({...filters, spotType: value || ''})}
              >
                {mockSpecies.map(s => (
                  <Select.Option key={s} value={s}>{s}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>交收日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.deliveryDateRange}
                onChange={(dates) => setFilters({...filters, deliveryDateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                rowClassName={(record) => record.hedgeUndelivered ? 'hedge-undelivered-row' : ''}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 按交易员认领的指令的完成情况和敞口报表
    const InstructionByTraderReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        trader: '', 
        hedgePlan: '', 
        instructionType: '', 
        dateRange: null
      });
      const [viewMode, setViewMode] = useState('trader'); // 'trader' | 'detail'

      const mockTraderInstructions = [
        {
          id: 1,
          trader: '交易员A',
          tradeDate: '2025-11-10',
          claimCount: 3,
          completedCount: 1,
          pendingCount: 2,
          completionRate: '33.33%',
          claimQty: 250,
          matchedQty: 120,
          unmatchedQty: 130,
          exposureQty: 130
        },
        {
          id: 2,
          trader: '交易员B',
          tradeDate: '2025-11-11',
          claimCount: 2,
          completedCount: 1,
          pendingCount: 1,
          completionRate: '50.00%',
          claimQty: 200,
          matchedQty: 200,
          unmatchedQty: 0,
          exposureQty: 0
        }
      ];

      const mockTraderInstructionDetails = mockInstructions
        .filter(i => i.futuresTrader)
        .map(i => ({
          id: i.id,
          instructionNo: i.instructionNo,
          instructionType: i.instructionType,
          hedgePlan: i.hedgePlan,
          creator: i.creator,
          createTime: i.createTime,
          instructionStatus: i.instructionStatus,
          requiredQty: i.futuresRequirement?.qty || 0,
          matchedQty: i.futuresMatched?.reduce((sum, m) => sum + (m.qty || 0), 0) || 0,
          unmatchedQty: (i.futuresRequirement?.qty || 0) - (i.futuresMatched?.reduce((sum, m) => sum + (m.qty || 0), 0) || 0),
          exposureQty: (i.futuresRequirement?.qty || 0) - (i.futuresMatched?.reduce((sum, m) => sum + (m.qty || 0), 0) || 0),
          futuresTrader: i.futuresTrader
        }));

      const filteredData = useMemo(() => {
        if (viewMode === 'trader') {
          return mockTraderInstructions.filter(item => {
            if (filters.trader && !item.trader.includes(filters.trader)) return false;
            return true;
          });
        } else {
          return mockTraderInstructionDetails.filter(item => {
            if (filters.trader && item.futuresTrader !== filters.trader) return false;
            if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
            if (filters.instructionType && item.instructionType !== filters.instructionType) return false;
            return true;
          });
        }
      }, [filters, viewMode]);

      const traderColumns = [
        { key: 'trader', title: '交易员', dataIndex: 'trader', width: 120 },
        { key: 'tradeDate', title: '交易日', dataIndex: 'tradeDate', width: 120 },
        { key: 'claimCount', title: '认领指令数量', dataIndex: 'claimCount', width: 140, align: 'right' },
        { key: 'completedCount', title: '已完成指令数量', dataIndex: 'completedCount', width: 160, align: 'right' },
        { key: 'pendingCount', title: '待完成指令数量', dataIndex: 'pendingCount', width: 160, align: 'right' },
        { key: 'completionRate', title: '指令完成率', dataIndex: 'completionRate', width: 130, align: 'right' },
        { key: 'claimQty', title: '认领所需数量合计（手数）', dataIndex: 'claimQty', width: 200, align: 'right' },
        { key: 'matchedQty', title: '已匹配数量合计（手数）', dataIndex: 'matchedQty', width: 200, align: 'right' },
        { key: 'unmatchedQty', title: '未匹配数量合计（手数）', dataIndex: 'unmatchedQty', width: 200, align: 'right' },
        { key: 'exposureQty', title: '敞口数量（手数）', dataIndex: 'exposureQty', width: 160, align: 'right' }
      ];

      const detailColumns = [
        { key: 'instructionNo', title: '指令编号', dataIndex: 'instructionNo', width: 150 },
        { key: 'instructionType', title: '指令类型', dataIndex: 'instructionType', width: 200 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'creator', title: '发起人', dataIndex: 'creator', width: 120 },
        { key: 'createTime', title: '发起时间', dataIndex: 'createTime', width: 160 },
        { key: 'instructionStatus', title: '指令状态', dataIndex: 'instructionStatus', width: 120, render: (status) => {
          const color = status === '完成' ? 'green' : status === '撤销待处理' ? 'orange' : 'blue';
          return <Tag color={color}>{status}</Tag>;
        }},
        { key: 'requiredQty', title: '所需数量（手数）', dataIndex: 'requiredQty', width: 160, align: 'right' },
        { key: 'matchedQty', title: '已匹配数量（手数）', dataIndex: 'matchedQty', width: 160, align: 'right' },
        { key: 'unmatchedQty', title: '未匹配数量（手数）', dataIndex: 'unmatchedQty', width: 160, align: 'right' },
        { key: 'exposureQty', title: '敞口数量（手数）', dataIndex: 'exposureQty', width: 160, align: 'right' }
      ];

      const allColumnDefinitions = viewMode === 'trader' ? traderColumns : detailColumns;

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('instruction-by-trader-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>视图：</label>
              <Radio.Group value={viewMode} onChange={(e) => setViewMode(e.target.value)}>
                <Radio.Button value="trader">按交易员</Radio.Button>
                <Radio.Button value="detail">按指令明细</Radio.Button>
              </Radio.Group>
            </div>
            <div className="erp-filter-item">
              <label>交易员：</label>
              <Input
                placeholder="请输入交易员"
                style={{ width: 200 }}
                value={filters.trader}
                onChange={(e) => setFilters({...filters, trader: e.target.value})}
                allowClear
              />
            </div>
            {viewMode === 'detail' && (
              <>
                <div className="erp-filter-item">
                  <label>保值方案：</label>
                  <Input
                    placeholder="请输入保值方案名称"
                    style={{ width: 200 }}
                    value={filters.hedgePlan}
                    onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                    allowClear
                  />
                </div>
                <div className="erp-filter-item">
                  <label>指令类型：</label>
                  <Select
                    showSearch
                    allowClear
                    placeholder="请选择指令类型"
                    style={{ width: 200 }}
                    value={filters.instructionType || undefined}
                    onChange={(value) => setFilters({...filters, instructionType: value || ''})}
                  >
                    {mockInstructionTypes.map(it => (
                      <Select.Option key={it.id} value={it.name}>{it.name}</Select.Option>
                    ))}
                  </Select>
                </div>
              </>
            )}
            <div className="erp-filter-item">
              <label>日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 期货账户信息一览报表
    const FuturesAccountInfoReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        futuresAccount: '', 
        statDate: null
      });

      const mockFuturesAccountInfo = [
        {
          id: 1,
          futuresAccount: 'ACC001',
          accountEquity: 10000000,
          availableFunds: 1440000,
          usedMargin: 8560000,
          riskDegree: 85.6,
          totalPosition: 500,
          longPosition: 300,
          shortPosition: 200,
          positionValue: 85600000,
          floatingProfit: 90000,
          closedProfit: 150000,
          commission: 5000,
          netProfit: 145000,
          statDate: '2025-11-30'
        },
        {
          id: 2,
          futuresAccount: 'ACC002',
          accountEquity: 5000000,
          availableFunds: 2000000,
          usedMargin: 3000000,
          riskDegree: 60.0,
          totalPosition: 200,
          longPosition: 100,
          shortPosition: 100,
          positionValue: 30000000,
          floatingProfit: -20000,
          closedProfit: 80000,
          commission: 3000,
          netProfit: 77000,
          statDate: '2025-11-30'
        }
      ];

      const filteredData = useMemo(() => {
        return mockFuturesAccountInfo.filter(item => {
          if (filters.futuresAccount && !item.futuresAccount.includes(filters.futuresAccount)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'futuresAccount', title: '期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'accountEquity', title: '账户权益', dataIndex: 'accountEquity', width: 140, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'availableFunds', title: '可用资金', dataIndex: 'availableFunds', width: 140, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'usedMargin', title: '占用保证金', dataIndex: 'usedMargin', width: 140, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'riskDegree', title: '风险度（%）', dataIndex: 'riskDegree', width: 130, align: 'right', render: (text) => {
          const color = text >= 80 ? 'red' : text >= 60 ? 'orange' : 'green';
          return <Tag color={color}>{text.toFixed(2)}%</Tag>;
        }},
        { key: 'totalPosition', title: '总持仓手数', dataIndex: 'totalPosition', width: 140, align: 'right' },
        { key: 'longPosition', title: '多头持仓手数', dataIndex: 'longPosition', width: 150, align: 'right' },
        { key: 'shortPosition', title: '空头持仓手数', dataIndex: 'shortPosition', width: 150, align: 'right' },
        { key: 'positionValue', title: '持仓市值', dataIndex: 'positionValue', width: 140, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'floatingProfit', title: '浮动盈亏', dataIndex: 'floatingProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'closedProfit', title: '平仓盈亏（统计期间）', dataIndex: 'closedProfit', width: 180, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'commission', title: '手续费（统计期间）', dataIndex: 'commission', width: 160, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'netProfit', title: '净盈亏', dataIndex: 'netProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'statDate', title: '统计日期', dataIndex: 'statDate', width: 120 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('futures-account-info-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>期货账户：</label>
              <Input
                placeholder="请输入期货账户"
                style={{ width: 200 }}
                value={filters.futuresAccount}
                onChange={(e) => setFilters({...filters, futuresAccount: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>统计日期：</label>
              <DatePicker
                style={{ width: 150 }}
                value={filters.statDate}
                onChange={(date) => setFilters({...filters, statDate: date})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 按交易员的投机交易记录和盈亏报表
    const TraderSpeculationProfitReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        trader: '', 
        futuresAccount: '', 
        contract: '', 
        dateRange: null
      });
      const [viewMode, setViewMode] = useState('trader'); // 'trader' | 'detail'

      const mockTraderSpeculation = [
        {
          id: 1,
          trader: '交易员A',
          tradeDate: '2025-11-10',
          tradeCount: 5,
          openQty: 100,
          closeQty: 80,
          closedProfit: 150000,
          commission: 5000,
          netProfit: 145000,
          winRate: '60.00%',
          avgProfit: 29000
        },
        {
          id: 2,
          trader: '交易员B',
          tradeDate: '2025-11-11',
          tradeCount: 3,
          openQty: 50,
          closeQty: 50,
          closedProfit: 80000,
          commission: 3000,
          netProfit: 77000,
          winRate: '66.67%',
          avgProfit: 25667
        }
      ];

      const mockTraderSpeculationDetails = [
        {
          id: 1,
          tradeDate: '2025-11-10',
          tradeTime: '09:30:00',
          trader: '交易员A',
          futuresAccount: 'ACC001',
          contract: 'CU2401',
          direction: '买入',
          openClose: '开仓',
          tradePrice: 5300,
          tradeQty: 50,
          closedProfit: 75000,
          commission: 2500,
          netProfit: 72500
        },
        {
          id: 2,
          tradeDate: '2025-11-10',
          tradeTime: '14:20:00',
          trader: '交易员A',
          futuresAccount: 'ACC001',
          contract: 'CU2401',
          direction: '卖出',
          openClose: '平仓',
          tradePrice: 5450,
          tradeQty: 30,
          closedProfit: 45000,
          commission: 1500,
          netProfit: 43500
        }
      ];

      const filteredData = useMemo(() => {
        if (viewMode === 'trader') {
          return mockTraderSpeculation.filter(item => {
            if (filters.trader && !item.trader.includes(filters.trader)) return false;
            return true;
          });
        } else {
          return mockTraderSpeculationDetails.filter(item => {
            if (filters.trader && item.trader !== filters.trader) return false;
            if (filters.futuresAccount && item.futuresAccount !== filters.futuresAccount) return false;
            if (filters.contract && !item.contract.includes(filters.contract)) return false;
            return true;
          });
        }
      }, [filters, viewMode]);

      const traderColumns = [
        { key: 'trader', title: '交易员', dataIndex: 'trader', width: 120 },
        { key: 'tradeDate', title: '交易日期', dataIndex: 'tradeDate', width: 120 },
        { key: 'tradeCount', title: '交易笔数', dataIndex: 'tradeCount', width: 120, align: 'right' },
        { key: 'openQty', title: '开仓手数', dataIndex: 'openQty', width: 120, align: 'right' },
        { key: 'closeQty', title: '平仓手数', dataIndex: 'closeQty', width: 120, align: 'right' },
        { key: 'closedProfit', title: '平仓盈亏', dataIndex: 'closedProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'commission', title: '手续费', dataIndex: 'commission', width: 120, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'netProfit', title: '净盈亏', dataIndex: 'netProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'winRate', title: '胜率', dataIndex: 'winRate', width: 120, align: 'right' },
        { key: 'avgProfit', title: '平均盈亏', dataIndex: 'avgProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }}
      ];

      const detailColumns = [
        { key: 'tradeDate', title: '交易日期', dataIndex: 'tradeDate', width: 120 },
        { key: 'tradeTime', title: '交易时间', dataIndex: 'tradeTime', width: 120 },
        { key: 'trader', title: '交易员', dataIndex: 'trader', width: 120 },
        { key: 'futuresAccount', title: '期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'contract', title: '合约代码', dataIndex: 'contract', width: 120 },
        { key: 'direction', title: '买卖方向', dataIndex: 'direction', width: 100, render: (text) => <Tag color={text === '买入' ? 'red' : 'green'}>{text}</Tag> },
        { key: 'openClose', title: '开平', dataIndex: 'openClose', width: 80 },
        { key: 'tradePrice', title: '成交价格', dataIndex: 'tradePrice', width: 120, align: 'right' },
        { key: 'tradeQty', title: '成交手数', dataIndex: 'tradeQty', width: 120, align: 'right' },
        { key: 'closedProfit', title: '平仓盈亏', dataIndex: 'closedProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'commission', title: '手续费', dataIndex: 'commission', width: 120, align: 'right', render: (text) => text.toLocaleString() },
        { key: 'netProfit', title: '净盈亏', dataIndex: 'netProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }}
      ];

      const allColumnDefinitions = viewMode === 'trader' ? traderColumns : detailColumns;

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('trader-speculation-profit-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>视图：</label>
              <Radio.Group value={viewMode} onChange={(e) => setViewMode(e.target.value)}>
                <Radio.Button value="trader">按交易员</Radio.Button>
                <Radio.Button value="detail">按交易明细</Radio.Button>
              </Radio.Group>
            </div>
            <div className="erp-filter-item">
              <label>交易员：</label>
              <Input
                placeholder="请输入交易员"
                style={{ width: 200 }}
                value={filters.trader}
                onChange={(e) => setFilters({...filters, trader: e.target.value})}
                allowClear
              />
            </div>
            {viewMode === 'detail' && (
              <>
                <div className="erp-filter-item">
                  <label>期货账户：</label>
                  <Input
                    placeholder="请输入期货账户"
                    style={{ width: 200 }}
                    value={filters.futuresAccount}
                    onChange={(e) => setFilters({...filters, futuresAccount: e.target.value})}
                    allowClear
                  />
                </div>
                <div className="erp-filter-item">
                  <label>合约代码：</label>
                  <Input
                    placeholder="请输入合约代码"
                    style={{ width: 200 }}
                    value={filters.contract}
                    onChange={(e) => setFilters({...filters, contract: e.target.value})}
                    allowClear
                  />
                </div>
              </>
            )}
            <div className="erp-filter-item">
              <label>交易日期范围：</label>
              <DatePicker.RangePicker
                style={{ width: 240 }}
                value={filters.dateRange}
                onChange={(dates) => setFilters({...filters, dateRange: dates})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 保值方案信息一览报表
    const HedgePlanInfoReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        statDate: null
      });

      const mockHedgePlanInfo = [
        {
          id: 1,
          hedgePlan: '整体保值方案A',
          planType: '整体匹配',
          spotTypes: '铜',
          brands: '品牌A,品牌C',
          contractCount: 2,
          contractQty: 250,
          pricedQty: 80,
          unpricedQty: 170,
          spotExposure: 170,
          futuresExposure: 50,
          coverageRate: '29.41%',
          futuresPosition: 50,
          floatingProfit: 90000,
          closedProfit: 150000,
          statDate: '2025-11-30'
        },
        {
          id: 2,
          hedgePlan: '单单保值方案B',
          planType: '单单匹配',
          spotTypes: '铝',
          brands: '品牌B',
          contractCount: 1,
          contractQty: 200,
          pricedQty: 0,
          unpricedQty: 200,
          spotExposure: 200,
          futuresExposure: 100,
          coverageRate: '50.00%',
          futuresPosition: 100,
          floatingProfit: -20000,
          closedProfit: 80000,
          statDate: '2025-11-30'
        }
      ];

      const filteredData = useMemo(() => {
        return mockHedgePlanInfo.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'planType', title: '方案类型', dataIndex: 'planType', width: 120 },
        { key: 'spotTypes', title: '适用现货品种', dataIndex: 'spotTypes', width: 150 },
        { key: 'brands', title: '适用品牌', dataIndex: 'brands', width: 200 },
        { key: 'contractCount', title: '关联合同数量', dataIndex: 'contractCount', width: 140, align: 'right' },
        { key: 'contractQty', title: '合同数量合计', dataIndex: 'contractQty', width: 140, align: 'right' },
        { key: 'pricedQty', title: '已点数量合计', dataIndex: 'pricedQty', width: 140, align: 'right' },
        { key: 'unpricedQty', title: '未点数量合计', dataIndex: 'unpricedQty', width: 140, align: 'right' },
        { key: 'spotExposure', title: '现货敞口合计', dataIndex: 'spotExposure', width: 140, align: 'right' },
        { key: 'futuresExposure', title: '期货敞口合计', dataIndex: 'futuresExposure', width: 140, align: 'right' },
        { key: 'coverageRate', title: '敞口覆盖率', dataIndex: 'coverageRate', width: 120, align: 'right' },
        { key: 'futuresPosition', title: '期货持仓手数合计', dataIndex: 'futuresPosition', width: 160, align: 'right' },
        { key: 'floatingProfit', title: '期货浮动盈亏', dataIndex: 'floatingProfit', width: 140, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'closedProfit', title: '期货平仓盈亏（统计期间）', dataIndex: 'closedProfit', width: 200, align: 'right', render: (text) => {
          const color = text >= 0 ? 'red' : 'green';
          return <span style={{ color }}>{text >= 0 ? '+' : ''}{text.toLocaleString()}</span>;
        }},
        { key: 'statDate', title: '统计日期', dataIndex: 'statDate', width: 120 }
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('hedge-plan-info-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>统计日期：</label>
              <DatePicker
                style={{ width: 150 }}
                value={filters.statDate}
                onChange={(date) => setFilters({...filters, statDate: date})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 合同套期关系一览表报表
    const ContractHedgeRelationReport = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({ 
        hedgePlan: '', 
        manager: '', 
        spotType: '', 
        brand: '', 
        statDate: null
      });

      const mockContractHedgeRelations = mockContracts.map(c => {
        const spotExposure = c.qty - (c.pricedQty || 0);
        const futuresExposure = 50; // 模拟期货敞口
        const coverageRate = spotExposure > 0 ? ((futuresExposure / 1.0) / spotExposure * 100).toFixed(2) + '%' : '-';
        const hedgeStatus = coverageRate === '-' ? '-' : parseFloat(coverageRate) >= 100 ? '已对冲' : parseFloat(coverageRate) === 0 ? '未对冲' : '部分对冲';
        return {
          id: c.id,
          contractNo: c.contractNo,
          hedgePlan: c.hedgePlan,
          manager: c.manager,
          customer: c.customer,
          spotType: c.spotType,
          brand: c.brand,
          qty: c.qty,
          pricedQty: c.pricedQty || 0,
          unpricedQty: c.unpricedQty || 0,
          spotExposure,
          futuresAccount: 'ACC001',
          futuresContract: 'CU2401',
          futuresQty: 50,
          futuresExposure,
          coverageRate,
          hedgeStatus
        };
      });

      const filteredData = useMemo(() => {
        return mockContractHedgeRelations.filter(item => {
          if (filters.hedgePlan && !item.hedgePlan.includes(filters.hedgePlan)) return false;
          if (filters.manager && !item.manager.includes(filters.manager)) return false;
          if (filters.spotType && item.spotType !== filters.spotType) return false;
          if (filters.brand && item.brand !== filters.brand) return false;
          return true;
        });
      }, [filters]);

      const allColumnDefinitions = [
        { key: 'contractNo', title: '合同编号', dataIndex: 'contractNo', width: 150 },
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'manager', title: '业务经理', dataIndex: 'manager', width: 120 },
        { key: 'customer', title: '供应商/客户', dataIndex: 'customer', width: 150 },
        { key: 'spotType', title: '现货品种', dataIndex: 'spotType', width: 120 },
        { key: 'brand', title: '品牌', dataIndex: 'brand', width: 120 },
        { key: 'qty', title: '合同数量', dataIndex: 'qty', width: 120, align: 'right' },
        { key: 'pricedQty', title: '已点数量', dataIndex: 'pricedQty', width: 120, align: 'right' },
        { key: 'unpricedQty', title: '未点数量', dataIndex: 'unpricedQty', width: 120, align: 'right' },
        { key: 'spotExposure', title: '现货敞口', dataIndex: 'spotExposure', width: 120, align: 'right' },
        { key: 'futuresAccount', title: '关联期货账户', dataIndex: 'futuresAccount', width: 120 },
        { key: 'futuresContract', title: '关联合约', dataIndex: 'futuresContract', width: 120 },
        { key: 'futuresQty', title: '关联期货数量（手数）', dataIndex: 'futuresQty', width: 180, align: 'right' },
        { key: 'futuresExposure', title: '期货敞口', dataIndex: 'futuresExposure', width: 120, align: 'right' },
        { key: 'coverageRate', title: '敞口覆盖率', dataIndex: 'coverageRate', width: 120, align: 'right' },
        { key: 'hedgeStatus', title: '套保状态', dataIndex: 'hedgeStatus', width: 120, render: (text) => {
          const color = text === '已对冲' ? 'green' : text === '未对冲' ? 'red' : 'orange';
          return <Tag color={color}>{text}</Tag>;
        }}
      ];

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: reportVisibleColumns
      } = useColumnManager('contract-hedge-relation-report', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>保值方案：</label>
              <Input
                placeholder="请输入保值方案名称"
                style={{ width: 200 }}
                value={filters.hedgePlan}
                onChange={(e) => setFilters({...filters, hedgePlan: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>业务经理：</label>
              <Input
                placeholder="请输入业务经理"
                style={{ width: 200 }}
                value={filters.manager}
                onChange={(e) => setFilters({...filters, manager: e.target.value})}
                allowClear
              />
            </div>
            <div className="erp-filter-item">
              <label>现货品种：</label>
              <Select
                allowClear
                placeholder="请选择现货品种"
                style={{ width: 150 }}
                value={filters.spotType || undefined}
                onChange={(value) => setFilters({...filters, spotType: value || ''})}
              >
                {mockSpecies.map(s => (
                  <Select.Option key={s} value={s}>{s}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>品牌：</label>
              <Select
                allowClear
                placeholder="请选择品牌"
                style={{ width: 150 }}
                value={filters.brand || undefined}
                onChange={(value) => setFilters({...filters, brand: value || ''})}
              >
                {mockBrands.map(b => (
                  <Select.Option key={b} value={b}>{b}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>统计日期：</label>
              <DatePicker
                style={{ width: 150 }}
                value={filters.statDate}
                onChange={(date) => setFilters({...filters, statDate: date})}
              />
            </div>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Button 
              icon={renderIcon('SettingOutlined')} 
              onClick={() => setColumnEditorVisible(true)}
              style={{ marginLeft: 'auto' }}
            >
              自定义列
            </Button>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ selectedRowKeys, onChange: setSelectedRowKeys }}
                columns={tableColumns}
                dataSource={filteredData}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>
          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={reportVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 自定义报表（结构化报表配置）
    const CustomReport = () => {
      const [activeTab, setActiveTab] = useState('config'); // 'config' | 'preview'
      const [dataSource, setDataSource] = useState('contract'); // 数据源
      const [selectedFields, setSelectedFields] = useState([]); // 选中的字段
      const [filters, setFilters] = useState([]); // 筛选条件
      const [groupBy, setGroupBy] = useState([]); // 分组字段
      const [sortBy, setSortBy] = useState([]); // 排序字段
      const [reportData, setReportData] = useState([]); // 报表数据
      const [reportName, setReportName] = useState(''); // 报表名称
      const [savedTemplates, setSavedTemplates] = useState([]); // 保存的模板

      // 数据源定义（数据字典）
      const dataSourceDefinitions = {
        contract: {
          name: '合同表',
          fields: [
            { key: 'contractNo', label: '合同编号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'hedgePlan', label: '保值方案', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'businessManager', label: '业务经理', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'customerName', label: '供应商/客户', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'spotVariety', label: '现货品种', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'brand', label: '品牌', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'contractQty', label: '合同数量', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'price', label: '单价', type: 'number', filterable: true, groupable: false, sortable: true },
            { key: 'contractAmount', label: '合同金额', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'pricing', label: '计价方式', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'deliveryDate', label: '交割日期', type: 'date', filterable: true, groupable: true, sortable: true },
            { key: 'createTime', label: '创建时间', type: 'datetime', filterable: true, groupable: false, sortable: true },
            { key: 'status', label: '状态', type: 'text', filterable: true, groupable: true, sortable: true }
          ]
        },
        instruction: {
          name: '指令表',
          fields: [
            { key: 'instructionNo', label: '指令编号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'instructionType', label: '指令类型', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'hedgePlan', label: '保值方案', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'creator', label: '发起人', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'createTime', label: '发起时间', type: 'datetime', filterable: true, groupable: false, sortable: true },
            { key: 'instructionStatus', label: '指令状态', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'futuresStatus', label: '期货交易状态', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'contractStatus', label: '合同创建状态', type: 'text', filterable: true, groupable: true, sortable: true }
          ]
        },
        futuresOrder: {
          name: '委托单表',
          fields: [
            { key: 'entrustNo', label: '委托单号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'futuresAccount', label: '期货账户', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'hedgePlan', label: '保值方案', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'contract', label: '合约代码', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'direction', label: '买卖方向', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'openClose', label: '开平', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'entrustQty', label: '委托手数', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'matchedQty', label: '成交手数', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'entrustPrice', label: '委托价格', type: 'number', filterable: true, groupable: false, sortable: true },
            { key: 'matchedPrice', label: '成交均价', type: 'number', filterable: true, groupable: false, sortable: true },
            { key: 'orderStatus', label: '挂单状态', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'dateTime', label: '委托时间', type: 'datetime', filterable: true, groupable: false, sortable: true }
          ]
        },
        futuresSpotRelation: {
          name: '期现关联表',
          fields: [
            { key: 'relationDate', label: '关联日期', type: 'date', filterable: true, groupable: true, sortable: true },
            { key: 'hedgePlan', label: '保值方案', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'futuresAccount', label: '期货账户', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'contract', label: '合约代码', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'direction', label: '买卖方向', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'futuresQty', label: '期货数量（手数）', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'contractNo', label: '合同编号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'contractQty', label: '合同数量', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'pricingPrice', label: '点价价格', type: 'number', filterable: true, groupable: false, sortable: true }
          ]
        },
        salesRelation: {
          name: '采销关联表',
          fields: [
            { key: 'relationDate', label: '关联日期', type: 'date', filterable: true, groupable: true, sortable: true },
            { key: 'hedgePlan', label: '保值方案', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'purchaseContractNo', label: '采购合同编号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'purchaseSupplier', label: '采购供应商', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'purchaseQty', label: '采购数量', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'salesContractNo', label: '销售合同编号', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'salesCustomer', label: '销售客户', type: 'text', filterable: true, groupable: true, sortable: true },
            { key: 'salesQty', label: '销售数量', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true },
            { key: 'relationQty', label: '关联数量', type: 'number', filterable: true, groupable: false, sortable: true, aggregatable: true }
          ]
        }
      };

      // 获取当前数据源的字段列表
      const currentFields = dataSourceDefinitions[dataSource]?.fields || [];

      // 获取当前数据源的数据
      const getDataSourceData = () => {
        switch (dataSource) {
          case 'contract':
            return mockContracts;
          case 'instruction':
            return mockInstructions;
          case 'futuresOrder':
            return mockFuturesOrders;
          case 'futuresSpotRelation':
            return mockFuturesSpotRelations;
          case 'salesRelation':
            return mockSalesRelations;
          default:
            return [];
        }
      };

      // 执行报表查询
      const executeReport = () => {
        let data = [...getDataSourceData()];

        // 应用筛选条件
        filters.forEach(filter => {
          if (!filter.field || !filter.operator) return;
          const field = currentFields.find(f => f.key === filter.field);
          if (!field) return;

          data = data.filter(item => {
            const value = item[filter.field];
            const filterValue = filter.value;

            switch (filter.operator) {
              case 'equals':
                return value === filterValue;
              case 'notEquals':
                return value !== filterValue;
              case 'contains':
                return String(value || '').includes(String(filterValue || ''));
              case 'notContains':
                return !String(value || '').includes(String(filterValue || ''));
              case 'greaterThan':
                return Number(value || 0) > Number(filterValue || 0);
              case 'lessThan':
                return Number(value || 0) < Number(filterValue || 0);
              case 'greaterThanOrEqual':
                return Number(value || 0) >= Number(filterValue || 0);
              case 'lessThanOrEqual':
                return Number(value || 0) <= Number(filterValue || 0);
              case 'in':
                return Array.isArray(filterValue) && filterValue.includes(value);
              case 'notIn':
                return Array.isArray(filterValue) && !filterValue.includes(value);
              case 'isNull':
                return value === null || value === undefined || value === '';
              case 'isNotNull':
                return value !== null && value !== undefined && value !== '';
              default:
                return true;
            }
          });
        });

        // 应用分组
        if (groupBy.length > 0) {
          const grouped = {};
          data.forEach(item => {
            const groupKey = groupBy.map(field => item[field] || '').join('|');
            if (!grouped[groupKey]) {
              grouped[groupKey] = {
                _groupKey: groupKey,
                _groupValues: groupBy.reduce((acc, field) => {
                  acc[field] = item[field];
                  return acc;
                }, {}),
                _items: []
              };
            }
            grouped[groupKey]._items.push(item);
          });

          // 计算聚合值
          const aggregated = Object.values(grouped).map(group => {
            const result = { ...group._groupValues };
            selectedFields.forEach(field => {
              const fieldDef = currentFields.find(f => f.key === field);
              if (fieldDef && fieldDef.aggregatable) {
                const values = group._items.map(item => Number(item[field] || 0));
                result[`${field}_sum`] = values.reduce((a, b) => a + b, 0);
                result[`${field}_avg`] = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                result[`${field}_count`] = values.length;
                result[`${field}_min`] = values.length > 0 ? Math.min(...values) : 0;
                result[`${field}_max`] = values.length > 0 ? Math.max(...values) : 0;
              }
            });
            return result;
          });
          data = aggregated;
        }

        // 应用排序
        if (sortBy.length > 0) {
          data.sort((a, b) => {
            for (const sort of sortBy) {
              const aVal = a[sort.field] || 0;
              const bVal = b[sort.field] || 0;
              if (aVal !== bVal) {
                return sort.order === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
              }
            }
            return 0;
          });
        }

        // 只选择需要的字段
        if (selectedFields.length > 0) {
          data = data.map(item => {
            const result = {};
            selectedFields.forEach(field => {
              result[field] = item[field];
              // 如果是分组聚合结果，也包含聚合字段
              if (item[`${field}_sum`] !== undefined) {
                result[`${field}_sum`] = item[`${field}_sum`];
                result[`${field}_avg`] = item[`${field}_avg`];
                result[`${field}_count`] = item[`${field}_count`];
              }
            });
            return result;
          });
        }

        setReportData(data);
        setActiveTab('preview');
        message.success('报表查询完成');
      };

      // 保存模板
      const saveTemplate = () => {
        if (!reportName.trim()) {
          message.warning('请输入报表名称');
          return;
        }
        const template = {
          id: Date.now(),
          name: reportName,
          dataSource,
          selectedFields,
          filters,
          groupBy,
          sortBy,
          createTime: new Date().toLocaleString()
        };
        setSavedTemplates([...savedTemplates, template]);
        message.success('模板保存成功');
      };

      // 加载模板
      const loadTemplate = (template) => {
        setDataSource(template.dataSource);
        setSelectedFields(template.selectedFields || []);
        setFilters(template.filters || []);
        setGroupBy(template.groupBy || []);
        setSortBy(template.sortBy || []);
        setReportName(template.name);
        message.success('模板加载成功');
      };

      // 添加筛选条件
      const addFilter = () => {
        setFilters([...filters, { field: '', operator: 'equals', value: '' }]);
      };

      // 删除筛选条件
      const removeFilter = (index) => {
        setFilters(filters.filter((_, i) => i !== index));
      };

      // 更新筛选条件
      const updateFilter = (index, field, value) => {
        const newFilters = [...filters];
        newFilters[index] = { ...newFilters[index], [field]: value };
        setFilters(newFilters);
      };

      // 添加排序
      const addSort = () => {
        setSortBy([...sortBy, { field: '', order: 'asc' }]);
      };

      // 删除排序
      const removeSort = (index) => {
        setSortBy(sortBy.filter((_, i) => i !== index));
      };

      // 更新排序
      const updateSort = (index, field, value) => {
        const newSorts = [...sortBy];
        newSorts[index] = { ...newSorts[index], [field]: value };
        setSortBy(newSorts);
      };

      // 切换字段选择
      const toggleField = (fieldKey) => {
        if (selectedFields.includes(fieldKey)) {
          setSelectedFields(selectedFields.filter(f => f !== fieldKey));
          // 如果字段在分组中，也要移除
          setGroupBy(groupBy.filter(f => f !== fieldKey));
          // 如果字段在排序中，也要移除
          setSortBy(sortBy.filter(s => s.field !== fieldKey));
        } else {
          setSelectedFields([...selectedFields, fieldKey]);
        }
      };

      // 切换分组字段
      const toggleGroupBy = (fieldKey) => {
        if (groupBy.includes(fieldKey)) {
          setGroupBy(groupBy.filter(f => f !== fieldKey));
        } else {
          setGroupBy([...groupBy, fieldKey]);
        }
      };

      // 数据源变更时重置配置
      const handleDataSourceChange = (newDataSource) => {
        setDataSource(newDataSource);
        setSelectedFields([]);
        setFilters([]);
        setGroupBy([]);
        setSortBy([]);
        setReportData([]);
      };

      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', padding: 16 }}>
          <Tabs activeKey={activeTab} onChange={setActiveTab} style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}>
            <Tabs.TabPane tab="报表配置" key="config" style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
              <div style={{ display: 'flex', flex: 1, gap: 16, minHeight: 0, overflow: 'hidden' }}>
                {/* 左侧配置面板 */}
                <div style={{ width: 400, display: 'flex', flexDirection: 'column', gap: 16, overflow: 'hidden' }}>
                  {/* 数据源选择 */}
                  <Card title="数据源选择" size="small" style={{ flexShrink: 0 }}>
                    <Select
                      value={dataSource}
                      onChange={handleDataSourceChange}
                      style={{ width: '100%' }}
                    >
                      {Object.keys(dataSourceDefinitions).map(key => (
                        <Select.Option key={key} value={key}>
                          {dataSourceDefinitions[key].name}
                        </Select.Option>
                      ))}
                    </Select>
                  </Card>

                  {/* 字段选择 */}
                  <Card title="字段选择" size="small" style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
                    <div style={{ flex: 1, overflow: 'auto' }}>
                      {currentFields.map(field => (
                        <div key={field.key} style={{ marginBottom: 8 }}>
                          <Checkbox
                            checked={selectedFields.includes(field.key)}
                            onChange={() => toggleField(field.key)}
                          >
                            {field.label}
                            <Tag color="blue" style={{ marginLeft: 8 }}>{field.type}</Tag>
                            {field.aggregatable && <Tag color="green" style={{ marginLeft: 4 }}>可聚合</Tag>}
                          </Checkbox>
                        </div>
                      ))}
                    </div>
                  </Card>

                  {/* 筛选条件 */}
                  <Card title="筛选条件" size="small" style={{ flexShrink: 0 }}>
                    <div style={{ marginBottom: 8 }}>
                      <Button size="small" onClick={addFilter}>添加筛选条件</Button>
                    </div>
                    {filters.map((filter, index) => {
                      const field = currentFields.find(f => f.key === filter.field);
                      return (
                        <div key={index} style={{ marginBottom: 12, padding: 8, border: '1px solid #f0f0f0', borderRadius: 4 }}>
                          <div style={{ display: 'flex', gap: 8, marginBottom: 8 }}>
                            <Select
                              placeholder="选择字段"
                              value={filter.field}
                              onChange={(value) => updateFilter(index, 'field', value)}
                              style={{ flex: 1 }}
                            >
                              {currentFields.filter(f => f.filterable).map(f => (
                                <Select.Option key={f.key} value={f.key}>{f.label}</Select.Option>
                              ))}
                            </Select>
                            <Select
                              placeholder="操作符"
                              value={filter.operator}
                              onChange={(value) => updateFilter(index, 'operator', value)}
                              style={{ width: 120 }}
                            >
                              <Select.Option value="equals">等于</Select.Option>
                              <Select.Option value="notEquals">不等于</Select.Option>
                              <Select.Option value="contains">包含</Select.Option>
                              <Select.Option value="notContains">不包含</Select.Option>
                              <Select.Option value="greaterThan">大于</Select.Option>
                              <Select.Option value="lessThan">小于</Select.Option>
                              <Select.Option value="greaterThanOrEqual">大于等于</Select.Option>
                              <Select.Option value="lessThanOrEqual">小于等于</Select.Option>
                              <Select.Option value="isNull">为空</Select.Option>
                              <Select.Option value="isNotNull">不为空</Select.Option>
                            </Select>
                            <Button size="small" danger onClick={() => removeFilter(index)}>删除</Button>
                          </div>
                          {filter.operator !== 'isNull' && filter.operator !== 'isNotNull' && (
                            <Input
                              placeholder="输入值"
                              value={filter.value}
                              onChange={(e) => updateFilter(index, 'value', e.target.value)}
                            />
                          )}
                        </div>
                      );
                    })}
                  </Card>

                  {/* 分组设置 */}
                  <Card title="分组设置" size="small" style={{ flexShrink: 0 }}>
                    <div style={{ marginBottom: 8 }}>
                      <span style={{ fontSize: 12, color: '#666' }}>选择分组字段（可多选）</span>
                    </div>
                    {currentFields.filter(f => f.groupable).map(field => (
                      <div key={field.key} style={{ marginBottom: 8 }}>
                        <Checkbox
                          checked={groupBy.includes(field.key)}
                          onChange={() => toggleGroupBy(field.key)}
                        >
                          {field.label}
                        </Checkbox>
                      </div>
                    ))}
                  </Card>

                  {/* 排序设置 */}
                  <Card title="排序设置" size="small" style={{ flexShrink: 0 }}>
                    <div style={{ marginBottom: 8 }}>
                      <Button size="small" onClick={addSort}>添加排序</Button>
                    </div>
                    {sortBy.map((sort, index) => (
                      <div key={index} style={{ marginBottom: 8, padding: 8, border: '1px solid #f0f0f0', borderRadius: 4 }}>
                        <div style={{ display: 'flex', gap: 8 }}>
                          <Select
                            placeholder="选择字段"
                            value={sort.field}
                            onChange={(value) => updateSort(index, 'field', value)}
                            style={{ flex: 1 }}
                          >
                            {currentFields.filter(f => f.sortable).map(f => (
                              <Select.Option key={f.key} value={f.key}>{f.label}</Select.Option>
                            ))}
                          </Select>
                          <Select
                            value={sort.order}
                            onChange={(value) => updateSort(index, 'order', value)}
                            style={{ width: 100 }}
                          >
                            <Select.Option value="asc">升序</Select.Option>
                            <Select.Option value="desc">降序</Select.Option>
                          </Select>
                          <Button size="small" danger onClick={() => removeSort(index)}>删除</Button>
                        </div>
                      </div>
                    ))}
                  </Card>
                </div>

                {/* 右侧操作面板 */}
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: 16 }}>
                  {/* 报表名称和操作 */}
                  <Card title="报表信息" size="small" style={{ flexShrink: 0 }}>
                    <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                      <Input
                        placeholder="输入报表名称"
                        value={reportName}
                        onChange={(e) => setReportName(e.target.value)}
                        style={{ flex: 1 }}
                      />
                      <Button type="primary" onClick={executeReport}>执行查询</Button>
                      <Button onClick={saveTemplate}>保存模板</Button>
                    </div>
                  </Card>

                  {/* 模板列表 */}
                  <Card title="已保存的模板" size="small" style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
                    <div style={{ flex: 1, overflow: 'auto' }}>
                      {savedTemplates.length === 0 ? (
                        <div style={{ textAlign: 'center', color: '#999', padding: 20 }}>暂无保存的模板</div>
                      ) : (
                        savedTemplates.map(template => (
                          <div
                            key={template.id}
                            style={{
                              padding: 12,
                              marginBottom: 8,
                              border: '1px solid #f0f0f0',
                              borderRadius: 4,
                              cursor: 'pointer',
                              display: 'flex',
                              justifyContent: 'space-between',
                              alignItems: 'center'
                            }}
                            onClick={() => loadTemplate(template)}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#f5f5f5'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                          >
                            <div>
                              <div style={{ fontWeight: 500 }}>{template.name}</div>
                              <div style={{ fontSize: 12, color: '#999', marginTop: 4 }}>
                                {dataSourceDefinitions[template.dataSource]?.name} | {template.createTime}
                              </div>
                            </div>
                            <Button
                              size="small"
                              danger
                              onClick={(e) => {
                                e.stopPropagation();
                                setSavedTemplates(savedTemplates.filter(t => t.id !== template.id));
                                message.success('模板已删除');
                              }}
                            >
                              删除
                            </Button>
                          </div>
                        ))
                      )}
                    </div>
                  </Card>
                </div>
              </div>
            </Tabs.TabPane>

            <Tabs.TabPane tab="报表预览" key="preview" style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}>
              <div style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
                <div style={{ marginBottom: 16, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <div>
                    <h3 style={{ margin: 0 }}>{reportName || '报表预览'}</h3>
                    <div style={{ fontSize: 12, color: '#999', marginTop: 4 }}>
                      数据源：{dataSourceDefinitions[dataSource]?.name} | 共 {reportData.length} 条记录
                    </div>
                  </div>
                  <div>
                    <Button onClick={() => {
                      // 导出功能（简化版）
                      const csv = [
                        selectedFields.map(f => currentFields.find(fd => fd.key === f)?.label || f).join(','),
                        ...reportData.map(row => selectedFields.map(f => row[f] || '').join(','))
                      ].join('\n');
                      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                      const link = document.createElement('a');
                      link.href = URL.createObjectURL(blob);
                      link.download = `${reportName || '报表'}_${new Date().toISOString().slice(0, 10)}.csv`;
                      link.click();
                      message.success('导出成功');
                    }}>导出CSV</Button>
                    <Button style={{ marginLeft: 8 }} onClick={() => setActiveTab('config')}>返回配置</Button>
                  </div>
                </div>
                <div style={{ flex: 1, overflow: 'auto' }}>
                  <Table
                    columns={selectedFields.map(fieldKey => {
                      const field = currentFields.find(f => f.key === fieldKey);
                      return {
                        title: field?.label || fieldKey,
                        dataIndex: fieldKey,
                        key: fieldKey,
                        width: 150,
                        render: (text) => {
                          if (text === null || text === undefined) return '-';
                          if (typeof text === 'number') {
                            // 如果是聚合字段，显示聚合结果
                            if (fieldKey.includes('_sum')) return Number(text).toLocaleString();
                            if (fieldKey.includes('_avg')) return Number(text).toFixed(2);
                            return Number(text).toLocaleString();
                          }
                          return String(text);
                        }
                      };
                    }).concat(
                      // 如果有分组聚合，显示聚合字段
                      groupBy.length > 0 ? selectedFields.filter(f => {
                        const field = currentFields.find(fd => fd.key === f);
                        return field && field.aggregatable;
                      }).flatMap(fieldKey => [
                        { title: `${currentFields.find(f => f.key === fieldKey)?.label}（合计）`, dataIndex: `${fieldKey}_sum`, key: `${fieldKey}_sum`, width: 150, render: (text) => text ? Number(text).toLocaleString() : '-' },
                        { title: `${currentFields.find(f => f.key === fieldKey)?.label}（平均）`, dataIndex: `${fieldKey}_avg`, key: `${fieldKey}_avg`, width: 150, render: (text) => text ? Number(text).toFixed(2) : '-' },
                        { title: `${currentFields.find(f => f.key === fieldKey)?.label}（数量）`, dataIndex: `${fieldKey}_count`, key: `${fieldKey}_count`, width: 100 }
                      ]) : []
                    )}
                    dataSource={reportData.map((row, index) => ({ ...row, key: index }))}
                    scroll={{ x: 'max-content' }}
                    pagination={{
                      pageSize: 20,
                      showSizeChanger: true,
                      showTotal: (total) => `共 ${total} 条记录`
                    }}
                  />
                </div>
              </div>
            </Tabs.TabPane>
          </Tabs>
        </div>
      );
    };

    // 匹配宝与委托备注页面
    const MatchAndRemark = () => {
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [filters, setFilters] = useState({
        dateRange: null, // [startDate, endDate]
        dateQuickFilter: 'today', // 'today' | 'history' | 'custom'
        futuresAccounts: [],
        hedgePlans: [],
        traders: [],
        contract: '',
        direction: null,
        openClose: null,
        orderStatus: [],
        shortNo: ''
      });
      const [filterForm] = Form.useForm();
      const [spotRemarkModalVisible, setSpotRemarkModalVisible] = useState(false);
      const [orderRemarkModalVisible, setOrderRemarkModalVisible] = useState(false);
      const [batchMatchModalVisible, setBatchMatchModalVisible] = useState(false);
      const [singleMatchModalVisible, setSingleMatchModalVisible] = useState(false);
      const [matchResultModalVisible, setMatchResultModalVisible] = useState(false);
      const [spotRemarkColumnEditorVisible, setSpotRemarkColumnEditorVisible] = useState(false);
      const [currentFuturesId, setCurrentFuturesId] = useState(null);
      const [spotRemarkForm] = Form.useForm();
      const [orderRemarkForm] = Form.useForm();
      const [batchMatchForm] = Form.useForm();
      const [singleMatchForm] = Form.useForm();
      const [changePlanModalVisible, setChangePlanModalVisible] = useState(false);
      const [virtualFuturesModalVisible, setVirtualFuturesModalVisible] = useState(false);
      const [changePlanForm] = Form.useForm();
      const [virtualFuturesForm] = Form.useForm();
      const [batchMatchFilter, setBatchMatchFilter] = useState('');
      const [batchMatchPage, setBatchMatchPage] = useState(1);

      // 重置筛选
      const resetFilters = () => {
        const defaultFilters = {
          dateRange: null,
          dateQuickFilter: 'today',
          futuresAccounts: [],
          hedgePlans: [],
          traders: [],
          contract: '',
          direction: null,
          openClose: null,
          orderStatus: [],
          shortNo: ''
        };
        setFilters(defaultFilters);
        filterForm.resetFields();
        filterForm.setFieldsValue({ dateQuickFilter: 'today' });
      };

      // 获取当前显示的委托单数据
      const displayOrders = useMemo(() => {
        let orders = [...mockFuturesOrders];
        
        // 日期筛选（优先使用快捷筛选，如果选择了自定义日期范围则使用日期范围）
        if (filters.dateRange && filters.dateRange.length === 2 && filters.dateQuickFilter === 'custom') {
          const [startDate, endDate] = filters.dateRange;
          if (startDate && endDate) {
            const start = dayjs(startDate).format('YYYY-MM-DD');
            const end = dayjs(endDate).format('YYYY-MM-DD');
            orders = orders.filter(order => {
              const orderDate = order.dateTime.substring(0, 10);
              return orderDate >= start && orderDate <= end;
            });
          }
        } else if (filters.dateQuickFilter === 'today') {
          // 当日筛选
          const today = '2025-11-24';
          orders = orders.filter(order => order.dateTime.startsWith(today));
        } else if (filters.dateQuickFilter === 'history') {
          // 历史筛选（排除当日）
          const today = '2025-11-24';
          orders = orders.filter(order => !order.dateTime.startsWith(today));
        }
        
        // 期货账户筛选
        if (filters.futuresAccounts && filters.futuresAccounts.length > 0) {
          orders = orders.filter(order => filters.futuresAccounts.includes(order.futuresAccount));
        }
        
        // 保值方案筛选
        if (filters.hedgePlans && filters.hedgePlans.length > 0) {
          orders = orders.filter(order => filters.hedgePlans.includes(order.hedgePlanId));
        }
        
        // 交易员筛选
        if (filters.traders && filters.traders.length > 0) {
          orders = orders.filter(order => {
            const acc = mockFuturesAccounts.find(a => a.account === order.futuresAccount);
            const orderTraders = acc?.traders || [];
            return filters.traders.some(t => orderTraders.includes(t));
          });
        }
        
        // 合约筛选
        if (filters.contract) {
          const contractKeyword = filters.contract.toLowerCase();
          orders = orders.filter(order => order.contract.toLowerCase().includes(contractKeyword));
        }
        
        // 方向筛选
        if (filters.direction) {
          orders = orders.filter(order => order.direction === filters.direction);
        }
        
        // 开平筛选
        if (filters.openClose) {
          orders = orders.filter(order => order.openClose === filters.openClose);
        }
        
        // 挂单状态筛选
        if (filters.orderStatus && filters.orderStatus.length > 0) {
          orders = orders.filter(order => filters.orderStatus.includes(order.orderStatus));
        }
        
        // 短编号筛选
        if (filters.shortNo) {
          const shortNoKeyword = filters.shortNo.toLowerCase();
          orders = orders.filter(order => order.shortNo.toLowerCase().includes(shortNoKeyword));
        }
        
        return orders;
      }, [filters]);

      // 所有可用列定义（一级字段）
      const allColumnDefinitions = [
        { key: 'futuresAccount', title: '期货账户', dataIndex: 'futuresAccount', width: 120, render: (account) => {
          const acc = mockFuturesAccounts.find(a => a.account === account);
          return acc?.alias || account || '-';
        }},
        { key: 'hedgePlan', title: '保值方案', dataIndex: 'hedgePlan', width: 180 },
        { key: 'dateTime', title: '日期时间', dataIndex: 'dateTime', width: 160 },
        { key: 'shortNo', title: '短编号', dataIndex: 'shortNo', width: 120 },
        { key: 'contract', title: '合约', dataIndex: 'contract', width: 120 },
        { key: 'direction', title: '方向', dataIndex: 'direction', width: 80, render: (dir) => (
          <Tag color={dir === '买入' ? 'red' : 'green'}>{dir}</Tag>
        )},
        { key: 'avgPrice', title: '成交均价', dataIndex: 'avgPrice', width: 120, align: 'right' },
        { key: 'tradedQty', title: '成交手数', dataIndex: 'tradedQty', width: 120, align: 'right', render: (qty, order) => {
          if (!qty && qty !== 0) return '-';
          const tons = calculateTons(qty, order.contract);
          return (
            <Tooltip title={tons}>
              <span style={{ cursor: 'help' }}>{qty} 手</span>
            </Tooltip>
          );
        }},
        { key: 'unmatchedQty', title: '未匹配手数', dataIndex: 'unmatchedQty', width: 120, align: 'right', render: (_, order) => {
          const matchedSum = (order.spotRemarks || [])
            .filter(r => r.isMatched)
            .reduce((sum, r) => sum + (r.qty || 0), 0);
          const unmatchedQty = (order.tradedQty || 0) - matchedSum;
          const tons = calculateTons(unmatchedQty, order.contract);
          return (
            <Tooltip title={tons}>
              <span style={{ cursor: 'help' }}>{unmatchedQty} 手</span>
            </Tooltip>
          );
        }},
        { 
          key: 'spotRemarks', 
          title: '期现备注', 
          dataIndex: 'spotRemarks', 
          width: 400,
          render: (remarks, record) => {
            if (!remarks || remarks.length === 0) return '-';
            
            // 根据配置的可见列动态生成表格列
            const spotRemarkTableColumns = spotRemarkVisibleColumns.map(col => {
              const def = spotRemarkColumnDefinitions.find(d => d.key === col.key);
              if (!def) return null;
              
              const columnDef = {
                ...def,
                ...col,
                width: col.width || def.width || 100,
                title: def.title,
                align: def.align || 'left',
                dataIndex: def.dataIndex
              };
              
              // 添加render函数
              if (col.key === 'qty') {
                columnDef.render = (v, remarkRecord) => {
                  if (!v && v !== 0) return '-';
                  const tons = calculateTons(v, record.contract);
                  return (
                    <Tooltip title={tons}>
                      <span style={{ cursor: 'help' }}>{v} 手</span>
                    </Tooltip>
                  );
                };
              } else if (col.key === 'spotQty') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'pricingPrice') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'tag') {
                columnDef.render = (tag) => tag ? <Tag>{tag}</Tag> : '-';
              } else if (col.key === 'remark') {
                columnDef.render = (v) => v || '-';
              } else if (col.key === 'customer') {
                // customer字段对应customerId
                columnDef.dataIndex = 'customerId';
                columnDef.render = (id) => {
                  if (!id) return '-';
                  const customer = mockCustomers.find(c => c.id === id);
                  return customer ? customer.shortName : '-';
                };
              } else if (col.key === 'contractNo') {
                // contractNo字段对应contractId
                columnDef.dataIndex = 'contractId';
                columnDef.render = (id) => {
                  if (!id) return '-';
                  const contract = mockContracts.find(c => c.id === id);
                  return contract ? contract.contractNo : '-';
                };
              } else if (col.key === 'isMatched') {
                columnDef.render = (matched) => (
                  <Tag color={matched ? 'green' : 'default'}>{matched ? '是' : '否'}</Tag>
                );
              }
              
              return columnDef;
            }).filter(Boolean);
            
            return (
              <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                <Table
                  size="small"
                  dataSource={remarks}
                  rowKey="id"
                  pagination={false}
                  columns={spotRemarkTableColumns}
                />
              </div>
            );
          }
        },
        { key: 'orderPrice', title: '报单价格', dataIndex: 'orderPrice', width: 120, align: 'right' },
        { key: 'orderStatus', title: '挂单状态', dataIndex: 'orderStatus', width: 100, render: (status) => {
          const statusMap = {
            '未成': { color: 'default' },
            '部成': { color: 'orange' },
            '全成': { color: 'green' },
            '已撤': { color: 'red' },
            '部成已撤': { color: 'red' },
            '错单': { color: 'red' }
          };
          const config = statusMap[status] || { color: 'default' };
          return <Tag color={config.color}>{status}</Tag>;
        }},
        { key: 'trader', title: '交易员', dataIndex: 'trader', width: 140, render: (_, order) => {
          const acc = mockFuturesAccounts.find(a => a.account === order.futuresAccount);
          return acc?.traders?.join(', ') || '-';
        }},
        { key: 'orderRemark', title: '委托备注', dataIndex: 'orderRemark', width: 200, ellipsis: true, render: (remark) => {
          if (!remark) return '';
          const text = remark.replace(/<[^>]*>/g, '').substring(0, 50);
          return (
            <Tooltip title={<div dangerouslySetInnerHTML={{ __html: remark }} />}>
              <span>{text}{remark.length > 50 ? '...' : ''}</span>
            </Tooltip>
          );
        }}
      ];

      // 期现备注二级字段列定义
      const spotRemarkColumnDefinitions = [
        { key: 'qty', title: '手数', dataIndex: 'qty', width: 80, align: 'right' },
        { key: 'spotQty', title: '现货数量', dataIndex: 'spotQty', width: 100, align: 'right' },
        { key: 'pricingPrice', title: '点价价格', dataIndex: 'pricingPrice', width: 100, align: 'right' },
        { key: 'tag', title: '标签', dataIndex: 'tag', width: 120 },
        { key: 'remark', title: '备注', dataIndex: 'remark', width: 150, ellipsis: true },
        { key: 'customer', title: '客商', dataIndex: 'customerId', width: 120 },
        { key: 'contractNo', title: '合同号', dataIndex: 'contractId', width: 120 },
        { key: 'isMatched', title: '是否已匹配', dataIndex: 'isMatched', width: 100 }
      ];

      // 期现备注二级字段的默认可见列
      const defaultSpotRemarkVisibleColumns = spotRemarkColumnDefinitions;

      // 期现备注二级字段的列管理
      const [spotRemarkVisibleColumns, setSpotRemarkVisibleColumns] = useState(() => {
        const saved = localStorage.getItem('match-remark-spot-columns');
        if (saved) {
          try {
            return JSON.parse(saved);
          } catch (e) {
            return defaultSpotRemarkVisibleColumns;
          }
        }
        return defaultSpotRemarkVisibleColumns;
      });

      useEffect(() => {
        localStorage.setItem('match-remark-spot-columns', JSON.stringify(spotRemarkVisibleColumns));
      }, [spotRemarkVisibleColumns]);

      // 期现备注列配置的保存和恢复
      const handleSpotRemarkColumnSave = (columns) => {
        setSpotRemarkVisibleColumns(columns);
        setSpotRemarkColumnEditorVisible(false);
        message.success('期现备注列设置已保存');
      };

      const handleSpotRemarkColumnRestoreDefault = () => {
        setSpotRemarkVisibleColumns(defaultSpotRemarkVisibleColumns);
        setSpotRemarkColumnEditorVisible(false);
        message.success('已恢复期现备注默认列设置');
      };

      const defaultVisibleColumns = allColumnDefinitions;

      const {
        tableColumns,
        columnEditorVisible,
        setColumnEditorVisible,
        handleColumnSave,
        handleColumnRestoreDefault,
        allColumnDefinitions: allCols,
        defaultVisibleColumns: defaultCols,
        visibleColumns: matchVisibleColumns
      } = useColumnManager('match-remark', allColumnDefinitions, defaultVisibleColumns, {
        onRowSelect: setSelectedRowKeys
      });

      // 获取保值方案的标签
      const getHedgePlanTags = (hedgePlanId) => {
        const plan = mockHedgePlans.find(hp => hp.id === hedgePlanId);
        return plan?.tags || [];
      };

      // 获取同保值方案的合同列表
      const getContractsByHedgePlan = (hedgePlanId) => {
        const plan = mockHedgePlans.find(hp => hp.id === hedgePlanId);
        if (!plan) return [];
        return mockContracts.filter(c => c.hedgePlan === plan.name);
      };

      // 处理期现备注
      const handleSpotRemark = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = displayOrders.find(o => o.id === selectedRowKeys[0]);
        if (order) {
          setCurrentFuturesId(order.id);
          spotRemarkForm.setFieldsValue({
            spotRemarks: order.spotRemarks || []
          });
          setSpotRemarkModalVisible(true);
        }
      };

      // 处理委托备注
      const handleOrderRemark = () => {
        if (selectedRowKeys.length !== 1) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = displayOrders.find(o => o.id === selectedRowKeys[0]);
        if (order) {
          setCurrentFuturesId(order.id);
          orderRemarkForm.setFieldsValue({
            orderRemark: order.orderRemark || ''
          });
          setOrderRemarkModalVisible(true);
        }
      };

      // 保存期现备注
      const handleSaveSpotRemark = () => {
        spotRemarkForm.validateFields().then(values => {
          const order = displayOrders.find(o => o.id === currentFuturesId);
          if (order) {
            const totalQty = (values.spotRemarks || []).reduce((sum, r) => sum + (r.qty || 0), 0);
            if (totalQty > order.tradedQty) {
              message.error(`期现备注中的总手数不能大于委托单的已成交手数（${order.tradedQty}）`);
              return;
            }
          }
          message.success('保存成功');
          setSpotRemarkModalVisible(false);
          spotRemarkForm.resetFields();
        });
      };

      // 保存委托备注
      const handleSaveOrderRemark = () => {
        orderRemarkForm.validateFields().then(values => {
          message.success('保存成功');
          setOrderRemarkModalVisible(false);
          orderRemarkForm.resetFields();
        });
      };

      // 删除委托备注
      const handleDeleteOrderRemark = () => {
        if (currentFuturesId) {
          message.success('删除成功');
          setOrderRemarkModalVisible(false);
          orderRemarkForm.resetFields();
        }
      };

      const selectedCount = selectedRowKeys.length;

      // 批量匹配
      const handleBatchMatch = () => {
        let selectedOrders = [];
        if (selectedRowKeys.length === 0) {
          // 未选择时，自动取前 10 条委托单作为测试数据
          selectedOrders = displayOrders.slice(0, 10);
        } else {
          selectedOrders = displayOrders.filter(o => selectedRowKeys.includes(o.id));
        }
        if (selectedOrders.length === 0) {
          message.warning('暂无可用于批量匹配的委托单');
          return;
        }
        batchMatchForm.setFieldsValue({
          matchRecords: selectedOrders.map(order => ({
            futuresId: order.id,
            hedgePlanId: order.hedgePlanId,
            contractId: null,
            contractQty: null,
            contractPrice: null,
            futuresQty: order.unmatchedQty
          }))
        });
        setBatchMatchModalVisible(true);
      };

      // 解除关联
      const handleSingleMatch = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要解除关联的委托单（可多选）');
          return;
        }
        const selectedOrders = displayOrders.filter(o => selectedRowKeys.includes(o.id));
        const records = [];
        selectedOrders.forEach(order => {
          (order.spotRemarks || [])
            .filter(r => r.isMatched)
            .forEach(r => {
              records.push({
                futuresId: order.id,
                hedgePlanId: order.hedgePlanId,
                spotRemarkId: r.id,
                tag: r.tag,
                qty: r.qty,
                remark: r.remark,
                toUnlink: true,
              });
            });
        });
        if (!records.length) {
          message.info('所选委托没有已匹配的期现备注，无需解除关联');
          return;
        }
        singleMatchForm.setFieldsValue({ records });
        setSingleMatchModalVisible(true);
      };

      // 变更保值方案
      const handleChangeHedgePlan = () => {
        if (selectedRowKeys.length === 0) {
          message.warning('请选择要变更保值方案的委托单（可多选）');
          return;
        }
        const selectedOrders = displayOrders.filter(o => selectedRowKeys.includes(o.id));
        const editableOrders = selectedOrders.filter(order => {
          const matchedRemarks = (order.spotRemarks || []).filter(r => r.isMatched);
          return matchedRemarks.length === 0;
        });
        if (!editableOrders.length) {
          message.info('所选委托均已有已匹配的期现备注，不能变更保值方案');
          return;
        }
        changePlanForm.setFieldsValue({
          records: editableOrders.map(order => ({
            futuresId: order.id,
            currentHedgePlanId: order.hedgePlanId,
            targetHedgePlanId: order.hedgePlanId
          }))
        });
        setChangePlanModalVisible(true);
      };

      const handleConfirmChangeHedgePlan = () => {
        changePlanForm.validateFields().then(values => {
          const records = values.records || [];
          if (!records.length) {
            message.warning('没有需要变更的记录');
            return;
          }
          message.success(`已为 ${records.length} 条委托变更保值方案（示意）`);
          setChangePlanModalVisible(false);
          changePlanForm.resetFields();
        });
      };

      // 虚拟期货
      const handleVirtualFutures = () => {
        virtualFuturesForm.resetFields();
        setVirtualFuturesModalVisible(true);
      };

      const handleConfirmVirtualFutures = () => {
        virtualFuturesForm.validateFields().then(values => {
          message.success('已创建虚拟期货指令（示意）');
          setVirtualFuturesModalVisible(false);
          virtualFuturesForm.resetFields();
        });
      };

      // 确认批量匹配
      const handleConfirmBatchMatch = () => {
        batchMatchForm.validateFields().then(values => {
          const matchRecords = values.matchRecords || [];
          const validRecords = matchRecords.filter(r => {
            const order = displayOrders.find(o => o.id === r.futuresId);
            if (!order) return false;
            const plan = mockHedgePlans.find(hp => hp.id === r.hedgePlanId);
            if (!plan) return false;
            
            // 检查匹配规则
            if (plan.type === '单单匹配') {
              // 需要检查标签
              const spotRemark = order.spotRemarks?.[0];
              if (spotRemark && spotRemark.tag) {
                const requireContractTags = ['长单保值', '长单增量', '长单减量', '长单取消', '订单接货保值', '订单出货保值', '订单增量', '订单减量', '订单取消', '买点价', '卖点价', '调敞口', '代持'];
                if (requireContractTags.includes(spotRemark.tag)) {
                  return !!r.contractId;
                }
              }
            }
            return true;
          });
          
          if (validRecords.length === 0) {
            message.warning('没有符合匹配规则的记录');
            return;
          }
          
          setBatchMatchModalVisible(false);
          setMatchResultModalVisible(true);
          message.success(`成功匹配 ${validRecords.length} 条记录`);
        });
      };

      // 确认解除关联
      const handleConfirmSingleMatch = () => {
        singleMatchForm.validateFields().then(values => {
          const records = values.records || [];
          if (!records.length) {
            message.warning('没有可解除的记录');
            return;
          }
          const toUnlink = records.filter(r => r.toUnlink);
          if (!toUnlink.length) {
            message.warning('请勾选需要解除关联的期现备注');
            return;
          }
          // 原型系统中不实际修改数据，只反馈操作结果
          message.success(`已解除 ${toUnlink.length} 条期现备注关联（示意）`);
          setSingleMatchModalVisible(false);
          singleMatchForm.resetFields();
        });
      };


      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <Form 
              form={filterForm} 
              layout="inline" 
              onValuesChange={(changedValues, allValues) => {
                if (changedValues.dateQuickFilter !== undefined) {
                  if (changedValues.dateQuickFilter === 'custom') {
                    // 切换到自定义时，保留已有日期范围
                    setFilters({ ...filters, dateQuickFilter: 'custom' });
                  } else {
                    // 切换到当日/历史时，清空日期范围
                    setFilters({ ...filters, dateQuickFilter: changedValues.dateQuickFilter, dateRange: null });
                    filterForm.setFieldsValue({ dateRange: null });
                  }
                } else if (changedValues.dateRange !== undefined) {
                  // 选择自定义日期范围时，自动切换到custom
                  setFilters({ ...filters, dateRange: changedValues.dateRange, dateQuickFilter: 'custom' });
                  filterForm.setFieldsValue({ dateQuickFilter: 'custom' });
                } else {
                  // 其他字段变化
                  setFilters({ ...filters, ...changedValues });
                }
              }}
              initialValues={{ dateQuickFilter: 'today' }}
              style={{ width: '100%' }}
            >
              <Space wrap style={{ flex: 1 }}>
                <Form.Item name="dateQuickFilter" label="日期">
                  <Radio.Group>
                    <Radio.Button value="today">当日</Radio.Button>
                    <Radio.Button value="history">历史</Radio.Button>
                    <Radio.Button value="custom">自定义</Radio.Button>
                  </Radio.Group>
                </Form.Item>
                {filters.dateQuickFilter === 'custom' && (
                  <Form.Item name="dateRange" label="日期范围">
                    <DatePicker.RangePicker style={{ width: 240 }} />
                  </Form.Item>
                )}
                <Form.Item name="futuresAccounts" label="期货账户">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 200 }}
                    options={mockFuturesAccounts.map(acc => ({ 
                      label: acc.alias || acc.account, 
                      value: acc.account 
                    }))}
                  />
                </Form.Item>
                <Form.Item name="hedgePlans" label="保值方案">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 200 }}
                    options={mockHedgePlans.map(plan => ({ label: plan.name, value: plan.id }))}
                  />
                </Form.Item>
                <Form.Item name="traders" label="交易员">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 200 }}
                    options={(() => {
                      const traderRole = mockPersonRoles.find(pr => pr.roleName === '交易员');
                      return traderRole?.personNames?.map(name => ({ label: name, value: name })) || [];
                    })()}
                  />
                </Form.Item>
                <Form.Item name="contract" label="合约">
                  <Input placeholder="合约代码" style={{ width: 150 }} allowClear />
                </Form.Item>
                <Form.Item name="direction" label="方向">
                  <Select
                    allowClear
                    placeholder="全部"
                    style={{ width: 100 }}
                    options={[
                      { label: '买入', value: '买入' },
                      { label: '卖出', value: '卖出' }
                    ]}
                  />
                </Form.Item>
                <Form.Item name="openClose" label="开平">
                  <Select
                    allowClear
                    placeholder="全部"
                    style={{ width: 100 }}
                    options={[
                      { label: '开仓', value: '开仓' },
                      { label: '平仓', value: '平仓' },
                      { label: '平今', value: '平今' }
                    ]}
                  />
                </Form.Item>
                <Form.Item name="orderStatus" label="挂单状态">
                  <Select
                    mode="multiple"
                    allowClear
                    placeholder="全部"
                    style={{ width: 150 }}
                    options={[
                      { label: '未成', value: '未成' },
                      { label: '部成', value: '部成' },
                      { label: '全成', value: '全成' },
                      { label: '已撤', value: '已撤' },
                      { label: '部成已撤', value: '部成已撤' },
                      { label: '错单', value: '错单' }
                    ]}
                  />
                </Form.Item>
                <Form.Item name="shortNo" label="短编号">
                  <Input placeholder="短编号" style={{ width: 150 }} allowClear />
                </Form.Item>
              </Space>
              <Space wrap>
                <Button icon={renderIcon('ReloadOutlined')} onClick={resetFilters}>重置</Button>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setSpotRemarkColumnEditorVisible(true)}
                >
                  期现备注列配置
                </Button>
                <Button 
                  icon={renderIcon('SettingOutlined')} 
                  onClick={() => setColumnEditorVisible(true)}
                >
                  自定义列
                </Button>
              </Space>
            </Form>
          </div>
          <div className="erp-toolbar" style={{ flexShrink: 0 }}>
            <Space wrap align="center">
              <span style={{ color: '#4b5565', fontSize: 12 }}>已选：{selectedCount} 条委托</span>
              <Button
                icon={renderIcon('FileTextOutlined')}
                onClick={handleSpotRemark}
                disabled={selectedCount !== 1}
                title="请只选择一条委托后操作期现备注"
              >
                期现备注
              </Button>
              <Button
                icon={renderIcon('EditOutlined')}
                onClick={handleOrderRemark}
                disabled={selectedCount !== 1}
                title="请只选择一条委托后操作委托备注"
              >
                委托备注
              </Button>
              <Button
                icon={renderIcon('ClusterOutlined')}
                onClick={handleBatchMatch}
                disabled={selectedCount === 0}
                title="根据规则对已选委托进行批量自动匹配，可多选/全选"
              >
                批量匹配
              </Button>
              <Button
                icon={renderIcon('SwapOutlined')}
                onClick={handleChangeHedgePlan}
                disabled={selectedCount === 0}
                title="对所选委托变更保值方案，已存在已匹配期现备注的委托不允许变更"
              >
                变更保值方案
              </Button>
              <Button
                icon={renderIcon('LinkOutlined')}
                onClick={handleSingleMatch}
                disabled={selectedCount === 0}
                title="对已选委托的已匹配期现备注进行解除关联，可多选/全选"
              >
                解除关联
              </Button>
              <Button
                icon={renderIcon('PlusCircleOutlined')}
                onClick={handleVirtualFutures}
                title="创建一笔虚拟期货，用于买卖保值方案之间的内部对冲"
              >
                虚拟期货
              </Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
            </Space>
            <Space align="center">
              <span style={{ fontSize: 12, color: '#9ca3af' }}>
                备注仅支持单条操作；批量匹配和指定匹配支持多选/全选。
              </span>
            </Space>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{ 
                  type: 'checkbox',
                  selectedRowKeys, 
                  onChange: setSelectedRowKeys 
                }}
                columns={tableColumns}
                dataSource={displayOrders}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={createPaginationConfig()}
              />
            </div>
          </div>

          {/* 期现备注模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="期现备注"
            open={spotRemarkModalVisible}
            onCancel={() => { setSpotRemarkModalVisible(false); spotRemarkForm.resetFields(); }}
            width={1000}
            onOk={handleSaveSpotRemark}
          >
            <Form form={spotRemarkForm} layout="vertical">
              <Form.List name="spotRemarks" initialValue={[]}>
                {(fields, { add, remove }) => {
                  const order = displayOrders.find(o => o.id === currentFuturesId);
                  const hedgePlanTags = order ? getHedgePlanTags(order.hedgePlanId) : [];
                  const contracts = order ? getContractsByHedgePlan(order.hedgePlanId) : [];
                  const plan = order ? mockHedgePlans.find(hp => hp.id === order.hedgePlanId) : null;
                  const isSingleMatch = plan?.type === '单单匹配';
                  const isSimplePlan = plan?.type === '整体匹配' || plan?.type === '无合同（客商）' || plan?.type === '无合同（人员）';

                  return (
                    <Space direction="vertical" style={{ width: '100%' }}>
                      {fields.map((field, index) => {
                        // 获取当前选择的合同信息
                        const selectedContractId = spotRemarkForm.getFieldValue(['spotRemarks', field.name, 'contractId']);
                        const selectedContract = selectedContractId ? mockContracts.find(c => c.id === selectedContractId) : null;
                        const isPricingContract = selectedContract?.pricing === '暂定价';
                        const isAvgPriceContract = selectedContract?.pricing === '均价';
                        
                        // 如果是单单匹配，根据合同类型决定是否显示现货数量和点价价格
                        const showSpotQtyAndPrice = isSingleMatch && isPricingContract;
                        
                        // 获取当前选择的合同信息（在组件外部计算，避免重复渲染）
                        const currentContractId = spotRemarkForm.getFieldValue(['spotRemarks', field.name, 'contractId']);
                        const currentContract = currentContractId ? mockContracts.find(c => c.id === currentContractId) : null;
                        const shouldShowSpotQtyAndPrice = isSingleMatch && currentContract?.pricing === '暂定价';
                        
                        // 计算需要显示的列数
                        let columnCount = 4; // 基础：手数、标签、备注、是否已匹配
                        if (isSingleMatch) columnCount += 1; // 合同号
                        if (shouldShowSpotQtyAndPrice) columnCount += 2; // 现货数量、点价价格
                        
                        return (
                          <Card key={field.key} size="small" title={`期现备注 ${index + 1}`} extra={
                            <Button type="text" danger icon={renderIcon('DeleteOutlined')} onClick={() => remove(field.name)}>删除</Button>
                          }>
                            <div
                              style={{
                                width: '100%',
                                display: 'grid',
                                gridTemplateColumns: `repeat(${Math.max(4, columnCount)}, minmax(0, 1fr))`,
                                columnGap: 16,
                                rowGap: 8,
                              }}
                            >
                              <Form.Item
                                {...field}
                                name={[field.name, 'qty']}
                                fieldKey={[field.fieldKey, 'qty']}
                                label="手数"
                                rules={[{ required: true, message: '请输入手数' }, { type: 'number', min: 0.01, message: '手数必须大于0' }]}
                                style={{ marginBottom: 4 }}
                              >
                                <Tooltip 
                                  title={(() => {
                                    const qty = spotRemarkForm.getFieldValue(['spotRemarks', field.name, 'qty']);
                                    return qty ? calculateTons(qty, order?.contract) : '';
                                  })()}
                                  trigger={['focus', 'hover']}
                                >
                                  <InputNumber 
                                    min={0.01} 
                                    step={0.01}
                                    style={{ width: '100%' }} 
                                    placeholder="请输入手数" 
                                  />
                                </Tooltip>
                              </Form.Item>
                              <Form.Item
                                noStyle
                                shouldUpdate={(prevValues, currentValues) => {
                                  const prevContractId = prevValues?.spotRemarks?.[field.name]?.contractId;
                                  const currentContractId = currentValues?.spotRemarks?.[field.name]?.contractId;
                                  return prevContractId !== currentContractId;
                                }}
                              >
                                {() => {
                                  const contractId = spotRemarkForm.getFieldValue(['spotRemarks', field.name, 'contractId']);
                                  const contract = contractId ? mockContracts.find(c => c.id === contractId) : null;
                                  const showSpotQtyAndPrice = isSingleMatch && contract?.pricing === '暂定价';
                                  
                                  return (
                                    <>
                                      {showSpotQtyAndPrice && (
                                        <Form.Item
                                          {...field}
                                          name={[field.name, 'spotQty']}
                                          fieldKey={[field.fieldKey, 'spotQty']}
                                          label="现货数量"
                                          style={{ marginBottom: 4 }}
                                        >
                                          <InputNumber min={0} style={{ width: '100%' }} placeholder="请输入现货数量（可选）" />
                                        </Form.Item>
                                      )}
                                      {showSpotQtyAndPrice && (
                                        <Form.Item
                                          {...field}
                                          name={[field.name, 'pricingPrice']}
                                          fieldKey={[field.fieldKey, 'pricingPrice']}
                                          label="点价价格"
                                          style={{ marginBottom: 4 }}
                                        >
                                          <InputNumber min={0} style={{ width: '100%' }} placeholder="请输入点价价格（可选）" />
                                        </Form.Item>
                                      )}
                                    </>
                                  );
                                }}
                              </Form.Item>
                              <Form.Item
                                {...field}
                                name={[field.name, 'tag']}
                                fieldKey={[field.fieldKey, 'tag']}
                                label="标签"
                                style={{ marginBottom: 4 }}
                              >
                                <Select placeholder="请选择标签" options={hedgePlanTags.map(tag => ({ label: tag, value: tag }))} />
                              </Form.Item>
                              {isSingleMatch && (
                                <Form.Item
                                  {...field}
                                  name={[field.name, 'contractId']}
                                  fieldKey={[field.fieldKey, 'contractId']}
                                  label="合同号"
                                  rules={[{ required: true, message: '请选择合同' }]}
                                  style={{ marginBottom: 4 }}
                                >
                                  <Select 
                                    placeholder="请选择合同"
                                    options={contracts.map(c => ({ label: c.contractNo, value: c.id }))}
                                    onChange={(value) => {
                                      // 如果已选合同，清空客商，并清空现货数量和点价价格（如果合同是均价类型）
                                      if (value) {
                                        const contract = mockContracts.find(c => c.id === value);
                                        const updates = { customerId: null };
                                        if (contract?.pricing === '均价') {
                                          updates.spotQty = null;
                                          updates.pricingPrice = null;
                                        }
                                        spotRemarkForm.setFieldsValue({
                                          spotRemarks: spotRemarkForm.getFieldValue('spotRemarks').map((r, i) => 
                                            i === field.name ? { ...r, ...updates } : r
                                          )
                                        });
                                      }
                                    }}
                                  />
                                </Form.Item>
                              )}
                              <Form.Item
                                {...field}
                                name={[field.name, 'remark']}
                                fieldKey={[field.fieldKey, 'remark']}
                                label="备注"
                                style={{ marginBottom: 4 }}
                              >
                                <Input placeholder="请输入备注" />
                              </Form.Item>
                              <Form.Item
                                {...field}
                                name={[field.name, 'isMatched']}
                                fieldKey={[field.fieldKey, 'isMatched']}
                                label="是否已匹配"
                                valuePropName="checked"
                                style={{ marginBottom: 4 }}
                              >
                                <Switch disabled />
                              </Form.Item>
                            </div>
                          </Card>
                        );
                      })}
                      <Button
                        type="dashed"
                        onClick={() => add({ qty: null, spotQty: null, pricingPrice: null, tag: null, remark: '', customerId: null, contractId: null, isMatched: false })}
                        icon={renderIcon('PlusOutlined')}
                        block
                      >
                        新增期现备注
                      </Button>
                    </Space>
                  );
                }}
              </Form.List>
            </Form>
          </Modal>

          {/* 委托备注模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="委托备注"
            open={orderRemarkModalVisible}
            onCancel={() => { setOrderRemarkModalVisible(false); orderRemarkForm.resetFields(); }}
            width={700}
            footer={[
              <Button key="delete" danger onClick={handleDeleteOrderRemark}>删除</Button>,
              <Button key="cancel" onClick={() => { setOrderRemarkModalVisible(false); orderRemarkForm.resetFields(); }}>取消</Button>,
              <Button key="ok" type="primary" onClick={handleSaveOrderRemark}>确认</Button>
            ]}
          >
            <Form form={orderRemarkForm} layout="vertical">
              <Form.Item label="备注信息" name="orderRemark">
                <Input.TextArea rows={8} placeholder="请输入委托备注" />
              </Form.Item>
            </Form>
          </Modal>

          {/* 批量匹配模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="批量匹配"
            open={batchMatchModalVisible}
            onCancel={() => { setBatchMatchModalVisible(false); batchMatchForm.resetFields(); setBatchMatchFilter(''); setBatchMatchPage(1); }}
            width={1400}
            bodyStyle={{ maxHeight: '80vh', overflow: 'hidden', paddingBottom: 8 }}
            onOk={handleConfirmBatchMatch}
          >
            <Form form={batchMatchForm} layout="vertical">
              <Form.List name="matchRecords">
                {(fields) => {
                  const matchRecords = batchMatchForm.getFieldValue('matchRecords') || [];
                  const filteredRecords = matchRecords.filter((record) => {
                    if (!batchMatchFilter) return true;
                    const order = displayOrders.find(o => o.id === record.futuresId);
                    const plan = mockHedgePlans.find(hp => hp.id === record.hedgePlanId);
                    const keyword = batchMatchFilter.toLowerCase();
                    return (
                      (order?.shortNo || '').toLowerCase().includes(keyword) ||
                      (order?.contract || '').toLowerCase().includes(keyword) ||
                      (order?.futuresAccount || '').toLowerCase().includes(keyword) ||
                      (plan?.name || '').toLowerCase().includes(keyword)
                    );
                  });
                  const pageSize = 10;
                  const total = filteredRecords.length;
                  const totalPages = Math.max(1, Math.ceil(total / pageSize));
                  const currentPage = Math.min(batchMatchPage, totalPages);
                  const startIndex = (currentPage - 1) * pageSize;
                  const pagedRecords = filteredRecords.slice(startIndex, startIndex + pageSize);

                  return (
                    <>
                      <div style={{ marginBottom: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8 }}>
                        <Input.Search
                          allowClear
                          placeholder="筛选短编号、合约、账户、保值方案"
                          value={batchMatchFilter}
                          onChange={(e) => { setBatchMatchFilter(e.target.value); setBatchMatchPage(1); }}
                          onSearch={(value) => { setBatchMatchFilter(value); setBatchMatchPage(1); }}
                          style={{ width: 320 }}
                          size="small"
                        />
                        <div style={{ display: 'flex', alignItems: 'center', gap: 16 }}>
                          <span style={{ fontSize: 12, color: '#9ca3af' }}>
                            共 {matchRecords.length} 条，当前显示 {pagedRecords.length} 条
                          </span>
                          <Pagination
                            size="small"
                            simple
                            total={total}
                            current={currentPage}
                            pageSize={pageSize}
                            onChange={(page) => setBatchMatchPage(page)}
                          />
                        </div>
                      </div>
                      <Table
                        size="small"
                        pagination={false}
                        dataSource={pagedRecords.map((record, index) => ({ ...record, key: startIndex + index }))}
                        columns={[
                        { title: '保值方案', dataIndex: 'hedgePlanId', width: 130, render: (id) => {
                          const plan = mockHedgePlans.find(hp => hp.id === id);
                          return plan?.name || '-';
                        }},
                        { title: '期货账户', dataIndex: 'futuresAccount', width: 100, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          const account = order?.futuresAccount;
                          if (!account) return '-';
                          const acc = mockFuturesAccounts.find(a => a.account === account);
                          return acc?.alias || account;
                        }},
                        { title: '日期时间', dataIndex: 'dateTime', width: 170, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          if (!order?.dateTime) return '-';
                          return dayjs(order.dateTime).format('MM-DD HH:mm:ss');
                        }},
                        { title: '合约', dataIndex: 'contract', width: 90, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.contract || '-';
                        }},
                        { title: '方向', dataIndex: 'direction', width: 70, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order ? <Tag color={order.direction === '买入' ? 'red' : 'green'}>{order.direction}</Tag> : '-';
                        }},
                        { title: '开平', dataIndex: 'openClose', width: 70, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.openClose || '-';
                        }},
                        { title: '标签', dataIndex: 'tag', width: 120, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          const firstTag = order?.spotRemarks?.[0]?.tag;
                          return firstTag ? <Tag>{firstTag}</Tag> : '-';
                        }},
                        { title: '价格', dataIndex: 'price', width: 80, render: (_, record) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return order?.avgPrice || '-';
                        }},
                        { title: '手数', dataIndex: 'futuresQty', width: 80, render: (qty, record, index) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          return (
                            <Form.Item name={[index, 'futuresQty']} style={{ margin: 0 }}>
                              <Tooltip 
                                title={(() => {
                                  const currentQty = batchMatchForm.getFieldValue(['matchRecords', index, 'futuresQty']) || qty;
                                  return currentQty ? calculateTons(currentQty, order?.contract) : '';
                                })()}
                                trigger={['focus', 'hover']}
                              >
                                <InputNumber 
                                  min={0.01} 
                                  step={0.01}
                                  style={{ width: '100%' }} 
                                  onChange={() => {
                                    // 触发重新渲染以更新 Tooltip
                                    batchMatchForm.setFieldsValue({});
                                  }}
                                />
                              </Tooltip>
                            </Form.Item>
                          );
                        }},
                        { title: '合同号', dataIndex: 'contractId', width: 140, render: (_, record, index) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          const contracts = order ? getContractsByHedgePlan(order.hedgePlanId) : [];
                          return (
                            <Form.Item name={[index, 'contractId']} style={{ margin: 0 }}>
                              <Select placeholder="请选择合同" options={contracts.map(c => ({ label: c.contractNo, value: c.id }))} />
                            </Form.Item>
                          );
                        }},
                        { title: '合同数量', dataIndex: 'contractQty', width: 90, render: (_, record, index) => (
                          <Form.Item name={[index, 'contractQty']} style={{ margin: 0 }}>
                            <InputNumber min={0} style={{ width: '100%' }} placeholder="可选" />
                          </Form.Item>
                        )},
                        { title: '合同价格', dataIndex: 'contractPrice', width: 90, render: (_, record, index) => (
                          <Form.Item name={[index, 'contractPrice']} style={{ margin: 0 }}>
                            <InputNumber min={0} style={{ width: '100%' }} placeholder="可选" />
                          </Form.Item>
                        )},
                        { title: '匹配状态', dataIndex: 'matchStatus', width: 110, render: (_, record, index) => {
                          const order = displayOrders.find(o => o.id === record.futuresId);
                          const plan = mockHedgePlans.find(hp => hp.id === record.hedgePlanId);
                          let isValid = true;
                          let reason = '';

                          if (!order || !plan) {
                            isValid = false;
                            reason = '数据缺失';
                          } else if (plan.type === '单单匹配') {
                            const spotRemark = order.spotRemarks?.[0];
                            if (spotRemark && spotRemark.tag) {
                              const requireContractTags = ['长单保值', '长单增量', '长单减量', '长单取消', '订单接货保值', '订单出货保值', '订单增量', '订单减量', '订单取消', '买点价', '卖点价', '调敞口', '代持'];
                              const requiresContract = requireContractTags.includes(spotRemark.tag);
                              if (requiresContract) {
                                const contractId = batchMatchForm.getFieldValue(['matchRecords', index, 'contractId']);
                                if (!contractId) {
                                  isValid = false;
                                  reason = '需选择合同';
                                }
                              }
                            }
                          }

                          return isValid ? (
                            <Tag color="green">可匹配</Tag>
                          ) : (
                            <Tag color="red">{reason || '暂不可匹配'}</Tag>
                          );
                        }}
                        ]}
                        scroll={{ y: 520 }}
                      />
                    </>
                  );
                }}
              </Form.List>
            </Form>
          </Modal>

      {/* 解除关联模态框 */}
          <Modal
            {...MODAL_TEXTS}
        title="解除关联"
            open={singleMatchModalVisible}
            onCancel={() => { setSingleMatchModalVisible(false); singleMatchForm.resetFields(); }}
        width={800}
            onOk={handleConfirmSingleMatch}
          >
            <Form form={singleMatchForm} layout="vertical">
          <Alert
            type="info"
            message="解除关联说明"
            description="列出所选委托下已匹配的期现备注，可勾选需要解除关联的记录。"
            style={{ marginBottom: 16 }}
          />
          <Form.List name="records">
            {(fields) => (
              <Table
                dataSource={fields}
                rowKey="key"
                pagination={false}
                scroll={{ y: 400 }}
                columns={[
                  {
                    title: '委托单',
                    dataIndex: 'futuresId',
                    render: (_, field) => {
                      const record = singleMatchForm.getFieldValue(['records', field.name]);
                      const order = displayOrders.find(o => o.id === record?.futuresId);
                      return order ? `${order.shortNo} / ${order.contract}` : '-';
                    }
                  },
                  {
                    title: '保值方案',
                    dataIndex: 'hedgePlanId',
                    render: (_, field) => {
                      const record = singleMatchForm.getFieldValue(['records', field.name]);
                      const plan = mockHedgePlans.find(hp => hp.id === record?.hedgePlanId);
                      return plan?.name || '-';
                    }
                  },
                  {
                    title: '标签',
                    dataIndex: 'tag',
                    render: (_, field) => {
                      const record = singleMatchForm.getFieldValue(['records', field.name]);
                      return record?.tag ? <Tag>{record.tag}</Tag> : '-';
                    }
                  },
                  {
                    title: '期现备注手数',
                    dataIndex: 'qty',
                    render: (_, field) => {
                      const record = singleMatchForm.getFieldValue(['records', field.name]);
                      const qty = record?.qty;
                      if (!qty && qty !== 0) return '-';
                      const order = displayOrders.find(o => o.id === record?.futuresId);
                      const tons = calculateTons(qty, order?.contract);
                      return (
                        <Tooltip title={tons}>
                          <span style={{ cursor: 'help' }}>{qty} 手</span>
                        </Tooltip>
                      );
                    }
                  },
                  {
                    title: '备注内容',
                    dataIndex: 'remark',
                    render: (_, field) => (
                      <span>
                        {singleMatchForm.getFieldValue(['records', field.name, 'remark']) || '-'}
                      </span>
                    )
                  },
                  {
                    title: '当前状态',
                    dataIndex: 'isMatched',
                    render: () => (
                      <Tag color="green">已匹配</Tag>
                    )
                  },
                  {
                    title: '是否解除关联',
                    dataIndex: 'toUnlink',
                    render: (_, field) => (
                      <Form.Item name={[field.name, 'toUnlink']} valuePropName="checked" style={{ margin: 0 }}>
                        <Checkbox />
                      </Form.Item>
                    )
                  }
                ]}
              />
            )}
          </Form.List>
              <Alert
                type="info"
            message="提示"
            description="原型系统中仅模拟解除关联操作，不对上方委托列表数据做真实修改。"
            style={{ marginTop: 16 }}
              />
            </Form>
          </Modal>

          {/* 变更保值方案模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="变更保值方案"
            open={changePlanModalVisible}
            onCancel={() => { setChangePlanModalVisible(false); changePlanForm.resetFields(); }}
            width={800}
            onOk={handleConfirmChangeHedgePlan}
          >
            <Form form={changePlanForm} layout="vertical">
              <Alert
                type="info"
                message="变更保值方案说明"
                description="仅支持对尚未产生已匹配期现备注的委托变更保值方案。已经存在已匹配期现备注的委托不在本列表中。"
                style={{ marginBottom: 16 }}
              />
              <Form.List name="records">
                {(fields) => (
                  <Table
                    dataSource={fields}
                    rowKey="key"
                    pagination={false}
                    scroll={{ y: 400 }}
                    columns={[
                      {
                        title: '委托单',
                        dataIndex: 'futuresId',
                        render: (_, field) => {
                          const record = changePlanForm.getFieldValue(['records', field.name]);
                          const order = displayOrders.find(o => o.id === record?.futuresId);
                          return order ? `${order.shortNo} / ${order.contract}` : '-';
                        }
                      },
                      {
                        title: '当前方案',
                        dataIndex: 'currentHedgePlanId',
                        render: (_, field) => {
                          const record = changePlanForm.getFieldValue(['records', field.name]);
                          const plan = mockHedgePlans.find(hp => hp.id === record?.currentHedgePlanId);
                          return plan?.name || '-';
                        }
                      },
                      {
                        title: '目标方案',
                        dataIndex: 'targetHedgePlanId',
                        render: (_, field) => (
                          <Form.Item name={[field.name, 'targetHedgePlanId']} style={{ margin: 0 }}>
                            <Select
                              placeholder="请选择目标保值方案"
                              options={mockHedgePlans.map(hp => ({ label: hp.name, value: hp.id }))}
                            />
                          </Form.Item>
                        )
                      }
                    ]}
                  />
                )}
              </Form.List>
              <Alert
                type="info"
                message="提示"
                description="本原型仅模拟变更操作，不会真正调整上方列表中的保值方案数据。"
                style={{ marginTop: 16 }}
              />
            </Form>
          </Modal>

          {/* 虚拟期货模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="虚拟期货"
            open={virtualFuturesModalVisible}
            onCancel={() => { setVirtualFuturesModalVisible(false); virtualFuturesForm.resetFields(); }}
            width={600}
            onOk={handleConfirmVirtualFutures}
          >
            <Form form={virtualFuturesForm} layout="vertical">
              <Alert
                type="info"
                message="虚拟期货说明"
                description="用于在买保值方案和卖保值方案之间创建一笔内部对冲的虚拟期货头寸，不直接对应真实交易。"
                style={{ marginBottom: 16 }}
              />
              <Form.Item
                label="买保值方案"
                name="buyHedgePlanId"
                rules={[{ required: true, message: '请选择买保值方案' }]}
              >
                <Select
                  placeholder="请选择买保值方案"
                  options={mockHedgePlans.map(hp => ({ label: hp.name, value: hp.id }))}
                />
              </Form.Item>
              <Form.Item
                label="卖保值方案"
                name="sellHedgePlanId"
                rules={[{ required: true, message: '请选择卖保值方案' }]}
              >
                <Select
                  placeholder="请选择卖保值方案"
                  options={mockHedgePlans.map(hp => ({ label: hp.name, value: hp.id }))}
                />
              </Form.Item>
              <Form.Item
                label="合约"
                name="contract"
                rules={[{ required: true, message: '请输入合约代码' }]}
              >
                <Input placeholder="例如 CU2401" />
              </Form.Item>
              <Form.Item
                label="手数"
                name="qty"
                rules={[{ required: true, message: '请输入手数' }]}
              >
                <InputNumber min={1} style={{ width: '100%' }} placeholder="请输入手数" />
              </Form.Item>
              <Form.Item
                label="价格"
                name="price"
                rules={[{ required: true, message: '请输入价格' }]}
              >
                <InputNumber min={0} style={{ width: '100%' }} placeholder="请输入价格" />
              </Form.Item>
            </Form>
          </Modal>

          {/* 匹配结果模态框 */}
          <Modal
            {...MODAL_TEXTS}
            title="匹配结果"
            open={matchResultModalVisible}
            onCancel={() => setMatchResultModalVisible(false)}
            width={800}
            footer={[
              <Button key="ok" type="primary" onClick={() => setMatchResultModalVisible(false)}>确认</Button>
            ]}
          >
            <Alert
              type="success"
              message="匹配成功"
              description="已成功完成批量匹配操作，相关记录已更新。"
              style={{ marginBottom: 16 }}
            />
            <Table
              columns={[
                { title: '委托单', dataIndex: 'futuresId' },
                { title: '匹配状态', dataIndex: 'status', render: () => <Tag color="green">成功</Tag> }
              ]}
              dataSource={[]}
              pagination={false}
            />
          </Modal>

          {columnEditorVisible && (
            <ColumnEditor
              allColumns={allCols}
              visibleColumns={matchVisibleColumns}
              onSave={handleColumnSave}
              onCancel={() => setColumnEditorVisible(false)}
              onRestoreDefault={handleColumnRestoreDefault}
            />
          )}
          {spotRemarkColumnEditorVisible && (
            <ColumnEditor
              allColumns={spotRemarkColumnDefinitions}
              visibleColumns={spotRemarkVisibleColumns}
              onSave={handleSpotRemarkColumnSave}
              onCancel={() => setSpotRemarkColumnEditorVisible(false)}
              onRestoreDefault={handleSpotRemarkColumnRestoreDefault}
            />
          )}
        </div>
      );
    };

    // 交易终端页面
    const WebTradeTerminal = () => {
      const [selectedAccount, setSelectedAccount] = useState(mockFuturesAccounts[0]?.account || '');
      const [selectedHedgePlan, setSelectedHedgePlan] = useState(mockHedgePlans[0]?.name || null);
      const [selectedContract, setSelectedContract] = useState('CU2401');
      const [selectedInstructionTab, setSelectedInstructionTab] = useState('mine');
      const [selectedWatchlistTab, setSelectedWatchlistTab] = useState('自选1');
      const [instructionDrawerVisible, setInstructionDrawerVisible] = useState(false);
      const [activeInstruction, setActiveInstruction] = useState(null);
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [selectedInstructionId, setSelectedInstructionId] = useState(null);
      const [assignModalVisible, setAssignModalVisible] = useState(false);
      const [currentAssignOrderId, setCurrentAssignOrderId] = useState(null);
      const [assignForm] = Form.useForm();
      const [orderForm] = Form.useForm();

      const mockInstructionCards = [
        {
          id: 'INS-001',
          type: '均价合同指令',
          status: '待认领',
          hedgePlan: '整体保值方案A',
          initiator: '福建石油',
          contractNo: 'HT2025-0001',
          tradeType: '销售',
          contractQty: 1000,
          contractPrice: 4670,
          futuresDirection: '买',
          futuresQty: 200,
          futuresContract: 'CU2401',
          futuresPrice: 5300,
          customer: '福建石油',
          tags: ['长单保值'],
          scopes: ['mine', 'all'],
          updatedAt: '2025-11-24 10:02',
          detail: {
            pricing: {
              method: '点价',
              window: '2025-11-20 ~ 2025-11-25',
              basis: 120,
              doneQty: 600,
              undoneQty: 400,
              logistics: '自提',
              warehouse: '上海保税仓'
            },
            children: [
              { id: 'INS-001-1', type: '子指令-均价', status: '执行中', operator: '交易员A', qty: 80, direction: '买' },
              { id: 'INS-001-2', type: '子指令-移仓', status: '待执行', operator: '交易员B', qty: 50, direction: '卖' }
            ],
            remarks: [
              { id: 1, author: '风控员', content: '请注意客商敞口，优先完成当日均价', time: '2025-11-24 09:50' },
              { id: 2, author: '交易员A', content: '上午已完成50手，待匹配现货', time: '2025-11-24 11:20' }
            ],
            logs: [
              { id: 1, content: '发起指令，系统自动生成期货需求200手', time: '2025-11-24 09:00' },
              { id: 2, content: '合同更新：数量+100吨', time: '2025-11-24 09:45' }
            ]
          }
        },
        {
          id: 'INS-002',
          type: '点价合同指令',
          status: '认领中',
          hedgePlan: '单单保值方案B',
          initiator: '嘉禾化工',
          contractNo: 'HT2025-0008',
          tradeType: '采购',
          contractQty: 800,
          contractPrice: 4520,
          futuresDirection: '卖',
          futuresQty: 120,
          futuresContract: 'AL2401',
          futuresPrice: 5240,
          customer: '嘉禾化工',
          tags: ['点价'],
          scopes: ['claim', 'all'],
          updatedAt: '2025-11-24 11:30',
          detail: {
            pricing: {
              method: '点价',
              window: '2025-11-24 09:00 ~ 15:00',
              basis: -80,
              doneQty: 400,
              undoneQty: 400,
              logistics: '送到',
              warehouse: '无锡仓'
            },
            children: [
              { id: 'INS-002-1', type: '子指令-点价', status: '已完成', operator: '交易员B', qty: 60, direction: '卖' },
              { id: 'INS-002-2', type: '子指令-点价', status: '待完成', operator: '交易员C', qty: 60, direction: '卖' }
            ],
            remarks: [
              { id: 1, author: '匹配员', content: '已匹配客商嘉禾化工发运批次', time: '2025-11-24 12:10' }
            ],
            logs: [
              { id: 1, content: '嘉禾提交点价申请，确认基差-80', time: '2025-11-24 10:05' }
            ]
          }
        }
      ];

      const mockWatchlists = {
        '自选1': [
          { key: 'CU2401', code: 'CU2401', name: '沪铜主力', trend: '+0.42%', latest: 5300, buyPrice: 5299, buyQty: 24, sellPrice: 5301, sellQty: 26 },
          { key: 'AL2401', code: 'AL2401', name: '沪铝主力', trend: '-0.18%', latest: 18230, buyPrice: 18225, buyQty: 12, sellPrice: 18235, sellQty: 10 }
        ],
        '自选2': [
          { key: 'ZN2401', code: 'ZN2401', name: '沪锌主力', trend: '+0.12%', latest: 21650, buyPrice: 21645, buyQty: 8, sellPrice: 21655, sellQty: 9 }
        ],
        '自选3': [],
        '外盘行情(延时)': [
          { key: 'GC2402', code: 'GC2402', name: 'COMEX金', trend: '-0.21%', latest: 2045.3, buyPrice: 2045.1, buyQty: 6, sellPrice: 2045.8, sellQty: 8 }
        ]
      };

      const mockMarketData = {
        CU2401: {
          latest: 5300,
          change: 50,
          changePercent: 0.95,
          volume: 10000,
          openInterest: 50000,
          high: 5320,
          low: 5230,
          open: 5250,
          prevClose: 5250,
          limitUp: 5500,
          limitDown: 5000,
          increase: 1200,
          amplitude: '0.71%',
          bid: [5299, 5298, 5297, 5296, 5295],
          bidVol: [24, 20, 18, 16, 12],
          ask: [5301, 5302, 5303, 5304, 5305],
          askVol: [22, 21, 19, 17, 15]
        },
        AL2401: {
          latest: 18230,
          change: -30,
          changePercent: -0.16,
          volume: 8000,
          openInterest: 42000,
          high: 18320,
          low: 18120,
          open: 18280,
          prevClose: 18260,
          limitUp: 18900,
          limitDown: 17600,
          increase: -600,
          amplitude: '0.55%',
          bid: [18228, 18226, 18224, 18222, 18220],
          bidVol: [14, 12, 10, 8, 6],
          ask: [18232, 18234, 18236, 18238, 18240],
          askVol: [13, 11, 9, 7, 5]
        }
      };

      const mockMatchOrders = [
        {
          id: 1,
          instructionId: 'INS-001',
          futuresAccount: 'ACC001',
          hedgePlan: '整体保值方案A',
          dateTime: '2025-11-24 10:30',
          shortNo: 'NO001',
          contract: 'CU2401',
          direction: '买入',
          avgPrice: 5300,
          tradedQty: 50,
          orderPrice: 5300,
          unmatchedQty: 20,
          orderStatus: '部成',
          orderRemark: '',
          spotRemarks: [
            { id: 1, qty: 20, spotQty: 100, pricingPrice: 5300, tag: '长单保值', remark: '待匹配', customer: '供应商A', contractNo: 'HT2025-0001', isMatched: false }
          ]
        },
        {
          id: 2,
          instructionId: 'INS-002',
          futuresAccount: 'ACC002',
          hedgePlan: '单单保值方案B',
          dateTime: '2025-11-24 11:00',
          shortNo: 'NO002',
          contract: 'AL2401',
          direction: '卖出',
          avgPrice: 5250,
          tradedQty: 30,
          orderPrice: 5250,
          unmatchedQty: 10,
          orderStatus: '全成',
          orderRemark: '点价组合',
          spotRemarks: [
            { id: 2, qty: 15, spotQty: 80, pricingPrice: 5250, tag: '点价', remark: '嘉禾第一批', customer: '嘉禾化工', contractNo: 'HT2025-0008', isMatched: true }
          ]
        },
        {
          id: 3,
          instructionId: 'INS-001',
          futuresAccount: 'ACC001',
          hedgePlan: '整体保值方案A',
          dateTime: '2025-11-24 13:20',
          shortNo: 'NO003',
          contract: 'CU2402',
          direction: '卖出',
          avgPrice: 5340,
          tradedQty: 0,
          orderPrice: 5340,
          unmatchedQty: 40,
          orderStatus: '未成',
          orderRemark: '',
          spotRemarks: []
        }
      ];

      const selectedInstruction = useMemo(
        () => mockInstructionCards.find(item => item.id === selectedInstructionId) || null,
        [mockInstructionCards, selectedInstructionId]
      );

      const selectedOrder = useMemo(
        () => mockMatchOrders.find(order => order.id === selectedRowKeys[0]) || null,
        [mockMatchOrders, selectedRowKeys]
      );

      const assignOrder = useMemo(
        () => mockMatchOrders.find(order => order.id === currentAssignOrderId) || null,
        [currentAssignOrderId, mockMatchOrders]
      );

      const mockPositions = [
        { id: 1, user: '交易员A', contract: 'CU2401', direction: '买入', qty: 120, avgPrice: 5280, lastPrice: 5305, floatingPnL: 3000, realizedPnL: 1200, margin: 450000, hedgePlan: '整体保值方案A' },
        { id: 2, user: '交易员B', contract: 'AL2401', direction: '卖出', qty: 80, avgPrice: 18260, lastPrice: 18230, floatingPnL: 2400, realizedPnL: 600, margin: 220000, hedgePlan: '单单保值方案B' }
      ];

      const mockFills = [
        { id: 1, contract: 'CU2401', direction: '买入', openClose: '开仓', price: 5300, qty: 10, fee: 50, matchNo: 'M001', time: '2025-11-24 10:30:15' },
        { id: 2, contract: 'AL2401', direction: '卖出', openClose: '平仓', price: 5250, qty: 5, fee: 25, matchNo: 'M002', time: '2025-11-24 11:00:20' }
      ];

      const mockClosed = [
        { id: 1, contract: 'CU2401', direction: '卖出', openPrice: 5200, closePrice: 5300, qty: 5, pnl: 5000, time: '2025-11-24 14:00', settlement: '现金' }
      ];

      const mockFunds = {
        equity: 1000000,
        available: 800000,
        occupied: 200000,
        riskDegree: 0.25,
        margin: 200000,
        floatingPnL: 32000,
        realizedPnL: 8500
      };

      const currentMarket = mockMarketData[selectedContract] || mockMarketData.CU2401;
      const lastClose = currentMarket.prevClose || (currentMarket.latest - currentMarket.change);

      const filteredInstructions = useMemo(() => {
        if (selectedInstructionTab === 'all') return mockInstructionCards;
        return mockInstructionCards.filter(item => item.scopes.includes(selectedInstructionTab));
      }, [selectedInstructionTab, mockInstructionCards]);

      const watchlistColumns = [
        { title: '合约', dataIndex: 'code', width: 90 },
        { title: '名称', dataIndex: 'name', width: 120 },
        { title: '走势', dataIndex: 'trend', width: 100 },
        { title: '最新', dataIndex: 'latest', width: 90 },
        { title: '买一价/量', dataIndex: 'buyPrice', width: 110, render: (_, record) => `${record.buyPrice} / ${record.buyQty}` },
        { title: '卖一价/量', dataIndex: 'sellPrice', width: 110, render: (_, record) => `${record.sellPrice} / ${record.sellQty}` }
      ];

      const spotRemarkColumns = [
        { title: '手数', dataIndex: 'qty', width: 70 },
        { title: '现货数量', dataIndex: 'spotQty', width: 90 },
        { title: '点价价格', dataIndex: 'pricingPrice', width: 90 },
        { title: '标签', dataIndex: 'tag', width: 100, render: (tag) => tag ? <Tag color="blue">{tag}</Tag> : '-' },
        { title: '备注', dataIndex: 'remark', width: 120 },
        { title: '客商', dataIndex: 'customer', width: 110 },
        { title: '合同号', dataIndex: 'contractNo', width: 120 },
        { title: '是否匹配', dataIndex: 'isMatched', width: 90, render: (matched) => <Tag color={matched ? 'green' : 'default'}>{matched ? '是' : '否'}</Tag> }
      ];

      const orderColumns = [
        { title: '指令编号', dataIndex: 'instructionId', width: 110 },
        { title: '期货账户', dataIndex: 'futuresAccount', width: 110, render: (account) => {
          if (!account) return '-';
          const acc = mockFuturesAccounts.find(a => a.account === account);
          return acc?.alias || account;
        }},
        { title: '保值方案', dataIndex: 'hedgePlan', width: 150 },
        { title: '日期时间', dataIndex: 'dateTime', width: 160 },
        { title: '短编号', dataIndex: 'shortNo', width: 100 },
        { title: '合约', dataIndex: 'contract', width: 90 },
        { title: '方向', dataIndex: 'direction', width: 70, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
        { title: '成交均价', dataIndex: 'avgPrice', width: 100, align: 'right' },
        { title: '成交手数', dataIndex: 'tradedQty', width: 100, align: 'right' },
        { title: '报单价格', dataIndex: 'orderPrice', width: 100, align: 'right' },
        { title: '未匹配手数', dataIndex: 'unmatchedQty', width: 110, align: 'right' },
        { title: '挂单状态', dataIndex: 'orderStatus', width: 110, render: (status) => <Tag color={status === '全成' ? 'green' : status === '未成' ? 'default' : 'orange'}>{status}</Tag> },
        { title: '委托备注', dataIndex: 'orderRemark', width: 180, render: (text) => text ? <Tooltip title={text}>{text}</Tooltip> : '-' },
        { title: '期现备注', dataIndex: 'spotRemarks', width: 120, render: (value) => value?.length ? <Tag color="blue">{value.length} 条</Tag> : '-' }
      ];

      const positionColumns = [
        { title: '用户', dataIndex: 'user', width: 100 },
        { title: '合约', dataIndex: 'contract', width: 100 },
        { title: '方向', dataIndex: 'direction', width: 70, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
        { title: '总仓', dataIndex: 'qty', width: 90, align: 'right' },
        { title: '均价', dataIndex: 'avgPrice', width: 90, align: 'right' },
        { title: '最新价', dataIndex: 'lastPrice', width: 90, align: 'right' },
        { title: '浮盈亏', dataIndex: 'floatingPnL', width: 100, align: 'right', render: (v) => <span style={{ color: v >= 0 ? 'red' : 'green' }}>{v >= 0 ? '+' : ''}{v}</span> },
        { title: '平仓盈亏', dataIndex: 'realizedPnL', width: 100, align: 'right' },
        { title: '占用保证金', dataIndex: 'margin', width: 120, align: 'right' },
        { title: '保值方案', dataIndex: 'hedgePlan', width: 150 }
      ];

      const tradeColumns = [
        { title: '时间', dataIndex: 'time', width: 150 },
        { title: '合约', dataIndex: 'contract', width: 100 },
        { title: '方向', dataIndex: 'direction', width: 70, render: (d) => <Tag color={d === '买入' ? 'red' : 'green'}>{d}</Tag> },
        { title: '开平', dataIndex: 'openClose', width: 70 },
        { title: '价格', dataIndex: 'price', width: 90, align: 'right' },
        { title: '数量', dataIndex: 'qty', width: 80, align: 'right' },
        { title: '手续费', dataIndex: 'fee', width: 80, align: 'right' },
        { title: '撮合编号', dataIndex: 'matchNo', width: 120 }
      ];

      const closedColumns = [
        { title: '平仓时间', dataIndex: 'time', width: 150 },
        { title: '合约', dataIndex: 'contract', width: 100 },
        { title: '方向', dataIndex: 'direction', width: 70 },
        { title: '开仓价格', dataIndex: 'openPrice', width: 100, align: 'right' },
        { title: '平仓价格', dataIndex: 'closePrice', width: 100, align: 'right' },
        { title: '数量', dataIndex: 'qty', width: 80, align: 'right' },
        { title: '平仓盈亏', dataIndex: 'pnl', width: 110, align: 'right', render: (v) => <span style={{ color: v >= 0 ? 'red' : 'green' }}>{v >= 0 ? '+' : ''}{v}</span> },
        { title: '结算方式', dataIndex: 'settlement', width: 100 }
      ];

      const colorByDelta = (value) => (value >= lastClose ? '#f5222d' : '#52c41a');
      const marketMetrics = [
        { label: '卖一', value: `${currentMarket.ask[0]} / ${currentMarket.askVol[0]}`, color: colorByDelta(currentMarket.ask[0]) },
        { label: '买一', value: `${currentMarket.bid[0]} / ${currentMarket.bidVol[0]}`, color: colorByDelta(currentMarket.bid[0]) },
        { label: '最新价', value: currentMarket.latest, color: colorByDelta(currentMarket.latest) },
        { label: '昨结', value: currentMarket.prevClose, color: '#1f2430' },
        { label: '今开', value: currentMarket.open, color: colorByDelta(currentMarket.open) },
        { label: '昨收', value: currentMarket.prevClose, color: '#1f2430' },
        { label: '涨跌', value: currentMarket.change, color: colorByDelta(currentMarket.latest) },
        { label: '最高', value: currentMarket.high, color: colorByDelta(currentMarket.high) },
        { label: '幅度', value: `${currentMarket.changePercent}%`, color: colorByDelta(currentMarket.changePercent) },
        { label: '最低', value: currentMarket.low, color: colorByDelta(currentMarket.low) },
        { label: '总手', value: currentMarket.volume.toLocaleString(), color: '#1f2430' },
        { label: '涨停', value: currentMarket.limitUp, color: colorByDelta(currentMarket.limitUp) },
        { label: '持仓', value: currentMarket.openInterest.toLocaleString(), color: '#1f2430' },
        { label: '跌停', value: currentMarket.limitDown, color: colorByDelta(currentMarket.limitDown) },
        { label: '增仓', value: currentMarket.increase.toLocaleString(), color: currentMarket.increase >= 0 ? '#f5222d' : '#52c41a' },
        { label: '振幅', value: currentMarket.amplitude, color: '#1f2430' }
      ];

      const currentTagOptions = useMemo(() => {
        const plan = mockHedgePlans.find(hp => hp.name === selectedHedgePlan);
        const source = plan?.tags?.length ? plan.tags : defaultTags;
        return source.map(tag => ({ label: tag, value: tag }));
      }, [selectedHedgePlan]);

      useEffect(() => {
        orderForm.setFieldsValue({ hedgePlan: selectedHedgePlan });
      }, [selectedHedgePlan, orderForm]);

      useEffect(() => {
        orderForm.setFieldsValue({ contract: selectedContract, price: currentMarket.latest });
      }, [selectedContract, currentMarket.latest, orderForm]);

      useEffect(() => {
        if (currentTagOptions.length) {
          orderForm.setFieldsValue({ tag: currentTagOptions[0].value });
        } else {
          orderForm.setFieldsValue({ tag: undefined });
        }
      }, [currentTagOptions, orderForm]);

      useEffect(() => {
        orderForm.setFieldsValue({ direction: 'buy', openClose: 'open', priceType: '对价', qty: 1 });
      }, [orderForm]);

      const handleInstructionAction = (item, action) => {
        message.success(`${action} - ${item.id}（模拟）`);
      };

      const handleInstructionClick = (item) => {
        setActiveInstruction(item);
        setInstructionDrawerVisible(true);
      };

      const handleFillOrderForm = (item) => {
        setSelectedHedgePlan(item.hedgePlan);
        setSelectedContract(item.futuresContract);
        orderForm.setFieldsValue({
          instructionId: item.id,
          hedgePlan: item.hedgePlan,
          contract: item.futuresContract,
          direction: item.futuresDirection === '买' ? 'buy' : 'sell',
          openClose: 'open',
          qty: item.futuresQty,
          price: item.futuresPrice,
          tag: item.tags?.[0]
        });
        message.info(`已填充指令 ${item.id} 至下单板`);
      };

      const handleAddWatchlist = (value) => {
        if (value) {
          message.success(`已添加 ${value} 至 ${selectedWatchlistTab}`);
        }
      };

      const handleOrderAction = (record, action) => {
        message.info(`${action} - ${record.shortNo}`);
      };

      const handleOrderToolbarAction = (action) => {
        if (!selectedOrder) {
          message.warning('请选择一条委托单');
          return;
        }
        handleOrderAction(selectedOrder, action);
      };

      const handleAssignInstruction = (orderId) => {
        const targetOrderId = orderId || selectedRowKeys[0];
        if (!selectedInstructionId) {
          message.warning('请选择一条指令');
          return;
        }
        if (!targetOrderId) {
          message.warning('请选择一条委托单');
          return;
        }
        const order = mockMatchOrders.find(o => o.id === targetOrderId);
        setCurrentAssignOrderId(targetOrderId);
        assignForm.setFieldsValue({
          futuresQty: order?.unmatchedQty || 0,
          contractQty: order?.contractQty || order?.tradedQty || null,
          contractPrice: order?.orderPrice || null
        });
        setAssignModalVisible(true);
      };

      const handleConfirmAssign = () => {
        assignForm.validateFields().then(values => {
          message.success(`指令 ${selectedInstructionId} 已配入委托 ${currentAssignOrderId}`);
          setAssignModalVisible(false);
          assignForm.resetFields();
        });
      };

      const handleCancelAssign = () => {
        setAssignModalVisible(false);
        assignForm.resetFields();
      };

      const handleSubmitOrder = () => {
        orderForm.validateFields().then(values => {
          message.success(`下单成功（模拟）：${values.contract} / ${values.qty}`);
        });
      };

      const instructionTabs = [
        { key: 'mine', label: '我发起的' },
        { key: 'claim', label: '我认领的' },
        { key: 'all', label: '全部' }
      ];

      const instructionTabItems = instructionTabs.map(tab => ({
        key: tab.key,
        label: tab.label
      }));

      const orderRowSelection = {
        type: 'radio',
        selectedRowKeys,
        onChange: setSelectedRowKeys
      };

      const orderItemStyle = { marginBottom: 4 };

      const expandedRowRender = (record) => {
        if (!record.spotRemarks?.length) {
          return <div style={{ padding: 8 }}>暂无期现备注</div>;
        }
        return (
          <Table
            size="small"
            columns={spotRemarkColumns}
            dataSource={record.spotRemarks.map(item => ({ key: item.id, ...item }))}
            pagination={false}
          />
        );
      };

      const watchlistGroupKeys = Object.keys(mockWatchlists);

      const ordersTable = (
        <Table
          size="small"
          rowSelection={orderRowSelection}
          columns={orderColumns}
          dataSource={mockMatchOrders}
          rowKey="id"
          pagination={false}
          expandable={{ expandedRowRender, rowExpandable: (record) => record.spotRemarks?.length > 0 }}
          scroll={{ x: 1400 }}
        />
      );

      const orderToolbar = (
        <div className="erp-toolbar" style={{ padding: '4px 8px', borderBottom: '1px solid #f0f2f5', background: '#f8f9fb', flexShrink: 0 }}>
          <Space wrap size={8}>
            <Button size="small" icon={renderIcon('FileTextOutlined')} onClick={() => handleOrderToolbarAction('期现备注')} disabled={!selectedOrder}>期现备注</Button>
            <Button size="small" icon={renderIcon('EditOutlined')} onClick={() => handleOrderToolbarAction('委托备注')} disabled={!selectedOrder}>委托备注</Button>
            <Button size="small" type="primary" icon={renderIcon('LinkOutlined')} onClick={() => handleAssignInstruction()} disabled={!selectedInstructionId || !selectedOrder}>配入指令</Button>
            <Button size="small" icon={renderIcon('DownloadOutlined')} onClick={() => message.info('导出（模拟）')}>导出</Button>
            <Button size="small" icon={renderIcon('ReloadOutlined')} onClick={() => message.success('已刷新')}>刷新</Button>
          </Space>
          <div style={{ marginLeft: 'auto', fontSize: 12, color: '#8a94a6' }}>
            {selectedInstruction ? `已选指令：${selectedInstruction.id}` : '未选指令'}
          </div>
        </div>
      );

      const ordersTabContent = (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0 }}>
          {orderToolbar}
          <div style={{ flex: 1, minHeight: 0 }}>
            {ordersTable}
          </div>
        </div>
      );

      const positionsTable = (
        <Table
          size="small"
          columns={positionColumns}
          dataSource={mockPositions}
          rowKey="id"
          pagination={false}
          scroll={{ x: 1000 }}
        />
      );

      const tradesTable = (
        <Table
          size="small"
          columns={tradeColumns}
          dataSource={mockFills}
          rowKey="id"
          pagination={false}
          scroll={{ x: 900 }}
        />
      );

      const closedTable = (
        <Table
          size="small"
          columns={closedColumns}
          dataSource={mockClosed}
          rowKey="id"
          pagination={false}
          scroll={{ x: 900 }}
        />
      );

      const fundsSummary = (
        <Space direction="vertical" style={{ width: '100%' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <span>权益：</span>
            <strong>{mockFunds.equity.toLocaleString()}</strong>
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <span>可用：</span>
            <strong style={{ color: 'green' }}>{mockFunds.available.toLocaleString()}</strong>
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <span>占用：</span>
            <strong>{mockFunds.occupied.toLocaleString()}</strong>
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <span>风险度：</span>
            <strong style={{ color: mockFunds.riskDegree > 0.8 ? 'red' : 'green' }}>{(mockFunds.riskDegree * 100).toFixed(2)}%</strong>
          </div>
          <div style={{ display: 'flex', justifyContent: 'space-between' }}>
            <span>保证金：</span>
            <strong>{mockFunds.margin.toLocaleString()}</strong>
          </div>
        </Space>
      );

      const renderTabContent = (content, padding = 6) => (
        <div style={{ height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0 }}>
          <div style={{ flex: 1, minHeight: 0, padding }}>
            <div style={{ height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0 }}>
              <div className="erp-table-wrapper">
                {content}
              </div>
            </div>
          </div>
        </div>
      );

      const orderTabItems = [
        { key: 'orders', label: '委托列表', children: renderTabContent(ordersTabContent, 0) },
        { key: 'positions', label: '持仓列表', children: renderTabContent(positionsTable) },
        { key: 'trades', label: '成交列表', children: renderTabContent(tradesTable) },
        { key: 'closed', label: '平仓明细', children: renderTabContent(closedTable) },
        { key: 'funds', label: '资金', children: renderTabContent(fundsSummary) }
      ];

      return (
        <ConfigProvider componentSize="small">
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column', background: '#eef2f6' }}>
          <div style={{ flex: 1, padding: '4px 8px 8px', overflow: 'hidden' }}>
            <div
              style={{
                height: '100%',
                display: 'grid',
                gridTemplateColumns: 'repeat(12, minmax(0, 1fr))',
                gridTemplateRows: '36px repeat(11, minmax(0, 1fr))',
                gap: 8
              }}
            >
              {/* 左侧指令列表 */}
              <Card
                style={{ gridColumn: '1 / span 3', gridRow: '1 / span 12', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}
                bodyStyle={{ padding: 0, display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0 }}
              >
                <Tabs
                  size="small"
                  activeKey={selectedInstructionTab}
                  onChange={setSelectedInstructionTab}
                  tabBarStyle={{ paddingLeft: 8 }}
                  items={instructionTabItems}
                />
                <div style={{ padding: 8, flex: 1, overflow: 'auto', display: 'flex', flexDirection: 'column', gap: 8 }}>
                  <List
                    size="small"
                    dataSource={filteredInstructions}
                    renderItem={(item) => (
                      <List.Item style={{ padding: 0, border: 'none' }}>
                        <Card
                          size="small"
                          hoverable
                          style={{ width: '100%', borderColor: selectedInstructionId === item.id ? '#1677ff' : undefined }}
                          onClick={() => setSelectedInstructionId(item.id)}
                        >
                          <Space direction="vertical" style={{ width: '100%' }} size={6}>
                            <Space style={{ width: '100%', justifyContent: 'space-between' }}>
                              <span style={{ fontWeight: 600 }}>{item.type}</span>
                              <Tag color={item.status === '待认领' ? 'orange' : 'blue'}>{item.status}</Tag>
                            </Space>
                            <div style={{ color: '#8a94a6', fontSize: 12 }}>
                              合同 {item.contractNo} · 客商 {item.initiator} · 更新时间 {item.updatedAt}
                            </div>
                            <div style={{ fontSize: 12 }}>
                              合同 {item.tradeType} {item.contractQty} 吨 · 期货 {item.futuresDirection} {item.futuresQty} 手 {item.futuresContract}
                            </div>
                            <Space wrap size={4}>
                              <Button size="small" onClick={(e) => { e.stopPropagation(); handleInstructionAction(item, '认领/取消认领'); }}>认领</Button>
                              <Button size="small" onClick={(e) => { e.stopPropagation(); handleInstructionAction(item, '同意/拒绝'); }}>撤销处理</Button>
                              <Button size="small" onClick={(e) => { e.stopPropagation(); handleInstructionAction(item, '完成指令'); }}>完成</Button>
                              <Button size="small" onClick={(e) => { e.stopPropagation(); handleInstructionAction(item, '备注'); }}>备注</Button>
                              <Button size="small" type="link" onClick={(e) => { e.stopPropagation(); handleFillOrderForm(item); }}>填入下单板</Button>
                              <Button size="small" type="link" onClick={(e) => { e.stopPropagation(); handleInstructionClick(item); }}>查看</Button>
                            </Space>
                          </Space>
                        </Card>
                      </List.Item>
                    )}
                  />
                </div>
              </Card>

              {/* 顶部账户资金区域 */}
              <div style={{ gridColumn: '4 / span 9', gridRow: '1 / span 1', display: 'flex', alignItems: 'center', gap: 12, padding: '0 8px' }}>
                <Select size="small" value={selectedAccount} onChange={setSelectedAccount} style={{ width: 160 }}>
                  {mockFuturesAccounts.map(acc => (
                    <Select.Option key={acc.id} value={acc.account}>
                      {acc.alias || acc.account}
                    </Select.Option>
                  ))}
                </Select>
                <Space size={14} wrap>
                  <span>风险度：<strong style={{ color: mockFunds.riskDegree > 0.8 ? '#f5222d' : '#52c41a' }}>{(mockFunds.riskDegree * 100).toFixed(1)}%</strong></span>
                  <span>可用：<strong>{mockFunds.available.toLocaleString()}</strong></span>
                  <span>持仓盈亏：<strong style={{ color: mockFunds.floatingPnL >= 0 ? '#f5222d' : '#52c41a' }}>{mockFunds.floatingPnL >= 0 ? '+' : ''}{mockFunds.floatingPnL.toLocaleString()}</strong></span>
                  <span>平仓盈亏：<strong style={{ color: mockFunds.realizedPnL >= 0 ? '#f5222d' : '#52c41a' }}>{mockFunds.realizedPnL >= 0 ? '+' : ''}{mockFunds.realizedPnL.toLocaleString()}</strong></span>
                </Space>
                <span style={{ marginLeft: 'auto', fontSize: 12, color: '#389e0d' }}>登录成功</span>
              </div>

              {/* 中间：盘口 + 下单板 */}
              <Card
                style={{ gridColumn: '4 / span 2', gridRow: '2 / span 4', display: 'flex', flexDirection: 'column', minHeight: 0 }}
                bodyStyle={{ padding: 10, flex: 1, display: 'flex', flexDirection: 'column', overflow: 'auto' }}
              >
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, minmax(0, 1fr))', gap: 8 }}>
                  {marketMetrics.map(metric => (
                    <div key={metric.label} style={{ display: 'flex', justifyContent: 'space-between', fontSize: 13 }}>
                      <span style={{ color: '#8a94a6' }}>{metric.label}</span>
                      <strong style={{ color: metric.color }}>{metric.value}</strong>
                    </div>
                  ))}
                </div>
              </Card>

              <Card
                style={{ gridColumn: '4 / span 2', gridRow: '6 / span 7', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}
                bodyStyle={{ padding: 12, display: 'flex', flexDirection: 'column', gap: 8, flex: 1, minHeight: 0 }}
              >
                <Form form={orderForm} layout="vertical" style={{ flex: 1, display: 'flex', flexDirection: 'column', overflow: 'auto' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(110px, 1fr))', gap: 4 }}>
                    <Form.Item label="指令编号" name="instructionId" style={orderItemStyle}>
                      <Input placeholder="可输入或从指令填充" />
                    </Form.Item>
                    <Form.Item label="保值方案" name="hedgePlan" style={orderItemStyle}>
                      <Select
                        placeholder="选择保值方案"
                        value={selectedHedgePlan}
                        onChange={setSelectedHedgePlan}
                      >
                        {mockHedgePlans.map(plan => (
                          <Select.Option key={plan.id} value={plan.name}>{plan.name}</Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                    <Form.Item label="合约代码" name="contract" style={orderItemStyle}>
                      <Input placeholder="如 CU2401" />
                    </Form.Item>
                    <Form.Item label="方向" name="direction" style={orderItemStyle}>
                      <Radio.Group optionType="button" buttonStyle="solid">
                        <Radio.Button value="buy">买入</Radio.Button>
                        <Radio.Button value="sell">卖出</Radio.Button>
                      </Radio.Group>
                    </Form.Item>
                    <Form.Item label="开平方向" name="openClose" style={orderItemStyle}>
                      <Radio.Group optionType="button" buttonStyle="solid">
                        <Radio.Button value="open">开仓</Radio.Button>
                        <Radio.Button value="close">平仓</Radio.Button>
                        <Radio.Button value="closeToday">平今</Radio.Button>
                        <Radio.Button value="auto">自动</Radio.Button>
                      </Radio.Group>
                    </Form.Item>
                    <Form.Item label="价格类型" name="priceType" style={orderItemStyle}>
                      <Radio.Group optionType="button" buttonStyle="solid">
                        <Radio.Button value="对价">对价</Radio.Button>
                        <Radio.Button value="挂价">挂价</Radio.Button>
                        <Radio.Button value="市价">市价</Radio.Button>
                        <Radio.Button value="指定">指定</Radio.Button>
                      </Radio.Group>
                    </Form.Item>
                    <Form.Item label="标签" name="tag" style={orderItemStyle}>
                      <Select options={currentTagOptions} placeholder="请选择标签" />
                    </Form.Item>
                    <Form.Item label="数量(手)" name="qty" style={orderItemStyle}>
                      <InputNumber min={1} style={{ width: '100%' }} />
                    </Form.Item>
                    <Form.Item label="价格" name="price" style={orderItemStyle}>
                      <InputNumber style={{ width: '100%' }} />
                    </Form.Item>
                    <Form.Item label="套保" name="hedgeFlag" valuePropName="checked" style={orderItemStyle}>
                      <Checkbox>启用套保标记</Checkbox>
                    </Form.Item>
                    <Form.Item label="保证金" style={orderItemStyle}>
                      <Input disabled value={(orderForm.getFieldValue('qty') || 0) * 1000} />
                    </Form.Item>
                    <Form.Item label="手续费" style={orderItemStyle}>
                      <Input disabled value={(orderForm.getFieldValue('qty') || 0) * 5} />
                    </Form.Item>
                  </div>
                  <Space style={{ marginTop: 2 }}>
                    <Button type="primary" icon={renderIcon('CheckCircleOutlined')} onClick={handleSubmitOrder}>下单</Button>
                    <Button onClick={() => orderForm.resetFields()}>重置</Button>
                  </Space>
                </Form>
              </Card>

              {/* 右侧：自选与数据列表 */}
              <Card
                style={{ gridColumn: '6 / span 7', gridRow: '2 / span 3', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}
                bodyStyle={{ padding: 12, flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}
              >
                <Input.Search
                  size="small"
                  placeholder="输入合约代码加入自选"
                  enterButton="添加"
                  allowClear
                  onSearch={handleAddWatchlist}
                  addonBefore={
                    <Select
                      size="small"
                      value={selectedWatchlistTab}
                      onChange={setSelectedWatchlistTab}
                      style={{ width: 120 }}
                    >
                      {watchlistGroupKeys.map(key => (
                        <Select.Option key={key} value={key}>{key}</Select.Option>
                      ))}
                    </Select>
                  }
                  style={{ marginBottom: 8 }}
                />
                <div style={{ flex: 1, minHeight: 0, overflow: 'auto' }}>
                  <Table
                    size="small"
                    columns={watchlistColumns}
                    dataSource={mockWatchlists[selectedWatchlistTab] || []}
                    rowKey="key"
                    pagination={false}
                  />
                </div>
              </Card>

              <Card
                style={{ gridColumn: '6 / span 7', gridRow: '5 / span 8', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'hidden' }}
                bodyStyle={{ padding: 0, display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0 }}
              >
                <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}>
                <Tabs
                    defaultActiveKey="orders"
                    items={orderTabItems}
                    tabBarStyle={{ paddingLeft: 8 }}
                  style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}
                  className="erp-fill-tabs"
                  />
                </div>
              </Card>
            </div>
          </div>

          <div style={{ height: 40, background: '#fff', borderTop: '1px solid #e5e8ef', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 20px' }}>
            <Space>
              <Badge status="processing" text="行情正常" />
              <Badge status="processing" text="交易正常" />
            </Space>
            <span>更新时间：{new Date().toLocaleString()}</span>
          </div>

          <Modal
            title="配入指令"
            open={assignModalVisible}
            onOk={handleConfirmAssign}
            onCancel={handleCancelAssign}
            destroyOnClose
          >
            <Space direction="vertical" style={{ width: '100%' }}>
              <Alert
                type="info"
                showIcon
                message={selectedInstruction && assignOrder ? `指令 ${selectedInstruction.id} → 委托 ${assignOrder.shortNo}` : '请选择指令与委托后提交'}
              />
              <Form form={assignForm} layout="vertical">
                <Form.Item label="期货数量(手)" name="futuresQty" rules={[{ required: true, message: '请输入期货数量' }]}>
                  <InputNumber min={1} style={{ width: '100%' }} />
                </Form.Item>
                <Form.Item label="合同数量(吨)" name="contractQty" rules={[{ required: true, message: '请输入合同数量' }]}>
                  <InputNumber min={1} style={{ width: '100%' }} />
                </Form.Item>
                <Form.Item label="合同价格" name="contractPrice" rules={[{ required: true, message: '请输入合同价格' }]}>
                  <InputNumber min={0} style={{ width: '100%' }} />
                </Form.Item>
              </Form>
            </Space>
          </Modal>

          <Drawer
            title={activeInstruction ? `指令详情 · ${activeInstruction.id}` : '指令详情'}
            placement="right"
            width={720}
            open={instructionDrawerVisible}
            onClose={() => setInstructionDrawerVisible(false)}
          >
            {activeInstruction ? (
              <Space direction="vertical" size={16} style={{ width: '100%' }}>
                <Card size="small" title="基础信息">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="指令编号">{activeInstruction.id}</Descriptions.Item>
                    <Descriptions.Item label="状态">{activeInstruction.status}</Descriptions.Item>
                    <Descriptions.Item label="保值方案">{activeInstruction.hedgePlan}</Descriptions.Item>
                    <Descriptions.Item label="发起人">{activeInstruction.initiator}</Descriptions.Item>
                    <Descriptions.Item label="合同编号">{activeInstruction.contractNo}</Descriptions.Item>
                    <Descriptions.Item label="交易类型">{activeInstruction.tradeType}</Descriptions.Item>
                    <Descriptions.Item label="合同数量">{activeInstruction.contractQty} 吨</Descriptions.Item>
                    <Descriptions.Item label="合同价格">{activeInstruction.contractPrice}</Descriptions.Item>
                    <Descriptions.Item label="期货需求">{activeInstruction.futuresDirection}{activeInstruction.futuresQty} 手 {activeInstruction.futuresContract}</Descriptions.Item>
                    <Descriptions.Item label="最后更新时间">{activeInstruction.updatedAt}</Descriptions.Item>
                  </Descriptions>
                </Card>
                <Card size="small" title="合同详情">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="点价方式">{activeInstruction.detail.pricing?.method}</Descriptions.Item>
                    <Descriptions.Item label="点价窗口">{activeInstruction.detail.pricing?.window}</Descriptions.Item>
                    <Descriptions.Item label="基差">{activeInstruction.detail.pricing?.basis}</Descriptions.Item>
                    <Descriptions.Item label="已点/未点">{activeInstruction.detail.pricing ? `${activeInstruction.detail.pricing.doneQty}/${activeInstruction.detail.pricing.undoneQty}` : '-'}</Descriptions.Item>
                    <Descriptions.Item label="物流">{activeInstruction.detail.pricing?.logistics}</Descriptions.Item>
                    <Descriptions.Item label="仓库">{activeInstruction.detail.pricing?.warehouse}</Descriptions.Item>
                  </Descriptions>
                </Card>
                <Card size="small" title="子指令与敞口结构">
                  <Table
                    size="small"
                    columns={[
                      { title: '子指令ID', dataIndex: 'id', width: 130 },
                      { title: '类型', dataIndex: 'type', width: 140 },
                      { title: '状态', dataIndex: 'status', width: 100 },
                      { title: '操作人', dataIndex: 'operator', width: 100 },
                      { title: '方向', dataIndex: 'direction', width: 70 },
                      { title: '影响手数', dataIndex: 'qty', width: 90 }
                    ]}
                    dataSource={activeInstruction.detail.children.map(child => ({ key: child.id, ...child }))}
                    pagination={false}
                  />
                  <Divider />
                  <Timeline
                    items={activeInstruction.detail.logs.map(log => ({
                      children: `${log.time} ${log.content}`
                    }))}
                  />
                </Card>
                <Card size="small" title="备注与日志">
                  <List
                    size="small"
                    dataSource={activeInstruction.detail.remarks}
                    renderItem={(item) => (
                      <List.Item>
                        <Space direction="vertical" size={4}>
                          <strong>{item.author}</strong>
                          <span>{item.content}</span>
                          <span style={{ color: '#8a94a6', fontSize: 12 }}>{item.time}</span>
                        </Space>
                      </List.Item>
                    )}
                  />
                </Card>
                <Space>
                  <Button type="primary" onClick={() => handleInstructionAction(activeInstruction, '认领/取消认领')}>认领/取消认领</Button>
                  <Button onClick={() => handleInstructionAction(activeInstruction, '同意/拒绝')}>撤销处理</Button>
                  <Button onClick={() => handleInstructionAction(activeInstruction, '完成指令')}>完成指令</Button>
                  <Button onClick={() => handleFillOrderForm(activeInstruction)}>填入下单板</Button>
                </Space>
              </Space>
            ) : (
              <Empty description="请选择左侧指令" />
            )}
          </Drawer>
        </div>
        </ConfigProvider>
      );
    };

    // 现货数据页面
    const SpotData = () => {
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div style={{ padding: 12, background: '#fff', borderBottom: '1px solid #e8e8e8', display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexShrink: 0 }}>
            <span style={{ fontWeight: 600 }}>现货数据</span>
            <Button icon={renderIcon('ReloadOutlined')} onClick={() => {
              const iframe = document.getElementById('spot-data-iframe');
              if (iframe) iframe.src = iframe.src;
            }}>刷新</Button>
          </div>
          <div style={{ flex: 1, minHeight: 0, position: 'relative' }}>
            <iframe
              id="spot-data-iframe"
              src="https://edb.shinnytech.com/"
              style={{ width: '100%', height: '100%', border: 'none' }}
              title="现货数据"
            />
          </div>
        </div>
      );
    };

    // 交易日历页面
    const TradeCalendar = () => {
      const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
      const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth() + 1);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [selectedDate, setSelectedDate] = useState(null);
      const [remarkForm] = Form.useForm();
      const [remarks, setRemarks] = useState(() => {
        const saved = localStorage.getItem(`trade-calendar-remarks-${mockPersons[0]?.id || 'default'}`);
        return saved ? JSON.parse(saved) : {};
      });
      
      const currentUser = mockPersons[0];
      const userId = currentUser?.id || 'default';
      
      // 生成日历数据
      const calendarData = useMemo(() => {
        const year = selectedYear;
        const month = selectedMonth;
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();
        
        const days = [];
        // 填充空白
        for (let i = 0; i < startDayOfWeek; i++) {
          days.push(null);
        }
        // 填充日期
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month - 1, day);
          const isWeekend = date.getDay() === 0 || date.getDay() === 6;
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          
          // 模拟交易日历数据
          const isTradingDay = !isWeekend; // 简单逻辑：工作日是交易日
          const exchanges = isTradingDay ? ['上期所', '大商所', '郑商所', '中金所'] : [];
          const openTime = isTradingDay ? '09:00' : '-';
          const closeTime = isTradingDay ? '15:00' : '-';
          
          days.push({
            date: dateStr,
            day,
            isTradingDay,
            exchanges,
            openTime,
            closeTime,
            remark: remarks[dateStr] || ''
          });
        }
        return days;
      }, [selectedYear, selectedMonth, remarks]);
      
      const handleDateClick = (dateStr) => {
        setSelectedDate(dateStr);
        remarkForm.setFieldsValue({ remark: remarks[dateStr] || '' });
        setRemarkModalVisible(true);
      };
      
      const handleSaveRemark = () => {
        remarkForm.validateFields().then(values => {
          const newRemarks = { ...remarks };
          if (values.remark && values.remark.trim()) {
            newRemarks[selectedDate] = values.remark.trim();
          } else {
            delete newRemarks[selectedDate];
          }
          setRemarks(newRemarks);
          localStorage.setItem(`trade-calendar-remarks-${userId}`, JSON.stringify(newRemarks));
          message.success('备注已保存');
          setRemarkModalVisible(false);
        });
      };
      
      const yearOptions = Array.from({ length: 5 }, (_, i) => new Date().getFullYear() - 2 + i);
      const monthOptions = Array.from({ length: 12 }, (_, i) => i + 1);
      
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>年份：</label>
              <Select value={selectedYear} onChange={setSelectedYear} style={{ width: 120 }}>
                {yearOptions.map(year => (
                  <Select.Option key={year} value={year}>{year}</Select.Option>
                ))}
              </Select>
            </div>
            <div className="erp-filter-item">
              <label>月份：</label>
              <Select value={selectedMonth} onChange={setSelectedMonth} style={{ width: 120 }}>
                {monthOptions.map(month => (
                  <Select.Option key={month} value={month}>{month}月</Select.Option>
                ))}
              </Select>
            </div>
          </div>
          
          <div style={{ flex: 1, padding: 16, overflow: 'auto', background: '#fff' }}>
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 8 }}>
              {['日', '一', '二', '三', '四', '五', '六'].map(day => (
                <div key={day} style={{ textAlign: 'center', fontWeight: 600, padding: 8, background: '#f5f5f5' }}>
                  {day}
                </div>
              ))}
              {calendarData.map((dayData, index) => {
                if (!dayData) {
                  return <div key={`empty-${index}`} />;
                }
                const { date, day, isTradingDay, exchanges, openTime, closeTime, remark } = dayData;
                return (
                  <Card
                    key={date}
                    size="small"
                    style={{
                      minHeight: 120,
                      cursor: 'pointer',
                      border: remark ? '2px solid #1677ff' : '1px solid #e8e8e8'
                    }}
                    onClick={() => handleDateClick(date)}
                  >
                    <div style={{ textAlign: 'center', marginBottom: 8 }}>
                      <div style={{ fontSize: 16, fontWeight: 600 }}>{day}</div>
                      <Tag color={isTradingDay ? 'green' : 'default'} style={{ marginTop: 4 }}>
                        {isTradingDay ? '交易日' : '非交易日'}
                      </Tag>
                    </div>
                    {isTradingDay && (
                      <div style={{ fontSize: 11, color: '#666' }}>
                        <div>交易所：{exchanges.join('、')}</div>
                        <div>开市：{openTime}</div>
                        <div>收市：{closeTime}</div>
                        {remark && (
                          <div style={{ marginTop: 4, color: '#1677ff', fontWeight: 600 }}>
                            备注：{remark}
                          </div>
                        )}
                      </div>
                    )}
                  </Card>
                );
              })}
            </div>
          </div>
          
          <Modal
            {...MODAL_TEXTS}
            title={`编辑备注 - ${selectedDate}`}
            open={remarkModalVisible}
            onCancel={() => setRemarkModalVisible(false)}
            onOk={handleSaveRemark}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item label="备注" name="remark">
                <Input.TextArea rows={4} placeholder="请输入备注信息" />
              </Form.Item>
            </Form>
          </Modal>
        </div>
      );
    };

    // 跨期价差矩阵页面
    const SpreadMatrix = () => {
      const [selectedVariety, setSelectedVariety] = useState('cat-1-1'); // 默认选择铜
      const [contracts, setContracts] = useState([]);
      const [prices, setPrices] = useState({});
      const [detailModalVisible, setDetailModalVisible] = useState(false);
      const [selectedCell, setSelectedCell] = useState(null);
      
      // 生成12个月合约
      const generateContracts = (varietyCode) => {
        const year = new Date().getFullYear();
        const contracts = [];
        for (let month = 1; month <= 12; month++) {
          const monthStr = String(month).padStart(2, '0');
          const code = `${varietyCode}${year}${monthStr}`;
          contracts.push({
            code,
            name: `${varietyCode}${year}${monthStr}`,
            month
          });
        }
        return contracts;
      };
      
      // 初始化合约和价格
      useEffect(() => {
        const variety = mockSpotCategories
          .flatMap(cat => cat.children || [])
          .find(c => c.key === selectedVariety);
        if (variety) {
          const varietyCode = variety.title === '铜' ? 'CU' : variety.title === '铝' ? 'AL' : 'CU';
          const newContracts = generateContracts(varietyCode);
          setContracts(newContracts);
          
          // 初始化价格（模拟）
          const initialPrices = {};
          newContracts.forEach(contract => {
            initialPrices[contract.code] = 5000 + Math.random() * 1000;
          });
          setPrices(initialPrices);
        }
      }, [selectedVariety]);
      
      // 模拟价格刷新
      useEffect(() => {
        const interval = setInterval(() => {
          setPrices(prev => {
            const newPrices = { ...prev };
            Object.keys(newPrices).forEach(code => {
              const change = (Math.random() - 0.5) * 0.01; // ±0.5%变化
              newPrices[code] = newPrices[code] * (1 + change);
            });
            return newPrices;
          });
        }, 3000);
        return () => clearInterval(interval);
      }, []);
      
      const handleRefresh = () => {
        const variety = mockSpotCategories
          .flatMap(cat => cat.children || [])
          .find(c => c.key === selectedVariety);
        if (variety) {
          const varietyCode = variety.title === '铜' ? 'CU' : variety.title === '铝' ? 'AL' : 'CU';
          const newContracts = generateContracts(varietyCode);
          setContracts(newContracts);
          
          const newPrices = {};
          newContracts.forEach(contract => {
            newPrices[contract.code] = 5000 + Math.random() * 1000;
          });
          setPrices(newPrices);
          message.success('合约列表已刷新');
        }
      };
      
      const calculateSpread = (rowCode, colCode) => {
        if (rowCode === colCode) return null;
        const rowPrice = prices[rowCode] || 0;
        const colPrice = prices[colCode] || 0;
        return rowPrice - colPrice;
      };
      
      const handleCellClick = (rowCode, colCode) => {
        if (rowCode === colCode) return;
        setSelectedCell({ rowCode, colCode, rowPrice: prices[rowCode], colPrice: prices[colCode] });
        setDetailModalVisible(true);
      };
      
      const handleExport = () => {
        message.success('导出功能（模拟）');
      };
      
      const varietyOptions = mockSpotCategories.flatMap(cat => 
        (cat.children || []).map(child => ({
          label: `${cat.title} - ${child.title}`,
          value: child.key
        }))
      );
      
      return (
        <div style={{ width: '100%', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <div className="erp-filter-bar" style={{ flexShrink: 0 }}>
            <div className="erp-filter-item">
              <label>期货品种：</label>
              <Select value={selectedVariety} onChange={setSelectedVariety} style={{ width: 200 }}>
                {varietyOptions.map(opt => (
                  <Select.Option key={opt.value} value={opt.value}>{opt.label}</Select.Option>
                ))}
              </Select>
            </div>
            <Space style={{ marginLeft: 'auto' }}>
              <Button icon={renderIcon('ReloadOutlined')} onClick={handleRefresh}>刷新合约列表</Button>
              <Button icon={renderIcon('DownloadOutlined')} onClick={handleExport}>导出价差矩阵</Button>
            </Space>
          </div>
          
          <div style={{ flex: 1, overflow: 'auto', padding: 16, background: '#fff' }}>
            <Table
              size="small"
              columns={[
                {
                  title: '合约',
                  dataIndex: 'code',
                  key: 'code',
                  fixed: 'left',
                  width: 100,
                  render: (code) => <strong>{code}</strong>
                },
                ...contracts.map(contract => ({
                  title: contract.code,
                  key: contract.code,
                  width: 120,
                  align: 'right',
                  render: (_, record) => {
                    const spread = calculateSpread(record.code, contract.code);
                    if (spread === null) {
                      return <span style={{ color: '#999' }}>--</span>;
                    }
                    const color = spread >= 0 ? 'red' : 'green';
                    return (
                      <span
                        style={{ color, cursor: 'pointer', fontWeight: 600 }}
                        onClick={() => handleCellClick(record.code, contract.code)}
                      >
                        {spread.toFixed(2)}
                      </span>
                    );
                  }
                }))
              ]}
              dataSource={contracts.map(c => ({ code: c.code, key: c.code }))}
              pagination={false}
              scroll={{ x: 'max-content' }}
            />
          </div>
          
          <Modal
            {...MODAL_TEXTS}
            title="价差详情"
            open={detailModalVisible}
            onCancel={() => setDetailModalVisible(false)}
            footer={[
              <Button key="close" onClick={() => setDetailModalVisible(false)}>关闭</Button>
            ]}
          >
            {selectedCell && (
              <div>
                <Space direction="vertical" style={{ width: '100%' }}>
                  <div>
                    <strong>行合约：</strong>{selectedCell.rowCode} - 价格：{selectedCell.rowPrice?.toFixed(2)}
                  </div>
                  <div>
                    <strong>列合约：</strong>{selectedCell.colCode} - 价格：{selectedCell.colPrice?.toFixed(2)}
                  </div>
                  <Divider />
                  <div>
                    <strong>价差：</strong>
                    <span style={{ color: (selectedCell.rowPrice - selectedCell.colPrice) >= 0 ? 'red' : 'green', fontSize: 18, fontWeight: 600 }}>
                      {(selectedCell.rowPrice - selectedCell.colPrice).toFixed(2)}
                    </span>
                  </div>
                </Space>
              </div>
            )}
          </Modal>
        </div>
      );
    };

    const MobileWorkbench = ({ user, roles, workbenches, onEnterDesktop }) => {
      const [activeWorkbench, setActiveWorkbench] = useState(null);

      return (
        <div className="mobile-workbench">
          <Card className="user-card" title="我的工作台">
            <Space direction="vertical" style={{ width: '100%' }}>
              <Space>
                <Avatar size={48}>{user?.name?.slice(-1) || '用'}</Avatar>
                <div>
                  <div style={{ fontSize: 18, fontWeight: 600 }}>{user?.name || '未登录用户'}</div>
                  <div style={{ color: '#8a94a6', fontSize: 13 }}>当前角色：</div>
                  <Space wrap>
                    {roles.length ? roles.map(role => (
                      <Tag color="blue" key={role}>{role}</Tag>
                    )) : <span style={{ color: '#999' }}>暂无角色</span>}
                  </Space>
                </div>
              </Space>
              <Alert
                type="info"
                showIcon
                message="移动端仅保留与你相关的工作台。复杂操作请使用桌面端。"
              />
              <Button block onClick={onEnterDesktop}>前往桌面版</Button>
            </Space>
          </Card>
          {workbenches.length ? workbenches.map(item => (
            <Card
              key={item.key}
              className="mobile-workbench-card"
              title={item.title}
              extra={<Tag color="geekblue">{item.fromRole}</Tag>}
              cover={
                <div style={{ padding: '12px 16px 0' }}>
                  <Space align="center" size={8}>
                    {renderIcon(item.icon, { style: { fontSize: 24, color: '#1677ff' } })}
                    <span style={{ color: '#8a94a6' }}>{item.description}</span>
                  </Space>
                </div>
              }
            >
              <Space direction="vertical" style={{ width: '100%' }}>
                <Button type="primary" block onClick={() => setActiveWorkbench(item)}>{item.cta}</Button>
                <Button block onClick={onEnterDesktop}>在桌面端处理</Button>
              </Space>
            </Card>
          )) : (
            <Empty description="暂无匹配的工作台，请联系管理员配置角色" />
          )}
          <Drawer
            placement="bottom"
            height={360}
            open={!!activeWorkbench}
            onClose={() => setActiveWorkbench(null)}
            title={activeWorkbench?.title}
          >
            {activeWorkbench && (
              <Space direction="vertical" style={{ width: '100%' }}>
                <Alert
                  message={`当前为 ${activeWorkbench.fromRole} 的工作台模块`}
                  description={activeWorkbench.description}
                  type="info"
                  showIcon
                />
                <Button
                  type="primary"
                  block
                  onClick={() => {
                    message.success(`已进入 ${activeWorkbench.title}`);
                    setActiveWorkbench(null);
                  }}
                >
                  我知道了
                </Button>
                <Button block onClick={onEnterDesktop}>使用桌面端获取完整体验</Button>
              </Space>
            )}
          </Drawer>
        </div>
      );
    };

    const NotificationList = () => {
      const [status, setStatus] = useState();
      const [typeFilter, setTypeFilter] = useState();

      const dataSource = useMemo(() => {
        return mockRiskAlerts.map(item => ({
          key: item.id,
          time: item.alertTime,
          title: item.title || item.ruleName || '告警',
          type: item.type || item.alertType || '告警转通知',
          status: item.status || '未处理',
          source: item.source || '风控告警',
          detail: item
        })).filter(item => {
          const statusOk = status ? item.status === status : true;
          const typeOk = typeFilter ? item.type === typeFilter : true;
          return statusOk && typeOk;
        });
      }, [status, typeFilter]);

      const columns = [
        { title: '时间', dataIndex: 'time', width: 180 },
        { title: '标题', dataIndex: 'title', width: 220 },
        { title: '类型', dataIndex: 'type', width: 120 },
        { 
          title: '状态', 
          dataIndex: 'status',
          width: 120,
          render: (v) => {
            const colorMap = { '未处理': 'red', '关注中': 'orange', '已处理': 'green' };
            return <Tag color={colorMap[v] || 'blue'}>{v}</Tag>;
          }
        },
        { title: '来源', dataIndex: 'source', width: 140 }
      ];

      return (
        <Card
          title="通知列表"
          extra={<Space>
            <Select
              allowClear
              placeholder="状态"
              style={{ width: 120 }}
              value={status}
              onChange={setStatus}
              options={[
                { value: '未处理', label: '未处理' },
                { value: '关注中', label: '关注中' },
                { value: '已处理', label: '已处理' }
              ]}
            />
            <Select
              allowClear
              placeholder="类型"
              style={{ width: 140 }}
              value={typeFilter}
              onChange={setTypeFilter}
              options={[
                { value: '告警转通知', label: '告警转通知' },
                { value: '系统通知', label: '系统通知' }
              ]}
            />
          </Space>}
        >
          <Table
            columns={columns}
            dataSource={dataSource}
            pagination={{ pageSize: 8, showTotal: (t) => `共 ${t} 条` }}
            scroll={{ x: 'max-content' }}
          />
        </Card>
      );
    };

    // 主应用组件
    // ==================== 风控宝测试数据 ====================
    // 生成当前日期时间的字符串
    const getCurrentDateTime = (hours, minutes) => {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
    };

    // 生成昨天的日期时间
    const getYesterdayDateTime = (hours, minutes) => {
      const now = new Date();
      now.setDate(now.getDate() - 1);
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
    };

    const mockRiskAlerts = [
      // 最新的告警（今天，最新的几条会显示"new"标签）
      {
        id: 'ALM-NEW-001',
        alertTime: getCurrentDateTime(14, 35),
        alertType: '已经异常',
        objectType: '期货账户',
        objectName: '中信期货-账户003',
        ruleName: '期货账户占用保证金超账户权益的80%',
        currentValue: '92.5%',
        threshold: '80%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-002',
        alertTime: getCurrentDateTime(14, 20),
        alertType: '行情类异常',
        objectType: '合约',
        objectName: 'al2404（沪铝2404合约）',
        ruleName: '3日跌幅超过3%',
        currentValue: '-4.8%',
        threshold: '-3%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-003',
        alertTime: getCurrentDateTime(13, 45),
        alertType: '已经异常',
        objectType: '合同',
        objectName: 'CG-202401-001250（采购合同）',
        ruleName: '合同关联的期货敞口数量大于合同数量的120%',
        currentValue: '期货敞口1,800吨，合同数量1,200吨，比例150%',
        threshold: '120%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-004',
        alertTime: getCurrentDateTime(13, 15),
        alertType: '可能异常',
        objectType: '合约',
        objectName: 'zn2403（沪锌2403合约）',
        ruleName: '有持仓距离交割月前15天开始预警',
        currentValue: '距离交割月还有10天',
        threshold: '15天',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-005',
        alertTime: getCurrentDateTime(12, 30),
        alertType: '已经异常',
        objectType: '委托',
        objectName: 'ORD-20240115-000789',
        ruleName: '期货报单阻止发出',
        currentValue: '报单被实时风控阻止，原因：超过账户持仓限额',
        threshold: '启用/禁用',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-006',
        alertTime: getCurrentDateTime(11, 50),
        alertType: '行情类异常',
        objectType: '合约',
        objectName: 'cu2405（沪铜2405合约）',
        ruleName: '5日涨幅超过5%',
        currentValue: '7.2%',
        threshold: '5%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-007',
        alertTime: getCurrentDateTime(11, 20),
        alertType: '可能异常',
        objectType: '合同',
        objectName: 'XS-202401-000890（销售合同）',
        ruleName: '暂定价合同离最后点价期还有5天，还没点完',
        currentValue: '距离最后点价期还有2天，未点价数量800吨',
        threshold: '5天',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-NEW-008',
        alertTime: getCurrentDateTime(10, 45),
        alertType: '已经异常',
        objectType: '品牌',
        objectName: 'B级铜',
        ruleName: '现货品牌未配置敞口系数和期货',
        currentValue: '品牌B级铜未配置敞口系数和期货品种对应关系',
        threshold: '启用/禁用',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      // 稍早一些的告警（今天上午）
      {
        id: 'ALM-20240115-001234',
        alertTime: getCurrentDateTime(9, 30),
        alertType: '行情类异常',
        objectType: '合约',
        objectName: 'cu2403（沪铜2403合约）',
        ruleName: '5日涨幅超过5%',
        currentValue: '6.8%',
        threshold: '5%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-20240115-001240',
        alertTime: getCurrentDateTime(10, 15),
        alertType: '已经异常',
        objectType: '期货账户',
        objectName: '中信期货-账户001',
        ruleName: '期货账户占用保证金超账户权益的80%',
        currentValue: '85.6%',
        threshold: '80%',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      {
        id: 'ALM-20240115-001236',
        alertTime: getCurrentDateTime(9, 0),
        alertType: '可能异常',
        objectType: '合约',
        objectName: 'cu2402（沪铜2402合约）',
        ruleName: '有持仓距离交割月前15天开始预警',
        currentValue: '距离交割月还有12天',
        threshold: '15天',
        status: '关注中',
        handler: '张三',
        lastHandleTime: getCurrentDateTime(9, 5),
        operationLogs: [
          { type: '关注', operator: '张三', time: getCurrentDateTime(9, 5), content: '已关注，需要持续监控' }
        ],
        remarks: []
      },
      {
        id: 'ALM-20240115-001237',
        alertTime: getCurrentDateTime(9, 0),
        alertType: '可能异常',
        objectType: '合同',
        objectName: 'CG-202401-001234（采购合同）',
        ruleName: '暂定价合同离最后点价期还有5天，还没点完',
        currentValue: '距离最后点价期还有3天，未点价数量500吨',
        threshold: '5天',
        status: '未处理',
        handler: null,
        lastHandleTime: null,
        operationLogs: [],
        remarks: []
      },
      // 昨天的告警（这些不会显示"new"标签，除非最后查看的ID更早）
      {
        id: 'ALM-20240115-001242',
        alertTime: getYesterdayDateTime(14, 30),
        alertType: '已经异常',
        objectType: '合同',
        objectName: 'XS-202401-000567（销售合同）',
        ruleName: '点价点超了',
        currentValue: '合同数量1,000吨，已点价1,200吨，超出200吨',
        threshold: '启用/禁用',
        status: '已处理',
        handler: '李四',
        lastHandleTime: getYesterdayDateTime(15, 0),
        operationLogs: [
          { type: '已处理', operator: '李四', time: getYesterdayDateTime(15, 0), content: '已处理，已联系客户确认' }
        ],
        remarks: [
          { author: '李四', time: getYesterdayDateTime(15, 5), content: '已与客户沟通，客户确认会尽快处理' }
        ]
      },
      {
        id: 'ALM-20240115-001243',
        alertTime: getYesterdayDateTime(13, 45),
        alertType: '已经异常',
        objectType: '合同',
        objectName: 'CG-202401-001236（采购合同）',
        ruleName: '采销匹配数量越界',
        currentValue: '采购合同数量1,000吨，已匹配销售数量1,200吨，超出200吨',
        threshold: '启用/禁用',
        status: '已处理',
        handler: '王五',
        lastHandleTime: getYesterdayDateTime(14, 0),
        operationLogs: [
          { type: '已处理', operator: '王五', time: getYesterdayDateTime(14, 0), content: '已处理，已调整匹配数量' }
        ],
        remarks: []
      },
      {
        id: 'ALM-20240115-001244',
        alertTime: getYesterdayDateTime(11, 20),
        alertType: '可能异常',
        objectType: '期货账户',
        objectName: '中信期货-账户002',
        ruleName: '有期货账户的保值额度未设置',
        currentValue: '未配置保值额度',
        threshold: '启用/禁用',
        status: '关注中',
        handler: '赵六',
        lastHandleTime: getYesterdayDateTime(11, 30),
        operationLogs: [
          { type: '关注', operator: '赵六', time: getYesterdayDateTime(11, 30), content: '已关注，等待配置' }
        ],
        remarks: []
      },
      {
        id: 'ALM-20240115-001245',
        alertTime: getYesterdayDateTime(10, 30),
        alertType: '已经异常',
        objectType: '委托',
        objectName: 'ORD-20240115-000456',
        ruleName: '期货报单阻止发出',
        currentValue: '报单被实时风控阻止，原因：超过账户持仓限额',
        threshold: '启用/禁用',
        status: '已处理',
        handler: '孙七',
        lastHandleTime: getYesterdayDateTime(10, 45),
        operationLogs: [
          { type: '已处理', operator: '孙七', time: getYesterdayDateTime(10, 45), content: '已处理，已调整持仓' }
        ],
        remarks: []
      },
      {
        id: 'ALM-20240115-001246',
        alertTime: getYesterdayDateTime(9, 45),
        alertType: '已经异常',
        objectType: '指令',
        objectName: 'INST-20240115-000234',
        ruleName: '指令阻止发出',
        currentValue: '指令被权限控制阻止，原因：该交易员无此合约交易权限',
        threshold: '启用/禁用',
        status: '已处理',
        handler: '周八',
        lastHandleTime: getYesterdayDateTime(10, 0),
        operationLogs: [
          { type: '已处理', operator: '周八', time: getYesterdayDateTime(10, 0), content: '已处理，已调整权限' }
        ],
        remarks: []
      },
      {
        id: 'ALM-20240115-001247',
        alertTime: getYesterdayDateTime(9, 5),
        alertType: '已经异常',
        objectType: '期货账户',
        objectName: '中信期货-账户002',
        ruleName: '期货账户登录异常',
        currentValue: '账户登录失败，连接超时',
        threshold: '启用/禁用',
        status: '已处理',
        handler: '吴九',
        lastHandleTime: getYesterdayDateTime(9, 20),
        operationLogs: [
          { type: '已处理', operator: '吴九', time: getYesterdayDateTime(9, 20), content: '已处理，已恢复连接' }
        ],
        remarks: []
      }
    ];

    const mockRiskDashboardData = {
      exposure: {
        hedgePlanTop5: [
          { name: '铜材保值方案A', exposure: 1500 },
          { name: '铜材保值方案B', exposure: 1200 },
          { name: '铝材保值方案A', exposure: 800 },
          { name: '铜材保值方案C', exposure: 600 },
          { name: '锌材保值方案A', exposure: 400 }
        ],
        // 全部数据（用于抽屉显示）
        hedgePlanAll: [
          { name: '铜材保值方案A', exposure: 1500 },
          { name: '铜材保值方案B', exposure: 1200 },
          { name: '铝材保值方案A', exposure: 800 },
          { name: '铜材保值方案C', exposure: 600 },
          { name: '锌材保值方案A', exposure: 400 },
          { name: '铝材保值方案B', exposure: 350 },
          { name: '锌材保值方案B', exposure: 300 },
          { name: '铜材保值方案D', exposure: 250 }
        ],
        contractTop5: [
          { contractNo: 'CG-202401-001234', exposure: 500 },
          { contractNo: 'XS-202401-000567', exposure: -300 },
          { contractNo: 'CG-202401-001235', exposure: 450 },
          { contractNo: 'XS-202401-000568', exposure: -250 },
          { contractNo: 'CG-202401-001236', exposure: 400 }
        ],
        contractAll: [
          { contractNo: 'CG-202401-001234', exposure: 500 },
          { contractNo: 'XS-202401-000567', exposure: -300 },
          { contractNo: 'CG-202401-001235', exposure: 450 },
          { contractNo: 'XS-202401-000568', exposure: -250 },
          { contractNo: 'CG-202401-001236', exposure: 400 },
          { contractNo: 'CG-202401-001237', exposure: 380 },
          { contractNo: 'XS-202401-000569', exposure: -200 },
          { contractNo: 'CG-202401-001238', exposure: 350 }
        ],
        futuresTop5: [
          { contract: 'cu2403', exposure: 800 },
          { contract: 'al2403', exposure: -500 },
          { contract: 'cu2404', exposure: 600 },
          { contract: 'zn2403', exposure: -300 },
          { contract: 'cu2405', exposure: 400 }
        ],
        futuresAll: [
          { contract: 'cu2403', exposure: 800 },
          { contract: 'al2403', exposure: -500 },
          { contract: 'cu2404', exposure: 600 },
          { contract: 'zn2403', exposure: -300 },
          { contract: 'cu2405', exposure: 400 },
          { contract: 'al2404', exposure: -250 },
          { contract: 'zn2404', exposure: -200 },
          { contract: 'cu2406', exposure: 300 }
        ]
      },
      market: {
        volatilityTop5: [
          { contract: 'cu2403', volatility: 6.8 },
          { contract: 'al2403', volatility: -4.2 },
          { contract: 'zn2403', volatility: 3.5 },
          { contract: 'cu2404', volatility: 2.8 },
          { contract: 'al2404', volatility: -2.1 }
        ],
        volatilityAll: [
          { contract: 'cu2403', volatility: 6.8 },
          { contract: 'al2403', volatility: -4.2 },
          { contract: 'zn2403', volatility: 3.5 },
          { contract: 'cu2404', volatility: 2.8 },
          { contract: 'al2404', volatility: -2.1 },
          { contract: 'zn2404', volatility: 1.8 },
          { contract: 'cu2405', volatility: 1.5 },
          { contract: 'al2405', volatility: -1.2 }
        ]
      },
      profit: {
        purchaseSalesTop5: [
          { contractNo: 'CG-202401-001234', profit: 150000 },
          { contractNo: 'XS-202401-000567', profit: 120000 },
          { contractNo: 'CG-202401-001235', profit: 100000 },
          { contractNo: 'XS-202401-000568', profit: 95000 },
          { contractNo: 'CG-202401-001236', profit: 80000 }
        ],
        futuresAccountTop5: [
          { account: '中信期货-账户001', profit: 200000 },
          { account: '中信期货-账户002', profit: 150000 },
          { account: '中信期货-账户003', profit: 120000 },
          { account: '中信期货-账户004', profit: 100000 },
          { account: '中信期货-账户005', profit: 80000 }
        ],
        hedgePlanFuturesTop5: [
          { name: '铜材保值方案A', profit: 180000 },
          { name: '铜材保值方案B', profit: 140000 },
          { name: '铝材保值方案A', profit: 110000 },
          { name: '铜材保值方案C', profit: 90000 },
          { name: '锌材保值方案A', profit: 70000 }
        ],
        futuresVarietyTop5: [
          { variety: '铜', profit: 250000 },
          { variety: '铝', profit: 180000 },
          { variety: '锌', profit: 120000 },
          { variety: '铅', profit: 80000 },
          { variety: '镍', profit: 60000 }
        ]
      },
      capital: {
        purchaseContractTop5: [
          { contractNo: 'CG-202401-001234', amount: 5000000 },
          { contractNo: 'CG-202401-001235', amount: 4500000 },
          { contractNo: 'CG-202401-001236', amount: 4000000 },
          { contractNo: 'CG-202401-001237', amount: 3500000 },
          { contractNo: 'CG-202401-001238', amount: 3000000 }
        ],
        salesContractTop5: [
          { contractNo: 'XS-202401-000567', amount: 4800000 },
          { contractNo: 'XS-202401-000568', amount: 4200000 },
          { contractNo: 'XS-202401-000569', amount: 3800000 },
          { contractNo: 'XS-202401-000570', amount: 3200000 },
          { contractNo: 'XS-202401-000571', amount: 2800000 }
        ],
        futuresAccountEquityTop5: [
          { account: '中信期货-账户001', equity: 10000000 },
          { account: '中信期货-账户002', equity: 8000000 },
          { account: '中信期货-账户003', equity: 6000000 },
          { account: '中信期货-账户004', equity: 5000000 },
          { account: '中信期货-账户005', equity: 4000000 }
        ],
        riskDegreeTop5: [
          { account: '中信期货-账户001', riskDegree: 85.6 },
          { account: '中信期货-账户002', riskDegree: 75.2 },
          { account: '中信期货-账户003', riskDegree: 68.5 },
          { account: '中信期货-账户004', riskDegree: 62.3 },
          { account: '中信期货-账户005', riskDegree: 55.8 }
        ]
      },
      alerts: {
        unprocessed: mockRiskAlerts.filter(a => a.status === '未处理').slice(0, 5),
        // 全部未处理告警（用于抽屉显示）
        unprocessedAll: mockRiskAlerts.filter(a => a.status === '未处理')
      },
      // 点价和代点价指令记录（全部）
      pricingInstructions: [
        { id: 1, contract: 'CG-202401-001234', instruction: '点价指令', time: '2024-01-15 10:30', price: 68500, quantity: 1000 },
        { id: 2, contract: 'XS-202401-000567', instruction: '代点价指令', time: '2024-01-15 11:20', price: 68800, quantity: 800 },
        { id: 3, contract: 'CG-202401-001235', instruction: '点价指令', time: '2024-01-15 14:15', price: 68450, quantity: 1200 },
        { id: 4, contract: 'XS-202401-000568', instruction: '点价指令', time: '2024-01-15 15:30', price: 68750, quantity: 600 },
        { id: 5, contract: 'CG-202401-001236', instruction: '代点价指令', time: '2024-01-15 16:00', price: 68600, quantity: 900 },
        { id: 6, contract: 'XS-202401-000569', instruction: '点价指令', time: '2024-01-15 16:45', price: 68900, quantity: 500 },
        { id: 7, contract: 'CG-202401-001237', instruction: '代点价指令', time: '2024-01-15 17:20', price: 68550, quantity: 700 }
      ],
      banner: {
        yesterdayPurchase: {
          pricingQuantity: 5000,
          pricingAvgPrice: 68500,
          futuresSellQuantity: 3000,
          futuresSellAvgPrice: 68200,
          // 明细数据
          details: [
            { contract: 'CG-202401-001234', pricingQuantity: 1500, pricingAvgPrice: 68600, futuresSellQuantity: 1000, futuresSellAvgPrice: 68300 },
            { contract: 'CG-202401-001235', pricingQuantity: 1200, pricingAvgPrice: 68500, futuresSellQuantity: 800, futuresSellAvgPrice: 68200 },
            { contract: 'CG-202401-001236', pricingQuantity: 1000, pricingAvgPrice: 68450, futuresSellQuantity: 600, futuresSellAvgPrice: 68150 },
            { contract: 'CG-202401-001237', pricingQuantity: 800, pricingAvgPrice: 68550, futuresSellQuantity: 400, futuresSellAvgPrice: 68250 },
            { contract: 'CG-202401-001238', pricingQuantity: 500, pricingAvgPrice: 68400, futuresSellQuantity: 200, futuresSellAvgPrice: 68100 }
          ]
        },
        yesterdaySales: {
          pricingQuantity: 4500,
          pricingAvgPrice: 68800,
          futuresBuyQuantity: 2800,
          futuresBuyAvgPrice: 68500,
          // 明细数据
          details: [
            { contract: 'XS-202401-000567', pricingQuantity: 1400, pricingAvgPrice: 68900, futuresBuyQuantity: 900, futuresBuyAvgPrice: 68600 },
            { contract: 'XS-202401-000568', pricingQuantity: 1100, pricingAvgPrice: 68800, futuresBuyQuantity: 700, futuresBuyAvgPrice: 68500 },
            { contract: 'XS-202401-000569', pricingQuantity: 900, pricingAvgPrice: 68750, futuresBuyQuantity: 600, futuresBuyAvgPrice: 68450 },
            { contract: 'XS-202401-000570', pricingQuantity: 700, pricingAvgPrice: 68850, futuresBuyQuantity: 400, futuresBuyAvgPrice: 68550 },
            { contract: 'XS-202401-000571', pricingQuantity: 400, pricingAvgPrice: 68700, futuresBuyQuantity: 200, futuresBuyAvgPrice: 68400 }
          ]
        },
        yesterdayPurchaseLong: {
          pricingQuantity: 3000,
          pricingAvgPrice: 68400,
          futuresSellQuantity: 2000,
          futuresSellAvgPrice: 68100
        },
        yesterdaySalesLong: {
          pricingQuantity: 2500,
          pricingAvgPrice: 68700,
          futuresBuyQuantity: 1500,
          futuresBuyAvgPrice: 68400
        },
        yesterdayPurchaseSalesRelation: {
          relationQuantity: 3500,
          contractProfit: 150000,
          futuresProfit: 120000,
          // 明细数据
          details: [
            { purchaseContract: 'CG-202401-001234', salesContract: 'XS-202401-000567', relationQuantity: 1000, contractProfit: 50000, futuresProfit: 40000 },
            { purchaseContract: 'CG-202401-001235', salesContract: 'XS-202401-000568', relationQuantity: 900, contractProfit: 45000, futuresProfit: 35000 },
            { purchaseContract: 'CG-202401-001236', salesContract: 'XS-202401-000569', relationQuantity: 800, contractProfit: 35000, futuresProfit: 30000 },
            { purchaseContract: 'CG-202401-001237', salesContract: 'XS-202401-000570', relationQuantity: 500, contractProfit: 20000, futuresProfit: 15000 },
            { purchaseContract: 'CG-202401-001238', salesContract: 'XS-202401-000571', relationQuantity: 300, contractProfit: 0, futuresProfit: 0 }
          ]
        },
        yesterdayInventory: {
          quantity: 8000,
          avgPrice: 68300,
          // 明细数据（未建立采销关联的合同货量）
          details: [
            { contract: 'CG-202401-001239', quantity: 2000, avgPrice: 68200 },
            { contract: 'CG-202401-001240', quantity: 1800, avgPrice: 68300 },
            { contract: 'CG-202401-001241', quantity: 1500, avgPrice: 68400 },
            { contract: 'CG-202401-001242', quantity: 1200, avgPrice: 68250 },
            { contract: 'CG-202401-001243', quantity: 1000, avgPrice: 68350 },
            { contract: 'CG-202401-001244', quantity: 500, avgPrice: 68200 }
          ]
        }
      },
      charts: {
        futuresSpotBasis: [
          { date: '01-10', futures: 68500, spot: 68300, basis: 200 },
          { date: '01-11', futures: 69200, spot: 69000, basis: 200 },
          { date: '01-12', futures: 70100, spot: 69900, basis: 200 },
          { date: '01-13', futures: 71500, spot: 71300, basis: 200 },
          { date: '01-14', futures: 72200, spot: 72000, basis: 200 },
          { date: '01-15', futures: 73158, spot: 72958, basis: 200 }
        ],
        // 历史期货、现货、基差数据（按日期降序）
        futuresSpotBasisHistory: [
          { date: '2024-01-15', futures: 73158, spot: 72958, basis: 200 },
          { date: '2024-01-14', futures: 72200, spot: 72000, basis: 200 },
          { date: '2024-01-13', futures: 71500, spot: 71300, basis: 200 },
          { date: '2024-01-12', futures: 70100, spot: 69900, basis: 200 },
          { date: '2024-01-11', futures: 69200, spot: 69000, basis: 200 },
          { date: '2024-01-10', futures: 68500, spot: 68300, basis: 200 },
          { date: '2024-01-09', futures: 68000, spot: 67800, basis: 200 },
          { date: '2024-01-08', futures: 67500, spot: 67300, basis: 200 },
          { date: '2024-01-07', futures: 67000, spot: 66800, basis: 200 },
          { date: '2024-01-06', futures: 66500, spot: 66300, basis: 200 }
        ],
        quantityAndDelivery: [
          { date: '01-15', quantity: 5000, futureDelivery: 3000 },
          { date: '01-16', quantity: 5200, futureDelivery: 3200 },
          { date: '01-17', quantity: 4800, futureDelivery: 2800 },
          { date: '01-18', quantity: 5500, futureDelivery: 3500 },
          { date: '01-19', quantity: 5100, futureDelivery: 3100 }
        ],
        // 货量和未来交收数据（从当前日期开始）
        quantityAndDeliveryFromToday: [
          { date: '2024-01-15', quantity: 5000, futureDelivery: 3000 },
          { date: '2024-01-16', quantity: 5200, futureDelivery: 3200 },
          { date: '2024-01-17', quantity: 4800, futureDelivery: 2800 },
          { date: '2024-01-18', quantity: 5500, futureDelivery: 3500 },
          { date: '2024-01-19', quantity: 5100, futureDelivery: 3100 },
          { date: '2024-01-20', quantity: 5300, futureDelivery: 3300 },
          { date: '2024-01-21', quantity: 4900, futureDelivery: 2900 }
        ],
        hedgeQuotaUsage: [
          { plan: '铜材保值方案A', used: 80, total: 100 },
          { plan: '铜材保值方案B', used: 65, total: 100 },
          { plan: '铝材保值方案A', used: 50, total: 100 }
        ],
        // 保值额度使用明细（按期货账户、合约、方向）
        hedgeQuotaUsageDetails: [
          { account: '中信期货-账户001', contract: 'CU2401', direction: '多头', used: 50, total: 100, usageRate: 50 },
          { account: '中信期货-账户001', contract: 'CU2401', direction: '空头', used: 30, total: 100, usageRate: 30 },
          { account: '中信期货-账户001', contract: 'CU2402', direction: '多头', used: 40, total: 100, usageRate: 40 },
          { account: '中信期货-账户002', contract: 'AL2401', direction: '多头', used: 60, total: 100, usageRate: 60 },
          { account: '中信期货-账户002', contract: 'AL2401', direction: '空头', used: 20, total: 100, usageRate: 20 },
          { account: '中信期货-账户002', contract: 'AL2402', direction: '多头', used: 45, total: 100, usageRate: 45 },
          { account: '中信期货-账户003', contract: 'ZN2401', direction: '多头', used: 35, total: 100, usageRate: 35 },
          { account: '中信期货-账户003', contract: 'ZN2401', direction: '空头', used: 25, total: 100, usageRate: 25 }
        ],
        varIndicator: [
          { date: '01-10', value: 4500000 },
          { date: '01-11', value: 4800000 },
          { date: '01-12', value: 5200000 },
          { date: '01-13', value: 5100000 },
          { date: '01-14', value: 4900000 },
          { date: '01-15', value: 5000000 }
        ],
        // 历史VaR数据（按日期降序）
        varIndicatorHistory: [
          { date: '2024-01-15', value: 5000000 },
          { date: '2024-01-14', value: 4900000 },
          { date: '2024-01-13', value: 5100000 },
          { date: '2024-01-12', value: 5200000 },
          { date: '2024-01-11', value: 4800000 },
          { date: '2024-01-10', value: 4500000 },
          { date: '2024-01-09', value: 4600000 },
          { date: '2024-01-08', value: 4400000 },
          { date: '2024-01-07', value: 4300000 },
          { date: '2024-01-06', value: 4200000 }
        ],
        stressTest: {
          scenario: '历史极端日',
          loss: -12000000
        }
      }
    };

    // ==================== 风控宝组件 ====================

    // ChartCard 组件（使用 ECharts）
    const ChartCard = ({ title, subtitle, option, themeMode = 'light' }) => {
      const ref = useRef(null);

      useEffect(() => {
        if (!ref.current || !window.echarts) return;
        let chart = window.echarts.getInstanceByDom(ref.current);
        if (chart) {
          chart.dispose();
        }
        chart = window.echarts.init(ref.current, null, { renderer: 'canvas', useDirtyRect: true });
        chart.setOption(option);
        const resizeObserver = new ResizeObserver(() => chart.resize());
        resizeObserver.observe(ref.current);
        return () => {
          resizeObserver.disconnect();
          chart.dispose();
        };
      }, [option, themeMode]);

      return (
        <Card title={title} size="small" extra={subtitle}>
          <div style={{ height: 240 }} ref={ref} />
        </Card>
      );
    };

    // 风控驾驶舱组件
    const RiskDashboard = () => {
      const banner = mockRiskDashboardData.banner;
      const charts = mockRiskDashboardData.charts;
      
      // 状态管理
      const [drawerVisible, setDrawerVisible] = useState(false);
      const [drawerData, setDrawerData] = useState(null);
      const [drawerTitle, setDrawerTitle] = useState('');
      
      // 维度切换状态
      const [dimensionMap, setDimensionMap] = useState({
        purchase: '全部',
        sales: '全部',
        relation: '全部',
        inventory: '全部',
        futuresSpotBasis: '全部',
        quantityDelivery: '全部',
        hedgeQuotaAccount: '全部',
        hedgeQuotaContract: '全部',
        hedgeQuotaDirection: '全部',
        varIndicator: '全部'
      });

      // 打开抽屉显示原始数据
      const handleCardHeaderClick = (title, data, type) => {
        setDrawerTitle(title);
        // 根据类型获取完整数据
        let fullData = data;
        if (type === 'purchase') {
          fullData = mockRiskDashboardData.banner.yesterdayPurchase.details || [];
        } else if (type === 'sales') {
          fullData = mockRiskDashboardData.banner.yesterdaySales.details || [];
        } else if (type === 'relation') {
          fullData = mockRiskDashboardData.banner.yesterdayPurchaseSalesRelation.details || [];
        } else if (type === 'inventory') {
          fullData = mockRiskDashboardData.banner.yesterdayInventory.details || [];
        } else if (type === 'futuresSpotBasis') {
          fullData = mockRiskDashboardData.charts.futuresSpotBasisHistory || [];
        } else if (type === 'quantityDelivery') {
          fullData = mockRiskDashboardData.charts.quantityAndDeliveryFromToday || [];
        } else if (type === 'hedgeQuota') {
          fullData = mockRiskDashboardData.charts.hedgeQuotaUsageDetails || [];
        } else if (type === 'varIndicator') {
          fullData = mockRiskDashboardData.charts.varIndicatorHistory || [];
        } else if (type === 'table') {
          // 根据标题获取对应的全部数据
          if (title === '保值方案敞口前五') {
            fullData = [...mockRiskDashboardData.exposure.hedgePlanAll].sort((a, b) => Math.abs(b.exposure) - Math.abs(a.exposure));
          } else if (title === '合同敞口前五') {
            fullData = [...mockRiskDashboardData.exposure.contractAll].sort((a, b) => Math.abs(b.exposure) - Math.abs(a.exposure));
          } else if (title === '期货敞口前五') {
            fullData = [...mockRiskDashboardData.exposure.futuresAll].sort((a, b) => Math.abs(b.exposure) - Math.abs(a.exposure));
          } else if (title === '关联期货合约的波动前五') {
            fullData = [...mockRiskDashboardData.market.volatilityAll].sort((a, b) => Math.abs(b.volatility) - Math.abs(a.volatility));
          } else {
            fullData = data;
          }
        } else if (type === 'alerts') {
          fullData = mockRiskDashboardData.alerts.unprocessedAll || [];
        } else if (type === 'instructions') {
          fullData = mockRiskDashboardData.pricingInstructions || [];
        }
        setDrawerData({ data: fullData, type });
        setDrawerVisible(true);
      };

      // 计算Y轴范围，让折线看起来有变化
      const calculateYAxisRange = (data, isBasis = false) => {
        const values = data.map(d => isBasis ? d.basis : (d.futures || d.spot || d.value));
        const min = Math.min(...values);
        const max = Math.max(...values);
        const range = max - min;
        const padding = range * 0.2; // 上下各留20%的padding
        return {
          min: Math.max(0, Math.floor(min - padding)),
          max: Math.ceil(max + padding)
        };
      };

      const futuresSpotRange = calculateYAxisRange(charts.futuresSpotBasis);
      const basisRange = calculateYAxisRange(charts.futuresSpotBasis, true);

      return (
        <div style={{ padding: '8px 9px 12px', height: '100%', overflow: 'auto' }}>
          <div className="erp-kanban-grid">
            {/* KPI 卡片区域 - 按现货品种 */}
            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('昨日采购订单', banner.yesterdayPurchase, 'purchase')}>
                  <span>昨日采购订单</span>
                  <Space>
                    <Select
                      size="small"
                      value={dimensionMap.purchase}
                      onChange={(v) => setDimensionMap({ ...dimensionMap, purchase: v })}
                      onClick={(e) => e.stopPropagation()}
                      style={{ width: 80 }}
                      options={[
                        { label: '全部', value: '全部' },
                        { label: '铜', value: '铜' },
                        { label: '铝', value: '铝' }
                      ]}
                      suffixIcon={renderIcon('DownOutlined')}
                    />
                    {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                  </Space>
                </div>
              }
            >
              <Statistic 
                title="定价数量" 
                value={banner.yesterdayPurchase.pricingQuantity} 
                suffix="吨"
                valueStyle={{ fontSize: 20 }}
              />
              <Divider style={{ margin: '12px 0' }} />
              <Space direction="vertical" size="small" style={{ width: '100%' }}>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  定价均价：<strong style={{ color: '#1f2430' }}>{banner.yesterdayPurchase.pricingAvgPrice.toLocaleString()}</strong> 元/吨
                </div>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  期货关联卖：<strong style={{ color: '#1f2430' }}>{banner.yesterdayPurchase.futuresSellQuantity.toLocaleString()}</strong> 吨
                </div>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  期货关联卖均价：<strong style={{ color: '#1f2430' }}>{banner.yesterdayPurchase.futuresSellAvgPrice.toLocaleString()}</strong> 元/吨
                </div>
              </Space>
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('昨日销售订单', banner.yesterdaySales, 'sales')}>
                  <span>昨日销售订单</span>
                  <Space>
                    <Select
                      size="small"
                      value={dimensionMap.sales}
                      onChange={(v) => setDimensionMap({ ...dimensionMap, sales: v })}
                      onClick={(e) => e.stopPropagation()}
                      style={{ width: 80 }}
                      options={[
                        { label: '全部', value: '全部' },
                        { label: '铜', value: '铜' },
                        { label: '铝', value: '铝' }
                      ]}
                      suffixIcon={renderIcon('DownOutlined')}
                    />
                    {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                  </Space>
                </div>
              }
            >
              <Statistic 
                title="定价数量" 
                value={banner.yesterdaySales.pricingQuantity} 
                suffix="吨"
                valueStyle={{ fontSize: 20 }}
              />
              <Divider style={{ margin: '12px 0' }} />
              <Space direction="vertical" size="small" style={{ width: '100%' }}>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  定价均价：<strong style={{ color: '#1f2430' }}>{banner.yesterdaySales.pricingAvgPrice.toLocaleString()}</strong> 元/吨
                </div>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  期货关联买：<strong style={{ color: '#1f2430' }}>{banner.yesterdaySales.futuresBuyQuantity.toLocaleString()}</strong> 吨
                </div>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  期货关联买均价：<strong style={{ color: '#1f2430' }}>{banner.yesterdaySales.futuresBuyAvgPrice.toLocaleString()}</strong> 元/吨
                </div>
              </Space>
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('昨日采销关联', banner.yesterdayPurchaseSalesRelation, 'relation')}>
                  <span>昨日采销关联</span>
                  <Space>
                    <Select
                      size="small"
                      value={dimensionMap.relation}
                      onChange={(v) => setDimensionMap({ ...dimensionMap, relation: v })}
                      onClick={(e) => e.stopPropagation()}
                      style={{ width: 80 }}
                      options={[
                        { label: '全部', value: '全部' },
                        { label: '铜', value: '铜' },
                        { label: '铝', value: '铝' }
                      ]}
                      suffixIcon={renderIcon('DownOutlined')}
                    />
                    {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                  </Space>
                </div>
              }
            >
              <Statistic 
                title="关联数量" 
                value={banner.yesterdayPurchaseSalesRelation.relationQuantity} 
                suffix="吨"
                valueStyle={{ fontSize: 20 }}
              />
              <Divider style={{ margin: '12px 0' }} />
              <Space direction="vertical" size="small" style={{ width: '100%' }}>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  关联合同利润：<strong style={{ color: '#52c41a' }}>{banner.yesterdayPurchaseSalesRelation.contractProfit.toLocaleString()}</strong> 元
                </div>
                <div style={{ fontSize: 13, color: '#8a94a6' }}>
                  关联期货利润：<strong style={{ color: '#52c41a' }}>{banner.yesterdayPurchaseSalesRelation.futuresProfit.toLocaleString()}</strong> 元
                </div>
              </Space>
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('昨日库存', banner.yesterdayInventory, 'inventory')}>
                  <span>昨日库存</span>
                  <Space>
                    <Select
                      size="small"
                      value={dimensionMap.inventory}
                      onChange={(v) => setDimensionMap({ ...dimensionMap, inventory: v })}
                      onClick={(e) => e.stopPropagation()}
                      style={{ width: 80 }}
                      options={[
                        { label: '全部', value: '全部' },
                        { label: '铜', value: '铜' },
                        { label: '铝', value: '铝' }
                      ]}
                      suffixIcon={renderIcon('DownOutlined')}
                    />
                    {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                  </Space>
                </div>
              }
            >
              <Statistic 
                title="库存货量" 
                value={banner.yesterdayInventory.quantity} 
                suffix="吨"
                valueStyle={{ fontSize: 20 }}
              />
              <Divider style={{ margin: '12px 0' }} />
              <div style={{ fontSize: 13, color: '#8a94a6' }}>
                库存均价：<strong style={{ color: '#1f2430' }}>{banner.yesterdayInventory.avgPrice.toLocaleString()}</strong> 元/吨
              </div>
            </Card>

            {/* 图表区域 */}
            <div className="span-6">
              <Card
                title={
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                    onClick={() => handleCardHeaderClick('期货、现货、基差', charts.futuresSpotBasis, 'futuresSpotBasis')}>
                    <span>期货、现货、基差</span>
                    <Space>
                      <Select
                        size="small"
                        value={dimensionMap.futuresSpotBasis}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, futuresSpotBasis: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 80 }}
                        options={[
                          { label: '全部', value: '全部' },
                          { label: '铜', value: '铜' },
                          { label: '铝', value: '铝' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                    </Space>
                  </div>
                }
                size="small"
                extra="近6日"
              >
                <ChartCard
                  title=""
                  subtitle=""
                  themeMode="light"
                option={{
                  tooltip: { trigger: 'axis' },
                  legend: { data: ['期货', '现货', '基差'], bottom: 0 },
                  grid: { left: 50, right: 50, top: 30, bottom: 50 },
                  xAxis: { 
                    type: 'category', 
                    data: charts.futuresSpotBasis.map(d => d.date)
                  },
                  yAxis: [
                    { 
                      type: 'value', 
                      name: '价格(元/吨)', 
                      position: 'left',
                      min: futuresSpotRange.min,
                      max: futuresSpotRange.max
                    },
                    { 
                      type: 'value', 
                      name: '基差(元/吨)', 
                      position: 'right',
                      min: basisRange.min,
                      max: basisRange.max
                    }
                  ],
                  series: [
                    { 
                      name: '期货', 
                      type: 'line', 
                      yAxisIndex: 0,
                      data: charts.futuresSpotBasis.map(d => d.futures),
                      itemStyle: { color: '#1677ff' },
                      smooth: true
                    },
                    { 
                      name: '现货', 
                      type: 'line', 
                      yAxisIndex: 0,
                      data: charts.futuresSpotBasis.map(d => d.spot),
                      itemStyle: { color: '#52c41a' },
                      smooth: true
                    },
                    { 
                      name: '基差', 
                      type: 'line', 
                      yAxisIndex: 1,
                      data: charts.futuresSpotBasis.map(d => d.basis),
                      itemStyle: { color: '#faad14' },
                      smooth: true
                    }
                  ]
                }}
                />
              </Card>
            </div>

            <div className="span-6">
              <Card
                title={
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                    onClick={() => handleCardHeaderClick('货量和未来交收货量', charts.quantityAndDelivery, 'quantityDelivery')}>
                    <span>货量和未来交收货量</span>
                    <Space>
                      <Select
                        size="small"
                        value={dimensionMap.quantityDelivery}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, quantityDelivery: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 80 }}
                        options={[
                          { label: '全部', value: '全部' },
                          { label: '铜', value: '铜' },
                          { label: '铝', value: '铝' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                    </Space>
                  </div>
                }
                size="small"
                extra="近5日"
              >
                <ChartCard
                  title=""
                  subtitle=""
                  themeMode="light"
                option={{
                  tooltip: { trigger: 'axis' },
                  legend: { data: ['货量', '未来交收货量'], bottom: 0 },
                  grid: { left: 50, right: 20, top: 30, bottom: 50 },
                  xAxis: { 
                    type: 'category', 
                    data: charts.quantityAndDelivery.map(d => d.date)
                  },
                  yAxis: { type: 'value', name: '数量(吨)' },
                  series: [
                    { 
                      name: '货量', 
                      type: 'bar', 
                      data: charts.quantityAndDelivery.map(d => d.quantity),
                      itemStyle: { color: '#1677ff' }
                    },
                    { 
                      name: '未来交收货量', 
                      type: 'bar', 
                      data: charts.quantityAndDelivery.map(d => d.futureDelivery),
                      itemStyle: { color: '#52c41a' }
                    }
                  ]
                }}
                />
              </Card>
            </div>

            <div className="span-6">
              <Card
                title={
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                    onClick={() => handleCardHeaderClick('保值额度使用', charts.hedgeQuotaUsage, 'hedgeQuota')}>
                    <span>保值额度使用</span>
                    <Space>
                      <Select
                        size="small"
                        value={dimensionMap.hedgeQuotaAccount}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, hedgeQuotaAccount: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 100 }}
                        placeholder="期货账户"
                        options={[
                          { label: '全部', value: '全部' },
                          { label: '账户A', value: '账户A' },
                          { label: '账户B', value: '账户B' },
                          { label: '账户C', value: '账户C' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      <Select
                        size="small"
                        value={dimensionMap.hedgeQuotaContract}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, hedgeQuotaContract: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 100 }}
                        placeholder="期货合约"
                        options={[
                          { label: '全部', value: '全部' },
                          { label: 'CU2401', value: 'CU2401' },
                          { label: 'CU2402', value: 'CU2402' },
                          { label: 'AL2401', value: 'AL2401' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      <Select
                        size="small"
                        value={dimensionMap.hedgeQuotaDirection}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, hedgeQuotaDirection: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 100 }}
                        placeholder="持仓方向"
                        options={[
                          { label: '全部', value: '全部' },
                          { label: '多头', value: '多头' },
                          { label: '空头', value: '空头' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                    </Space>
                  </div>
                }
                size="small"
                extra="当前状态"
              >
                <ChartCard
                  title=""
                  subtitle=""
                  themeMode="light"
                option={{
                  tooltip: { trigger: 'item' },
                  legend: { orient: 'vertical', left: 'left' },
                  series: [
                    {
                      name: '保值额度',
                      type: 'pie',
                      radius: ['40%', '70%'],
                      center: ['60%', '50%'],
                      data: charts.hedgeQuotaUsage.map(item => ({
                        value: item.used,
                        name: item.plan,
                        label: {
                          formatter: '{b}\n{c}/{d}%'
                        }
                      })),
                      emphasis: {
                        itemStyle: {
                          shadowBlur: 10,
                          shadowOffsetX: 0,
                          shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                      }
                    }
                  ]
                }}
                />
              </Card>
            </div>

            <div className="span-6">
              <Card
                title={
                  <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                    onClick={() => handleCardHeaderClick('VAR指标', charts.varIndicator, 'varIndicator')}>
                    <span>VAR指标</span>
                    <Space>
                      <Select
                        size="small"
                        value={dimensionMap.varIndicator}
                        onChange={(v) => setDimensionMap({ ...dimensionMap, varIndicator: v })}
                        onClick={(e) => e.stopPropagation()}
                        style={{ width: 80 }}
                        options={[
                          { label: '全部', value: '全部' },
                          { label: '铜', value: '铜' },
                          { label: '铝', value: '铝' }
                        ]}
                        suffixIcon={renderIcon('DownOutlined')}
                      />
                      {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                    </Space>
                  </div>
                }
                size="small"
                extra="近6日"
              >
                <ChartCard
                  title=""
                  subtitle=""
                  themeMode="light"
                option={{
                  tooltip: { trigger: 'axis', formatter: '{b}: {c} 元' },
                  grid: { left: 50, right: 20, top: 30, bottom: 30 },
                  xAxis: { 
                    type: 'category', 
                    data: charts.varIndicator.map(d => d.date)
                  },
                  yAxis: { type: 'value', name: 'VaR值(元)' },
                  series: [
                    { 
                      name: 'VaR指标', 
                      type: 'line', 
                      data: charts.varIndicator.map(d => d.value),
                      itemStyle: { color: '#ff4d4f' },
                      areaStyle: { color: 'rgba(255, 77, 79, 0.2)' },
                      smooth: true
                    }
                  ]
                }}
                />
              </Card>
            </div>

            {/* 表格区域 */}
            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('保值方案敞口前五', mockRiskDashboardData.exposure.hedgePlanTop5, 'table')}>
                  <span>保值方案敞口前五</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
            >
              <Table
                size="small"
                columns={[
                  { title: '保值方案', dataIndex: 'name', key: 'name' },
                  { title: '敞口', dataIndex: 'exposure', key: 'exposure', render: (v) => v.toLocaleString(), align: 'right' }
                ]}
                dataSource={mockRiskDashboardData.exposure.hedgePlanTop5}
                pagination={false}
              />
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('合同敞口前五', mockRiskDashboardData.exposure.contractTop5, 'table')}>
                  <span>合同敞口前五</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
            >
              <Table
                size="small"
                columns={[
                  { title: '合同号', dataIndex: 'contractNo', key: 'contractNo' },
                  { title: '敞口', dataIndex: 'exposure', key: 'exposure', render: (v) => v.toLocaleString(), align: 'right' }
                ]}
                dataSource={mockRiskDashboardData.exposure.contractTop5}
                pagination={false}
              />
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('期货敞口前五', mockRiskDashboardData.exposure.futuresTop5, 'table')}>
                  <span>期货敞口前五</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
            >
              <Table
                size="small"
                columns={[
                  { title: '合约', dataIndex: 'contract', key: 'contract' },
                  { title: '敞口', dataIndex: 'exposure', key: 'exposure', render: (v) => v.toLocaleString(), align: 'right' }
                ]}
                dataSource={mockRiskDashboardData.exposure.futuresTop5}
                pagination={false}
              />
            </Card>

            <Card 
              className="span-3" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('关联期货合约的波动前五', mockRiskDashboardData.market.volatilityTop5, 'table')}>
                  <span>关联期货合约的波动前五</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
            >
              <Table
                size="small"
                columns={[
                  { title: '合约', dataIndex: 'contract', key: 'contract' },
                  { title: '波动率', dataIndex: 'volatility', key: 'volatility', render: (v) => <span style={{ color: v > 0 ? '#ff4d4f' : '#52c41a' }}>{v > 0 ? '+' : ''}{v}%</span>, align: 'right' }
                ]}
                dataSource={mockRiskDashboardData.market.volatilityTop5}
                pagination={false}
              />
            </Card>

            <Card 
              className="span-6" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('风控告警未处理', mockRiskDashboardData.alerts.unprocessedAll, 'alerts')}>
                  <span>风控告警未处理</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
              extra={<Tag color="red">{mockRiskDashboardData.alerts.unprocessed.length}</Tag>}
            >
              <List
                size="small"
                dataSource={mockRiskDashboardData.alerts.unprocessed}
                renderItem={(item) => (
                  <List.Item style={{ padding: '8px 0' }}>
                    <Space direction="vertical" size="small" style={{ width: '100%' }}>
                      <div>
                        <Tag color={item.alertType === '已经异常' ? 'red' : item.alertType === '可能异常' ? 'orange' : 'blue'} style={{ marginRight: 8 }}>
                          {item.alertType}
                        </Tag>
                        <strong>{item.objectName}</strong>
                      </div>
                      <div style={{ color: '#8a94a6', fontSize: 12, marginLeft: 8 }}>
                        {item.ruleName} - {item.currentValue}
                      </div>
                    </Space>
                  </List.Item>
                )}
              />
            </Card>

            <Card 
              className="span-6" 
              title={
                <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer' }}
                  onClick={() => handleCardHeaderClick('点价和代点价指令记录', mockRiskDashboardData.pricingInstructions.slice(0, 5), 'instructions')}>
                  <span>点价和代点价指令记录</span>
                  {renderIcon('RightOutlined', { style: { fontSize: 12, color: '#8a94a6' } })}
                </div>
              }
            >
              <List
                size="small"
                dataSource={mockRiskDashboardData.pricingInstructions.slice(0, 5)}
                renderItem={(item) => (
                  <List.Item style={{ padding: '8px 0' }}>
                    <Space>
                      <Tag>{item.instruction}</Tag>
                      <span>{item.contract}</span>
                      <span style={{ color: '#8a94a6', fontSize: 12 }}>{item.time}</span>
                    </Space>
                  </List.Item>
                )}
              />
            </Card>
          </div>

          {/* 数据详情抽屉 */}
          <Drawer
            title={drawerTitle}
            placement="right"
            width={900}
            open={drawerVisible}
            onClose={() => setDrawerVisible(false)}
            extra={
              <Button type="text" icon={renderIcon('CloseOutlined')} onClick={() => setDrawerVisible(false)} />
            }
          >
            {drawerData && (
              <div>
                {drawerData.type === 'purchase' ? (
                  <Table
                    columns={[
                      { title: '合同', dataIndex: 'contract', key: 'contract', width: 180 },
                      { title: '定价数量', dataIndex: 'pricingQuantity', key: 'pricingQuantity', align: 'right', sorter: (a, b) => b.pricingQuantity - a.pricingQuantity, defaultSortOrder: 'descend' },
                      { title: '定价均价', dataIndex: 'pricingAvgPrice', key: 'pricingAvgPrice', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' },
                      { title: '期货关联卖数量', dataIndex: 'futuresSellQuantity', key: 'futuresSellQuantity', align: 'right' },
                      { title: '期货关联卖均价', dataIndex: 'futuresSellAvgPrice', key: 'futuresSellAvgPrice', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'sales' ? (
                  <Table
                    columns={[
                      { title: '合同', dataIndex: 'contract', key: 'contract', width: 180 },
                      { title: '定价数量', dataIndex: 'pricingQuantity', key: 'pricingQuantity', align: 'right', sorter: (a, b) => b.pricingQuantity - a.pricingQuantity, defaultSortOrder: 'descend' },
                      { title: '定价均价', dataIndex: 'pricingAvgPrice', key: 'pricingAvgPrice', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' },
                      { title: '期货关联买数量', dataIndex: 'futuresBuyQuantity', key: 'futuresBuyQuantity', align: 'right' },
                      { title: '期货关联买均价', dataIndex: 'futuresBuyAvgPrice', key: 'futuresBuyAvgPrice', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'relation' ? (
                  <Table
                    columns={[
                      { title: '采购合同', dataIndex: 'purchaseContract', key: 'purchaseContract', width: 180 },
                      { title: '销售合同', dataIndex: 'salesContract', key: 'salesContract', width: 180 },
                      { title: '关联数量', dataIndex: 'relationQuantity', key: 'relationQuantity', align: 'right' },
                      { title: '关联合同利润', dataIndex: 'contractProfit', key: 'contractProfit', align: 'right', render: (v) => v.toLocaleString() + ' 元' },
                      { title: '关联期货利润', dataIndex: 'futuresProfit', key: 'futuresProfit', align: 'right', render: (v) => v.toLocaleString() + ' 元' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'inventory' ? (
                  <Table
                    columns={[
                      { title: '合同', dataIndex: 'contract', key: 'contract', width: 180 },
                      { title: '货量', dataIndex: 'quantity', key: 'quantity', align: 'right' },
                      { title: '均价', dataIndex: 'avgPrice', key: 'avgPrice', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'futuresSpotBasis' ? (
                  <Table
                    columns={[
                      { title: '日期', dataIndex: 'date', key: 'date', width: 120, sorter: (a, b) => new Date(b.date) - new Date(a.date), defaultSortOrder: 'descend' },
                      { title: '期货价格', dataIndex: 'futures', key: 'futures', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' },
                      { title: '现货价格', dataIndex: 'spot', key: 'spot', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' },
                      { title: '基差', dataIndex: 'basis', key: 'basis', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'quantityDelivery' ? (
                  <Table
                    columns={[
                      { title: '日期', dataIndex: 'date', key: 'date', width: 120 },
                      { title: '货量', dataIndex: 'quantity', key: 'quantity', align: 'right' },
                      { title: '未来交收货量', dataIndex: 'futureDelivery', key: 'futureDelivery', align: 'right' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'hedgeQuota' ? (
                  <Table
                    columns={[
                      { title: '期货账户', dataIndex: 'account', key: 'account', width: 180 },
                      { title: '合约', dataIndex: 'contract', key: 'contract', width: 100 },
                      { title: '方向', dataIndex: 'direction', key: 'direction', width: 80 },
                      { title: '已使用', dataIndex: 'used', key: 'used', align: 'right' },
                      { title: '总额度', dataIndex: 'total', key: 'total', align: 'right' },
                      { title: '使用率', dataIndex: 'usageRate', key: 'usageRate', align: 'right', render: (v) => v + '%' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => `${record.account}-${record.contract}-${record.direction}-${index}`}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'varIndicator' ? (
                  <Table
                    columns={[
                      { title: '日期', dataIndex: 'date', key: 'date', width: 120, sorter: (a, b) => new Date(b.date) - new Date(a.date), defaultSortOrder: 'descend' },
                      { title: 'VaR值', dataIndex: 'value', key: 'value', align: 'right', render: (v) => v.toLocaleString() + ' 元' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'alerts' ? (
                  <Table
                    columns={[
                      { title: '告警时间', dataIndex: 'alertTime', key: 'alertTime', width: 180 },
                      { title: '异常类型', dataIndex: 'alertType', key: 'alertType', width: 120, render: (type) => {
                        const colorMap = { '行情类异常': 'blue', '可能异常': 'orange', '已经异常': 'red' };
                        return <Tag color={colorMap[type]}>{type}</Tag>;
                      }},
                      { title: '告警对象', dataIndex: 'objectName', key: 'objectName', width: 200 },
                      { title: '规则名称', dataIndex: 'ruleName', key: 'ruleName', width: 250 },
                      { title: '当前值', dataIndex: 'currentValue', key: 'currentValue', width: 150 }
                    ]}
                    dataSource={drawerData.data}
                    rowKey="id"
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'instructions' ? (
                  <Table
                    columns={[
                      { title: '合同', dataIndex: 'contract', key: 'contract', width: 180 },
                      { title: '指令类型', dataIndex: 'instruction', key: 'instruction', width: 120 },
                      { title: '时间', dataIndex: 'time', key: 'time', width: 180 },
                      { title: '价格', dataIndex: 'price', key: 'price', align: 'right', render: (v) => v.toLocaleString() + ' 元/吨' },
                      { title: '数量', dataIndex: 'quantity', key: 'quantity', align: 'right' }
                    ]}
                    dataSource={drawerData.data}
                    rowKey="id"
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : drawerData.type === 'table' ? (
                  <Table
                    columns={Object.keys(drawerData.data[0] || {}).map(key => ({
                      title: key === 'name' ? '保值方案' : key === 'contractNo' ? '合同号' : key === 'contract' ? '合约' : key === 'exposure' ? '敞口' : key === 'volatility' ? '波动率' : key,
                      dataIndex: key,
                      key: key,
                      render: (v) => typeof v === 'number' ? (key === 'volatility' ? (v > 0 ? '+' : '') + v + '%' : v.toLocaleString()) : v,
                      align: typeof drawerData.data[0]?.[key] === 'number' ? 'right' : 'left',
                      sorter: typeof drawerData.data[0]?.[key] === 'number' ? (a, b) => Math.abs(b[key]) - Math.abs(a[key]) : undefined,
                      defaultSortOrder: typeof drawerData.data[0]?.[key] === 'number' ? 'descend' : undefined
                    }))}
                    dataSource={drawerData.data}
                    rowKey={(record, index) => index}
                    pagination={{ pageSize: 20 }}
                    size="small"
                  />
                ) : (
                  <Descriptions bordered column={1} size="small">
                    {Object.entries(drawerData.data).map(([key, value]) => (
                      <Descriptions.Item key={key} label={key}>
                        {typeof value === 'number' ? value.toLocaleString() : String(value)}
                      </Descriptions.Item>
                    ))}
                  </Descriptions>
                )}
              </div>
            )}
          </Drawer>
        </div>
      );
    };


    // 风控告警记录组件
    const RiskAlertRecord = () => {
      const [alerts, setAlerts] = useState(mockRiskAlerts);
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [detailDrawerVisible, setDetailDrawerVisible] = useState(false);
      const [selectedAlert, setSelectedAlert] = useState(null);
      const [remarkModalVisible, setRemarkModalVisible] = useState(false);
      const [currentAlertForRemark, setCurrentAlertForRemark] = useState(null);
      const [remarkForm] = Form.useForm();
      const [forwardModalVisible, setForwardModalVisible] = useState(false);
      const [forwardForm] = Form.useForm();
      const [selectedRoleId, setSelectedRoleId] = useState(null);
      const [filters, setFilters] = useState({
        timeRange: '7',
        alertType: [],
        status: [],
        objectType: [],
        ruleName: ''
      });

      // 红点提醒相关状态
      const LAST_VIEWED_ALERT_KEY = 'risk_alert_last_viewed_id';
      const [lastViewedAlertId, setLastViewedAlertId] = useState(() => {
        // 从 localStorage 读取最后查看的告警ID
        return localStorage.getItem(LAST_VIEWED_ALERT_KEY) || null;
      });

      // 当组件可见时，更新最后查看的告警ID（用于自动标记已查看）
      useEffect(() => {
        const handleVisibilityChange = () => {
          if (!document.hidden && filteredAlerts.length > 0) {
            // 页面可见时，记录第一条（最新的）告警ID
            // 这表示用户已经看到了最新的告警
            const sortedAlerts = [...filteredAlerts].sort((a, b) => 
              new Date(b.alertTime) - new Date(a.alertTime)
            );
            if (sortedAlerts.length > 0) {
              const latestAlertId = sortedAlerts[0].id;
              // 延迟更新，确保用户已经看到列表
              setTimeout(() => {
                if (latestAlertId !== lastViewedAlertId) {
                  localStorage.setItem(LAST_VIEWED_ALERT_KEY, latestAlertId);
                  setLastViewedAlertId(latestAlertId);
                }
              }, 1000); // 延迟1秒更新，确保用户已经看到列表
            }
          }
        };

        // 页面可见性变化时触发
        document.addEventListener('visibilitychange', handleVisibilityChange);
        
        // 组件挂载时延迟检查一次
        const timer = setTimeout(() => {
          if (filteredAlerts.length > 0) {
            const sortedAlerts = [...filteredAlerts].sort((a, b) => 
              new Date(b.alertTime) - new Date(a.alertTime)
            );
            if (sortedAlerts.length > 0) {
              const latestAlertId = sortedAlerts[0].id;
              if (latestAlertId !== lastViewedAlertId) {
                localStorage.setItem(LAST_VIEWED_ALERT_KEY, latestAlertId);
                setLastViewedAlertId(latestAlertId);
              }
            }
          }
        }, 2000); // 延迟2秒，确保用户已经看到列表

        return () => {
          document.removeEventListener('visibilitychange', handleVisibilityChange);
          clearTimeout(timer);
        };
      }, [filteredAlerts, lastViewedAlertId]);

      const filteredAlerts = useMemo(() => {
        const filtered = alerts.filter(alert => {
          if (filters.alertType.length > 0 && !filters.alertType.includes(alert.alertType)) return false;
          if (filters.status.length > 0 && !filters.status.includes(alert.status)) return false;
          if (filters.ruleName && !alert.ruleName.includes(filters.ruleName)) return false;
          return true;
        });
        // 按时间倒序排列（最新的在前）
        return filtered.sort((a, b) => new Date(b.alertTime) - new Date(a.alertTime));
      }, [alerts, filters]);

      // 判断告警是否为新的（在最后查看的告警之后）
      const isNewAlert = useCallback((alert) => {
        if (!lastViewedAlertId) {
          // 如果没有记录，所有未处理的告警都是新的
          return alert.status !== '已处理';
        }
        
        // 将告警列表按时间倒序排列（最新的在前）
        const sortedAlerts = [...filteredAlerts].sort((a, b) => 
          new Date(b.alertTime) - new Date(a.alertTime)
        );
        
        // 找到最后查看的告警在排序列表中的位置
        const lastViewedIndex = sortedAlerts.findIndex(a => a.id === lastViewedAlertId);
        if (lastViewedIndex === -1) {
          // 如果找不到，所有未处理的告警都是新的
          return alert.status !== '已处理';
        }
        
        // 找到当前告警在排序列表中的位置
        const currentIndex = sortedAlerts.findIndex(a => a.id === alert.id);
        if (currentIndex === -1) return false;
        
        // 如果当前告警在最后查看的告警之前（索引更小），说明是新的
        return currentIndex < lastViewedIndex;
      }, [filteredAlerts, lastViewedAlertId]);

      const handleStatusChange = (alertId, newStatus, handler) => {
        setAlerts(alerts.map(alert => {
          if (alert.id === alertId) {
            const operationLog = {
              type: newStatus === '关注中' ? '关注' : newStatus === '已处理' ? '已处理' : '转发',
              operator: handler || '系统',
              time: new Date().toLocaleString('zh-CN'),
              content: newStatus === '关注中' ? '已关注' : newStatus === '已处理' ? '已处理' : '已转发'
            };
            return {
              ...alert,
              status: newStatus,
              handler: handler || alert.handler,
              lastHandleTime: new Date().toLocaleString('zh-CN'),
              operationLogs: [...(alert.operationLogs || []), operationLog]
            };
          }
          return alert;
        }));
        message.success('操作成功');
      };

      const handleBatchAction = (action) => {
        if (selectedRowKeys.length === 0) {
          message.warning('请先选择告警记录');
          return;
        }
        const handler = '当前用户';
        const selectedAlerts = alerts.filter(a => selectedRowKeys.includes(a.id));
        
        if (action === '已处理') {
          // 只处理未处理的记录
          const unprocessedAlerts = selectedAlerts.filter(a => a.status !== '已处理');
          if (unprocessedAlerts.length === 0) {
            message.warning('选中的记录中没有未处理的告警');
            return;
          }
          unprocessedAlerts.forEach(alert => {
            handleStatusChange(alert.id, '已处理', handler);
          });
          message.success(`已处理 ${unprocessedAlerts.length} 条告警记录`);
        } else if (action === '关注') {
          // 只处理非"关注中"的记录
          const nonWatchingAlerts = selectedAlerts.filter(a => a.status !== '关注中');
          if (nonWatchingAlerts.length === 0) {
            message.warning('选中的记录中没有需要关注的告警');
            return;
          }
          nonWatchingAlerts.forEach(alert => {
            handleStatusChange(alert.id, '关注中', handler);
          });
          message.success(`已关注 ${nonWatchingAlerts.length} 条告警记录`);
        } else if (action === '转发') {
          // 打开转发Modal
          setForwardModalVisible(true);
          forwardForm.resetFields();
          setSelectedRoleId(null);
        }
      };

      const handleForward = () => {
        forwardForm.validateFields().then(values => {
          const selectedRole = mockRoles.find(r => r.id === values.roleId);
          const selectedPerson = mockPersons.find(p => p.id === values.personId);
          const handler = '当前用户';
          const selectedAlertIds = selectedRowKeys;
          
          // 记录转发操作
          const operationLog = {
            type: '转发',
            operator: handler,
            time: new Date().toLocaleString('zh-CN'),
            content: `转发给 ${selectedRole?.name} - ${selectedPerson?.name}`
          };
          
          setAlerts(prevAlerts => prevAlerts.map(a => 
            selectedAlertIds.includes(a.id)
              ? { ...a, operationLogs: [...(a.operationLogs || []), operationLog] }
              : a
          ));
          
          message.success(`已转发 ${selectedAlertIds.length} 条告警记录给 ${selectedPerson?.name}`);
          setForwardModalVisible(false);
          forwardForm.resetFields();
          setSelectedRoleId(null);
          setSelectedRowKeys([]);
        });
      };

      // 根据角色获取该角色下的人员列表
      const getPersonsByRole = (roleId) => {
        const roleRelation = mockPersonRoles.find(pr => pr.roleId === roleId);
        if (!roleRelation) return [];
        return mockPersons.filter(p => roleRelation.personIds.includes(p.id) && p.status === 'enabled');
      };

      const columns = [
        {
          title: '告警时间',
          dataIndex: 'alertTime',
          key: 'alertTime',
          width: 180,
          sorter: (a, b) => new Date(a.alertTime) - new Date(b.alertTime),
          render: (text, record) => (
            <Space>
              <span>{text}</span>
              {isNewAlert(record) && (
                <Tag color="red" style={{ margin: 0 }}>new</Tag>
              )}
            </Space>
          )
        },
        {
          title: '异常类型',
          dataIndex: 'alertType',
          key: 'alertType',
          width: 140,
          render: (type) => {
            const colorMap = {
              '行情类异常': 'blue',
              '可能异常': 'orange',
              '已经异常': 'red'
            };
            return <Tag color={colorMap[type]}>{type}</Tag>;
          },
          filters: [
            { text: '行情类异常', value: '行情类异常' },
            { text: '可能异常', value: '可能异常' },
            { text: '已经异常', value: '已经异常' }
          ],
          onFilter: (value, record) => record.alertType === value
        },
        {
          title: '告警对象',
          dataIndex: 'objectName',
          key: 'objectName',
          width: 200,
          ellipsis: true
        },
        {
          title: '规则名称',
          dataIndex: 'ruleName',
          key: 'ruleName',
          width: 250,
          ellipsis: true
        },
        {
          title: '当前值',
          dataIndex: 'currentValue',
          key: 'currentValue',
          width: 200
        },
        {
          title: '阈值',
          dataIndex: 'threshold',
          key: 'threshold',
          width: 120
        },
        {
          title: '处理状态',
          dataIndex: 'status',
          key: 'status',
          width: 100,
          render: (status) => {
            const colorMap = {
              '未处理': 'red',
              '关注中': 'orange',
              '已处理': 'default'
            };
            return <Tag color={colorMap[status]}>{status}</Tag>;
          },
          filters: [
            { text: '未处理', value: '未处理' },
            { text: '关注中', value: '关注中' },
            { text: '已处理', value: '已处理' }
          ],
          onFilter: (value, record) => record.status === value
        },
        {
          title: '处理人',
          dataIndex: 'handler',
          key: 'handler',
          width: 100
        }
      ];

      return (
        <div style={{ padding: '8px 9px 12px', height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0 }}>
          <div className="erp-filter-bar" style={{ marginBottom: 16 }}>
            <div className="erp-filter-item">
              <label>时间范围：</label>
              <Select
                style={{ width: 150 }}
                value={filters.timeRange}
                onChange={(v) => setFilters({ ...filters, timeRange: v })}
                options={[
                  { label: '近1日', value: '1' },
                  { label: '近7日', value: '7' },
                  { label: '近30日', value: '30' },
                  { label: '自定义', value: 'custom' }
                ]}
              />
            </div>
            <div className="erp-filter-item">
              <label>异常类型：</label>
              <Select
                mode="multiple"
                style={{ width: 200 }}
                placeholder="全部"
                value={filters.alertType}
                onChange={(v) => setFilters({ ...filters, alertType: v })}
                options={[
                  { label: '行情类异常', value: '行情类异常' },
                  { label: '可能异常', value: '可能异常' },
                  { label: '已经异常', value: '已经异常' }
                ]}
              />
            </div>
            <div className="erp-filter-item">
              <label>处理状态：</label>
              <Select
                mode="multiple"
                style={{ width: 150 }}
                placeholder="全部"
                value={filters.status}
                onChange={(v) => setFilters({ ...filters, status: v })}
                options={[
                  { label: '未处理', value: '未处理' },
                  { label: '关注中', value: '关注中' },
                  { label: '已处理', value: '已处理' }
                ]}
              />
            </div>
            <div className="erp-filter-item">
              <label>规则名称：</label>
              <Input
                style={{ width: 200 }}
                placeholder="支持模糊搜索"
                value={filters.ruleName}
                onChange={(e) => setFilters({ ...filters, ruleName: e.target.value })}
                allowClear
              />
            </div>
          </div>
          <div className="erp-toolbar">
            <Space wrap>
              {(() => {
                const selectedAlerts = alerts.filter(a => selectedRowKeys.includes(a.id));
                const hasUnprocessed = selectedAlerts.length > 0 && selectedAlerts.some(a => a.status !== '已处理');
                return (
                  <Button 
                    type="primary" 
                    onClick={() => handleBatchAction('已处理')}
                    disabled={!hasUnprocessed}
                  >
                    已处理
                  </Button>
                );
              })()}
              {(() => {
                const selectedAlerts = alerts.filter(a => selectedRowKeys.includes(a.id));
                const hasNonWatching = selectedAlerts.length > 0 && selectedAlerts.some(a => a.status !== '关注中');
                return (
                  <Button 
                    onClick={() => handleBatchAction('关注')}
                    disabled={!hasNonWatching}
                  >
                    关注
                  </Button>
                );
              })()}
              <Button 
                onClick={() => {
                  if (selectedRowKeys.length === 0) {
                    message.warning('请先选择告警记录');
                    return;
                  }
                  handleBatchAction('转发');
                }}
                disabled={selectedRowKeys.length === 0}
              >
                转发
              </Button>
              <Button 
                onClick={() => {
                  const alert = alerts.find(a => a.id === selectedRowKeys[0]);
                  if (alert) {
                    setCurrentAlertForRemark(alert);
                    remarkForm.resetFields();
                    setRemarkModalVisible(true);
                  }
                }}
                disabled={selectedRowKeys.length !== 1}
              >
                备注
              </Button>
              <Button 
                icon={renderIcon('EyeOutlined')}
                onClick={() => {
                  if (selectedRowKeys.length === 1) {
                    const alert = alerts.find(a => a.id === selectedRowKeys[0]);
                    if (alert) {
                      setSelectedAlert(alert);
                      setDetailDrawerVisible(true);
                    }
                  } else {
                    message.warning('请选择一条告警记录查看详情');
                  }
                }}
                disabled={selectedRowKeys.length !== 1}
              >
                查看详情
              </Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出</Button>
              <Button 
                type="dashed"
                onClick={() => {
                  localStorage.removeItem(LAST_VIEWED_ALERT_KEY);
                  setLastViewedAlertId(null);
                  message.success('已重置最后查看记录，所有新告警将显示"new"标签');
                }}
              >
                重置查看记录（测试用）
              </Button>
            </Space>
          </div>
          <div className="erp-table-panel" style={{ flex: 1, minHeight: 0 }}>
            <div className="erp-table-wrapper">
              <Table
                rowSelection={{
                  selectedRowKeys,
                  onChange: setSelectedRowKeys
                }}
                columns={columns}
                dataSource={filteredAlerts}
                rowKey="id"
                scroll={{ x: 'max-content', y: 'calc(100vh - 400px)' }}
                pagination={{
                  total: filteredAlerts.length,
                  pageSize: 20,
                  showSizeChanger: true,
                  showTotal: (total) => `共 ${total} 条`,
                  pageSizeOptions: ['10', '20', '50', '100']
                }}
                onRow={(record) => ({
                  onClick: (e) => {
                    // 如果点击的是 checkbox、按钮、链接等交互元素，不触发行选中
                    if (e.target.tagName === 'INPUT' ||
                        e.target.tagName === 'BUTTON' || 
                        e.target.tagName === 'A' || 
                        e.target.closest('input[type="checkbox"]') ||
                        e.target.closest('button') || 
                        e.target.closest('a') ||
                        e.target.closest('.ant-btn') ||
                        e.target.closest('.ant-tag') ||
                        e.target.closest('.ant-input') ||
                        e.target.closest('.ant-select') ||
                        e.target.closest('.ant-dropdown')) {
                      return;
                    }
                    // 切换该行的选中状态
                    const key = record.id;
                    if (selectedRowKeys.includes(key)) {
                      // 如果已选中，则取消选中
                      setSelectedRowKeys(selectedRowKeys.filter(k => k !== key));
                    } else {
                      // 如果未选中，则选中
                      setSelectedRowKeys([...selectedRowKeys, key]);
                    }
                  },
                  style: { cursor: 'pointer' }
                })}
              />
            </div>
          </div>
          {/* 告警详情抽屉 */}
          <Drawer
            title={selectedAlert ? `告警详情 · ${selectedAlert.id}` : '告警详情'}
            placement="right"
            width={800}
            open={detailDrawerVisible}
            onClose={() => {
              setDetailDrawerVisible(false);
              setSelectedAlert(null);
            }}
          >
            {selectedAlert ? (
              <Space direction="vertical" size={16} style={{ width: '100%' }}>
                <Card size="small" title="基本信息">
                  <Descriptions column={2} size="small" bordered>
                    <Descriptions.Item label="告警时间">{selectedAlert.alertTime}</Descriptions.Item>
                    <Descriptions.Item label="异常类型">
                      <Tag color={selectedAlert.alertType === '已经异常' ? 'red' : selectedAlert.alertType === '可能异常' ? 'orange' : 'blue'}>
                        {selectedAlert.alertType}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="告警对象">{selectedAlert.objectName}</Descriptions.Item>
                    <Descriptions.Item label="规则名称">{selectedAlert.ruleName}</Descriptions.Item>
                    <Descriptions.Item label="当前值">{selectedAlert.currentValue}</Descriptions.Item>
                    <Descriptions.Item label="阈值">{selectedAlert.threshold}</Descriptions.Item>
                    <Descriptions.Item label="处理状态">
                      <Tag color={selectedAlert.status === '未处理' ? 'red' : selectedAlert.status === '关注中' ? 'orange' : 'default'}>
                        {selectedAlert.status}
                      </Tag>
                    </Descriptions.Item>
                    <Descriptions.Item label="处理人">{selectedAlert.handler || '-'}</Descriptions.Item>
                  </Descriptions>
                </Card>
                
                {selectedAlert.operationLogs && selectedAlert.operationLogs.length > 0 && (
                  <Card size="small" title="操作记录">
                    <Timeline
                      size="small"
                      items={selectedAlert.operationLogs.map(log => ({
                        color: log.type === '已处理' ? 'green' : log.type === '关注' ? 'orange' : 'blue',
                        children: (
                          <div>
                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                              <Tag color={log.type === '已处理' ? 'green' : log.type === '关注' ? 'orange' : 'blue'}>{log.type}</Tag>
                              <strong>{log.operator}</strong>
                              <span style={{ color: '#8a94a6', fontSize: '12px' }}>{log.time}</span>
                            </div>
                            <div style={{ color: '#4b5565' }}>{log.content}</div>
                          </div>
                        )
                      }))}
                    />
                  </Card>
                )}
                
                {selectedAlert.remarks && selectedAlert.remarks.length > 0 && (
                  <Card size="small" title="备注信息">
                    <List
                      size="small"
                      dataSource={selectedAlert.remarks}
                      renderItem={(item) => (
                        <List.Item>
                          <Space direction="vertical" size={4} style={{ width: '100%' }}>
                            <div>
                              <strong>{item.author}</strong>
                              <span style={{ color: '#8a94a6', fontSize: '12px', marginLeft: 8 }}>{item.time}</span>
                            </div>
                            <div>{item.content}</div>
                          </Space>
                        </List.Item>
                      )}
                    />
                  </Card>
                )}
              </Space>
            ) : (
              <Empty description="暂无告警详情" />
            )}
          </Drawer>

          {/* 备注Modal */}
          <Modal
            {...MODAL_TEXTS}
            title="添加备注"
            open={remarkModalVisible}
            onCancel={() => {
              setRemarkModalVisible(false);
              remarkForm.resetFields();
              setCurrentAlertForRemark(null);
            }}
            onOk={() => {
              remarkForm.validateFields().then(values => {
                const remark = {
                  author: '当前用户',
                  time: new Date().toLocaleString('zh-CN'),
                  content: values.remark
                };
                setAlerts(alerts.map(a => 
                  a.id === currentAlertForRemark.id 
                    ? { ...a, remarks: [...(a.remarks || []), remark] }
                    : a
                ));
                message.success('备注添加成功');
                setRemarkModalVisible(false);
                remarkForm.resetFields();
                setCurrentAlertForRemark(null);
              });
            }}
            width={600}
          >
            <Form form={remarkForm} layout="vertical">
              <Form.Item label="告警对象">
                <Input value={currentAlertForRemark?.objectName} disabled />
              </Form.Item>
              <Form.Item label="规则名称">
                <Input value={currentAlertForRemark?.ruleName} disabled />
              </Form.Item>
              <Form.Item 
                label="备注内容" 
                name="remark" 
                rules={[{ required: true, message: '请输入备注内容' }]}
              >
                <Input.TextArea rows={4} placeholder="请输入备注内容" />
              </Form.Item>
              {currentAlertForRemark?.remarks && currentAlertForRemark.remarks.length > 0 && (
                <Form.Item label="历史备注">
                  <div style={{ maxHeight: 200, overflowY: 'auto', padding: '12px', background: '#f5f5f5', borderRadius: '4px' }}>
                    {currentAlertForRemark.remarks.map((r, idx) => (
                      <div key={idx} style={{ marginBottom: 8, paddingBottom: 8, borderBottom: idx < currentAlertForRemark.remarks.length - 1 ? '1px solid #e8e8e8' : 'none' }}>
                        <div><strong>{r.author}</strong>：{r.content}</div>
                        <div style={{ color: '#999', fontSize: '12px' }}>{r.time}</div>
                      </div>
                    ))}
                  </div>
                </Form.Item>
              )}
            </Form>
          </Modal>

          {/* 转发Modal */}
          <Modal
            {...MODAL_TEXTS}
            title="转发告警"
            open={forwardModalVisible}
            onCancel={() => {
              setForwardModalVisible(false);
              forwardForm.resetFields();
              setSelectedRoleId(null);
            }}
            onOk={handleForward}
            width={500}
          >
            <Form form={forwardForm} layout="vertical">
              <Form.Item 
                label="选择角色" 
                name="roleId" 
                rules={[{ required: true, message: '请选择角色' }]}
              >
                <Radio.Group 
                  onChange={(e) => {
                    const roleId = e.target.value;
                    setSelectedRoleId(roleId);
                    forwardForm.setFieldsValue({ roleId, personId: undefined }); // 更新角色ID并清空人员选择
                  }}
                >
                  <Space direction="vertical">
                    {mockRoles.map(role => (
                      <Radio key={role.id} value={role.id}>
                        {role.name}
                        <span style={{ color: '#8a94a6', fontSize: '12px', marginLeft: 8 }}>
                          {role.description}
                        </span>
                      </Radio>
                    ))}
                  </Space>
                </Radio.Group>
              </Form.Item>
              
              {selectedRoleId && getPersonsByRole(selectedRoleId).length > 0 && (
                <Form.Item 
                  label="选择人员" 
                  name="personId" 
                  rules={[{ required: true, message: '请选择人员' }]}
                >
                  <Radio.Group>
                    <Space direction="vertical">
                      {getPersonsByRole(selectedRoleId).map(person => (
                        <Radio key={person.id} value={person.id}>
                          {person.name}
                          {person.phone && (
                            <span style={{ color: '#8a94a6', fontSize: '12px', marginLeft: 8 }}>
                              {person.phone}
                            </span>
                          )}
                        </Radio>
                      ))}
                    </Space>
                  </Radio.Group>
                </Form.Item>
              )}
              
              {selectedRoleId && getPersonsByRole(selectedRoleId).length === 0 && (
                <Alert
                  message="该角色下暂无可用人员"
                  type="warning"
                  showIcon
                  style={{ marginBottom: 16 }}
                />
              )}
              
              {selectedRowKeys.length > 0 && (
                <Form.Item label="转发告警数量">
                  <div style={{ color: '#8a94a6', fontSize: '12px' }}>
                    将转发 {selectedRowKeys.length} 条告警记录
                  </div>
                </Form.Item>
              )}
            </Form>
          </Modal>
        </div>
      );
    };

    // 风控设置组件
    const RiskSettings = () => {
      const [settings, setSettings] = useState({
        marketRiseDays: 5,
        marketRisePercent: 5,
        marketFallDays: 5,
        marketFallPercent: 5,
        deliveryMonthDays: 15,
        futuresDeliveryTodayEnabled: true,
        optionExerciseDays: 15,
        optionExerciseTodayEnabled: true,
        unfinishedInstructionEnabled: true,
        holidayLastDayEnabled: true,
        pricingDays: 5,
        hedgeQuotaEnabled: true,
        spotPriceMissingEnabled: true,
        marginPercent: 80,
        contractExposurePercent: 120,
        systemOrderEnabled: true,
        loginExceptionEnabled: true,
        avgPriceFieldMissingEnabled: true,
        avgPricePriceMissingEnabled: true,
        avgPricePeriodMissingEnabled: true,
        pricingPeriodMissingEnabled: true,
        deliveryDateMissingEnabled: true,
        pricingExceedEnabled: true,
        matchExceedEnabled: true,
        exposureCoefficientEnabled: true,
        brandFuturesRelationEnabled: true,
        orderBlockEnabled: true,
        instructionBlockEnabled: true,
        purchaseSalesFuturesInconsistentEnabled: false,
        purchaseSalesRelationMissingDays: 3
      });
      const [form] = Form.useForm();

      const handleSave = () => {
        form.validateFields().then(values => {
          setSettings(values);
          message.success('风控设置保存成功');
        }).catch(err => {
          message.error('请检查表单填写是否正确');
        });
      };

      const handleReset = () => {
        form.resetFields();
        message.info('已重置为默认值');
      };

      return (
        <div style={{ padding: '24px', background: '#f4f6fb', minHeight: '100%' }}>
          <Card 
            title={
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <span style={{ fontSize: '18px', fontWeight: 600 }}>风控设置</span>
                <Tag color="blue" style={{ marginLeft: '8px' }}>风险监控配置</Tag>
              </div>
            }
            extra={
              <Space>
                <Button onClick={handleReset}>重置</Button>
                <Button type="primary" onClick={handleSave} icon={renderIcon('SaveOutlined')}>
                  保存设置
                </Button>
              </Space>
            }
            style={{ 
              borderRadius: '12px',
              boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)'
            }}
          >
            <Form
              form={form}
              layout="vertical"
              initialValues={settings}
              onValuesChange={(_, allValues) => setSettings(allValues)}
            >
              <Card 
                size="small" 
                title={
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {renderIcon('RiseOutlined', { style: { color: '#ff9800', fontSize: '16px' } })}
                    <span>行情类异常</span>
                  </div>
                }
                style={{ 
                  marginBottom: 20,
                  borderLeft: '4px solid #ff9800',
                  borderRadius: '8px'
                }}
                headStyle={{ 
                  background: 'linear-gradient(90deg, rgba(255, 152, 0, 0.05) 0%, transparent 100%)',
                  borderBottom: '1px solid rgba(255, 152, 0, 0.2)'
                }}
              >
                <Row gutter={[16, 16]}>
                  <Col span={8}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>N日涨幅超过N% - 天数</span>} 
                      name="marketRiseDays"
                      tooltip="设置统计涨幅的天数范围"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={8}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>N日涨幅超过N% - 涨幅阈值</span>} 
                      name="marketRisePercent"
                      tooltip="设置涨幅百分比阈值"
                    >
                      <InputNumber 
                        min={0} 
                        max={100} 
                        addonAfter="%" 
                        style={{ width: '100%' }}
                        placeholder="请输入百分比"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={8}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>N日跌幅超过N% - 天数</span>} 
                      name="marketFallDays"
                      tooltip="设置统计跌幅的天数范围"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={8}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>N日跌幅超过N% - 跌幅阈值</span>} 
                      name="marketFallPercent"
                      tooltip="设置跌幅百分比阈值"
                    >
                      <InputNumber 
                        min={0} 
                        max={100} 
                        addonAfter="%" 
                        style={{ width: '100%' }}
                        placeholder="请输入百分比"
                      />
                    </Form.Item>
                  </Col>
                </Row>
              </Card>
              
              <Card 
                size="small" 
                title={
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {renderIcon('WarningOutlined', { style: { color: '#faad14', fontSize: '16px' } })}
                    <span>可能异常</span>
                    <Tag color="orange" style={{ marginLeft: '8px', fontSize: '11px' }}>预警</Tag>
                  </div>
                }
                style={{ 
                  marginBottom: 20,
                  borderLeft: '4px solid #faad14',
                  borderRadius: '8px'
                }}
                headStyle={{ 
                  background: 'linear-gradient(90deg, rgba(250, 173, 20, 0.05) 0%, transparent 100%)',
                  borderBottom: '1px solid rgba(250, 173, 20, 0.2)'
                }}
              >
                <Row gutter={[16, 16]}>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>有持仓且距离交割月前N天</span>} 
                      name="deliveryMonthDays"
                      tooltip="距离交割月多少天时触发预警"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>未全部点价且离最后点价日期还有N天</span>} 
                      name="pricingDays"
                      tooltip="距离最后点价日期多少天时触发预警"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>有期货持仓今天交割</span>} 
                      name="futuresDeliveryTodayEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，当天有期货交割时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>有期权持仓且距离行权日前N天</span>} 
                      name="optionExerciseDays"
                      tooltip="距离期权行权日多少天时触发预警"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>有期权持仓今天行权</span>} 
                      name="optionExerciseTodayEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，当天有期权行权时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>当日有未完成的指令</span>} 
                      name="unfinishedInstructionEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，当日有未完成指令时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>节前最后交易日</span>} 
                      name="holidayLastDayEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，节前最后交易日会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>期货账户保值额度未设置</span>} 
                      name="hedgeQuotaEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，期货账户未设置保值额度时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>缺少现货价格录入</span>} 
                      name="spotPriceMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，缺少现货价格录入时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>采销关联期货不一致</span>} 
                      name="purchaseSalesFuturesInconsistentEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，当采购合同与销售合同的采销关联关系中关联的期货合约不一致时会触发预警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                </Row>
              </Card>
              
              <Card 
                size="small" 
                title={
                  <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    {renderIcon('ExclamationCircleOutlined', { style: { color: '#ff4d4f', fontSize: '16px' } })}
                    <span>已经异常</span>
                    <Tag color="red" style={{ marginLeft: '8px', fontSize: '11px' }}>严重</Tag>
                  </div>
                }
                style={{ 
                  borderLeft: '4px solid #ff4d4f',
                  borderRadius: '8px'
                }}
                headStyle={{ 
                  background: 'linear-gradient(90deg, rgba(255, 77, 79, 0.05) 0%, transparent 100%)',
                  borderBottom: '1px solid rgba(255, 77, 79, 0.2)'
                }}
              >
                <Row gutter={[16, 16]}>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>期货账户占用保证金超账户权益的N%</span>} 
                      name="marginPercent"
                      tooltip="当保证金占用超过账户权益的设定百分比时触发告警"
                    >
                      <InputNumber 
                        min={0} 
                        max={100} 
                        addonAfter="%" 
                        style={{ width: '100%' }}
                        placeholder="请输入百分比"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>合同关联的期货敞口数量大于合同数量的N%</span>} 
                      name="contractExposurePercent"
                      tooltip="当期货敞口数量超过合同数量的设定百分比时触发告警"
                    >
                      <InputNumber 
                        min={0} 
                        addonAfter="%" 
                        style={{ width: '100%' }}
                        placeholder="请输入百分比"
                      />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>发生系统外报单</span>} 
                      name="systemOrderEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，发生系统外报单时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>期货账户登录异常</span>} 
                      name="loginExceptionEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，期货账户登录异常时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>均价合同缺少平台价字段</span>} 
                      name="avgPriceFieldMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，均价合同缺少平台价字段时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>均价合同缺少平台价价格</span>} 
                      name="avgPricePriceMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，均价合同缺少平台价价格时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>均价合同缺少均价起止日</span>} 
                      name="avgPricePeriodMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，均价合同缺少均价起止日时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>点价合同缺少点价期</span>} 
                      name="pricingPeriodMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，点价合同缺少点价期时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>合同缺少交收日期</span>} 
                      name="deliveryDateMissingEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，合同缺少交收日期时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>点价越界</span>} 
                      name="pricingExceedEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，点价越界时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>采销匹配数量越界</span>} 
                      name="matchExceedEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，采销匹配数量越界时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>现货品牌未配置敞口系数和期货</span>} 
                      name="exposureCoefficientEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，现货品牌未配置敞口系数和期货时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>合同的期现关联不符合全局设置</span>} 
                      name="brandFuturesRelationEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，合同的期现关联不符合全局设置时会触发告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>期货报单阻止发出告警</span>} 
                      name="orderBlockEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，期货报单被阻止时会发出告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>指令阻止发出告警</span>} 
                      name="instructionBlockEnabled" 
                      valuePropName="checked"
                      tooltip="开启后，指令被阻止时会发出告警"
                    >
                      <Switch checkedChildren="开启" unCheckedChildren="关闭" />
                    </Form.Item>
                  </Col>
                  <Col span={6}>
                    <Form.Item 
                      label={<span style={{ fontWeight: 500 }}>创建N天后未指定采销关系</span>} 
                      name="purchaseSalesRelationMissingDays"
                      tooltip="当采购合同或销售合同创建超过设定天数后仍未指定采销关联关系时触发告警"
                    >
                      <InputNumber 
                        min={1} 
                        addonAfter="天" 
                        style={{ width: '100%' }}
                        placeholder="请输入天数"
                      />
                    </Form.Item>
                  </Col>
                </Row>
              </Card>
            </Form>
          </Card>
        </div>
      );
    };

    // VaR测试组件 - 完整版
    const RiskVaR = () => {
      const [dimension, setDimension] = useState('hedgePlan'); // 'hedgePlan' | 'futuresAccount'
      const [selectedHedgePlans, setSelectedHedgePlans] = useState([]);
      const [selectedSpecies, setSelectedSpecies] = useState([]);
      const [selectedBrands, setSelectedBrands] = useState([]);
      const [selectedAccounts, setSelectedAccounts] = useState([]);
      const [baseDate, setBaseDate] = useState(null);
      const [calculationMethod, setCalculationMethod] = useState('参数法');
      const [confidence, setConfidence] = useState(95);
      const [timePeriod, setTimePeriod] = useState(1);
      const [customTimePeriod, setCustomTimePeriod] = useState('');
      const [historyWindow, setHistoryWindow] = useState(250);
      const [customHistoryWindow, setCustomHistoryWindow] = useState('');
      const [contractType, setContractType] = useState('主连');
      const [isCalculating, setIsCalculating] = useState(false);
      const [needsRecalculate, setNeedsRecalculate] = useState(false);
      const [hasCalculated, setHasCalculated] = useState(false); // 标记是否已经计算过
      const [varResult, setVarResult] = useState({
        value: 5000000,
        confidence: 95,
        timePeriod: 1,
        riskLevel: 'yellow',
        riskLimit: 10000000,
        calculationTime: new Date().toLocaleString('zh-CN')
      });
      const [varHistory, setVarHistory] = useState([]);
      const [contributionData, setContributionData] = useState([]);
      const [backtestResult, setBacktestResult] = useState(null);
      const [positionDetails, setPositionDetails] = useState([]);
      const [drillDownLevel, setDrillDownLevel] = useState('overview'); // 'overview' | 'hedgePlan' | 'account' | 'species' | 'brand'
      const [drillDownData, setDrillDownData] = useState(null);
      
      // 图表引用
      const varTrendChartRef = useRef(null);
      const varContributionChartRef = useRef(null);
      const varDistributionChartRef = useRef(null);
      const backtestChartRef = useRef(null);

      // 模拟数据
      const mockHedgePlans = ['铜材保值方案A', '铜材保值方案B', '铝材保值方案A', '铜材保值方案C', '锌材保值方案A'];
      const mockSpecies = ['铜', '铝', '锌', '铅'];
      const mockBrands = ['A级铜', 'B级铜', 'A级铝', 'B级铝'];
      const mockAccounts = ['中信期货-账户001', '中信期货-账户002', '中信期货-账户003'];

      // 生成VaR历史趋势数据
      useEffect(() => {
        const history = [];
        const now = new Date();
        for (let i = 29; i >= 0; i--) {
          const date = new Date(now);
          date.setDate(date.getDate() - i);
          history.push({
            date: date.toLocaleDateString('zh-CN'),
            var: 4000000 + Math.random() * 2000000,
            actualLoss: Math.random() > 0.95 ? 4500000 + Math.random() * 1000000 : null
          });
        }
        setVarHistory(history);
      }, []);

      // 初始化VaR趋势图
      useEffect(() => {
        if (varTrendChartRef.current && window.echarts && varHistory.length > 0) {
          const chart = window.echarts.init(varTrendChartRef.current);
          const dates = varHistory.map(h => h.date);
          const varValues = varHistory.map(h => (h.var / 10000).toFixed(0));
          const actualLosses = varHistory.map(h => h.actualLoss ? (h.actualLoss / 10000).toFixed(0) : null);
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              formatter: (params) => {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                  result += `${param.seriesName}: ${param.value}万元<br/>`;
                });
                return result;
              }
            },
            legend: {
              data: ['VaR值', '实际损失'],
              top: 10
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              data: dates,
              boundaryGap: false
            },
            yAxis: {
              type: 'value',
              name: '金额（万元）',
              axisLabel: {
                formatter: '{value}'
              }
            },
            series: [
              {
                name: 'VaR值',
                type: 'line',
                data: varValues,
                smooth: true,
                itemStyle: { color: '#1677ff' },
                areaStyle: { color: 'rgba(22, 119, 255, 0.1)' }
              },
              {
                name: '实际损失',
                type: 'scatter',
                data: actualLosses,
                itemStyle: { color: '#ff4d4f' },
                symbolSize: 8
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [varHistory]);

      // 初始化贡献度饼图
      useEffect(() => {
        if (varContributionChartRef.current && window.echarts && contributionData.length > 0) {
          const chart = window.echarts.init(varContributionChartRef.current);
          
          chart.setOption({
            tooltip: {
              trigger: 'item',
              formatter: '{b}: {c}万元 ({d}%)'
            },
            legend: {
              orient: 'vertical',
              left: 'left',
              top: 'middle'
            },
            series: [
              {
                name: 'VaR贡献度',
                type: 'pie',
                radius: ['40%', '70%'],
                avoidLabelOverlap: false,
                itemStyle: {
                  borderRadius: 10,
                  borderColor: '#fff',
                  borderWidth: 2
                },
                label: {
                  show: true,
                  formatter: '{b}\n{d}%'
                },
                emphasis: {
                  label: {
                    show: true,
                    fontSize: 14,
                    fontWeight: 'bold'
                  }
                },
                data: contributionData.map(item => ({
                  value: (item.value / 10000).toFixed(0),
                  name: item.name
                }))
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [contributionData]);

      // 初始化VaR分布图
      useEffect(() => {
        if (varDistributionChartRef.current && window.echarts) {
          const chart = window.echarts.init(varDistributionChartRef.current);
          
          // 生成模拟分布数据
          const distributionData = [];
          for (let i = 0; i < 50; i++) {
            distributionData.push(Math.random() * 10000000);
          }
          distributionData.sort((a, b) => a - b);
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              formatter: 'VaR值: {c}万元'
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'value',
              name: 'VaR值（万元）',
              splitLine: { show: true }
            },
            yAxis: {
              type: 'value',
              name: '频数',
              splitLine: { show: true }
            },
            series: [
              {
                name: 'VaR分布',
                type: 'bar',
                data: distributionData.map(v => (v / 10000).toFixed(0)),
                itemStyle: {
                  color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#83bff6' },
                    { offset: 0.5, color: '#188df0' },
                    { offset: 1, color: '#188df0' }
                  ])
                },
                emphasis: {
                  itemStyle: {
                    color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      { offset: 0, color: '#2378f7' },
                      { offset: 0.7, color: '#2378f7' },
                      { offset: 1, color: '#83bff6' }
                    ])
                  }
                }
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, []);

      // 初始化回测对比图
      useEffect(() => {
        if (backtestChartRef.current && window.echarts && backtestResult) {
          const chart = window.echarts.init(backtestChartRef.current);
          
          // 生成回测数据
          const dates = [];
          const varPredictions = [];
          const actualLosses = [];
          const now = new Date();
          
          for (let i = 59; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('zh-CN'));
            
            const baseVar = 4000000 + Math.random() * 2000000;
            varPredictions.push((baseVar / 10000).toFixed(0));
            
            // 模拟实际损失，偶尔超过VaR
            if (Math.random() < 0.05) {
              actualLosses.push((baseVar * 1.1 + Math.random() * 500000) / 10000);
            } else {
              actualLosses.push((baseVar * 0.8 + Math.random() * baseVar * 0.2) / 10000);
            }
          }
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              formatter: (params) => {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                  result += `${param.seriesName}: ${param.value}万元<br/>`;
                });
                return result;
              }
            },
            legend: {
              data: ['VaR预测', '实际损失'],
              top: 10
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              data: dates,
              boundaryGap: false
            },
            yAxis: {
              type: 'value',
              name: '金额（万元）'
            },
            series: [
              {
                name: 'VaR预测',
                type: 'line',
                data: varPredictions,
                smooth: true,
                itemStyle: { color: '#1677ff' },
                lineStyle: { width: 2 }
              },
              {
                name: '实际损失',
                type: 'line',
                data: actualLosses,
                smooth: true,
                itemStyle: { color: '#52c41a' },
                lineStyle: { width: 2 },
                markPoint: {
                  data: actualLosses.map((loss, index) => {
                    const varPred = parseFloat(varPredictions[index]);
                    if (loss > varPred) {
                      return {
                        coord: [index, loss],
                        value: '超过VaR',
                        itemStyle: { color: '#ff4d4f' }
                      };
                    }
                    return null;
                  }).filter(Boolean)
                }
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [backtestResult]);

      // 生成贡献度数据
      useEffect(() => {
        if (dimension === 'hedgePlan') {
          setContributionData([
            { name: '铜材保值方案A', value: 2500000, percent: 50 },
            { name: '铜材保值方案B', value: 1500000, percent: 30 },
            { name: '铝材保值方案A', value: 1000000, percent: 20 }
          ]);
        } else {
          setContributionData([
            { name: '中信期货-账户001', value: 3000000, percent: 60 },
            { name: '中信期货-账户002', value: 1500000, percent: 30 },
            { name: '中信期货-账户003', value: 500000, percent: 10 }
          ]);
        }
      }, [dimension]);

      // 生成持仓明细数据
      useEffect(() => {
        const details = [];
        for (let i = 0; i < 10; i++) {
          details.push({
            id: i + 1,
            hedgePlan: dimension === 'hedgePlan' ? mockHedgePlans[i % mockHedgePlans.length] : null,
            account: dimension === 'futuresAccount' ? mockAccounts[i % mockAccounts.length] : null,
            species: mockSpecies[i % mockSpecies.length],
            brand: dimension === 'hedgePlan' ? mockBrands[i % mockBrands.length] : null,
            contract: `cu${2403 + i}`,
            direction: i % 2 === 0 ? '多头' : '空头',
            quantity: 50 + i * 10,
            price: 68000 + i * 100,
            exposureCoefficient: dimension === 'hedgePlan' ? 5 : null,
            positionValue: (50 + i * 10) * (68000 + i * 100) * (dimension === 'hedgePlan' ? 5 : 1),
            riskContribution: (10 - i) * 5
          });
        }
        setPositionDetails(details);
      }, [dimension]);

      // 生成回测数据
      useEffect(() => {
        setBacktestResult({
          totalDays: 250,
          exceedCount: 12,
          exceedFrequency: 4.8,
          expectedFrequency: 5.0,
          accuracy: '良好'
        });
      }, []);

      // 参数变更提示（只有在已经计算过的情况下才提示）
      useEffect(() => {
        if (hasCalculated) {
          setNeedsRecalculate(true);
        }
      }, [dimension, calculationMethod, confidence, timePeriod, historyWindow, contractType, hasCalculated]);

      // 计算VaR
      const handleCalculate = () => {
        setIsCalculating(true);
        setNeedsRecalculate(false);
        
        // 模拟计算过程
        setTimeout(() => {
          const newValue = 4000000 + Math.random() * 3000000;
          const riskLevel = newValue > 8000000 ? 'red' : newValue > 6000000 ? 'yellow' : 'green';
          
          setVarResult({
            value: newValue,
            confidence,
            timePeriod: customTimePeriod || timePeriod,
            riskLevel,
            riskLimit: 10000000,
            calculationTime: new Date().toLocaleString('zh-CN')
          });
          
          // 更新历史数据
          const newHistory = [...varHistory];
          newHistory.push({
            date: new Date().toLocaleDateString('zh-CN'),
            var: newValue,
            actualLoss: null
          });
          if (newHistory.length > 30) newHistory.shift();
          setVarHistory(newHistory);
          
          // 更新贡献度数据（模拟）
          if (dimension === 'hedgePlan') {
            setContributionData([
              { name: '铜材保值方案A', value: newValue * 0.5, percent: 50 },
              { name: '铜材保值方案B', value: newValue * 0.3, percent: 30 },
              { name: '铝材保值方案A', value: newValue * 0.2, percent: 20 }
            ]);
          } else {
            setContributionData([
              { name: '中信期货-账户001', value: newValue * 0.6, percent: 60 },
              { name: '中信期货-账户002', value: newValue * 0.3, percent: 30 },
              { name: '中信期货-账户003', value: newValue * 0.1, percent: 10 }
            ]);
          }
          
          setIsCalculating(false);
          setHasCalculated(true);
          message.success('VaR计算完成');
        }, 1500);
      };

      // 维度切换
      const handleDimensionChange = (e) => {
        const newDimension = e.target.value;
        setDimension(newDimension);
        setDrillDownLevel('overview');
        setDrillDownData(null);
      };

      // 下钻功能
      const handleDrillDown = (item, level) => {
        setDrillDownLevel(level);
        setDrillDownData(item);
      };

      // 返回概览
      const handleBackToOverview = () => {
        setDrillDownLevel('overview');
        setDrillDownData(null);
      };

      return (
        <div style={{ padding: '8px 9px 12px', height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'auto' }}>
          {/* 顶部筛选区 */}
          <Card size="small" style={{ marginBottom: 16 }}>
            <Space direction="vertical" style={{ width: '100%' }} size="middle">
              <div>
                <strong>维度选择器：</strong>
                <Radio.Group value={dimension} onChange={handleDimensionChange} style={{ marginLeft: 16 }}>
                  <Radio value="hedgePlan">保值方案维度（基于期现关联关系的逻辑持仓）</Radio>
                  <Radio value="futuresAccount">期货账户维度（基于实际开平仓结果的物理持仓）</Radio>
                </Radio.Group>
              </div>
              
              <Row gutter={16}>
                {dimension === 'hedgePlan' ? (
                  <>
                    <Col span={8}>
                      <Form.Item label="保值方案（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedHedgePlans}
                          onChange={setSelectedHedgePlans}
                          style={{ width: '100%' }}
                        >
                          {mockHedgePlans.map(plan => (
                            <Select.Option key={plan} value={plan}>{plan}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                    <Col span={8}>
                      <Form.Item label="现货品种（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedSpecies}
                          onChange={setSelectedSpecies}
                          style={{ width: '100%' }}
                        >
                          {mockSpecies.map(s => (
                            <Select.Option key={s} value={s}>{s}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                    <Col span={8}>
                      <Form.Item label="品牌（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedBrands}
                          onChange={setSelectedBrands}
                          style={{ width: '100%' }}
                        >
                          {mockBrands.map(b => (
                            <Select.Option key={b} value={b}>{b}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                  </>
                ) : (
                  <Col span={8}>
                    <Form.Item label="期货账户（多选）">
                      <Select
                        mode="multiple"
                        placeholder="全部"
                        value={selectedAccounts}
                        onChange={setSelectedAccounts}
                        style={{ width: '100%' }}
                      >
                        {mockAccounts.map(acc => (
                          <Select.Option key={acc} value={acc}>{acc}</Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                  </Col>
                )}
                <Col span={8}>
                  <Form.Item label="计算基准日">
                    <DatePicker
                      value={baseDate}
                      onChange={setBaseDate}
                      placeholder="当前日"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="计算方法">
                    <Select value={calculationMethod} onChange={setCalculationMethod} style={{ width: '100%' }}>
                      <Select.Option value="历史模拟法">历史模拟法</Select.Option>
                      <Select.Option value="蒙特卡洛模拟法">蒙特卡洛模拟法</Select.Option>
                      <Select.Option value="参数法">参数法（方差-协方差法）</Select.Option>
                    </Select>
                  </Form.Item>
                </Col>
              </Row>
            </Space>
          </Card>

          {/* 参数配置区 */}
          <Card size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={6}>
                <Form.Item label="置信度">
                  <Select value={confidence} onChange={setConfidence} style={{ width: '100%' }}>
                    <Select.Option value={90}>90%</Select.Option>
                    <Select.Option value={95}>95%（常用）</Select.Option>
                    <Select.Option value={97.5}>97.5%</Select.Option>
                    <Select.Option value={99}>99%（更保守）</Select.Option>
                  </Select>
                </Form.Item>
              </Col>
              <Col span={6}>
                <Form.Item label="时间周期">
                  <Select value={timePeriod} onChange={setTimePeriod} style={{ width: '100%' }}>
                    <Select.Option value={1}>1日VaR</Select.Option>
                    <Select.Option value={10}>10日VaR</Select.Option>
                    <Select.Option value={30}>30日VaR</Select.Option>
                    <Select.Option value="custom">自定义</Select.Option>
                  </Select>
                </Form.Item>
                {timePeriod === 'custom' && (
                  <Input
                    placeholder="输入天数"
                    value={customTimePeriod}
                    onChange={(e) => setCustomTimePeriod(e.target.value)}
                    style={{ marginTop: 8 }}
                  />
                )}
              </Col>
              <Col span={6}>
                <Form.Item label="历史数据窗口">
                  <Select value={historyWindow} onChange={setHistoryWindow} style={{ width: '100%' }}>
                    <Select.Option value={250}>250个交易日（约1年）</Select.Option>
                    <Select.Option value={500}>500个交易日（约2年）</Select.Option>
                    <Select.Option value="custom">自定义</Select.Option>
                  </Select>
                </Form.Item>
                {historyWindow === 'custom' && (
                  <Input
                    placeholder="输入交易日数"
                    value={customHistoryWindow}
                    onChange={(e) => setCustomHistoryWindow(e.target.value)}
                    style={{ marginTop: 8 }}
                  />
                )}
              </Col>
              <Col span={6}>
                <Form.Item label="连续合约类型">
                  <Select value={contractType} onChange={setContractType} style={{ width: '100%' }}>
                    <Select.Option value="主连">主连（主力连续）</Select.Option>
                    <Select.Option value="近月连续">近月连续</Select.Option>
                    <Select.Option value="指数连续">指数连续</Select.Option>
                  </Select>
                </Form.Item>
              </Col>
            </Row>
            <Space>
              <Button 
                type="primary" 
                onClick={handleCalculate}
                loading={isCalculating}
                disabled={isCalculating}
              >
                计算VaR
              </Button>
              {needsRecalculate && (
                <Alert
                  message="参数已变更，请重新计算"
                  type="warning"
                  showIcon
                  style={{ display: 'inline-flex', alignItems: 'center' }}
                />
              )}
              <Button icon={renderIcon('ReloadOutlined')}>刷新数据</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出报告</Button>
            </Space>
          </Card>

          {/* 核心结果展示区 */}
          <Card size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={12}>
                <div style={{ textAlign: 'center', padding: '20px' }}>
                  <div style={{ fontSize: 32, fontWeight: 'bold', color: varResult.riskLevel === 'red' ? '#ff4d4f' : varResult.riskLevel === 'yellow' ? '#faad14' : '#52c41a', marginBottom: 8 }}>
                    {varResult.value.toLocaleString()} 元
                  </div>
                  <div style={{ marginBottom: 8 }}>
                    <Tag color={varResult.riskLevel === 'red' ? 'red' : varResult.riskLevel === 'yellow' ? 'orange' : 'green'} style={{ fontSize: 14, padding: '4px 12px' }}>
                      {varResult.riskLevel === 'red' ? '高风险' : varResult.riskLevel === 'yellow' ? '中等风险' : '低风险'}
                    </Tag>
                  </div>
                  <div style={{ color: '#8a94a6', fontSize: 14 }}>
                    {varResult.confidence}%置信度下，{varResult.timePeriod}日VaR
                  </div>
                  <div style={{ color: '#8a94a6', fontSize: 12, marginTop: 8 }}>
                    风险限额：{varResult.riskLimit.toLocaleString()} 元
                    <span style={{ marginLeft: 8, color: varResult.value > varResult.riskLimit ? '#ff4d4f' : '#52c41a' }}>
                      ({varResult.value > varResult.riskLimit ? '超限' : '正常'})
                    </span>
                  </div>
                  <div style={{ color: '#8a94a6', fontSize: 12, marginTop: 4 }}>
                    计算时间：{varResult.calculationTime}
                  </div>
                </div>
              </Col>
              <Col span={12}>
                <div style={{ padding: '20px' }}>
                  <div style={{ marginBottom: 12, fontWeight: 'bold' }}>风险等级说明：</div>
                  <Space direction="vertical" size="small">
                    <div><Tag color="green">绿色</Tag> VaR在安全范围内，风险可控</div>
                    <div><Tag color="orange">黄色</Tag> VaR接近风险限额，需要关注</div>
                    <div><Tag color="red">红色</Tag> VaR超过风险限额，需要采取措施降低风险</div>
                  </Space>
                  <div style={{ marginTop: 16, padding: 12, background: '#f5f5f5', borderRadius: 4 }}>
                    <div style={{ fontSize: 12, color: '#8a94a6', marginBottom: 4 }}>VaR数值含义：</div>
                    <div style={{ fontSize: 12 }}>
                      在{varResult.confidence}%的置信度下，未来{varResult.timePeriod}天内，持仓的最大可能损失不超过{varResult.value.toLocaleString()}元。
                      <br />
                      <span style={{ color: '#faad14' }}>注意：VaR是概率意义上的估计，不是绝对保证。</span>
                    </div>
                  </div>
                </div>
              </Col>
            </Row>
          </Card>

          {/* 分析图表区 */}
          <Row gutter={16} style={{ marginBottom: 16 }}>
            <Col span={12}>
              <Card size="small" title="VaR趋势图" extra={<Select defaultValue="day" size="small" style={{ width: 100 }}>
                <Select.Option value="day">按日</Select.Option>
                <Select.Option value="week">按周</Select.Option>
                <Select.Option value="month">按月</Select.Option>
              </Select>}>
                <div ref={varTrendChartRef} style={{ height: 300, width: '100%' }}></div>
              </Card>
            </Col>
            <Col span={12}>
              <Card size="small" title="VaR贡献度分析" extra={
                <Button type="link" size="small" onClick={() => handleDrillDown(null, 'overview')}>
                  {drillDownLevel !== 'overview' ? '返回概览' : ''}
                </Button>
              }>
                {drillDownLevel === 'overview' ? (
                  <div style={{ height: 300 }}>
                    <div ref={varContributionChartRef} style={{ height: 200, width: '100%', marginBottom: 16 }}></div>
                    <Table
                      size="small"
                      columns={[
                        { title: dimension === 'hedgePlan' ? '保值方案' : '期货账户', dataIndex: 'name', key: 'name' },
                        { title: 'VaR贡献', dataIndex: 'value', key: 'value', render: (v) => v.toLocaleString() + ' 元', align: 'right' },
                        { title: '占比', dataIndex: 'percent', key: 'percent', render: (v) => v + '%', align: 'right' },
                        {
                          title: '操作',
                          key: 'action',
                          render: (_, record) => (
                            <Button type="link" size="small" onClick={() => handleDrillDown(record, dimension === 'hedgePlan' ? 'hedgePlan' : 'account')}>
                              下钻
                            </Button>
                          )
                        }
                      ]}
                      dataSource={contributionData}
                      pagination={false}
                    />
                  </div>
                ) : (
                  <div style={{ height: 300, display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#fafafa', borderRadius: 4 }}>
                    <div style={{ textAlign: 'center', color: '#8a94a6' }}>
                      <div style={{ fontSize: 48, marginBottom: 8 }}>📊</div>
                      <div>下钻视图：{drillDownData?.name}</div>
                      <Button type="link" onClick={handleBackToOverview} style={{ marginTop: 8 }}>返回概览</Button>
                    </div>
                  </div>
                )}
              </Card>
            </Col>
          </Row>

          <Row gutter={16} style={{ marginBottom: 16 }}>
            <Col span={24}>
              <Card size="small" title="VaR分布图">
                <div ref={varDistributionChartRef} style={{ height: 250, width: '100%' }}></div>
              </Card>
            </Col>
          </Row>

          {/* 历史回测区 */}
          <Row gutter={16} style={{ marginBottom: 16 }}>
            <Col span={12}>
              <Card size="small" title="回测结果统计">
                {backtestResult && (
                  <Space direction="vertical" style={{ width: '100%' }}>
                    <Descriptions column={1} size="small" bordered>
                      <Descriptions.Item label="回测期间">
                        {backtestResult.totalDays} 个交易日
                      </Descriptions.Item>
                      <Descriptions.Item label="实际损失超过VaR次数">
                        {backtestResult.exceedCount} 次
                      </Descriptions.Item>
                      <Descriptions.Item label="超过频率">
                        {backtestResult.exceedFrequency}%
                      </Descriptions.Item>
                      <Descriptions.Item label="预期频率">
                        {backtestResult.expectedFrequency}%（{varResult.confidence}%置信度下）
                      </Descriptions.Item>
                      <Descriptions.Item label="准确度评估">
                        <Tag color={backtestResult.accuracy === '良好' ? 'green' : 'orange'}>
                          {backtestResult.accuracy}
                        </Tag>
                        {backtestResult.accuracy === '良好' && '（频率接近预期，模型较准确）'}
                      </Descriptions.Item>
                    </Descriptions>
                  </Space>
                )}
              </Card>
            </Col>
            <Col span={12}>
              <Card size="small" title="回测对比图">
                <div ref={backtestChartRef} style={{ height: 300, width: '100%' }}></div>
              </Card>
            </Col>
          </Row>

          {/* 明细数据区 */}
          <Card size="small" title="持仓明细表" extra={
            <Button icon={renderIcon('DownloadOutlined')} size="small">导出明细</Button>
          }>
            <Table
              columns={[
                dimension === 'hedgePlan' 
                  ? { title: '保值方案', dataIndex: 'hedgePlan', key: 'hedgePlan', width: 150 }
                  : { title: '期货账户', dataIndex: 'account', key: 'account', width: 150 },
                { title: '品种', dataIndex: 'species', key: 'species', width: 80 },
                dimension === 'hedgePlan' && { title: '品牌', dataIndex: 'brand', key: 'brand', width: 100 },
                { title: '合约代码', dataIndex: 'contract', key: 'contract', width: 120 },
                { title: '持仓方向', dataIndex: 'direction', key: 'direction', width: 100 },
                { title: '持仓数量（手）', dataIndex: 'quantity', key: 'quantity', align: 'right', width: 120 },
                { title: '当前价格', dataIndex: 'price', key: 'price', render: (v) => v.toLocaleString(), align: 'right', width: 120 },
                dimension === 'hedgePlan' && { title: '敞口系数', dataIndex: 'exposureCoefficient', key: 'exposureCoefficient', align: 'right', width: 100 },
                { title: '持仓价值（元）', dataIndex: 'positionValue', key: 'positionValue', render: (v) => v.toLocaleString(), align: 'right', width: 150 },
                { title: '风险贡献度（%）', dataIndex: 'riskContribution', key: 'riskContribution', align: 'right', width: 130 }
              ].filter(Boolean)}
              dataSource={positionDetails}
              rowKey="id"
              scroll={{ x: 'max-content' }}
              pagination={{
                pageSize: 10,
                showSizeChanger: true,
                showTotal: (total) => `共 ${total} 条`
              }}
            />
          </Card>
        </div>
      );
    };

    // 压力测试组件 - 完整版
    const RiskStress = () => {
      const [dimension, setDimension] = useState('hedgePlan'); // 'hedgePlan' | 'futuresAccount'
      const [selectedHedgePlans, setSelectedHedgePlans] = useState([]);
      const [selectedSpecies, setSelectedSpecies] = useState([]);
      const [selectedBrands, setSelectedBrands] = useState([]);
      const [selectedAccounts, setSelectedAccounts] = useState([]);
      const [baseDate, setBaseDate] = useState(null);
      const [scenarioType, setScenarioType] = useState('历史极端日');
      const [isTesting, setIsTesting] = useState(false);
      const [needsRetest, setNeedsRetest] = useState(false);
      const [hasTested, setHasTested] = useState(false);
      
      // 场景参数
      const [extremeDayThreshold, setExtremeDayThreshold] = useState(5); // 极端日识别标准（%）
      const [historyWindow, setHistoryWindow] = useState(250);
      const [contractType, setContractType] = useState('主连');
      const [linkedMarkets, setLinkedMarkets] = useState([]);
      const [marketShocks, setMarketShocks] = useState({}); // 各市场冲击幅度
      const [correlation, setCorrelation] = useState(0.7); // 相关性参数
      const [basisChange, setBasisChange] = useState(500); // 基差变化幅度（元）
      const [basisChangeType, setBasisChangeType] = useState('扩大'); // 扩大/缩小
      const [exchangeRateChange, setExchangeRateChange] = useState(5); // 汇率变化幅度（%）
      const [exchangeRateDirection, setExchangeRateDirection] = useState('贬值'); // 升值/贬值
      const [customShocks, setCustomShocks] = useState({}); // 自定义场景冲击幅度
      
      const [stressResults, setStressResults] = useState([]); // 多场景结果
      const [currentResult, setCurrentResult] = useState(null);
      const [positionDetails, setPositionDetails] = useState([]);
      const [drillDownLevel, setDrillDownLevel] = useState('overview');
      const [drillDownData, setDrillDownData] = useState(null);
      
      // 图表引用
      const lossDistributionChartRef = useRef(null);
      const scenarioCompareChartRef = useRef(null);
      const extremeDayChartRef = useRef(null);
      
      // 模拟数据
      const mockHedgePlans = ['铜材保值方案A', '铜材保值方案B', '铝材保值方案A', '铜材保值方案C', '锌材保值方案A'];
      const mockSpecies = ['铜', '铝', '锌', '铅'];
      const mockBrands = ['A级铜', 'B级铜', 'A级铝', 'B级铝'];
      const mockAccounts = ['中信期货-账户001', '中信期货-账户002', '中信期货-账户003'];
      
      // 生成持仓明细数据
      useEffect(() => {
        const details = [];
        for (let i = 0; i < 10; i++) {
          const currentPrice = 68000 + i * 100;
          let scenarioPrice = currentPrice;
          let priceChange = 0;
          
          // 根据场景类型计算场景价格
          if (scenarioType === '历史极端日') {
            priceChange = (Math.random() > 0.5 ? 1 : -1) * (extremeDayThreshold + Math.random() * 2);
            scenarioPrice = currentPrice * (1 + priceChange / 100);
          } else if (scenarioType === '跨市场联动') {
            priceChange = (Math.random() > 0.5 ? 1 : -1) * (5 + Math.random() * 3);
            scenarioPrice = currentPrice * (1 + priceChange / 100);
          } else if (scenarioType === '基差骤变') {
            const change = basisChangeType === '扩大' ? basisChange : -basisChange;
            scenarioPrice = currentPrice + change;
            priceChange = (change / currentPrice) * 100;
          } else if (scenarioType === '汇率冲击') {
            const rateChange = exchangeRateDirection === '贬值' ? exchangeRateChange : -exchangeRateChange;
            priceChange = rateChange;
            scenarioPrice = currentPrice * (1 + rateChange / 100);
          } else {
            priceChange = (Math.random() > 0.5 ? 1 : -1) * (3 + Math.random() * 2);
            scenarioPrice = currentPrice * (1 + priceChange / 100);
          }
          
          const quantity = 50 + i * 10;
          const loss = (scenarioPrice - currentPrice) * quantity * (dimension === 'hedgePlan' ? 5 : 1);
          
          details.push({
            id: i + 1,
            hedgePlan: dimension === 'hedgePlan' ? mockHedgePlans[i % mockHedgePlans.length] : null,
            account: dimension === 'futuresAccount' ? mockAccounts[i % mockAccounts.length] : null,
            species: mockSpecies[i % mockSpecies.length],
            brand: dimension === 'hedgePlan' ? mockBrands[i % mockBrands.length] : null,
            contract: `cu${2403 + i}`,
            direction: i % 2 === 0 ? '多头' : '空头',
            quantity: quantity,
            currentPrice: currentPrice,
            scenarioPrice: scenarioPrice,
            priceChange: priceChange.toFixed(2) + '%',
            loss: loss,
            exposureCoefficient: dimension === 'hedgePlan' ? 5 : null
          });
        }
        setPositionDetails(details);
      }, [dimension, scenarioType, extremeDayThreshold, basisChange, basisChangeType, exchangeRateChange, exchangeRateDirection]);

      // 参数变更提示
      useEffect(() => {
        if (hasTested) {
          setNeedsRetest(true);
        }
      }, [dimension, scenarioType, extremeDayThreshold, historyWindow, contractType, basisChange, basisChangeType, exchangeRateChange, exchangeRateDirection, hasTested]);

      // 执行压力测试
      const handleStressTest = () => {
        setIsTesting(true);
        setNeedsRetest(false);
        
        // 模拟测试过程
        setTimeout(() => {
          const totalLoss = positionDetails.reduce((sum, p) => sum + p.loss, 0);
          const minLoss = totalLoss * 0.8;
          const maxLoss = totalLoss * 1.2;
          const riskLevel = maxLoss < -5000000 ? 'green' : maxLoss < -10000000 ? 'yellow' : 'red';
          
          const result = {
            scenario: scenarioType,
            minLoss: minLoss,
            maxLoss: maxLoss,
            worstCaseLoss: maxLoss,
            riskLevel: riskLevel,
            testTime: new Date().toLocaleString('zh-CN'),
            contractType: contractType
          };
          
          setCurrentResult(result);
          
          // 更新多场景结果
          const newResults = [...stressResults];
          const existingIndex = newResults.findIndex(r => r.scenario === scenarioType);
          if (existingIndex >= 0) {
            newResults[existingIndex] = result;
          } else {
            newResults.push(result);
          }
          setStressResults(newResults);
          
          setIsTesting(false);
          setHasTested(true);
          message.success('压力测试完成');
        }, 1500);
      };

      // 批量测试多个场景
      const handleBatchTest = () => {
        const scenarios = ['历史极端日', '跨市场联动', '基差骤变', '汇率冲击'];
        setIsTesting(true);
        
        setTimeout(() => {
          const results = scenarios.map(scenario => {
            const baseLoss = -8000000 - Math.random() * 4000000;
            return {
              scenario: scenario,
              minLoss: baseLoss * 0.8,
              maxLoss: baseLoss * 1.2,
              worstCaseLoss: baseLoss * 1.2,
              riskLevel: baseLoss * 1.2 < -5000000 ? 'green' : baseLoss * 1.2 < -10000000 ? 'yellow' : 'red',
              testTime: new Date().toLocaleString('zh-CN')
            };
          });
          
          setStressResults(results);
          setCurrentResult(results[0]);
          setIsTesting(false);
          setHasTested(true);
          message.success(`批量测试完成，共测试 ${scenarios.length} 个场景`);
        }, 2000);
      };

      // 维度切换
      const handleDimensionChange = (e) => {
        const newDimension = e.target.value;
        setDimension(newDimension);
        setDrillDownLevel('overview');
        setDrillDownData(null);
      };

      // 下钻功能
      const handleDrillDown = (item, level) => {
        setDrillDownLevel(level);
        setDrillDownData(item);
      };

      // 返回概览
      const handleBackToOverview = () => {
        setDrillDownLevel('overview');
        setDrillDownData(null);
      };

      // 初始化损失分布图
      useEffect(() => {
        if (lossDistributionChartRef.current && window.echarts && currentResult) {
          const chart = window.echarts.init(lossDistributionChartRef.current);
          
          // 生成损失分布数据
          const distributionData = [];
          const range = currentResult.maxLoss - currentResult.minLoss;
          for (let i = 0; i < 20; i++) {
            distributionData.push(currentResult.minLoss + (range / 20) * i);
          }
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              formatter: '损失: {c}万元'
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'value',
              name: '损失金额（万元）',
              splitLine: { show: true }
            },
            yAxis: {
              type: 'value',
              name: '频数',
              splitLine: { show: true }
            },
            series: [
              {
                name: '损失分布',
                type: 'bar',
                data: distributionData.map(v => (v / 10000).toFixed(0)),
                itemStyle: {
                  color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [
                    { offset: 0, color: '#ff7875' },
                    { offset: 0.5, color: '#ff4d4f' },
                    { offset: 1, color: '#cf1322' }
                  ])
                },
                markLine: {
                  data: [
                    {
                      name: '最坏情景',
                      xAxis: (currentResult.worstCaseLoss / 10000).toFixed(0),
                      lineStyle: { color: '#ff4d4f', width: 2, type: 'dashed' }
                    }
                  ],
                  label: {
                    formatter: '最坏情景: {c}万元'
                  }
                }
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [currentResult]);

      // 初始化场景对比图
      useEffect(() => {
        if (scenarioCompareChartRef.current && window.echarts && stressResults.length > 0) {
          const chart = window.echarts.init(scenarioCompareChartRef.current);
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              axisPointer: { type: 'shadow' },
              formatter: (params) => {
                let result = params[0].name + '<br/>';
                params.forEach(param => {
                  result += `${param.seriesName}: ${param.value}万元<br/>`;
                });
                return result;
              }
            },
            legend: {
              data: ['最小损失', '最大损失', '最坏情景损失'],
              top: 10
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              data: stressResults.map(r => r.scenario)
            },
            yAxis: {
              type: 'value',
              name: '损失金额（万元）'
            },
            series: [
              {
                name: '最小损失',
                type: 'bar',
                data: stressResults.map(r => (r.minLoss / 10000).toFixed(0)),
                itemStyle: { color: '#52c41a' }
              },
              {
                name: '最大损失',
                type: 'bar',
                data: stressResults.map(r => (r.maxLoss / 10000).toFixed(0)),
                itemStyle: { color: '#faad14' }
              },
              {
                name: '最坏情景损失',
                type: 'bar',
                data: stressResults.map(r => (r.worstCaseLoss / 10000).toFixed(0)),
                itemStyle: { color: '#ff4d4f' }
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [stressResults]);

      // 初始化历史极端日回放图
      useEffect(() => {
        if (extremeDayChartRef.current && window.echarts && scenarioType === '历史极端日') {
          const chart = window.echarts.init(extremeDayChartRef.current);
          
          // 生成历史极端日数据
          const dates = [];
          const prices = [];
          const now = new Date();
          
          for (let i = 29; i >= 0; i--) {
            const date = new Date(now);
            date.setDate(date.getDate() - i);
            dates.push(date.toLocaleDateString('zh-CN'));
            
            const basePrice = 68000;
            let price = basePrice;
            if (i === 15) {
              // 模拟极端日
              price = basePrice * (1 + (extremeDayThreshold + 2) / 100);
            } else {
              price = basePrice + (Math.random() - 0.5) * 1000;
            }
            prices.push((price / 1000).toFixed(1));
          }
          
          chart.setOption({
            tooltip: {
              trigger: 'axis',
              formatter: '价格: {c}元/吨'
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            xAxis: {
              type: 'category',
              data: dates,
              boundaryGap: false
            },
            yAxis: {
              type: 'value',
              name: '价格（元/吨）'
            },
            series: [
              {
                name: '价格走势',
                type: 'line',
                data: prices,
                smooth: true,
                itemStyle: { color: '#1677ff' },
                markPoint: {
                  data: [
                    {
                      name: '极端波动',
                      coord: [15, prices[15]],
                      itemStyle: { color: '#ff4d4f' }
                    }
                  ]
                }
              }
            ]
          });
          
          const handleResize = () => chart.resize();
          window.addEventListener('resize', handleResize);
          
          return () => {
            window.removeEventListener('resize', handleResize);
            chart.dispose();
          };
        }
      }, [scenarioType, extremeDayThreshold]);

      return (
        <div style={{ padding: '8px 9px 12px', height: '100%', display: 'flex', flexDirection: 'column', minHeight: 0, overflow: 'auto' }}>
          {/* 顶部筛选区 */}
          <Card size="small" style={{ marginBottom: 16 }}>
            <Space direction="vertical" style={{ width: '100%' }} size="middle">
              <div>
                <strong>维度选择器：</strong>
                <Radio.Group value={dimension} onChange={handleDimensionChange} style={{ marginLeft: 16 }}>
                  <Radio value="hedgePlan">保值方案维度（基于期现关联关系的逻辑持仓）</Radio>
                  <Radio value="futuresAccount">期货账户维度（基于实际开平仓结果的物理持仓）</Radio>
                </Radio.Group>
              </div>
              
              <Row gutter={16}>
                {dimension === 'hedgePlan' ? (
                  <>
                    <Col span={8}>
                      <Form.Item label="保值方案（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedHedgePlans}
                          onChange={setSelectedHedgePlans}
                          style={{ width: '100%' }}
                        >
                          {mockHedgePlans.map(plan => (
                            <Select.Option key={plan} value={plan}>{plan}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                    <Col span={8}>
                      <Form.Item label="现货品种（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedSpecies}
                          onChange={setSelectedSpecies}
                          style={{ width: '100%' }}
                        >
                          {mockSpecies.map(s => (
                            <Select.Option key={s} value={s}>{s}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                    <Col span={8}>
                      <Form.Item label="品牌（多选）">
                        <Select
                          mode="multiple"
                          placeholder="全部"
                          value={selectedBrands}
                          onChange={setSelectedBrands}
                          style={{ width: '100%' }}
                        >
                          {mockBrands.map(b => (
                            <Select.Option key={b} value={b}>{b}</Select.Option>
                          ))}
                        </Select>
                      </Form.Item>
                    </Col>
                  </>
                ) : (
                  <Col span={8}>
                    <Form.Item label="期货账户（多选）">
                      <Select
                        mode="multiple"
                        placeholder="全部"
                        value={selectedAccounts}
                        onChange={setSelectedAccounts}
                        style={{ width: '100%' }}
                      >
                        {mockAccounts.map(acc => (
                          <Select.Option key={acc} value={acc}>{acc}</Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                  </Col>
                )}
                <Col span={8}>
                  <Form.Item label="测试基准日">
                    <DatePicker
                      value={baseDate}
                      onChange={setBaseDate}
                      placeholder="当前日"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item label="历史数据窗口">
                    <Select value={historyWindow} onChange={setHistoryWindow} style={{ width: '100%' }}>
                      <Select.Option value={250}>250个交易日（约1年）</Select.Option>
                      <Select.Option value={500}>500个交易日（约2年）</Select.Option>
                      <Select.Option value="custom">自定义</Select.Option>
                    </Select>
                  </Form.Item>
                </Col>
              </Row>
            </Space>
          </Card>

          {/* 场景配置区 */}
          <Card size="small" style={{ marginBottom: 16 }}>
            <Row gutter={16}>
              <Col span={12}>
                <Form.Item label="场景类型">
                  <Select value={scenarioType} onChange={setScenarioType} style={{ width: '100%' }}>
                    <Select.Option value="历史极端日">历史极端日</Select.Option>
                    <Select.Option value="跨市场联动">跨市场联动</Select.Option>
                    <Select.Option value="基差骤变">基差骤变</Select.Option>
                    <Select.Option value="汇率冲击">汇率冲击</Select.Option>
                    <Select.Option value="自定义场景">自定义场景</Select.Option>
                  </Select>
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item label="期货价格连续合约类型">
                  <Select value={contractType} onChange={setContractType} style={{ width: '100%' }}>
                    <Select.Option value="主连">主连（主力连续）</Select.Option>
                    <Select.Option value="近月连续">近月连续</Select.Option>
                    <Select.Option value="指数连续">指数连续</Select.Option>
                  </Select>
                </Form.Item>
              </Col>
            </Row>
            
            {/* 场景参数设置 */}
            {scenarioType === '历史极端日' && (
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item label="极端日识别标准">
                    <InputNumber
                      value={extremeDayThreshold}
                      onChange={setExtremeDayThreshold}
                      min={1}
                      max={20}
                      addonAfter="%"
                      style={{ width: '100%' }}
                    />
                    <div style={{ fontSize: 12, color: '#8a94a6', marginTop: 4 }}>
                      涨跌幅超过{extremeDayThreshold}%的交易日将被识别为极端日
                    </div>
                  </Form.Item>
                </Col>
              </Row>
            )}
            
            {scenarioType === '跨市场联动' && (
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item label="联动市场（多选）">
                    <Select
                      mode="multiple"
                      placeholder="选择市场"
                      value={linkedMarkets}
                      onChange={setLinkedMarkets}
                      style={{ width: '100%' }}
                    >
                      {mockSpecies.map(s => (
                        <Select.Option key={s} value={s}>{s}</Select.Option>
                      ))}
                    </Select>
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item label="价格冲击幅度">
                    <InputNumber
                      value={marketShocks['default'] || 5}
                      onChange={(v) => setMarketShocks({ ...marketShocks, default: v })}
                      min={1}
                      max={20}
                      addonAfter="%"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item label="相关性参数">
                    <InputNumber
                      value={correlation}
                      onChange={setCorrelation}
                      min={0}
                      max={1}
                      step={0.1}
                      style={{ width: '100%' }}
                    />
                    <div style={{ fontSize: 12, color: '#8a94a6', marginTop: 4 }}>
                      市场间相关性系数（0-1之间）
                    </div>
                  </Form.Item>
                </Col>
              </Row>
            )}
            
            {scenarioType === '基差骤变' && (
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item label="基差变化类型">
                    <Select value={basisChangeType} onChange={setBasisChangeType} style={{ width: '100%' }}>
                      <Select.Option value="扩大">扩大</Select.Option>
                      <Select.Option value="缩小">缩小</Select.Option>
                    </Select>
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item label="基差变化幅度">
                    <InputNumber
                      value={basisChange}
                      onChange={setBasisChange}
                      min={100}
                      max={2000}
                      step={100}
                      addonAfter="元"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
              </Row>
            )}
            
            {scenarioType === '汇率冲击' && (
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item label="汇率变化方向">
                    <Select value={exchangeRateDirection} onChange={setExchangeRateDirection} style={{ width: '100%' }}>
                      <Select.Option value="升值">升值</Select.Option>
                      <Select.Option value="贬值">贬值</Select.Option>
                    </Select>
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item label="汇率变化幅度">
                    <InputNumber
                      value={exchangeRateChange}
                      onChange={setExchangeRateChange}
                      min={1}
                      max={20}
                      addonAfter="%"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
              </Row>
            )}
            
            {scenarioType === '自定义场景' && (
              <Row gutter={16}>
                <Col span={24}>
                  <Alert
                    message="自定义场景"
                    description="可以为各品种/合约设置不同的价格冲击幅度，或组合价格、基差、汇率等多个因素"
                    type="info"
                    showIcon
                    style={{ marginBottom: 16 }}
                  />
                </Col>
                <Col span={12}>
                  <Form.Item label="默认价格冲击">
                    <InputNumber
                      value={customShocks['default'] || 5}
                      onChange={(v) => setCustomShocks({ ...customShocks, default: v })}
                      min={-20}
                      max={20}
                      addonAfter="%"
                      style={{ width: '100%' }}
                    />
                  </Form.Item>
                </Col>
              </Row>
            )}
            
            <Space style={{ marginTop: 16 }}>
              <Button 
                type="primary" 
                onClick={handleStressTest}
                loading={isTesting}
                disabled={isTesting}
              >
                执行压力测试
              </Button>
              <Button 
                onClick={handleBatchTest}
                loading={isTesting}
                disabled={isTesting}
              >
                批量测试（多场景对比）
              </Button>
              {needsRetest && (
                <Alert
                  message="参数已变更，请重新测试"
                  type="warning"
                  showIcon
                  style={{ display: 'inline-flex', alignItems: 'center' }}
                />
              )}
              <Button icon={renderIcon('ReloadOutlined')}>刷新数据</Button>
              <Button icon={renderIcon('DownloadOutlined')}>导出报告</Button>
            </Space>
          </Card>

          {/* 核心结果展示区 */}
          {currentResult && (
            <Card size="small" style={{ marginBottom: 16 }}>
              <Row gutter={16}>
                <Col span={12}>
                  <div style={{ textAlign: 'center', padding: '20px' }}>
                    <div style={{ fontSize: 28, fontWeight: 'bold', color: currentResult.riskLevel === 'red' ? '#ff4d4f' : currentResult.riskLevel === 'yellow' ? '#faad14' : '#52c41a', marginBottom: 8 }}>
                      损失区间: {currentResult.minLoss.toLocaleString()} ~ {currentResult.maxLoss.toLocaleString()} 元
                    </div>
                    <div style={{ marginBottom: 8 }}>
                      <Tag color={currentResult.riskLevel === 'red' ? 'red' : currentResult.riskLevel === 'yellow' ? 'orange' : 'green'} style={{ fontSize: 14, padding: '4px 12px' }}>
                        {currentResult.riskLevel === 'red' ? '高风险' : currentResult.riskLevel === 'yellow' ? '中等风险' : '低风险'}
                      </Tag>
                    </div>
                    <div style={{ color: '#8a94a6', fontSize: 14 }}>
                      场景: {currentResult.scenario}
                    </div>
                    <div style={{ color: '#8a94a6', fontSize: 12, marginTop: 8 }}>
                      最坏情景损失: <span style={{ color: '#ff4d4f', fontWeight: 'bold' }}>{currentResult.worstCaseLoss.toLocaleString()} 元</span>
                    </div>
                    <div style={{ color: '#8a94a6', fontSize: 12, marginTop: 4 }}>
                      测试时间: {currentResult.testTime}
                    </div>
                  </div>
                </Col>
                <Col span={12}>
                  <div style={{ padding: '20px' }}>
                    <div style={{ marginBottom: 12, fontWeight: 'bold' }}>风险等级说明：</div>
                    <Space direction="vertical" size="small">
                      <div><Tag color="green">绿色</Tag> 损失在可承受范围内</div>
                      <div><Tag color="orange">黄色</Tag> 损失接近风险限额，需要关注</div>
                      <div><Tag color="red">红色</Tag> 损失超过风险限额，需要采取措施降低风险</div>
                    </Space>
                    <div style={{ marginTop: 16, padding: 12, background: '#f5f5f5', borderRadius: 4 }}>
                      <div style={{ fontSize: 12, color: '#8a94a6', marginBottom: 4 }}>损失区间含义：</div>
                      <div style={{ fontSize: 12 }}>
                        在{currentResult.scenario}场景下，持仓的损失可能在{Math.abs(currentResult.minLoss).toLocaleString()}元到{Math.abs(currentResult.maxLoss).toLocaleString()}元之间。
                        <br />
                        最坏情景损失：{Math.abs(currentResult.worstCaseLoss).toLocaleString()}元（最大损失）
                      </div>
                    </div>
                  </div>
                </Col>
              </Row>
            </Card>
          )}

          {/* 分析图表区 */}
          <Row gutter={16} style={{ marginBottom: 16 }}>
            <Col span={12}>
              <Card size="small" title="损失分布图" extra={
                currentResult && (
                  <Tag color={currentResult.riskLevel === 'red' ? 'red' : currentResult.riskLevel === 'yellow' ? 'orange' : 'green'}>
                    最坏情景: {(currentResult.worstCaseLoss / 10000).toFixed(0)}万元
                  </Tag>
                )
              }>
                {currentResult ? (
                  <div ref={lossDistributionChartRef} style={{ height: 300, width: '100%' }}></div>
                ) : (
                  <div style={{ height: 300, display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#fafafa', borderRadius: 4 }}>
                    <div style={{ textAlign: 'center', color: '#8a94a6' }}>
                      <div style={{ fontSize: 48, marginBottom: 8 }}>📊</div>
                      <div>请先执行压力测试</div>
                    </div>
                  </div>
                )}
              </Card>
            </Col>
            <Col span={12}>
              <Card size="small" title="场景对比图" extra={
                stressResults.length > 0 && (
                  <Tag color="blue">{stressResults.length} 个场景</Tag>
                )
              }>
                {stressResults.length > 0 ? (
                  <div ref={scenarioCompareChartRef} style={{ height: 300, width: '100%' }}></div>
                ) : (
                  <div style={{ height: 300, display: 'flex', alignItems: 'center', justifyContent: 'center', background: '#fafafa', borderRadius: 4 }}>
                    <div style={{ textAlign: 'center', color: '#8a94a6' }}>
                      <div style={{ fontSize: 48, marginBottom: 8 }}>📈</div>
                      <div>执行批量测试可查看多场景对比</div>
                    </div>
                  </div>
                )}
              </Card>
            </Col>
          </Row>

          {scenarioType === '历史极端日' && (
            <Row gutter={16} style={{ marginBottom: 16 }}>
              <Col span={24}>
                <Card size="small" title="历史极端日回放图">
                  <div ref={extremeDayChartRef} style={{ height: 300, width: '100%' }}></div>
                </Card>
              </Col>
            </Row>
          )}

          {/* 明细数据区 */}
          <Card size="small" title="持仓明细表" extra={
            <Button icon={renderIcon('DownloadOutlined')} size="small">导出明细</Button>
          }>
            <Table
              columns={[
                dimension === 'hedgePlan' 
                  ? { title: '保值方案', dataIndex: 'hedgePlan', key: 'hedgePlan', width: 150 }
                  : { title: '期货账户', dataIndex: 'account', key: 'account', width: 150 },
                { title: '品种', dataIndex: 'species', key: 'species', width: 80 },
                dimension === 'hedgePlan' && { title: '品牌', dataIndex: 'brand', key: 'brand', width: 100 },
                { title: '合约代码', dataIndex: 'contract', key: 'contract', width: 120 },
                { title: '持仓方向', dataIndex: 'direction', key: 'direction', width: 100 },
                { title: '持仓数量（手）', dataIndex: 'quantity', key: 'quantity', align: 'right', width: 120 },
                { title: '当前价格', dataIndex: 'currentPrice', key: 'currentPrice', render: (v) => v.toLocaleString(), align: 'right', width: 120 },
                { title: '场景价格', dataIndex: 'scenarioPrice', key: 'scenarioPrice', render: (v) => v.toLocaleString(), align: 'right', width: 120 },
                { title: '价格变化', dataIndex: 'priceChange', key: 'priceChange', align: 'right', width: 100 },
                { title: '损失金额（元）', dataIndex: 'loss', key: 'loss', render: (v) => <span style={{ color: v < 0 ? '#ff4d4f' : '#52c41a' }}>{v.toLocaleString()}</span>, align: 'right', width: 150 },
                dimension === 'hedgePlan' && { title: '敞口系数', dataIndex: 'exposureCoefficient', key: 'exposureCoefficient', align: 'right', width: 100 }
              ].filter(Boolean)}
              dataSource={positionDetails}
              rowKey="id"
              scroll={{ x: 'max-content' }}
              pagination={{
                pageSize: 10,
                showSizeChanger: true,
                showTotal: (total) => `共 ${total} 条`
              }}
            />
          </Card>
        </div>
      );
    };

    const App = () => {
      const [topMenu, setTopMenu] = useState('workbench');
      const [sideMenuKey, setSideMenuKey] = useState('');
      const [tabs, setTabs] = useState([]);
      const [activeTab, setActiveTab] = useState('');
      const [isMobile, setIsMobile] = useState(getIsMobile());
      const [sideMenuDrawerVisible, setSideMenuDrawerVisible] = useState(false);
      const [currentUser] = useState(mockPersons[0] || null);

      // 红点提醒：计算新告警数量
      const [newAlertCount, setNewAlertCount] = useState(0);
      
      useEffect(() => {
        const calculateNewAlertCount = () => {
          const LAST_VIEWED_ALERT_KEY = 'risk_alert_last_viewed_id';
          const lastViewedAlertId = localStorage.getItem(LAST_VIEWED_ALERT_KEY);
          
          if (!lastViewedAlertId) {
            // 如果没有记录，所有未处理的告警都是新的
            return mockRiskAlerts.filter(a => a.status !== '已处理').length;
          }
          
          // 找到最后查看的告警在列表中的位置（按时间倒序）
          const sortedAlerts = [...mockRiskAlerts].sort((a, b) => 
            new Date(b.alertTime) - new Date(a.alertTime)
          );
          const lastViewedIndex = sortedAlerts.findIndex(a => a.id === lastViewedAlertId);
          
          if (lastViewedIndex === -1) {
            // 如果找不到，所有未处理的告警都是新的
            return mockRiskAlerts.filter(a => a.status !== '已处理').length;
          }
          
          // 返回在最后查看的告警之前的未处理告警数量
          return sortedAlerts.slice(0, lastViewedIndex).filter(a => a.status !== '已处理').length;
        };
        
        setNewAlertCount(calculateNewAlertCount());
        
        // 定期检查新告警数量（每30秒）
        const interval = setInterval(() => {
          setNewAlertCount(calculateNewAlertCount());
        }, 30000);
        
        return () => clearInterval(interval);
      }, []);

      const currentUserRoles = useMemo(() => {
        if (!currentUser) return [];
        const roleSet = new Set();
        mockPersonRoles.forEach(pr => {
          if (pr.personNames?.includes(currentUser.name)) {
            roleSet.add(pr.roleName);
          }
        });
        return Array.from(roleSet);
      }, [currentUser]);

      const baseTopMenus = [
        { key: 'workbench', label: '工作台' },
        { key: 'contract', label: '合同宝' },
        { key: 'instruction', label: '指令宝' },
        { key: 'match', label: '匹配宝' },
        { key: 'trade', label: '交易宝' },
        { key: 'risk', label: '风控宝' },
        { key: 'report', label: '其他报表' },
        { key: 'settings', label: '全局设置' }
      ];

      const roleTopMenuAccess = {
        '超级管理员': baseTopMenus.map(m => m.key),
        '交易员': ['workbench', 'trade'],
        '风控员': ['workbench', 'risk', 'report'],
        '匹配员': ['workbench', 'match'],
        '制单员': ['workbench', 'contract'],
        '指令员': ['workbench', 'instruction'],
        '业务经理': ['workbench', 'contract']
      };

      const availableTopMenus = useMemo(() => {
        // 默认工作台永远可见
        const allowed = new Set(['workbench']);
        currentUserRoles.forEach(role => {
          (roleTopMenuAccess[role] || []).forEach(k => allowed.add(k));
        });
        // 超级管理员直接全开
        if (currentUserRoles.includes('超级管理员')) {
          return baseTopMenus;
        }
        return baseTopMenus.filter(menu => allowed.has(menu.key));
      }, [currentUserRoles]);

      // 顶部菜单变更时校验当前选中
      useEffect(() => {
        if (!availableTopMenus.find(m => m.key === topMenu)) {
          setTopMenu(availableTopMenus[0]?.key || 'workbench');
          setSideMenuKey('');
          setTabs([]);
          setActiveTab('');
        }
      }, [availableTopMenus, topMenu]);

      const baseSideMenus = {
        contract: [
          { 
            key: 'contract-manage', 
            label: '合同管理', 
            icon: 'FileTextOutlined',
            children: [
              { key: '采购合同管理', label: '采购合同管理', icon: 'ShoppingOutlined' },
              { key: '销售合同管理', label: '销售合同管理', icon: 'ShopOutlined' }
            ]
          },
          { 
            key: 'contract-report', 
            label: '报表', 
            icon: 'BarChartOutlined',
            children: [
              { key: 'avg-price-net-value', label: '均价合同今日净值预估', icon: 'CalculatorOutlined' },
              { key: 'contract-futures-relation', label: '查看合同与期货的关系', icon: 'LinkOutlined' },
              { key: 'purchase-sales-relation-contract', label: '查看采销合同的关系', icon: 'SwapOutlined' },
              { key: 'contract-event-log', label: '合同事件流水查询', icon: 'FileTextOutlined' },
              { key: 'contract-exposure', label: '合同敞口分列与合计', icon: 'TableOutlined' },
              { key: 'contract-delivery-by-manager', label: '按业务负责人的合同的应交收和实际交收', icon: 'UserOutlined' }
            ]
          }
        ],
        instruction: [
          { 
            key: 'instruction-settings', 
            label: '指令权限设置', 
            icon: 'SettingOutlined',
            children: [
              { key: 'person-instruction-permission', label: '人员指令权限设置', icon: 'UserOutlined' },
              { key: 'customer-instruction-permission', label: '客商指令权限设置', icon: 'TeamOutlined' },
              { key: 'avg-price-auto-instruction', label: '均价自动指令启停', icon: 'PoweroffOutlined' }
            ]
          },
          { 
            key: 'instruction-workbench', 
            label: '各岗位的指令工作台', 
            icon: 'DesktopOutlined',
            children: [
              { key: 'instruction-workbench-manager', label: '业务经理工作台', icon: 'UserOutlined' },
              { key: 'instruction-workbench-trader', label: '交易员工作台', icon: 'TrademarkOutlined' },
              { key: 'instruction-workbench-maker', label: '指令员工作台', icon: 'SettingOutlined' },
              { key: 'instruction-workbench-clerk', label: '制单员工作台', icon: 'FileTextOutlined' },
              { key: 'instruction-workbench-customer', label: '客商工作台', icon: 'TeamOutlined' }
            ]
          },
          { 
            key: 'instruction-report', 
            label: '报表', 
            icon: 'BarChartOutlined',
            children: [
              { key: 'instruction-pending', label: '在途指令', icon: 'ClockCircleOutlined' },
              { key: 'instruction-history', label: '历史指令', icon: 'HistoryOutlined' },
              { key: 'instruction-by-trader', label: '按交易员认领的指令的完成情况和敞口', icon: 'UserOutlined' },
              { key: 'instruction-update-record', label: '指令更新记录', icon: 'FileTextOutlined' }
            ]
          }
        ],
        match: [
          { key: 'match-remark', label: '匹配宝与委托备注', icon: 'FileTextOutlined' },
          { 
            key: 'match-report', 
            label: '报表', 
            icon: 'BarChartOutlined',
            children: [
              { key: 'futures-spot-relation', label: '期现关联记录', icon: 'LinkOutlined' },
              { key: 'purchase-sales-relation', label: '采销关联记录', icon: 'SwapOutlined' }
            ]
          }
        ],
        trade: [
          { key: 'web-trade', label: '交易终端', icon: 'StockOutlined' },
          { key: 'spot-data', label: '现货数据', icon: 'DatabaseOutlined' },
          { key: 'trade-calendar', label: '交易日历', icon: 'CalendarOutlined' },
          { key: 'spread-matrix', label: '跨期价差矩阵', icon: 'TableOutlined' },
          { 
            key: 'trade-report', 
            label: '报表', 
            icon: 'BarChartOutlined',
            children: [
              { key: 'futures-account-info', label: '期货账户信息一览', icon: 'AccountBookOutlined' },
              { key: 'trader-speculation-profit', label: '按交易员的投机交易记录和盈亏报表', icon: 'DollarOutlined' }
            ]
          }
        ],
        risk: [
          { key: 'risk-dashboard', label: '风控驾驶舱', icon: 'DashboardOutlined' },
          { key: 'risk-alert-record', label: '风控告警记录', icon: 'AlertOutlined' },
          { key: 'risk-var', label: 'VaR测试', icon: 'LineChartOutlined' },
          { key: 'risk-stress', label: '压力测试', icon: 'ThunderboltOutlined' },
          { key: 'risk-settings', label: '风控设置', icon: 'SettingOutlined' }
        ],
        report: [
          {
            key: 'other-report',
            label: '其他报表',
            icon: 'BarChartOutlined',
            children: [
              { key: 'hedge-plan-info', label: '保值方案信息一览', icon: 'FileProtectOutlined' },
              { key: 'contract-hedge-relation', label: '合同套期关系一览表', icon: 'LinkOutlined' },
              { key: 'custom-report', label: '自定义报表', icon: 'SettingOutlined' }
            ]
          }
        ],
        settings: [
          { key: 'spot-brand', label: '现货品种与价格', icon: 'DatabaseOutlined' },
          { key: 'customer', label: '客商管理', icon: 'TeamOutlined' },
          { key: 'hedge-plan', label: '保值方案管理', icon: 'WalletOutlined' },
          { key: 'futures-account', label: '期货账户管理', icon: 'AccountBookOutlined' },
          { 
            key: 'person-manage', 
            label: '人员管理', 
            icon: 'UserOutlined',
            children: [
              { key: 'person', label: '人员管理', icon: 'UserOutlined' },
              { key: 'person-role', label: '人员角色管理', icon: 'TeamOutlined' }
            ]
          },
          { key: 'custom-field', label: '自定义字段配置', icon: 'FileTextOutlined' },
          { key: 'other-settings', label: '其他设置', icon: 'SettingOutlined' }
        ]
      };

      const workbenchInstructionChildren = useMemo(() => {
        const children = instructionWorkbenchOptions
          .filter(opt => currentUserRoles.includes(opt.role))
          .map(opt => ({
            key: opt.key,
            label: opt.label,
            icon: opt.icon
          }));
        if (children.length === 0) {
          children.push({ key: 'instruction-workbench', label: '指令工作台', icon: 'DesktopOutlined' });
        }
        return children;
      }, [currentUserRoles]);

      const computedSideMenus = useMemo(() => {
        return {
          ...baseSideMenus,
          workbench: [
            {
              key: 'personal-instruction',
              label: '指令工作台',
              icon: 'DesktopOutlined',
              children: workbenchInstructionChildren
            },
            {
              key: 'notification-list',
              label: '通知列表',
              icon: 'BellOutlined'
            }
          ]
        };
      }, [baseSideMenus, workbenchInstructionChildren]);

      const mobileWorkbenchCards = useMemo(() => {
        const cards = [
          { key: 'instruction-mobile', title: '指令工作台', description: '按角色提供对应指令工作台，适配移动端快速处理。', icon: 'DesktopOutlined', fromRole: currentUserRoles.join('、') || '默认', cta: '进入指令工作台' },
          { key: 'notification-list', title: '通知列表', description: '查看告警转通知与系统通知，支持快速处理。', icon: 'BellOutlined', fromRole: '系统', cta: '查看通知' }
        ];
        if (currentUserRoles.includes('交易员')) {
          cards.push({ key: 'mobile-trade', title: '交易宝（移动端）', description: '查看行情、下单、持仓与账户概览的移动端适配。', icon: 'StockOutlined', fromRole: '交易员', cta: '进入交易宝' });
        }
        return cards;
      }, [currentUserRoles]);

      useEffect(() => {
        const handleResize = () => {
          setIsMobile(getIsMobile());
        };
        handleResize();
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);

      useEffect(() => {
        if (!isMobile) {
          setSideMenuDrawerVisible(false);
        }
      }, [isMobile]);

      const menuItems = useMemo(() => {
        return computedSideMenus[topMenu]?.map(item => {
          const menuItem = {
            key: item.key,
            icon: renderIcon(item.icon),
            label: item.label,
            children: item.children?.map(child => {
              const childMenuItem = {
                key: child.key,
                icon: renderIcon(child.icon),
                label: child.label
              };
              // 如果是风控告警记录菜单项，添加红点提醒
              if (child.key === 'risk-alert-record' && newAlertCount > 0) {
                childMenuItem.label = (
                  <span style={{ position: 'relative', display: 'inline-block', paddingRight: '12px' }}>
                    {child.label}
                    <span
                      style={{
                        position: 'absolute',
                        top: '2px',
                        right: '0',
                        width: '8px',
                        height: '8px',
                        borderRadius: '50%',
                        backgroundColor: '#ff4d4f',
                        display: 'inline-block',
                        boxShadow: '0 0 0 1px #fff'
                      }}
                    />
                  </span>
                );
              }
              return childMenuItem;
            })
          };
          
          // 检查直接菜单项（没有children的情况）
          if (!item.children && item.key === 'risk-alert-record' && newAlertCount > 0) {
            menuItem.label = (
              <span style={{ position: 'relative', display: 'inline-block', paddingRight: '12px' }}>
                {item.label}
                <span
                  style={{
                    position: 'absolute',
                    top: '2px',
                    right: '0',
                    width: '8px',
                    height: '8px',
                    borderRadius: '50%',
                    backgroundColor: '#ff4d4f',
                    display: 'inline-block',
                    boxShadow: '0 0 0 1px #fff'
                  }}
                />
              </span>
            );
          }
          
          return menuItem;
        }) || [];
      }, [computedSideMenus, topMenu, newAlertCount]);

      const handleDesktopHint = useCallback(() => {
        message.info('请使用桌面端访问完整功能');
      }, []);

      const handleMenuClick = (key) => {
        setSideMenuKey(key);
        
        // 如果点击的是风控告警记录，更新最后查看的告警ID（清除红点）
        if (key === 'risk-alert-record') {
          const sortedAlerts = [...mockRiskAlerts].sort((a, b) => 
            new Date(b.alertTime) - new Date(a.alertTime)
          );
          if (sortedAlerts.length > 0) {
            const latestAlertId = sortedAlerts[0].id;
            localStorage.setItem('risk_alert_last_viewed_id', latestAlertId);
            // 立即更新红点数量
            setNewAlertCount(0);
          }
        }
        
        if (!tabs.find(t => t.key === key)) {
          // 查找菜单项，包括子菜单
          let menuItem = computedSideMenus[topMenu]?.find(m => m.key === key);
          if (!menuItem) {
            // 在子菜单中查找
            const parentMenu = computedSideMenus[topMenu]?.find(m => m.children?.some(c => c.key === key));
            if (parentMenu) {
              menuItem = parentMenu.children.find(c => c.key === key);
            }
          }
          const newTab = { key, label: menuItem?.label || key };
          setTabs([...tabs, newTab]);
        }
        setActiveTab(key);
      };

      // 统一的关闭单个标签页逻辑
      const closeTab = (targetKey) => {
        const newTabs = tabs.filter(t => t.key !== targetKey);
        setTabs(newTabs);
        if (targetKey === activeTab) {
          if (newTabs.length) {
            setActiveTab(newTabs[newTabs.length - 1].key);
          } else {
            setActiveTab('');
          }
        }
      };

      // Tabs 组件原生的关闭事件
      const handleTabEdit = (targetKey, action) => {
        if (action === 'remove') {
          closeTab(targetKey);
        }
      };

      // 自定义：关闭其他、关闭左侧、关闭右侧
      const handleCloseOthersTabs = () => {
        if (!activeTab || tabs.length <= 1) return;
        const newTabs = tabs.filter(t => t.key === activeTab);
        setTabs(newTabs);
        setActiveTab(activeTab);
      };

      const handleCloseLeftTabs = () => {
        if (!activeTab || tabs.length === 0) return;
        const currentIndex = tabs.findIndex(t => t.key === activeTab);
        if (currentIndex <= 0) return;
        const newTabs = tabs.slice(currentIndex);
        setTabs(newTabs);
        // 当前激活 tab 仍然存在于新列表中，因此保持不变
        setActiveTab(activeTab);
      };

      const handleCloseRightTabs = () => {
        if (!activeTab || tabs.length === 0) return;
        const currentIndex = tabs.findIndex(t => t.key === activeTab);
        if (currentIndex === -1 || currentIndex === tabs.length - 1) return;
        const newTabs = tabs.slice(0, currentIndex + 1);
        setTabs(newTabs);
        setActiveTab(activeTab);
      };

      const renderContent = () => {
        switch (activeTab) {
          case 'personal-instruction':
            return <InstructionWorkbench />;
          case 'notification-list':
            return <NotificationList />;
          case 'spot-brand':
            return <SpotBrandManagement />;
          case 'customer':
            return <CustomerManagement />;
          case 'hedge-plan':
            return <HedgePlanManagement />;
          case 'futures-account':
            return <FuturesAccountManagement />;
          case 'person':
            return <PersonManagement />;
          case 'person-role':
            return <PersonRoleManagement />;
          case 'custom-field':
            return <CustomFieldManagement />;
          case 'other-settings':
            return <OtherSettings />;
          case '采购合同管理':
            return <ContractManagement contractType="purchase" />;
          case '销售合同管理':
            return <ContractManagement contractType="sales" />;
          case 'contract-manage':
            return <ContractManagement contractType="purchase" />;
          case 'instruction-workbench-manager':
            return <InstructionWorkbench initialRole="manager" />;
          case 'instruction-workbench-trader':
            return <InstructionWorkbench initialRole="trader" />;
          case 'instruction-workbench-maker':
            return <InstructionWorkbench initialRole="maker" />;
          case 'instruction-workbench-clerk':
            return <InstructionWorkbench initialRole="clerk" />;
          case 'instruction-workbench-customer':
            return <InstructionWorkbench initialRole="customer" />;
          case 'instruction-workbench':
            return <InstructionWorkbench />;
          case 'person-instruction-permission':
            return <PersonInstructionPermission />;
          case 'customer-instruction-permission':
            return <CustomerInstructionPermission />;
          case 'avg-price-auto-instruction':
            return <AvgPriceAutoInstruction />;
          case 'instruction-pending':
            return <InstructionPendingReport />;
          case 'instruction-history':
            return <InstructionHistoryReport />;
          case 'instruction-update-record':
            return <InstructionUpdateRecordReport />;
          case 'instruction-by-trader':
            return <InstructionByTraderReport />;
          case 'match-remark':
            return <MatchAndRemark />;
          case 'futures-spot-relation':
            return <FuturesSpotRelationReport />;
          case 'purchase-sales-relation':
            return <PurchaseSalesRelationReport />;
          case 'web-trade':
            return <WebTradeTerminal />;
          case 'spot-data':
            return <SpotData />;
          case 'trade-calendar':
            return <TradeCalendar />;
          case 'spread-matrix':
            return <SpreadMatrix />;
          case 'contract-report':
            return <div style={{ padding: 40, textAlign: 'center', color: '#8a94a6', fontSize: 16 }}>建设中</div>;
          case 'avg-price-net-value':
            return <AvgPriceNetValueReport />;
          case 'contract-futures-relation':
            return <ContractFuturesRelationReport />;
          case 'purchase-sales-relation-contract':
            return <PurchaseSalesRelationContractReport />;
          case 'contract-event-log':
            return <ContractEventLogReport />;
          case 'contract-exposure':
            return <ContractExposureReport />;
          case 'contract-delivery-by-manager':
            return <ContractDeliveryByManagerReport />;
          case 'contract-change-record':
            return <ContractEventLogReport />;
          case 'risk-dashboard':
            return <RiskDashboard />;
          case 'risk-alert-record':
            return <RiskAlertRecord />;
          case 'risk-settings':
            return <RiskSettings />;
          case 'risk-var':
            return <RiskVaR />;
          case 'risk-stress':
            return <RiskStress />;
          case 'futures-account-info':
            return <FuturesAccountInfoReport />;
          case 'trader-speculation-profit':
            return <TraderSpeculationProfitReport />;
          case 'hedge-plan-info':
            return <HedgePlanInfoReport />;
          case 'contract-hedge-relation':
            return <ContractHedgeRelationReport />;
          case 'custom-report':
            return <CustomReport />;
          case 'other-report':
            return <div style={{ padding: 40, textAlign: 'center', color: '#8a94a6', fontSize: 16 }}>建设中</div>;
          default:
            return <div style={{ padding: 40, textAlign: 'center', color: '#8a94a6' }}>请选择菜单项</div>;
        }
      };

      if (isMobile) {
        return (
          <ConfigProvider theme={{ token: { colorPrimary: '#1677ff' } }}>
            <div style={{ minHeight: '100vh', display: 'flex', flexDirection: 'column' }}>
              <Header className="erp-header" style={{ width: '100%' }}>
                <div className="erp-logo" style={{ width: '100%', justifyContent: 'space-between' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
                    <div className="erp-logo-badge">快期</div>
                    <div className="erp-title">
                      <span className="name" title="期现业务管理平台">期现业务管理平台</span>
                      <span className="desc">Mobile Workbench</span>
                    </div>
                  </div>
                  <Button type="text" onClick={handleDesktopHint}>桌面版</Button>
                </div>
              </Header>
              <Content className="erp-content" style={{ flex: 1, width: '100%' }}>
                <MobileWorkbench
                  user={currentUser}
                  roles={currentUserRoles}
                  workbenches={mobileWorkbenchCards}
                  onEnterDesktop={handleDesktopHint}
                />
              </Content>
            </div>
          </ConfigProvider>
        );
      }

      return (
        <ConfigProvider theme={{ token: { colorPrimary: '#1677ff' } }}>
          <div style={{ height: '100vh', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
            <Header className="erp-header">
              <div className="erp-logo">
                {isMobile && (
                  <Button
                    className="erp-mobile-menu-btn"
                    type="text"
                    icon={renderIcon('MenuOutlined')}
                    onClick={() => setSideMenuDrawerVisible(true)}
                  />
                )}
                <div className="erp-logo-badge">快期</div>
                <div className="erp-title">
                  <span className="name" title="期现业务管理平台">期现业务管理平台</span>
                  <span className="desc" title="Prototype System">Prototype</span>
                </div>
              </div>
              <div className="erp-top-menu" style={{ flex: 1, display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '4px', margin: '0 20px', overflowX: 'auto', overflowY: 'hidden' }}>
                {availableTopMenus.map(menu => (
                  <div
                    key={menu.key}
                    className={`erp-top-menu-item ${topMenu === menu.key ? 'active' : ''}`}
                    onClick={() => setTopMenu(menu.key)}
                    style={{ flexShrink: 0 }}
                  >
                    {menu.label}
                  </div>
                ))}
              </div>
              <Space style={{ flexShrink: 0 }}>
                <Avatar>用户</Avatar>
              </Space>
            </Header>
            <div className="erp-main-layout">
              {!isMobile && (
                <Sider className="erp-sider" width={240}>
                  <Menu
                    mode="inline"
                    selectedKeys={[sideMenuKey]}
                    onClick={({ key }) => handleMenuClick(key)}
                    items={menuItems}
                  />
                </Sider>
              )}
              <div className="erp-content-area">
                <div className="erp-tabs-bar" style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                  <div style={{ flex: 1, minWidth: 0 }}>
                    <Tabs
                      type="editable-card"
                      activeKey={activeTab}
                      onChange={setActiveTab}
                      onEdit={handleTabEdit}
                      hideAdd
                      items={tabs.map(tab => ({
                        key: tab.key,
                        label: tab.label,
                        closable: true
                      }))}
                    />
                  </div>
                  <Dropdown
                    trigger={['click']}
                    disabled={!activeTab || tabs.length === 0}
                    menu={{
                      items: [
                        {
                          key: 'close-others',
                          label: '关闭其他',
                          disabled: !activeTab || tabs.length <= 1,
                          onClick: () => handleCloseOthersTabs()
                        },
                        {
                          key: 'close-left',
                          label: '关闭左侧',
                          disabled:
                            !activeTab ||
                            tabs.findIndex(t => t.key === activeTab) <= 0,
                          onClick: () => handleCloseLeftTabs()
                        },
                        {
                          key: 'close-right',
                          label: '关闭右侧',
                          disabled:
                            !activeTab ||
                            tabs.findIndex(t => t.key === activeTab) === -1 ||
                            tabs.findIndex(t => t.key === activeTab) === tabs.length - 1,
                          onClick: () => handleCloseRightTabs()
                        }
                      ]
                    }}
                  >
                    <Button
                      size="small"
                      icon={renderIcon('MoreOutlined')}
                      type="text"
                    />
                  </Dropdown>
                </div>
                <Content className="erp-content">
                  {renderContent()}
                </Content>
              </div>
            </div>
            {isMobile && (
              <Drawer
                placement="left"
                width={260}
                open={sideMenuDrawerVisible}
                onClose={() => setSideMenuDrawerVisible(false)}
                bodyStyle={{ padding: 0 }}
              >
                <Menu
                  mode="inline"
                  selectedKeys={[sideMenuKey]}
                  onClick={({ key }) => {
                    handleMenuClick(key);
                    setSideMenuDrawerVisible(false);
                  }}
                  items={menuItems}
                />
              </Drawer>
            )}
          </div>
        </ConfigProvider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>

